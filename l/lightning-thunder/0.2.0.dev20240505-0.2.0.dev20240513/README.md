# Comparing `tmp/lightning_thunder-0.2.0.dev20240505.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240513.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning_thunder-0.2.0.dev20240505.tar", last modified: Sun May  5 00:20:32 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240513.tar", last modified: Mon May 13 14:08:16 2024, max compression
```

## Comparing `lightning_thunder-0.2.0.dev20240505.tar` & `lightning_thunder-0.2.0.dev20240513.tar`

### file list

```diff
@@ -1,101 +1,102 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.278033 lightning_thunder-0.2.0.dev20240505/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-05 00:20:32.278033 lightning_thunder-0.2.0.dev20240505/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      538 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.262033 lightning_thunder-0.2.0.dev20240505/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      130 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      836 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-05 00:20:32.278033 lightning_thunder-0.2.0.dev20240505/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.262033 lightning_thunder-0.2.0.dev20240505/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    36220 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.266033 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   102663 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    21472 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3730 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    28582 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.266033 lightning_thunder-0.2.0.dev20240505/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    63993 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    30602 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    56936 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   118947 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    48867 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28189 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   140193 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    19356 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    11709 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      310 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    10320 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    33925 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    75941 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    11133 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    83372 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    25646 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   153180 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.422199 lightning_thunder-0.2.0.dev20240513/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-13 14:08:16.422199 lightning_thunder-0.2.0.dev20240513/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.418199 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2461 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      538 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.402199 lightning_thunder-0.2.0.dev20240513/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      836 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-13 14:08:16.422199 lightning_thunder-0.2.0.dev20240513/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.402199 lightning_thunder-0.2.0.dev20240513/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-05-13 14:08:16.000000 lightning_thunder-0.2.0.dev20240513/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34464 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.406199 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   102663 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22448 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3730 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28582 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11229 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.406199 lightning_thunder-0.2.0.dev20240513/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    64146 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30798 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.410199 lightning_thunder-0.2.0.dev20240513/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    58266 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4484 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4343 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/module.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   121505 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48852 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28189 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   141043 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.410199 lightning_thunder-0.2.0.dev20240513/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.414199 lightning_thunder-0.2.0.dev20240513/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    29040 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11709 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.414199 lightning_thunder-0.2.0.dev20240513/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      310 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10320 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33491 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.414199 lightning_thunder-0.2.0.dev20240513/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.418199 lightning_thunder-0.2.0.dev20240513/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    75941 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14038 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13065 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    83541 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24891 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.418199 lightning_thunder-0.2.0.dev20240513/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.418199 lightning_thunder-0.2.0.dev20240513/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 14:08:16.418199 lightning_thunder-0.2.0.dev20240513/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   158401 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-05-13 14:08:14.000000 lightning_thunder-0.2.0.dev20240513/thunder/torch/langctx.py
```

### Comparing `lightning_thunder-0.2.0.dev20240505/LICENSE` & `lightning_thunder-0.2.0.dev20240513/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240513/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/PKG-INFO` & `lightning_thunder-0.2.0.dev20240513/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240505
+Version: 0.2.0.dev20240513
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -30,40 +30,40 @@
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
-Requires-Dist: coverage==7.4.4; extra == "test"
+Requires-Dist: coverage==7.5.1; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
-Requires-Dist: graphviz==0.20.1; extra == "test"
+Requires-Dist: graphviz==0.20.3; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test"
 Requires-Dist: jax; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jsonargparse; extra == "test"
 Requires-Dist: litgpt==0.3.0; extra == "test"
 Requires-Dist: numpy; extra == "test"
 Requires-Dist: pandas; extra == "test"
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
-Requires-Dist: pytest-timeout==2.2.0; extra == "test"
+Requires-Dist: pytest-timeout==2.3.1; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
-Requires-Dist: pytest-xdist==3.5.0; extra == "test"
+Requires-Dist: pytest-xdist==3.6.1; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
-Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
+Requires-Dist: ipython[all]==8.24.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240505
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240513
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -14,29 +14,29 @@
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
 mpmath<1.4.0 Provides-Extra: test Requires-Dist: absl-py; extra == "test"
-Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops; extra ==
+Requires-Dist: coverage==7.5.1; extra == "test" Requires-Dist: einops; extra ==
 "test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist:
-fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test"
+fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.3; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
 and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
 litgpt==0.3.0; extra == "test" Requires-Dist: numpy; extra == "test" Requires-
 Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test" Requires-Dist:
-pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
+pytest-timeout==2.3.1; extra == "test" Requires-Dist: pytest-
+timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.6.1; extra
 == "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
 xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-Dist: cuda-
-python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0; extra ==
+python; extra == "notebooks" Requires-Dist: ipython[all]==8.24.0; extra ==
 "notebooks"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
```

### Comparing `lightning_thunder-0.2.0.dev20240505/README.md` & `lightning_thunder-0.2.0.dev20240513/README.md`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240505
+Version: 0.2.0.dev20240513
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -30,40 +30,40 @@
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
-Requires-Dist: coverage==7.4.4; extra == "test"
+Requires-Dist: coverage==7.5.1; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
-Requires-Dist: graphviz==0.20.1; extra == "test"
+Requires-Dist: graphviz==0.20.3; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test"
 Requires-Dist: jax; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jsonargparse; extra == "test"
 Requires-Dist: litgpt==0.3.0; extra == "test"
 Requires-Dist: numpy; extra == "test"
 Requires-Dist: pandas; extra == "test"
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
-Requires-Dist: pytest-timeout==2.2.0; extra == "test"
+Requires-Dist: pytest-timeout==2.3.1; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
-Requires-Dist: pytest-xdist==3.5.0; extra == "test"
+Requires-Dist: pytest-xdist==3.6.1; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
-Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
+Requires-Dist: ipython[all]==8.24.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240513/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240505
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240513
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -14,29 +14,29 @@
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
 mpmath<1.4.0 Provides-Extra: test Requires-Dist: absl-py; extra == "test"
-Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops; extra ==
+Requires-Dist: coverage==7.5.1; extra == "test" Requires-Dist: einops; extra ==
 "test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist:
-fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test"
+fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.3; extra == "test"
 Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
 and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
 litgpt==0.3.0; extra == "test" Requires-Dist: numpy; extra == "test" Requires-
 Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test" Requires-Dist:
-pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
+pytest-timeout==2.3.1; extra == "test" Requires-Dist: pytest-
+timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.6.1; extra
 == "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
 xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-Dist: cuda-
-python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0; extra ==
+python; extra == "notebooks" Requires-Dist: ipython[all]==8.24.0; extra ==
 "notebooks"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
```

### Comparing `lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/SOURCES.txt`

 * *Files 1% similar despite different names*

```diff
@@ -31,14 +31,15 @@
 thunder/core/codeutils.py
 thunder/core/compile_data.py
 thunder/core/devices.py
 thunder/core/dtypes.py
 thunder/core/interpreter.py
 thunder/core/jit_ext.py
 thunder/core/langctxs.py
+thunder/core/module.py
 thunder/core/options.py
 thunder/core/patterns.py
 thunder/core/prims.py
 thunder/core/profile.py
 thunder/core/proxies.py
 thunder/core/pytree.py
 thunder/core/rematerialization.py
```

### Comparing `lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/requires.txt` & `lightning_thunder-0.2.0.dev20240513/lightning_thunder.egg-info/requires.txt`

 * *Files 24% similar despite different names*

```diff
@@ -5,32 +5,32 @@
 igraph>=0.10.4
 optree>=0.9.2
 opt_einsum>=3.3.0
 mpmath<1.4.0
 
 [notebooks]
 cuda-python
-ipython[all]==8.23.0
+ipython[all]==8.24.0
 
 [test]
 absl-py
-coverage==7.4.4
+coverage==7.5.1
 einops
 expecttest==0.2.1
 fdm==0.4.1
-graphviz==0.20.1
+graphviz==0.20.3
 hypothesis==6.100.0
 jsonargparse
 litgpt==0.3.0
 numpy
 pandas
 pytest-cov==4.1.0
 pytest-random-order==1.1.1
-pytest-timeout==2.2.0
+pytest-timeout==2.3.1
 pytest-timestamper==0.0.10
-pytest-xdist==3.5.0
+pytest-xdist==3.6.1
 pytest==8.1.1
 xlsxwriter
 
 [test:sys_platform == "linux" or sys_platform == "darwin"]
 jax
 jaxlib
```

### Comparing `lightning_thunder-0.2.0.dev20240505/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240513/requirements/test.txt`

 * *Files 13% similar despite different names*

```diff
@@ -1,15 +1,15 @@
-coverage ==7.4.4
+coverage ==7.5.1
 pytest ==8.1.1
-pytest-timeout ==2.2.0
+pytest-timeout ==2.3.1
 pytest-cov ==4.1.0
-pytest-xdist ==3.5.0
+pytest-xdist ==3.6.1
 pytest-random-order ==1.1.1
 pytest-timestamper ==0.0.10
-graphviz ==0.20.1
+graphviz ==0.20.3
 fdm ==0.4.1
 expecttest ==0.2.1  # for test_ddp.py
 hypothesis ==6.100.0  # for test_ddp.py
 numpy  # for test_ops.py
 einops  # for test_einops.py
 litgpt==0.3.0  # for the model definition in tests and benchmarks
 absl-py # thunder/benchmarks/test_benchmark_litgpt.py
```

### Comparing `lightning_thunder-0.2.0.dev20240505/setup.py` & `lightning_thunder-0.2.0.dev20240513/setup.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,21 +1,21 @@
 from functools import wraps
 from typing import Any
 from collections import defaultdict, namedtuple
 from collections.abc import Callable
 from collections.abc import Sequence
-from contextlib import contextmanager
 from contextvars import ContextVar
 import os
 import dis
 import time
 import warnings
 
 from looseversion import LooseVersion
 
+from thunder.core.module import ThunderModule
 from thunder.core.interpreter import InterpreterLogItem
 from thunder.core.options import (
     INTERPRETATION_OPTIONS,
     resolve_interpretation_option,
     resolve_sharp_edges_option,
     CACHE_OPTIONS,
     SHARP_EDGES_OPTIONS,
@@ -39,15 +39,15 @@
     CompileStats,
     _create_callable,
     trace,
     transform_for_execution,
 )
 import thunder.extend as extend
 from thunder.extend import Executor, add_default_executor
-from thunder.core.compile_data import compile_data_and_stats
+from thunder.core.compile_data import compile_data_and_stats, get_compile_data
 from thunder.core.langctxs import LanguageContext
 import thunder.core.langctxs as langctxs
 from thunder.core.baseutils import run_once, check
 from thunder.core.proxies import (
     Proxy,
     TensorProxy,
     NumberProxy,
@@ -186,89 +186,14 @@
     *,
     record_history: bool,
     sharp_edges: SHARP_EDGES_OPTIONS,
 ) -> TraceResults:
     return thunder_general_jit(fn, args, kwargs, sharp_edges=sharp_edges, record_history=record_history)
 
 
-class ThunderModule(pytorch.nn.Module):
-    """A wrapper nn.Module subclass.
-
-    This wrapper is returned by ``thunder.jit``, you would typically not
-    instantiate it manually.
-
-    """
-
-    def __init__(self, model, compiled_model_call):
-        """"""
-        super().__init__()
-        self._model = model
-
-        self._forward_fn = compiled_model_call
-
-    def forward(self, *args, **kwargs):
-        res = self._forward_fn(*args, **kwargs)
-        return res
-
-    @contextmanager
-    def no_sync(self):
-        r"""Context manager to disable gradient synchronization in data parallel mode.
-
-        This context manager is intended to be used in conjunction with
-        :class:`torch.nn.parallel.DistributedDataParallel` to disable gradient
-        synchronization in the backward pass. It will not have any effect when
-        used with other modules.
-
-        .. note::
-
-            This could lead to different accumulated gradients with ``torch.nn.parallel.distributed.DistributedDataParallel.no_sync``.
-            PyTorch's gradient synchronization is implemented by applying all-reduce to gradient buckets of ``torch.nn.Parameter.grad``.
-            Thus the ``no_sync`` context leads to :math:`\text{AllReduce} \left( \sum_{i = 0}^{\rm{num_grad_accum_steps}} g_i \right)`.
-            In contrast, this synchronizes accumulated gradients when exiting, leading to
-            :math:`\text{AllReduce} \left( \sum_{i = 0}^{\rm{num_grad_accum_steps - 1}} g_i \right) + \text{AllReduce}(g_{\rm{num_grad_accum_steps}})`.
-
-        .. warning::
-
-            You must reuse this context manager in each group of gradient accumulation iterations since gradients will get synchronized
-            on context manager exit.
-
-            .. code-block:: python
-
-                with model.no_sync():
-                    for _ in range(len(gradient_accumulation_iters)):
-                        loss(model(x)).backward()  # uses no-sync-backward trace
-                loss(model(x)).backward()  # uses the regular backward trace
-                optimizer.step()
-
-        """
-        from thunder.distributed import (
-            set_skip_data_parallel_grad_sync,
-            reset_skip_data_parallel_grad_sync,
-            _sync_grads,
-        )
-
-        token = set_skip_data_parallel_grad_sync(True)
-        try:
-            yield
-        finally:
-            reset_skip_data_parallel_grad_sync(token)
-            _sync_grads(self)
-
-    def __getattr__(self, name: str) -> Any:
-        if name == "_model":
-            return self._modules["_model"]
-        return getattr(self._model, name)
-
-    def state_dict(self, *args: Any, **kwargs: Any) -> Any:
-        return self._model.state_dict(*args, **kwargs)
-
-    def load_state_dict(self, *args: Any, **kwargs: Any) -> Any:
-        return self._model.load_state_dict(*args, **kwargs)
-
-
 # this captures the information needed to decide whether a cached function
 # matches (e.g. ddp and autocast state)
 _cache_info_ctx = ContextVar("cache_info_ctx")
 
 
 def _with_cache_info_ctx(fn):
     def cache_info_wrapper(*args, **kwargs):
@@ -331,14 +256,15 @@
     *,
     langctx: None | str | Any | LanguageContext = None,
     executors: None | Sequence[Executor | str] = None,
     sharp_edges: None | SHARP_EDGES_OPTIONS | str = None,
     interpretation: None | INTERPRETATION_OPTIONS | str = None,
     cache: None | CACHE_OPTIONS | str = None,
     disable_torch_autograd: bool = False,  # TODO Revisit this UX for RC1
+    early_transforms: list | None = None,
     additional_transforms: list | None = None,
     record_history: bool = False,
     **compile_options,  # TODO RC1 Make this explicit -- dict of options
 ) -> Callable:
     """Just-in-time compile a callable (function or model).
 
     Args:
@@ -350,14 +276,17 @@
         sharp_edges: sharp edge detection action. What to do when thunder detects a construct that is likely to lead to errors. Can be ``"allow"``, ``"warn"``, ``"error"``. Defaults to ``"allow"``.
         cache: caching mode. default: ``"constant values"```
 
                - ``"no caching"`` - disable caching and always recompute,
                - ``"constant values"`` - require Tensors to be of the same shape, device, dtype etc., and integers and strings to match exactly,
                - ``"same input"`` - don't check, but just assume that a cached function works if it exists.
         interpretation: (deprecated: don't use this, use the thunder.functional.jit entry point to get the functional jit)
+
+        early_transforms: List of transforms to be applied to prologue, computation, and epilogue traces before executing the prologue. Default: ``None```
+        transforms: List of transforms to be applied to the computation trace. Default: ``None```
     """
 
     if "executors_list" in compile_options:
         warnings.warn("outdated argument executors_list= in call, please use executors=")
         if executors is None:
             executors = compile_options.pop("executors_list")
 
@@ -367,14 +296,17 @@
     if interpretation is INTERPRETATION_OPTIONS.PYTHON_INTERPRETER:
         interpreter = functional._python_interpreter
     elif interpretation is INTERPRETATION_OPTIONS.TRANSLATE_FUNCTIONS:
         interpreter = functional._translate_functions_interpreter
     elif interpretation is INTERPRETATION_OPTIONS.TRANSLATE_PYTHON:
         interpreter = _general_frontend
 
+    if early_transforms is None:
+        early_transforms = []
+
     if additional_transforms is None:
         additional_transforms = []
 
     # Resolve names of executors
     executors = resolve_executors(executors)
 
     # TODO: verify that tutorials don't have false positives and enable warning by default
@@ -445,52 +377,53 @@
 
         # TODO RC1 Add module and function checks to prologue (make it a compile option)
 
         # Checks cache
         cs.last_trace_cache_start = time.time_ns()
         if (cd.cache_option is CACHE_OPTIONS.CONSTANT_VALUES) or (cd.cache_option is CACHE_OPTIONS.SYMBOLIC_VALUES):
             for cache_entry in reversed(cs.interpreter_cache):
-                (
-                    pro,
-                    pro_traces,
-                    comp,
-                    comp_traces,
-                    epilogue,
-                    epilogue_traces,
-                    backward_fn,
-                    backward_traces,
-                    _return_none_instead_of_grads,
-                ) = cache_entry
-                try:
-                    cs.last_prologue_execution_start = time.time_ns()
-                    if epilogue:
-                        inps, pro_to_epi = pro(*args, **kwargs)
-                    else:
-                        inps = pro(*args, **kwargs)
-                        pro_to_epi = None
-                    cs.last_prologue_execution_stop = time.time_ns()
-                except Exception as _:
-                    continue
-
-                cs.last_trace_host_tracing_start = time.time_ns()
-                cs.last_trace_host_tracing_stop = time.time_ns()
+                with compile_data_and_stats(cd, cs):
+                    (
+                        pro,
+                        pro_traces,
+                        comp,
+                        comp_traces,
+                        epilogue,
+                        epilogue_traces,
+                        backward_fn,
+                        backward_traces,
+                        _return_none_instead_of_grads,
+                    ) = cache_entry
+                    try:
+                        cs.last_prologue_execution_start = time.time_ns()
+                        if epilogue:
+                            inps, pro_to_epi = pro(*args, **kwargs)
+                        else:
+                            inps = pro(*args, **kwargs)
+                            pro_to_epi = None
+                        cs.last_prologue_execution_stop = time.time_ns()
+                    except Exception as _:
+                        continue
+
+                    cs.last_trace_host_tracing_start = time.time_ns()
+                    cs.last_trace_host_tracing_stop = time.time_ns()
+
+                    # Updates cache statistics
+                    cs.cache_hits += 1
+                    cs.last_traces = comp_traces
+                    cs.last_interpreted_instructions = None
+                    cs.last_interpreter_log = None
+                    cs.last_prologue_traces = pro_traces
+                    cs.last_prologue = pro
+                    cs.last_prologue_transformation_start = 0
+                    cs.last_prologue_transformation_stop = 0
+                    cs.last_computation_transformation_start = 0
+                    cs.last_computation_transformation_stop = 0
 
-                # Updates cache statistics
-                cs.cache_hits += 1
-                cs.last_traces = comp_traces
-                cs.last_interpreted_instructions = None
-                cs.last_interpreter_log = None
-                cs.last_prologue_traces = pro_traces
-                cs.last_prologue = pro
-                cs.last_prologue_transformation_start = 0
-                cs.last_prologue_transformation_stop = 0
-                cs.last_computation_transformation_start = 0
-                cs.last_computation_transformation_stop = 0
-
-                return cache_entry, inps, pro_to_epi
+                    return cache_entry, inps, pro_to_epi
 
         if cd.cache_option is CACHE_OPTIONS.SAME_INPUT:
             if len(cs.interpreter_cache):
                 cache_entry = cs.interpreter_cache[0]
                 (
                     pro,
                     pro_traces,
@@ -541,44 +474,60 @@
                     fn, args, kwargs, record_history=record_history, sharp_edges=cd.sharp_edges
                 )
                 prologue_trc = jit_results.prologue_trace
                 computation_trc = jit_results.computation_trace
                 epilogue_trc = jit_results.epilogue_trace
                 last_interpreter_log = jit_results.interpreter_log
 
+            prologue_traces = [prologue_trc]
+            computation_traces = [computation_trc]
+
             if epilogue_trc is not None:
                 epilogue_traces = [epilogue_trc]
-                epilogue = epilogue_trc.python_callable()
             else:
                 epilogue_traces = None
-                epilogue = None
 
             cs.last_trace_tracing_stop = time.time_ns()
 
             # Makes the prologue callable
             cs.last_prologue_transformation_start = time.time_ns()
-            protraces = transform_for_execution(
+
+            transform: Callable
+            for transform in early_transforms:
+                prologue_trc, computation_trc, epilogue_trc = transform(
+                    prologue_trc, computation_trc, epilogue_trc, executors_list=cd.executors_list
+                )
+                prologue_traces.append(prologue_trc)
+                computation_traces.append(computation_trc)
+                if epilogue_trc is not None:
+                    epilogue_traces.append(epilogue_trc)
+
+            prologue_traces += transform_for_execution(
                 prologue_trc,
                 executors_list=(pythonex,),
                 use_del_last_used=False,
             )
-            protrace = protraces[-1]
+            protrace = prologue_traces[-1]
             pro = protrace.python_callable()
 
+            if epilogue_trc is not None:
+                epilogue = epilogue_trc.python_callable()
+            else:
+                epilogue = None
+
             cs.last_prologue_transformation_stop = time.time_ns()
 
             cs.last_prologue_execution_start = time.time_ns()
             if epilogue:
                 inps, pro_to_epi = pro(*args, **kwargs)
             else:
                 inps = pro(*args, **kwargs)
                 pro_to_epi = None
             cs.last_prologue_execution_stop = time.time_ns()
 
-            computation_traces = [computation_trc]
             cs.last_traces = computation_traces
             backward_traces = []
             cs.last_backward_traces = backward_traces
             cs.last_interpreter_log = last_interpreter_log
             cs.last_interpreted_instructions = (i for i in last_interpreter_log if isinstance(i, dis.Instruction))
 
             computation_trc = dce(computation_trc)
@@ -602,60 +551,55 @@
                     # transform_for_execution and various sorting of symbols,
                     # applying transform_for_execution after this would be
                     # breaking the order of operations
                     computation_trc, backward_trc = split_forward_backward(computation_trc, cd, cs, *inps)
                     # Note computation_trc and backward_trc have been appended to cs.last_(backward_)traces
                     # by split_forward_backward
                     extraces = cs.last_traces
-                    check(
-                        not additional_transforms,
-                        lambda: "Specifying additional_transforms is not supported with PyTorch Autograd integration",
-                    )
 
             if backward_trc is None:
-                cs.last_computation_transformation_start = time.time_ns()
-
                 ## EPILOGUE and TRANSFORMS should not mix...
                 # applies transforms
+                cs.last_computation_transformation_start = time.time_ns()
                 for transform in additional_transforms:
                     computation_trc = transform(computation_trc, executors_list=cd.executors_list)
                     computation_traces.append(computation_trc)
+                cs.last_computation_transformation_stop = time.time_ns()
 
                 with langctxs.langctx(cd.langctx):
                     extraces = transform_for_execution(
                         computation_trc,
                         executors_list=cd.executors_list,
                     )
                 computation_trc = extraces[-1]
-                cs.last_computation_transformation_stop = time.time_ns()
 
             comp = computation_trc.python_callable()
 
             if backward_trc is not None:
                 backward_fn = backward_trc.python_callable()
             else:
                 backward_fn = None
 
             # TODO RC1 Update the cache
             cache_entry = CacheEntry(
                 pro,
-                protraces,
+                prologue_traces,
                 comp,
                 extraces,
                 epilogue,
                 epilogue_traces,
                 backward_fn,
                 backward_traces,
                 return_none_instead_of_grads,
             )
             if cd.cache_option is not CACHE_OPTIONS.NO_CACHING:
                 cs.interpreter_cache.append(cache_entry)
 
             cs.last_traces += extraces
-            cs.last_prologue_traces = [prologue_trc] + protraces
+            cs.last_prologue_traces = [prologue_trc] + prologue_traces
             cs.last_prologue = pro
 
         return cache_entry, inps, pro_to_epi
 
     cd.get_computation_and_inputs = get_computation_and_inputs
 
     @wraps(fn)
@@ -699,18 +643,20 @@
         cs.last_trace_cache_stop = time.time_ns()
         cs.last_trace_host_stop = time.time_ns()
 
         return result
 
     if isinstance(fn, pytorch.nn.Module):
         fn_ = ThunderModule(fn, fn_)
+        cd._thunder_module_map[id(fn)] = fn_
 
     # Sets compile options and statistics attributes
     fn_._lc_cd = cd
     fn_._lc_cs = cs
+    fn_._lc_early_transforms = early_transforms[:]  ## transforms
     fn_._lc_transforms = additional_transforms[:]  ## transforms
     fn_._lc_post_optimization_transforms = []  ## post_optimization_transforms
 
     return fn_
 
 
 def compile(
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/benchmark_litgpt.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,16 +1,24 @@
 import os
 import time
 from typing import Any
+from contextlib import nullcontext
 
 import torch
 import functools
 from torch.utils.data import DataLoader, IterableDataset
 import torch.distributed as torch_dist
 from torch.distributed.device_mesh import init_device_mesh
+import warnings
+
+from torch.distributed.algorithms._checkpoint.checkpoint_wrapper import (
+    apply_activation_checkpointing,
+    checkpoint_wrapper,
+    CheckpointWrapper,
+)
 
 import thunder
 from thunder.tests.litgpt_model import Config, GPT, Block
 
 from lightning.fabric.utilities.throughput import measure_flops
 from lightning.fabric.utilities import Throughput
 
@@ -37,18 +45,16 @@
 
 
 def run_fwd_bwd_one_microbatch(
     model: torch.nn.Module,
     input_ids: torch.Tensor,
     targets: torch.Tensor,
     gradient_accumulation_steps: int,
-    te_ctx: Any,
 ) -> torch.Tensor:
-    with te_ctx():
-        logits = model(input_ids)
+    logits = model(input_ids)
     logits = logits.reshape(-1, logits.size(-1))
     targets = targets.reshape(-1)
     loss = torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1) / gradient_accumulation_steps
     loss.backward()
     return loss
 
 
@@ -63,14 +69,15 @@
         global_batch_size: int | None = None,
         model_name: str = "Llama-2-7b-hf",
         shard_mode: str = "zero2",
         bucketing_mode: str = "none",
         sharding_size: int | None = None,
         ddp_bucket_size: float = 256.0,
         fsdp_bucket_params: float | None = None,
+        checkpoint_activations: bool = False,
         n_layers: int | None = None,
         profiler_start: int = 15,
         profiler_stop: int = 15,
         skip_data_sync: bool = False,
     ):
         seed = 1337
         torch.manual_seed(seed)
@@ -93,14 +100,15 @@
         self.dynamic = dynamic
         self.distributed_mode = distributed_mode
         self.shard_mode = shard_mode
         self.bucketing_mode = bucketing_mode
         self.sharding_size = sharding_size
         self.ddp_bucket_size = ddp_bucket_size
         self.fsdp_bucket_params = fsdp_bucket_params
+        self.checkpoint_activations = checkpoint_activations
         self.micro_batch_size = micro_batch_size
 
         # Clarify benchmark assumptions
         if self.sharding_size is not None:
             assert (
                 "thunder" not in self.compile
             ), "Hybrid Sharding (FSDP/DP) using --sharding_size is not yet supported for Thunder. Coming soon."
@@ -146,14 +154,17 @@
         ), f"Global Batch Size {self.global_batch_size} should be a multiple of Micro Batch Size {self.micro_batch_size}."
         self.gradient_accumulation_steps = int(self.global_batch_size / self.micro_batch_size)
         if world_size:
             self.gradient_accumulation_steps = int(self.gradient_accumulation_steps / world_size)
             assert (
                 self.global_batch_size % self.micro_batch_size * world_size == 0
             ), f"Global Batch Size {self.global_batch_size} should be a multiple Micro Batch Size {self.micro_batch_size} * World Size {world_size}."
+
+        if self.checkpoint_activations:
+            assert "thunder" not in self.compile, "Activations checkpointing is not supported for Thunder."
         self.skip_data_sync = skip_data_sync
 
         # Profiling Args
         self.nsys_enabled = nsys_enabled
         self.profiler_start = profiler_start
         self.profiler_stop = profiler_stop
 
@@ -165,14 +176,18 @@
         print(f"Loading model with {self.config.__dict__}")
         self.model = self.init_model()
         print(f"Time to instantiate model: {time.perf_counter() - t0:.02f} seconds.")
 
         # Setup the distributed algorithm choices
         self.model = self.setup_distributed(self.model)
 
+        # Setup activations checkpointing
+        if self.checkpoint_activations:
+            self.setup_activation_checkpointing()
+
         # Initialize the optimizer after the model is sharded if using FSDP
         self.optimizer = configure_optimizers(
             self.model, weight_decay, learning_rate, (beta1, beta2), device_type="cuda"
         )
 
         # Compile the model
         self.model = self.setup_compile(self.model)
@@ -269,14 +284,25 @@
                     auto_wrap_policy=custom_wrap_policy,
                     device_id=local_rank,
                     use_orig_params=True,
                     device_mesh=mesh,
                 )
         return model
 
+    def setup_activation_checkpointing(self):
+        if any(isinstance(mod, CheckpointWrapper) for mod in self.model.modules()):
+            warnings.warn(
+                "FSDP checkpointing is configured, but the model already contains checkpointed layers."
+                " Checkpointing will be ignored."
+            )
+            return
+
+        check_fn = lambda submodule: isinstance(submodule, Block)
+        apply_activation_checkpointing(self.model, checkpoint_wrapper_fn=checkpoint_wrapper, check_fn=check_fn)
+
     def setup_compile(self, model):
         if self.compile == "inductor":
             print("Resetting cache size for torch.compile")
             import torch._dynamo.config as dynamo_config
 
             dynamo_config.cache_size_limit = 64
             model = torch.compile(model)
@@ -347,23 +373,14 @@
         t0 = None
         if global_rank in [0, None]:
             # Calculate the model FLOPs
             self.calculate_model_flops()
             # Setup throughput Collection
             self.throughput = Throughput(window_size=self.max_iters - self.warmup_iter, world_size=world_size)
 
-        if "transformerengine" in self.compile:
-            import transformer_engine.pytorch as te
-
-            te_ctx = te.fp8_autocast
-        else:
-            from contextlib import nullcontext
-
-            te_ctx = nullcontext
-
         if self.skip_data_sync:
             data_sync_ctx = self.model.no_sync
         else:
             data_sync_ctx = nullcontext
 
         for i in range(self.max_iters):
             iter_t0 = time.perf_counter()
@@ -376,22 +393,20 @@
                     input_ids = input_ids.to(device=self.device)
                     targets = targets.to(device=self.device)
 
                     if self.nsys_enabled and i == self.profiler_start and global_rank in [0, None] and step_idx == 0:
                         print("=====Start NSYS Profiling======")
                         torch.cuda.cudart().cudaProfilerStart()
 
-                    loss = run_fwd_bwd_one_microbatch(
-                        self.model, input_ids, targets, self.gradient_accumulation_steps, te_ctx
-                    )
+                    loss = run_fwd_bwd_one_microbatch(self.model, input_ids, targets, self.gradient_accumulation_steps)
 
             input_ids, targets = next(self.train_data_iter)
             input_ids = input_ids.to(device=self.device)
             targets = targets.to(device=self.device)
-            loss = run_fwd_bwd_one_microbatch(self.model, input_ids, targets, self.gradient_accumulation_steps, te_ctx)
+            loss = run_fwd_bwd_one_microbatch(self.model, input_ids, targets, self.gradient_accumulation_steps)
 
             # Simple Gradient Accumulation Implementation
             self.optimizer.step()
             self.optimizer.zero_grad(set_to_none=True)
 
             if self.nsys_enabled and i == self.profiler_stop and global_rank in [0, None]:
                 print("=====Stop NSYS Profiling======")
@@ -518,7 +533,11 @@
 
 if __name__ == "__main__":
     torch.set_float32_matmul_precision("high")
 
     from jsonargparse import CLI
 
     CLI(benchmark_main)
+
+    # ref: https://github.com/pytorch/pytorch/blob/3af12447/torch/csrc/distributed/c10d/ProcessGroupNCCL.cpp#L1110-L1116
+    if world_size > 1:
+        torch_dist.destroy_process_group()
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/einsum.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/targets.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240513/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files 2% similar despite different names*

```diff
@@ -96,21 +96,21 @@
             with pd.ExcelWriter(filename, engine="xlsxwriter") as writer:
                 self.iter_time_df.to_excel(writer, sheet_name="Average Iter Time (ms)")
                 self.tokens_per_sec_df.to_excel(writer, sheet_name="Tokens per sec")
                 self.tokens_per_sec_per_gpu_df.to_excel(writer, sheet_name="Tokens per sec per GPU")
                 self.memory_used_GB_df.to_excel(writer, sheet_name="Memory allocated GB")
         elif self.output_format == "print":
             print("\nAVERAGE ITERATION TIME (ms)")
-            print(self.iter_time_df)
+            print(self.iter_time_df.to_string())
             print("\nTHROUGHPUT (tokens/s)")
-            print(self.tokens_per_sec_df)
+            print(self.tokens_per_sec_df.to_string())
             print("\nNORMALIZED THROUGHPUT (tokens/s/GPU)")
-            print(self.tokens_per_sec_per_gpu_df)
+            print(self.tokens_per_sec_per_gpu_df.to_string())
             print("\nMEMORY ALLOCATED (GB)")
-            print(self.memory_used_GB_df)
+            print(self.memory_used_GB_df.to_string())
 
     def run_benchmark(self, kwargs):
         command_list = []
         for key, val in kwargs.items():
             command_list.append("--" + str(key) + "=" + str(val))
         if kwargs["distributed_mode"] != "none":
             nproc_per_node = torch.cuda.device_count()
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/clang/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -1795,14 +1795,21 @@
         a = a != 0
     if not utils.is_boolean_dtype(dtypes.to_dtype(b)):
         b = b != 0
 
     return a & b
 
 
+@clangop()
+def logical_not(a: TensorLike, /) -> TensorLike:
+    if not utils.is_boolean_dtype(dtypes.to_dtype(a)):
+        return a == 0
+    return ~a
+
+
 @clangop(method_name="le")
 def le(a, b):
     return _elementwise_binary_wrapper(
         a, b, prim=prims.le, type_promotion_kind=utils.ELEMENTWISE_TYPE_PROMOTION_KIND.ALWAYS_BOOL
     )
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240513/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/common.py` & `lightning_thunder-0.2.0.dev20240513/thunder/common.py`

 * *Files 0% similar despite different names*

```diff
@@ -211,14 +211,18 @@
         self.debug_log = debug_log
 
         # TODO Consider validating that this dict has exclusively string keys
         self.compile_options = compile_options
 
         self.is_module = isinstance(self.fn, torch.nn.Module)
 
+        # to not introduce (more) ref cycles, make this int->ThunderModule with
+        # but the accessor has to check if tmm[id(module)]._module is module
+        self._thunder_module_map = {}
+
         # We set the process_group_for_ddp attribute on the module when
         # thunder.distributed.ddp(module) is called.
         self.process_group_for_ddp = getattr(self.fn, "process_group_for_ddp", None)
 
         #
         # Possibly processes the function
         #
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/baseutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/interpreter.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/jit_ext.py`

 * *Files 3% similar despite different names*

```diff
@@ -110,14 +110,15 @@
 #
 
 
 EXT_FLAG_IS_PROXY_DERIVED = 1
 EXT_FLAG_IS_TENSOR_PROXY = 2
 EXT_FLAG_IS_MODULE_MEMBER_DICT = 4
 EXT_FLAG_IS_MODULE = 8
+EXT_FLAG_IS_CALLABLE = 16
 MODULE_MEMBER_DICT_ATTRS = {
     "_parameters",
     "_modules",
     "_buffers",
     "__dict__",
 }
 
@@ -499,21 +500,15 @@
             assert len(pr.inputs) == 2
             lhs, rhs = pr.inputs
             postfix = get_postfix(lhs)
 
             if rhs.inst == PseudoInst.CONSTANT:
                 rhs_postfix = str(rhs.value)
 
-                if pr.inst == PseudoInst.BINARY_SUBSCR:
-                    maybe_module_pr = lhs
-                else:
-                    # LOAD_ATTR
-                    maybe_module_pr = pr
-
-                if maybe_module_pr.ext_flag & EXT_FLAG_IS_MODULE_MEMBER_DICT:
+                if lhs.ext_flag & EXT_FLAG_IS_MODULE:
                     if rhs_postfix not in MODULE_MEMBER_DICT_ATTRS:
                         postfix.append(rhs_postfix)
                 else:
                     postfix.append(rhs_postfix)
 
             return postfix
         else:
@@ -1038,23 +1033,36 @@
     return all(should_register_for_prologue(i) for i in pr.inputs)
 
 
 def _general_jit_wrap_callback(value):
     ctx: GeneralJitCtx = get_general_jit_ctx()
 
     uvalue = value.value
+    # for modules, rewrite m.__dict__["key"] to m.key
+    if (
+        value.provenance.inst is PseudoInst.BINARY_SUBSCR
+        and value.provenance.inputs[0].inst is PseudoInst.LOAD_ATTR
+        and value.provenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
+        and value.provenance.inputs[0].inputs[1].inst is PseudoInst.CONSTANT
+        and value.provenance.inputs[0].inputs[1].value == "__dict__"
+    ):
+        value.provenance = ProvenanceRecord(
+            PseudoInst.LOAD_ATTR,
+            inputs=[value.provenance.inputs[0].inputs[0], value.provenance.inputs[1]],
+            ext_flag=value.provenance.ext_flag,
+        )
     if isinstance(uvalue, torch.nn.Module):
         value.provenance.ext_flag |= EXT_FLAG_IS_MODULE
     elif isinstance(uvalue, torch.Tensor):
         # we always want to proxy torch.Tensor, even const
         p = ctx.proxify(value)
     elif value.provenance.inst is PseudoInst.CONSTANT:
         value.provenance.ext_flag |= EXT_FLAG_IS_PROXY_DERIVED
     elif callable(uvalue):
-        pass  # we only care if it is called
+        value.provenance.ext_flag |= EXT_FLAG_IS_CALLABLE
     elif type(uvalue) in (tuple, list, dict, CellType, ModuleType, set):
         pass  # basic containers are OK, too, subclasses?
     elif isinstance(uvalue, Proxy):
         value.provenance.ext_flag |= EXT_FLAG_IS_PROXY_DERIVED
     elif isinstance(uvalue, (float, int, complex, str)) and not isinstance(uvalue, Proxy):
         if value.provenance.ext_flag & EXT_FLAG_IS_PROXY_DERIVED:  # we already have seen this
             pass
@@ -1120,15 +1128,15 @@
             intermediates_set.add(v)
 
     return inputs_list, intermediates_set
 
 
 def unpack_inputs(ctx, prologue_trace, pro_to_comp_inps, pro_to_epi_inps, args, kwargs, *, has_epilogue: bool):
     already_unpacked: dict[int, Proxy] = {}
-    is_pure = True
+    orig_modules: dict[int, Proxy] = {}
 
     # param_ordering[id(proxy] is a list that contains either finite numbers or (strings preceded by math.inf)
     param_ordering: dict[int, list] = {}
 
     # Unpacks the inputs in the prologue trace
     # TODO Generate unpacking constraints
     def unpack(v: Variable | Proxy) -> Proxy:
@@ -1149,53 +1157,55 @@
         def from_input(provenance, *, new_output=False):
             assert new_output
             if provenance.inst == PseudoInst.INPUT_ARGS:
                 param_ordering[id(pro_args_proxy)] = (pro_args_proxy, [0])
                 return pro_args_proxy
             elif provenance.inst == PseudoInst.INPUT_KWARGS:
                 param_ordering[id(pro_kwargs_proxy)] = (pro_kwargs_proxy, [1])
-                is_pure = False
                 return pro_kwargs_proxy
             elif provenance.inst == PseudoInst.INPUT_FN:
-                is_pure = False
                 if provenance.ext_flag & EXT_FLAG_IS_MODULE:
                     name = "module"
                 else:
                     name = "fn"
                 output = Proxy(name=name)
                 param_ordering[id(output)] = (output, [3])
                 provenance.proxy = output
                 bsym = prims.unpack_function_obj.bind(output, output=output)
                 prologue_trace.bound_symbols.append(bsym)
                 return output
             assert False
 
         def from_load_attr(provenance, *, new_output=False):
-            is_pure = False
-            inputs = [from_provenance(i, new_output=True) for i in provenance.inputs]
+            obj, name = (from_provenance(i, new_output=True) for i in provenance.inputs)
+            orig_obj = obj
+            if provenance.inputs[0].ext_flag & EXT_FLAG_IS_MODULE and provenance.ext_flag & EXT_FLAG_IS_CALLABLE:
+                obj = orig_modules.get(id(obj), obj)
+
             if new_output:
                 output = Proxy("obj")
             else:
                 output = p
-            param_ordering[id(output)] = (output, param_ordering[id(inputs[0])][1] + [math.inf, "." + str(inputs[1])])
-            bsym = prims.unpack_attr.bind(inputs[0], inputs[1], output=output)
+            param_ordering[id(output)] = (output, param_ordering[id(orig_obj)][1] + [math.inf, "." + str(name)])
+            bsym = prims.unpack_attr.bind(obj, name, output=output)
             prologue_trace.bound_symbols.append(bsym)
             return output
 
         def from_constant(provenance, *, new_output=False):
             if isinstance(provenance.value, (int, str)):
                 return provenance.value
             else:
                 raise NotImplementedError(f"constant of type {type(provenance.value)} {provenance.value}")
 
-        def unpack_parameter_or_buffer(provenance, *, new_output=False):
-            assert provenance.inputs[0].inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
+        def unpack_parameter_or_buffer_or_submodule(provenance, *, new_output=False):
+            assert provenance.inputs[0].inst is PseudoInst.LOAD_ATTR
+            assert provenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
             typ = provenance.inputs[0].inputs[1].value
             name = [provenance.inputs[1].value]
-            mprovenance = provenance.inputs[0].inputs[0].inputs[0]
+            mprovenance = provenance.inputs[0].inputs[0]
 
             while (
                 mprovenance.inst is PseudoInst.BINARY_SUBSCR
                 and mprovenance.inputs[1].inst is PseudoInst.CONSTANT
                 and mprovenance.inputs[0].inst is PseudoInst.LOAD_ATTR
                 and mprovenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
             ):
@@ -1206,15 +1216,15 @@
 
                 name_component = mprovenance.inputs[1].value
                 name.insert(0, name_component)
                 mprovenance = mprovenance.inputs[0].inputs[0]
 
             root_module = from_provenance(mprovenance, new_output=True)
             if new_output:
-                output = Proxy("")  # name? collectify?
+                output = Proxy("m")  # name? collectify?
             else:
                 output = p
 
             param_ordering[id(output)] = (
                 output,
                 param_ordering[id(root_module)][1]
                 + [
@@ -1225,29 +1235,33 @@
                     )
                 ],
             )
 
             name = ".".join(name)
             if typ == "_parameters":
                 bsym = prims.unpack_parameter.bind(root_module, name, output=output)
-            else:
+            elif typ == "_buffers":
                 bsym = prims.unpack_buffer.bind(root_module, name, output=output)
+            elif typ == "_modules":
+                bsym = prims.unpack_submodule.bind(root_module, name, output=output)
+            else:
+                assert False
             prologue_trace.bound_symbols.append(bsym)
+            return output
 
         def from_binary_subscr(provenance, *, new_output=False):
             # special case tensors, todo: do this via pattern matching after unpacking?
             if (
                 provenance.inst is PseudoInst.BINARY_SUBSCR
-                and provenance.inputs[0].inst is PseudoInst.BINARY_SUBSCR
-                and provenance.inputs[1].inst is PseudoInst.CONSTANT
+                and provenance.inputs[0].inst is PseudoInst.LOAD_ATTR
                 and provenance.inputs[0].inputs[1].inst is PseudoInst.CONSTANT
-                and provenance.inputs[0].inputs[1].value in {"_parameters", "_buffers"}
-                and provenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE_MEMBER_DICT
+                and provenance.inputs[0].inputs[1].value in {"_parameters", "_buffers", "_modules"}
+                and provenance.inputs[0].inputs[0].ext_flag & EXT_FLAG_IS_MODULE
             ):
-                return unpack_parameter_or_buffer(provenance, new_output=new_output)
+                return unpack_parameter_or_buffer_or_submodule(provenance, new_output=new_output)
 
             inputs = [from_provenance(i, new_output=True) for i in provenance.inputs]
             obj, idx = inputs
             if new_output:
                 output = Proxy("subscr")  # name? collectify?
             else:
                 output = p
@@ -1311,14 +1325,24 @@
                 "OPAQUE": from_opaque,
             }
 
             unpack_fn = d.get(inst)
             if unpack_fn is None:
                 raise NotImplementedError(f"Unpacking from {inst} {provenance}")
             res = unpack_fn(provenance, new_output=new_output)
+
+            if provenance.ext_flag & EXT_FLAG_IS_MODULE:
+                assert prologue_trace.bound_symbols[-1].output is res
+                if prologue_trace.bound_symbols[-1].sym != prims.unpack_submodule:
+                    orig_module = Proxy("module")
+                    prologue_trace.bound_symbols[-1].output = orig_module
+                    bsym = prims.unpack_thunder_module.bind(orig_module, output=res)
+                    orig_modules[id(res)] = orig_module
+                    prologue_trace.bound_symbols.append(bsym)
+
             provenance.proxy = res
             return res
 
         assert isinstance(p.history, ProvenanceRecord), p.history
         with tracectx(prologue_trace):
             try:
                 from_provenance(p.history)
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/langctxs.py`

 * *Files 10% similar despite different names*

```diff
@@ -59,17 +59,25 @@
 
 def reset_langctx(token: Any, /) -> None:
     """Resets the language context."""
     _langctx.reset(token)
 
 
 # A helper for acquiring a method
-def resolve_method(id: Any, *args, **kwargs) -> Callable:
-    ctx: LanguageContext = get_langctx()
-    method: Callable = ctx.get_method(id, *args, **kwargs)
+def resolve_method(id: Any, *args, **kwargs) -> None | Callable:
+    try:
+        ctx: None | LanguageContext = get_langctx()
+    except LookupError:
+        return None
+    try:
+        # ctx.get_method throws an AttributeError when the context does not have the requested attribute, except
+        # for the prims language context, which always throws a ValueError
+        method: Callable = ctx.get_method(id, *args, **kwargs)
+    except (AttributeError, ValueError) as e:
+        return None
     return method
 
 
 _langctx_registry: dict[Any, LanguageContext] = {}
 
 
 def register_langctx(id: Any, ctx: LanguageContext) -> None:
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/prims.py`

 * *Files 1% similar despite different names*

```diff
@@ -117,14 +117,16 @@
     UNPACK_SEQUENCE = auto()
     UNPACK_TRIVIAL = auto()
     UNPACK_TUPLE = auto()
     UNPACK_LIST = auto()
     UNPACK_DICT_KEY = auto()
     UNPACK_PARAMETER = auto()
     UNPACK_BUFFER = auto()
+    UNPACK_SUBMODULE = auto()
+    UNPACK_THUNDER_MODULE = auto()
     CONSTRUCT_TUPLE = auto()
     PACK_SETITEM = auto()
     # TODO: UNPACK_SET
     # Utility prims
     COMMENT = auto()
     DEL = auto()
     PRINT = auto()
@@ -685,14 +687,51 @@
     meta=unpack_function_obj_meta,
     python_printer=unpack_function_obj_printer,
     python_impl=unpack_function_obj_impl,
     _bind_postprocess=_unpack_trivial_bind_postprocess,
 )
 
 
+def unpack_thunder_module_impl(x: Any, /) -> Any:
+    return x
+
+
+def unpack_thunder_module_meta(x: Any, /) -> Any:
+    return x
+
+
+def unpack_thunder_module_printer(
+    bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
+) -> str:
+    utils.check(
+        len(arg_printables) == 1,
+        lambda: f"Expected one argument for unpack_thunder_module but got {arg_printables}",
+        exception_type=AssertionError,
+    )
+    utils.check(
+        len(kwarg_printables) == 0,
+        lambda: f"Expected no kwargs for unpack_thunder_module but got {kwarg_printables}",
+        exception_type=AssertionError,
+    )
+
+    result_str = "_" if bsym.output is None else f"{codeutils.prettyprint(out_printables, with_type=True)}"
+    arg_str = codeutils.prettyprint(arg_printables[0])
+    s = f"{result_str} = thunder.core.module.get_thunder_module({arg_str})"
+    return s
+
+
+unpack_thunder_module = make_prim(
+    PrimIDs.UNPACK_THUNDER_MODULE,
+    "unpack_thunder_module",
+    meta=unpack_thunder_module_meta,
+    python_printer=unpack_thunder_module_printer,
+    python_impl=unpack_thunder_module_impl,
+)
+
+
 def unpack_cache_info_impl(x: Any, /, *, name: str | None = None) -> Any:
     return x
 
 
 def unpack_cache_info_meta(x: Any, /, *, name: str | None = None) -> Any:
     return x
 
@@ -948,83 +987,124 @@
     meta=unpack_attr_meta,
     python_printer=unpack_attr_printer,
     python_impl=unpack_attr_impl,
 )
 
 
 # NOTE UNPACK_PARAMETER is intended only to be bound to directly, and not called
-def unpack_parameter_meta(o: Any, key: str) -> Any:
+def unpack_parameter_meta(o: Any, key: str, /) -> Any:
     raise NotImplementedError
 
 
 def unpack_parameter_printer(
     bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
 ):
     utils.check(
         len(arg_printables) == 2,
-        lambda: f"Expected two arguments for unpack_attr but got {arg_printables}",
+        lambda: f"Expected two arguments for unpack_parameter but got {arg_printables}",
         exception_type=AssertionError,
     )
     utils.check(
         len(kwarg_printables) == 0,
-        lambda: f"Expected no kwargs for unpack_attr but got {kwarg_printables}",
+        lambda: f"Expected no kwargs for unpack_parameter but got {kwarg_printables}",
         exception_type=AssertionError,
     )
 
     # Converts printables to strings
     origin, key = arg_printables
     origin_str = codeutils.prettyprint(origin)
     keystr = codeutils.prettyprint(key)
     outstr = codeutils.prettyprint(out_printables, with_type=True, literals_as_underscores=True)
 
     return f"{outstr} = {origin_str}.get_parameter({keystr})"
 
 
-def unpack_parameter_impl(o: Any, key: str) -> Any:
+def unpack_parameter_impl(o: Any, key: str, /) -> Any:
     return o.get_parameter(key)
 
 
 unpack_parameter = make_prim(
     PrimIDs.UNPACK_PARAMETER,
     "unpack_parameter",
     meta=unpack_parameter_meta,
     python_printer=unpack_parameter_printer,
     python_impl=unpack_parameter_impl,
 )
 
 
+# NOTE UNPACK_SUBMODULE is intended only to be bound to directly, and not called
+def unpack_submodule_meta(o: Any, key: str, /) -> Any:
+    raise NotImplementedError
+
+
+def unpack_submodule_printer(
+    bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
+):
+    utils.check(
+        len(arg_printables) == 2,
+        lambda: f"Expected two arguments for unpack_submodule but got {arg_printables}",
+        exception_type=AssertionError,
+    )
+    utils.check(
+        len(kwarg_printables) == 0,
+        lambda: f"Expected no kwargs for unpack_submodule but got {kwarg_printables}",
+        exception_type=AssertionError,
+    )
+
+    # Converts printables to strings
+    origin, key = arg_printables
+    origin_str = codeutils.prettyprint(origin)
+    keystr = codeutils.prettyprint(key)
+    outstr = codeutils.prettyprint(out_printables, with_type=True, literals_as_underscores=True)
+
+    return f"{outstr} = {origin_str}.get_submodule({keystr})"
+
+
+def unpack_submodule_impl(o: Any, key: str, /) -> Any:
+    return o.get_submodule(key)
+
+
+unpack_submodule = make_prim(
+    PrimIDs.UNPACK_SUBMODULE,
+    "unpack_submodule",
+    meta=unpack_submodule_meta,
+    python_printer=unpack_submodule_printer,
+    python_impl=unpack_submodule_impl,
+)
+
+
 # NOTE UNPACK_BUFFER is intended only to be bound to directly, and not called
-def unpack_buffer_meta(o: Any, key: str) -> Any:
+def unpack_buffer_meta(o: Any, key: str, /) -> Any:
     raise NotImplementedError
 
 
 def unpack_buffer_printer(
     bsym: BoundSymbol, out_printables: Any, arg_printables: Sequence[Printable], kwarg_printables: dict[str, Printable]
 ):
     utils.check(
         len(arg_printables) == 2,
-        lambda: f"Expected two arguments for unpack_attr but got {arg_printables}",
+        lambda: f"Expected two arguments for unpack_buffer but got {arg_printables}",
         exception_type=AssertionError,
     )
     utils.check(
         len(kwarg_printables) == 0,
-        lambda: f"Expected no kwargs for unpack_attr but got {kwarg_printables}",
+        lambda: f"Expected no kwargs for unpack_buffer but got {kwarg_printables}",
         exception_type=AssertionError,
     )
 
     # Converts printables to strings
     origin, key = arg_printables
     origin_str = codeutils.prettyprint(origin)
     keystr = codeutils.prettyprint(key)
     outstr = codeutils.prettyprint(out_printables, with_type=True, literals_as_underscores=True)
 
     return f"{outstr} = {origin_str}.get_buffer({keystr})"
 
 
-def unpack_buffer_impl(o: Any, key: str) -> Any:
+def unpack_buffer_impl(o: Any, key: str, /) -> Any:
     return o.get_buffer(key)
 
 
 unpack_buffer = make_prim(
     PrimIDs.UNPACK_BUFFER,
     "unpack_buffer",
     meta=unpack_buffer_meta,
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/proxies.py`

 * *Files 0% similar despite different names*

```diff
@@ -1124,19 +1124,14 @@
     @property
     def requires_grad(self):
         return self._requires_grad
 
     def type_string(self):
         return f"FUTURE {self.device} {self.dtype.shortname()}{list(self.shape)}"
 
-    @property
-    def size(self, /) -> Any:
-        fn = resolve_method("size", self)
-        return fn(self)
-
     def wait(self) -> TensorProxy:
         from thunder.distributed.prims import wait
 
         return wait(self)
 
     def replace_name(self, name: str):
         """Return a copy of this proxy with the given name."""
@@ -1175,18 +1170,14 @@
     #   themselves into the trace, so they can be used when working with tensor proxies
     #   outside of a trace or language context
     @property
     def shape(self):
         return self._shape
 
     @property
-    def numel(self):
-        return self._numel
-
-    @property
     def ndim(self):
         return self._ndim
 
     @property
     def device(self):
         return self._device
 
@@ -1202,19 +1193,14 @@
     def requires_grad(self):
         return self._requires_grad
 
     @property
     def ddp_type(self):
         return self._ddp_type
 
-    @property
-    def size(self, /) -> Any:
-        fn = resolve_method("size", self)
-        return fn(self)
-
     # We need to implement `__len__` as
     # > In addition to bypassing any instance attributes in the
     # > interest of correctness, implicit special method lookup
     # > generally also bypasses the __getattribute__() method
     # > even of the object’s metaclass
     # Ref: https://docs.python.org/3/reference/datamodel.html#special-method-lookup
     def __len__(self):
@@ -1228,22 +1214,32 @@
 
     def type_string(self):
         return f"{self.device} {self.dtype.shortname()}{list(self.shape)}"
 
     # NOTE __getattr__ is overridden to support language-specific methods
     def __getattr__(self, attr: str, /):
         method_or_value: None | Callable | Any = resolve_method(attr, self)
+        if method_or_value is None:
+            method_or_value = self.get_default_attr(attr)
         baseutils.check(method_or_value is not None, lambda: f"Unknown attribute {attr}", exception_type=AttributeError)
 
         if callable(method_or_value):
             return partial(method_or_value, self)
 
         return method_or_value
 
     #
+    # Default attribute
+    #
+    def get_default_attr(self, attr: str, /) -> None | Any:
+        if attr == "numel":
+            return self._numel
+        return None
+
+    #
     # Datatype conversion shorthands
     #
 
     def float(self):
         method = resolve_method("float", self)
         return method(self)
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/rematerialization.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/symbol.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/trace.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/transforms.py`

 * *Files 2% similar despite different names*

```diff
@@ -920,7844 +920,7897 @@
 00003970: 2020 2072 6573 6574 5f74 7261 6365 6374     reset_tracect
 00003980: 7828 7472 6163 6563 7478 5f74 6f6b 290a  x(tracectx_tok).
 00003990: 0a0a 230a 2320 436f 6d70 6f73 6162 6c65  ..#.# Composable
 000039a0: 2074 7261 6e73 666f 726d 730a 230a 0a0a   transforms.#...
 000039b0: 2320 4865 6c70 6572 2066 756e 6374 696f  # Helper functio
 000039c0: 6e20 746f 2061 6464 2061 2074 7261 6e73  n to add a trans
 000039d0: 666f 726d 0a64 6566 2061 6464 5f74 7261  form.def add_tra
-000039e0: 6e73 666f 726d 2863 666e 3a20 4361 6c6c  nsform(cfn: Call
-000039f0: 6162 6c65 2c20 7472 616e 7366 6f72 6d3a  able, transform:
-00003a00: 2043 616c 6c61 626c 6529 202d 3e20 4361   Callable) -> Ca
-00003a10: 6c6c 6162 6c65 3a0a 2020 2020 6672 6f6d  llable:.    from
-00003a20: 2074 6875 6e64 6572 2e63 6f6d 6d6f 6e20   thunder.common 
-00003a30: 696d 706f 7274 205f 6372 6561 7465 5f63  import _create_c
-00003a40: 616c 6c61 626c 652c 2043 6f6d 7069 6c65  allable, Compile
-00003a50: 4461 7461 2c20 436f 6d70 696c 6553 7461  Data, CompileSta
-00003a60: 7473 0a0a 2020 2020 6364 3a20 4e6f 6e65  ts..    cd: None
-00003a70: 207c 2041 6e79 203d 2067 6574 6174 7472   | Any = getattr
-00003a80: 2863 666e 2c20 225f 6c63 5f63 6422 2c20  (cfn, "_lc_cd", 
-00003a90: 4e6f 6e65 290a 0a20 2020 2075 7469 6c73  None)..    utils
-00003aa0: 2e63 6865 636b 2863 6420 6973 206e 6f74  .check(cd is not
-00003ab0: 204e 6f6e 652c 206c 616d 6264 613a 2066   None, lambda: f
-00003ac0: 2243 616e 206f 6e6c 7920 7472 616e 7366  "Can only transf
-00003ad0: 6f72 6d20 636f 6d70 696c 6564 2074 6875  orm compiled thu
-00003ae0: 6e64 6572 2066 756e 6374 696f 6e73 2229  nder functions")
-00003af0: 0a20 2020 2075 7469 6c73 2e63 6865 636b  .    utils.check
-00003b00: 2869 7369 6e73 7461 6e63 6528 6364 2c20  (isinstance(cd, 
-00003b10: 436f 6d70 696c 6544 6174 6129 2c20 6c61  CompileData), la
-00003b20: 6d62 6461 3a20 6622 466f 756e 6420 616e  mbda: f"Found an
-00003b30: 2075 6e6b 6e6f 776e 2063 6f6d 7069 6c65   unknown compile
-00003b40: 2064 6174 6120 6174 7472 6962 7574 6520   data attribute 
-00003b50: 7b63 647d 2229 0a0a 2020 2020 6966 2063  {cd}")..    if c
-00003b60: 642e 7573 696e 675f 6a69 743a 0a20 2020  d.using_jit:.   
-00003b70: 2020 2020 2066 726f 6d20 7468 756e 6465       from thunde
-00003b80: 7220 696d 706f 7274 206a 6974 0a0a 2020  r import jit..  
-00003b90: 2020 2020 2020 7265 7475 726e 206a 6974        return jit
-00003ba0: 280a 2020 2020 2020 2020 2020 2020 6364  (.            cd
-00003bb0: 2e66 6e2c 0a20 2020 2020 2020 2020 2020  .fn,.           
-00003bc0: 206c 616e 6763 7478 3d63 642e 6c61 6e67   langctx=cd.lang
-00003bd0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00003be0: 2065 7865 6375 746f 7273 3d63 642e 6578   executors=cd.ex
-00003bf0: 6563 7574 6f72 735f 6c69 7374 2c0a 2020  ecutors_list,.  
-00003c00: 2020 2020 2020 2020 2020 7368 6172 705f            sharp_
-00003c10: 6564 6765 733d 6364 2e73 6861 7270 5f65  edges=cd.sharp_e
-00003c20: 6467 6573 2c0a 2020 2020 2020 2020 2020  dges,.          
-00003c30: 2020 2320 6361 6368 652c 2069 6e74 6572    # cache, inter
-00003c40: 7072 6574 6174 696f 6e3f 0a20 2020 2020  pretation?.     
-00003c50: 2020 2020 2020 2061 6464 6974 696f 6e61         additiona
-00003c60: 6c5f 7472 616e 7366 6f72 6d73 3d63 666e  l_transforms=cfn
-00003c70: 2e5f 6c63 5f74 7261 6e73 666f 726d 7320  ._lc_transforms 
-00003c80: 2b20 5b74 7261 6e73 666f 726d 5d2c 0a20  + [transform],. 
-00003c90: 2020 2020 2020 2020 2020 2064 6973 6162             disab
-00003ca0: 6c65 5f74 6f72 6368 5f61 7574 6f67 7261  le_torch_autogra
-00003cb0: 643d 5472 7565 2c20 2023 2063 642e 6469  d=True,  # cd.di
-00003cc0: 7361 626c 655f 746f 7263 685f 6175 746f  sable_torch_auto
-00003cd0: 6772 6164 5f73 7570 706f 7274 2c0a 2020  grad_support,.  
-00003ce0: 2020 2020 2020 2020 2020 2a2a 6364 2e63            **cd.c
-00003cf0: 6f6d 7069 6c65 5f6f 7074 696f 6e73 2c0a  ompile_options,.
-00003d00: 2020 2020 2020 2020 290a 0a20 2020 2063          )..    c
-00003d10: 7320 3d20 6765 7461 7474 7228 6366 6e2c  s = getattr(cfn,
-00003d20: 2022 5f6c 635f 6373 222c 204e 6f6e 6529   "_lc_cs", None)
-00003d30: 0a20 2020 2069 6620 6373 2069 7320 4e6f  .    if cs is No
-00003d40: 6e65 3a0a 2020 2020 2020 2020 6373 203d  ne:.        cs =
-00003d50: 2043 6f6d 7069 6c65 5374 6174 7328 290a   CompileStats().
-00003d60: 0a20 2020 2074 7261 6e73 666f 726d 7320  .    transforms 
-00003d70: 3d20 6366 6e2e 5f6c 635f 7472 616e 7366  = cfn._lc_transf
-00003d80: 6f72 6d73 202b 205b 7472 616e 7366 6f72  orms + [transfor
-00003d90: 6d5d 0a20 2020 2070 6f74 7261 6e73 666f  m].    potransfo
-00003da0: 726d 7320 3d20 6366 6e2e 5f6c 635f 706f  rms = cfn._lc_po
-00003db0: 7374 5f6f 7074 696d 697a 6174 696f 6e5f  st_optimization_
-00003dc0: 7472 616e 7366 6f72 6d73 0a20 2020 2075  transforms.    u
-00003dd0: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
-00003de0: 6f72 6d20 3d20 6366 6e2e 5f75 7369 6e67  orm = cfn._using
-00003df0: 5f67 7261 645f 7472 616e 7366 6f72 6d0a  _grad_transform.
-00003e00: 0a20 2020 206e 6366 6e20 3d20 5f63 7265  .    ncfn = _cre
-00003e10: 6174 655f 6361 6c6c 6162 6c65 280a 2020  ate_callable(.  
-00003e20: 2020 2020 2020 6364 2c0a 2020 2020 2020        cd,.      
-00003e30: 2020 6373 2c0a 2020 2020 2020 2020 7472    cs,.        tr
-00003e40: 616e 7366 6f72 6d73 3d74 7261 6e73 666f  ansforms=transfo
-00003e50: 726d 732c 0a20 2020 2020 2020 2070 6f73  rms,.        pos
-00003e60: 745f 6f70 7469 6d69 7a61 7469 6f6e 5f74  t_optimization_t
-00003e70: 7261 6e73 666f 726d 733d 706f 7472 616e  ransforms=potran
-00003e80: 7366 6f72 6d73 2c0a 2020 2020 2020 2020  sforms,.        
-00003e90: 5f75 7369 6e67 5f67 7261 645f 7472 616e  _using_grad_tran
-00003ea0: 7366 6f72 6d3d 7573 696e 675f 6772 6164  sform=using_grad
-00003eb0: 5f74 7261 6e73 666f 726d 2c0a 2020 2020  _transform,.    
-00003ec0: 290a 2020 2020 7265 7475 726e 206e 6366  ).    return ncf
-00003ed0: 6e0a 0a0a 2320 544f 444f 2043 6f6e 7369  n...# TODO Consi
-00003ee0: 6465 7220 7265 6661 6374 6f72 696e 6720  der refactoring 
-00003ef0: 7468 6973 2077 6974 6820 7468 6520 6162  this with the ab
-00003f00: 6f76 650a 2320 4865 6c70 6572 2066 756e  ove.# Helper fun
-00003f10: 6374 696f 6e20 746f 2061 6464 2061 2070  ction to add a p
-00003f20: 6f73 742d 6f70 7469 6d69 7a61 7469 6f6e  ost-optimization
-00003f30: 2074 7261 6e73 666f 726d 0a64 6566 2061   transform.def a
-00003f40: 6464 5f70 6f73 745f 6f70 7469 6d69 7a61  dd_post_optimiza
-00003f50: 7469 6f6e 5f74 7261 6e73 666f 726d 2863  tion_transform(c
-00003f60: 666e 3a20 4361 6c6c 6162 6c65 2c20 7472  fn: Callable, tr
-00003f70: 616e 7366 6f72 6d3a 2043 616c 6c61 626c  ansform: Callabl
-00003f80: 6529 202d 3e20 4361 6c6c 6162 6c65 3a0a  e) -> Callable:.
-00003f90: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00003fa0: 2e63 6f6d 6d6f 6e20 696d 706f 7274 205f  .common import _
-00003fb0: 6372 6561 7465 5f63 616c 6c61 626c 652c  create_callable,
-00003fc0: 2043 6f6d 7069 6c65 4461 7461 2c20 436f   CompileData, Co
-00003fd0: 6d70 696c 6553 7461 7473 0a0a 2020 2020  mpileStats..    
-00003fe0: 6364 3a20 4e6f 6e65 207c 2041 6e79 203d  cd: None | Any =
-00003ff0: 2067 6574 6174 7472 2863 666e 2c20 225f   getattr(cfn, "_
-00004000: 6c63 5f63 6422 2c20 4e6f 6e65 290a 0a20  lc_cd", None).. 
-00004010: 2020 2075 7469 6c73 2e63 6865 636b 2863     utils.check(c
-00004020: 6420 6973 206e 6f74 204e 6f6e 652c 206c  d is not None, l
-00004030: 616d 6264 613a 2066 2243 616e 206f 6e6c  ambda: f"Can onl
-00004040: 7920 7472 616e 7366 6f72 6d20 636f 6d70  y transform comp
-00004050: 696c 6564 2074 6875 6e64 6572 2066 756e  iled thunder fun
-00004060: 6374 696f 6e73 2229 0a20 2020 2075 7469  ctions").    uti
-00004070: 6c73 2e63 6865 636b 2869 7369 6e73 7461  ls.check(isinsta
-00004080: 6e63 6528 6364 2c20 436f 6d70 696c 6544  nce(cd, CompileD
-00004090: 6174 6129 2c20 6c61 6d62 6461 3a20 6622  ata), lambda: f"
-000040a0: 466f 756e 6420 616e 2075 6e6b 6e6f 776e  Found an unknown
-000040b0: 2063 6f6d 7069 6c65 2064 6174 6120 6174   compile data at
-000040c0: 7472 6962 7574 6520 7b63 647d 2229 0a0a  tribute {cd}")..
-000040d0: 2020 2020 6373 203d 2043 6f6d 7069 6c65      cs = Compile
-000040e0: 5374 6174 7328 290a 2020 2020 7472 616e  Stats().    tran
-000040f0: 7366 6f72 6d73 203d 2063 666e 2e5f 6c63  sforms = cfn._lc
-00004100: 5f74 7261 6e73 666f 726d 730a 2020 2020  _transforms.    
-00004110: 706f 7472 616e 7366 6f72 6d73 203d 2063  potransforms = c
-00004120: 666e 2e5f 6c63 5f70 6f73 745f 6f70 7469  fn._lc_post_opti
-00004130: 6d69 7a61 7469 6f6e 5f74 7261 6e73 666f  mization_transfo
-00004140: 726d 7320 2b20 5b74 7261 6e73 666f 726d  rms + [transform
-00004150: 5d0a 0a20 2020 206e 6366 6e20 3d20 5f63  ]..    ncfn = _c
-00004160: 7265 6174 655f 6361 6c6c 6162 6c65 2863  reate_callable(c
-00004170: 642c 2063 732c 2074 7261 6e73 666f 726d  d, cs, transform
-00004180: 733d 7472 616e 7366 6f72 6d73 2c20 706f  s=transforms, po
-00004190: 7374 5f6f 7074 696d 697a 6174 696f 6e5f  st_optimization_
-000041a0: 7472 616e 7366 6f72 6d73 3d70 6f74 7261  transforms=potra
-000041b0: 6e73 666f 726d 7329 0a20 2020 2072 6574  nsforms).    ret
-000041c0: 7572 6e20 6e63 666e 0a0a 0a23 2054 6865  urn ncfn...# The
-000041d0: 206e 6f2d 6f70 2074 7261 6e73 666f 726d   no-op transform
-000041e0: 2e20 4120 7472 6976 6961 6c20 636f 6d70  . A trivial comp
-000041f0: 6f73 6162 6c65 2074 7261 6e73 666f 726d  osable transform
-00004200: 2c20 6f6e 6c79 2075 7365 6675 6c20 6173  , only useful as
-00004210: 2061 6e20 6578 616d 706c 652e 0a64 6566   an example..def
-00004220: 205f 6e6f 6f70 5f74 7261 6e73 666f 726d   _noop_transform
-00004230: 2874 7261 6365 3a20 5472 6163 652c 202a  (trace: Trace, *
-00004240: 2a6b 7761 7267 7329 202d 3e20 5472 6163  *kwargs) -> Trac
-00004250: 653a 0a20 2020 2073 7461 7274 5f74 696d  e:.    start_tim
-00004260: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
-00004270: 5f6e 7328 290a 2020 2020 6e6f 6f70 5f74  _ns().    noop_t
-00004280: 7261 6365 203d 2066 726f 6d5f 7472 6163  race = from_trac
-00004290: 6528 7472 6163 6529 0a0a 2020 2020 7472  e(trace)..    tr
-000042a0: 6163 6563 7478 5f74 6f6b 3a20 416e 790a  acectx_tok: Any.
-000042b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000042c0: 2074 7261 6365 6374 785f 746f 6b20 3d20   tracectx_tok = 
-000042d0: 7365 745f 7472 6163 6563 7478 286e 6f6f  set_tracectx(noo
-000042e0: 705f 7472 6163 6529 0a20 2020 2020 2020  p_trace).       
-000042f0: 2070 7269 6d73 2e63 6f6d 6d65 6e74 2822   prims.comment("
-00004300: 5468 6973 2063 6f6d 6d65 6e74 2061 6464  This comment add
-00004310: 6564 2062 7920 7468 6520 6e6f 2d6f 7020  ed by the no-op 
-00004320: 7472 616e 7366 6f72 6d22 290a 2020 2020  transform").    
-00004330: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
-00004340: 2072 6573 6574 5f74 7261 6365 6374 7828   reset_tracectx(
-00004350: 7472 6163 6563 7478 5f74 6f6b 290a 0a20  tracectx_tok).. 
-00004360: 2020 206e 6f6f 705f 7472 6163 652e 626f     noop_trace.bo
-00004370: 756e 645f 7379 6d62 6f6c 732e 6578 7465  und_symbols.exte
-00004380: 6e64 2874 7261 6365 2e62 6f75 6e64 5f73  nd(trace.bound_s
-00004390: 796d 626f 6c73 290a 0a20 2020 2065 6e64  ymbols)..    end
-000043a0: 5f74 696d 655f 6e73 203d 2074 696d 652e  _time_ns = time.
-000043b0: 7469 6d65 5f6e 7328 290a 2020 2020 656c  time_ns().    el
-000043c0: 6170 7365 645f 7469 6d65 5f6e 7320 3d20  apsed_time_ns = 
-000043d0: 656e 645f 7469 6d65 5f6e 7320 2d20 7374  end_time_ns - st
-000043e0: 6172 745f 7469 6d65 5f6e 730a 2020 2020  art_time_ns.    
-000043f0: 656c 6170 7365 645f 7469 6d65 5f6d 696c  elapsed_time_mil
-00004400: 6c69 7320 3d20 656c 6170 7365 645f 7469  lis = elapsed_ti
-00004410: 6d65 5f6e 7320 2f2f 2031 3030 3030 3030  me_ns // 1000000
-00004420: 0a20 2020 206e 6f6f 705f 7472 6163 652e  .    noop_trace.
-00004430: 7365 745f 7072 6f76 656e 616e 6365 2854  set_provenance(T
-00004440: 7261 6365 5072 6f76 656e 616e 6365 2866  raceProvenance(f
-00004450: 224e 6f2d 6f70 2054 7261 6e73 666f 726d  "No-op Transform
-00004460: 2028 746f 6f6b 207b 656c 6170 7365 645f   (took {elapsed_
-00004470: 7469 6d65 5f6d 696c 6c69 737d 206d 696c  time_millis} mil
-00004480: 6c69 7365 636f 6e64 7329 2229 290a 0a20  liseconds)")).. 
-00004490: 2020 2072 6574 7572 6e20 6e6f 6f70 5f74     return noop_t
-000044a0: 7261 6365 0a0a 0a64 6566 206e 6f6f 7028  race...def noop(
-000044b0: 6366 6e3a 2043 616c 6c61 626c 6529 202d  cfn: Callable) -
-000044c0: 3e20 4361 6c6c 6162 6c65 3a0a 2020 2020  > Callable:.    
-000044d0: 7265 7475 726e 2061 6464 5f74 7261 6e73  return add_trans
-000044e0: 666f 726d 2863 666e 2c20 5f6e 6f6f 705f  form(cfn, _noop_
-000044f0: 7472 616e 7366 6f72 6d29 0a0a 0a23 2054  transform)...# T
-00004500: 6865 2063 6f6d 6d65 6e74 2066 7573 696f  he comment fusio
-00004510: 6e73 2074 7261 6e73 666f 726d 2e20 4a75  ns transform. Ju
-00004520: 7374 2061 6464 7320 6120 636f 6d6d 656e  st adds a commen
-00004530: 7420 6265 666f 7265 2061 6e64 2061 6674  t before and aft
-00004540: 6572 2065 6163 6820 6675 7369 6f6e 2e0a  er each fusion..
-00004550: 2320 2020 5468 6973 2069 7320 616e 2065  #   This is an e
-00004560: 7861 6d70 6c65 206f 6620 6120 706f 7374  xample of a post
-00004570: 2d6f 7074 696d 697a 6174 696f 6e20 7472  -optimization tr
-00004580: 616e 7366 6f72 6d2e 0a64 6566 205f 636f  ansform..def _co
-00004590: 6d6d 656e 745f 6675 7369 6f6e 735f 7472  mment_fusions_tr
-000045a0: 616e 7366 6f72 6d28 7472 6163 653a 2054  ansform(trace: T
-000045b0: 7261 6365 2c20 2a2a 6b77 6172 6773 2920  race, **kwargs) 
-000045c0: 2d3e 2054 7261 6365 3a0a 2020 2020 7374  -> Trace:.    st
-000045d0: 6172 745f 7469 6d65 5f6e 7320 3d20 7469  art_time_ns = ti
-000045e0: 6d65 2e74 696d 655f 6e73 2829 0a20 2020  me.time_ns().   
-000045f0: 2063 6f6d 6d65 6e74 6564 5f74 7261 6365   commented_trace
-00004600: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
-00004610: 6163 6529 0a0a 2020 2020 6e62 7379 6d73  ace)..    nbsyms
-00004620: 3a20 6c69 7374 5b42 6f75 6e64 5379 6d62  : list[BoundSymb
-00004630: 6f6c 5d20 3d20 5b5d 0a20 2020 2066 6f72  ol] = [].    for
-00004640: 2062 7379 6d20 696e 2074 7261 6365 2e62   bsym in trace.b
-00004650: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
-00004660: 2020 2020 2020 6966 2062 7379 6d2e 7379        if bsym.sy
-00004670: 6d2e 6973 5f66 7573 696f 6e3a 0a20 2020  m.is_fusion:.   
-00004680: 2020 2020 2020 2020 2066 7573 696f 6e5f           fusion_
-00004690: 6e61 6d65 203d 2062 7379 6d2e 7379 6d2e  name = bsym.sym.
-000046a0: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-000046b0: 2070 7265 5f63 6f6d 6d65 6e74 5f62 7379   pre_comment_bsy
-000046c0: 6d20 3d20 7072 696d 732e 636f 6d6d 656e  m = prims.commen
-000046d0: 742e 6269 6e64 2866 2242 6566 6f72 6520  t.bind(f"Before 
-000046e0: 7b66 7573 696f 6e5f 6e61 6d65 7d22 2c20  {fusion_name}", 
-000046f0: 6f75 7470 7574 3d4e 6f6e 6529 0a20 2020  output=None).   
-00004700: 2020 2020 2020 2020 2070 6f73 745f 636f           post_co
-00004710: 6d6d 656e 745f 6273 796d 203d 2070 7269  mment_bsym = pri
-00004720: 6d73 2e63 6f6d 6d65 6e74 2e62 696e 6428  ms.comment.bind(
-00004730: 6622 4166 7465 7220 7b66 7573 696f 6e5f  f"After {fusion_
-00004740: 6e61 6d65 7d22 2c20 6f75 7470 7574 3d4e  name}", output=N
-00004750: 6f6e 6529 0a0a 2020 2020 2020 2020 2020  one)..          
-00004760: 2020 6e62 7379 6d73 2e65 7874 656e 6428    nbsyms.extend(
-00004770: 5b70 7265 5f63 6f6d 6d65 6e74 5f62 7379  [pre_comment_bsy
-00004780: 6d2c 2062 7379 6d2c 2070 6f73 745f 636f  m, bsym, post_co
-00004790: 6d6d 656e 745f 6273 796d 5d29 0a20 2020  mment_bsym]).   
-000047a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000047b0: 2020 2020 2020 206e 6273 796d 732e 6170         nbsyms.ap
-000047c0: 7065 6e64 2862 7379 6d29 0a0a 2020 2020  pend(bsym)..    
-000047d0: 636f 6d6d 656e 7465 645f 7472 6163 652e  commented_trace.
-000047e0: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-000047f0: 6e62 7379 6d73 0a20 2020 2065 6e64 5f74  nbsyms.    end_t
-00004800: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
-00004810: 6d65 5f6e 7328 290a 2020 2020 656c 6170  me_ns().    elap
-00004820: 7365 645f 7469 6d65 5f6e 7320 3d20 656e  sed_time_ns = en
-00004830: 645f 7469 6d65 5f6e 7320 2d20 7374 6172  d_time_ns - star
-00004840: 745f 7469 6d65 5f6e 730a 2020 2020 656c  t_time_ns.    el
-00004850: 6170 7365 645f 7469 6d65 5f6d 696c 6c69  apsed_time_milli
-00004860: 7320 3d20 656c 6170 7365 645f 7469 6d65  s = elapsed_time
-00004870: 5f6e 7320 2f2f 2031 3030 3030 3030 0a0a  _ns // 1000000..
-00004880: 2020 2020 636f 6d6d 656e 7465 645f 7472      commented_tr
-00004890: 6163 652e 7365 745f 7072 6f76 656e 616e  ace.set_provenan
-000048a0: 6365 2854 7261 6365 5072 6f76 656e 616e  ce(TraceProvenan
-000048b0: 6365 2866 2243 6f6d 6d65 6e74 2046 7573  ce(f"Comment Fus
-000048c0: 696f 6e73 2028 746f 6f6b 207b 656c 6170  ions (took {elap
-000048d0: 7365 645f 7469 6d65 5f6d 696c 6c69 737d  sed_time_millis}
-000048e0: 206d 696c 6c69 7365 636f 6e64 7329 2229   milliseconds)")
-000048f0: 290a 0a20 2020 2072 6574 7572 6e20 636f  )..    return co
-00004900: 6d6d 656e 7465 645f 7472 6163 650a 0a0a  mmented_trace...
-00004910: 6465 6620 636f 6d6d 656e 745f 6675 7369  def comment_fusi
-00004920: 6f6e 7328 6366 6e3a 2043 616c 6c61 626c  ons(cfn: Callabl
-00004930: 6529 202d 3e20 4361 6c6c 6162 6c65 3a0a  e) -> Callable:.
-00004940: 2020 2020 7265 7475 726e 2061 6464 5f70      return add_p
-00004950: 6f73 745f 6f70 7469 6d69 7a61 7469 6f6e  ost_optimization
-00004960: 5f74 7261 6e73 666f 726d 2863 666e 2c20  _transform(cfn, 
-00004970: 5f63 6f6d 6d65 6e74 5f66 7573 696f 6e73  _comment_fusions
-00004980: 5f74 7261 6e73 666f 726d 290a 0a0a 230a  _transform)...#.
-00004990: 2320 4865 6c70 6572 2066 756e 6374 696f  # Helper functio
-000049a0: 6e73 2066 6f72 2063 6f6d 706f 7361 626c  ns for composabl
-000049b0: 6520 7472 616e 7366 6f72 6d73 0a23 0a0a  e transforms.#..
-000049c0: 0a23 2046 6c61 7474 656e 7320 6120 6c69  .# Flattens a li
-000049d0: 7374 206f 6620 626f 756e 6420 7379 6d62  st of bound symb
-000049e0: 6f6c 732c 2072 6574 7572 6e69 6e67 2074  ols, returning t
-000049f0: 6865 2066 6c61 7474 656e 6564 206c 6973  he flattened lis
-00004a00: 740a 6465 6620 666c 6174 7465 6e5f 666f  t.def flatten_fo
-00004a10: 725f 7472 616e 7366 6f72 6d28 7368 6f75  r_transform(shou
-00004a20: 6c64 5f66 6c61 7474 656e 3a20 4361 6c6c  ld_flatten: Call
-00004a30: 6162 6c65 2c20 6273 796d 733a 206c 6973  able, bsyms: lis
-00004a40: 745b 426f 756e 6453 796d 626f 6c5d 2920  t[BoundSymbol]) 
-00004a50: 2d3e 206c 6973 745b 426f 756e 6453 796d  -> list[BoundSym
-00004a60: 626f 6c5d 3a0a 2020 2020 666c 6174 7465  bol]:.    flatte
-00004a70: 6e65 643a 206c 6973 745b 426f 756e 6453  ned: list[BoundS
-00004a80: 796d 626f 6c5d 203d 205b 5d0a 0a20 2020  ymbol] = []..   
-00004a90: 2064 6566 205f 666c 6174 7465 6e28 6273   def _flatten(bs
-00004aa0: 796d 3a20 426f 756e 6453 796d 626f 6c29  ym: BoundSymbol)
-00004ab0: 3a0a 2020 2020 2020 2020 6966 2073 686f  :.        if sho
-00004ac0: 756c 645f 666c 6174 7465 6e28 6273 796d  uld_flatten(bsym
-00004ad0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00004ae0: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
-00004af0: 2020 2020 2020 6c65 6e28 6273 796d 2e73        len(bsym.s
-00004b00: 7562 7379 6d62 6f6c 7329 203e 2030 2c0a  ubsymbols) > 0,.
-00004b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b20: 6c61 6d62 6461 3a20 6622 4e6f 2067 7261  lambda: f"No gra
-00004b30: 6420 7275 6c65 2066 6f75 6e64 2066 6f72  d rule found for
-00004b40: 207b 6273 796d 7d20 616e 6420 6e6f 2073   {bsym} and no s
-00004b50: 7562 7379 6d62 6f6c 7320 696e 7369 6465  ubsymbols inside
-00004b60: 2069 7420 746f 2063 7265 6174 6520 6120   it to create a 
-00004b70: 6772 6164 2066 6f72 6d75 6c61 222c 0a20  grad formula",. 
-00004b80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00004b90: 2020 2020 2020 2020 2066 6f72 2073 6273           for sbs
-00004ba0: 796d 2069 6e20 6273 796d 2e73 7562 7379  ym in bsym.subsy
-00004bb0: 6d62 6f6c 733a 0a20 2020 2020 2020 2020  mbols:.         
-00004bc0: 2020 2020 2020 205f 666c 6174 7465 6e28         _flatten(
-00004bd0: 7362 7379 6d29 0a20 2020 2020 2020 2065  sbsym).        e
-00004be0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00004bf0: 2066 6c61 7474 656e 6564 2e61 7070 656e   flattened.appen
-00004c00: 6428 6273 796d 290a 0a20 2020 2066 6f72  d(bsym)..    for
-00004c10: 2062 7379 6d20 696e 2062 7379 6d73 3a0a   bsym in bsyms:.
-00004c20: 2020 2020 2020 2020 5f66 6c61 7474 656e          _flatten
-00004c30: 2862 7379 6d29 0a0a 2020 2020 7265 7475  (bsym)..    retu
-00004c40: 726e 2066 6c61 7474 656e 6564 0a0a 0a23  rn flattened...#
-00004c50: 0a23 2050 6861 6e74 6f6d 2067 7261 6420  .# Phantom grad 
-00004c60: 7472 616e 7366 6f72 6d0a 230a 0a23 0a23  transform.#..#.#
-00004c70: 2046 756e 6374 696f 6e73 2072 656c 6174   Functions relat
-00004c80: 6564 2074 6f20 6675 6e63 7469 6f6e 616c  ed to functional
-00004c90: 697a 696e 6720 5468 756e 6465 724f 7074  izing ThunderOpt
-00004ca0: 696d 697a 6564 4d6f 6475 6c65 730a 230a  imizedModules.#.
-00004cb0: 0a0a 2320 544f 444f 2054 6573 7420 7769  ..# TODO Test wi
-00004cc0: 7468 2062 7566 6665 7273 0a64 6566 2070  th buffers.def p
-00004cd0: 6f70 756c 6174 655f 6772 6164 7328 6772  opulate_grads(gr
-00004ce0: 6164 733a 206c 6973 745b 5465 6e73 6f72  ads: list[Tensor
-00004cf0: 5072 6f78 795d 2c20 746f 6d3a 204e 6f6e  Proxy], tom: Non
-00004d00: 6520 7c20 746f 7263 682e 6e6e 2e4d 6f64  e | torch.nn.Mod
-00004d10: 756c 6520 3d20 4e6f 6e65 2c20 6172 6773  ule = None, args
-00004d20: 3d4e 6f6e 652c 206b 7761 7267 733d 4e6f  =None, kwargs=No
-00004d30: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
-00004d40: 2069 6478 3a20 696e 7420 3d20 300a 2020   idx: int = 0.  
-00004d50: 2020 6672 6f6d 2074 6875 6e64 6572 2069    from thunder i
-00004d60: 6d70 6f72 7420 5468 756e 6465 724d 6f64  mport ThunderMod
-00004d70: 756c 652c 2063 6f6d 7069 6c65 5f64 6174  ule, compile_dat
-00004d80: 610a 0a20 2020 2069 6620 6973 696e 7374  a..    if isinst
-00004d90: 616e 6365 2874 6f6d 2c20 5468 756e 6465  ance(tom, Thunde
-00004da0: 724d 6f64 756c 6529 206f 7220 636f 6d70  rModule) or comp
-00004db0: 696c 655f 6461 7461 2874 6f6d 292e 7573  ile_data(tom).us
-00004dc0: 696e 675f 6a69 743a 0a20 2020 2020 2020  ing_jit:.       
-00004dd0: 2061 7373 6572 7420 6172 6773 2069 7320   assert args is 
-00004de0: 6e6f 7420 4e6f 6e65 2c20 2270 6f70 756c  not None, "popul
-00004df0: 6174 6520 6772 6164 206e 6565 6473 2061  ate grad needs a
-00004e00: 7267 7320 2861 6e64 2070 6f73 7369 626c  rgs (and possibl
-00004e10: 7920 6b77 6172 6773 2920 746f 2077 6f72  y kwargs) to wor
-00004e20: 6b20 7769 7468 2054 6875 6e64 6572 4d6f  k with ThunderMo
-00004e30: 6475 6c65 7322 0a20 2020 2020 2020 2069  dules".        i
-00004e40: 6620 6b77 6172 6773 2069 7320 4e6f 6e65  f kwargs is None
-00004e50: 3a0a 2020 2020 2020 2020 2020 2020 6b77  :.            kw
-00004e60: 6172 6773 203d 207b 7d0a 2020 2020 2020  args = {}.      
-00004e70: 2020 5f2c 2063 6f6d 7075 7461 7469 6f6e    _, computation
-00004e80: 5f69 6e70 7574 732c 205f 203d 2063 6f6d  _inputs, _ = com
-00004e90: 7069 6c65 5f64 6174 6128 746f 6d29 2e67  pile_data(tom).g
-00004ea0: 6574 5f63 6f6d 7075 7461 7469 6f6e 5f61  et_computation_a
-00004eb0: 6e64 5f69 6e70 7574 7328 2a61 7267 732c  nd_inputs(*args,
-00004ec0: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-00004ed0: 2020 2066 6f72 2070 2069 6e20 636f 6d70     for p in comp
-00004ee0: 7574 6174 696f 6e5f 696e 7075 7473 3a0a  utation_inputs:.
-00004ef0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00004f00: 7369 6e73 7461 6e63 6528 702c 2074 6f72  sinstance(p, tor
-00004f10: 6368 2e54 656e 736f 7229 2061 6e64 2070  ch.Tensor) and p
-00004f20: 2e72 6571 7569 7265 735f 6772 6164 3a0a  .requires_grad:.
-00004f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f40: 2320 5375 7070 6f72 7473 2067 7261 6420  # Supports grad 
-00004f50: 6163 6375 6d75 6c61 7469 6f6e 2028 6c69  accumulation (li
-00004f60: 6b65 2077 6865 6e20 7765 6967 6874 2074  ke when weight t
-00004f70: 7969 6e67 290a 2020 2020 2020 2020 2020  ying).          
-00004f80: 2020 2020 2020 6966 2070 2e67 7261 6420        if p.grad 
-00004f90: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00004fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fb0: 2070 2e67 7261 6420 2b3d 2067 7261 6473   p.grad += grads
-00004fc0: 5b69 6478 5d0a 2020 2020 2020 2020 2020  [idx].          
-00004fd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00004fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ff0: 702e 6772 6164 203d 2067 7261 6473 5b69  p.grad = grads[i
-00005000: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
-00005010: 2020 2020 6964 7820 2b3d 2031 0a20 2020      idx += 1.   
-00005020: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00005030: 2023 2053 686f 7274 2d63 6972 6375 6974   # Short-circuit
-00005040: 7320 6966 2074 6865 7265 2061 7265 206e  s if there are n
-00005050: 6f20 6172 6773 206f 7220 6b77 6172 6773  o args or kwargs
-00005060: 0a20 2020 2069 6620 6172 6773 2069 7320  .    if args is 
-00005070: 4e6f 6e65 2061 6e64 206b 7761 7267 7320  None and kwargs 
-00005080: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00005090: 2072 6574 7572 6e0a 0a20 2020 2066 6c61   return..    fla
-000050a0: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
-000050b0: 7474 656e 2828 6172 6773 2c20 6b77 6172  tten((args, kwar
-000050c0: 6773 2929 0a20 2020 2066 6f72 2066 2069  gs)).    for f i
-000050d0: 6e20 666c 6174 733a 0a20 2020 2020 2020  n flats:.       
-000050e0: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
-000050f0: 2c20 746f 7263 682e 5465 6e73 6f72 2920  , torch.Tensor) 
-00005100: 616e 6420 662e 7265 7175 6972 6573 5f67  and f.requires_g
-00005110: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-00005120: 2066 2e67 7261 6420 3d20 6772 6164 735b   f.grad = grads[
-00005130: 6964 785d 0a20 2020 2020 2020 2020 2020  idx].           
-00005140: 2069 6478 202b 3d20 310a 0a0a 6465 6620   idx += 1...def 
-00005150: 6578 7472 6163 745f 6772 6164 7328 6d6f  extract_grads(mo
-00005160: 6475 6c65 3a20 746f 7263 682e 6e6e 2e4d  dule: torch.nn.M
-00005170: 6f64 756c 6529 202d 3e20 7475 706c 655b  odule) -> tuple[
-00005180: 746f 7263 682e 5465 6e73 6f72 2c20 2e2e  torch.Tensor, ..
-00005190: 2e5d 3a0a 2020 2020 6772 6164 7320 3d20  .]:.    grads = 
-000051a0: 7475 706c 6528 0a20 2020 2020 2020 2066  tuple(.        f
-000051b0: 2e67 7261 640a 2020 2020 2020 2020 666f  .grad.        fo
-000051c0: 7220 6620 696e 2063 6861 696e 286d 6f64  r f in chain(mod
-000051d0: 756c 652e 7061 7261 6d65 7465 7273 2829  ule.parameters()
-000051e0: 2c20 6d6f 6475 6c65 2e62 7566 6665 7273  , module.buffers
-000051f0: 2829 290a 2020 2020 2020 2020 6966 2069  ()).        if i
-00005200: 7369 6e73 7461 6e63 6528 662c 2074 6f72  sinstance(f, tor
-00005210: 6368 2e54 656e 736f 7229 2061 6e64 2066  ch.Tensor) and f
-00005220: 2e72 6571 7569 7265 735f 6772 6164 2061  .requires_grad a
-00005230: 6e64 2066 2e67 7261 6420 6973 206e 6f74  nd f.grad is not
-00005240: 204e 6f6e 650a 2020 2020 290a 2020 2020   None.    ).    
-00005250: 7265 7475 726e 2067 7261 6473 0a0a 0a64  return grads...d
-00005260: 6566 2063 6c65 6172 5f67 7261 6473 286d  ef clear_grads(m
-00005270: 6f64 756c 653a 2074 6f72 6368 2e6e 6e2e  odule: torch.nn.
-00005280: 4d6f 6475 6c65 2920 2d3e 204e 6f6e 653a  Module) -> None:
-00005290: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
-000052a0: 7374 616e 6365 286d 6f64 756c 652c 2074  stance(module, t
-000052b0: 6f72 6368 2e6e 6e2e 4d6f 6475 6c65 293a  orch.nn.Module):
-000052c0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-000052d0: 0a20 2020 2066 6f72 2070 2069 6e20 6d6f  .    for p in mo
-000052e0: 6475 6c65 2e70 6172 616d 6574 6572 7328  dule.parameters(
-000052f0: 293a 0a20 2020 2020 2020 2070 2e67 7261  ):.        p.gra
-00005300: 6420 3d20 4e6f 6e65 0a20 2020 2066 6f72  d = None.    for
-00005310: 2062 2069 6e20 6d6f 6475 6c65 2e62 7566   b in module.buf
-00005320: 6665 7273 2829 3a0a 2020 2020 2020 2020  fers():.        
-00005330: 622e 6772 6164 203d 204e 6f6e 650a 0a0a  b.grad = None...
-00005340: 6672 6f6d 2074 6875 6e64 6572 2e63 6f72  from thunder.cor
-00005350: 652e 696e 7465 7270 7265 7465 7220 696d  e.interpreter im
-00005360: 706f 7274 206d 616b 655f 6f70 6171 7565  port make_opaque
-00005370: 0a66 726f 6d20 7468 756e 6465 722e 636f  .from thunder.co
-00005380: 7265 2e6c 616e 6763 7478 7320 696d 706f  re.langctxs impo
-00005390: 7274 206c 616e 6763 7478 2c20 4c61 6e67  rt langctx, Lang
-000053a0: 7561 6765 730a 0a0a 2320 544f 444f 2052  uages...# TODO R
-000053b0: 4331 2052 6570 6c61 6365 2077 6974 6820  C1 Replace with 
-000053c0: 6c61 6e67 6374 780a 6465 6620 746f 7263  langctx.def torc
-000053d0: 6863 7478 2866 6e29 3a0a 2020 2020 5f66  hctx(fn):.    _f
-000053e0: 6e20 3d20 6c61 6e67 6374 7828 4c61 6e67  n = langctx(Lang
-000053f0: 7561 6765 732e 544f 5243 4829 2866 6e29  uages.TORCH)(fn)
-00005400: 0a20 2020 2072 6574 7572 6e20 6d61 6b65  .    return make
-00005410: 5f6f 7061 7175 6528 5f66 6e29 0a0a 0a5f  _opaque(_fn)..._
-00005420: 6772 6164 5f66 6e5f 6d61 703a 2064 6963  grad_fn_map: dic
-00005430: 745b 416e 792c 2043 616c 6c61 626c 655d  t[Any, Callable]
-00005440: 203d 207b 7d0a 0a0a 6465 6620 7265 6769   = {}...def regi
-00005450: 7374 6572 5f67 7261 6428 7379 6d5f 6f72  ster_grad(sym_or
-00005460: 5f69 643a 2053 796d 626f 6c20 7c20 416e  _id: Symbol | An
-00005470: 792c 2067 7261 6466 6e3a 2043 616c 6c61  y, gradfn: Calla
-00005480: 626c 6529 202d 3e20 4e6f 6e65 3a0a 2020  ble) -> None:.  
-00005490: 2020 6964 3a20 416e 7920 3d20 7379 6d5f    id: Any = sym_
-000054a0: 6f72 5f69 640a 2020 2020 6966 2069 7369  or_id.    if isi
-000054b0: 6e73 7461 6e63 6528 7379 6d5f 6f72 5f69  nstance(sym_or_i
-000054c0: 642c 2053 796d 626f 6c29 3a0a 2020 2020  d, Symbol):.    
-000054d0: 2020 2020 6964 203d 2073 796d 5f6f 725f      id = sym_or_
-000054e0: 6964 2e69 640a 2020 2020 5f67 7261 645f  id.id.    _grad_
-000054f0: 666e 5f6d 6170 5b69 645d 203d 2067 7261  fn_map[id] = gra
-00005500: 6466 6e0a 0a0a 2320 4772 6164 2066 756e  dfn...# Grad fun
-00005510: 6374 696f 6e73 2066 6f72 2070 7269 6d73  ctions for prims
-00005520: 0a66 726f 6d20 7468 756e 6465 722e 636f  .from thunder.co
-00005530: 7265 2e70 7269 6d73 2069 6d70 6f72 7420  re.prims import 
-00005540: 5072 696d 4944 7320 6173 2070 6964 732c  PrimIDs as pids,
-00005550: 2067 6574 5f67 7261 642c 2070 7574 5f67   get_grad, put_g
-00005560: 7261 640a 0a0a 2320 4120 6765 6e65 7261  rad...# A genera
-00005570: 6c69 7a61 7469 6f6e 206f 6620 7072 696d  lization of prim
-00005580: 732e 7075 745f 6772 6164 2074 6f20 7079  s.put_grad to py
-00005590: 7472 6565 730a 2320 544f 444f 2043 6f6e  trees.# TODO Con
-000055a0: 7369 6465 7220 7661 6c69 6461 7469 6e67  sider validating
-000055b0: 2074 6861 7420 7468 6520 7370 6563 7320   that the specs 
-000055c0: 6172 6520 7468 6520 7361 6d65 0a23 2054  are the same.# T
-000055d0: 4f44 4f20 436f 6e73 6964 6572 2076 616c  ODO Consider val
-000055e0: 6964 6174 696e 6720 7468 6174 2074 6861  idating that tha
-000055f0: 7420 6f62 6a65 6374 2072 6571 7569 7265  t object require
-00005600: 7320 6772 6164 2028 616e 6420 6669 6c74  s grad (and filt
-00005610: 6572 696e 6720 6f2e 772e 290a 6465 6620  ering o.w.).def 
-00005620: 7075 745f 6772 6164 7328 612c 2067 293a  put_grads(a, g):
-00005630: 0a20 2020 2066 6c61 7473 2c20 5f20 3d20  .    flats, _ = 
-00005640: 7472 6565 5f66 6c61 7474 656e 2861 290a  tree_flatten(a).
-00005650: 2020 2020 666c 6174 6772 6164 732c 205f      flatgrads, _
-00005660: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00005670: 6729 0a0a 2020 2020 666f 7220 662c 2066  g)..    for f, f
-00005680: 6720 696e 207a 6970 2866 6c61 7473 2c20  g in zip(flats, 
-00005690: 666c 6174 6772 6164 7329 3a0a 2020 2020  flatgrads):.    
-000056a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000056b0: 6528 662c 2054 656e 736f 7250 726f 7879  e(f, TensorProxy
-000056c0: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
-000056d0: 2866 672c 2054 656e 736f 7250 726f 7879  (fg, TensorProxy
-000056e0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-000056f0: 7574 5f67 7261 6428 662c 2066 6729 0a0a  ut_grad(f, fg)..
-00005700: 0a23 0a23 2055 6e70 6163 6b69 6e67 206f  .#.# Unpacking o
-00005710: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
-00005720: 0a23 204e 4f54 4520 7072 696d 732e 756e  .# NOTE prims.un
-00005730: 7061 636b 5f65 6d70 7479 5f64 6963 7420  pack_empty_dict 
-00005740: 6372 6561 7465 7320 6e6f 2067 7261 6420  creates no grad 
-00005750: 6173 736f 6369 6174 696f 6e73 0a72 6567  associations.reg
-00005760: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00005770: 554e 5041 434b 5f45 4d50 5459 5f44 4943  UNPACK_EMPTY_DIC
-00005780: 542c 2070 7269 6d73 2e75 6e70 6163 6b5f  T, prims.unpack_
-00005790: 656d 7074 795f 6469 6374 290a 0a23 204e  empty_dict)..# N
-000057a0: 4f54 4520 7072 696d 732e 756e 7061 636b  OTE prims.unpack
-000057b0: 5f6b 6579 2063 7265 6174 6573 206e 6f20  _key creates no 
-000057c0: 6772 6164 2061 7373 6f63 6961 7469 6f6e  grad association
-000057d0: 730a 7265 6769 7374 6572 5f67 7261 6428  s.register_grad(
-000057e0: 7069 6473 2e55 4e50 4143 4b5f 4b45 592c  pids.UNPACK_KEY,
-000057f0: 2070 7269 6d73 2e75 6e70 6163 6b5f 6b65   prims.unpack_ke
-00005800: 7929 0a0a 2320 4e4f 5445 2070 7269 6d73  y)..# NOTE prims
-00005810: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
-00005820: 2063 7265 6174 6573 206e 6f20 6772 6164   creates no grad
-00005830: 2061 7373 6f63 6961 7469 6f6e 730a 7265   associations.re
-00005840: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00005850: 2e55 4e50 4143 4b5f 5345 5155 454e 4345  .UNPACK_SEQUENCE
-00005860: 2c20 7072 696d 732e 756e 7061 636b 5f73  , prims.unpack_s
-00005870: 6571 7565 6e63 6529 0a0a 0a23 0a23 2044  equence)...#.# D
-00005880: 6174 6120 6d6f 7665 6d65 6e74 2061 6e64  ata movement and
-00005890: 2074 7261 6e73 666f 726d 6174 696f 6e20   transformation 
-000058a0: 6f70 6572 6174 6f72 2067 7261 6473 0a23  operator grads.#
-000058b0: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-000058c0: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
-000058d0: 7479 7065 5f70 7269 6d5f 6772 6164 2861  type_prim_grad(a
-000058e0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-000058f0: 7250 726f 7879 2c20 6474 7970 653a 2074  rProxy, dtype: t
-00005900: 7970 6520 7c20 6474 7970 6573 2e64 7479  ype | dtypes.dty
-00005910: 7065 2920 2d3e 204e 756d 6265 7220 7c20  pe) -> Number | 
-00005920: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00005930: 2066 7764 203d 2070 7269 6d73 2e63 6f6e   fwd = prims.con
-00005940: 7665 7274 5f65 6c65 6d65 6e74 5f74 7970  vert_element_typ
-00005950: 6528 612c 2064 7479 7065 290a 0a20 2020  e(a, dtype)..   
-00005960: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00005970: 6429 0a20 2020 2067 5f63 6f6e 7665 7274  d).    g_convert
-00005980: 6564 203d 2070 7269 6d73 2e63 6f6e 7665  ed = prims.conve
-00005990: 7274 5f65 6c65 6d65 6e74 5f74 7970 6528  rt_element_type(
-000059a0: 672c 2064 7479 7065 732e 746f 5f64 7479  g, dtypes.to_dty
-000059b0: 7065 2861 2929 0a20 2020 2070 7574 5f67  pe(a)).    put_g
-000059c0: 7261 6428 612c 2067 5f63 6f6e 7665 7274  rad(a, g_convert
-000059d0: 6564 290a 0a20 2020 2072 6574 7572 6e20  ed)..    return 
-000059e0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-000059f0: 7261 6428 7069 6473 2e43 4f4e 5645 5254  rad(pids.CONVERT
-00005a00: 5f45 4c45 4d45 4e54 5f54 5950 452c 205f  _ELEMENT_TYPE, _
-00005a10: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
-00005a20: 7479 7065 5f70 7269 6d5f 6772 6164 290a  type_prim_grad).
-00005a30: 0a23 0a23 2054 656e 736f 7220 6372 6561  .#.# Tensor crea
-00005a40: 7469 6f6e 206f 7065 7261 746f 7220 6772  tion operator gr
-00005a50: 6164 730a 230a 0a23 204e 4f54 4520 7072  ads.#..# NOTE pr
-00005a60: 696d 732e 6675 6c6c 2063 7265 6174 6573  ims.full creates
-00005a70: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
-00005a80: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
-00005a90: 7261 6428 7069 6473 2e46 554c 4c2c 2070  rad(pids.FULL, p
-00005aa0: 7269 6d73 2e66 756c 6c29 0a0a 2320 4e4f  rims.full)..# NO
-00005ab0: 5445 2070 7269 6d73 2e69 6f74 6120 6372  TE prims.iota cr
-00005ac0: 6561 7465 7320 6e6f 2067 7261 6420 6173  eates no grad as
-00005ad0: 736f 6369 6174 696f 6e73 0a72 6567 6973  sociations.regis
-00005ae0: 7465 725f 6772 6164 2870 6964 732e 494f  ter_grad(pids.IO
-00005af0: 5441 2c20 7072 696d 732e 696f 7461 290a  TA, prims.iota).
-00005b00: 0a0a 6465 6620 5f75 6e69 666f 726d 5f67  ..def _uniform_g
-00005b10: 7261 6428 7368 6170 652c 206d 696e 7661  rad(shape, minva
-00005b20: 6c2c 206d 6178 7661 6c2c 202a 2c20 6465  l, maxval, *, de
-00005b30: 7669 6365 2c20 6474 7970 6529 3a0a 2020  vice, dtype):.  
-00005b40: 2020 6677 642c 2073 6176 6564 203d 2075    fwd, saved = u
-00005b50: 6e69 666f 726d 5f61 7567 5f66 7764 2873  niform_aug_fwd(s
-00005b60: 6861 7065 2c20 6d69 6e76 616c 2c20 6d61  hape, minval, ma
-00005b70: 7876 616c 2c20 6465 7669 6365 3d64 6576  xval, device=dev
-00005b80: 6963 652c 2064 7479 7065 3d64 7479 7065  ice, dtype=dtype
-00005b90: 290a 2020 2020 6720 3d20 6765 745f 6772  ).    g = get_gr
-00005ba0: 6164 2866 7764 290a 2020 2020 5f2c 2067  ad(fwd).    _, g
-00005bb0: 6d69 6e76 616c 2c20 676d 6178 7661 6c20  minval, gmaxval 
-00005bc0: 3d20 756e 6966 6f72 6d5f 6261 636b 7761  = uniform_backwa
-00005bd0: 7264 282a 7361 7665 642c 2067 290a 2020  rd(*saved, g).  
-00005be0: 2020 7075 745f 6772 6164 7328 286d 696e    put_grads((min
-00005bf0: 7661 6c2c 206d 6178 7661 6c29 2c20 2867  val, maxval), (g
-00005c00: 6d69 6e76 616c 2c20 676d 6178 7661 6c29  minval, gmaxval)
-00005c10: 290a 2020 2020 7265 7475 726e 2066 7764  ).    return fwd
-00005c20: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00005c30: 2870 6964 732e 554e 4946 4f52 4d2c 205f  (pids.UNIFORM, _
-00005c40: 756e 6966 6f72 6d5f 6772 6164 290a 0a23  uniform_grad)..#
-00005c50: 0a23 2052 6573 6861 7069 6e67 2061 6e64  .# Reshaping and
-00005c60: 2070 6572 6d75 7469 6e67 206f 7065 7261   permuting opera
-00005c70: 746f 7220 6772 6164 730a 230a 0a0a 4074  tor grads.#...@t
-00005c80: 6f72 6368 6374 780a 6465 6620 5f62 726f  orchctx.def _bro
-00005c90: 6164 6361 7374 5f69 6e5f 6469 6d5f 7072  adcast_in_dim_pr
-00005ca0: 696d 5f67 7261 6428 0a20 2020 2061 3a20  im_grad(.    a: 
-00005cb0: 5465 6e73 6f72 5072 6f78 792c 2073 6861  TensorProxy, sha
-00005cc0: 7065 3a20 5365 7175 656e 6365 5b69 6e74  pe: Sequence[int
-00005cd0: 5d2c 2062 726f 6164 6361 7374 5f64 696d  ], broadcast_dim
-00005ce0: 656e 7369 6f6e 733a 2053 6571 7565 6e63  ensions: Sequenc
-00005cf0: 655b 696e 745d 0a29 202d 3e20 5465 6e73  e[int].) -> Tens
-00005d00: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00005d10: 203d 2070 7269 6d73 2e62 726f 6164 6361   = prims.broadca
-00005d20: 7374 5f69 6e5f 6469 6d28 612c 2073 6861  st_in_dim(a, sha
-00005d30: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
-00005d40: 6d65 6e73 696f 6e73 290a 0a20 2020 2067  mensions)..    g
-00005d50: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00005d60: 0a0a 2020 2020 756e 6974 5f64 696d 7320  ..    unit_dims 
-00005d70: 3d20 7475 706c 6528 6920 666f 7220 692c  = tuple(i for i,
-00005d80: 2073 2069 6e20 656e 756d 6572 6174 6528   s in enumerate(
-00005d90: 612e 7368 6170 6529 2069 6620 7320 3d3d  a.shape) if s ==
-00005da0: 2031 290a 2020 2020 6263 6173 745f 6469   1).    bcast_di
-00005db0: 6d73 203d 2074 7570 6c65 2862 2066 6f72  ms = tuple(b for
-00005dc0: 2069 2c20 6220 696e 2065 6e75 6d65 7261   i, b in enumera
-00005dd0: 7465 2862 726f 6164 6361 7374 5f64 696d  te(broadcast_dim
-00005de0: 656e 7369 6f6e 7329 2069 6620 6920 6e6f  ensions) if i no
-00005df0: 7420 696e 2075 6e69 745f 6469 6d73 290a  t in unit_dims).
-00005e00: 2020 2020 7265 6475 6365 5f64 696d 7320      reduce_dims 
-00005e10: 3d20 7475 706c 6528 7320 666f 7220 692c  = tuple(s for i,
-00005e20: 2073 2069 6e20 656e 756d 6572 6174 6528   s in enumerate(
-00005e30: 7261 6e67 6528 6c65 6e28 7368 6170 6529  range(len(shape)
-00005e40: 2929 2069 6620 6920 6e6f 7420 696e 2062  )) if i not in b
-00005e50: 6361 7374 5f64 696d 7329 0a0a 2020 2020  cast_dims)..    
-00005e60: 6720 3d20 6c74 6f72 6368 2e73 756d 2867  g = ltorch.sum(g
-00005e70: 2c20 7265 6475 6365 5f64 696d 7329 0a0a  , reduce_dims)..
-00005e80: 2020 2020 2320 4e4f 5445 2054 6869 7320      # NOTE This 
-00005e90: 6d75 7374 2062 6520 636c 616e 672e 756e  must be clang.un
-00005ea0: 7371 7565 657a 6520 6265 6361 7573 6520  squeeze because 
-00005eb0: 746f 7263 682e 756e 7371 7565 657a 652c  torch.unsqueeze,
-00005ec0: 2075 6e6c 696b 6520 636c 616e 672e 756e   unlike clang.un
-00005ed0: 7371 7565 657a 652c 206f 6e6c 7920 6163  squeeze, only ac
-00005ee0: 6365 7074 7320 616e 2069 6e74 6567 6572  cepts an integer
-00005ef0: 0a20 2020 2023 2020 2028 7075 7420 616e  .    #   (put an
-00005f00: 6f74 6865 7220 7761 792c 2074 6f72 6368  other way, torch
-00005f10: 206f 6e6c 7920 616c 6c6f 7773 206f 6e65   only allows one
-00005f20: 2075 6e73 7175 6565 7a65 2061 7420 6120   unsqueeze at a 
-00005f30: 7469 6d65 290a 2020 2020 6720 3d20 636c  time).    g = cl
-00005f40: 616e 672e 756e 7371 7565 657a 6528 672c  ang.unsqueeze(g,
-00005f50: 2075 6e69 745f 6469 6d73 290a 0a20 2020   unit_dims)..   
-00005f60: 2070 7574 5f67 7261 6428 612c 2067 290a   put_grad(a, g).
-00005f70: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00005f80: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00005f90: 7069 6473 2e42 524f 4144 4341 5354 5f49  pids.BROADCAST_I
-00005fa0: 4e5f 4449 4d2c 205f 6272 6f61 6463 6173  N_DIM, _broadcas
-00005fb0: 745f 696e 5f64 696d 5f70 7269 6d5f 6772  t_in_dim_prim_gr
-00005fc0: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
-00005fd0: 6465 6620 5f63 6174 5f70 7269 6d5f 6772  def _cat_prim_gr
-00005fe0: 6164 2874 656e 736f 7273 3a20 6c69 7374  ad(tensors: list
-00005ff0: 5b54 656e 736f 7250 726f 7879 5d2c 202f  [TensorProxy], /
-00006000: 2c20 6469 6d3a 2069 6e74 2920 2d3e 2054  , dim: int) -> T
-00006010: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00006020: 6677 6420 3d20 7072 696d 732e 6361 7428  fwd = prims.cat(
-00006030: 7465 6e73 6f72 732c 2064 696d 290a 0a20  tensors, dim).. 
-00006040: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00006050: 6677 6429 0a0a 2020 2020 736c 6963 655f  fwd)..    slice_
-00006060: 7374 6172 743a 2069 6e74 203d 2030 0a20  start: int = 0. 
-00006070: 2020 2074 3a20 5465 6e73 6f72 5072 6f78     t: TensorProx
-00006080: 790a 2020 2020 666f 7220 7420 696e 2074  y.    for t in t
-00006090: 656e 736f 7273 3a0a 2020 2020 2020 2020  ensors:.        
-000060a0: 6469 6d5f 6c65 6e3a 2069 6e74 203d 2074  dim_len: int = t
-000060b0: 2e73 6861 7065 5b64 696d 5d0a 2020 2020  .shape[dim].    
-000060c0: 2020 2020 736c 6963 655f 656e 643a 2069      slice_end: i
-000060d0: 6e74 203d 2073 6c69 6365 5f73 7461 7274  nt = slice_start
-000060e0: 202b 2064 696d 5f6c 656e 0a20 2020 2020   + dim_len.     
-000060f0: 2020 2067 5f73 6c69 6365 3a20 5465 6e73     g_slice: Tens
-00006100: 6f72 5072 6f78 7920 3d20 636c 616e 672e  orProxy = clang.
-00006110: 736c 6963 655f 696e 5f64 696d 2867 2c20  slice_in_dim(g, 
-00006120: 736c 6963 655f 7374 6172 742c 2073 6c69  slice_start, sli
-00006130: 6365 5f65 6e64 2c20 6469 6d3d 6469 6d29  ce_end, dim=dim)
-00006140: 0a20 2020 2020 2020 2073 6c69 6365 5f73  .        slice_s
-00006150: 7461 7274 203d 2073 6c69 6365 5f65 6e64  tart = slice_end
-00006160: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
-00006170: 6428 742c 2067 5f73 6c69 6365 290a 0a20  d(t, g_slice).. 
-00006180: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00006190: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-000061a0: 6473 2e43 4154 2c20 5f63 6174 5f70 7269  ds.CAT, _cat_pri
-000061b0: 6d5f 6772 6164 290a 0a0a 6465 6620 5f72  m_grad)...def _r
-000061c0: 6573 6861 7065 5f70 7269 6d5f 6772 6164  eshape_prim_grad
-000061d0: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
-000061e0: 2073 6861 7065 3a20 7475 706c 655b 696e   shape: tuple[in
-000061f0: 742c 202e 2e2e 5d29 202d 3e20 5465 6e73  t, ...]) -> Tens
-00006200: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00006210: 203d 2070 7269 6d73 2e72 6573 6861 7065   = prims.reshape
-00006220: 2861 2c20 7368 6170 6529 0a0a 2020 2020  (a, shape)..    
-00006230: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00006240: 290a 0a20 2020 2061 5f67 7261 6420 3d20  )..    a_grad = 
-00006250: 7072 696d 732e 7265 7368 6170 6528 672c  prims.reshape(g,
-00006260: 2061 2e73 6861 7065 290a 2020 2020 7075   a.shape).    pu
-00006270: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
-00006280: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00006290: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-000062a0: 6428 7069 6473 2e52 4553 4841 5045 2c20  d(pids.RESHAPE, 
-000062b0: 5f72 6573 6861 7065 5f70 7269 6d5f 6772  _reshape_prim_gr
-000062c0: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
-000062d0: 6465 6620 5f73 6c69 6365 5f70 7269 6d5f  def _slice_prim_
-000062e0: 6772 6164 280a 2020 2020 613a 2054 656e  grad(.    a: Ten
-000062f0: 736f 7250 726f 7879 2c20 7374 6172 745f  sorProxy, start_
-00006300: 696e 6469 6365 733a 2053 6571 7565 6e63  indices: Sequenc
-00006310: 655b 696e 745d 2c20 656e 645f 696e 6469  e[int], end_indi
-00006320: 6365 733a 2053 6571 7565 6e63 655b 696e  ces: Sequence[in
-00006330: 745d 2c20 7374 7269 6465 733a 204e 6f6e  t], strides: Non
-00006340: 6520 7c20 5365 7175 656e 6365 5b69 6e74  e | Sequence[int
-00006350: 5d20 3d20 4e6f 6e65 0a29 202d 3e20 5465  ] = None.) -> Te
-00006360: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00006370: 7764 203d 2070 7269 6d73 2e73 6c69 6365  wd = prims.slice
-00006380: 5f70 7269 6d28 612c 2073 7461 7274 5f69  _prim(a, start_i
-00006390: 6e64 6963 6573 2c20 656e 645f 696e 6469  ndices, end_indi
-000063a0: 6365 732c 2073 7472 6964 6573 290a 0a20  ces, strides).. 
-000063b0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-000063c0: 6677 6429 0a0a 2020 2020 7061 6464 696e  fwd)..    paddin
-000063d0: 6720 3d20 4e6f 6e65 0a20 2020 2069 6620  g = None.    if 
-000063e0: 7374 7269 6465 7320 6973 204e 6f6e 6520  strides is None 
-000063f0: 6f72 206e 702e 616c 6c28 6e70 2e65 7175  or np.all(np.equ
-00006400: 616c 2873 7472 6964 6573 2c20 3129 293a  al(strides, 1)):
-00006410: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
-00006420: 203d 2074 7570 6c65 287a 6970 2873 7461   = tuple(zip(sta
-00006430: 7274 5f69 6e64 6963 6573 2c20 6e70 2e73  rt_indices, np.s
-00006440: 7562 7472 6163 7428 612e 7368 6170 652c  ubtract(a.shape,
-00006450: 2065 6e64 5f69 6e64 6963 6573 292c 2028   end_indices), (
-00006460: 302c 2920 2a20 6c65 6e28 7374 6172 745f  0,) * len(start_
-00006470: 696e 6469 6365 7329 2929 0a20 2020 2065  indices))).    e
-00006480: 6c73 653a 0a20 2020 2020 2020 2072 6561  lse:.        rea
-00006490: 6c5f 6c69 6d69 7473 203d 206e 702e 6164  l_limits = np.ad
-000064a0: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
-000064b0: 7461 7274 5f69 6e64 6963 6573 2c0a 2020  tart_indices,.  
-000064c0: 2020 2020 2020 2020 2020 6e70 2e77 6865            np.whe
-000064d0: 7265 286e 702e 6571 7561 6c28 672e 7368  re(np.equal(g.sh
-000064e0: 6170 652c 2030 292c 2030 2c20 6e70 2e61  ape, 0), 0, np.a
-000064f0: 6464 2831 2c20 6e70 2e6d 756c 7469 706c  dd(1, np.multipl
-00006500: 7928 6e70 2e73 7562 7472 6163 7428 672e  y(np.subtract(g.
-00006510: 7368 6170 652c 2031 292c 2073 7472 6964  shape, 1), strid
-00006520: 6573 2929 292c 0a20 2020 2020 2020 2029  es))),.        )
-00006530: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
-00006540: 203d 2074 7570 6c65 287a 6970 2873 7461   = tuple(zip(sta
-00006550: 7274 5f69 6e64 6963 6573 2c20 6e70 2e73  rt_indices, np.s
-00006560: 7562 7472 6163 7428 612e 7368 6170 652c  ubtract(a.shape,
-00006570: 2072 6561 6c5f 6c69 6d69 7473 292c 206e   real_limits), n
-00006580: 702e 7375 6274 7261 6374 2873 7472 6964  p.subtract(strid
-00006590: 6573 2c20 3129 2929 0a0a 2020 2020 2320  es, 1)))..    # 
-000065a0: 436f 6e76 6572 7473 204e 756d 5079 206e  Converts NumPy n
-000065b0: 756d 6265 7273 2074 6f20 5079 7468 6f6e  umbers to Python
-000065c0: 2069 6e74 730a 2020 2020 2320 544f 444f   ints.    # TODO
-000065d0: 2053 686f 756c 6420 7765 2073 7570 706f   Should we suppo
-000065e0: 7274 204e 756d 5079 206e 756d 6265 7273  rt NumPy numbers
-000065f0: 2062 6574 7465 723f 0a20 2020 2070 6164   better?.    pad
-00006600: 6469 6e67 203d 2074 7265 655f 6d61 7028  ding = tree_map(
-00006610: 696e 742c 2070 6164 6469 6e67 290a 2020  int, padding).  
-00006620: 2020 615f 6772 6164 203d 2070 7269 6d73    a_grad = prims
-00006630: 2e70 6164 2867 2c20 636f 6e73 745f 6173  .pad(g, const_as
-00006640: 2830 2c20 672e 6474 7970 6529 2c20 7061  (0, g.dtype), pa
-00006650: 6464 696e 6729 0a20 2020 2070 7574 5f67  dding).    put_g
-00006660: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-00006670: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00006680: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00006690: 6964 732e 534c 4943 452c 205f 736c 6963  ids.SLICE, _slic
-000066a0: 655f 7072 696d 5f67 7261 6429 0a0a 0a40  e_prim_grad)...@
-000066b0: 746f 7263 6863 7478 0a64 6566 205f 7371  torchctx.def _sq
-000066c0: 7565 657a 655f 7072 696d 5f67 7261 6428  ueeze_prim_grad(
-000066d0: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-000066e0: 2f2c 2064 696d 733a 2074 7570 6c65 5b69  /, dims: tuple[i
-000066f0: 6e74 2c20 2e2e 2e5d 2920 2d3e 2054 656e  nt, ...]) -> Ten
-00006700: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
-00006710: 6420 3d20 7072 696d 732e 7371 7565 657a  d = prims.squeez
-00006720: 6528 612c 2074 7570 6c65 2864 696d 7329  e(a, tuple(dims)
-00006730: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00006740: 7261 6428 6677 6429 0a20 2020 2023 204e  rad(fwd).    # N
-00006750: 4f54 4520 5468 6973 2063 616c 6c73 2063  OTE This calls c
-00006760: 6c61 6e67 2e75 6e73 7175 6565 7a65 2c20  lang.unsqueeze, 
-00006770: 616e 6420 6e6f 7420 746f 7263 682e 756e  and not torch.un
-00006780: 7371 7565 657a 652c 2062 6563 6175 7365  squeeze, because
-00006790: 2074 6f72 6368 2e75 6e73 7175 6565 7a65   torch.unsqueeze
-000067a0: 206f 6e6c 7920 7375 7070 6f72 7473 0a20   only supports. 
-000067b0: 2020 2023 2020 2075 6e73 7175 6565 7a69     #   unsqueezi
-000067c0: 6e67 2061 2073 696e 676c 6520 6469 6d65  ng a single dime
-000067d0: 6e73 696f 6e0a 2020 2020 615f 6772 6164  nsion.    a_grad
-000067e0: 203d 2063 6c61 6e67 2e75 6e73 7175 6565   = clang.unsquee
-000067f0: 7a65 2867 2c20 6469 6d73 290a 2020 2020  ze(g, dims).    
-00006800: 7075 745f 6772 6164 2861 2c20 615f 6772  put_grad(a, a_gr
-00006810: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
-00006820: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00006830: 7261 6428 7069 6473 2e53 5155 4545 5a45  rad(pids.SQUEEZE
-00006840: 2c20 5f73 7175 6565 7a65 5f70 7269 6d5f  , _squeeze_prim_
-00006850: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
-00006860: 780a 6465 6620 5f74 616b 655f 7072 696d  x.def _take_prim
-00006870: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
-00006880: 726f 7879 2c20 696e 6465 783a 2054 656e  roxy, index: Ten
-00006890: 736f 7250 726f 7879 2c20 6469 6d3a 2069  sorProxy, dim: i
-000068a0: 6e74 2920 2d3e 2054 656e 736f 7250 726f  nt) -> TensorPro
-000068b0: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-000068c0: 696d 732e 7461 6b65 2861 2c20 696e 6465  ims.take(a, inde
-000068d0: 782c 2064 696d 290a 0a20 2020 2067 203d  x, dim)..    g =
-000068e0: 2067 6574 5f67 7261 6428 6677 6429 0a0a   get_grad(fwd)..
-000068f0: 2020 2020 2320 544f 444f 2053 7769 7463      # TODO Switc
-00006900: 6820 746f 206c 746f 7263 682e 696e 6465  h to ltorch.inde
-00006910: 785f 6164 643f 0a20 2020 2023 204e 4f54  x_add?.    # NOT
-00006920: 4520 496e 7465 6e74 696f 6e61 6c6c 7920  E Intentionally 
-00006930: 6e6f 7420 6361 6c6c 696e 6720 7a65 726f  not calling zero
-00006940: 735f 6c69 6b65 2074 6f20 6176 6f69 6420  s_like to avoid 
-00006950: 7072 6573 6572 7669 6e67 2061 0a20 2020  preserving a.   
-00006960: 2023 2054 4f44 4f20 5570 6461 7465 2074   # TODO Update t
-00006970: 6f20 6361 6c6c 206c 746f 7263 682e 7a65  o call ltorch.ze
-00006980: 726f 730a 2020 2020 7a65 726f 7320 3d20  ros.    zeros = 
-00006990: 7072 696d 732e 6675 6c6c 2861 2e73 6861  prims.full(a.sha
-000069a0: 7065 2c20 6669 6c6c 5f76 616c 7565 3d30  pe, fill_value=0
-000069b0: 2c20 6465 7669 6365 3d61 2e64 6576 6963  , device=a.devic
-000069c0: 652c 2064 7479 7065 3d61 2e64 7479 7065  e, dtype=a.dtype
-000069d0: 290a 2020 2020 615f 6772 6164 203d 2070  ).    a_grad = p
-000069e0: 7269 6d73 2e69 6e64 6578 5f61 6464 287a  rims.index_add(z
-000069f0: 6572 6f73 2c20 696e 6465 782c 2067 2c20  eros, index, g, 
-00006a00: 6469 6d29 0a20 2020 2070 7574 5f67 7261  dim).    put_gra
-00006a10: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
-00006a20: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00006a30: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00006a40: 732e 5441 4b45 2c20 5f74 616b 655f 7072  s.TAKE, _take_pr
-00006a50: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
-00006a60: 6863 7478 0a64 6566 205f 6761 7468 6572  hctx.def _gather
-00006a70: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
-00006a80: 6e73 6f72 5072 6f78 792c 2069 6e64 6578  nsorProxy, index
-00006a90: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
-00006aa0: 696d 3a20 696e 7429 202d 3e20 5465 6e73  im: int) -> Tens
-00006ab0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00006ac0: 203d 2070 7269 6d73 2e67 6174 6865 7228   = prims.gather(
-00006ad0: 612c 2069 6e64 6578 2c20 6469 6d29 0a0a  a, index, dim)..
-00006ae0: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00006af0: 2866 7764 290a 2020 2020 2320 4e4f 5445  (fwd).    # NOTE
-00006b00: 2049 6e74 656e 7469 6f6e 616c 6c79 206e   Intentionally n
-00006b10: 6f74 2063 616c 6c69 6e67 207a 6572 6f73  ot calling zeros
-00006b20: 5f6c 696b 6520 746f 2061 766f 6964 2070  _like to avoid p
-00006b30: 7265 7365 7276 696e 6720 5465 6e73 6f72  reserving Tensor
-00006b40: 5072 6f78 7920 612e 0a20 2020 2023 2054  Proxy a..    # T
-00006b50: 4f44 4f20 5570 6461 7465 2074 6f20 6361  ODO Update to ca
-00006b60: 6c6c 206c 746f 7263 682e 7a65 726f 730a  ll ltorch.zeros.
-00006b70: 2020 2020 7a65 726f 7320 3d20 7072 696d      zeros = prim
-00006b80: 732e 6675 6c6c 2861 2e73 6861 7065 2c20  s.full(a.shape, 
-00006b90: 6669 6c6c 5f76 616c 7565 3d30 2c20 6465  fill_value=0, de
-00006ba0: 7669 6365 3d61 2e64 6576 6963 652c 2064  vice=a.device, d
-00006bb0: 7479 7065 3d61 2e64 7479 7065 290a 2020  type=a.dtype).  
-00006bc0: 2020 615f 6772 6164 203d 2070 7269 6d73    a_grad = prims
-00006bd0: 2e73 6361 7474 6572 5f61 6464 287a 6572  .scatter_add(zer
-00006be0: 6f73 2c20 696e 6465 782c 2067 2c20 6469  os, index, g, di
-00006bf0: 6d29 0a20 2020 2070 7574 5f67 7261 6428  m).    put_grad(
-00006c00: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00006c10: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00006c20: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00006c30: 4741 5448 4552 2c20 5f67 6174 6865 725f  GATHER, _gather_
-00006c40: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-00006c50: 7263 6863 7478 0a64 6566 205f 7461 6b65  rchctx.def _take
-00006c60: 5f61 6c6f 6e67 5f61 7869 735f 7072 696d  _along_axis_prim
-00006c70: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
-00006c80: 726f 7879 2c20 696e 6465 783a 2054 656e  roxy, index: Ten
-00006c90: 736f 7250 726f 7879 2c20 6469 6d3a 2069  sorProxy, dim: i
-00006ca0: 6e74 2920 2d3e 2054 656e 736f 7250 726f  nt) -> TensorPro
-00006cb0: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-00006cc0: 696d 732e 7461 6b65 5f61 6c6f 6e67 5f61  ims.take_along_a
-00006cd0: 7869 7328 612c 2069 6e64 6578 2c20 6469  xis(a, index, di
-00006ce0: 6d29 0a0a 2020 2020 6720 3d20 6765 745f  m)..    g = get_
-00006cf0: 6772 6164 2866 7764 290a 2020 2020 2320  grad(fwd).    # 
-00006d00: 4e4f 5445 2049 6e74 656e 7469 6f6e 616c  NOTE Intentional
-00006d10: 6c79 206e 6f74 2063 616c 6c69 6e67 207a  ly not calling z
-00006d20: 6572 6f73 5f6c 696b 6520 746f 2061 766f  eros_like to avo
-00006d30: 6964 2070 7265 7365 7276 696e 6720 5465  id preserving Te
-00006d40: 6e73 6f72 5072 6f78 7920 612e 0a20 2020  nsorProxy a..   
-00006d50: 2023 2054 4f44 4f20 5570 6461 7465 2074   # TODO Update t
-00006d60: 6f20 6361 6c6c 206c 746f 7263 682e 7a65  o call ltorch.ze
-00006d70: 726f 730a 2020 2020 7a65 726f 7320 3d20  ros.    zeros = 
-00006d80: 7072 696d 732e 6675 6c6c 2861 2e73 6861  prims.full(a.sha
-00006d90: 7065 2c20 6669 6c6c 5f76 616c 7565 3d30  pe, fill_value=0
-00006da0: 2c20 6465 7669 6365 3d61 2e64 6576 6963  , device=a.devic
-00006db0: 652c 2064 7479 7065 3d61 2e64 7479 7065  e, dtype=a.dtype
-00006dc0: 290a 2020 2020 615f 6772 6164 203d 2070  ).    a_grad = p
-00006dd0: 7269 6d73 2e73 6361 7474 6572 5f61 6464  rims.scatter_add
-00006de0: 287a 6572 6f73 2c20 696e 6465 782c 2067  (zeros, index, g
-00006df0: 2c20 6469 6d29 0a20 2020 2070 7574 5f67  , dim).    put_g
-00006e00: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-00006e10: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00006e20: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00006e30: 6964 732e 5441 4b45 5f41 4c4f 4e47 5f41  ids.TAKE_ALONG_A
-00006e40: 5849 532c 205f 7461 6b65 5f61 6c6f 6e67  XIS, _take_along
-00006e50: 5f61 7869 735f 7072 696d 5f67 7261 6429  _axis_prim_grad)
-00006e60: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00006e70: 205f 7472 616e 7370 6f73 655f 7072 696d   _transpose_prim
-00006e80: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
-00006e90: 726f 7879 2c20 7065 726d 7574 6174 696f  roxy, permutatio
-00006ea0: 6e3a 2074 7570 6c65 5b69 6e74 2c20 2e2e  n: tuple[int, ..
-00006eb0: 2e5d 2920 2d3e 2054 656e 736f 7250 726f  .]) -> TensorPro
-00006ec0: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-00006ed0: 696d 732e 7472 616e 7370 6f73 6528 612c  ims.transpose(a,
-00006ee0: 2074 7570 6c65 2870 6572 6d75 7461 7469   tuple(permutati
-00006ef0: 6f6e 2929 0a0a 2020 2020 6720 3d20 6765  on))..    g = ge
-00006f00: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00006f10: 756e 646f 203d 205f 6172 6773 6f72 7428  undo = _argsort(
-00006f20: 7065 726d 7574 6174 696f 6e29 0a20 2020  permutation).   
-00006f30: 2061 5f67 7261 6420 3d20 7072 696d 732e   a_grad = prims.
-00006f40: 7472 616e 7370 6f73 6528 672c 2074 7570  transpose(g, tup
-00006f50: 6c65 2875 6e64 6f29 290a 2020 2020 7075  le(undo)).    pu
-00006f60: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
-00006f70: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00006f80: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00006f90: 6428 7069 6473 2e54 5241 4e53 504f 5345  d(pids.TRANSPOSE
-00006fa0: 2c20 5f74 7261 6e73 706f 7365 5f70 7269  , _transpose_pri
-00006fb0: 6d5f 6772 6164 290a 0a23 0a23 204d 656d  m_grad)..#.# Mem
-00006fc0: 6f72 7920 6c61 796f 7574 206f 7065 7261  ory layout opera
-00006fd0: 746f 7220 6772 6164 730a 230a 0a0a 4074  tor grads.#...@t
-00006fe0: 6f72 6368 6374 780a 6465 6620 5f73 7472  orchctx.def _str
-00006ff0: 6964 655f 6f72 6465 725f 7072 696d 5f67  ide_order_prim_g
-00007000: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
-00007010: 7879 2c20 2f2c 206f 7264 6572 3a20 5365  xy, /, order: Se
-00007020: 7175 656e 6365 5b69 6e74 5d29 202d 3e20  quence[int]) -> 
-00007030: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007040: 2066 7764 203d 2070 7269 6d73 2e73 7472   fwd = prims.str
-00007050: 6964 655f 6f72 6465 7228 612c 206f 7264  ide_order(a, ord
-00007060: 6572 290a 0a20 2020 2067 203d 2067 6574  er)..    g = get
-00007070: 5f67 7261 6428 6677 6429 0a20 2020 2070  _grad(fwd).    p
-00007080: 7574 5f67 7261 6428 612c 2067 290a 0a20  ut_grad(a, g).. 
-00007090: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-000070a0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-000070b0: 6473 2e53 5452 4944 455f 4f52 4445 522c  ds.STRIDE_ORDER,
-000070c0: 205f 7374 7269 6465 5f6f 7264 6572 5f70   _stride_order_p
-000070d0: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
-000070e0: 456c 656d 656e 7477 6973 6520 756e 6172  Elementwise unar
-000070f0: 7920 6f70 6572 6174 6f72 2067 7261 6473  y operator grads
-00007100: 0a23 0a40 746f 7263 6863 7478 0a64 6566  .#.@torchctx.def
-00007110: 205f 6162 735f 7072 696d 5f67 7261 6428   _abs_prim_grad(
-00007120: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-00007130: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-00007140: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007150: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00007160: 732e 6162 7328 6129 0a0a 2020 2020 6720  s.abs(a)..    g 
-00007170: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00007180: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00007190: 6720 2a20 6c74 6f72 6368 2e73 6967 6e28  g * ltorch.sign(
-000071a0: 6129 290a 0a20 2020 2072 6574 7572 6e20  a))..    return 
-000071b0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-000071c0: 7261 6428 7069 6473 2e41 4253 2c20 5f61  rad(pids.ABS, _a
-000071d0: 6273 5f70 7269 6d5f 6772 6164 290a 0a0a  bs_prim_grad)...
-000071e0: 6465 6620 5f63 6f73 5f70 7269 6d5f 6772  def _cos_prim_gr
-000071f0: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
-00007200: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
-00007210: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007220: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00007230: 7269 6d73 2e63 6f73 2861 290a 0a20 2020  rims.cos(a)..   
-00007240: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00007250: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
-00007260: 612c 2067 202a 2028 2d70 7269 6d73 2e73  a, g * (-prims.s
-00007270: 696e 2861 2929 290a 0a20 2020 2072 6574  in(a)))..    ret
-00007280: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00007290: 6572 5f67 7261 6428 7069 6473 2e43 4f53  er_grad(pids.COS
-000072a0: 2c20 5f63 6f73 5f70 7269 6d5f 6772 6164  , _cos_prim_grad
-000072b0: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-000072c0: 6620 5f65 7266 5f70 7269 6d5f 6772 6164  f _erf_prim_grad
-000072d0: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
-000072e0: 736f 7250 726f 7879 2920 2d3e 204e 756d  sorProxy) -> Num
-000072f0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00007300: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00007310: 6d73 2e65 7266 2861 290a 0a20 2020 2067  ms.erf(a)..    g
-00007320: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00007330: 0a20 2020 2061 5f67 7261 6420 3d20 3220  .    a_grad = 2 
-00007340: 2f20 6d61 7468 2e73 7172 7428 6d61 7468  / math.sqrt(math
-00007350: 2e70 6929 202a 206c 746f 7263 682e 6578  .pi) * ltorch.ex
-00007360: 7028 2d28 612a 2a32 2929 202a 2067 0a20  p(-(a**2)) * g. 
-00007370: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
-00007380: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
-00007390: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-000073a0: 725f 6772 6164 2870 6964 732e 4552 462c  r_grad(pids.ERF,
-000073b0: 205f 6572 665f 7072 696d 5f67 7261 6429   _erf_prim_grad)
-000073c0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-000073d0: 205f 6578 705f 7072 696d 5f67 7261 6428   _exp_prim_grad(
-000073e0: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-000073f0: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-00007400: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007410: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00007420: 732e 6578 7028 6129 0a0a 2020 2020 6720  s.exp(a)..    g 
-00007430: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00007440: 2020 2020 615f 6772 6164 203d 2067 202a      a_grad = g *
-00007450: 2066 7764 0a20 2020 2070 7574 5f67 7261   fwd.    put_gra
-00007460: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
-00007470: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00007480: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00007490: 732e 4558 502c 205f 6578 705f 7072 696d  s.EXP, _exp_prim
-000074a0: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
-000074b0: 7478 0a64 6566 205f 6c6f 675f 7072 696d  tx.def _log_prim
-000074c0: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
-000074d0: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
-000074e0: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
-000074f0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00007500: 3d20 7072 696d 732e 6c6f 6728 6129 0a0a  = prims.log(a)..
-00007510: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
-00007520: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
-00007530: 203d 2067 202f 2061 0a20 2020 2070 7574   = g / a.    put
-00007540: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
-00007550: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00007560: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00007570: 2870 6964 732e 4c4f 472c 205f 6c6f 675f  (pids.LOG, _log_
-00007580: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-00007590: 7263 6863 7478 0a64 6566 205f 6e65 675f  rchctx.def _neg_
-000075a0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-000075b0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-000075c0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-000075d0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-000075e0: 6677 6420 3d20 7072 696d 732e 6e65 6728  fwd = prims.neg(
-000075f0: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
-00007600: 6772 6164 2866 7764 290a 2020 2020 7075  grad(fwd).    pu
-00007610: 745f 6772 6164 2861 2c20 2d67 290a 0a20  t_grad(a, -g).. 
-00007620: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00007630: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00007640: 6473 2e4e 4547 2c20 5f6e 6567 5f70 7269  ds.NEG, _neg_pri
-00007650: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
-00007660: 6374 780a 6465 6620 5f72 7371 7274 5f70  ctx.def _rsqrt_p
-00007670: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-00007680: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007690: 2c20 2f29 202d 3e20 4e75 6d62 6572 207c  , /) -> Number |
-000076a0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-000076b0: 2020 6677 6420 3d20 7072 696d 732e 7273    fwd = prims.rs
-000076c0: 7172 7428 6129 0a0a 2020 2020 6720 3d20  qrt(a)..    g = 
-000076d0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
-000076e0: 2020 2320 416e 2061 6c74 6572 6e61 7469    # An alternati
-000076f0: 7665 2064 6572 6976 6174 696f 6e20 7573  ve derivation us
-00007700: 6564 2062 7920 4a41 5820 6973 202d 302e  ed by JAX is -0.
-00007710: 3520 2a20 6720 2a20 7273 7172 7428 7829  5 * g * rsqrt(x)
-00007720: 202f 2078 0a20 2020 2023 2077 6865 7265   / x.    # where
-00007730: 2072 7371 7274 2878 2920 616e 6420 7820   rsqrt(x) and x 
-00007740: 6172 6520 7361 7665 6420 666f 7220 7468  are saved for th
-00007750: 6520 6261 636b 7761 7264 7320 7061 7373  e backwards pass
-00007760: 2e0a 2020 2020 2320 5468 6973 2064 6572  ..    # This der
-00007770: 6976 6174 696f 6e20 7761 7320 7365 6c65  ivation was sele
-00007780: 6374 6564 2062 6563 6175 7365 2069 7420  cted because it 
-00007790: 6176 6f69 6473 2073 6176 696e 6720 7468  avoids saving th
-000077a0: 6520 696e 7075 7420 7465 6e73 6f72 2e0a  e input tensor..
-000077b0: 2020 2020 615f 6772 6164 203d 202d 302e      a_grad = -0.
-000077c0: 3520 2a20 6720 2a20 6677 642a 2a33 2e30  5 * g * fwd**3.0
-000077d0: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-000077e0: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
-000077f0: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00007800: 7465 725f 6772 6164 2870 6964 732e 5253  ter_grad(pids.RS
-00007810: 5152 542c 205f 7273 7172 745f 7072 696d  QRT, _rsqrt_prim
-00007820: 5f67 7261 6429 0a0a 0a64 6566 205f 7369  _grad)...def _si
-00007830: 6e5f 7072 696d 5f67 7261 6428 613a 204e  n_prim_grad(a: N
-00007840: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007850: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
-00007860: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00007870: 2020 6677 6420 3d20 7072 696d 732e 7369    fwd = prims.si
-00007880: 6e28 6129 0a0a 2020 2020 6720 3d20 6765  n(a)..    g = ge
-00007890: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-000078a0: 7075 745f 6772 6164 2861 2c20 6720 2a20  put_grad(a, g * 
-000078b0: 7072 696d 732e 636f 7328 6129 290a 0a20  prims.cos(a)).. 
-000078c0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-000078d0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-000078e0: 6473 2e53 494e 2c20 5f73 696e 5f70 7269  ds.SIN, _sin_pri
-000078f0: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
-00007900: 6374 780a 6465 6620 5f74 616e 685f 7072  ctx.def _tanh_pr
-00007910: 696d 5f67 7261 6428 613a 204e 756d 6265  im_grad(a: Numbe
-00007920: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
-00007930: 202f 2920 2d3e 204e 756d 6265 7220 7c20   /) -> Number | 
-00007940: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00007950: 2066 7764 203d 2070 7269 6d73 2e74 616e   fwd = prims.tan
-00007960: 6828 6129 0a0a 2020 2020 6720 3d20 6765  h(a)..    g = ge
-00007970: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00007980: 615f 6772 6164 203d 2067 202a 2028 3120  a_grad = g * (1 
-00007990: 2d20 6677 6420 2a20 6677 6429 0a20 2020  - fwd * fwd).   
-000079a0: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-000079b0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-000079c0: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-000079d0: 6772 6164 2870 6964 732e 5441 4e48 2c20  grad(pids.TANH, 
-000079e0: 5f74 616e 685f 7072 696d 5f67 7261 6429  _tanh_prim_grad)
-000079f0: 0a0a 230a 2320 456c 656d 656e 7477 6973  ..#.# Elementwis
-00007a00: 6520 6269 6e61 7279 206f 7065 7261 746f  e binary operato
-00007a10: 7220 6772 6164 730a 230a 0a0a 4074 6f72  r grads.#...@tor
-00007a20: 6368 6374 780a 6465 6620 5f61 6464 5f70  chctx.def _add_p
-00007a30: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-00007a40: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007a50: 2c20 623a 204e 756d 6265 7220 7c20 5465  , b: Number | Te
-00007a60: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00007a70: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007a80: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00007a90: 2061 202b 2062 0a0a 2020 2020 6720 3d20   a + b..    g = 
-00007aa0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
-00007ab0: 2020 615f 6772 6164 203d 2067 0a20 2020    a_grad = g.   
-00007ac0: 2062 5f67 7261 6420 3d20 670a 2020 2020   b_grad = g.    
-00007ad0: 7075 745f 6772 6164 7328 2861 2c20 6229  put_grads((a, b)
-00007ae0: 2c20 2861 5f67 7261 642c 2062 5f67 7261  , (a_grad, b_gra
-00007af0: 6429 290a 0a20 2020 2072 6574 7572 6e20  d))..    return 
-00007b00: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00007b10: 7261 6428 7069 6473 2e41 4444 2c20 5f61  rad(pids.ADD, _a
-00007b20: 6464 5f70 7269 6d5f 6772 6164 290a 0a0a  dd_prim_grad)...
-00007b30: 2320 4e4f 5445 2054 6865 2066 6f6c 6c6f  # NOTE The follo
-00007b40: 7769 6e67 2067 7261 6420 6465 6669 6e69  wing grad defini
-00007b50: 7469 6f6e 2072 656c 6965 7320 6f6e 2074  tion relies on t
-00007b60: 6865 2066 6163 7420 7468 6174 206f 6e6c  he fact that onl
-00007b70: 7920 696e 6578 6163 7420 6474 7970 6573  y inexact dtypes
-00007b80: 2061 7265 2064 6966 6665 7265 6e74 6961   are differentia
-00007b90: 626c 652c 0a23 2020 2061 6e64 2074 6f72  ble,.#   and tor
-00007ba0: 6368 2773 2074 7275 6520 6469 7669 7369  ch's true divisi
-00007bb0: 6f6e 206f 7065 7261 746f 7220 616e 6420  on operator and 
-00007bc0: 7468 6520 6469 7669 7369 6f6e 2070 7269  the division pri
-00007bd0: 6d69 7469 7665 2061 6772 6565 206f 6e20  mitive agree on 
-00007be0: 7468 6f73 6520 7479 7065 730a 4074 6f72  those types.@tor
-00007bf0: 6368 6374 780a 6465 6620 5f64 6976 5f70  chctx.def _div_p
-00007c00: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-00007c10: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007c20: 2c20 623a 204e 756d 6265 7220 7c20 5465  , b: Number | Te
-00007c30: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00007c40: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007c50: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00007c60: 2061 202f 2062 0a0a 2020 2020 6720 3d20   a / b..    g = 
-00007c70: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
-00007c80: 2020 615f 6772 6164 203d 2067 202f 2062    a_grad = g / b
-00007c90: 0a20 2020 2062 5f67 7261 6420 3d20 2d67  .    b_grad = -g
-00007ca0: 202a 2028 2861 202f 2062 2920 2f20 6229   * ((a / b) / b)
-00007cb0: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
-00007cc0: 612c 2062 292c 2028 615f 6772 6164 2c20  a, b), (a_grad, 
-00007cd0: 625f 6772 6164 2929 0a0a 2020 2020 7265  b_grad))..    re
-00007ce0: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00007cf0: 7465 725f 6772 6164 2870 6964 732e 4449  ter_grad(pids.DI
-00007d00: 562c 205f 6469 765f 7072 696d 5f67 7261  V, _div_prim_gra
-00007d10: 6429 0a0a 2320 436f 6d70 6172 6973 6f6e  d)..# Comparison
-00007d20: 206f 7065 7261 746f 7273 202d 2d20 7468   operators -- th
-00007d30: 6573 6520 6372 6561 7465 206e 6f20 6772  ese create no gr
-00007d40: 6164 2061 7373 6f63 6961 7469 6f6e 730a  ad associations.
-00007d50: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00007d60: 6473 2e45 512c 2070 7269 6d73 2e65 7129  ds.EQ, prims.eq)
-00007d70: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00007d80: 6964 732e 4745 2c20 7072 696d 732e 6765  ids.GE, prims.ge
-00007d90: 290a 7265 6769 7374 6572 5f67 7261 6428  ).register_grad(
-00007da0: 7069 6473 2e4c 542c 2070 7269 6d73 2e6c  pids.LT, prims.l
-00007db0: 7429 0a72 6567 6973 7465 725f 6772 6164  t).register_grad
-00007dc0: 2870 6964 732e 4e45 2c20 7072 696d 732e  (pids.NE, prims.
-00007dd0: 6e65 290a 7265 6769 7374 6572 5f67 7261  ne).register_gra
-00007de0: 6428 7069 6473 2e47 542c 2070 7269 6d73  d(pids.GT, prims
-00007df0: 2e67 7429 0a72 6567 6973 7465 725f 6772  .gt).register_gr
-00007e00: 6164 2870 6964 732e 4c45 2c20 7072 696d  ad(pids.LE, prim
-00007e10: 732e 6c65 290a 0a0a 4074 6f72 6368 6374  s.le)...@torchct
-00007e20: 780a 6465 6620 5f6d 756c 5f70 7269 6d5f  x.def _mul_prim_
-00007e30: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
-00007e40: 2054 656e 736f 7250 726f 7879 2c20 623a   TensorProxy, b:
-00007e50: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007e60: 5072 6f78 792c 202f 2920 2d3e 204e 756d  Proxy, /) -> Num
-00007e70: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00007e80: 793a 0a20 2020 2066 7764 203d 2061 202a  y:.    fwd = a *
-00007e90: 2062 0a0a 2020 2020 6720 3d20 6765 745f   b..    g = get_
-00007ea0: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00007eb0: 6772 6164 203d 2062 202a 2067 0a20 2020  grad = b * g.   
-00007ec0: 2062 5f67 7261 6420 3d20 6120 2a20 670a   b_grad = a * g.
-00007ed0: 2020 2020 7075 745f 6772 6164 7328 2861      put_grads((a
-00007ee0: 2c20 6229 2c20 2861 5f67 7261 642c 2062  , b), (a_grad, b
-00007ef0: 5f67 7261 6429 290a 0a20 2020 2072 6574  _grad))..    ret
-00007f00: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00007f10: 6572 5f67 7261 6428 7069 6473 2e4d 554c  er_grad(pids.MUL
-00007f20: 2c20 5f6d 756c 5f70 7269 6d5f 6772 6164  , _mul_prim_grad
-00007f30: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-00007f40: 6620 5f73 7562 5f70 7269 6d5f 6772 6164  f _sub_prim_grad
-00007f50: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
-00007f60: 736f 7250 726f 7879 2c20 623a 204e 756d  sorProxy, b: Num
-00007f70: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00007f80: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-00007f90: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00007fa0: 6677 6420 3d20 6120 2d20 620a 0a20 2020  fwd = a - b..   
-00007fb0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00007fc0: 6429 0a20 2020 2061 5f67 7261 6420 3d20  d).    a_grad = 
-00007fd0: 670a 2020 2020 625f 6772 6164 203d 202d  g.    b_grad = -
-00007fe0: 670a 2020 2020 7075 745f 6772 6164 7328  g.    put_grads(
-00007ff0: 2861 2c20 6229 2c20 2861 5f67 7261 642c  (a, b), (a_grad,
-00008000: 2062 5f67 7261 6429 290a 0a20 2020 2072   b_grad))..    r
-00008010: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00008020: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
-00008030: 5542 2c20 5f73 7562 5f70 7269 6d5f 6772  UB, _sub_prim_gr
-00008040: 6164 290a 0a0a 230a 2320 436f 6e64 6974  ad)...#.# Condit
-00008050: 696f 6e61 6c20 6f70 6572 6174 6f72 2067  ional operator g
-00008060: 7261 6473 0a23 0a0a 0a64 6566 205f 7768  rads.#...def _wh
-00008070: 6572 655f 7072 696d 5f67 7261 6428 7072  ere_prim_grad(pr
-00008080: 6564 3a20 4e75 6d62 6572 207c 2054 656e  ed: Number | Ten
-00008090: 736f 7250 726f 7879 2c20 613a 204e 756d  sorProxy, a: Num
-000080a0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-000080b0: 792c 2062 3a20 4e75 6d62 6572 207c 2054  y, b: Number | T
-000080c0: 656e 736f 7250 726f 7879 2920 2d3e 2054  ensorProxy) -> T
-000080d0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-000080e0: 6677 6420 3d20 7072 696d 732e 7768 6572  fwd = prims.wher
-000080f0: 6528 7072 6564 2c20 612c 2062 290a 0a20  e(pred, a, b).. 
-00008100: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00008110: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
-00008120: 3d20 6c74 6f72 6368 2e77 6865 7265 2870  = ltorch.where(p
-00008130: 7265 642c 2067 2c20 3029 0a20 2020 2062  red, g, 0).    b
-00008140: 5f67 7261 6420 3d20 6c74 6f72 6368 2e77  _grad = ltorch.w
-00008150: 6865 7265 2870 7265 642c 2030 2c20 6729  here(pred, 0, g)
-00008160: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
-00008170: 612c 2062 292c 2028 615f 6772 6164 2c20  a, b), (a_grad, 
-00008180: 625f 6772 6164 2929 0a0a 2020 2020 7265  b_grad))..    re
-00008190: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-000081a0: 7465 725f 6772 6164 2870 6964 732e 5748  ter_grad(pids.WH
-000081b0: 4552 452c 205f 7768 6572 655f 7072 696d  ERE, _where_prim
-000081c0: 5f67 7261 6429 0a0a 230a 2320 5265 6475  _grad)..#.# Redu
-000081d0: 6374 696f 6e20 6f70 6572 6174 6f72 2067  ction operator g
-000081e0: 7261 6473 0a23 0a0a 0a23 2054 4f44 4f20  rads.#...# TODO 
-000081f0: 5265 7669 6577 2074 7765 616b 696e 6720  Review tweaking 
-00008200: 6772 6164 5f63 686f 6f73 6572 5f70 756c  grad_chooser_pul
-00008210: 6c62 6163 6b20 696e 7465 7266 6163 650a  lback interface.
-00008220: 6465 6620 5f61 6d61 785f 7072 696d 5f67  def _amax_prim_g
-00008230: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
-00008240: 7879 2c20 2f2c 2064 696d 733a 2053 6571  xy, /, dims: Seq
-00008250: 7565 6e63 655b 696e 745d 2920 2d3e 2054  uence[int]) -> T
-00008260: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00008270: 6677 6420 3d20 7072 696d 732e 616d 6178  fwd = prims.amax
-00008280: 2861 2c20 6469 6d73 290a 0a20 2020 2067  (a, dims)..    g
-00008290: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-000082a0: 0a20 2020 2061 5f67 7261 6420 3d20 6772  .    a_grad = gr
-000082b0: 6164 5f63 686f 6f73 6572 5f62 6163 6b77  ad_chooser_backw
-000082c0: 6172 6428 6677 642c 2061 2c20 612e 7368  ard(fwd, a, a.sh
-000082d0: 6170 652c 2064 696d 732c 2067 290a 2020  ape, dims, g).  
-000082e0: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
-000082f0: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
-00008300: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-00008310: 5f67 7261 6428 7069 6473 2e41 4d41 582c  _grad(pids.AMAX,
-00008320: 205f 616d 6178 5f70 7269 6d5f 6772 6164   _amax_prim_grad
-00008330: 290a 0a0a 6465 6620 5f73 756d 5f70 7269  )...def _sum_pri
-00008340: 6d5f 6772 6164 2861 3a20 5465 6e73 6f72  m_grad(a: Tensor
-00008350: 5072 6f78 792c 202f 2c20 6469 6d73 3a20  Proxy, /, dims: 
-00008360: 5365 7175 656e 6365 5b69 6e74 5d29 202d  Sequence[int]) -
-00008370: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00008380: 2020 2066 7764 203d 2070 7269 6d73 2e73     fwd = prims.s
-00008390: 756d 2861 2c20 6469 6d73 290a 0a20 2020  um(a, dims)..   
-000083a0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-000083b0: 6429 0a20 2020 2061 5f67 7261 6420 3d20  d).    a_grad = 
-000083c0: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
-000083d0: 6469 6d73 2867 2c20 6469 6d73 2c20 612e  dims(g, dims, a.
-000083e0: 7368 6170 6529 0a20 2020 2070 7574 5f67  shape).    put_g
-000083f0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-00008400: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00008410: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00008420: 6964 732e 5355 4d2c 205f 7375 6d5f 7072  ids.SUM, _sum_pr
-00008430: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
-00008440: 6863 7478 0a64 6566 205f 746f 706b 5f70  hctx.def _topk_p
-00008450: 7269 6d5f 6772 6164 280a 2020 2020 613a  rim_grad(.    a:
-00008460: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
-00008470: 206b 3a20 696e 742c 2064 696d 3a20 4e6f   k: int, dim: No
-00008480: 6e65 207c 2069 6e74 203d 204e 6f6e 652c  ne | int = None,
-00008490: 206c 6172 6765 7374 3a20 626f 6f6c 203d   largest: bool =
-000084a0: 2054 7275 652c 2073 6f72 7465 643a 2062   True, sorted: b
-000084b0: 6f6f 6c20 3d20 5472 7565 2c20 2a2c 206f  ool = True, *, o
-000084c0: 7574 3d4e 6f6e 650a 293a 0a20 2020 2066  ut=None.):.    f
-000084d0: 7764 203d 2070 7269 6d73 2e74 6f70 6b28  wd = prims.topk(
-000084e0: 612c 206b 2c20 6469 6d2c 206c 6172 6765  a, k, dim, large
-000084f0: 7374 2c20 736f 7274 6564 2c20 6f75 743d  st, sorted, out=
-00008500: 6f75 7429 0a20 2020 2076 616c 2c20 6964  out).    val, id
-00008510: 7820 3d20 6677 640a 0a20 2020 2076 616c  x = fwd..    val
-00008520: 5f67 7261 6420 3d20 6765 745f 6772 6164  _grad = get_grad
-00008530: 2876 616c 290a 0a20 2020 2061 5f67 7261  (val)..    a_gra
-00008540: 6420 3d20 6c74 6f72 6368 2e7a 6572 6f73  d = ltorch.zeros
-00008550: 5f6c 696b 6528 6129 0a20 2020 2023 2054  _like(a).    # T
-00008560: 4f44 4f3a 2072 6570 6c61 6365 2077 6974  ODO: replace wit
-00008570: 6820 7363 6174 7465 7220 6f6e 6365 2077  h scatter once w
-00008580: 6520 6861 7665 2069 742e 0a20 2020 2023  e have it..    #
-00008590: 2073 6361 7474 6572 5f61 6464 2069 7320   scatter_add is 
-000085a0: 6120 7072 696d 2061 6e64 2069 7420 7265  a prim and it re
-000085b0: 6c69 6573 206f 6e20 6174 6f6d 6963 206f  lies on atomic o
-000085c0: 7073 2e0a 2020 2020 615f 6772 6164 203d  ps..    a_grad =
-000085d0: 206c 746f 7263 682e 7363 6174 7465 725f   ltorch.scatter_
-000085e0: 6164 6428 615f 6772 6164 2c20 6469 6d2c  add(a_grad, dim,
-000085f0: 2069 6478 2c20 7661 6c5f 6772 6164 290a   idx, val_grad).
-00008600: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00008610: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00008620: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00008630: 6572 5f67 7261 6428 7069 6473 2e54 4f50  er_grad(pids.TOP
-00008640: 4b2c 205f 746f 706b 5f70 7269 6d5f 6772  K, _topk_prim_gr
-00008650: 6164 290a 0a0a 2320 544f 444f 2046 6978  ad)...# TODO Fix
-00008660: 2064 6976 6973 696f 6e20 6279 207a 6572   division by zer
-00008670: 6f20 7768 656e 206e 5f65 6c65 6d5f 7265  o when n_elem_re
-00008680: 6475 6365 6420 3d3d 2030 206f 7220 7768  duced == 0 or wh
-00008690: 656e 206d 6561 6e2e 6e75 6d65 6c20 3d3d  en mean.numel ==
-000086a0: 2030 0a23 2020 2062 7920 7265 7475 726e   0.#   by return
-000086b0: 696e 6720 7a65 726f 735f 6c69 6b65 2861  ing zeros_like(a
-000086c0: 2920 6f72 2073 696d 696c 6172 2e0a 2320  ) or similar..# 
-000086d0: 544f 444f 2046 6978 2067 7261 6420 7768  TODO Fix grad wh
-000086e0: 656e 2063 6f72 7265 6374 696f 6e20 3e20  en correction > 
-000086f0: 6e5f 656c 656d 5f72 6564 7563 6564 2e0a  n_elem_reduced..
-00008700: 4074 6f72 6368 6374 780a 6465 6620 5f76  @torchctx.def _v
-00008710: 6172 5f6d 6561 6e5f 7072 696d 5f67 7261  ar_mean_prim_gra
-00008720: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
-00008730: 2c20 2f2c 2064 696d 733a 2053 6571 7565  , /, dims: Seque
-00008740: 6e63 655b 696e 745d 2c20 2a2c 2063 6f72  nce[int], *, cor
-00008750: 7265 6374 696f 6e3a 204e 756d 6265 7229  rection: Number)
-00008760: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
-00008770: 0a20 2020 2076 2c20 6d20 3d20 7072 696d  .    v, m = prim
-00008780: 732e 7661 725f 6d65 616e 2861 2c20 6469  s.var_mean(a, di
-00008790: 6d73 2c20 636f 7272 6563 7469 6f6e 3d63  ms, correction=c
-000087a0: 6f72 7265 6374 696f 6e29 0a0a 2020 2020  orrection)..    
-000087b0: 6776 203d 2067 6574 5f67 7261 6428 7629  gv = get_grad(v)
-000087c0: 0a20 2020 2067 6d20 3d20 6765 745f 6772  .    gm = get_gr
-000087d0: 6164 286d 290a 0a20 2020 206e 5f65 6c65  ad(m)..    n_ele
-000087e0: 6d5f 7265 6475 6365 6420 3d20 612e 6e75  m_reduced = a.nu
-000087f0: 6d65 6c20 2f2f 206d 2e6e 756d 656c 2069  mel // m.numel i
-00008800: 6620 612e 6e75 6d65 6c20 213d 2030 2065  f a.numel != 0 e
-00008810: 6c73 6520 310a 0a20 2020 2023 2043 6f6d  lse 1..    # Com
-00008820: 7075 7465 7320 6d65 616e 2062 7764 0a20  putes mean bwd. 
-00008830: 2020 206d 6561 6e5f 7363 616c 6520 3d20     mean_scale = 
-00008840: 312e 3020 2f20 6e5f 656c 656d 5f72 6564  1.0 / n_elem_red
-00008850: 7563 6564 0a20 2020 206d 6561 6e5f 6772  uced.    mean_gr
-00008860: 6164 203d 206d 6561 6e5f 7363 616c 6520  ad = mean_scale 
-00008870: 2a20 7265 7374 6f72 655f 7265 6475 6365  * restore_reduce
-00008880: 645f 6469 6d73 2867 6d2c 2064 696d 732c  d_dims(gm, dims,
-00008890: 2061 2e73 6861 7065 290a 0a20 2020 2023   a.shape)..    #
-000088a0: 2043 6f6d 7075 7465 7320 7661 7220 6277   Computes var bw
-000088b0: 640a 2020 2020 6e6f 726d 616c 697a 6174  d.    normalizat
-000088c0: 696f 6e5f 7363 616c 6172 203d 206e 5f65  ion_scalar = n_e
-000088d0: 6c65 6d5f 7265 6475 6365 6420 2d20 636f  lem_reduced - co
-000088e0: 7272 6563 7469 6f6e 0a20 2020 2072 6573  rrection.    res
-000088f0: 746f 7265 645f 6776 203d 2072 6573 746f  tored_gv = resto
-00008900: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
-00008910: 6776 2c20 6469 6d73 2c20 612e 7368 6170  gv, dims, a.shap
-00008920: 6529 0a20 2020 2023 2049 6e73 6572 7469  e).    # Inserti
-00008930: 6e67 2061 2063 6f6e 7665 7273 696f 6e20  ng a conversion 
-00008940: 746f 2074 6865 2073 616d 6520 6474 7970  to the same dtyp
-00008950: 6520 746f 2064 6973 6162 6c65 206e 7646  e to disable nvF
-00008960: 7573 6572 2065 7865 6375 746f 7273 2773  user executors's
-00008970: 0a20 2020 2023 2062 6f6f 6b65 6e64 206f  .    # bookend o
-00008980: 7074 696d 697a 6174 696f 6e20 286e 765f  ptimization (nv_
-00008990: 656e 6162 6c65 5f62 6f6f 6b65 6e64 292c  enable_bookend),
-000089a0: 2077 6869 6368 2063 616e 2063 6175 7365   which can cause
-000089b0: 2074 6865 2062 6163 6b77 6172 640a 2020   the backward.  
-000089c0: 2020 2320 7061 7373 2074 6f20 6765 6e65    # pass to gene
-000089d0: 7261 7465 2074 776f 206b 6572 6e65 6c73  rate two kernels
-000089e0: 0a20 2020 206d 6561 6e5f 6d64 7479 7065  .    mean_mdtype
-000089f0: 203d 2070 7269 6d73 2e63 6f6e 7665 7274   = prims.convert
-00008a00: 5f65 6c65 6d65 6e74 5f74 7970 6528 6d2c  _element_type(m,
-00008a10: 206d 2e64 7479 7065 290a 2020 2020 7265   m.dtype).    re
-00008a20: 7374 6f72 6564 5f6d 6561 6e20 3d20 7265  stored_mean = re
-00008a30: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
-00008a40: 6d73 286d 6561 6e5f 6d64 7479 7065 2c20  ms(mean_mdtype, 
-00008a50: 6469 6d73 2c20 612e 7368 6170 6529 0a20  dims, a.shape). 
-00008a60: 2020 2076 6172 5f67 7261 6420 3d20 2832     var_grad = (2
-00008a70: 202a 2072 6573 746f 7265 645f 6776 202a   * restored_gv *
-00008a80: 2028 6120 2d20 7265 7374 6f72 6564 5f6d   (a - restored_m
-00008a90: 6561 6e29 2920 2f20 6e6f 726d 616c 697a  ean)) / normaliz
-00008aa0: 6174 696f 6e5f 7363 616c 6172 0a0a 2020  ation_scalar..  
-00008ab0: 2020 7075 745f 6772 6164 2861 2c20 6d65    put_grad(a, me
-00008ac0: 616e 5f67 7261 6420 2b20 7661 725f 6772  an_grad + var_gr
-00008ad0: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
-00008ae0: 762c 206d 0a0a 0a72 6567 6973 7465 725f  v, m...register_
-00008af0: 6772 6164 2870 6964 732e 5641 525f 4d45  grad(pids.VAR_ME
-00008b00: 414e 2c20 5f76 6172 5f6d 6561 6e5f 7072  AN, _var_mean_pr
-00008b10: 696d 5f67 7261 6429 0a0a 0a23 0a23 204c  im_grad)...#.# L
-00008b20: 696e 6561 7220 616c 6765 6272 6120 6f70  inear algebra op
-00008b30: 6572 6174 6f72 2067 7261 6473 0a23 0a40  erator grads.#.@
-00008b40: 746f 7263 6863 7478 0a64 6566 205f 6c69  torchctx.def _li
-00008b50: 6e65 6172 5f70 7269 6d5f 6772 6164 2861  near_prim_grad(a
-00008b60: 3a20 5465 6e73 6f72 5072 6f78 792c 2077  : TensorProxy, w
-00008b70: 3a20 5465 6e73 6f72 5072 6f78 792c 2062  : TensorProxy, b
-00008b80: 6961 733a 204e 6f6e 6520 7c20 5465 6e73  ias: None | Tens
-00008b90: 6f72 5072 6f78 7929 202d 3e20 5465 6e73  orProxy) -> Tens
-00008ba0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00008bb0: 203d 2070 7269 6d73 2e6c 696e 6561 7228   = prims.linear(
-00008bc0: 612c 2077 2c20 6269 6173 290a 0a20 2020  a, w, bias)..   
-00008bd0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00008be0: 6429 0a0a 2020 2020 6669 7273 745f 6469  d)..    first_di
-00008bf0: 6d20 3d20 2d32 0a20 2020 2067 7261 645f  m = -2.    grad_
-00008c00: 6120 3d20 6c74 6f72 6368 2e6d 6174 6d75  a = ltorch.matmu
-00008c10: 6c28 672e 7265 7368 6170 6528 2d31 2c20  l(g.reshape(-1, 
-00008c20: 672e 7368 6170 655b 2d31 5d29 2c20 7729  g.shape[-1]), w)
-00008c30: 2e72 6573 6861 7065 2861 2e73 6861 7065  .reshape(a.shape
-00008c40: 290a 0a20 2020 2067 7261 645f 773a 2054  )..    grad_w: T
-00008c50: 656e 736f 7250 726f 7879 0a20 2020 2069  ensorProxy.    i
-00008c60: 6620 612e 6e64 696d 203d 3d20 313a 0a20  f a.ndim == 1:. 
-00008c70: 2020 2020 2020 2067 7261 645f 7720 3d20         grad_w = 
-00008c80: 6c74 6f72 6368 2e6d 6174 6d75 6c28 672e  ltorch.matmul(g.
-00008c90: 756e 7371 7565 657a 6528 6669 7273 745f  unsqueeze(first_
-00008ca0: 6469 6d29 2e6d 542c 2061 2e75 6e73 7175  dim).mT, a.unsqu
-00008cb0: 6565 7a65 2866 6972 7374 5f64 696d 2929  eeze(first_dim))
-00008cc0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00008cd0: 2020 2067 7261 645f 7720 3d20 6c74 6f72     grad_w = ltor
-00008ce0: 6368 2e6d 6174 6d75 6c28 672e 7265 7368  ch.matmul(g.resh
-00008cf0: 6170 6528 2d31 2c20 672e 7368 6170 655b  ape(-1, g.shape[
-00008d00: 2d31 5d29 2e6d 542c 2061 2e72 6573 6861  -1]).mT, a.resha
-00008d10: 7065 282d 312c 2061 2e73 6861 7065 5b2d  pe(-1, a.shape[-
-00008d20: 315d 2929 0a0a 2020 2020 7075 745f 6772  1]))..    put_gr
-00008d30: 6164 7328 2861 2c20 7729 2c20 2867 7261  ads((a, w), (gra
-00008d40: 645f 612c 2067 7261 645f 7729 290a 0a20  d_a, grad_w)).. 
-00008d50: 2020 2069 6620 6269 6173 2069 7320 6e6f     if bias is no
-00008d60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00008d70: 6966 2067 2e6e 6469 6d20 3e20 313a 0a20  if g.ndim > 1:. 
-00008d80: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
-00008d90: 6269 6173 203d 206c 746f 7263 682e 7375  bias = ltorch.su
-00008da0: 6d28 672c 2074 7570 6c65 2872 616e 6765  m(g, tuple(range
-00008db0: 2867 2e6e 6469 6d20 2d20 3129 2929 0a20  (g.ndim - 1))). 
-00008dc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00008dd0: 2020 2020 2020 2020 2067 7261 645f 6269           grad_bi
-00008de0: 6173 203d 2067 0a20 2020 2020 2020 2070  as = g.        p
-00008df0: 7574 5f67 7261 6428 6269 6173 2c20 6772  ut_grad(bias, gr
-00008e00: 6164 5f62 6961 7329 0a0a 2020 2020 7265  ad_bias)..    re
-00008e10: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00008e20: 7465 725f 6772 6164 2870 6964 732e 4c49  ter_grad(pids.LI
-00008e30: 4e45 4152 2c20 5f6c 696e 6561 725f 7072  NEAR, _linear_pr
-00008e40: 696d 5f67 7261 6429 0a0a 0a23 2054 4f44  im_grad)...# TOD
-00008e50: 4f20 4164 6420 6578 706c 6963 6974 206c  O Add explicit l
-00008e60: 746f 7263 6820 7673 2063 6c61 6e67 206d  torch vs clang m
-00008e70: 6f64 756c 6520 746f 2074 6865 2074 656e  odule to the ten
-00008e80: 736f 7220 6f70 6572 6174 696f 6e73 2062  sor operations b
-00008e90: 656c 6f77 0a23 2054 4f44 4f20 636f 756c  elow.# TODO coul
-00008ea0: 6420 7765 2067 6574 2072 6964 206f 6620  d we get rid of 
-00008eb0: 7468 6520 6669 6e61 6c20 7371 7565 657a  the final squeez
-00008ec0: 6573 2069 6e20 7468 6520 622e 6e64 696d  es in the b.ndim
-00008ed0: 203d 3d20 3120 6361 7365 2061 6e64 2074   == 1 case and t
-00008ee0: 6865 2061 2e6e 6469 6d20 3d3d 2031 2063  he a.ndim == 1 c
-00008ef0: 6173 653f 0a40 746f 7263 6863 7478 0a64  ase?.@torchctx.d
-00008f00: 6566 205f 6d61 746d 756c 5f70 7269 6d5f  ef _matmul_prim_
-00008f10: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
-00008f20: 6f78 792c 2062 3a20 5465 6e73 6f72 5072  oxy, b: TensorPr
-00008f30: 6f78 792c 202f 2920 2d3e 2054 656e 736f  oxy, /) -> Tenso
-00008f40: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00008f50: 3d20 7072 696d 732e 6d61 746d 756c 2861  = prims.matmul(a
-00008f60: 2c20 6229 0a20 2020 2067 203d 2067 6574  , b).    g = get
-00008f70: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
-00008f80: 6c61 7374 5f64 696d 203d 2028 2d31 2c29  last_dim = (-1,)
-00008f90: 0a20 2020 2066 6972 7374 5f64 696d 203d  .    first_dim =
-00008fa0: 2028 2d32 2c29 0a20 2020 2069 6620 612e   (-2,).    if a.
-00008fb0: 6e64 696d 203d 3d20 3120 616e 6420 622e  ndim == 1 and b.
-00008fc0: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
-00008fd0: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
-00008fe0: 2062 292c 2028 6720 2a20 622c 2067 202a   b), (g * b, g *
-00008ff0: 2061 2929 0a20 2020 2065 6c69 6620 622e   a)).    elif b.
-00009000: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
-00009010: 2020 2067 6120 3d20 756e 7371 7565 657a     ga = unsqueez
-00009020: 6528 672c 206c 6173 745f 6469 6d29 2040  e(g, last_dim) @
-00009030: 2075 6e73 7175 6565 7a65 2862 2c20 6c61   unsqueeze(b, la
-00009040: 7374 5f64 696d 292e 6d54 0a20 2020 2020  st_dim).mT.     
-00009050: 2020 2067 6220 3d20 612e 6d54 2040 2075     gb = a.mT @ u
-00009060: 6e73 7175 6565 7a65 2867 2c20 6c61 7374  nsqueeze(g, last
-00009070: 5f64 696d 290a 2020 2020 2020 2020 6966  _dim).        if
-00009080: 2067 2e6e 6469 6d20 3e20 313a 0a20 2020   g.ndim > 1:.   
-00009090: 2020 2020 2020 2020 2067 6220 3d20 7371           gb = sq
-000090a0: 7565 657a 6528 6762 2c20 6c61 7374 5f64  ueeze(gb, last_d
-000090b0: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
-000090c0: 6762 203d 206c 746f 7263 682e 7375 6d28  gb = ltorch.sum(
-000090d0: 6762 2c20 7475 706c 6528 7261 6e67 6528  gb, tuple(range(
-000090e0: 6762 2e6e 6469 6d20 2d20 3129 2929 0a20  gb.ndim - 1))). 
-000090f0: 2020 2020 2020 2070 7574 5f67 7261 6473         put_grads
-00009100: 2828 612c 2062 292c 2028 6761 2c20 6762  ((a, b), (ga, gb
-00009110: 2e73 7175 6565 7a65 2829 2929 0a20 2020  .squeeze())).   
-00009120: 2065 6c69 6620 612e 6e64 696d 203d 3d20   elif a.ndim == 
-00009130: 313a 0a20 2020 2020 2020 2067 6120 3d20  1:.        ga = 
-00009140: 756e 7371 7565 657a 6528 672c 2066 6972  unsqueeze(g, fir
-00009150: 7374 5f64 696d 2920 4020 622e 6d54 0a20  st_dim) @ b.mT. 
-00009160: 2020 2020 2020 2069 6620 672e 6e64 696d         if g.ndim
-00009170: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-00009180: 2020 6761 203d 206c 746f 7263 682e 7375    ga = ltorch.su
-00009190: 6d28 6761 2c20 7475 706c 6528 7261 6e67  m(ga, tuple(rang
-000091a0: 6528 6761 2e6e 6469 6d20 2d20 3129 2929  e(ga.ndim - 1)))
-000091b0: 0a20 2020 2020 2020 2067 6220 3d20 756e  .        gb = un
-000091c0: 7371 7565 657a 6528 612c 2066 6972 7374  squeeze(a, first
-000091d0: 5f64 696d 292e 6d54 2040 2075 6e73 7175  _dim).mT @ unsqu
-000091e0: 6565 7a65 2867 2c20 6669 7273 745f 6469  eeze(g, first_di
-000091f0: 6d29 0a20 2020 2020 2020 2070 7574 5f67  m).        put_g
-00009200: 7261 6473 2828 612c 2062 292c 2028 6761  rads((a, b), (ga
-00009210: 2e73 7175 6565 7a65 2829 2c20 6762 2929  .squeeze(), gb))
-00009220: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00009230: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
-00009240: 2062 292c 2028 6720 4020 622e 6d54 2c20   b), (g @ b.mT, 
-00009250: 612e 6d54 2040 2067 2929 0a0a 2020 2020  a.mT @ g))..    
-00009260: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00009270: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00009280: 4d41 544d 554c 2c20 5f6d 6174 6d75 6c5f  MATMUL, _matmul_
-00009290: 7072 696d 5f67 7261 6429 0a0a 230a 2320  prim_grad)..#.# 
-000092a0: 4e4e 206f 7065 7261 746f 7220 6772 6164  NN operator grad
-000092b0: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
-000092c0: 6465 6620 5f65 6d62 6564 6469 6e67 5f70  def _embedding_p
-000092d0: 7269 6d5f 6772 6164 280a 2020 2020 613a  rim_grad(.    a:
-000092e0: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
-000092f0: 2077 6569 6768 742c 202a 2c20 7061 6464   weight, *, padd
-00009300: 696e 675f 6964 783d 2d31 2c20 6d61 785f  ing_idx=-1, max_
-00009310: 6e6f 726d 3d4e 6f6e 652c 206e 6f72 6d5f  norm=None, norm_
-00009320: 7479 7065 3d32 2e30 2c20 7363 616c 655f  type=2.0, scale_
-00009330: 6772 6164 5f62 795f 6672 6571 3d46 616c  grad_by_freq=Fal
-00009340: 7365 2c20 7370 6172 7365 3d46 616c 7365  se, sparse=False
-00009350: 0a29 202d 3e20 5465 6e73 6f72 5072 6f78  .) -> TensorProx
-00009360: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00009370: 6d73 2e65 6d62 6564 6469 6e67 280a 2020  ms.embedding(.  
-00009380: 2020 2020 2020 612c 0a20 2020 2020 2020        a,.       
-00009390: 2077 6569 6768 742c 0a20 2020 2020 2020   weight,.       
-000093a0: 2070 6164 6469 6e67 5f69 6478 3d70 6164   padding_idx=pad
-000093b0: 6469 6e67 5f69 6478 2c0a 2020 2020 2020  ding_idx,.      
-000093c0: 2020 6d61 785f 6e6f 726d 3d6d 6178 5f6e    max_norm=max_n
-000093d0: 6f72 6d2c 0a20 2020 2020 2020 206e 6f72  orm,.        nor
-000093e0: 6d5f 7479 7065 3d6e 6f72 6d5f 7479 7065  m_type=norm_type
-000093f0: 2c0a 2020 2020 2020 2020 7363 616c 655f  ,.        scale_
-00009400: 6772 6164 5f62 795f 6672 6571 3d73 6361  grad_by_freq=sca
-00009410: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
-00009420: 0a20 2020 2020 2020 2073 7061 7273 653d  .        sparse=
-00009430: 7370 6172 7365 2c0a 2020 2020 290a 0a20  sparse,.    ).. 
-00009440: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00009450: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
-00009460: 3d20 7072 696d 732e 656d 6265 6464 696e  = prims.embeddin
-00009470: 675f 6261 636b 7761 7264 2867 2c20 612c  g_backward(g, a,
-00009480: 2077 6569 6768 742e 7368 6170 655b 305d   weight.shape[0]
-00009490: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
-000094a0: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-000094b0: 712c 2073 7061 7273 6529 0a20 2020 2070  q, sparse).    p
-000094c0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
-000094d0: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
-000094e0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-000094f0: 6164 2870 6964 732e 454d 4245 4444 494e  ad(pids.EMBEDDIN
-00009500: 472c 205f 656d 6265 6464 696e 675f 7072  G, _embedding_pr
-00009510: 696d 5f67 7261 6429 0a0a 230a 2320 5068  im_grad)..#.# Ph
-00009520: 616e 746f 6d20 6772 6164 2074 7261 6e73  antom grad trans
-00009530: 666f 726d 2068 656c 7065 7273 0a23 0a0a  form helpers.#..
-00009540: 0a64 6566 205f 6765 745f 6772 6164 666e  .def _get_gradfn
-00009550: 5f61 6e64 5f65 7865 6375 746f 7228 0a20  _and_executor(. 
-00009560: 2020 2062 7379 6d3a 2042 6f75 6e64 5379     bsym: BoundSy
-00009570: 6d62 6f6c 2c20 2a2c 2065 7865 6375 746f  mbol, *, executo
-00009580: 7273 5f6c 6973 743a 2053 6571 7565 6e63  rs_list: Sequenc
-00009590: 655b 416e 795d 203d 2074 7570 6c65 2829  e[Any] = tuple()
-000095a0: 0a29 202d 3e20 7475 706c 655b 4361 6c6c  .) -> tuple[Call
-000095b0: 6162 6c65 207c 204e 6f6e 652c 2045 7865  able | None, Exe
-000095c0: 6375 746f 7220 7c20 4e6f 6e65 5d3a 0a20  cutor | None]:. 
-000095d0: 2020 2063 6420 3d20 6765 745f 636f 6d70     cd = get_comp
-000095e0: 696c 655f 6461 7461 2829 0a20 2020 2065  ile_data().    e
-000095f0: 7865 6375 746f 7273 5f6c 6973 7420 3d20  xecutors_list = 
-00009600: 6364 2e65 7865 6375 746f 7273 5f6c 6973  cd.executors_lis
-00009610: 7420 6966 2063 6420 6973 206e 6f74 204e  t if cd is not N
-00009620: 6f6e 6520 656c 7365 2065 7865 6375 746f  one else executo
-00009630: 7273 5f6c 6973 740a 2020 2020 2320 4368  rs_list.    # Ch
-00009640: 6563 6b73 2069 6620 7468 6520 6578 6563  ecks if the exec
-00009650: 7574 6f72 2077 6869 6368 2068 6173 2070  utor which has p
-00009660: 7269 6f72 6974 7920 666f 7220 7468 6973  riority for this
-00009670: 206f 7065 7261 7469 6f6e 2068 6173 2061   operation has a
-00009680: 2073 7065 6369 6669 6320 6772 6164 2074   specific grad t
-00009690: 7261 6e73 666f 726d 2066 6f72 2069 740a  ransform for it.
-000096a0: 2020 2020 666f 7220 6578 2069 6e20 6578      for ex in ex
-000096b0: 6563 7574 6f72 735f 6c69 7374 3a0a 2020  ecutors_list:.  
-000096c0: 2020 2020 2020 6966 2065 782e 6361 6e5f        if ex.can_
-000096d0: 6578 6563 7574 655f 6f72 5f66 7573 6528  execute_or_fuse(
-000096e0: 6273 796d 293a 0a20 2020 2020 2020 2020  bsym):.         
-000096f0: 2020 2065 785f 6772 6164 5f74 7261 6e73     ex_grad_trans
-00009700: 666f 726d 3a20 4e6f 6e65 207c 2043 616c  form: None | Cal
-00009710: 6c61 626c 6520 3d20 6578 2e67 6574 5f67  lable = ex.get_g
-00009720: 7261 645f 7472 616e 7366 6f72 6d28 6273  rad_transform(bs
-00009730: 796d 2e73 796d 290a 2020 2020 2020 2020  ym.sym).        
-00009740: 2020 2020 6966 2065 785f 6772 6164 5f74      if ex_grad_t
-00009750: 7261 6e73 666f 726d 2069 7320 6e6f 7420  ransform is not 
-00009760: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00009770: 2020 2020 2020 7265 7475 726e 2065 785f        return ex_
-00009780: 6772 6164 5f74 7261 6e73 666f 726d 2c20  grad_transform, 
-00009790: 6578 0a20 2020 2020 2020 2020 2020 2062  ex.            b
-000097a0: 7265 616b 0a0a 2020 2020 2320 4966 2074  reak..    # If t
-000097b0: 6865 2065 7865 6375 746f 7220 646f 6573  he executor does
-000097c0: 6e27 7420 6465 6669 6e65 2069 7473 206f  n't define its o
-000097d0: 776e 2067 7261 6420 7472 616e 7366 6f72  wn grad transfor
-000097e0: 6d2c 2074 6869 7320 6a75 7374 2072 6574  m, this just ret
-000097f0: 7572 6e73 2074 6865 2064 6566 6175 6c74  urns the default
-00009800: 2067 7261 6420 7472 616e 7366 6f72 6d20   grad transform 
-00009810: 666f 7220 7468 6520 6273 796d 0a20 2020  for the bsym.   
-00009820: 2067 7261 6466 6e20 3d20 5f67 7261 645f   gradfn = _grad_
-00009830: 666e 5f6d 6170 2e67 6574 2862 7379 6d2e  fn_map.get(bsym.
-00009840: 7379 6d2e 6964 2c20 4e6f 6e65 290a 2020  sym.id, None).  
-00009850: 2020 7265 7475 726e 2067 7261 6466 6e2c    return gradfn,
-00009860: 204e 6f6e 650a 0a0a 2320 5468 6520 6465   None...# The de
-00009870: 6661 756c 7420 6772 6164 2073 7065 6369  fault grad speci
-00009880: 6669 6572 2066 6f72 2074 6865 2067 7261  fier for the gra
-00009890: 6420 7472 616e 7366 6f72 6d0a 2320 2020  d transform.#   
-000098a0: 466f 7220 6561 6368 2074 656e 736f 7220  For each tensor 
-000098b0: 6f75 7470 7574 2022 6f22 2072 6571 7569  output "o" requi
-000098c0: 7269 6e67 2067 7261 642c 2073 7065 6369  ring grad, speci
-000098d0: 6669 6573 2061 2067 7261 6420 6f66 206f  fies a grad of o
-000098e0: 6e65 735f 6c69 6b65 286f 290a 6465 6620  nes_like(o).def 
-000098f0: 5f67 7261 645f 7370 6563 6966 6965 725f  _grad_specifier_
-00009900: 6465 6661 756c 7428 7079 7472 6565 3a20  default(pytree: 
-00009910: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
-00009920: 2020 666c 6174 732c 205f 203d 2074 7265    flats, _ = tre
-00009930: 655f 666c 6174 7465 6e28 7079 7472 6565  e_flatten(pytree
-00009940: 290a 0a20 2020 2066 6f72 2066 2069 6e20  )..    for f in 
-00009950: 666c 6174 733a 0a20 2020 2020 2020 2069  flats:.        i
-00009960: 6620 6973 696e 7374 616e 6365 2866 2c20  f isinstance(f, 
-00009970: 5465 6e73 6f72 5072 6f78 7929 2061 6e64  TensorProxy) and
-00009980: 2066 2e72 6571 7569 7265 735f 6772 6164   f.requires_grad
-00009990: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000099a0: 4e4f 5445 2054 6869 7320 7573 6573 2063  NOTE This uses c
-000099b0: 6c61 6e67 2e6f 6e65 735f 6c69 6b65 2066  lang.ones_like f
-000099c0: 6f72 206e 6f77 2062 6563 6175 7365 206c  or now because l
-000099d0: 746f 7263 682e 6f6e 6573 5f6c 696b 6520  torch.ones_like 
-000099e0: 7769 6c6c 2065 7874 656e 6420 7468 650a  will extend the.
-000099f0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00009a00: 6c69 6665 7469 6d65 206f 6620 662c 2077  lifetime of f, w
-00009a10: 6869 6c65 2063 6c61 6e67 2e6f 6e65 735f  hile clang.ones_
-00009a20: 6c69 6b65 2077 696c 6c20 6578 7472 6163  like will extrac
-00009a30: 7420 7468 6520 6d65 7461 6461 7461 206f  t the metadata o
-00009a40: 6620 6620 6174 2074 7261 6365 2074 696d  f f at trace tim
-00009a50: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
-00009a60: 696d 732e 7075 745f 6772 6164 2866 2c20  ims.put_grad(f, 
-00009a70: 636c 616e 672e 6675 6c6c 5f6c 696b 6528  clang.full_like(
-00009a80: 662c 2031 2e30 2929 0a0a 0a23 2054 4f44  f, 1.0))...# TOD
-00009a90: 4f20 5465 7374 2077 6974 6820 6275 6666  O Test with buff
-00009aa0: 6572 730a 6465 6620 5f67 7261 645f 6f75  ers.def _grad_ou
-00009ab0: 745f 7370 6563 6966 6965 725f 6465 6661  t_specifier_defa
-00009ac0: 756c 7428 7079 7472 6565 3a20 416e 7929  ult(pytree: Any)
-00009ad0: 202d 3e20 6c69 7374 5b54 656e 736f 7250   -> list[TensorP
-00009ae0: 726f 7879 5d3a 0a20 2020 2066 6c61 7473  roxy]:.    flats
-00009af0: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
-00009b00: 656e 2870 7974 7265 6529 0a20 2020 2067  en(pytree).    g
-00009b10: 7261 6473 203d 206c 6973 7428 5b70 7269  rads = list([pri
-00009b20: 6d73 2e67 6574 5f67 7261 6428 6629 2066  ms.get_grad(f) f
-00009b30: 6f72 2066 2069 6e20 666c 6174 7320 6966  or f in flats if
-00009b40: 2069 7369 6e73 7461 6e63 6528 662c 2054   isinstance(f, T
-00009b50: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
-00009b60: 662e 7265 7175 6972 6573 5f67 7261 645d  f.requires_grad]
-00009b70: 290a 2020 2020 7265 7475 726e 2067 7261  ).    return gra
-00009b80: 6473 0a0a 0a23 2054 4f44 4f20 466f 726d  ds...# TODO Form
-00009b90: 616c 6c79 2064 6566 696e 6520 7468 6520  ally define the 
-00009ba0: 2267 7261 6469 656e 7422 206f 6620 6120  "gradient" of a 
-00009bb0: 7465 6e73 6f72 0a23 2054 4f44 4f20 4966  tensor.# TODO If
-00009bc0: 206e 6f6e 6520 6f66 2074 6865 2069 6e70   none of the inp
-00009bd0: 7574 7320 746f 2061 6e20 6f70 6572 6174  uts to an operat
-00009be0: 696f 6e20 7265 7175 6972 6520 6772 6164  ion require grad
-00009bf0: 2c20 7468 656e 2077 6520 636f 756c 6420  , then we could 
-00009c00: 6c65 6176 6520 7468 6174 206f 7065 7261  leave that opera
-00009c10: 7469 6f6e 2061 6c6f 6e65 0a23 2020 2054  tion alone.#   T
-00009c20: 6869 7320 636f 756c 6420 6163 7475 616c  his could actual
-00009c30: 6c79 2069 6d70 726f 7665 2070 6572 666f  ly improve perfo
-00009c40: 726d 616e 6365 2069 6620 7468 6520 6f70  rmance if the op
-00009c50: 6572 6174 696f 6e20 7065 7266 6f72 6d73  eration performs
-00009c60: 2065 7874 7261 2063 6f6d 7075 7461 7469   extra computati
-00009c70: 6f6e 7320 696e 2069 7473 2067 7261 6420  ons in its grad 
-00009c80: 7472 616e 7366 6f72 6d0a 2320 2020 4120  transform.#   A 
-00009c90: 776f 726b 6172 6f75 6e64 2066 6f72 2074  workaround for t
-00009ca0: 6869 7320 776f 756c 6420 6265 2066 6f72  his would be for
-00009cb0: 2074 6865 206f 7065 7261 7469 6f6e 2069   the operation i
-00009cc0: 7473 656c 6620 746f 2063 6865 636b 2069  tself to check i
-00009cd0: 6620 6974 7320 696e 7075 7420 7265 7175  f its input requ
-00009ce0: 6972 6573 2067 7261 6420 6f72 206e 6f74  ires grad or not
-00009cf0: 0a23 2054 7261 6e73 666f 726d 7320 6120  .# Transforms a 
-00009d00: 6675 6e63 7469 6f6e 2074 6f20 636f 6d70  function to comp
-00009d10: 7574 6520 7468 6520 2267 7261 6469 656e  ute the "gradien
-00009d20: 7422 206f 6620 6974 7320 696e 7075 7473  t" of its inputs
-00009d30: 2072 6571 7569 7269 6e67 2067 7261 642c   requiring grad,
-00009d40: 2070 6f73 7369 626c 790a 2320 2020 6d6f   possibly.#   mo
-00009d50: 6469 6669 6564 2062 7920 7468 6520 6772  dified by the gr
-00009d60: 6164 2073 7065 6369 6669 6572 7320 2873  ad specifiers (s
-00009d70: 6565 2062 656c 6f77 292e 0a23 2054 6865  ee below)..# The
-00009d80: 206f 7074 696f 6e61 6c20 6772 6164 5f73   optional grad_s
-00009d90: 7065 6369 6669 6572 2061 7267 756d 656e  pecifier argumen
-00009da0: 7420 6163 6365 7074 7320 7468 6520 6675  t accepts the fu
-00009db0: 6e63 7469 6f6e 2773 206f 7574 7075 742c  nction's output,
-00009dc0: 2072 756e 7320 696e 2061 206e 6f2d 6772   runs in a no-gr
-00009dd0: 6164 2063 6f6e 7465 7874 2c0a 2320 2020  ad context,.#   
-00009de0: 616e 6420 6361 6e20 7075 7420 6772 6164  and can put grad
-00009df0: 7320 2875 7369 6e67 2070 7269 6d73 2e70  s (using prims.p
-00009e00: 7574 5f67 7261 6428 2929 2066 6f72 2074  ut_grad()) for t
-00009e10: 656e 736f 7273 2e20 4279 2064 6566 6175  ensors. By defau
-00009e20: 6c74 2c20 666f 7220 6576 6572 7920 7465  lt, for every te
-00009e30: 6e73 6f72 206f 7574 7075 7420 226f 220a  nsor output "o".
-00009e40: 2320 2020 7468 6174 2072 6571 7569 7265  #   that require
-00009e50: 7320 6772 6164 2c20 6120 6772 6164 206f  s grad, a grad o
-00009e60: 6620 6f6e 6573 5f6c 696b 6528 6f29 2069  f ones_like(o) i
-00009e70: 7320 7075 742e 0a23 2054 6865 206f 7074  s put..# The opt
-00009e80: 696f 6e61 6c20 6772 6164 5f6f 7574 5f73  ional grad_out_s
-00009e90: 7065 6369 6669 6572 2061 6363 6570 7473  pecifier accepts
-00009ea0: 2074 6865 2066 756e 6374 696f 6e27 7320   the function's 
-00009eb0: 696e 7075 7420 616e 6420 6361 6e20 6361  input and can ca
-00009ec0: 6c6c 2070 7269 6d73 2e67 6574 5f67 7261  ll prims.get_gra
-00009ed0: 6428 2920 746f 0a23 2020 2061 6371 7569  d() to.#   acqui
-00009ee0: 7265 2061 6e64 2072 6574 7572 6e20 6772  re and return gr
-00009ef0: 6164 6965 6e74 7320 6173 2064 6573 6972  adients as desir
-00009f00: 6564 2e20 4279 2064 6566 6175 6c74 2c20  ed. By default, 
-00009f10: 7468 6520 696e 7075 7420 6973 2066 6c61  the input is fla
-00009f20: 7474 656e 6564 0a23 2020 2028 7472 6565  ttened.#   (tree
-00009f30: 5f66 6c61 7474 656e 2861 7267 732c 206b  _flatten(args, k
-00009f40: 7761 7267 7329 2920 616e 6420 6120 666c  wargs)) and a fl
-00009f50: 6174 206c 6973 7420 6f66 2067 7261 6473  at list of grads
-00009f60: 2066 6f72 2061 6c6c 2074 656e 736f 7273   for all tensors
-00009f70: 2072 6571 7569 7269 6e67 2067 7261 640a   requiring grad.
-00009f80: 2320 2020 616e 6420 4e6f 6e65 2066 6f72  #   and None for
-00009f90: 206f 7468 6572 2069 6e70 7574 7320 6973   other inputs is
-00009fa0: 2072 6574 7572 6e65 642e 0a23 2054 6865   returned..# The
-00009fb0: 2061 6c67 6f72 6974 686d 2066 6f72 206d   algorithm for m
-00009fc0: 6f64 6966 7969 6e67 2074 6865 2070 726f  odifying the pro
-00009fd0: 6772 616d 2068 6173 2074 6865 2066 6f6c  gram has the fol
-00009fe0: 6c6f 7769 6e67 2073 7465 7073 3a0a 2320  lowing steps:.# 
-00009ff0: 2020 3129 2046 6c61 7474 656e 7320 7468    1) Flattens th
-0000a000: 6520 6f72 6967 696e 616c 2074 7261 6365  e original trace
-0000a010: 2066 6f72 2074 6865 2067 7261 6420 7472   for the grad tr
-0000a020: 616e 7366 6f72 6d20 2d2d 2065 6e73 7569  ansform -- ensui
-0000a030: 6e67 2074 6861 7420 616c 6c20 746f 702d  ng that all top-
-0000a040: 6c65 7665 6c20 7379 6d62 6f6c 7320 6861  level symbols ha
-0000a050: 7665 0a23 2020 2020 2020 2061 2067 7261  ve.#       a gra
-0000a060: 6420 6675 6e63 7469 6f6e 2e0a 6465 6620  d function..def 
-0000a070: 6772 6164 280a 2020 2020 6366 6e2c 2067  grad(.    cfn, g
-0000a080: 7261 645f 7370 6563 6966 6965 723a 2043  rad_specifier: C
-0000a090: 616c 6c61 626c 6520 3d20 5f67 7261 645f  allable = _grad_
-0000a0a0: 7370 6563 6966 6965 725f 6465 6661 756c  specifier_defaul
-0000a0b0: 742c 2067 7261 645f 6f75 745f 7370 6563  t, grad_out_spec
-0000a0c0: 6966 6965 723a 2043 616c 6c61 626c 6520  ifier: Callable 
-0000a0d0: 3d20 5f67 7261 645f 6f75 745f 7370 6563  = _grad_out_spec
-0000a0e0: 6966 6965 725f 6465 6661 756c 740a 2920  ifier_default.) 
-0000a0f0: 2d3e 2043 616c 6c61 626c 653a 0a20 2020  -> Callable:.   
-0000a100: 2023 2043 7265 6174 6573 2061 2063 7573   # Creates a cus
-0000a110: 746f 6d20 7472 616e 7366 6f72 6d20 6361  tom transform ca
-0000a120: 6c6c 6162 6c65 2074 6861 7420 6269 6e64  llable that bind
-0000a130: 7320 7468 6520 6164 6469 7469 6f6e 616c  s the additional
-0000a140: 2061 7267 756d 656e 7473 2074 6f20 7468   arguments to th
-0000a150: 6520 6772 6164 2074 7261 6e73 666f 726d  e grad transform
-0000a160: 0a20 2020 2040 6c61 6e67 6374 7828 4c61  .    @langctx(La
-0000a170: 6e67 7561 6765 732e 434c 414e 4729 0a20  nguages.CLANG). 
-0000a180: 2020 2064 6566 205f 6772 6164 5f74 7261     def _grad_tra
-0000a190: 6e73 666f 726d 2874 7263 3a20 5472 6163  nsform(trc: Trac
-0000a1a0: 652c 202a 2c20 6578 6563 7574 6f72 735f  e, *, executors_
-0000a1b0: 6c69 7374 3a20 5365 7175 656e 6365 5b41  list: Sequence[A
-0000a1c0: 6e79 5d29 202d 3e20 5472 6163 653a 0a20  ny]) -> Trace:. 
-0000a1d0: 2020 2020 2020 2073 7461 7274 5f74 696d         start_tim
-0000a1e0: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
-0000a1f0: 5f6e 7328 290a 0a20 2020 2020 2020 2023  _ns()..        #
-0000a200: 2053 5445 5020 4f4e 4520 2d2d 2046 6c61   STEP ONE -- Fla
-0000a210: 7474 656e 7320 616e 6420 6463 6573 0a0a  ttens and dces..
-0000a220: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
-0000a230: 7320 5472 7565 2069 6620 7468 6520 6273  s True if the bs
-0000a240: 796d 2068 6173 206e 6f20 6772 6164 2066  ym has no grad f
-0000a250: 756e 6374 696f 6e2c 2061 6e64 2073 6f20  unction, and so 
-0000a260: 6d75 7374 2062 6520 666c 6174 7465 6e65  must be flattene
-0000a270: 6420 666f 7220 7468 6520 6772 6164 2074  d for the grad t
-0000a280: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
-0000a290: 206e 6576 6572 5f66 6c61 7474 656e 3a20   never_flatten: 
-0000a2a0: 7365 745b 4861 7368 6162 6c65 5d20 3d20  set[Hashable] = 
-0000a2b0: 7b70 7269 6d73 2e50 7269 6d49 4473 2e52  {prims.PrimIDs.R
-0000a2c0: 4554 5552 4e2c 2070 7269 6d73 2e50 7269  ETURN, prims.Pri
-0000a2d0: 6d49 4473 2e55 4e50 4143 4b5f 5452 4956  mIDs.UNPACK_TRIV
-0000a2e0: 4941 4c7d 0a0a 2020 2020 2020 2020 6465  IAL}..        de
-0000a2f0: 6620 7368 6f75 6c64 5f66 6c61 7474 656e  f should_flatten
-0000a300: 5f66 6f72 5f67 7261 6428 6273 796d 3a20  _for_grad(bsym: 
-0000a310: 426f 756e 6453 796d 626f 6c29 202d 3e20  BoundSymbol) -> 
-0000a320: 626f 6f6c 3a0a 2020 2020 2020 2020 2020  bool:.          
-0000a330: 2020 6966 2062 7379 6d2e 7379 6d2e 6964    if bsym.sym.id
-0000a340: 2069 6e20 6e65 7665 725f 666c 6174 7465   in never_flatte
-0000a350: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-0000a360: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0000a370: 0a20 2020 2020 2020 2020 2020 2067 7261  .            gra
-0000a380: 6466 6e3a 204e 6f6e 6520 7c20 4361 6c6c  dfn: None | Call
-0000a390: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
-0000a3a0: 2067 7261 6466 6e2c 205f 203d 205f 6765   gradfn, _ = _ge
-0000a3b0: 745f 6772 6164 666e 5f61 6e64 5f65 7865  t_gradfn_and_exe
-0000a3c0: 6375 746f 7228 6273 796d 2c20 6578 6563  cutor(bsym, exec
-0000a3d0: 7574 6f72 735f 6c69 7374 3d65 7865 6375  utors_list=execu
-0000a3e0: 746f 7273 5f6c 6973 7429 0a20 2020 2020  tors_list).     
-0000a3f0: 2020 2020 2020 2072 6574 7572 6e20 6772         return gr
-0000a400: 6164 666e 2069 7320 4e6f 6e65 0a0a 2020  adfn is None..  
-0000a410: 2020 2020 2020 2320 544f 444f 2052 4331        # TODO RC1
-0000a420: 3a20 6d61 7962 6520 6d6f 7665 2074 6f20  : maybe move to 
-0000a430: 7072 6f64 7563 6520 7468 6573 6520 616c  produce these al
-0000a440: 7761 7973 206f 6e20 6372 6561 7469 6f6e  ways on creation
-0000a450: 0a20 2020 2020 2020 2069 6620 7472 632e  .        if trc.
-0000a460: 6b77 6172 6773 2069 7320 4e6f 6e65 3a0a  kwargs is None:.
-0000a470: 2020 2020 2020 2020 2020 2020 7472 632e              trc.
-0000a480: 6b77 6172 6773 203d 207b 7d0a 2020 2020  kwargs = {}.    
-0000a490: 2020 2020 6966 2074 7263 2e66 6e20 6973      if trc.fn is
-0000a4a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000a4b0: 2020 2074 7263 2e66 6e20 3d20 7472 632e     trc.fn = trc.
-0000a4c0: 7079 7468 6f6e 5f63 616c 6c61 626c 6528  python_callable(
-0000a4d0: 290a 0a20 2020 2020 2020 2067 7261 6474  )..        gradt
-0000a4e0: 7263 203d 2066 726f 6d5f 7472 6163 6528  rc = from_trace(
-0000a4f0: 7472 6329 0a20 2020 2020 2020 2066 6c61  trc).        fla
-0000a500: 7474 656e 6564 5f62 7379 6d73 3a20 6c69  ttened_bsyms: li
-0000a510: 7374 5b42 6f75 6e64 5379 6d62 6f6c 5d20  st[BoundSymbol] 
-0000a520: 3d20 666c 6174 7465 6e5f 666f 725f 7472  = flatten_for_tr
-0000a530: 616e 7366 6f72 6d28 7368 6f75 6c64 5f66  ansform(should_f
-0000a540: 6c61 7474 656e 5f66 6f72 5f67 7261 642c  latten_for_grad,
-0000a550: 2074 7263 2e62 6f75 6e64 5f73 796d 626f   trc.bound_symbo
-0000a560: 6c73 290a 2020 2020 2020 2020 6772 6164  ls).        grad
-0000a570: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000a580: 7320 3d20 666c 6174 7465 6e65 645f 6273  s = flattened_bs
-0000a590: 796d 730a 2020 2020 2020 2020 6772 6164  yms.        grad
-0000a5a0: 7472 6320 3d20 6463 6528 6772 6164 7472  trc = dce(gradtr
-0000a5b0: 6329 0a0a 2020 2020 2020 2020 2320 5354  c)..        # ST
-0000a5c0: 4550 2054 574f 202d 2d20 5265 706c 6163  EP TWO -- Replac
-0000a5d0: 6573 206f 7269 6769 6e61 6c20 6361 6c6c  es original call
-0000a5e0: 7320 7769 7468 2067 7261 6420 6361 6c6c  s with grad call
-0000a5f0: 730a 0a20 2020 2020 2020 2023 2044 6566  s..        # Def
-0000a600: 696e 6573 2074 6865 2076 6973 6974 6f72  ines the visitor
-0000a610: 2070 6174 7465 726e 2066 6f72 2074 6865   pattern for the
-0000a620: 2066 6972 7374 2070 6173 7320 6f66 2074   first pass of t
-0000a630: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
-0000a640: 6d2c 0a20 2020 2020 2020 2023 2020 2077  m,.        #   w
-0000a650: 6869 6368 2073 7761 7073 2042 6f75 6e64  hich swaps Bound
-0000a660: 5379 6d62 6f6c 7320 7769 7468 2074 6865  Symbols with the
-0000a670: 6972 2067 7261 6420 6675 6e63 7469 6f6e  ir grad function
-0000a680: 730a 2020 2020 2020 2020 6465 6620 7669  s.        def vi
-0000a690: 7369 745f 2862 7379 6d3a 2042 6f75 6e64  sit_(bsym: Bound
-0000a6a0: 5379 6d62 6f6c 2920 2d3e 2043 616c 6c61  Symbol) -> Calla
-0000a6b0: 626c 653a 0a20 2020 2020 2020 2020 2020  ble:.           
-0000a6c0: 2067 7261 6466 6e3a 204e 6f6e 6520 7c20   gradfn: None | 
-0000a6d0: 4361 6c6c 6162 6c65 0a20 2020 2020 2020  Callable.       
-0000a6e0: 2020 2020 2067 7261 6466 6e2c 205f 203d       gradfn, _ =
-0000a6f0: 205f 6765 745f 6772 6164 666e 5f61 6e64   _get_gradfn_and
-0000a700: 5f65 7865 6375 746f 7228 6273 796d 2c20  _executor(bsym, 
-0000a710: 6578 6563 7574 6f72 735f 6c69 7374 3d65  executors_list=e
-0000a720: 7865 6375 746f 7273 5f6c 6973 7429 0a20  xecutors_list). 
-0000a730: 2020 2020 2020 2020 2020 2063 6865 636b             check
-0000a740: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a750: 2020 6772 6164 666e 2069 7320 6e6f 7420    gradfn is not 
-0000a760: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0000a770: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
-0000a780: 4661 696c 6564 2074 6f20 6669 6e64 2061  Failed to find a
-0000a790: 2067 7261 6466 6e20 666f 7220 7b62 7379   gradfn for {bsy
-0000a7a0: 6d3d 7d20 6166 7465 7220 666c 6174 7465  m=} after flatte
-0000a7b0: 6e69 6e67 222c 0a20 2020 2020 2020 2020  ning",.         
-0000a7c0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-0000a7d0: 5f74 7970 653d 4173 7365 7274 696f 6e45  _type=AssertionE
-0000a7e0: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
-0000a7f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000a800: 7265 7475 726e 2067 7261 6466 6e0a 0a20  return gradfn.. 
-0000a810: 2020 2020 2020 2040 7772 6170 7328 7472         @wraps(tr
-0000a820: 632e 666e 2e6d 6574 6120 6966 2069 7369  c.fn.meta if isi
-0000a830: 6e73 7461 6e63 6528 7472 632e 666e 2c20  nstance(trc.fn, 
-0000a840: 5379 6d62 6f6c 2920 656c 7365 2074 7263  Symbol) else trc
-0000a850: 2e66 6e29 0a20 2020 2020 2020 2064 6566  .fn).        def
-0000a860: 2069 6e74 6572 7072 6574 696e 675f 666e   interpreting_fn
-0000a870: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-0000a880: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000a890: 6573 756c 7420 3d20 6576 616c 5f74 7261  esult = eval_tra
-0000a8a0: 6365 2867 7261 6474 7263 2c20 2a61 7267  ce(gradtrc, *arg
-0000a8b0: 732c 2073 796d 626f 6c5f 6d61 7070 6572  s, symbol_mapper
-0000a8c0: 3d76 6973 6974 5f2c 202a 2a6b 7761 7267  =visit_, **kwarg
-0000a8d0: 7329 0a20 2020 2020 2020 2020 2020 2023  s).            #
-0000a8e0: 2053 6574 7320 6772 6164 7320 666f 7220   Sets grads for 
-0000a8f0: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
-0000a900: 2020 2023 2054 4f44 4f20 5468 6973 2065     # TODO This e
-0000a910: 6666 6563 7469 7665 6c79 2072 756e 7320  ffectively runs 
-0000a920: 696e 2061 206e 6f20 6772 6164 2063 6f6e  in a no grad con
-0000a930: 7465 7874 202d 2d20 7368 6f75 6c64 2069  text -- should i
-0000a940: 7420 7275 6e20 696e 2061 2067 7261 6420  t run in a grad 
-0000a950: 636f 6e74 6578 742c 0a20 2020 2020 2020  context,.       
-0000a960: 2020 2020 2023 2020 206f 7220 7368 6f75       #   or shou
-0000a970: 6c64 2074 6865 7265 2062 6520 7468 6520  ld there be the 
-0000a980: 6f70 7469 6f6e 2074 6f20 7275 6e20 6974  option to run it
-0000a990: 2069 6e20 6120 6772 6164 2063 6f6e 7465   in a grad conte
-0000a9a0: 7874 3f0a 2020 2020 2020 2020 2020 2020  xt?.            
-0000a9b0: 6772 6164 5f73 7065 6369 6669 6572 2872  grad_specifier(r
-0000a9c0: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
-0000a9d0: 2020 2023 2043 6f6e 7374 7275 6374 7320     # Constructs 
-0000a9e0: 7265 7475 726e 2076 616c 7565 0a20 2020  return value.   
-0000a9f0: 2020 2020 2020 2020 2066 6c61 745f 6772           flat_gr
-0000aa00: 6164 7320 3d20 6772 6164 5f6f 7574 5f73  ads = grad_out_s
-0000aa10: 7065 6369 6669 6572 2828 6172 6773 2c20  pecifier((args, 
-0000aa20: 6b77 6172 6773 2929 0a20 2020 2020 2020  kwargs)).       
-0000aa30: 2020 2020 2072 6574 7572 6e20 666c 6174       return flat
-0000aa40: 5f67 7261 6473 0a0a 2020 2020 2020 2020  _grads..        
-0000aa50: 2320 4e4f 5445 2041 6674 6572 2074 6869  # NOTE After thi
-0000aa60: 7320 6361 6c6c 2074 6865 2067 7261 6474  s call the gradt
-0000aa70: 7263 2069 7320 696e 7661 6c69 642c 2062  rc is invalid, b
-0000aa80: 6563 6175 7365 3a0a 2020 2020 2020 2020  ecause:.        
-0000aa90: 2320 2020 3129 2054 6865 206e 6f6e 2d65  #   1) The non-e
-0000aaa0: 7865 6375 7461 626c 6520 7075 745f 6772  xecutable put_gr
-0000aab0: 6164 206f 7065 7261 7469 6f6e 7320 6172  ad operations ar
-0000aac0: 6520 7374 696c 6c20 696e 2074 6865 2074  e still in the t
-0000aad0: 7261 6365 2c20 616e 6420 6d75 6c74 6970  race, and multip
-0000aae0: 6c65 2063 616c 6c73 2074 6f20 7075 7420  le calls to put 
-0000aaf0: 6772 6164 2061 7265 206e 6f74 2061 6363  grad are not acc
-0000ab00: 756d 756c 6174 6564 0a20 2020 2020 2020  umulated.       
-0000ab10: 2023 2020 2032 2920 5468 6520 6e6f 6e2d   #   2) The non-
-0000ab20: 6578 6563 7574 6162 6c65 2067 6574 5f67  executable get_g
-0000ab30: 7261 6420 6f70 6572 6174 696f 6e73 2061  rad operations a
-0000ab40: 7265 2073 7469 6c6c 2069 6e20 7468 6520  re still in the 
-0000ab50: 7472 6163 652c 2061 6e64 2074 6865 7920  trace, and they 
-0000ab60: 6d61 7920 7072 6f64 7563 6520 6469 6666  may produce diff
-0000ab70: 6572 656e 7420 7072 6f78 6965 7320 7768  erent proxies wh
-0000ab80: 656e 0a20 2020 2020 2020 2023 2020 2020  en.        #    
-0000ab90: 2020 2063 616c 6c65 6420 6f6e 2074 6865     called on the
-0000aba0: 2073 616d 6520 696e 7075 7473 0a20 2020   same inputs.   
-0000abb0: 2020 2020 2023 2020 2033 2920 5468 6520       #   3) The 
-0000abc0: 6f70 6572 6174 696f 6e73 2061 7265 206e  operations are n
-0000abd0: 6f74 2069 6e20 6120 7661 6c69 6420 6f72  ot in a valid or
-0000abe0: 6465 720a 2020 2020 2020 2020 6772 6164  der.        grad
-0000abf0: 7472 6320 3d20 636f 6e73 7472 7563 745f  trc = construct_
-0000ac00: 7472 6163 6528 0a20 2020 2020 2020 2020  trace(.         
-0000ac10: 2020 2072 656e 616d 655f 7072 6f78 6965     rename_proxie
-0000ac20: 733d 4661 6c73 652c 0a20 2020 2020 2020  s=False,.       
-0000ac30: 2020 2020 2075 7365 5f64 6365 3d46 616c       use_dce=Fal
-0000ac40: 7365 2c0a 2020 2020 2020 2020 2928 696e  se,.        )(in
-0000ac50: 7465 7270 7265 7469 6e67 5f66 6e2c 202a  terpreting_fn, *
-0000ac60: 6772 6164 7472 632e 6172 6773 2c20 2a2a  gradtrc.args, **
-0000ac70: 6772 6164 7472 632e 6b77 6172 6773 290a  gradtrc.kwargs).
-0000ac80: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
-0000ac90: 7363 6f70 6573 203d 205b 6772 6164 7472  scopes = [gradtr
-0000aca0: 632e 626f 756e 645f 7379 6d62 6f6c 735d  c.bound_symbols]
-0000acb0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000acc0: 2e5f 636f 6d70 6c65 7465 203d 2046 616c  ._complete = Fal
-0000acd0: 7365 0a0a 2020 2020 2020 2020 2320 5354  se..        # ST
-0000ace0: 4550 2054 4852 4545 202d 2d20 4861 6e64  EP THREE -- Hand
-0000acf0: 6c65 7320 7075 745f 6772 6164 2061 6e64  les put_grad and
-0000ad00: 2067 6574 5f67 7261 6420 6f70 6572 6174   get_grad operat
-0000ad10: 696f 6e73 2061 6e64 2061 6363 756d 756c  ions and accumul
-0000ad20: 6174 6573 2067 7261 6469 656e 7473 0a0a  ates gradients..
-0000ad30: 2020 2020 2020 2020 2320 4163 6375 6d75          # Accumu
-0000ad40: 6c61 7465 7320 6772 6164 6965 6e74 732c  lates gradients,
-0000ad50: 2063 7265 6174 696e 6720 7468 6520 7072   creating the pr
-0000ad60: 696d 616c 202d 3e20 6163 6375 6d75 6c61  imal -> accumula
-0000ad70: 7465 6420 6772 6164 206d 6170 7069 6e67  ted grad mapping
-0000ad80: 0a20 2020 2020 2020 2023 2053 6574 7320  .        # Sets 
-0000ad90: 7468 6520 7472 6163 696e 6720 636f 6e74  the tracing cont
-0000ada0: 6578 7420 736f 2061 6363 756d 756c 6174  ext so accumulat
-0000adb0: 696f 6e20 6f70 6572 6174 696f 6e73 2061  ion operations a
-0000adc0: 7265 2072 6563 6f72 6465 6420 696e 746f  re recorded into
-0000add0: 2074 6865 2074 7261 6365 0a20 2020 2020   the trace.     
-0000ade0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000adf0: 2020 2020 7472 6163 6563 7478 5f74 6f6b      tracectx_tok
-0000ae00: 203d 2073 6574 5f74 7261 6365 6374 7828   = set_tracectx(
-0000ae10: 6772 6164 7472 6329 0a0a 2020 2020 2020  gradtrc)..      
-0000ae20: 2020 2020 2020 2320 4d61 7073 2070 7269        # Maps pri
-0000ae30: 6d61 6c73 2074 6f20 7468 6569 7220 6772  mals to their gr
-0000ae40: 6164 6965 6e74 7320 2877 6869 6368 2061  adients (which a
-0000ae50: 7265 2072 6574 7572 6e65 6420 6672 6f6d  re returned from
-0000ae60: 2063 616c 6c69 6e67 2067 6574 5f67 7261   calling get_gra
-0000ae70: 6420 6f6e 2074 6865 2070 7269 6d61 6c29  d on the primal)
-0000ae80: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0000ae90: 6d61 6c73 5f74 6f5f 6769 6e70 7574 5f6d  mals_to_ginput_m
-0000aea0: 6170 3a20 6469 6374 5b56 6172 6961 626c  ap: dict[Variabl
-0000aeb0: 652c 2054 656e 736f 7250 726f 7879 5d20  e, TensorProxy] 
-0000aec0: 3d20 7b7d 0a0a 2020 2020 2020 2020 2020  = {}..          
-0000aed0: 2020 2320 4861 6e64 6c65 7320 7075 745f    # Handles put_
-0000aee0: 6772 6164 206f 7065 7261 7469 6f6e 730a  grad operations.
-0000aef0: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-0000af00: 5445 2054 6869 7320 6d6f 6469 6669 6573  TE This modifies
-0000af10: 2061 206c 6973 7420 7468 6174 2069 7320   a list that is 
-0000af20: 6265 696e 6720 656e 756d 6572 6174 6564  being enumerated
-0000af30: 206f 7665 722c 2062 7574 2069 7427 7320   over, but it's 
-0000af40: 4f4b 2062 6563 6175 7365 2077 6527 7265  OK because we're
-0000af50: 206f 6e6c 790a 2020 2020 2020 2020 2020   only.          
-0000af60: 2020 2320 2020 6170 7065 6e64 696e 6720    #   appending 
-0000af70: 746f 2074 6865 2065 6e64 206f 6620 7468  to the end of th
-0000af80: 6520 6c69 7374 0a20 2020 2020 2020 2020  e list.         
-0000af90: 2020 2062 7379 6d3a 2042 6f75 6e64 5379     bsym: BoundSy
-0000afa0: 6d62 6f6c 0a20 2020 2020 2020 2020 2020  mbol.           
-0000afb0: 2066 6f72 2062 7379 6d20 696e 2067 7261   for bsym in gra
-0000afc0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
-0000afd0: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-0000afe0: 2020 2020 6964 3a20 4861 7368 6162 6c65      id: Hashable
-0000aff0: 203d 2062 7379 6d2e 7379 6d2e 6964 0a20   = bsym.sym.id. 
-0000b000: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b010: 6620 6964 2069 7320 7069 6473 2e50 5554  f id is pids.PUT
-0000b020: 5f47 5241 443a 0a20 2020 2020 2020 2020  _GRAD:.         
-0000b030: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-0000b040: 6c3a 204e 756d 6265 7220 7c20 5465 6e73  l: Number | Tens
-0000b050: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
-0000b060: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-0000b070: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-0000b080: 7250 726f 7879 0a20 2020 2020 2020 2020  rProxy.         
-0000b090: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-0000b0a0: 6c2c 2067 7261 6420 3d20 6273 796d 2e66  l, grad = bsym.f
-0000b0b0: 6c61 745f 6172 6773 0a0a 2020 2020 2020  lat_args..      
-0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000b0d0: 544f 444f 2053 7570 706f 7274 2061 7574  TODO Support aut
-0000b0e0: 6f67 7261 6420 6f6e 206e 756d 6265 7273  ograd on numbers
-0000b0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b100: 2020 2020 2023 2046 696c 7465 7273 2063       # Filters c
-0000b110: 616c 6c73 2074 6f20 7075 745f 6772 6164  alls to put_grad
-0000b120: 2074 6861 7420 776f 756c 6420 7075 7420   that would put 
-0000b130: 6120 6772 6164 206f 6e20 6120 6e6f 6e2d  a grad on a non-
-0000b140: 7465 6e73 6f72 206f 7220 6120 7465 6e73  tensor or a tens
-0000b150: 6f72 2074 6861 7420 646f 6573 6e27 7420  or that doesn't 
-0000b160: 7265 7175 6972 6520 6772 6164 0a20 2020  require grad.   
-0000b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b180: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-0000b190: 6365 2870 7269 6d61 6c2c 2054 656e 736f  ce(primal, Tenso
-0000b1a0: 7250 726f 7879 2920 6f72 206e 6f74 2070  rProxy) or not p
-0000b1b0: 7269 6d61 6c2e 7265 7175 6972 6573 5f67  rimal.requires_g
-0000b1c0: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-0000b1d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000b1e0: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0000b1f0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0000b200: 4f20 5375 7070 6f72 7420 636f 6d70 6c65  O Support comple
-0000b210: 7820 6175 746f 6772 6164 0a20 2020 2020  x autograd.     
-0000b220: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000b230: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
-0000b240: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-0000b250: 7420 6474 7970 6573 2e69 735f 636f 6d70  t dtypes.is_comp
-0000b260: 6c65 785f 6474 7970 6528 6474 7970 6573  lex_dtype(dtypes
-0000b270: 2e74 6f5f 6474 7970 6528 7072 696d 616c  .to_dtype(primal
-0000b280: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0000b290: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-0000b2a0: 6461 3a20 6622 436f 6d70 6c65 7820 6772  da: f"Complex gr
-0000b2b0: 6164 2069 7320 6e6f 7420 7375 7070 6f72  ad is not suppor
-0000b2c0: 7465 6420 7965 7422 2c0a 2020 2020 2020  ted yet",.      
-0000b2d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b2f0: 2020 2020 2076 7072 696d 616c 3a20 5661       vprimal: Va
-0000b300: 7269 6162 6c65 203d 2076 6172 6961 626c  riable = variabl
-0000b310: 6569 6679 2870 7269 6d61 6c29 0a20 2020  eify(primal).   
-0000b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b330: 2061 6363 756d 3a20 4e6f 6e65 207c 2054   accum: None | T
-0000b340: 656e 736f 7250 726f 7879 203d 2070 7269  ensorProxy = pri
-0000b350: 6d61 6c73 5f74 6f5f 6769 6e70 7574 5f6d  mals_to_ginput_m
-0000b360: 6170 2e67 6574 2876 7072 696d 616c 2c20  ap.get(vprimal, 
-0000b370: 4e6f 6e65 290a 0a20 2020 2020 2020 2020  None)..         
-0000b380: 2020 2020 2020 2020 2020 2069 6620 6163             if ac
-0000b390: 6375 6d20 6973 204e 6f6e 653a 0a20 2020  cum is None:.   
-0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3b0: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
-0000b3c0: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
-0000b3d0: 616c 5d20 3d20 6772 6164 0a20 2020 2020  al] = grad.     
-0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000b3f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000b400: 2020 2020 2020 2020 2020 2020 2061 6363               acc
-0000b410: 756d 203d 2061 6363 756d 202b 2067 7261  um = accum + gra
-0000b420: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000b430: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-0000b440: 735f 746f 5f67 696e 7075 745f 6d61 705b  s_to_ginput_map[
-0000b450: 7670 7269 6d61 6c5d 203d 2061 6363 756d  vprimal] = accum
-0000b460: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000b470: 4861 6e64 6c65 7320 6765 745f 6772 6164  Handles get_grad
-0000b480: 206f 7065 7261 7469 6f6e 730a 0a20 2020   operations..   
-0000b490: 2020 2020 2020 2020 2023 2052 6573 6574           # Reset
-0000b4a0: 7320 7468 6520 7377 6170 6d61 7020 666f  s the swapmap fo
-0000b4b0: 7220 6772 6164 730a 2020 2020 2020 2020  r grads.        
-0000b4c0: 2020 2020 7377 6170 6d61 703a 2064 6963      swapmap: dic
-0000b4d0: 745b 5661 7269 6162 6c65 2c20 5072 6f78  t[Variable, Prox
-0000b4e0: 795d 203d 207b 7d0a 0a20 2020 2020 2020  y] = {}..       
-0000b4f0: 2020 2020 2066 6f72 2062 7379 6d20 696e       for bsym in
-0000b500: 2067 7261 6474 7263 2e62 6f75 6e64 5f73   gradtrc.bound_s
-0000b510: 796d 626f 6c73 3a0a 2020 2020 2020 2020  ymbols:.        
-0000b520: 2020 2020 2020 2020 6964 3a20 4861 7368          id: Hash
-0000b530: 6162 6c65 203d 2062 7379 6d2e 7379 6d2e  able = bsym.sym.
-0000b540: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
-0000b550: 2020 2069 6620 6964 2069 7320 7069 6473     if id is pids
-0000b560: 2e47 4554 5f47 5241 443a 0a20 2020 2020  .GET_GRAD:.     
-0000b570: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b580: 7269 6d61 6c3a 204e 756d 6265 7220 7c20  rimal: Number | 
-0000b590: 5465 6e73 6f72 5072 6f78 790a 2020 2020  TensorProxy.    
-0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 2870 7269 6d61 6c2c 2920 3d20 6273 796d  (primal,) = bsym
-0000b5c0: 2e66 6c61 745f 6172 6773 0a20 2020 2020  .flat_args.     
-0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0000b5e0: 7261 643a 204e 756d 6265 7220 7c20 5465  rad: Number | Te
-0000b5f0: 6e73 6f72 5072 6f78 7920 3d20 6273 796d  nsorProxy = bsym
-0000b600: 2e6f 7574 7075 740a 0a20 2020 2020 2020  .output..       
-0000b610: 2020 2020 2020 2020 2020 2020 2076 7072               vpr
-0000b620: 696d 616c 3a20 5661 7269 6162 6c65 0a20  imal: Variable. 
-0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b640: 2020 2076 6772 6164 3a20 5661 7269 6162     vgrad: Variab
-0000b650: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-0000b660: 2020 2020 2020 2076 7072 696d 616c 2c20         vprimal, 
-0000b670: 7667 7261 6420 3d20 7661 7269 6162 6c65  vgrad = variable
-0000b680: 6966 7928 7072 696d 616c 292c 2076 6172  ify(primal), var
-0000b690: 6961 626c 6569 6679 2867 7261 6429 0a0a  iableify(grad)..
-0000b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6b0: 2020 2020 6163 7475 616c 5f67 7261 643a      actual_grad:
-0000b6c0: 204e 6f6e 6520 7c20 5465 6e73 6f72 5072   None | TensorPr
-0000b6d0: 6f78 7920 3d20 7072 696d 616c 735f 746f  oxy = primals_to
-0000b6e0: 5f67 696e 7075 745f 6d61 702e 6765 7428  _ginput_map.get(
-0000b6f0: 7670 7269 6d61 6c2c 204e 6f6e 6529 0a0a  vprimal, None)..
-0000b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b710: 2020 2020 2320 4e4f 5445 2049 6620 6163      # NOTE If ac
-0000b720: 7475 616c 5f67 7261 6420 6973 204e 6f6e  tual_grad is Non
-0000b730: 6520 7468 656e 2074 6865 7265 2773 2061  e then there's a
-0000b740: 2067 6574 5f67 7261 6428 2920 7265 7175   get_grad() requ
-0000b750: 6573 7420 666f 7220 6120 7465 6e73 6f72  est for a tensor
-0000b760: 2077 6869 6368 0a20 2020 2020 2020 2020   which.         
-0000b770: 2020 2020 2020 2020 2020 2023 2020 2068             #   h
-0000b780: 6173 206e 6f20 7075 745f 6772 6164 2829  as no put_grad()
-0000b790: 2c20 736f 2077 6520 7265 7475 726e 207a  , so we return z
-0000b7a0: 6572 6f73 2066 6f72 2074 6865 2067 7261  eros for the gra
-0000b7b0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000b7c0: 2020 2020 2020 2320 544f 444f 2052 6576        # TODO Rev
-0000b7d0: 6973 6974 2074 6869 7320 2d2d 2063 616e  isit this -- can
-0000b7e0: 2077 6520 7265 6d6f 7665 2074 6865 7365   we remove these
-0000b7f0: 2063 6f6d 7075 7461 7469 6f6e 732c 206f   computations, o
-0000b800: 7220 7573 6520 6120 7370 6563 6961 6c20  r use a special 
-0000b810: 5a65 726f 5465 6e73 6f72 0a20 2020 2020  ZeroTensor.     
-0000b820: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b830: 2020 2074 6f20 7369 6d70 6c69 6679 2074     to simplify t
-0000b840: 6865 6d3f 0a20 2020 2020 2020 2020 2020  hem?.           
-0000b850: 2020 2020 2020 2020 2069 6620 6163 7475           if actu
-0000b860: 616c 5f67 7261 6420 6973 204e 6f6e 653a  al_grad is None:
-0000b870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b880: 2020 2020 2020 2020 2061 6374 7561 6c5f           actual_
-0000b890: 6772 6164 203d 206c 746f 7263 682e 7a65  grad = ltorch.ze
-0000b8a0: 726f 735f 6c69 6b65 2870 7269 6d61 6c29  ros_like(primal)
-0000b8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b8c0: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
-0000b8d0: 5f74 6f5f 6769 6e70 7574 5f6d 6170 5b76  _to_ginput_map[v
-0000b8e0: 7072 696d 616c 5d20 3d20 6163 7475 616c  primal] = actual
-0000b8f0: 5f67 7261 640a 0a20 2020 2020 2020 2020  _grad..         
-0000b900: 2020 2020 2020 2020 2020 2023 2055 7064             # Upd
-0000b910: 6174 6573 2074 6865 2067 7261 6420 616c  ates the grad al
-0000b920: 6961 7320 6d61 700a 2020 2020 2020 2020  ias map.        
-0000b930: 2020 2020 2020 2020 2020 2020 7661 6374              vact
-0000b940: 7561 6c5f 6772 6164 3a20 5661 7269 6162  ual_grad: Variab
-0000b950: 6c65 203d 2076 6172 6961 626c 6569 6679  le = variableify
-0000b960: 2861 6374 7561 6c5f 6772 6164 290a 2020  (actual_grad).  
-0000b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b980: 2020 6966 2076 6163 7475 616c 5f67 7261    if vactual_gra
-0000b990: 6420 213d 2076 6772 6164 3a0a 2020 2020  d != vgrad:.    
-0000b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9b0: 2020 2020 7377 6170 6d61 705b 7667 7261      swapmap[vgra
-0000b9c0: 645d 203d 2061 6374 7561 6c5f 6772 6164  d] = actual_grad
-0000b9d0: 0a0a 2020 2020 2020 2020 6669 6e61 6c6c  ..        finall
-0000b9e0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
-0000b9f0: 2052 6573 746f 7265 7320 7363 6f70 650a   Restores scope.
-0000ba00: 2020 2020 2020 2020 2020 2020 7265 7365              rese
-0000ba10: 745f 7472 6163 6563 7478 2874 7261 6365  t_tracectx(trace
-0000ba20: 6374 785f 746f 6b29 0a0a 2020 2020 2020  ctx_tok)..      
-0000ba30: 2020 2320 4669 6c74 6572 7320 7075 745f    # Filters put_
-0000ba40: 6772 6164 2061 6e64 2067 6574 5f67 7261  grad and get_gra
-0000ba50: 6420 6f70 6572 6174 696f 6e73 2061 6e64  d operations and
-0000ba60: 2061 7070 6c69 6573 2074 6865 2073 7761   applies the swa
-0000ba70: 706d 6170 0a20 2020 2020 2020 2064 6566  pmap.        def
-0000ba80: 205f 6669 6c74 6572 2862 7379 6d3a 2042   _filter(bsym: B
-0000ba90: 6f75 6e64 5379 6d62 6f6c 2920 2d3e 2062  oundSymbol) -> b
-0000baa0: 6f6f 6c3a 0a20 2020 2020 2020 2020 2020  ool:.           
-0000bab0: 2069 643a 2048 6173 6861 626c 6520 3d20   id: Hashable = 
-0000bac0: 6273 796d 2e73 796d 2e69 640a 2020 2020  bsym.sym.id.    
-0000bad0: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-0000bae0: 6420 696e 2028 7069 6473 2e50 5554 5f47  d in (pids.PUT_G
-0000baf0: 5241 442c 2070 6964 732e 4745 545f 4752  RAD, pids.GET_GR
-0000bb00: 4144 290a 0a20 2020 2020 2020 2067 7261  AD)..        gra
-0000bb10: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
-0000bb20: 6c73 203d 205b 0a20 2020 2020 2020 2020  ls = [.         
-0000bb30: 2020 2062 7379 6d2e 6672 6f6d 5f62 7379     bsym.from_bsy
-0000bb40: 6d5f 7377 6170 5f70 726f 7869 6573 2873  m_swap_proxies(s
-0000bb50: 7761 706d 6170 2920 666f 7220 6273 796d  wapmap) for bsym
-0000bb60: 2069 6e20 6772 6164 7472 632e 626f 756e   in gradtrc.boun
-0000bb70: 645f 7379 6d62 6f6c 7320 6966 206e 6f74  d_symbols if not
-0000bb80: 205f 6669 6c74 6572 2862 7379 6d29 0a20   _filter(bsym). 
-0000bb90: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
-0000bba0: 2020 2320 5354 4550 2046 4f55 5220 2d2d    # STEP FOUR --
-0000bbb0: 2d20 4f72 6465 7273 2074 6865 206f 7065  - Orders the ope
-0000bbc0: 7261 7469 6f6e 730a 2020 2020 2020 2020  rations.        
-0000bbd0: 2320 544f 444f 2043 6f6e 7369 6465 7220  # TODO Consider 
-0000bbe0: 616c 7465 726e 6174 6976 6520 7363 6865  alternative sche
-0000bbf0: 6475 6c69 6e67 2061 6c67 6f72 6974 686d  duling algorithm
-0000bc00: 732c 206d 6179 6265 2062 7920 7573 696e  s, maybe by usin
-0000bc10: 6720 6772 6170 6820 6665 6174 7572 6573  g graph features
-0000bc20: 0a20 2020 2020 2020 2023 2020 2053 6f6d  .        #   Som
-0000bc30: 6520 6964 6561 7320 6172 6520 6c6f 6f6b  e ideas are look
-0000bc40: 696e 6720 6174 206d 656d 6f72 792d 7361  ing at memory-sa
-0000bc50: 7669 6e67 206e 6f64 6573 2c20 616e 6420  ving nodes, and 
-0000bc60: 6e6f 6465 7320 7769 7468 2061 2068 6967  nodes with a hig
-0000bc70: 6820 696e 2d64 6567 7265 6520 6f72 2068  h in-degree or h
-0000bc80: 6967 6820 6f75 742d 6465 6772 6565 0a0a  igh out-degree..
-0000bc90: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0000bca0: 7320 616e 2069 6e69 7469 616c 2076 616c  s an initial val
-0000bcb0: 6964 206f 7264 6572 696e 6720 746f 2044  id ordering to D
-0000bcc0: 4345 2c20 736f 2074 6861 7420 6164 6469  CE, so that addi
-0000bcd0: 7469 6f6e 616c 206f 7264 6572 696e 6720  tional ordering 
-0000bce0: 616e 616c 7973 6973 2064 6f65 736e 2774  analysis doesn't
-0000bcf0: 206e 6565 6420 746f 2063 6f6e 7369 6465   need to conside
-0000bd00: 7220 616c 6c20 7379 6d62 6f6c 730a 2020  r all symbols.  
-0000bd10: 2020 2020 2020 726f 6f74 732c 206c 6561        roots, lea
-0000bd20: 7665 7320 3d20 6273 796d 5f6c 6973 745f  ves = bsym_list_
-0000bd30: 746f 5f64 6167 2867 7261 6474 7263 2e62  to_dag(gradtrc.b
-0000bd40: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
-0000bd50: 2020 2020 2020 6f72 6465 7265 645f 6273        ordered_bs
-0000bd60: 796d 7320 3d20 746f 706f 736f 7274 5f62  yms = toposort_b
-0000bd70: 7379 6d5f 6461 6728 726f 6f74 732c 2054  sym_dag(roots, T
-0000bd80: 4f50 4f53 4f52 545f 4f52 4445 522e 544f  OPOSORT_ORDER.TO
-0000bd90: 505f 444f 574e 290a 2020 2020 2020 2020  P_DOWN).        
-0000bda0: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
-0000bdb0: 6d62 6f6c 7320 3d20 6f72 6465 7265 645f  mbols = ordered_
-0000bdc0: 6273 796d 730a 2020 2020 2020 2020 6772  bsyms.        gr
-0000bdd0: 6164 7472 6320 3d20 6463 6528 6772 6164  adtrc = dce(grad
-0000bde0: 7472 6329 0a0a 2020 2020 2020 2020 2320  trc)..        # 
-0000bdf0: 4964 656e 7469 6669 6573 2074 6865 206f  Identifies the o
-0000be00: 7264 6572 206f 6620 426f 756e 6453 796d  rder of BoundSym
-0000be10: 626f 6c73 2075 7369 6e67 2061 2022 4446  bols using a "DF
-0000be20: 5320 616e 6420 6368 6169 6e22 2061 6c67  S and chain" alg
-0000be30: 6f72 6974 686d 0a20 2020 2020 2020 2023  orithm.        #
-0000be40: 2054 4f44 4f20 456c 6162 6f72 6174 6520   TODO Elaborate 
-0000be50: 6f6e 2074 6869 7320 616c 676f 7269 7468  on this algorith
-0000be60: 6d20 616e 6420 7468 6520 696d 706c 656d  m and the implem
-0000be70: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
-0000be80: 2072 6f6f 7473 2c20 6c65 6176 6573 203d   roots, leaves =
-0000be90: 2062 7379 6d5f 6c69 7374 5f74 6f5f 6461   bsym_list_to_da
-0000bea0: 6728 6772 6164 7472 632e 626f 756e 645f  g(gradtrc.bound_
-0000beb0: 7379 6d62 6f6c 7329 0a20 2020 2020 2020  symbols).       
-0000bec0: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
-0000bed0: 2020 2020 6c65 6e28 6c65 6176 6573 2920      len(leaves) 
-0000bee0: 3d3d 2031 2c0a 2020 2020 2020 2020 2020  == 1,.          
-0000bef0: 2020 6c61 6d62 6461 3a20 6622 4578 7065    lambda: f"Expe
-0000bf00: 6374 6564 206f 6e6c 7920 6f6e 6520 6c65  cted only one le
-0000bf10: 6166 206e 6f64 6520 7768 656e 2073 6f72  af node when sor
-0000bf20: 7469 6e67 2066 6f72 2067 7261 642c 2066  ting for grad, f
-0000bf30: 6f75 6e64 2074 6865 7265 2077 6572 6520  ound there were 
-0000bf40: 7b6c 656e 286c 6561 7665 7329 7d20 6c65  {len(leaves)} le
-0000bf50: 6176 6573 222c 0a20 2020 2020 2020 2029  aves",.        )
-0000bf60: 0a20 2020 2020 2020 2028 6c65 6166 2c29  .        (leaf,)
-0000bf70: 203d 206c 6561 7665 730a 0a20 2020 2020   = leaves..     
-0000bf80: 2020 2023 2043 6f6d 7075 7465 7320 7468     # Computes th
-0000bf90: 6520 7465 6e73 6f72 206d 656d 6f72 7920  e tensor memory 
-0000bfa0: 7573 6564 2062 7920 7468 6520 6769 7665  used by the give
-0000bfb0: 6e20 7079 7472 6565 0a20 2020 2020 2020  n pytree.       
-0000bfc0: 2064 6566 206d 656d 6f72 795f 7573 6564   def memory_used
-0000bfd0: 2870 7974 7265 6529 202d 3e20 696e 743a  (pytree) -> int:
-0000bfe0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-0000bff0: 6f72 795f 7573 653a 2069 6e74 203d 2030  ory_use: int = 0
-0000c000: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
-0000c010: 6620 636f 756e 745f 6d65 6d6f 7279 5f75  f count_memory_u
-0000c020: 7365 2878 293a 0a20 2020 2020 2020 2020  se(x):.         
-0000c030: 2020 2020 2020 206e 6f6e 6c6f 6361 6c20         nonlocal 
-0000c040: 6d65 6d6f 7279 5f75 7365 0a20 2020 2020  memory_use.     
-0000c050: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0000c060: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
-0000c070: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
-0000c080: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0000c090: 6d6f 7279 5f75 7365 202b 3d20 782e 6474  mory_use += x.dt
-0000c0a0: 7970 652e 5f62 7974 6573 202a 2078 2e6e  ype._bytes * x.n
-0000c0b0: 756d 656c 0a0a 2020 2020 2020 2020 2020  umel..          
-0000c0c0: 2020 7472 6565 5f6d 6170 2863 6f75 6e74    tree_map(count
-0000c0d0: 5f6d 656d 6f72 795f 7573 652c 2070 7974  _memory_use, pyt
-0000c0e0: 7265 6529 0a20 2020 2020 2020 2020 2020  ree).           
-0000c0f0: 2072 6574 7572 6e20 6d65 6d6f 7279 5f75   return memory_u
-0000c100: 7365 0a0a 2020 2020 2020 2020 2320 5472  se..        # Tr
-0000c110: 7565 2077 6865 6e20 6120 6e6f 6465 2069  ue when a node i
-0000c120: 7320 6120 226c 696e 6b22 202d 2d20 6120  s a "link" -- a 
-0000c130: 6e6f 6465 2077 6974 6820 6f6e 6c79 206f  node with only o
-0000c140: 6e65 2063 6869 6c64 2061 6e64 2061 7420  ne child and at 
-0000c150: 6d6f 7374 206f 6e65 2070 6172 656e 740a  most one parent.
-0000c160: 2020 2020 2020 2020 2320 2020 436f 6e63          #   Conc
-0000c170: 6570 7475 616c 6c79 2074 6865 206e 6f64  eptually the nod
-0000c180: 6520 6973 2061 2022 6c69 6e6b 2220 696e  e is a "link" in
-0000c190: 2061 2063 6861 696e 206f 6620 6e6f 6465   a chain of node
-0000c1a0: 7320 6c69 6b65 2041 202d 3e20 4220 2d3e  s like A -> B ->
-0000c1b0: 2043 0a20 2020 2020 2020 2064 6566 2069   C.        def i
-0000c1c0: 735f 6c69 6e6b 286e 3a20 4e6f 6465 2920  s_link(n: Node) 
-0000c1d0: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-0000c1e0: 2020 2020 205f 6973 5f6c 696e 6b20 3d20       _is_link = 
-0000c1f0: 6c65 6e28 6e2e 6368 696c 6472 656e 2920  len(n.children) 
-0000c200: 3d3d 2031 2061 6e64 206c 656e 286e 2e70  == 1 and len(n.p
-0000c210: 6172 656e 7473 2920 3c3d 2031 0a20 2020  arents) <= 1.   
-0000c220: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c230: 5f69 735f 6c69 6e6b 0a0a 2020 2020 2020  _is_link..      
-0000c240: 2020 636f 756e 7465 723a 2069 6e74 203d    counter: int =
-0000c250: 2030 0a0a 2020 2020 2020 2020 6465 6620   0..        def 
-0000c260: 5f63 6861 696e 2863 3a20 6c69 7374 5b4e  _chain(c: list[N
-0000c270: 6f64 655d 2c20 656e 643a 204e 6f64 6529  ode], end: Node)
-0000c280: 202d 3e20 6c69 7374 5b4e 6f64 655d 3a0a   -> list[Node]:.
-0000c290: 2020 2020 2020 2020 2020 2020 6e6f 6e6c              nonl
-0000c2a0: 6f63 616c 2063 6f75 6e74 6572 0a0a 2020  ocal counter..  
-0000c2b0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-0000c2c0: 2045 7870 6572 696d 656e 7420 7769 7468   Experiment with
-0000c2d0: 206e 6f74 2061 6c77 6179 7320 6675 7369   not always fusi
-0000c2e0: 6e67 2074 6869 7320 696e 746f 2074 6865  ng this into the
-0000c2f0: 2063 6f6e 7375 6d65 7220 2d2d 2074 6865   consumer -- the
-0000c300: 7265 2063 6f75 6c64 2062 6520 616e 0a20  re could be an. 
-0000c310: 2020 2020 2020 2020 2020 2023 2020 2069             #   i
-0000c320: 6e74 6572 6573 7469 6e67 206d 696e 6375  nteresting mincu
-0000c330: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0000c340: 4e4f 5445 2049 6e20 7468 6973 2063 6173  NOTE In this cas
-0000c350: 6520 7468 6520 6368 6169 6e20 6361 6e6e  e the chain cann
-0000c360: 6f74 2062 6520 6578 7465 6e64 6564 2c20  ot be extended, 
-0000c370: 616e 6420 6974 7320 6f72 6967 696e 2069  and its origin i
-0000c380: 7320 696e 7075 7420 746f 2074 6865 2066  s input to the f
-0000c390: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
-0000c3a0: 2020 2020 2320 2020 736f 2074 6869 7320      #   so this 
-0000c3b0: 6a75 7374 2066 7573 6573 2069 7420 696e  just fuses it in
-0000c3c0: 746f 2074 6865 2063 6f6e 7375 6d65 720a  to the consumer.
-0000c3d0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0000c3e0: 656e 2865 6e64 2e70 6172 656e 7473 2920  en(end.parents) 
-0000c3f0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0000c400: 2020 2020 2020 666f 7220 6e20 696e 2063        for n in c
-0000c410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c420: 2020 2020 2020 6e2e 6e75 6d62 6572 203d        n.number =
-0000c430: 2063 6f75 6e74 6572 0a20 2020 2020 2020   counter.       
-0000c440: 2020 2020 2020 2020 2020 2020 2063 6f75               cou
-0000c450: 6e74 6572 202b 3d20 310a 2020 2020 2020  nter += 1.      
-0000c460: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000c470: 205b 5d0a 0a20 2020 2020 2020 2020 2020   []..           
-0000c480: 2023 204e 4f54 4520 6c65 6e28 656e 642e   # NOTE len(end.
-0000c490: 7061 7265 6e74 7329 203d 3d20 3120 6f6e  parents) == 1 on
-0000c4a0: 2074 6869 7320 7061 7468 0a20 2020 2020   this path.     
-0000c4b0: 2020 2020 2020 2028 7061 7265 6e74 2c29         (parent,)
-0000c4c0: 203d 2065 6e64 2e70 6172 656e 7473 0a0a   = end.parents..
-0000c4d0: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
-0000c4e0: 7465 6e64 7320 7468 6520 6368 6169 6e20  tends the chain 
-0000c4f0: 6966 2074 6865 2070 6172 656e 7420 6973  if the parent is
-0000c500: 2061 206c 696e 6b0a 2020 2020 2020 2020   a link.        
-0000c510: 2020 2020 6966 2069 735f 6c69 6e6b 2870      if is_link(p
-0000c520: 6172 656e 7429 3a0a 2020 2020 2020 2020  arent):.        
-0000c530: 2020 2020 2020 2020 632e 6170 7065 6e64          c.append
-0000c540: 2870 6172 656e 7429 0a20 2020 2020 2020  (parent).       
-0000c550: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c560: 5f63 6861 696e 2863 2c20 7061 7265 6e74  _chain(c, parent
-0000c570: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0000c580: 204e 4f54 4520 496e 2074 6869 7320 6361   NOTE In this ca
-0000c590: 7365 2074 6865 2063 6861 696e 2068 6173  se the chain has
-0000c5a0: 2061 2070 6172 656e 7420 7468 6174 2069   a parent that i
-0000c5b0: 7320 6e6f 7420 6120 6c69 6e6b 0a20 2020  s not a link.   
-0000c5c0: 2020 2020 2020 2020 2023 2046 696e 6473           # Finds
-0000c5d0: 2074 6865 206d 696e 6375 740a 2020 2020   the mincut.    
-0000c5e0: 2020 2020 2020 2020 6d69 6e63 7574 5f69          mincut_i
-0000c5f0: 6478 3a20 696e 7420 3d20 6c65 6e28 6329  dx: int = len(c)
-0000c600: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
-0000c610: 5f6d 656d 6f72 795f 7573 6167 653a 2069  _memory_usage: i
-0000c620: 6e74 203d 206d 656d 6f72 795f 7573 6564  nt = memory_used
-0000c630: 2870 6172 656e 742e 6273 796d 2e6f 7574  (parent.bsym.out
-0000c640: 7075 7429 0a0a 2020 2020 2020 2020 2020  put)..          
-0000c650: 2020 666f 7220 6964 782c 206e 2069 6e20    for idx, n in 
-0000c660: 656e 756d 6572 6174 6528 6329 3a0a 2020  enumerate(c):.  
-0000c670: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0000c680: 6d20 3d20 6d65 6d6f 7279 5f75 7365 6428  m = memory_used(
-0000c690: 6e2e 6273 796d 2e6f 7574 7075 7429 0a20  n.bsym.output). 
-0000c6a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000c6b0: 6620 6d65 6d20 3c20 6d69 6e5f 6d65 6d6f  f mem < min_memo
-0000c6c0: 7279 5f75 7361 6765 3a0a 2020 2020 2020  ry_usage:.      
-0000c6d0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-0000c6e0: 6e63 7574 5f69 6478 203d 2069 6478 0a20  ncut_idx = idx. 
-0000c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c700: 2020 206d 696e 5f6d 656d 6f72 795f 7573     min_memory_us
-0000c710: 6167 6520 3d20 6d65 6d0a 0a20 2020 2020  age = mem..     
-0000c720: 2020 2020 2020 2066 6f72 2069 6478 2c20         for idx, 
-0000c730: 6e20 696e 2065 6e75 6d65 7261 7465 2863  n in enumerate(c
-0000c740: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c750: 2020 2069 6620 6964 7820 3c20 6d69 6e63     if idx < minc
-0000c760: 7574 5f69 6478 3a0a 2020 2020 2020 2020  ut_idx:.        
-0000c770: 2020 2020 2020 2020 2020 2020 6e2e 6e75              n.nu
-0000c780: 6d62 6572 203d 2063 6f75 6e74 6572 0a20  mber = counter. 
-0000c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c7a0: 2020 2063 6f75 6e74 6572 202b 3d20 310a     counter += 1.
-0000c7b0: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-0000c7c0: 6574 7572 6e73 2074 6865 2070 726f 6475  eturns the produ
-0000c7d0: 6365 722d 7369 6465 2063 6861 696e 2063  cer-side chain c
-0000c7e0: 7574 2069 6620 6974 2065 7869 7374 730a  ut if it exists.
-0000c7f0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-0000c800: 696e 6375 745f 6964 7820 3c20 6c65 6e28  incut_idx < len(
-0000c810: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
-0000c820: 2020 2020 7265 7475 726e 205b 635b 6d69      return [c[mi
-0000c830: 6e63 7574 5f69 6478 5d5d 0a20 2020 2020  ncut_idx]].     
-0000c840: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000c850: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0000c860: 6572 7420 6d69 6e63 7574 5f69 6478 203d  ert mincut_idx =
-0000c870: 3d20 6c65 6e28 6329 0a20 2020 2020 2020  = len(c).       
-0000c880: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c890: 656e 642e 7061 7265 6e74 730a 0a20 2020  end.parents..   
-0000c8a0: 2020 2020 2064 6566 2063 6861 696e 5f6f       def chain_o
-0000c8b0: 7574 286e 3a20 4e6f 6465 2c20 7374 6163  ut(n: Node, stac
-0000c8c0: 6b3a 206c 6973 745b 4e6f 6465 5d29 202d  k: list[Node]) -
-0000c8d0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000c8e0: 2020 2020 2320 5368 6f72 742d 6369 7263      # Short-circ
-0000c8f0: 7569 7473 2069 6620 7468 6520 6f72 6967  uits if the orig
-0000c900: 696e 616c 206e 6f64 6520 6e20 6361 6e6e  inal node n cann
-0000c910: 6f74 2062 6520 7061 7274 206f 6620 6120  ot be part of a 
-0000c920: 6368 6169 6e0a 2020 2020 2020 2020 2020  chain.          
-0000c930: 2020 6966 206e 6f74 2069 735f 6c69 6e6b    if not is_link
-0000c940: 286e 293a 0a20 2020 2020 2020 2020 2020  (n):.           
-0000c950: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
-0000c960: 6428 6e29 0a20 2020 2020 2020 2020 2020  d(n).           
-0000c970: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0000c980: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
-0000c990: 6973 5f6c 696e 6b28 6e29 203d 3d20 5472  is_link(n) == Tr
-0000c9a0: 7565 0a20 2020 2020 2020 2020 2020 2070  ue.            p
-0000c9b0: 6f73 745f 6368 6169 6e3a 206c 6973 745b  ost_chain: list[
-0000c9c0: 4e6f 6465 5d20 3d20 5f63 6861 696e 285b  Node] = _chain([
-0000c9d0: 6e5d 2c20 6e29 0a0a 2020 2020 2020 2020  n], n)..        
-0000c9e0: 2020 2020 666f 7220 7063 2069 6e20 706f      for pc in po
-0000c9f0: 7374 5f63 6861 696e 3a0a 2020 2020 2020  st_chain:.      
-0000ca00: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
-0000ca10: 6170 7065 6e64 2870 6329 0a0a 2020 2020  append(pc)..    
-0000ca20: 2020 2020 7374 6163 6b3a 206c 6973 745b      stack: list[
-0000ca30: 4e6f 6465 5d20 3d20 5b6c 6561 665d 0a20  Node] = [leaf]. 
-0000ca40: 2020 2020 2020 2077 6869 6c65 206c 656e         while len
-0000ca50: 2873 7461 636b 2920 3e20 303a 0a20 2020  (stack) > 0:.   
-0000ca60: 2020 2020 2020 2020 206e 3a20 4e6f 6465           n: Node
-0000ca70: 203d 2073 7461 636b 2e70 6f70 2829 0a0a   = stack.pop()..
-0000ca80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000ca90: 2e6e 756d 6265 7220 6973 206e 6f74 204e  .number is not N
-0000caa0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000cab0: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-0000cac0: 2020 2020 2020 2020 2020 206e 2e6e 756d             n.num
-0000cad0: 6265 7220 3d20 636f 756e 7465 720a 2020  ber = counter.  
-0000cae0: 2020 2020 2020 2020 2020 636f 756e 7465            counte
-0000caf0: 7220 2b3d 2031 0a0a 2020 2020 2020 2020  r += 1..        
-0000cb00: 2020 2020 666f 7220 7020 696e 206e 2e70      for p in n.p
-0000cb10: 6172 656e 7473 3a0a 2020 2020 2020 2020  arents:.        
-0000cb20: 2020 2020 2020 2020 6368 6169 6e5f 6f75          chain_ou
-0000cb30: 7428 702c 2073 7461 636b 290a 0a20 2020  t(p, stack)..   
-0000cb40: 2020 2020 2064 6566 205f 7365 6c65 6374       def _select
-0000cb50: 6f72 2865 6c69 6769 626c 655f 6e6f 6465  or(eligible_node
-0000cb60: 733a 206c 6973 745b 4e6f 6465 5d29 202d  s: list[Node]) -
-0000cb70: 3e20 696e 743a 0a20 2020 2020 2020 2020  > int:.         
-0000cb80: 2020 206d 696e 5f69 6478 3a20 696e 7420     min_idx: int 
-0000cb90: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-0000cba0: 6d69 6e5f 6e75 6d62 6572 3a20 696e 7420  min_number: int 
-0000cbb0: 3d20 656c 6967 6962 6c65 5f6e 6f64 6573  = eligible_nodes
-0000cbc0: 5b30 5d2e 6e75 6d62 6572 0a0a 2020 2020  [0].number..    
-0000cbd0: 2020 2020 2020 2020 2320 4e4f 5445 2041          # NOTE A
-0000cbe0: 6c74 686f 7567 6820 7765 2776 6520 616c  lthough we've al
-0000cbf0: 7265 6164 7920 7072 6f63 6573 7365 6420  ready processed 
-0000cc00: 7468 6520 6669 7273 7420 656c 656d 656e  the first elemen
-0000cc10: 7420 6865 7265 2c20 7468 6973 2073 7469  t here, this sti
-0000cc20: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
-0000cc30: 2020 2065 6e75 6d65 7261 7465 7320 7468     enumerates th
-0000cc40: 6520 656e 7469 7265 206c 6973 7420 6320  e entire list c 
-0000cc50: 746f 2061 6c69 676e 2074 6865 2065 6e75  to align the enu
-0000cc60: 6d65 7261 7469 6f6e 2069 6478 2070 726f  meration idx pro
-0000cc70: 7065 726c 790a 2020 2020 2020 2020 2020  perly.          
-0000cc80: 2020 666f 7220 6964 782c 206e 2069 6e20    for idx, n in 
-0000cc90: 656e 756d 6572 6174 6528 656c 6967 6962  enumerate(eligib
-0000cca0: 6c65 5f6e 6f64 6573 293a 0a20 2020 2020  le_nodes):.     
-0000ccb0: 2020 2020 2020 2020 2020 2063 6865 636b             check
-0000ccc0: 286e 2e6e 756d 6265 7220 6973 206e 6f74  (n.number is not
-0000ccd0: 204e 6f6e 652c 206c 616d 6264 613a 2066   None, lambda: f
-0000cce0: 2245 7870 6563 7465 6420 6561 6368 206e  "Expected each n
-0000ccf0: 6f64 6520 746f 2062 6520 6e75 6d62 6572  ode to be number
-0000cd00: 6564 2c20 6275 7420 7b6e 7d20 7761 7320  ed, but {n} was 
-0000cd10: 6e6f 7422 290a 0a20 2020 2020 2020 2020  not")..         
-0000cd20: 2020 2020 2020 2069 6620 6e2e 6e75 6d62         if n.numb
-0000cd30: 6572 203c 206d 696e 5f6e 756d 6265 723a  er < min_number:
-0000cd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cd50: 2020 2020 206d 696e 5f69 6478 203d 2069       min_idx = i
-0000cd60: 6478 0a20 2020 2020 2020 2020 2020 2020  dx.             
-0000cd70: 2020 2020 2020 206d 696e 5f6e 756d 6265         min_numbe
-0000cd80: 7220 3d20 6e2e 6e75 6d62 6572 0a0a 2020  r = n.number..  
-0000cd90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000cda0: 206d 696e 5f69 6478 0a0a 2020 2020 2020   min_idx..      
-0000cdb0: 2020 736f 7274 6564 5f62 7379 6d73 203d    sorted_bsyms =
-0000cdc0: 2074 6f70 6f73 6f72 745f 6273 796d 5f64   toposort_bsym_d
-0000cdd0: 6167 286c 6561 7665 732c 2074 6f70 6f73  ag(leaves, topos
-0000cde0: 6f72 745f 6f72 6465 723d 544f 504f 534f  ort_order=TOPOSO
-0000cdf0: 5254 5f4f 5244 4552 2e42 4f54 544f 4d5f  RT_ORDER.BOTTOM_
-0000ce00: 5550 2c20 7365 6c65 6374 6f72 3d5f 7365  UP, selector=_se
-0000ce10: 6c65 6374 6f72 290a 2020 2020 2020 2020  lector).        
-0000ce20: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
-0000ce30: 6d62 6f6c 7320 3d20 736f 7274 6564 5f62  mbols = sorted_b
-0000ce40: 7379 6d73 0a20 2020 2020 2020 2067 7261  syms.        gra
-0000ce50: 6474 7263 203d 2064 6365 2867 7261 6474  dtrc = dce(gradt
-0000ce60: 7263 290a 0a20 2020 2020 2020 2023 2054  rc)..        # T
-0000ce70: 4f44 4f20 436f 6e73 6964 6572 2068 6f77  ODO Consider how
-0000ce80: 2074 6f20 6861 6e64 6c65 2067 7261 6420   to handle grad 
-0000ce90: 772e 722e 742e 206f 6e6c 7920 736f 6d65  w.r.t. only some
-0000cea0: 206f 7574 7075 7473 202d 2d20 7368 6f75   outputs -- shou
-0000ceb0: 6c64 2061 6c6c 2067 7261 640a 2020 2020  ld all grad.    
-0000cec0: 2020 2020 2320 2020 6f70 6572 6174 696f      #   operatio
-0000ced0: 6e73 2075 7369 6e67 2074 6865 206f 7468  ns using the oth
-0000cee0: 6572 206f 7574 7075 7420 6265 2072 656d  er output be rem
-0000cef0: 6f76 6564 3f20 5768 6174 206b 696e 6420  oved? What kind 
-0000cf00: 6f66 2061 7373 756d 7074 696f 6e20 646f  of assumption do
-0000cf10: 6573 2074 6861 740a 2020 2020 2020 2020  es that.        
-0000cf20: 2320 2020 6d61 6b65 2061 626f 7574 2074  #   make about t
-0000cf30: 6865 2067 7261 6420 7374 7275 6374 7572  he grad structur
-0000cf40: 653f 2050 726f 6261 626c 7920 736f 6d65  e? Probably some
-0000cf50: 206b 696e 6420 6f66 2069 6e64 6570 656e   kind of indepen
-0000cf60: 6465 6e63 6520 6173 7375 6d70 7469 6f6e  dence assumption
-0000cf70: 3f20 4172 650a 2020 2020 2020 2020 2320  ? Are.        # 
-0000cf80: 2020 7468 6572 6520 7072 6163 7469 6361    there practica
-0000cf90: 6c20 6578 616d 706c 6573 2077 6865 7265  l examples where
-0000cfa0: 2074 6861 7427 7320 616e 2069 7373 7565   that's an issue
-0000cfb0: 3f0a 0a20 2020 2020 2020 2065 6e64 5f74  ?..        end_t
-0000cfc0: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
-0000cfd0: 6d65 5f6e 7328 290a 2020 2020 2020 2020  me_ns().        
-0000cfe0: 656c 6170 7365 645f 7469 6d65 5f6e 7320  elapsed_time_ns 
-0000cff0: 3d20 656e 645f 7469 6d65 5f6e 7320 2d20  = end_time_ns - 
-0000d000: 7374 6172 745f 7469 6d65 5f6e 730a 2020  start_time_ns.  
-0000d010: 2020 2020 2020 656c 6170 7365 645f 7469        elapsed_ti
-0000d020: 6d65 5f6d 696c 6c69 7320 3d20 656c 6170  me_millis = elap
-0000d030: 7365 645f 7469 6d65 5f6e 7320 2f2f 2031  sed_time_ns // 1
-0000d040: 3030 3030 3030 0a20 2020 2020 2020 2067  000000.        g
-0000d050: 7261 6474 7263 2e73 6574 5f70 726f 7665  radtrc.set_prove
-0000d060: 6e61 6e63 6528 5472 6163 6550 726f 7665  nance(TraceProve
-0000d070: 6e61 6e63 6528 6622 4772 6164 2028 746f  nance(f"Grad (to
-0000d080: 6f6b 207b 656c 6170 7365 645f 7469 6d65  ok {elapsed_time
-0000d090: 5f6d 696c 6c69 737d 206d 696c 6c69 7365  _millis} millise
-0000d0a0: 636f 6e64 7329 2229 290a 0a20 2020 2020  conds)"))..     
-0000d0b0: 2020 2072 6574 7572 6e20 6772 6164 7472     return gradtr
-0000d0c0: 630a 0a20 2020 2023 204e 4f54 4520 5468  c..    # NOTE Th
-0000d0d0: 6973 2069 7320 6120 6b6c 7564 6765 2074  is is a kludge t
-0000d0e0: 6f20 696e 6469 6361 7465 2074 6861 7420  o indicate that 
-0000d0f0: 7765 2073 686f 756c 646e 2774 2075 7365  we shouldn't use
-0000d100: 2050 7954 6f72 6368 2773 2061 7574 6f67   PyTorch's autog
-0000d110: 7261 6420 6265 6361 7573 650a 2020 2020  rad because.    
-0000d120: 2320 2020 7765 2772 6520 7573 696e 6720  #   we're using 
-0000d130: 6f75 7220 6f77 6e20 6175 746f 6772 6164  our own autograd
-0000d140: 2074 7261 6e73 666f 726d 0a20 2020 2063   transform.    c
-0000d150: 666e 2e5f 7573 696e 675f 6772 6164 5f74  fn._using_grad_t
-0000d160: 7261 6e73 666f 726d 203d 2054 7275 650a  ransform = True.
-0000d170: 0a20 2020 2072 6574 7572 6e20 6164 645f  .    return add_
-0000d180: 7472 616e 7366 6f72 6d28 6366 6e2c 205f  transform(cfn, _
-0000d190: 6772 6164 5f74 7261 6e73 666f 726d 290a  grad_transform).
-0000d1a0: 0a0a 6465 6620 6772 6164 5f76 3128 0a20  ..def grad_v1(. 
-0000d1b0: 2020 2063 666e 2c0a 2920 2d3e 2043 616c     cfn,.) -> Cal
-0000d1c0: 6c61 626c 653a 0a20 2020 2064 6566 2067  lable:.    def g
-0000d1d0: 7261 6428 6675 6e63 293a 0a20 2020 2020  rad(func):.     
-0000d1e0: 2020 2064 6566 2067 7261 645f 6675 6e63     def grad_func
-0000d1f0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-0000d200: 293a 0a20 2020 2020 2020 2020 2020 205f  ):.            _
-0000d210: 2c20 6772 6164 7320 3d20 7661 6c75 655f  , grads = value_
-0000d220: 616e 645f 6772 6164 2866 756e 6329 282a  and_grad(func)(*
-0000d230: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
-0000d240: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-0000d250: 7320 3d20 5b67 2066 6f72 2067 2069 6e20  s = [g for g in 
-0000d260: 6772 6164 7320 6966 2067 2069 7320 6e6f  grads if g is no
-0000d270: 7420 4e6f 6e65 5d0a 2020 2020 2020 2020  t None].        
-0000d280: 2020 2020 7265 7475 726e 2067 7261 6473      return grads
-0000d290: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000d2a0: 2067 7261 645f 6675 6e63 0a0a 2020 2020   grad_func..    
-0000d2b0: 6465 6620 5f67 7261 645f 7472 616e 7366  def _grad_transf
-0000d2c0: 6f72 6d28 7472 633a 2054 7261 6365 2c20  orm(trc: Trace, 
-0000d2d0: 2a2c 2065 7865 6375 746f 7273 5f6c 6973  *, executors_lis
-0000d2e0: 743a 2053 6571 7565 6e63 655b 416e 795d  t: Sequence[Any]
-0000d2f0: 2920 2d3e 2054 7261 6365 3a0a 2020 2020  ) -> Trace:.    
-0000d300: 2020 2020 6772 6164 7472 6320 3d20 636f      gradtrc = co
-0000d310: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
-0000d320: 6772 6164 2874 7263 2e70 7974 686f 6e5f  grad(trc.python_
-0000d330: 6361 6c6c 6162 6c65 2829 292c 202a 7472  callable()), *tr
-0000d340: 632e 6172 6773 2c20 2a2a 7472 632e 6b77  c.args, **trc.kw
-0000d350: 6172 6773 290a 2020 2020 2020 2020 7265  args).        re
-0000d360: 7475 726e 2067 7261 6474 7263 0a0a 2020  turn gradtrc..  
-0000d370: 2020 6366 6e2e 5f75 7369 6e67 5f67 7261    cfn._using_gra
-0000d380: 645f 7472 616e 7366 6f72 6d20 3d20 5472  d_transform = Tr
-0000d390: 7565 0a20 2020 2072 6574 7572 6e20 6164  ue.    return ad
-0000d3a0: 645f 7472 616e 7366 6f72 6d28 6366 6e2c  d_transform(cfn,
-0000d3b0: 205f 6772 6164 5f74 7261 6e73 666f 726d   _grad_transform
-0000d3c0: 290a 0a0a 636c 6173 7320 5472 616e 7366  )...class Transf
-0000d3d0: 6f72 6d73 2845 6e75 6d29 3a0a 2020 2020  orms(Enum):.    
-0000d3e0: 4964 656e 7469 7479 4f70 203d 2061 7574  IdentityOp = aut
-0000d3f0: 6f28 290a 2020 2020 566d 6170 4f70 203d  o().    VmapOp =
-0000d400: 2061 7574 6f28 290a 2020 2020 4a76 704f   auto().    JvpO
-0000d410: 7020 3d20 6175 746f 2829 0a20 2020 2056  p = auto().    V
-0000d420: 6a70 4f70 203d 2061 7574 6f28 290a 0a0a  jpOp = auto()...
-0000d430: 406c 7275 5f63 6163 6865 286d 6178 7369  @lru_cache(maxsi
-0000d440: 7a65 3d4e 6f6e 6529 0a64 6566 2073 796d  ze=None).def sym
-0000d450: 626f 6c5f 746f 5f65 7661 6c28 626f 756e  bol_to_eval(boun
-0000d460: 645f 7379 6d62 6f6c 293a 0a20 2020 2022  d_symbol):.    "
-0000d470: 2222 4d61 7020 6120 426f 756e 6453 796d  ""Map a BoundSym
-0000d480: 626f 6c20 746f 2061 2066 756e 6374 696f  bol to a functio
-0000d490: 6e20 7468 6174 2065 7661 6c75 6174 6573  n that evaluates
-0000d4a0: 2069 742e 0a0a 2020 2020 4172 6773 3a0a   it...    Args:.
-0000d4b0: 2020 2020 2020 2020 626f 756e 645f 7379          bound_sy
-0000d4c0: 6d62 6f6c 3a20 426f 756e 6453 796d 626f  mbol: BoundSymbo
-0000d4d0: 6c20 746f 206d 6170 0a20 2020 2022 2222  l to map.    """
-0000d4e0: 0a20 2020 2023 2053 796d 626f 6c20 6973  .    # Symbol is
-0000d4f0: 2063 616c 6c61 626c 650a 2020 2020 7265   callable.    re
-0000d500: 7475 726e 2062 6f75 6e64 5f73 796d 626f  turn bound_symbo
-0000d510: 6c2e 7379 6d0a 0a0a 2320 544f 444f 3a20  l.sym...# TODO: 
-0000d520: 4375 7272 656e 746c 7920 7765 2075 7365  Currently we use
-0000d530: 2074 7261 6365 2e61 7267 7320 616e 6420   trace.args and 
-0000d540: 7472 6163 652e 6b77 6172 6773 2074 6f20  trace.kwargs to 
-0000d550: 6765 7420 7468 6520 6172 6775 6d65 6e74  get the argument
-0000d560: 730a 2320 4d61 7962 6520 7765 2073 686f  s.# Maybe we sho
-0000d570: 756c 6420 7573 6520 7468 6573 6520 696e  uld use these in
-0000d580: 7374 6561 640a 7472 616e 7366 6f72 6d5f  stead.transform_
-0000d590: 736b 6970 5f6c 6973 7420 3d20 280a 2020  skip_list = (.  
-0000d5a0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-0000d5b0: 554e 5041 434b 5f45 4d50 5459 5f44 4943  UNPACK_EMPTY_DIC
-0000d5c0: 542c 0a20 2020 2070 7269 6d73 2e50 7269  T,.    prims.Pri
-0000d5d0: 6d49 4473 2e55 4e50 4143 4b5f 4b45 592c  mIDs.UNPACK_KEY,
-0000d5e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-0000d5f0: 4473 2e55 4e50 4143 4b5f 5345 5155 454e  Ds.UNPACK_SEQUEN
-0000d600: 4345 2c0a 2020 2020 7072 696d 732e 5072  CE,.    prims.Pr
-0000d610: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
-0000d620: 5649 414c 2c0a 2020 2020 7072 696d 732e  VIAL,.    prims.
-0000d630: 5072 696d 4944 732e 5245 5455 524e 2c0a  PrimIDs.RETURN,.
-0000d640: 290a 0a0a 6465 6620 6576 616c 5f74 7261  )...def eval_tra
-0000d650: 6365 2874 7261 6365 2c20 2a61 7267 732c  ce(trace, *args,
-0000d660: 2073 796d 626f 6c5f 6d61 7070 6572 3d73   symbol_mapper=s
-0000d670: 796d 626f 6c5f 746f 5f65 7661 6c2c 2077  ymbol_to_eval, w
-0000d680: 6974 685f 656e 763d 4661 6c73 652c 202a  ith_env=False, *
-0000d690: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-0000d6a0: 2245 7661 6c75 6174 6520 6120 7472 6163  "Evaluate a trac
-0000d6b0: 652e 0a0a 2020 2020 4172 6773 3a0a 2020  e...    Args:.  
-0000d6c0: 2020 2020 2020 7472 6163 653a 2074 7261        trace: tra
-0000d6d0: 6365 2074 6f20 6576 616c 7561 7465 0a20  ce to evaluate. 
-0000d6e0: 2020 2020 2020 202a 6172 6773 3a20 6172         *args: ar
-0000d6f0: 6775 6d65 6e74 7320 746f 2065 7661 6c75  guments to evalu
-0000d700: 6174 6520 7468 6520 7472 6163 6520 7769  ate the trace wi
-0000d710: 7468 0a20 2020 2020 2020 2073 796d 626f  th.        symbo
-0000d720: 6c5f 6d61 7070 6572 3a20 6675 6e63 7469  l_mapper: functi
-0000d730: 6f6e 2074 6861 7420 6d61 7073 2061 2073  on that maps a s
-0000d740: 796d 626f 6c20 746f 2061 2066 756e 6374  ymbol to a funct
-0000d750: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
-0000d760: 6573 2069 740a 2020 2020 2020 2020 2a2a  es it.        **
-0000d770: 6b77 6172 6773 3a20 6b65 7977 6f72 6420  kwargs: keyword 
-0000d780: 6172 6775 6d65 6e74 7320 746f 2065 7661  arguments to eva
-0000d790: 6c75 6174 6520 7468 6520 7472 6163 6520  luate the trace 
-0000d7a0: 7769 7468 0a0a 2020 2020 5265 7475 726e  with..    Return
-0000d7b0: 733a 0a20 2020 2020 2020 2072 6573 756c  s:.        resul
-0000d7c0: 7420 6f66 2065 7661 6c75 6174 696e 6720  t of evaluating 
-0000d7d0: 7468 6520 7472 6163 650a 2020 2020 2222  the trace.    ""
-0000d7e0: 220a 2020 2020 656e 7620 3d20 7b7d 0a0a  ".    env = {}..
-0000d7f0: 2020 2020 6465 6620 7265 6164 2878 3a20      def read(x: 
-0000d800: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
-0000d810: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000d820: 2878 2c20 5661 7269 6162 6c65 293a 0a20  (x, Variable):. 
-0000d830: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d840: 6e20 656e 765b 782e 6e61 6d65 5d0a 2020  n env[x.name].  
-0000d850: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000d860: 2020 2020 2020 2020 7265 7475 726e 2078          return x
-0000d870: 0a0a 2020 2020 6465 6620 7772 6974 6528  ..    def write(
-0000d880: 763a 2056 6172 6961 626c 652c 2076 616c  v: Variable, val
-0000d890: 3a20 416e 792c 2061 6c6c 6f77 5f64 7570  : Any, allow_dup
-0000d8a0: 6c69 6361 7465 733d 4661 6c73 6529 202d  licates=False) -
-0000d8b0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000d8c0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-0000d8d0: 6528 762c 2056 6172 6961 626c 6529 3a0a  e(v, Variable):.
-0000d8e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000d8f0: 726e 0a20 2020 2020 2020 2023 2044 7570  rn.        # Dup
-0000d900: 6c69 6361 7465 7320 6172 6520 616c 6c6f  licates are allo
-0000d910: 7765 6420 616e 6420 6f76 6572 7772 6974  wed and overwrit
-0000d920: 7465 6e0a 2020 2020 2020 2020 6966 2076  ten.        if v
-0000d930: 2e6e 616d 6520 696e 2065 6e76 3a0a 2020  .name in env:.  
-0000d940: 2020 2020 2020 2020 2020 6966 2061 6c6c            if all
-0000d950: 6f77 5f64 7570 6c69 6361 7465 733a 0a20  ow_duplicates:. 
-0000d960: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000d970: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
-0000d980: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0000d990: 6f72 2866 2256 6172 6961 626c 6520 7b76  or(f"Variable {v
-0000d9a0: 2e6e 616d 657d 2069 7320 6265 696e 6720  .name} is being 
-0000d9b0: 6f76 6572 7772 6974 7465 6e20 7468 6973  overwritten this
-0000d9c0: 2069 7320 6e6f 7420 616c 6c6f 7765 6422   is not allowed"
-0000d9d0: 290a 2020 2020 2020 2020 656e 765b 762e  ).        env[v.
-0000d9e0: 6e61 6d65 5d20 3d20 7661 6c0a 0a20 2020  name] = val..   
-0000d9f0: 2073 6166 655f 6d61 705f 666c 6174 2877   safe_map_flat(w
-0000da00: 7269 7465 2c20 6c69 7374 2874 7261 6365  rite, list(trace
-0000da10: 2e61 7267 7329 2c20 6c69 7374 2861 7267  .args), list(arg
-0000da20: 7329 290a 2020 2020 7361 6665 5f6d 6170  s)).    safe_map
-0000da30: 5f66 6c61 7428 7772 6974 652c 206c 6973  _flat(write, lis
-0000da40: 7428 7472 6163 652e 6b77 6172 6773 2e76  t(trace.kwargs.v
-0000da50: 616c 7565 7328 2929 2c20 6c69 7374 286b  alues()), list(k
-0000da60: 7761 7267 732e 7661 6c75 6573 2829 2929  wargs.values()))
-0000da70: 0a0a 2020 2020 666f 7220 7379 6d62 6f6c  ..    for symbol
-0000da80: 2069 6e20 7472 6163 652e 626f 756e 645f   in trace.bound_
-0000da90: 7379 6d62 6f6c 733a 0a20 2020 2020 2020  symbols:.       
-0000daa0: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
-0000dab0: 6420 696e 2074 7261 6e73 666f 726d 5f73  d in transform_s
-0000dac0: 6b69 705f 6c69 7374 3a0a 2020 2020 2020  kip_list:.      
-0000dad0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-0000dae0: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
-0000daf0: 6565 5f6d 6170 2872 6561 642c 2073 796d  ee_map(read, sym
-0000db00: 626f 6c2e 6172 6773 290a 2020 2020 2020  bol.args).      
-0000db10: 2020 6b77 6172 6773 203d 2074 7265 655f    kwargs = tree_
-0000db20: 6d61 7028 7265 6164 2c20 7379 6d62 6f6c  map(read, symbol
-0000db30: 2e6b 7761 7267 7329 0a20 2020 2020 2020  .kwargs).       
-0000db40: 2070 7269 6d5f 6675 6e63 203d 2073 796d   prim_func = sym
-0000db50: 626f 6c5f 6d61 7070 6572 2873 796d 626f  bol_mapper(symbo
-0000db60: 6c29 0a20 2020 2020 2020 2069 6620 7072  l).        if pr
-0000db70: 696d 5f66 756e 6320 6973 204e 6f6e 653a  im_func is None:
-0000db80: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0000db90: 7469 6e75 650a 2020 2020 2020 2020 7265  tinue.        re
-0000dba0: 7375 6c74 203d 2070 7269 6d5f 6675 6e63  sult = prim_func
-0000dbb0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-0000dbc0: 290a 2020 2020 2020 2020 7361 6665 5f6d  ).        safe_m
-0000dbd0: 6170 5f66 6c61 7428 7772 6974 652c 206c  ap_flat(write, l
-0000dbe0: 6973 7428 7365 7175 656e 6369 6679 2873  ist(sequencify(s
-0000dbf0: 796d 626f 6c2e 6f75 7470 7574 2929 2c20  ymbol.output)), 
-0000dc00: 6c69 7374 2873 6571 7565 6e63 6966 7928  list(sequencify(
-0000dc10: 7265 7375 6c74 2929 290a 0a20 2020 2069  result)))..    i
-0000dc20: 6620 7769 7468 5f65 6e76 3a0a 2020 2020  f with_env:.    
-0000dc30: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
-0000dc40: 6d61 7028 7265 6164 2c20 7472 6163 652e  map(read, trace.
-0000dc50: 6f75 7470 7574 292c 2065 6e76 0a0a 2020  output), env..  
-0000dc60: 2020 7265 7475 726e 2074 7265 655f 6d61    return tree_ma
-0000dc70: 7028 7265 6164 2c20 7472 6163 652e 6f75  p(read, trace.ou
-0000dc80: 7470 7574 290a 0a0a 6465 6620 5f69 6465  tput)...def _ide
-0000dc90: 6e74 6974 795f 6361 6c6c 5f6d 6574 6166  ntity_call_metaf
-0000dca0: 756e 6328 2a61 7267 732c 2074 7261 6365  unc(*args, trace
-0000dcb0: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
-0000dcc0: 7329 3a0a 2020 2020 7769 7468 2064 6574  s):.    with det
-0000dcd0: 6163 6865 645f 7472 6163 6528 293a 0a20  ached_trace():. 
-0000dce0: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
-0000dcf0: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
-0000dd00: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0000dd10: 0a0a 0a69 6465 6e74 6974 795f 6361 6c6c  ...identity_call
-0000dd20: 203d 2053 796d 626f 6c28 6964 3d54 7261   = Symbol(id=Tra
-0000dd30: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
-0000dd40: 4f70 2c20 6e61 6d65 3d22 6964 656e 7469  Op, name="identi
-0000dd50: 7479 5f63 616c 6c22 2c20 6d65 7461 3d5f  ty_call", meta=_
-0000dd60: 6964 656e 7469 7479 5f63 616c 6c5f 6d65  identity_call_me
-0000dd70: 7461 6675 6e63 290a 0a0a 6465 6620 6964  tafunc)...def id
-0000dd80: 656e 7469 7479 2866 756e 6329 3a0a 2020  entity(func):.  
-0000dd90: 2020 2222 2249 6465 6e74 6974 7920 7472    """Identity tr
-0000dda0: 616e 7366 6f72 6d20 666f 7220 6120 5468  ansform for a Th
-0000ddb0: 756e 6465 7220 6675 6e63 7469 6f6e 2e0a  under function..
-0000ddc0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0000ddd0: 2020 2066 756e 6320 2843 616c 6c61 626c     func (Callabl
-0000dde0: 6529 3a20 4120 5468 756e 6465 7220 6675  e): A Thunder fu
-0000ddf0: 6e63 7469 6f6e 2074 6f20 6265 2074 7261  nction to be tra
-0000de00: 6e73 666f 726d 6564 2e0a 2020 2020 2222  nsformed..    ""
-0000de10: 220a 0a20 2020 2064 6566 2077 7261 7070  "..    def wrapp
-0000de20: 6572 282a 6172 6773 2c20 2a2a 6b77 6172  er(*args, **kwar
-0000de30: 6773 293a 0a20 2020 2020 2020 2074 7261  gs):.        tra
-0000de40: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-0000de50: 7261 6365 2829 2866 756e 632c 202a 6172  race()(func, *ar
-0000de60: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-0000de70: 2020 2020 2020 7265 7475 726e 2069 6465        return ide
-0000de80: 6e74 6974 795f 6361 6c6c 282a 6172 6773  ntity_call(*args
-0000de90: 2c20 2a2a 6b77 6172 6773 2c20 7472 6163  , **kwargs, trac
-0000dea0: 653d 7472 6163 6529 0a0a 2020 2020 7265  e=trace)..    re
-0000deb0: 7475 726e 2077 7261 7070 6572 0a0a 0a64  turn wrapper...d
-0000dec0: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
-0000ded0: 6c5f 7079 746f 7263 6828 2a61 7267 732c  l_pytorch(*args,
-0000dee0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-0000def0: 2a6b 7761 7267 7329 3a0a 2020 2020 696d  *kwargs):.    im
-0000df00: 706f 7274 2074 6f72 6368 0a0a 2020 2020  port torch..    
-0000df10: 6465 6620 7379 6d62 6f6c 5f6d 6170 7065  def symbol_mappe
-0000df20: 7228 6f70 293a 0a20 2020 2020 2020 2069  r(op):.        i
-0000df30: 6620 6f70 2e6f 7020 3d3d 2054 7261 6e73  f op.op == Trans
-0000df40: 666f 726d 732e 4964 656e 7469 7479 4f70  forms.IdentityOp
-0000df50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000df60: 7475 726e 205f 6964 656e 7469 7479 5f63  turn _identity_c
-0000df70: 616c 6c5f 7079 746f 7263 680a 0a20 2020  all_pytorch..   
-0000df80: 2020 2020 2074 6f72 6368 5f6f 7020 3d20       torch_op = 
-0000df90: 6f70 735f 746f 5f74 6f72 6368 5f6f 7073  ops_to_torch_ops
-0000dfa0: 5f6d 6170 5b6f 702e 6f70 5d0a 2020 2020  _map[op.op].    
-0000dfb0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000dfc0: 6528 746f 7263 685f 6f70 2c20 7374 7229  e(torch_op, str)
-0000dfd0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000dfe0: 7475 726e 2067 6574 6174 7472 2874 6f72  turn getattr(tor
-0000dff0: 6368 2c20 746f 7263 685f 6f70 2e73 7472  ch, torch_op.str
-0000e000: 6970 2822 7079 746f 7263 682e 2229 290a  ip("pytorch.")).
-0000e010: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0000e020: 6f72 6368 5f6f 700a 0a20 2020 2077 6974  orch_op..    wit
-0000e030: 6820 6465 7461 6368 6564 5f74 7261 6365  h detached_trace
-0000e040: 2829 3a0a 2020 2020 2020 2020 7265 7475  ():.        retu
-0000e050: 726e 2065 7661 6c5f 7472 6163 6528 7472  rn eval_trace(tr
-0000e060: 6163 652c 202a 6172 6773 2c20 2a2a 6b77  ace, *args, **kw
-0000e070: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
-0000e080: 7065 723d 7379 6d62 6f6c 5f6d 6170 7065  per=symbol_mappe
-0000e090: 7229 0a0a 0a23 2052 6567 6973 7465 7220  r)...# Register 
-0000e0a0: 7468 6520 6964 656e 7469 7479 2063 616c  the identity cal
-0000e0b0: 6c20 666f 7220 5079 546f 7263 6820 6578  l for PyTorch ex
-0000e0c0: 6563 7574 6f72 2e0a 2320 6f70 735f 746f  ecutor..# ops_to
-0000e0d0: 5f74 6f72 6368 5f6f 7073 5f6d 6170 5b54  _torch_ops_map[T
-0000e0e0: 7261 6e73 666f 726d 732e 4964 656e 7469  ransforms.Identi
-0000e0f0: 7479 4f70 5d20 3d20 5f69 6465 6e74 6974  tyOp] = _identit
-0000e100: 795f 6361 6c6c 5f70 7974 6f72 6368 0a0a  y_call_pytorch..
-0000e110: 0a23 2056 4d41 5020 7472 616e 7366 6f72  .# VMAP transfor
-0000e120: 6d0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  m.# ------------
-0000e130: 2d0a 0a0a 636c 6173 7320 4e6f 744d 6170  -...class NotMap
-0000e140: 7065 643a 0a20 2020 2022 2222 5265 7072  ped:.    """Repr
-0000e150: 6573 656e 7473 2061 206e 6f6e 2d62 6174  esents a non-bat
-0000e160: 6368 6564 2064 696d 656e 7369 6f6e 2e22  ched dimension."
-0000e170: 2222 0a0a 2020 2020 6465 6620 5f5f 7265  ""..    def __re
-0000e180: 7072 5f5f 2873 656c 6629 3a0a 2020 2020  pr__(self):.    
-0000e190: 2020 2020 7265 7475 726e 2022 6e6f 745f      return "not_
-0000e1a0: 6d61 7070 6564 220a 0a0a 4064 6174 6163  mapped"...@datac
-0000e1b0: 6c61 7373 2866 726f 7a65 6e3d 5472 7565  lass(frozen=True
-0000e1c0: 290a 636c 6173 7320 4261 7463 6865 6456  ).class BatchedV
-0000e1d0: 616c 7565 3a0a 2020 2020 2222 2242 6174  alue:.    """Bat
-0000e1e0: 6368 6564 2076 616c 7565 2066 6f72 2074  ched value for t
-0000e1f0: 6865 2076 6d61 7020 7472 616e 7366 6f72  he vmap transfor
-0000e200: 6d2e 0a0a 2020 2020 4174 7472 6962 7574  m...    Attribut
-0000e210: 6573 3a0a 2020 2020 2020 2020 7661 6c75  es:.        valu
-0000e220: 653a 2042 6174 6368 6564 2076 616c 7565  e: Batched value
-0000e230: 2e0a 2020 2020 2020 2020 6261 7463 685f  ..        batch_
-0000e240: 6469 6d3a 2042 6174 6368 696e 6720 6469  dim: Batching di
-0000e250: 6d65 6e73 696f 6e20 6f72 206e 6f74 5f6d  mension or not_m
-0000e260: 6170 7065 640a 2020 2020 2222 220a 0a20  apped.    """.. 
-0000e270: 2020 2076 616c 7565 3a20 416e 790a 2020     value: Any.  
-0000e280: 2020 6261 7463 685f 6469 6d3a 2069 6e74    batch_dim: int
-0000e290: 207c 204e 6f74 4d61 7070 6564 0a0a 2020   | NotMapped..  
-0000e2a0: 2020 6465 6620 5f5f 6974 6572 5f5f 2873    def __iter__(s
-0000e2b0: 656c 6629 3a0a 2020 2020 2020 2020 7969  elf):.        yi
-0000e2c0: 656c 6420 7365 6c66 2e76 616c 7565 0a20  eld self.value. 
-0000e2d0: 2020 2020 2020 2079 6965 6c64 2073 656c         yield sel
-0000e2e0: 662e 6261 7463 685f 6469 6d0a 0a0a 6465  f.batch_dim...de
-0000e2f0: 6620 7061 6972 5f74 6f5f 6261 7463 6865  f pair_to_batche
-0000e300: 645f 7661 6c75 6528 7061 6972 293a 0a20  d_value(pair):. 
-0000e310: 2020 2022 2222 436f 6e76 6572 7473 2061     """Converts a
-0000e320: 2070 6169 7220 746f 2061 2042 6174 6368   pair to a Batch
-0000e330: 6564 5661 6c75 652e 0a0a 2020 2020 4172  edValue...    Ar
-0000e340: 6773 3a0a 2020 2020 2020 2020 7061 6972  gs:.        pair
-0000e350: 2028 5365 7175 656e 6365 293a 2050 6169   (Sequence): Pai
-0000e360: 7220 746f 2063 6f6e 7665 7274 2e0a 0a20  r to convert... 
-0000e370: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0000e380: 2020 2020 4261 7463 6865 6456 616c 7565      BatchedValue
-0000e390: 3a20 4261 7463 6865 6456 616c 7565 2072  : BatchedValue r
-0000e3a0: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
-0000e3b0: 2074 6865 2070 6169 722e 0a20 2020 2022   the pair..    "
-0000e3c0: 2222 0a20 2020 2069 6620 6973 696e 7374  "".    if isinst
-0000e3d0: 616e 6365 2870 6169 722c 2042 6174 6368  ance(pair, Batch
-0000e3e0: 6564 5661 6c75 6529 3a0a 2020 2020 2020  edValue):.      
-0000e3f0: 2020 7265 7475 726e 2070 6169 720a 2020    return pair.  
-0000e400: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000e410: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0000e420: 6528 7061 6972 2c20 5365 7175 656e 6365  e(pair, Sequence
-0000e430: 2920 616e 6420 6c65 6e28 7061 6972 2920  ) and len(pair) 
-0000e440: 3d3d 2032 0a20 2020 2020 2020 2072 6574  == 2.        ret
-0000e450: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
-0000e460: 282a 7061 6972 290a 0a0a 6465 6620 7665  (*pair)...def ve
-0000e470: 6374 6f72 697a 6564 5f62 6174 6368 6572  ctorized_batcher
-0000e480: 2870 7269 6d2c 2061 7869 735f 7369 7a65  (prim, axis_size
-0000e490: 2c20 6261 7463 6865 645f 7661 6c75 6573  , batched_values
-0000e4a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0000e4b0: 2062 6174 6368 5f64 696d 203d 2062 6174   batch_dim = bat
-0000e4c0: 6368 6564 5f76 616c 7565 735b 305d 2e62  ched_values[0].b
-0000e4d0: 6174 6368 5f64 696d 0a20 2020 2061 7373  atch_dim.    ass
-0000e4e0: 6572 7420 616c 6c28 0a20 2020 2020 2020  ert all(.       
-0000e4f0: 2062 6174 6368 5f64 696d 203d 3d20 6276   batch_dim == bv
-0000e500: 2e62 6174 6368 5f64 696d 2066 6f72 2062  .batch_dim for b
-0000e510: 7620 696e 2062 6174 6368 6564 5f76 616c  v in batched_val
-0000e520: 7565 735b 313a 5d0a 2020 2020 292c 2066  ues[1:].    ), f
-0000e530: 2260 7665 6374 6f72 697a 6564 5f62 6174  "`vectorized_bat
-0000e540: 6368 6572 6020 676f 7420 6469 6666 6572  cher` got differ
-0000e550: 656e 7420 6261 7463 6865 6420 6469 6d65  ent batched dime
-0000e560: 6e73 696f 6e73 207b 5b62 762e 6261 7463  nsions {[bv.batc
-0000e570: 685f 6469 6d20 666f 7220 6276 2069 6e20  h_dim for bv in 
-0000e580: 6261 7463 6865 645f 7661 6c75 6573 5d7d  batched_values]}
-0000e590: 220a 2020 2020 7265 7475 726e 2042 6174  ".    return Bat
-0000e5a0: 6368 6564 5661 6c75 6528 7072 696d 282a  chedValue(prim(*
-0000e5b0: 5b62 762e 7661 6c75 6520 666f 7220 6276  [bv.value for bv
-0000e5c0: 2069 6e20 6261 7463 6865 645f 7661 6c75   in batched_valu
-0000e5d0: 6573 5d2c 202a 2a6b 7761 7267 7329 2c20  es], **kwargs), 
-0000e5e0: 6261 7463 685f 6469 6d29 0a0a 0a6e 6f74  batch_dim)...not
-0000e5f0: 5f6d 6170 7065 6420 3d20 4e6f 744d 6170  _mapped = NotMap
-0000e600: 7065 6428 290a 0a0a 6465 6620 6d6f 7665  ped()...def move
-0000e610: 6469 6d28 782c 2073 7263 3a20 696e 742c  dim(x, src: int,
-0000e620: 2064 7374 3a20 696e 7429 3a0a 2020 2020   dst: int):.    
-0000e630: 7065 726d 203d 205b 6920 666f 7220 6920  perm = [i for i 
-0000e640: 696e 2072 616e 6765 2878 2e6e 6469 6d29  in range(x.ndim)
-0000e650: 2069 6620 6920 213d 2073 7263 5d0a 2020   if i != src].  
-0000e660: 2020 7065 726d 2e69 6e73 6572 7428 6473    perm.insert(ds
-0000e670: 742c 2073 7263 290a 2020 2020 7265 7475  t, src).    retu
-0000e680: 726e 2070 7269 6d73 2e74 7261 6e73 706f  rn prims.transpo
-0000e690: 7365 2878 2c20 7475 706c 6528 7065 726d  se(x, tuple(perm
-0000e6a0: 2929 0a0a 0a64 6566 206d 6f76 655f 6261  ))...def move_ba
-0000e6b0: 7463 685f 6469 6d28 6178 6973 5f73 697a  tch_dim(axis_siz
-0000e6c0: 652c 2073 7263 2c20 6473 742c 2078 293a  e, src, dst, x):
-0000e6d0: 0a20 2020 2069 6620 7372 6320 6973 206e  .    if src is n
-0000e6e0: 6f74 5f6d 6170 7065 643a 0a20 2020 2020  ot_mapped:.     
-0000e6f0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000e700: 2878 2c20 4e75 6d62 6572 293a 0a20 2020  (x, Number):.   
-0000e710: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000e720: 780a 2020 2020 2020 2020 7461 7267 6574  x.        target
-0000e730: 5f73 6861 7065 203d 206c 6973 7428 782e  _shape = list(x.
-0000e740: 7368 6170 6529 0a20 2020 2020 2020 2074  shape).        t
-0000e750: 6172 6765 745f 7368 6170 652e 696e 7365  arget_shape.inse
-0000e760: 7274 2864 7374 2c20 6178 6973 5f73 697a  rt(dst, axis_siz
-0000e770: 6529 0a20 2020 2020 2020 2062 6361 7374  e).        bcast
-0000e780: 5f64 696d 7320 3d20 6c69 7374 2872 616e  _dims = list(ran
-0000e790: 6765 286c 656e 2874 6172 6765 745f 7368  ge(len(target_sh
-0000e7a0: 6170 6529 2929 0a20 2020 2020 2020 2062  ape))).        b
-0000e7b0: 6361 7374 5f64 696d 732e 706f 7028 6473  cast_dims.pop(ds
-0000e7c0: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
-0000e7d0: 6e20 7072 696d 732e 6272 6f61 6463 6173  n prims.broadcas
-0000e7e0: 745f 696e 5f64 696d 2878 2c20 7461 7267  t_in_dim(x, targ
-0000e7f0: 6574 5f73 6861 7065 2c20 6263 6173 745f  et_shape, bcast_
-0000e800: 6469 6d73 290a 2020 2020 656c 6966 2073  dims).    elif s
-0000e810: 7263 203d 3d20 6473 743a 0a20 2020 2020  rc == dst:.     
-0000e820: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
-0000e830: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-0000e840: 7475 726e 206d 6f76 6564 696d 2878 2c20  turn movedim(x, 
-0000e850: 7372 632c 2064 7374 290a 0a0a 6465 6620  src, dst)...def 
-0000e860: 6269 6e61 7279 5f6f 705f 6261 7463 6869  binary_op_batchi
-0000e870: 6e67 5f72 756c 6528 6f70 3a20 7072 696d  ng_rule(op: prim
-0000e880: 732e 5072 696d 4944 732c 2061 7869 735f  s.PrimIDs, axis_
-0000e890: 7369 7a65 3a20 696e 742c 2076 616c 735f  size: int, vals_
-0000e8a0: 696e 3a20 4261 7463 6865 6456 616c 7565  in: BatchedValue
-0000e8b0: 293a 0a20 2020 2028 2878 2c20 785f 6264  ):.    ((x, x_bd
-0000e8c0: 696d 292c 2028 792c 2079 5f62 6469 6d29  im), (y, y_bdim)
-0000e8d0: 2920 3d20 7661 6c73 5f69 6e0a 2020 2020  ) = vals_in.    
-0000e8e0: 6966 2078 5f62 6469 6d20 213d 2079 5f62  if x_bdim != y_b
-0000e8f0: 6469 6d3a 0a20 2020 2020 2020 2069 6620  dim:.        if 
-0000e900: 785f 6264 696d 2069 7320 6e6f 745f 6d61  x_bdim is not_ma
-0000e910: 7070 6564 3a0a 2020 2020 2020 2020 2020  pped:.          
-0000e920: 2020 7820 3d20 6d6f 7665 5f62 6174 6368    x = move_batch
-0000e930: 5f64 696d 2861 7869 735f 7369 7a65 2c20  _dim(axis_size, 
-0000e940: 785f 6264 696d 2c20 795f 6264 696d 2c20  x_bdim, y_bdim, 
-0000e950: 7829 0a20 2020 2020 2020 2020 2020 2078  x).            x
-0000e960: 5f62 6469 6d20 3d20 795f 6264 696d 0a20  _bdim = y_bdim. 
-0000e970: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000e980: 2020 2020 2020 2020 2079 203d 206d 6f76           y = mov
-0000e990: 655f 6261 7463 685f 6469 6d28 6178 6973  e_batch_dim(axis
-0000e9a0: 5f73 697a 652c 2079 5f62 6469 6d2c 2078  _size, y_bdim, x
-0000e9b0: 5f62 6469 6d2c 2079 290a 2020 2020 7265  _bdim, y).    re
-0000e9c0: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
-0000e9d0: 6528 6f70 2878 2c20 7929 2c20 785f 6264  e(op(x, y), x_bd
-0000e9e0: 696d 290a 0a0a 6465 6620 7369 6e5f 766d  im)...def sin_vm
-0000e9f0: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
-0000ea00: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
-0000ea10: 7565 2920 2d3e 2042 6174 6368 6564 5661  ue) -> BatchedVa
-0000ea20: 6c75 653a 0a20 2020 2072 6574 7572 6e20  lue:.    return 
-0000ea30: 7665 6374 6f72 697a 6564 5f62 6174 6368  vectorized_batch
-0000ea40: 6572 2870 7269 6d73 2e73 696e 2c20 6178  er(prims.sin, ax
-0000ea50: 6973 5f73 697a 652c 2028 612c 2929 0a0a  is_size, (a,))..
-0000ea60: 0a64 6566 2063 6f73 5f76 6d61 7028 6178  .def cos_vmap(ax
-0000ea70: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
-0000ea80: 2042 6174 6368 6564 5661 6c75 6529 202d   BatchedValue) -
-0000ea90: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
-0000eaa0: 2020 2020 7265 7475 726e 2076 6563 746f      return vecto
-0000eab0: 7269 7a65 645f 6261 7463 6865 7228 7072  rized_batcher(pr
-0000eac0: 696d 732e 636f 732c 2061 7869 735f 7369  ims.cos, axis_si
-0000ead0: 7a65 2c20 2861 2c29 290a 0a0a 6465 6620  ze, (a,))...def 
-0000eae0: 6d75 6c5f 766d 6170 2861 7869 735f 7369  mul_vmap(axis_si
-0000eaf0: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
-0000eb00: 6865 6456 616c 7565 2c20 623a 2042 6174  hedValue, b: Bat
-0000eb10: 6368 6564 5661 6c75 6529 202d 3e20 4261  chedValue) -> Ba
-0000eb20: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
-0000eb30: 7265 7475 726e 2062 696e 6172 795f 6f70  return binary_op
-0000eb40: 5f62 6174 6368 696e 675f 7275 6c65 2870  _batching_rule(p
-0000eb50: 7269 6d73 2e6d 756c 2c20 6178 6973 5f73  rims.mul, axis_s
-0000eb60: 697a 652c 2028 612c 2062 2929 0a0a 0a64  ize, (a, b))...d
-0000eb70: 6566 2061 6464 5f76 6d61 7028 6178 6973  ef add_vmap(axis
-0000eb80: 5f73 697a 653a 2069 6e74 2c20 613a 2042  _size: int, a: B
-0000eb90: 6174 6368 6564 5661 6c75 652c 2062 3a20  atchedValue, b: 
-0000eba0: 4261 7463 6865 6456 616c 7565 2920 2d3e  BatchedValue) ->
-0000ebb0: 2042 6174 6368 6564 5661 6c75 653a 0a20   BatchedValue:. 
-0000ebc0: 2020 2072 6574 7572 6e20 6269 6e61 7279     return binary
-0000ebd0: 5f6f 705f 6261 7463 6869 6e67 5f72 756c  _op_batching_rul
-0000ebe0: 6528 7072 696d 732e 6164 642c 2061 7869  e(prims.add, axi
-0000ebf0: 735f 7369 7a65 2c20 2861 2c20 6229 290a  s_size, (a, b)).
-0000ec00: 0a0a 6465 6620 7375 6d5f 766d 6170 2861  ..def sum_vmap(a
-0000ec10: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
-0000ec20: 3a20 4261 7463 6865 6456 616c 7565 2c20  : BatchedValue, 
-0000ec30: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
-0000ec40: 6e74 5d2c 202a 2a6b 7761 7267 7329 202d  nt], **kwargs) -
-0000ec50: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
-0000ec60: 2020 2020 6264 696d 203d 2061 2e62 6174      bdim = a.bat
-0000ec70: 6368 5f64 696d 0a20 2020 2023 2054 4f44  ch_dim.    # TOD
-0000ec80: 4f3a 2072 656d 6f76 6520 7468 6973 2077  O: remove this w
-0000ec90: 6865 6e20 6469 6d73 2062 6563 6f6d 6573  hen dims becomes
-0000eca0: 2061 206d 616e 6461 746f 7279 206b 7761   a mandatory kwa
-0000ecb0: 7267 0a20 2020 2069 6620 6c65 6e28 6469  rg.    if len(di
-0000ecc0: 6d73 2920 3e20 303a 0a20 2020 2020 2020  ms) > 0:.       
-0000ecd0: 2064 696d 732c 205f 203d 2073 6166 655f   dims, _ = safe_
-0000ece0: 7a69 7028 2a64 696d 7329 0a20 2020 2064  zip(*dims).    d
-0000ecf0: 696d 735f 6265 666f 7265 203d 2074 7570  ims_before = tup
-0000ed00: 6c65 2865 6c20 666f 7220 656c 2069 6e20  le(el for el in 
-0000ed10: 6469 6d73 2069 6620 656c 203c 2062 6469  dims if el < bdi
-0000ed20: 6d29 0a20 2020 2064 696d 735f 6166 7465  m).    dims_afte
-0000ed30: 7220 3d20 7475 706c 6528 656c 202b 2031  r = tuple(el + 1
-0000ed40: 2066 6f72 2065 6c20 696e 2064 696d 7320   for el in dims 
-0000ed50: 6966 2065 6c20 3e3d 2062 6469 6d29 0a20  if el >= bdim). 
-0000ed60: 2020 2062 6174 6368 6564 5f64 696d 7320     batched_dims 
-0000ed70: 3d20 6469 6d73 5f62 6566 6f72 6520 2b20  = dims_before + 
-0000ed80: 6469 6d73 5f61 6674 6572 0a20 2020 2072  dims_after.    r
-0000ed90: 6574 7572 6e20 7665 6374 6f72 697a 6564  eturn vectorized
-0000eda0: 5f62 6174 6368 6572 2870 7269 6d73 2e73  _batcher(prims.s
-0000edb0: 756d 2c20 6178 6973 5f73 697a 652c 2028  um, axis_size, (
-0000edc0: 612c 292c 2064 696d 733d 6261 7463 6865  a,), dims=batche
-0000edd0: 645f 6469 6d73 2c20 2a2a 6b77 6172 6773  d_dims, **kwargs
-0000ede0: 290a 0a0a 2320 544f 444f 3a20 506c 6561  )...# TODO: Plea
-0000edf0: 7365 2074 6573 7420 7468 6973 2065 7874  se test this ext
-0000ee00: 656e 7369 7665 6c79 0a64 6566 2062 726f  ensively.def bro
-0000ee10: 6164 6361 7374 5f69 6e5f 6469 6d5f 766d  adcast_in_dim_vm
-0000ee20: 6170 280a 2020 2020 6178 6973 5f73 697a  ap(.    axis_siz
-0000ee30: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
-0000ee40: 6564 5661 6c75 652c 2073 6861 7065 3a20  edValue, shape: 
-0000ee50: 5365 7175 656e 6365 5b42 6174 6368 6564  Sequence[Batched
-0000ee60: 5661 6c75 655d 2c20 6272 6f61 6463 6173  Value], broadcas
-0000ee70: 745f 6469 6d65 6e73 696f 6e73 3a20 5365  t_dimensions: Se
-0000ee80: 7175 656e 6365 5b42 6174 6368 6564 5661  quence[BatchedVa
-0000ee90: 6c75 655d 0a29 202d 3e20 4261 7463 6865  lue].) -> Batche
-0000eea0: 6456 616c 7565 3a0a 2020 2020 6264 696d  dValue:.    bdim
-0000eeb0: 203d 2061 2e62 6174 6368 5f64 696d 0a20   = a.batch_dim. 
-0000eec0: 2020 2023 2054 4f44 4f3a 2072 656d 6f76     # TODO: remov
-0000eed0: 6520 7468 6973 2077 6865 6e20 7368 6170  e this when shap
-0000eee0: 6520 616e 6420 6272 6f61 6463 6173 745f  e and broadcast_
-0000eef0: 6469 6d65 6e73 696f 6e73 2062 6563 6f6d  dimensions becom
-0000ef00: 6520 6d61 6e64 6174 6f72 7920 6b77 6172  e mandatory kwar
-0000ef10: 6773 0a20 2020 2073 6861 7065 2c20 5f20  gs.    shape, _ 
-0000ef20: 3d20 7361 6665 5f7a 6970 282a 7368 6170  = safe_zip(*shap
-0000ef30: 6529 0a20 2020 2069 6620 6c65 6e28 6272  e).    if len(br
-0000ef40: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000ef50: 6e73 2920 3e20 303a 0a20 2020 2020 2020  ns) > 0:.       
-0000ef60: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
-0000ef70: 7369 6f6e 732c 205f 203d 2073 6166 655f  sions, _ = safe_
-0000ef80: 7a69 7028 2a62 726f 6164 6361 7374 5f64  zip(*broadcast_d
-0000ef90: 696d 656e 7369 6f6e 7329 0a20 2020 2069  imensions).    i
-0000efa0: 6620 6264 696d 2069 7320 6e6f 745f 6d61  f bdim is not_ma
-0000efb0: 7070 6564 3a0a 2020 2020 2020 2020 7265  pped:.        re
-0000efc0: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
-0000efd0: 6528 7072 696d 732e 6272 6f61 6463 6173  e(prims.broadcas
-0000efe0: 745f 696e 5f64 696d 2861 2e76 616c 7565  t_in_dim(a.value
-0000eff0: 2c20 7368 6170 652c 2062 726f 6164 6361  , shape, broadca
-0000f000: 7374 5f64 696d 656e 7369 6f6e 7329 2c20  st_dimensions), 
-0000f010: 6264 696d 290a 2020 2020 656c 7365 3a0a  bdim).    else:.
-0000f020: 2020 2020 2020 2020 6e65 775f 6264 696d          new_bdim
-0000f030: 203d 2062 6469 6d20 2b20 7375 6d28 3120   = bdim + sum(1 
-0000f040: 666f 7220 6469 6d20 696e 2062 726f 6164  for dim in broad
-0000f050: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
-0000f060: 6966 2064 696d 203c 2062 6469 6d29 0a20  if dim < bdim). 
-0000f070: 2020 2020 2020 206e 6577 5f73 6861 7065         new_shape
-0000f080: 203d 206c 6973 7428 7368 6170 6529 0a20   = list(shape). 
-0000f090: 2020 2020 2020 206e 6577 5f73 6861 7065         new_shape
-0000f0a0: 2e69 6e73 6572 7428 6e65 775f 6264 696d  .insert(new_bdim
-0000f0b0: 2c20 6178 6973 5f73 697a 6529 0a20 2020  , axis_size).   
-0000f0c0: 2020 2020 206e 6577 5f62 726f 6164 6361       new_broadca
-0000f0d0: 7374 5f64 696d 656e 7369 6f6e 7320 3d20  st_dimensions = 
-0000f0e0: 2830 2c29 202b 2074 7570 6c65 2864 696d  (0,) + tuple(dim
-0000f0f0: 202b 2031 2069 6620 6469 6d20 3e3d 2062   + 1 if dim >= b
-0000f100: 6469 6d20 656c 7365 2064 696d 2066 6f72  dim else dim for
-0000f110: 2064 696d 2069 6e20 6272 6f61 6463 6173   dim in broadcas
-0000f120: 745f 6469 6d65 6e73 696f 6e73 290a 2020  t_dimensions).  
-0000f130: 2020 2020 2020 6966 2062 726f 6164 6361        if broadca
-0000f140: 7374 5f64 696d 656e 7369 6f6e 7320 3d3d  st_dimensions ==
-0000f150: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
-0000f160: 206e 6577 5f62 726f 6164 6361 7374 5f64   new_broadcast_d
-0000f170: 696d 656e 7369 6f6e 7320 3d20 2829 0a20  imensions = (). 
-0000f180: 2020 2020 2020 2072 6574 7572 6e20 4261         return Ba
-0000f190: 7463 6865 6456 616c 7565 2870 7269 6d73  tchedValue(prims
-0000f1a0: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
-0000f1b0: 6d28 612e 7661 6c75 652c 206e 6577 5f73  m(a.value, new_s
-0000f1c0: 6861 7065 2c20 6e65 775f 6272 6f61 6463  hape, new_broadc
-0000f1d0: 6173 745f 6469 6d65 6e73 696f 6e73 292c  ast_dimensions),
-0000f1e0: 206e 6577 5f62 6469 6d29 0a0a 0a76 6d61   new_bdim)...vma
-0000f1f0: 705f 696d 706c 733a 2064 6963 745b 7072  p_impls: dict[pr
-0000f200: 696d 732e 5379 6d62 6f6c 2c20 4361 6c6c  ims.Symbol, Call
-0000f210: 6162 6c65 5d20 3d20 6469 6374 2829 0a0a  able] = dict()..
-0000f220: 0a64 6566 2075 6e77 7261 705f 6f6e 655f  .def unwrap_one_
-0000f230: 6c65 7665 6c5f 6f66 5f73 7562 7379 6d62  level_of_subsymb
-0000f240: 6f6c 7328 7472 6163 6529 3a0a 2020 2020  ols(trace):.    
-0000f250: 6e65 775f 7379 6d62 6f6c 735f 6974 6572  new_symbols_iter
-0000f260: 203d 2028 0a20 2020 2020 2020 2062 6f75   = (.        bou
-0000f270: 6e64 5f73 796d 626f 6c2e 7375 6273 796d  nd_symbol.subsym
-0000f280: 626f 6c73 2069 6620 6c65 6e28 626f 756e  bols if len(boun
-0000f290: 645f 7379 6d62 6f6c 2e73 7562 7379 6d62  d_symbol.subsymb
-0000f2a0: 6f6c 7329 203e 2030 2065 6c73 6520 5b62  ols) > 0 else [b
-0000f2b0: 6f75 6e64 5f73 796d 626f 6c5d 0a20 2020  ound_symbol].   
-0000f2c0: 2020 2020 2066 6f72 2062 6f75 6e64 5f73       for bound_s
-0000f2d0: 796d 626f 6c20 696e 2074 7261 6365 2e62  ymbol in trace.b
-0000f2e0: 6f75 6e64 5f73 796d 626f 6c73 0a20 2020  ound_symbols.   
-0000f2f0: 2029 0a20 2020 206e 6577 5f73 796d 626f   ).    new_symbo
-0000f300: 6c73 203d 206c 6973 7428 6368 6169 6e2e  ls = list(chain.
-0000f310: 6672 6f6d 5f69 7465 7261 626c 6528 6e65  from_iterable(ne
-0000f320: 775f 7379 6d62 6f6c 735f 6974 6572 2929  w_symbols_iter))
-0000f330: 0a20 2020 2074 7261 6365 2e62 6f75 6e64  .    trace.bound
-0000f340: 5f73 796d 626f 6c73 203d 206e 6577 5f73  _symbols = new_s
-0000f350: 796d 626f 6c73 0a20 2020 2072 6574 7572  ymbols.    retur
-0000f360: 6e20 7472 6163 650a 0a0a 6465 6620 6465  n trace...def de
-0000f370: 636f 6d70 6f73 6564 5f66 6e5f 766d 6170  composed_fn_vmap
-0000f380: 5f72 756c 6528 6178 6973 5f73 697a 652c  _rule(axis_size,
-0000f390: 202a 6172 6773 2c20 666e 2c20 2a2a 6b77   *args, fn, **kw
-0000f3a0: 6172 6773 293a 0a20 2020 2061 7267 732c  args):.    args,
-0000f3b0: 2069 6e5f 6469 6d73 203d 2075 6e7a 6970   in_dims = unzip
-0000f3c0: 3228 6172 6773 290a 2020 2020 756e 6261  2(args).    unba
-0000f3d0: 7463 6865 645f 6172 6773 203d 2074 7265  tched_args = tre
-0000f3e0: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
-0000f3f0: 7265 6d6f 7665 5f62 6174 6368 5f64 696d  remove_batch_dim
-0000f400: 2878 2920 6966 2069 7369 6e73 7461 6e63  (x) if isinstanc
-0000f410: 6528 782c 2054 656e 736f 7250 726f 7879  e(x, TensorProxy
-0000f420: 2920 656c 7365 2078 2c20 6172 6773 290a  ) else x, args).
-0000f430: 2020 2020 7472 6163 6520 3d20 636f 6e73      trace = cons
-0000f440: 7472 7563 745f 7472 6163 6528 2928 666e  truct_trace()(fn
-0000f450: 2c20 2a75 6e62 6174 6368 6564 5f61 7267  , *unbatched_arg
-0000f460: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
-0000f470: 2074 7261 6365 203d 2075 6e77 7261 705f   trace = unwrap_
-0000f480: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
-0000f490: 7379 6d62 6f6c 7328 7472 6163 6529 0a20  symbols(trace). 
-0000f4a0: 2020 206f 7574 7320 3d20 5f76 6d61 705f     outs = _vmap_
-0000f4b0: 6361 6c6c 5f6d 6574 6166 756e 6328 4661  call_metafunc(Fa
-0000f4c0: 6c73 652c 2061 7267 732c 2069 6e5f 6469  lse, args, in_di
-0000f4d0: 6d73 2c20 302c 2061 7869 735f 7369 7a65  ms, 0, axis_size
-0000f4e0: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
-0000f4f0: 3d74 7261 6365 2c20 2a2a 6b77 6172 6773  =trace, **kwargs
-0000f500: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
-0000f510: 6e63 6528 6f75 7473 2c20 5365 7175 656e  nce(outs, Sequen
-0000f520: 6365 293a 0a20 2020 2020 2020 206f 7574  ce):.        out
-0000f530: 5f64 696d 7320 3d20 2830 2c29 202a 206c  _dims = (0,) * l
-0000f540: 656e 286f 7574 7329 0a20 2020 2020 2020  en(outs).       
-0000f550: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
-0000f560: 2870 6169 725f 746f 5f62 6174 6368 6564  (pair_to_batched
-0000f570: 5f76 616c 7565 2c20 7361 6665 5f7a 6970  _value, safe_zip
-0000f580: 286f 7574 732c 206f 7574 5f64 696d 7329  (outs, out_dims)
-0000f590: 290a 2020 2020 7265 7475 726e 2042 6174  ).    return Bat
-0000f5a0: 6368 6564 5661 6c75 6528 6f75 7473 2c20  chedValue(outs, 
-0000f5b0: 3029 0a0a 0a76 6d61 705f 696d 706c 735b  0)...vmap_impls[
-0000f5c0: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
-0000f5d0: 4e5d 203d 2073 696e 5f76 6d61 700a 766d  N] = sin_vmap.vm
-0000f5e0: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
-0000f5f0: 7269 6d49 4473 2e43 4f53 5d20 3d20 636f  rimIDs.COS] = co
-0000f600: 735f 766d 6170 0a76 6d61 705f 696d 706c  s_vmap.vmap_impl
-0000f610: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
-0000f620: 4d55 4c5d 203d 206d 756c 5f76 6d61 700a  MUL] = mul_vmap.
-0000f630: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
-0000f640: 2e50 7269 6d49 4473 2e41 4444 5d20 3d20  .PrimIDs.ADD] = 
-0000f650: 6164 645f 766d 6170 0a76 6d61 705f 696d  add_vmap.vmap_im
-0000f660: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-0000f670: 732e 5355 4d5d 203d 2073 756d 5f76 6d61  s.SUM] = sum_vma
-0000f680: 700a 766d 6170 5f69 6d70 6c73 5b70 7269  p.vmap_impls[pri
-0000f690: 6d73 2e50 7269 6d49 4473 2e42 524f 4144  ms.PrimIDs.BROAD
-0000f6a0: 4341 5354 5f49 4e5f 4449 4d5d 203d 2062  CAST_IN_DIM] = b
-0000f6b0: 726f 6164 6361 7374 5f69 6e5f 6469 6d5f  roadcast_in_dim_
-0000f6c0: 766d 6170 0a0a 0a64 6566 2076 6d61 705f  vmap...def vmap_
-0000f6d0: 7379 6d62 6f6c 5f6d 6170 7065 7228 7379  symbol_mapper(sy
-0000f6e0: 6d62 6f6c 3a20 7072 696d 732e 5379 6d62  mbol: prims.Symb
-0000f6f0: 6f6c 2c20 2a2c 2061 7869 735f 7369 7a65  ol, *, axis_size
-0000f700: 3a20 696e 7429 3a0a 2020 2020 2222 224d  : int):.    """M
-0000f710: 6170 7320 6120 7379 6d62 6f6c 2074 6f20  aps a symbol to 
-0000f720: 6120 766d 6170 2066 756e 6374 696f 6e20  a vmap function 
-0000f730: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
-0000f740: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
-0000f750: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
-0000f760: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
-0000f770: 626f 6c20 746f 2065 7661 6c75 6174 652e  bol to evaluate.
-0000f780: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-0000f790: 2020 2020 2020 4e6f 7449 6d70 6c65 6d65        NotImpleme
-0000f7a0: 6e74 6564 4572 726f 723a 2049 6620 7468  ntedError: If th
-0000f7b0: 6520 766d 6170 2066 6f72 2074 6865 2073  e vmap for the s
-0000f7c0: 796d 626f 6c20 6973 206e 6f74 2069 6d70  ymbol is not imp
-0000f7d0: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
-0000f7e0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000f7f0: 4361 6c6c 6162 6c65 3a20 766d 6170 2066  Callable: vmap f
-0000f800: 756e 6374 696f 6e20 7468 6174 2065 7661  unction that eva
-0000f810: 6c75 6174 6573 2074 6865 2073 796d 626f  luates the symbo
-0000f820: 6c2e 0a20 2020 2022 2222 0a0a 2020 2020  l..    """..    
-0000f830: 6465 6620 7772 6170 5f61 7267 2878 293a  def wrap_arg(x):
-0000f840: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0000f850: 7374 616e 6365 2878 2c20 4261 7463 6865  stance(x, Batche
-0000f860: 6456 616c 7565 293a 0a20 2020 2020 2020  dValue):.       
-0000f870: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
-0000f880: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-0000f890: 7461 6e63 6528 782c 204e 756d 6265 7229  tance(x, Number)
-0000f8a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000f8b0: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
-0000f8c0: 6528 782c 206e 6f74 5f6d 6170 7065 6429  e(x, not_mapped)
-0000f8d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000f8e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000f8f0: 2056 616c 7565 4572 726f 7228 6622 766d   ValueError(f"vm
-0000f900: 6170 2077 7261 705f 6172 6720 676f 7420  ap wrap_arg got 
-0000f910: 616e 2075 6e73 7570 706f 7274 6564 2074  an unsupported t
-0000f920: 7970 6520 7b74 7970 6528 7829 7d22 290a  ype {type(x)}").
-0000f930: 0a20 2020 2069 6620 7379 6d62 6f6c 2e61  .    if symbol.a
-0000f940: 7265 5f61 6c6c 5f61 7267 735f 636f 6e73  re_all_args_cons
-0000f950: 7461 6e74 3a0a 0a20 2020 2020 2020 2064  tant:..        d
-0000f960: 6566 205f 766d 6170 5f69 6d70 6c5f 636f  ef _vmap_impl_co
-0000f970: 6e73 7428 7379 6d62 6f6c 2c20 2a61 7267  nst(symbol, *arg
-0000f980: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-0000f990: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-0000f9a0: 7379 6d62 6f6c 5f74 6f5f 6576 616c 2873  symbol_to_eval(s
-0000f9b0: 796d 626f 6c29 282a 6172 6773 2c20 2a2a  ymbol)(*args, **
-0000f9c0: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
-0000f9d0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0000f9e0: 6365 286f 7574 2c20 5365 7175 656e 6365  ce(out, Sequence
-0000f9f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000fa00: 2020 2072 6574 7572 6e20 7361 6665 5f6d     return safe_m
-0000fa10: 6170 2870 6169 725f 746f 5f62 6174 6368  ap(pair_to_batch
-0000fa20: 6564 5f76 616c 7565 2c20 7361 6665 5f7a  ed_value, safe_z
-0000fa30: 6970 2861 7267 732c 205b 6e6f 745f 6d61  ip(args, [not_ma
-0000fa40: 7070 6564 5d20 2a20 6c65 6e28 6f75 7429  pped] * len(out)
-0000fa50: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-0000fa60: 7265 7475 726e 2042 6174 6368 6564 5661  return BatchedVa
-0000fa70: 6c75 6528 6f75 742c 206e 6f74 5f6d 6170  lue(out, not_map
-0000fa80: 7065 6429 0a0a 2020 2020 2020 2020 7265  ped)..        re
-0000fa90: 7475 726e 2070 6172 7469 616c 285f 766d  turn partial(_vm
-0000faa0: 6170 5f69 6d70 6c5f 636f 6e73 742c 2073  ap_impl_const, s
-0000fab0: 796d 626f 6c29 0a0a 2020 2020 766d 6170  ymbol)..    vmap
-0000fac0: 5f69 6d70 6c20 3d20 766d 6170 5f69 6d70  _impl = vmap_imp
-0000fad0: 6c73 2e67 6574 2873 796d 626f 6c2e 7379  ls.get(symbol.sy
-0000fae0: 6d2e 6964 290a 2020 2020 6966 2076 6d61  m.id).    if vma
-0000faf0: 705f 696d 706c 2069 7320 4e6f 6e65 3a0a  p_impl is None:.
-0000fb00: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-0000fb10: 796d 626f 6c2e 7375 6273 796d 626f 6c73  ymbol.subsymbols
-0000fb20: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-0000fb30: 2020 2076 6d61 705f 696d 706c 203d 2070     vmap_impl = p
-0000fb40: 6172 7469 616c 2864 6563 6f6d 706f 7365  artial(decompose
-0000fb50: 645f 666e 5f76 6d61 705f 7275 6c65 2c20  d_fn_vmap_rule, 
-0000fb60: 666e 3d73 796d 626f 6c2e 7379 6d29 0a20  fn=symbol.sym). 
-0000fb70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000fb80: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
-0000fb90: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-0000fba0: 6f72 2866 2276 6d61 7020 666f 7220 7b73  or(f"vmap for {s
-0000fbb0: 796d 626f 6c2e 7379 6d2e 6964 7d20 6973  ymbol.sym.id} is
-0000fbc0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-0000fbd0: 2229 0a0a 2020 2020 6465 6620 5f76 6d61  ")..    def _vma
-0000fbe0: 705f 696d 706c 282a 6172 6773 2c20 2a2a  p_impl(*args, **
-0000fbf0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0000fc00: 2061 7267 7320 3d20 7472 6565 5f6d 6170   args = tree_map
-0000fc10: 2877 7261 705f 6172 672c 2061 7267 7329  (wrap_arg, args)
-0000fc20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0000fc30: 616c 6c28 6973 696e 7374 616e 6365 2861  all(isinstance(a
-0000fc40: 7267 2c20 4261 7463 6865 6456 616c 7565  rg, BatchedValue
-0000fc50: 2920 666f 7220 6172 6720 696e 2074 7265  ) for arg in tre
-0000fc60: 655f 666c 6174 7465 6e28 6172 6773 295b  e_flatten(args)[
-0000fc70: 305d 290a 2020 2020 2020 2020 7265 7475  0]).        retu
-0000fc80: 726e 2076 6d61 705f 696d 706c 2861 7869  rn vmap_impl(axi
-0000fc90: 735f 7369 7a65 2c20 2a61 7267 732c 202a  s_size, *args, *
-0000fca0: 2a6b 7761 7267 7329 0a0a 2020 2020 7265  *kwargs)..    re
-0000fcb0: 7475 726e 205f 766d 6170 5f69 6d70 6c0a  turn _vmap_impl.
-0000fcc0: 0a0a 6465 6620 7265 6d6f 7665 5f62 6174  ..def remove_bat
-0000fcd0: 6368 5f64 696d 2874 656e 736f 723a 2054  ch_dim(tensor: T
-0000fce0: 656e 736f 7250 726f 7879 2c20 6261 7463  ensorProxy, batc
-0000fcf0: 685f 6469 6d3a 2069 6e74 203d 2030 2920  h_dim: int = 0) 
-0000fd00: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
-0000fd10: 2020 2020 2222 2252 656d 6f76 6573 2074      """Removes t
-0000fd20: 6865 2062 6174 6368 2064 696d 656e 7369  he batch dimensi
-0000fd30: 6f6e 2066 726f 6d20 6120 7465 6e73 6f72  on from a tensor
-0000fd40: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-0000fd50: 2020 2020 2074 656e 736f 7220 2854 656e       tensor (Ten
-0000fd60: 736f 7250 726f 7879 293a 2054 656e 736f  sorProxy): Tenso
-0000fd70: 7220 746f 2072 656d 6f76 6520 7468 6520  r to remove the 
-0000fd80: 6261 7463 6820 6469 6d65 6e73 696f 6e20  batch dimension 
-0000fd90: 6672 6f6d 2e0a 0a20 2020 2052 6574 7572  from...    Retur
-0000fda0: 6e73 3a0a 2020 2020 2020 2020 5465 6e73  ns:.        Tens
-0000fdb0: 6f72 5072 6f78 793a 2054 656e 736f 7220  orProxy: Tensor 
-0000fdc0: 7769 7468 2074 6865 2062 6174 6368 2064  with the batch d
-0000fdd0: 696d 656e 7369 6f6e 2072 656d 6f76 6564  imension removed
-0000fde0: 2e0a 2020 2020 2222 220a 2020 2020 6e65  ..    """.    ne
-0000fdf0: 775f 7368 6170 6520 3d20 7465 6e73 6f72  w_shape = tensor
-0000fe00: 2e73 6861 7065 5b3a 6261 7463 685f 6469  .shape[:batch_di
-0000fe10: 6d5d 202b 2074 656e 736f 722e 7368 6170  m] + tensor.shap
-0000fe20: 655b 6261 7463 685f 6469 6d20 2b20 3120  e[batch_dim + 1 
-0000fe30: 3a5d 0a20 2020 2072 6574 7572 6e20 5465  :].    return Te
-0000fe40: 6e73 6f72 5072 6f78 7928 6c69 6b65 3d74  nsorProxy(like=t
-0000fe50: 656e 736f 722c 2073 6861 7065 3d6e 6577  ensor, shape=new
-0000fe60: 5f73 6861 7065 290a 0a0a 2320 544f 444f  _shape)...# TODO
-0000fe70: 3a20 696e 204a 4158 2061 7267 732c 2069  : in JAX args, i
-0000fe80: 6e5f 6469 6d73 2061 7265 2066 6c61 7474  n_dims are flatt
-0000fe90: 656e 6564 2074 6865 2073 616d 6520 7761  ened the same wa
-0000fea0: 790a 2320 544f 444f 3a20 696e 204a 4158  y.# TODO: in JAX
-0000feb0: 206f 7574 5f64 696d 7320 6172 6520 666c   out_dims are fl
-0000fec0: 6174 7465 6e65 6420 6173 2077 656c 6c0a  attened as well.
-0000fed0: 6465 6620 5f76 6d61 705f 6361 6c6c 5f6d  def _vmap_call_m
-0000fee0: 6574 6166 756e 6328 6465 7461 6368 6564  etafunc(detached
-0000fef0: 3a20 626f 6f6c 2c20 6172 6773 2c20 696e  : bool, args, in
-0000ff00: 5f64 696d 732c 206f 7574 5f64 696d 732c  _dims, out_dims,
-0000ff10: 2061 7869 735f 7369 7a65 2c20 6675 6e63   axis_size, func
-0000ff20: 7469 6f6e 5f74 7261 6365 3a20 5472 6163  tion_trace: Trac
-0000ff30: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
-0000ff40: 2020 2222 224d 6574 6166 756e 6374 696f    """Metafunctio
-0000ff50: 6e20 666f 7220 766d 6170 2063 616c 6c2e  n for vmap call.
-0000ff60: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0000ff70: 2020 2020 6465 7461 6368 6564 2028 626f      detached (bo
-0000ff80: 6f6c 293a 2057 6865 7468 6572 2074 6f20  ol): Whether to 
-0000ff90: 6465 7461 6368 2074 6865 2074 7261 6365  detach the trace
-0000ffa0: 2e0a 2020 2020 2020 2020 6172 6773 2028  ..        args (
-0000ffb0: 5475 706c 655b 5072 6f78 795d 293a 2041  Tuple[Proxy]): A
-0000ffc0: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-0000ffd0: 6675 6e63 7469 6f6e 2e0a 2020 2020 2020  function..      
-0000ffe0: 2020 696e 5f64 696d 7320 2854 7570 6c65    in_dims (Tuple
-0000fff0: 5b69 6e74 5d29 3a20 4261 7463 6820 6469  [int]): Batch di
-00010000: 6d65 6e73 696f 6e20 666f 7220 6561 6368  mension for each
-00010010: 2061 7267 756d 656e 742e 0a20 2020 2020   argument..     
-00010020: 2020 206f 7574 5f64 696d 7320 2854 7570     out_dims (Tup
-00010030: 6c65 5b69 6e74 5d29 3a20 4261 7463 6820  le[int]): Batch 
-00010040: 6469 6d65 6e73 696f 6e20 666f 7220 7265  dimension for re
-00010050: 7475 726e 2076 616c 7565 732e 0a20 2020  turn values..   
-00010060: 2020 2020 2066 756e 6374 696f 6e5f 7472       function_tr
-00010070: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
-00010080: 6365 2074 6f20 7573 6520 666f 7220 7468  ce to use for th
-00010090: 6520 6675 6e63 7469 6f6e 2e0a 2020 2020  e function..    
-000100a0: 2020 2020 6b77 6172 6773 3a20 4b65 7977      kwargs: Keyw
-000100b0: 6f72 6420 6172 6775 6d65 6e74 732e 0a0a  ord arguments...
-000100c0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-000100d0: 2020 2020 4173 7365 7274 696f 6e45 7272      AssertionErr
-000100e0: 6f72 3a20 4966 2074 6865 2076 6d61 7020  or: If the vmap 
-000100f0: 666f 7220 6b65 7977 6f72 6420 6172 6775  for keyword argu
-00010100: 6d65 6e74 7320 6973 206e 6f74 2069 6d70  ments is not imp
-00010110: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
-00010120: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00010130: 5265 7375 6c74 206f 6620 7468 6520 766d  Result of the vm
-00010140: 6170 2074 7261 6e73 666f 726d 2e0a 2020  ap transform..  
-00010150: 2020 2222 220a 2020 2020 636f 6d6d 6f6e    """.    common
-00010160: 5f64 6576 6963 6520 3d20 7b78 2e64 6576  _device = {x.dev
-00010170: 6963 6520 666f 7220 7820 696e 2061 7267  ice for x in arg
-00010180: 7320 6966 2069 7369 6e73 7461 6e63 6528  s if isinstance(
-00010190: 782c 2054 656e 736f 7250 726f 7879 297d  x, TensorProxy)}
-000101a0: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
-000101b0: 636f 6d6d 6f6e 5f64 6576 6963 6529 203c  common_device) <
-000101c0: 3d20 312c 2022 766d 6170 2066 6f72 206d  = 1, "vmap for m
-000101d0: 756c 7469 706c 6520 6465 7669 6365 7320  ultiple devices 
-000101e0: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-000101f0: 6564 220a 2020 2020 2863 6f6d 6d6f 6e5f  ed".    (common_
-00010200: 6465 7669 6365 2c29 203d 2063 6f6d 6d6f  device,) = commo
-00010210: 6e5f 6465 7669 6365 2069 6620 6c65 6e28  n_device if len(
-00010220: 636f 6d6d 6f6e 5f64 6576 6963 6529 203d  common_device) =
-00010230: 3d20 3120 656c 7365 2028 6370 752c 290a  = 1 else (cpu,).
-00010240: 0a20 2020 2069 6620 6178 6973 5f73 697a  .    if axis_siz
-00010250: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-00010260: 2020 2028 6178 6973 5f73 697a 652c 2920     (axis_size,) 
-00010270: 3d20 7b78 2e73 6861 7065 5b61 785d 2066  = {x.shape[ax] f
-00010280: 6f72 2078 2c20 6178 2069 6e20 7a69 7028  or x, ax in zip(
-00010290: 6172 6773 2c20 696e 5f64 696d 7329 2069  args, in_dims) i
-000102a0: 6620 6178 2069 7320 6e6f 7420 6e6f 745f  f ax is not not_
-000102b0: 6d61 7070 6564 7d0a 2020 2020 696e 5f64  mapped}.    in_d
-000102c0: 696d 7320 3d20 696e 5f64 696d 7320 6966  ims = in_dims if
-000102d0: 2069 7369 6e73 7461 6e63 6528 696e 5f64   isinstance(in_d
-000102e0: 696d 732c 2053 6571 7565 6e63 6529 2065  ims, Sequence) e
-000102f0: 6c73 6520 2869 6e5f 6469 6d73 2c29 0a20  lse (in_dims,). 
-00010300: 2020 2069 6e5f 6469 6d73 203d 2074 7570     in_dims = tup
-00010310: 6c65 286e 6f74 5f6d 6170 7065 6420 6966  le(not_mapped if
-00010320: 2069 7369 6e73 7461 6e63 6528 612c 204e   isinstance(a, N
-00010330: 756d 6265 7229 2065 6c73 6520 6420 666f  umber) else d fo
-00010340: 7220 612c 2064 2069 6e20 7361 6665 5f7a  r a, d in safe_z
-00010350: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
-00010360: 2929 0a20 2020 206f 7574 5f64 696d 7320  )).    out_dims 
-00010370: 3d20 6f75 745f 6469 6d73 2069 6620 6973  = out_dims if is
-00010380: 696e 7374 616e 6365 286f 7574 5f64 696d  instance(out_dim
-00010390: 732c 2053 6571 7565 6e63 6529 2065 6c73  s, Sequence) els
-000103a0: 6520 286f 7574 5f64 696d 732c 290a 0a20  e (out_dims,).. 
-000103b0: 2020 2063 7478 203d 2064 6574 6163 6865     ctx = detache
-000103c0: 645f 7472 6163 6528 2920 6966 2064 6574  d_trace() if det
-000103d0: 6163 6865 6420 656c 7365 206e 756c 6c63  ached else nullc
-000103e0: 6f6e 7465 7874 2829 0a20 2020 2077 6974  ontext().    wit
-000103f0: 6820 6374 783a 0a20 2020 2020 2020 2023  h ctx:.        #
-00010400: 2057 6520 7072 6f70 6167 6174 6520 7468   We propagate th
-00010410: 6520 4261 7463 6856 616c 7565 2074 6872  e BatchValue thr
-00010420: 6f75 6768 2074 6865 2074 7261 6365 2c20  ough the trace, 
-00010430: 616e 6420 7468 656e 2075 6e77 7261 7020  and then unwrap 
-00010440: 6974 2061 7420 7468 6520 656e 640a 2020  it at the end.  
-00010450: 2020 2020 2020 6261 7463 6865 645f 6172        batched_ar
-00010460: 6773 203d 2073 6166 655f 6d61 7028 7061  gs = safe_map(pa
-00010470: 6972 5f74 6f5f 6261 7463 6865 645f 7661  ir_to_batched_va
-00010480: 6c75 652c 2073 6166 655f 7a69 7028 6172  lue, safe_zip(ar
-00010490: 6773 2c20 696e 5f64 696d 7329 290a 2020  gs, in_dims)).  
-000104a0: 2020 2020 2020 7265 7375 6c74 203d 2065        result = e
-000104b0: 7661 6c5f 7472 6163 6528 0a20 2020 2020  val_trace(.     
-000104c0: 2020 2020 2020 2066 756e 6374 696f 6e5f         function_
-000104d0: 7472 6163 652c 202a 6261 7463 6865 645f  trace, *batched_
-000104e0: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
-000104f0: 7065 723d 7061 7274 6961 6c28 766d 6170  per=partial(vmap
-00010500: 5f73 796d 626f 6c5f 6d61 7070 6572 2c20  _symbol_mapper, 
-00010510: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
-00010520: 697a 6529 2c20 2a2a 6b77 6172 6773 0a20  ize), **kwargs. 
-00010530: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010540: 2023 2055 6e77 7261 7070 696e 6720 7468   # Unwrapping th
-00010550: 6520 4261 7463 6865 6456 616c 7565 2773  e BatchedValue's
-00010560: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00010570: 7374 616e 6365 2872 6573 756c 742c 2053  stance(result, S
-00010580: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-00010590: 2020 2020 2020 666c 6174 5f72 6573 756c        flat_resul
-000105a0: 742c 2073 7065 6320 3d20 7472 6565 5f66  t, spec = tree_f
-000105b0: 6c61 7474 656e 2872 6573 756c 7429 0a20  latten(result). 
-000105c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000105d0: 7420 616c 6c28 6973 696e 7374 616e 6365  t all(isinstance
-000105e0: 2878 2c20 4261 7463 6865 6456 616c 7565  (x, BatchedValue
-000105f0: 2920 666f 7220 7820 696e 2066 6c61 745f  ) for x in flat_
-00010600: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
-00010610: 2020 2020 6f75 7473 2c20 6264 696d 7320      outs, bdims 
-00010620: 3d20 756e 7a69 7032 2866 6c61 745f 7265  = unzip2(flat_re
-00010630: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-00010640: 2020 2320 544f 444f 3a20 6861 6e64 6c65    # TODO: handle
-00010650: 2074 6865 2063 6173 6520 7768 6572 6520   the case where 
-00010660: 6f75 745f 6469 6d73 2069 7320 6120 7369  out_dims is a si
-00010670: 6e67 6c65 2076 616c 7565 2062 6574 7465  ngle value bette
-00010680: 720a 2020 2020 2020 2020 2020 2020 6966  r.            if
-00010690: 206c 656e 286f 7574 5f64 696d 7329 203d   len(out_dims) =
-000106a0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-000106b0: 2020 2020 206f 7574 5f64 696d 7320 3d20       out_dims = 
-000106c0: 6f75 745f 6469 6d73 202a 206c 656e 286f  out_dims * len(o
-000106d0: 7574 7329 0a20 2020 2020 2020 2020 2020  uts).           
-000106e0: 206f 7574 7320 3d20 7361 6665 5f6d 6170   outs = safe_map
-000106f0: 2870 6172 7469 616c 286d 6f76 655f 6261  (partial(move_ba
-00010700: 7463 685f 6469 6d2c 2061 7869 735f 7369  tch_dim, axis_si
-00010710: 7a65 292c 2062 6469 6d73 2c20 6f75 745f  ze), bdims, out_
-00010720: 6469 6d73 2c20 6f75 7473 290a 2020 2020  dims, outs).    
-00010730: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-00010740: 7265 655f 756e 666c 6174 7465 6e28 6f75  ree_unflatten(ou
-00010750: 7473 2c20 7370 6563 290a 2020 2020 2020  ts, spec).      
-00010760: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00010770: 7265 7375 6c74 2c20 4e75 6d62 6572 2920  result, Number) 
-00010780: 616e 6420 6178 6973 5f73 697a 6520 6973  and axis_size is
-00010790: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000107a0: 2020 2020 2020 2023 2054 4f44 4f3a 2066         # TODO: f
-000107b0: 6574 6368 2074 6865 2064 6566 6175 6c74  etch the default
-000107c0: 2064 6576 6963 6520 6672 6f6d 2074 6865   device from the
-000107d0: 2063 6f6e 7465 7874 0a20 2020 2020 2020   context.       
-000107e0: 2020 2020 2072 6573 756c 7420 3d20 6675       result = fu
-000107f0: 6c6c 2873 6861 7065 3d28 292c 2066 696c  ll(shape=(), fil
-00010800: 6c5f 7661 6c75 653d 7265 7375 6c74 2c20  l_value=result, 
-00010810: 6465 7669 6365 3d63 6f6d 6d6f 6e5f 6465  device=common_de
-00010820: 7669 6365 290a 2020 2020 2020 2020 2020  vice).          
-00010830: 2020 7265 7375 6c74 203d 2042 6174 6368    result = Batch
-00010840: 6564 5661 6c75 6528 7265 7375 6c74 2c20  edValue(result, 
-00010850: 6e6f 745f 6d61 7070 6564 290a 2020 2020  not_mapped).    
-00010860: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00010870: 6e63 6528 7265 7375 6c74 2c20 4261 7463  nce(result, Batc
-00010880: 6865 6456 616c 7565 2920 616e 6420 6973  hedValue) and is
-00010890: 696e 7374 616e 6365 2872 6573 756c 742e  instance(result.
-000108a0: 7661 6c75 652c 204e 756d 6265 7229 2061  value, Number) a
-000108b0: 6e64 2061 7869 735f 7369 7a65 2069 7320  nd axis_size is 
-000108c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000108d0: 2020 2020 2020 7265 7375 6c74 203d 2042        result = B
-000108e0: 6174 6368 6564 5661 6c75 6528 6675 6c6c  atchedValue(full
-000108f0: 2873 6861 7065 3d28 292c 2066 696c 6c5f  (shape=(), fill_
-00010900: 7661 6c75 653d 7265 7375 6c74 2e76 616c  value=result.val
-00010910: 7565 2c20 6465 7669 6365 3d63 6f6d 6d6f  ue, device=commo
-00010920: 6e5f 6465 7669 6365 292c 2072 6573 756c  n_device), resul
-00010930: 742e 6261 7463 685f 6469 6d29 0a20 2020  t.batch_dim).   
-00010940: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00010950: 7374 616e 6365 2872 6573 756c 742c 2042  stance(result, B
-00010960: 6174 6368 6564 5661 6c75 6529 0a20 2020  atchedValue).   
-00010970: 2020 2020 206f 7574 203d 206d 6f76 655f       out = move_
-00010980: 6261 7463 685f 6469 6d28 6178 6973 5f73  batch_dim(axis_s
-00010990: 697a 652c 2072 6573 756c 742e 6261 7463  ize, result.batc
-000109a0: 685f 6469 6d2c 206f 7574 5f64 696d 735b  h_dim, out_dims[
-000109b0: 305d 2c20 7265 7375 6c74 2e76 616c 7565  0], result.value
-000109c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000109d0: 206f 7574 0a0a 0a76 6d61 705f 6361 6c6c   out...vmap_call
-000109e0: 203d 2053 796d 626f 6c28 6964 3d54 7261   = Symbol(id=Tra
-000109f0: 6e73 666f 726d 732e 566d 6170 4f70 2c20  nsforms.VmapOp, 
-00010a00: 6e61 6d65 3d22 766d 6170 5f63 616c 6c22  name="vmap_call"
-00010a10: 2c20 6d65 7461 3d70 6172 7469 616c 285f  , meta=partial(_
-00010a20: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
-00010a30: 6e63 2c20 4661 6c73 6529 290a 0a0a 2320  nc, False))...# 
-00010a40: 544f 444f 3a20 686f 7720 7368 6f75 6c64  TODO: how should
-00010a50: 2077 6520 6861 6e64 6c65 206f 7574 5f64   we handle out_d
-00010a60: 696d 7320 6865 7265 3f0a 2320 616c 7468  ims here?.# alth
-00010a70: 6f75 6768 2068 6572 6520 7765 2061 7265  ough here we are
-00010a80: 2063 616c 6c69 6e67 2076 6d61 7020 6f66   calling vmap of
-00010a90: 2069 6465 6e74 6974 792c 2073 6f20 7765   identity, so we
-00010aa0: 2073 686f 756c 6420 6b6e 6f77 2066 726f   should know fro
-00010ab0: 6d20 7468 6520 6361 6c6c 2074 6f20 766d  m the call to vm
-00010ac0: 6170 0a23 2054 6869 7320 7368 6f75 6c64  ap.# This should
-00010ad0: 2062 6520 6669 6e65 2e20 4966 2077 6520   be fine. If we 
-00010ae0: 6861 7665 2076 6d61 7028 6964 656e 7469  have vmap(identi
-00010af0: 7479 2866 756e 6329 2c20 6f75 745f 6469  ty(func), out_di
-00010b00: 6d73 3d4e 2920 7468 656e 2074 6869 7320  ms=N) then this 
-00010b10: 7275 6c65 2069 7320 6669 7273 7420 7573  rule is first us
-00010b20: 6564 0a23 2074 6f20 6765 7420 7468 6520  ed.# to get the 
-00010b30: 766d 6170 7065 6420 7265 7375 6c74 206f  vmapped result o
-00010b40: 6620 6964 656e 7469 7479 2866 756e 6329  f identity(func)
-00010b50: 2069 6e20 766d 6170 5f73 796d 626f 6c5f   in vmap_symbol_
-00010b60: 6d61 7070 6572 2c20 616e 6420 6f75 745f  mapper, and out_
-00010b70: 6469 6d73 2069 7320 6861 6e64 6c65 640a  dims is handled.
-00010b80: 2320 6166 7465 7220 7468 6174 2069 6e20  # after that in 
-00010b90: 7468 6520 6f75 7465 7220 5f76 6d61 705f  the outer _vmap_
-00010ba0: 6361 6c6c 5f6d 6574 6166 756e 632e 0a64  call_metafunc..d
-00010bb0: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
-00010bc0: 6c5f 766d 6170 2861 7869 735f 7369 7a65  l_vmap(axis_size
-00010bd0: 2c20 2a62 6174 6368 6564 5f61 7267 732c  , *batched_args,
-00010be0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-00010bf0: 2a6b 7761 7267 7329 3a0a 2020 2020 6172  *kwargs):.    ar
-00010c00: 6773 2c20 696e 5f64 696d 7320 3d20 756e  gs, in_dims = un
-00010c10: 7a69 7032 2862 6174 6368 6564 5f61 7267  zip2(batched_arg
-00010c20: 7329 0a20 2020 206f 7574 5f64 696d 7320  s).    out_dims 
-00010c30: 3d20 3020 2023 2046 6978 6d65 0a20 2020  = 0  # Fixme.   
-00010c40: 206f 7574 732c 206f 7574 5f64 696d 7320   outs, out_dims 
-00010c50: 3d20 5f76 6d61 705f 6361 6c6c 5f6d 6574  = _vmap_call_met
-00010c60: 6166 756e 6328 4661 6c73 652c 2061 7267  afunc(False, arg
-00010c70: 732c 2069 6e5f 6469 6d73 2c20 6f75 745f  s, in_dims, out_
-00010c80: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
-00010c90: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
-00010ca0: 7472 6163 652c 202a 2a6b 7761 7267 7329  trace, **kwargs)
-00010cb0: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00010cc0: 6365 286f 7574 732c 2053 6571 7565 6e63  ce(outs, Sequenc
-00010cd0: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00010ce0: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
-00010cf0: 5f74 6f5f 6261 7463 6865 645f 7661 6c75  _to_batched_valu
-00010d00: 652c 2073 6166 655f 7a69 7028 6f75 7473  e, safe_zip(outs
-00010d10: 2c20 6f75 745f 6469 6d73 2929 0a20 2020  , out_dims)).   
-00010d20: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
-00010d30: 616c 7565 286f 7574 732c 206f 7574 5f64  alue(outs, out_d
-00010d40: 696d 7329 0a0a 0a76 6d61 705f 696d 706c  ims)...vmap_impl
-00010d50: 735b 5472 616e 7366 6f72 6d73 2e49 6465  s[Transforms.Ide
-00010d60: 6e74 6974 794f 705d 203d 205f 6964 656e  ntityOp] = _iden
-00010d70: 7469 7479 5f63 616c 6c5f 766d 6170 0a0a  tity_call_vmap..
-00010d80: 0a64 6566 205f 6a76 705f 6361 6c6c 5f76  .def _jvp_call_v
-00010d90: 6d61 7028 6178 6973 5f73 697a 652c 2062  map(axis_size, b
-00010da0: 6174 6368 6564 5f70 7269 6d61 6c73 2c20  atched_primals, 
-00010db0: 6261 7463 6865 645f 7461 6e67 656e 7473  batched_tangents
-00010dc0: 2c20 2a2c 2066 756e 6374 696f 6e5f 7472  , *, function_tr
-00010dd0: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-00010de0: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
-00010df0: 6c73 2c20 7072 696d 616c 735f 6264 696d  ls, primals_bdim
-00010e00: 7320 3d20 7361 6665 5f7a 6970 282a 6261  s = safe_zip(*ba
-00010e10: 7463 6865 645f 7072 696d 616c 7329 0a20  tched_primals). 
-00010e20: 2020 2074 616e 6765 6e74 732c 2074 616e     tangents, tan
-00010e30: 6765 6e74 735f 6264 696d 7320 3d20 7361  gents_bdims = sa
-00010e40: 6665 5f7a 6970 282a 6261 7463 6865 645f  fe_zip(*batched_
-00010e50: 7461 6e67 656e 7473 290a 2020 2020 6a76  tangents).    jv
-00010e60: 705f 6675 6e63 203d 2070 6172 7469 616c  p_func = partial
-00010e70: 285f 6a76 705f 6361 6c6c 5f6d 6574 6166  (_jvp_call_metaf
-00010e80: 756e 632c 2046 616c 7365 2c20 6675 6e63  unc, False, func
-00010e90: 7469 6f6e 5f74 7261 6365 3d66 756e 6374  tion_trace=funct
-00010ea0: 696f 6e5f 7472 6163 6529 0a20 2020 2076  ion_trace).    v
-00010eb0: 6d61 7070 6564 5f6a 7670 5f66 756e 6320  mapped_jvp_func 
-00010ec0: 3d20 766d 6170 286a 7670 5f66 756e 632c  = vmap(jvp_func,
-00010ed0: 2069 6e5f 6469 6d73 3d28 7072 696d 616c   in_dims=(primal
-00010ee0: 735f 6264 696d 732c 2074 616e 6765 6e74  s_bdims, tangent
-00010ef0: 735f 6264 696d 7329 2c20 6178 6973 5f73  s_bdims), axis_s
-00010f00: 697a 653d 6178 6973 5f73 697a 6529 0a20  ize=axis_size). 
-00010f10: 2020 2072 6573 756c 7420 3d20 766d 6170     result = vmap
-00010f20: 7065 645f 6a76 705f 6675 6e63 2870 7269  ped_jvp_func(pri
-00010f30: 6d61 6c73 2c20 7461 6e67 656e 7473 2c20  mals, tangents, 
-00010f40: 2a2a 6b77 6172 6773 290a 2020 2020 7265  **kwargs).    re
-00010f50: 7475 726e 2074 7265 655f 6d61 7028 6c61  turn tree_map(la
-00010f60: 6d62 6461 2078 3a20 4261 7463 6865 6456  mbda x: BatchedV
-00010f70: 616c 7565 2878 2c20 3029 2c20 7265 7375  alue(x, 0), resu
-00010f80: 6c74 290a 0a0a 766d 6170 5f69 6d70 6c73  lt)...vmap_impls
-00010f90: 5b54 7261 6e73 666f 726d 732e 4a76 704f  [Transforms.JvpO
-00010fa0: 705d 203d 205f 6a76 705f 6361 6c6c 5f76  p] = _jvp_call_v
-00010fb0: 6d61 700a 0a0a 6465 6620 766d 6170 2866  map...def vmap(f
-00010fc0: 756e 632c 2069 6e5f 6469 6d73 3d30 2c20  unc, in_dims=0, 
-00010fd0: 6f75 745f 6469 6d73 3d30 2c20 6178 6973  out_dims=0, axis
-00010fe0: 5f73 697a 653d 4e6f 6e65 293a 0a20 2020  _size=None):.   
-00010ff0: 2022 2222 5665 6374 6f72 697a 696e 6720   """Vectorizing 
-00011000: 7472 616e 7366 6f72 6d20 666f 7220 6120  transform for a 
-00011010: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
-00011020: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00011030: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
-00011040: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
-00011050: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
-00011060: 7261 6e73 666f 726d 6564 2e0a 0a20 2020  ransformed...   
-00011070: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00011080: 2020 4361 6c6c 6162 6c65 3a20 4120 766d    Callable: A vm
-00011090: 6170 7065 6420 7665 7273 696f 6e20 6f66  apped version of
-000110a0: 2074 6865 2066 756e 6374 696f 6e2e 0a20   the function.. 
-000110b0: 2020 2022 2222 0a0a 2020 2020 2320 544f     """..    # TO
-000110c0: 444f 3a20 666c 6174 7465 6e0a 2020 2020  DO: flatten.    
-000110d0: 2320 496e 204a 4158 2066 6c61 7474 656e  # In JAX flatten
-000110e0: 696e 6720 6f66 2069 6e5f 6469 6d73 2069  ing of in_dims i
-000110f0: 7320 7261 7468 6572 2063 6f6d 706c 6963  s rather complic
-00011100: 6174 6564 2062 6563 6175 7365 2069 7420  ated because it 
-00011110: 6361 6e20 6f70 7469 6f6e 616c 6c79 2062  can optionally b
-00011120: 650a 2020 2020 2320 7370 6563 6966 6965  e.    # specifie
-00011130: 6420 6173 2061 20e2 809c 7072 6566 6978  d as a ...prefix
-00011140: e280 9d20 7079 7472 6565 2c20 6d65 616e  ... pytree, mean
-00011150: 696e 6720 7468 6174 2061 2073 696e 676c  ing that a singl
-00011160: 6520 6c65 6166 2076 616c 7565 2063 616e  e leaf value can
-00011170: 2062 6520 6170 706c 6965 640a 2020 2020   be applied.    
-00011180: 2320 746f 2061 6e20 656e 7469 7265 2073  # to an entire s
-00011190: 7562 2d70 7974 7265 652e 0a0a 2020 2020  ub-pytree...    
-000111a0: 6465 6620 666c 6174 7465 6e5f 6675 6e63  def flatten_func
-000111b0: 5f66 6f72 5f76 6d61 7028 6675 6e63 2c20  _for_vmap(func, 
-000111c0: 6172 6773 2c20 6b77 6172 6773 293a 0a20  args, kwargs):. 
-000111d0: 2020 2020 2020 2066 6c61 745f 6172 6773         flat_args
-000111e0: 2c20 7370 6563 203d 2074 7265 655f 666c  , spec = tree_fl
-000111f0: 6174 7465 6e28 2861 7267 732c 206b 7761  atten((args, kwa
-00011200: 7267 7329 290a 0a20 2020 2020 2020 2064  rgs))..        d
-00011210: 6566 2066 6c61 745f 6675 6e63 282a 666c  ef flat_func(*fl
-00011220: 6174 5f61 7267 7329 3a0a 2020 2020 2020  at_args):.      
-00011230: 2020 2020 2020 666e 5f61 7267 732c 2066        fn_args, f
-00011240: 6e5f 6b77 6172 6773 203d 2074 7265 655f  n_kwargs = tree_
-00011250: 756e 666c 6174 7465 6e28 666c 6174 5f61  unflatten(flat_a
-00011260: 7267 732c 2073 7065 6329 0a20 2020 2020  rgs, spec).     
-00011270: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
-00011280: 6e63 282a 666e 5f61 7267 732c 202a 2a66  nc(*fn_args, **f
-00011290: 6e5f 6b77 6172 6773 290a 0a20 2020 2020  n_kwargs)..     
-000112a0: 2020 2072 6574 7572 6e20 666c 6174 5f66     return flat_f
-000112b0: 756e 632c 2066 6c61 745f 6172 6773 2c20  unc, flat_args, 
-000112c0: 7370 6563 0a0a 2020 2020 6465 6620 7772  spec..    def wr
-000112d0: 6170 7065 7228 2a61 7267 732c 202a 2a6b  apper(*args, **k
-000112e0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-000112f0: 6675 6e63 5f66 6c61 742c 2061 7267 735f  func_flat, args_
-00011300: 666c 6174 2c20 6172 6773 5f73 7065 6320  flat, args_spec 
-00011310: 3d20 666c 6174 7465 6e5f 6675 6e63 5f66  = flatten_func_f
-00011320: 6f72 5f76 6d61 7028 6675 6e63 2c20 6172  or_vmap(func, ar
-00011330: 6773 2c20 6b77 6172 6773 290a 2020 2020  gs, kwargs).    
-00011340: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00011350: 6528 696e 5f64 696d 732c 2069 6e74 293a  e(in_dims, int):
-00011360: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
-00011370: 6469 6d73 5f66 6c61 7420 3d20 2869 6e5f  dims_flat = (in_
-00011380: 6469 6d73 2c29 202a 206c 656e 2861 7267  dims,) * len(arg
-00011390: 735f 666c 6174 290a 2020 2020 2020 2020  s_flat).        
-000113a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000113b0: 2020 696e 5f64 696d 735f 666c 6174 2c20    in_dims_flat, 
-000113c0: 696e 5f64 696d 735f 7370 6563 203d 2074  in_dims_spec = t
-000113d0: 7265 655f 666c 6174 7465 6e28 696e 5f64  ree_flatten(in_d
-000113e0: 696d 7329 0a20 2020 2020 2020 2020 2020  ims).           
-000113f0: 2061 7373 6572 7420 6c65 6e28 696e 5f64   assert len(in_d
-00011400: 696d 735f 666c 6174 2920 3d3d 206c 656e  ims_flat) == len
-00011410: 2861 7267 735f 666c 6174 292c 2022 696e  (args_flat), "in
-00011420: 5f64 696d 7320 6d75 7374 2068 6176 6520  _dims must have 
-00011430: 7468 6520 7361 6d65 206c 656e 6774 6820  the same length 
-00011440: 6173 2061 7267 732c 206b 7761 7267 7322  as args, kwargs"
-00011450: 0a20 2020 2020 2020 2075 6e62 6174 6368  .        unbatch
-00011460: 6564 5f61 7267 735f 666c 6174 203d 205b  ed_args_flat = [
-00011470: 7265 6d6f 7665 5f62 6174 6368 5f64 696d  remove_batch_dim
-00011480: 2861 7267 2920 6966 2069 7369 6e73 7461  (arg) if isinsta
-00011490: 6e63 6528 6172 672c 2054 656e 736f 7250  nce(arg, TensorP
-000114a0: 726f 7879 2920 656c 7365 2061 7267 2066  roxy) else arg f
-000114b0: 6f72 2061 7267 2069 6e20 6172 6773 5f66  or arg in args_f
-000114c0: 6c61 745d 0a20 2020 2020 2020 2074 7261  lat].        tra
-000114d0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-000114e0: 7261 6365 2829 2866 756e 635f 666c 6174  race()(func_flat
-000114f0: 2c20 2a75 6e62 6174 6368 6564 5f61 7267  , *unbatched_arg
-00011500: 735f 666c 6174 290a 2020 2020 2020 2020  s_flat).        
-00011510: 6f75 7473 203d 2076 6d61 705f 6361 6c6c  outs = vmap_call
-00011520: 2861 7267 735f 666c 6174 2c20 696e 5f64  (args_flat, in_d
-00011530: 696d 735f 666c 6174 2c20 6f75 745f 6469  ims_flat, out_di
-00011540: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
-00011550: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
-00011560: 6e5f 7472 6163 653d 7472 6163 6529 0a20  n_trace=trace). 
-00011570: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-00011580: 7473 0a0a 2020 2020 7265 7475 726e 2077  ts..    return w
-00011590: 7261 7070 6572 0a0a 0a23 2054 4f44 4f20  rapper...# TODO 
-000115a0: 5468 6973 2066 756e 6374 696f 6e20 636f  This function co
-000115b0: 6d6d 656e 7465 6420 6f75 7420 6265 6361  mmented out beca
-000115c0: 7573 6520 6974 2063 616c 6c73 206d 616b  use it calls mak
-000115d0: 655f 7472 6163 6564 2c20 7768 6963 6820  e_traced, which 
-000115e0: 646f 6573 206e 6f74 2065 7869 7374 0a23  does not exist.#
-000115f0: 2064 6566 2076 6d61 705f 6561 6765 7228   def vmap_eager(
-00011600: 6675 6e63 2c20 6172 6773 2c20 696e 5f64  func, args, in_d
-00011610: 696d 733d 302c 206f 7574 5f64 696d 733d  ims=0, out_dims=
-00011620: 302c 2061 7869 735f 7369 7a65 3d4e 6f6e  0, axis_size=Non
-00011630: 652c 2065 7865 6375 746f 723d 2274 6f72  e, executor="tor
-00011640: 6368 2229 3a0a 2320 2020 2020 2222 2243  ch"):.#     """C
-00011650: 6f6d 7075 7465 7320 7468 6520 766d 6170  omputes the vmap
-00011660: 206f 6620 6120 5468 756e 6465 7220 6675   of a Thunder fu
-00011670: 6e63 7469 6f6e 2e0a 0a23 2020 2020 2041  nction...#     A
-00011680: 7267 733a 0a23 2020 2020 2020 2020 2066  rgs:.#         f
-00011690: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
-000116a0: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
-000116b0: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
-000116c0: 726d 6564 2e0a 2320 2020 2020 2020 2020  rmed..#         
-000116d0: 6172 6773 2028 5f74 7970 655f 293a 2041  args (_type_): A
-000116e0: 7267 7320 6f66 2074 6865 2066 756e 6374  rgs of the funct
-000116f0: 696f 6e2e 0a23 2020 2020 2020 2020 2065  ion..#         e
-00011700: 7865 6375 746f 7220 2873 7472 2c20 6f70  xecutor (str, op
-00011710: 7469 6f6e 616c 293a 2045 7865 6375 746f  tional): Executo
-00011720: 7220 746f 2075 7365 2e20 4465 6661 756c  r to use. Defaul
-00011730: 7473 2074 6f20 2274 6f72 6368 222e 0a0a  ts to "torch"...
-00011740: 2320 2020 2020 5265 7475 726e 733a 0a23  #     Returns:.#
-00011750: 2020 2020 2020 2020 2054 6865 2072 6573           The res
-00011760: 756c 7420 6f66 2074 6865 2076 6d61 7070  ult of the vmapp
-00011770: 6564 2066 756e 6374 696f 6e2e 0a23 2020  ed function..#  
-00011780: 2020 2022 2222 0a23 2020 2020 2023 2054     """.#     # T
-00011790: 4f44 4f3a 2066 6978 2074 6869 7320 2d20  ODO: fix this - 
-000117a0: 6e6f 7420 616c 6c20 6172 6773 206d 6179  not all args may
-000117b0: 2062 6520 6261 7463 6865 640a 2320 2020   be batched.#   
-000117c0: 2020 2320 544f 444f 3a20 6865 7265 2077    # TODO: here w
-000117d0: 6520 6173 7375 6d65 2062 6174 6368 2061  e assume batch a
-000117e0: 7869 7320 6973 2030 0a23 2020 2020 2076  xis is 0.#     v
-000117f0: 6d61 705f 7472 6163 6520 3d20 6d61 6b65  map_trace = make
-00011800: 5f74 7261 6365 280a 2320 2020 2020 2020  _trace(.#       
-00011810: 2020 766d 6170 2866 756e 632c 2069 6e5f    vmap(func, in_
-00011820: 6469 6d73 3d69 6e5f 6469 6d73 2c20 6f75  dims=in_dims, ou
-00011830: 745f 6469 6d73 3d6f 7574 5f64 696d 732c  t_dims=out_dims,
-00011840: 2061 7869 735f 7369 7a65 3d61 7869 735f   axis_size=axis_
-00011850: 7369 7a65 292c 2065 7865 6375 746f 723d  size), executor=
-00011860: 6578 6563 7574 6f72 2c0a 2320 2020 2020  executor,.#     
-00011870: 2020 2020 2a61 7267 7329 0a23 2020 2020      *args).#    
-00011880: 2076 6d61 705f 7472 6163 6564 203d 206d   vmap_traced = m
-00011890: 616b 655f 7472 6163 6564 2870 6172 7469  ake_traced(parti
-000118a0: 616c 2865 7661 6c5f 7472 6163 652c 2076  al(eval_trace, v
-000118b0: 6d61 705f 7472 6163 6529 2c20 6578 6563  map_trace), exec
-000118c0: 7574 6f72 3d65 7865 6375 746f 7229 0a23  utor=executor).#
-000118d0: 2020 2020 2072 6574 7572 6e20 766d 6170       return vmap
-000118e0: 5f74 7261 6365 6428 2a61 7267 7329 0a0a  _traced(*args)..
-000118f0: 0a23 204a 5650 2074 7261 6e73 666f 726d  .# JVP transform
-00011900: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  .# -------------
-00011910: 0a0a 0a40 6461 7461 636c 6173 7328 6672  ...@dataclass(fr
-00011920: 6f7a 656e 3d54 7275 6529 0a63 6c61 7373  ozen=True).class
-00011930: 204a 5650 4475 616c 3a0a 2020 2020 2222   JVPDual:.    ""
-00011940: 2244 7561 6c20 6e75 6d62 6572 2066 6f72  "Dual number for
-00011950: 2074 6865 204a 5650 2074 7261 6e73 666f   the JVP transfo
-00011960: 726d 2e0a 0a20 2020 2041 7474 7269 6275  rm...    Attribu
-00011970: 7465 733a 0a20 2020 2020 2020 2070 7269  tes:.        pri
-00011980: 6d61 6c3a 2050 7269 6d61 6c20 7661 6c75  mal: Primal valu
-00011990: 652e 0a20 2020 2020 2020 2074 616e 6765  e..        tange
-000119a0: 6e74 3a20 5461 6e67 656e 7420 7661 6c75  nt: Tangent valu
-000119b0: 652e 0a20 2020 2022 2222 0a0a 2020 2020  e..    """..    
-000119c0: 7072 696d 616c 3a20 416e 790a 2020 2020  primal: Any.    
-000119d0: 7461 6e67 656e 743a 2041 6e79 0a0a 2020  tangent: Any..  
-000119e0: 2020 6465 6620 5f5f 6974 6572 5f5f 2873    def __iter__(s
-000119f0: 656c 6629 3a0a 2020 2020 2020 2020 7969  elf):.        yi
-00011a00: 656c 6420 7365 6c66 2e70 7269 6d61 6c0a  eld self.primal.
-00011a10: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
-00011a20: 6c66 2e74 616e 6765 6e74 0a0a 0a64 6566  lf.tangent...def
-00011a30: 2070 6169 725f 746f 5f6a 7670 5f64 7561   pair_to_jvp_dua
-00011a40: 6c28 7061 6972 293a 0a20 2020 2022 2222  l(pair):.    """
-00011a50: 436f 6e76 6572 7473 2061 2070 6169 7220  Converts a pair 
-00011a60: 746f 2061 204a 5650 4475 616c 2e0a 0a20  to a JVPDual... 
-00011a70: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00011a80: 2070 6169 7220 2853 6571 7565 6e63 6529   pair (Sequence)
-00011a90: 3a20 5061 6972 2074 6f20 636f 6e76 6572  : Pair to conver
-00011aa0: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
-00011ab0: 0a20 2020 2020 2020 204a 5650 4475 616c  .        JVPDual
-00011ac0: 3a20 4a56 5044 7561 6c20 7265 7072 6573  : JVPDual repres
-00011ad0: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
-00011ae0: 7061 6972 2e0a 2020 2020 2222 220a 2020  pair..    """.  
-00011af0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00011b00: 7061 6972 2c20 4a56 5044 7561 6c29 3a0a  pair, JVPDual):.
-00011b10: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-00011b20: 6169 720a 2020 2020 656c 7365 3a0a 2020  air.    else:.  
-00011b30: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00011b40: 6e73 7461 6e63 6528 7061 6972 2c20 5365  nstance(pair, Se
-00011b50: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
-00011b60: 7061 6972 2920 3d3d 2032 0a20 2020 2020  pair) == 2.     
-00011b70: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-00011b80: 6c28 2a70 6169 7229 0a0a 0a64 6566 2073  l(*pair)...def s
-00011b90: 696e 5f6a 7670 2861 3a20 4a56 5044 7561  in_jvp(a: JVPDua
-00011ba0: 6c29 3a0a 2020 2020 782c 2078 6420 3d20  l):.    x, xd = 
-00011bb0: 610a 2020 2020 7265 7475 726e 204a 5650  a.    return JVP
-00011bc0: 4475 616c 2870 7269 6d73 2e73 696e 2878  Dual(prims.sin(x
-00011bd0: 292c 2070 7269 6d73 2e63 6f73 2878 2920  ), prims.cos(x) 
-00011be0: 2a20 7864 290a 0a0a 6465 6620 6d75 6c5f  * xd)...def mul_
-00011bf0: 6a76 7028 613a 204a 5650 4475 616c 2c20  jvp(a: JVPDual, 
-00011c00: 623a 204a 5650 4475 616c 293a 0a20 2020  b: JVPDual):.   
-00011c10: 2078 2c20 7864 203d 2061 0a20 2020 2079   x, xd = a.    y
-00011c20: 2c20 7964 203d 2062 0a20 2020 2072 6574  , yd = b.    ret
-00011c30: 7572 6e20 4a56 5044 7561 6c28 7820 2a20  urn JVPDual(x * 
-00011c40: 792c 2078 202a 2079 6420 2b20 7920 2a20  y, x * yd + y * 
-00011c50: 7864 290a 0a0a 6465 6620 6164 645f 6a76  xd)...def add_jv
-00011c60: 7028 613a 204a 5650 4475 616c 2c20 623a  p(a: JVPDual, b:
-00011c70: 204a 5650 4475 616c 293a 0a20 2020 2078   JVPDual):.    x
-00011c80: 2c20 7864 203d 2061 0a20 2020 2079 2c20  , xd = a.    y, 
-00011c90: 7964 203d 2062 0a20 2020 2072 6574 7572  yd = b.    retur
-00011ca0: 6e20 4a56 5044 7561 6c28 7820 2b20 792c  n JVPDual(x + y,
-00011cb0: 2078 6420 2b20 7964 290a 0a0a 6465 6620   xd + yd)...def 
-00011cc0: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-00011cd0: 5f6a 7670 2861 3a20 4a56 5044 7561 6c2c  _jvp(a: JVPDual,
-00011ce0: 2073 6861 7065 3a20 7475 706c 655b 4a56   shape: tuple[JV
-00011cf0: 5044 7561 6c2c 202e 2e2e 5d2c 2062 726f  PDual, ...], bro
-00011d00: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00011d10: 733a 2074 7570 6c65 5b4a 5650 4475 616c  s: tuple[JVPDual
-00011d20: 2c20 2e2e 2e5d 2920 2d3e 204a 5650 4475  , ...]) -> JVPDu
-00011d30: 616c 3a0a 2020 2020 782c 2078 6420 3d20  al:.    x, xd = 
-00011d40: 610a 2020 2020 2320 544f 444f 3a20 7368  a.    # TODO: sh
-00011d50: 6170 6520 616e 6420 6272 6f61 6463 6173  ape and broadcas
-00011d60: 745f 6469 6d65 6e73 696f 6e73 2073 686f  t_dimensions sho
-00011d70: 756c 6420 6265 2074 7570 6c65 7320 6f66  uld be tuples of
-00011d80: 2069 6e74 730a 2020 2020 2320 6275 7420   ints.    # but 
-00011d90: 666f 7220 6e6f 7720 6974 2773 2061 2074  for now it's a t
-00011da0: 7570 6c65 206f 6620 4a56 5044 7561 6c73  uple of JVPDuals
-00011db0: 0a20 2020 2069 6620 6c65 6e28 7368 6170  .    if len(shap
-00011dc0: 6529 203e 2030 2061 6e64 2069 7369 6e73  e) > 0 and isins
-00011dd0: 7461 6e63 6528 7368 6170 655b 305d 2c20  tance(shape[0], 
-00011de0: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
-00011df0: 2020 7368 6170 652c 205f 203d 2073 6166    shape, _ = saf
-00011e00: 655f 7a69 7028 2a73 6861 7065 290a 2020  e_zip(*shape).  
-00011e10: 2020 6966 206c 656e 2862 726f 6164 6361    if len(broadca
-00011e20: 7374 5f64 696d 656e 7369 6f6e 7329 203e  st_dimensions) >
-00011e30: 2030 2061 6e64 2069 7369 6e73 7461 6e63   0 and isinstanc
-00011e40: 6528 6272 6f61 6463 6173 745f 6469 6d65  e(broadcast_dime
-00011e50: 6e73 696f 6e73 5b30 5d2c 204a 5650 4475  nsions[0], JVPDu
-00011e60: 616c 293a 0a20 2020 2020 2020 2062 726f  al):.        bro
-00011e70: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00011e80: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
-00011e90: 2a62 726f 6164 6361 7374 5f64 696d 656e  *broadcast_dimen
-00011ea0: 7369 6f6e 7329 0a20 2020 2072 6574 7572  sions).    retur
-00011eb0: 6e20 4a56 5044 7561 6c28 0a20 2020 2020  n JVPDual(.     
-00011ec0: 2020 2070 7269 6d73 2e62 726f 6164 6361     prims.broadca
-00011ed0: 7374 5f69 6e5f 6469 6d28 782c 2073 6861  st_in_dim(x, sha
-00011ee0: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
-00011ef0: 6d65 6e73 696f 6e73 292c 2070 7269 6d73  mensions), prims
-00011f00: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
-00011f10: 6d28 7864 2c20 7368 6170 652c 2062 726f  m(xd, shape, bro
-00011f20: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00011f30: 7329 0a20 2020 2029 0a0a 0a64 6566 2075  s).    )...def u
-00011f40: 6e70 6163 6b5f 7365 7175 656e 6365 5f6a  npack_sequence_j
-00011f50: 7670 2873 6571 7565 6e63 653a 204a 5650  vp(sequence: JVP
-00011f60: 4475 616c 2c20 6c65 6e67 7468 3a20 4a56  Dual, length: JV
-00011f70: 5044 7561 6c29 202d 3e20 4a56 5044 7561  PDual) -> JVPDua
-00011f80: 6c3a 0a20 2020 2078 203d 2074 7265 655f  l:.    x = tree_
-00011f90: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-00011fa0: 7072 696d 616c 2c20 7365 7175 656e 6365  primal, sequence
-00011fb0: 290a 2020 2020 7864 203d 2074 7265 655f  ).    xd = tree_
-00011fc0: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-00011fd0: 7461 6e67 656e 742c 2073 6571 7565 6e63  tangent, sequenc
-00011fe0: 6529 0a20 2020 206c 656e 6774 682c 205f  e).    length, _
-00011ff0: 203d 206c 656e 6774 680a 2020 2020 7072   = length.    pr
-00012000: 696d 616c 7320 3d20 7072 696d 732e 756e  imals = prims.un
-00012010: 7061 636b 5f73 6571 7565 6e63 6528 782c  pack_sequence(x,
-00012020: 206c 656e 6774 6829 0a20 2020 2074 616e   length).    tan
-00012030: 6765 6e74 7320 3d20 7072 696d 732e 756e  gents = prims.un
-00012040: 7061 636b 5f73 6571 7565 6e63 6528 7864  pack_sequence(xd
-00012050: 2c20 6c65 6e67 7468 290a 2020 2020 7265  , length).    re
-00012060: 7475 726e 2073 6166 655f 6d61 7028 7061  turn safe_map(pa
-00012070: 6972 5f74 6f5f 6a76 705f 6475 616c 2c20  ir_to_jvp_dual, 
-00012080: 7361 6665 5f7a 6970 2870 7269 6d61 6c73  safe_zip(primals
-00012090: 2c20 7461 6e67 656e 7473 2929 0a0a 0a64  , tangents))...d
-000120a0: 6566 2075 6e70 6163 6b5f 7472 6976 6961  ef unpack_trivia
-000120b0: 6c5f 6a76 7028 783a 204a 5650 4475 616c  l_jvp(x: JVPDual
-000120c0: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
-000120d0: 2020 7265 7475 726e 2078 0a0a 0a6a 7670    return x...jvp
-000120e0: 5f69 6d70 6c73 3a20 6469 6374 5b70 7269  _impls: dict[pri
-000120f0: 6d73 2e53 796d 626f 6c2c 2043 616c 6c61  ms.Symbol, Calla
-00012100: 626c 655d 203d 2064 6963 7428 290a 0a6a  ble] = dict()..j
-00012110: 7670 5f69 6d70 6c73 5b70 7269 6d73 2e50  vp_impls[prims.P
-00012120: 7269 6d49 4473 2e53 494e 5d20 3d20 7369  rimIDs.SIN] = si
-00012130: 6e5f 6a76 700a 6a76 705f 696d 706c 735b  n_jvp.jvp_impls[
-00012140: 7072 696d 732e 5072 696d 4944 732e 4d55  prims.PrimIDs.MU
-00012150: 4c5d 203d 206d 756c 5f6a 7670 0a6a 7670  L] = mul_jvp.jvp
-00012160: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-00012170: 6d49 4473 2e41 4444 5d20 3d20 6164 645f  mIDs.ADD] = add_
-00012180: 6a76 700a 6a76 705f 696d 706c 735b 7072  jvp.jvp_impls[pr
-00012190: 696d 732e 5072 696d 4944 732e 4252 4f41  ims.PrimIDs.BROA
-000121a0: 4443 4153 545f 494e 5f44 494d 5d20 3d20  DCAST_IN_DIM] = 
-000121b0: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-000121c0: 5f6a 7670 0a23 206a 7670 5f69 6d70 6c73  _jvp.# jvp_impls
-000121d0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e55  [prims.PrimIDs.U
-000121e0: 4e50 4143 4b5f 5345 5155 454e 4345 5d20  NPACK_SEQUENCE] 
-000121f0: 3d20 756e 7061 636b 5f73 6571 7565 6e63  = unpack_sequenc
-00012200: 655f 6a76 700a 2320 6a76 705f 696d 706c  e_jvp.# jvp_impl
-00012210: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
-00012220: 554e 5041 434b 5f54 5249 5649 414c 5d20  UNPACK_TRIVIAL] 
-00012230: 3d20 756e 7061 636b 5f74 7269 7669 616c  = unpack_trivial
-00012240: 5f6a 7670 0a0a 0a64 6566 206a 7670 5f73  _jvp...def jvp_s
-00012250: 796d 626f 6c5f 6d61 7070 6572 2873 796d  ymbol_mapper(sym
-00012260: 626f 6c3a 2070 7269 6d73 2e53 796d 626f  bol: prims.Symbo
-00012270: 6c29 3a0a 2020 2020 2222 224d 6170 7320  l):.    """Maps 
-00012280: 6120 7379 6d62 6f6c 2074 6f20 6120 4a56  a symbol to a JV
-00012290: 5020 6675 6e63 7469 6f6e 2074 6861 7420  P function that 
-000122a0: 6576 616c 7561 7465 7320 6974 2e0a 0a20  evaluates it... 
-000122b0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000122c0: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
-000122d0: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
-000122e0: 6f20 6576 616c 7561 7465 2e0a 0a20 2020  o evaluate...   
-000122f0: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-00012300: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-00012310: 7272 6f72 3a20 4966 2074 6865 204a 5650  rror: If the JVP
-00012320: 2066 6f72 2074 6865 2073 796d 626f 6c20   for the symbol 
-00012330: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-00012340: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
-00012350: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-00012360: 6c65 3a20 4a56 5020 6675 6e63 7469 6f6e  le: JVP function
-00012370: 2074 6861 7420 6576 616c 7561 7465 7320   that evaluates 
-00012380: 7468 6520 7379 6d62 6f6c 2e0a 2020 2020  the symbol..    
-00012390: 2222 220a 0a20 2020 2064 6566 2077 7261  """..    def wra
-000123a0: 705f 6172 6728 7829 3a0a 2020 2020 2020  p_arg(x):.      
-000123b0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000123c0: 782c 204a 5650 4475 616c 293a 0a20 2020  x, JVPDual):.   
-000123d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000123e0: 780a 2020 2020 2020 2020 656c 6966 2069  x.        elif i
-000123f0: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
-00012400: 6265 7229 3a0a 2020 2020 2020 2020 2020  ber):.          
-00012410: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
-00012420: 2878 2c20 7479 7065 2878 2928 3029 290a  (x, type(x)(0)).
-00012430: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00012440: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00012450: 5661 6c75 6545 7272 6f72 2866 224a 5650  ValueError(f"JVP
-00012460: 2077 7261 705f 6172 6720 676f 7420 616e   wrap_arg got an
-00012470: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-00012480: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
-00012490: 2020 2023 2049 6620 7379 6d62 6f6c 2e61     # If symbol.a
-000124a0: 7267 7320 646f 6573 6e27 7420 6861 7665  rgs doesn't have
-000124b0: 2073 7562 636c 6173 7365 7320 6f66 2056   subclasses of V
-000124c0: 6172 6961 626c 652c 2074 6865 6e20 7765  ariable, then we
-000124d0: 206e 6565 6420 746f 2072 6574 7572 6e20   need to return 
-000124e0: 6120 7a65 726f 2074 616e 6765 6e74 0a20  a zero tangent. 
-000124f0: 2020 2023 2054 4f44 4f3a 2074 6865 7265     # TODO: there
-00012500: 206d 6179 2062 6520 6120 6265 7474 6572   may be a better
-00012510: 2077 6179 2074 6f20 6465 7465 6374 2063   way to detect c
-00012520: 6f6e 7374 616e 7473 2069 6e20 7468 6520  onstants in the 
-00012530: 7472 6163 650a 2020 2020 6966 2073 796d  trace.    if sym
-00012540: 626f 6c2e 6172 655f 616c 6c5f 6172 6773  bol.are_all_args
-00012550: 5f63 6f6e 7374 616e 743a 0a0a 2020 2020  _constant:..    
-00012560: 2020 2020 6465 6620 7a65 726f 735f 6c69      def zeros_li
-00012570: 6b65 2878 293a 0a20 2020 2020 2020 2020  ke(x):.         
-00012580: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00012590: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
-000125a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000125b0: 2020 7265 7475 726e 2066 756c 6c5f 6c69    return full_li
-000125c0: 6b65 2878 2c20 6669 6c6c 5f76 616c 7565  ke(x, fill_value
-000125d0: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-000125e0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-000125f0: 782c 204e 756d 6265 7250 726f 7879 293a  x, NumberProxy):
-00012600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012610: 2072 6574 7572 6e20 7479 7065 2878 2e76   return type(x.v
-00012620: 616c 7565 2928 3029 0a20 2020 2020 2020  alue)(0).       
-00012630: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00012640: 616e 6365 2878 2c20 4e75 6d62 6572 293a  ance(x, Number):
-00012650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012660: 2072 6574 7572 6e20 7479 7065 2878 2928   return type(x)(
-00012670: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
-00012680: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012690: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000126a0: 4572 726f 7228 6622 7a65 726f 735f 6c69  Error(f"zeros_li
-000126b0: 6b65 2069 6e73 6964 6520 4a56 5020 676f  ke inside JVP go
-000126c0: 7420 616e 2075 6e73 7570 706f 7274 6564  t an unsupported
-000126d0: 2074 7970 6520 7b74 7970 6528 7829 7d22   type {type(x)}"
-000126e0: 290a 0a20 2020 2020 2020 2064 6566 206a  )..        def j
-000126f0: 7670 5f69 6d70 6c5f 636f 6e73 7428 7379  vp_impl_const(sy
-00012700: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
-00012710: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00012720: 2020 2020 7072 696d 616c 7320 3d20 7379      primals = sy
-00012730: 6d62 6f6c 5f74 6f5f 6576 616c 2873 796d  mbol_to_eval(sym
-00012740: 626f 6c29 282a 6172 6773 2c20 2a2a 6b77  bol)(*args, **kw
-00012750: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-00012760: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00012770: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
-00012780: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00012790: 2020 2020 7461 6e67 656e 7473 203d 2074      tangents = t
-000127a0: 7570 6c65 287a 6572 6f73 5f6c 696b 6528  uple(zeros_like(
-000127b0: 7029 2066 6f72 2070 2069 6e20 7072 696d  p) for p in prim
-000127c0: 616c 7329 0a20 2020 2020 2020 2020 2020  als).           
-000127d0: 2020 2020 2072 6574 7572 6e20 7361 6665       return safe
-000127e0: 5f6d 6170 2870 6169 725f 746f 5f6a 7670  _map(pair_to_jvp
-000127f0: 5f64 7561 6c2c 2073 6166 655f 7a69 7028  _dual, safe_zip(
-00012800: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-00012810: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-00012820: 7265 7475 726e 204a 5650 4475 616c 2870  return JVPDual(p
-00012830: 7269 6d61 6c73 2c20 7a65 726f 735f 6c69  rimals, zeros_li
-00012840: 6b65 2870 7269 6d61 6c73 2929 0a0a 2020  ke(primals))..  
-00012850: 2020 2020 2020 7265 7475 726e 2070 6172        return par
-00012860: 7469 616c 286a 7670 5f69 6d70 6c5f 636f  tial(jvp_impl_co
-00012870: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
-00012880: 2020 2320 4e6f 726d 616c 2063 6173 652c    # Normal case,
-00012890: 2077 6520 6861 7665 2061 2070 726f 7879   we have a proxy
-000128a0: 2074 616e 6765 6e74 0a20 2020 206a 7670   tangent.    jvp
-000128b0: 5f69 6d70 6c20 3d20 6a76 705f 696d 706c  _impl = jvp_impl
-000128c0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
-000128d0: 2e69 6429 0a20 2020 2069 6620 6a76 705f  .id).    if jvp_
-000128e0: 696d 706c 2069 7320 4e6f 6e65 3a0a 2020  impl is None:.  
-000128f0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-00012900: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-00012910: 6622 4a56 5020 666f 7220 7b73 796d 626f  f"JVP for {symbo
-00012920: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
-00012930: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
-00012940: 2020 2020 6465 6620 5f6a 7670 5f69 6d70      def _jvp_imp
-00012950: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
-00012960: 7329 3a0a 2020 2020 2020 2020 6172 6773  s):.        args
-00012970: 203d 2074 7265 655f 6d61 7028 7772 6170   = tree_map(wrap
-00012980: 5f61 7267 2c20 6172 6773 290a 2020 2020  _arg, args).    
-00012990: 2020 2020 2320 4578 7065 6374 696e 6720      # Expecting 
-000129a0: 4a56 5044 7561 6c73 2077 7261 7070 696e  JVPDuals wrappin
-000129b0: 6720 7061 6972 7320 6f66 2070 7269 6d61  g pairs of prima
-000129c0: 6c73 2061 6e64 2074 616e 6765 6e74 730a  ls and tangents.
-000129d0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
-000129e0: 6c6c 2869 7369 6e73 7461 6e63 6528 6172  ll(isinstance(ar
-000129f0: 672c 204a 5650 4475 616c 2920 666f 7220  g, JVPDual) for 
-00012a00: 6172 6720 696e 2074 7265 655f 666c 6174  arg in tree_flat
-00012a10: 7465 6e28 6172 6773 295b 305d 290a 2020  ten(args)[0]).  
-00012a20: 2020 2020 2020 7265 7475 726e 206a 7670        return jvp
-00012a30: 5f69 6d70 6c28 2a61 7267 732c 202a 2a6b  _impl(*args, **k
-00012a40: 7761 7267 7329 0a0a 2020 2020 7265 7475  wargs)..    retu
-00012a50: 726e 205f 6a76 705f 696d 706c 0a0a 0a64  rn _jvp_impl...d
-00012a60: 6566 205f 6a76 705f 6361 6c6c 5f6d 6574  ef _jvp_call_met
-00012a70: 6166 756e 6328 6465 7461 6368 6564 3a20  afunc(detached: 
-00012a80: 626f 6f6c 2c20 7072 696d 616c 732c 2074  bool, primals, t
-00012a90: 616e 6765 6e74 732c 202a 2c20 6675 6e63  angents, *, func
-00012aa0: 7469 6f6e 5f74 7261 6365 3a20 5472 6163  tion_trace: Trac
-00012ab0: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
-00012ac0: 2020 2222 224d 6574 6166 756e 6374 696f    """Metafunctio
-00012ad0: 6e20 666f 7220 7468 6520 4a56 5020 7472  n for the JVP tr
-00012ae0: 616e 7366 6f72 6d2e 0a0a 2020 2020 4172  ansform...    Ar
-00012af0: 6773 3a0a 2020 2020 2020 2020 6465 7461  gs:.        deta
-00012b00: 6368 6564 2028 626f 6f6c 293a 2057 6865  ched (bool): Whe
-00012b10: 7468 6572 2074 6f20 6465 7461 6368 2074  ther to detach t
-00012b20: 6865 2074 7261 6365 2e0a 2020 2020 2020  he trace..      
-00012b30: 2020 7072 696d 616c 7320 2854 7570 6c65    primals (Tuple
-00012b40: 5b50 726f 7879 5d29 3a20 5072 696d 616c  [Proxy]): Primal
-00012b50: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
-00012b60: 2074 616e 6765 6e74 7320 2854 7570 6c65   tangents (Tuple
-00012b70: 5b50 726f 7879 5d29 3a20 5461 6e67 656e  [Proxy]): Tangen
-00012b80: 7420 7661 6c75 6573 2e0a 2020 2020 2020  t values..      
-00012b90: 2020 6675 6e63 7469 6f6e 5f74 7261 6365    function_trace
-00012ba0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
-00012bb0: 6f66 2074 6865 2066 756e 6374 696f 6e20  of the function 
-00012bc0: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
-00012bd0: 642e 0a20 2020 2020 2020 206b 7761 7267  d..        kwarg
-00012be0: 733a 204b 6579 776f 7264 2061 7267 756d  s: Keyword argum
-00012bf0: 656e 7473 2e0a 0a20 2020 2052 6169 7365  ents...    Raise
-00012c00: 733a 0a20 2020 2020 2020 2041 7373 6572  s:.        Asser
-00012c10: 7469 6f6e 4572 726f 723a 2049 6620 7468  tionError: If th
-00012c20: 6520 4a56 5020 666f 7220 6b65 7977 6f72  e JVP for keywor
-00012c30: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
-00012c40: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
-00012c50: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00012c60: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
-00012c70: 7468 6520 4a56 5020 7472 616e 7366 6f72  the JVP transfor
-00012c80: 6d2e 0a20 2020 2022 2222 0a20 2020 2061  m..    """.    a
-00012c90: 7373 6572 7420 6c65 6e28 6b77 6172 6773  ssert len(kwargs
-00012ca0: 2920 3d3d 2030 2c20 224a 5650 2066 6f72  ) == 0, "JVP for
-00012cb0: 206b 7761 7267 7320 6973 206e 6f74 2069   kwargs is not i
-00012cc0: 6d70 6c65 6d65 6e74 6564 220a 0a20 2020  mplemented"..   
-00012cd0: 2063 7478 203d 2064 6574 6163 6865 645f   ctx = detached_
-00012ce0: 7472 6163 6528 2920 6966 2064 6574 6163  trace() if detac
-00012cf0: 6865 6420 656c 7365 206e 756c 6c63 6f6e  hed else nullcon
-00012d00: 7465 7874 2829 0a20 2020 2077 6974 6820  text().    with 
-00012d10: 6374 783a 0a20 2020 2020 2020 2023 2057  ctx:.        # W
-00012d20: 7261 7070 696e 6720 7468 6520 7072 696d  rapping the prim
-00012d30: 616c 7320 616e 6420 7461 6e67 656e 7473  als and tangents
-00012d40: 2069 6e20 4a56 5044 7561 6c73 2069 7320   in JVPDuals is 
-00012d50: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
-00012d60: 6573 7361 7279 2c20 6275 7420 6974 206d  essary, but it m
-00012d70: 616b 6573 0a20 2020 2020 2020 2023 2074  akes.        # t
-00012d80: 6865 2063 6f64 6520 6d6f 7265 2072 6561  he code more rea
-00012d90: 6461 626c 650a 2020 2020 2020 2020 2320  dable.        # 
-00012da0: 5765 2070 726f 7061 6761 7465 2074 6865  We propagate the
-00012db0: 204a 5650 4475 616c 7320 7468 726f 7567   JVPDuals throug
-00012dc0: 6820 7468 6520 7472 6163 652c 2061 6e64  h the trace, and
-00012dd0: 2074 6865 6e20 756e 7772 6170 2074 6865   then unwrap the
-00012de0: 6d20 6174 2074 6865 2065 6e64 0a20 2020  m at the end.   
-00012df0: 2020 2020 2070 7269 6d61 6c73 5f74 616e       primals_tan
-00012e00: 6765 6e74 735f 6475 616c 7320 3d20 7361  gents_duals = sa
-00012e10: 6665 5f6d 6170 2870 6169 725f 746f 5f6a  fe_map(pair_to_j
-00012e20: 7670 5f64 7561 6c2c 2073 6166 655f 7a69  vp_dual, safe_zi
-00012e30: 7028 7072 696d 616c 732c 2074 616e 6765  p(primals, tange
-00012e40: 6e74 7329 290a 2020 2020 2020 2020 7265  nts)).        re
-00012e50: 7375 6c74 203d 2065 7661 6c5f 7472 6163  sult = eval_trac
-00012e60: 6528 6675 6e63 7469 6f6e 5f74 7261 6365  e(function_trace
-00012e70: 2c20 2a70 7269 6d61 6c73 5f74 616e 6765  , *primals_tange
-00012e80: 6e74 735f 6475 616c 732c 2073 796d 626f  nts_duals, symbo
-00012e90: 6c5f 6d61 7070 6572 3d6a 7670 5f73 796d  l_mapper=jvp_sym
-00012ea0: 626f 6c5f 6d61 7070 6572 290a 2020 2020  bol_mapper).    
-00012eb0: 2020 2020 2320 556e 7772 6170 7069 6e67      # Unwrapping
-00012ec0: 2074 6865 204a 5650 4475 616c 730a 2020   the JVPDuals.  
-00012ed0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00012ee0: 6e63 6528 7265 7375 6c74 2c20 5365 7175  nce(result, Sequ
-00012ef0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-00012f00: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
-00012f10: 696e 7374 616e 6365 2878 2c20 4a56 5044  instance(x, JVPD
-00012f20: 7561 6c29 2066 6f72 2078 2069 6e20 7265  ual) for x in re
-00012f30: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-00012f40: 2020 7072 696d 616c 732c 2074 616e 6765    primals, tange
-00012f50: 6e74 7320 3d20 756e 7a69 7032 2872 6573  nts = unzip2(res
-00012f60: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-00012f70: 2072 6574 7572 6e20 7072 696d 616c 732c   return primals,
-00012f80: 2074 616e 6765 6e74 730a 2020 2020 2020   tangents.      
-00012f90: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00012fa0: 6e63 6528 7265 7375 6c74 2c20 4a56 5044  nce(result, JVPD
-00012fb0: 7561 6c29 0a20 2020 2020 2020 2072 6574  ual).        ret
-00012fc0: 7572 6e20 7265 7375 6c74 2e70 7269 6d61  urn result.prima
-00012fd0: 6c2c 2072 6573 756c 742e 7461 6e67 656e  l, result.tangen
-00012fe0: 740a 0a0a 6a76 705f 6361 6c6c 203d 2053  t...jvp_call = S
-00012ff0: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
-00013000: 726d 732e 4a76 704f 702c 206e 616d 653d  rms.JvpOp, name=
-00013010: 226a 7670 5f63 616c 6c22 2c20 6d65 7461  "jvp_call", meta
-00013020: 3d70 6172 7469 616c 285f 6a76 705f 6361  =partial(_jvp_ca
-00013030: 6c6c 5f6d 6574 6166 756e 632c 2046 616c  ll_metafunc, Fal
-00013040: 7365 2929 0a0a 0a64 6566 205f 6964 656e  se))...def _iden
-00013050: 7469 7479 5f63 616c 6c5f 6a76 7028 2a61  tity_call_jvp(*a
-00013060: 7267 733a 204a 5650 4475 616c 2c20 7472  rgs: JVPDual, tr
-00013070: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-00013080: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
-00013090: 6c73 2c20 7461 6e67 656e 7473 203d 2075  ls, tangents = u
-000130a0: 6e7a 6970 3228 6172 6773 290a 2020 2020  nzip2(args).    
-000130b0: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
-000130c0: 5f74 616e 6765 6e74 7320 3d20 5f6a 7670  _tangents = _jvp
-000130d0: 5f63 616c 6c5f 6d65 7461 6675 6e63 2846  _call_metafunc(F
-000130e0: 616c 7365 2c20 7072 696d 616c 732c 2074  alse, primals, t
-000130f0: 616e 6765 6e74 732c 2074 7261 6365 2c20  angents, trace, 
-00013100: 2a2a 6b77 6172 6773 290a 2020 2020 6966  **kwargs).    if
-00013110: 2069 7369 6e73 7461 6e63 6528 6f75 745f   isinstance(out_
-00013120: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
-00013130: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00013140: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
-00013150: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
-00013160: 6665 5f7a 6970 286f 7574 5f70 7269 6d61  fe_zip(out_prima
-00013170: 6c73 2c20 6f75 745f 7461 6e67 656e 7473  ls, out_tangents
-00013180: 2929 0a20 2020 2072 6574 7572 6e20 4a56  )).    return JV
-00013190: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-000131a0: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
-000131b0: 0a0a 0a6a 7670 5f69 6d70 6c73 5b54 7261  ...jvp_impls[Tra
-000131c0: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
-000131d0: 4f70 5d20 3d20 5f69 6465 6e74 6974 795f  Op] = _identity_
-000131e0: 6361 6c6c 5f6a 7670 0a0a 0a64 6566 205f  call_jvp...def _
-000131f0: 766d 6170 5f63 616c 6c5f 6a76 7028 6172  vmap_call_jvp(ar
-00013200: 6773 3a20 4a56 5044 7561 6c2c 2069 6e5f  gs: JVPDual, in_
-00013210: 6469 6d73 2c20 6f75 745f 6469 6d73 2c20  dims, out_dims, 
-00013220: 6178 6973 5f73 697a 652c 2074 7261 6365  axis_size, trace
-00013230: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
-00013240: 7329 3a0a 2020 2020 7072 696d 616c 732c  s):.    primals,
-00013250: 2074 616e 6765 6e74 7320 3d20 7361 6665   tangents = safe
-00013260: 5f7a 6970 282a 6172 6773 290a 2020 2020  _zip(*args).    
-00013270: 696e 5f64 696d 732c 205f 203d 2073 6166  in_dims, _ = saf
-00013280: 655f 7a69 7028 2a69 6e5f 6469 6d73 290a  e_zip(*in_dims).
-00013290: 2020 2020 6f75 745f 6469 6d73 2c20 5f20      out_dims, _ 
-000132a0: 3d20 7361 6665 5f7a 6970 282a 6f75 745f  = safe_zip(*out_
-000132b0: 6469 6d73 290a 2020 2020 766d 6170 7065  dims).    vmappe
-000132c0: 645f 7472 6163 6520 3d20 636f 6e73 7472  d_trace = constr
-000132d0: 7563 745f 7472 6163 6528 2928 0a20 2020  uct_trace()(.   
-000132e0: 2020 2020 2076 6d61 7028 7061 7274 6961       vmap(partia
-000132f0: 6c28 6576 616c 5f74 7261 6365 2c20 7472  l(eval_trace, tr
-00013300: 6163 6529 2c20 696e 5f64 696d 733d 696e  ace), in_dims=in
-00013310: 5f64 696d 732c 206f 7574 5f64 696d 733d  _dims, out_dims=
-00013320: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
-00013330: 697a 653d 6178 6973 5f73 697a 6529 2c20  ize=axis_size), 
-00013340: 2a70 7269 6d61 6c73 0a20 2020 2029 0a20  *primals.    ). 
-00013350: 2020 2076 6d61 7070 6564 5f66 756e 6320     vmapped_func 
-00013360: 3d20 7061 7274 6961 6c28 6576 616c 5f74  = partial(eval_t
-00013370: 7261 6365 2c20 766d 6170 7065 645f 7472  race, vmapped_tr
-00013380: 6163 6529 0a20 2020 206f 7574 5f70 7269  ace).    out_pri
-00013390: 6d61 6c73 2c20 6f75 745f 7461 6e67 656e  mals, out_tangen
-000133a0: 7473 203d 206a 7670 2876 6d61 7070 6564  ts = jvp(vmapped
-000133b0: 5f66 756e 6329 2870 7269 6d61 6c73 2c20  _func)(primals, 
-000133c0: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
-000133d0: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
-000133e0: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
-000133f0: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
-00013400: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
-00013410: 655f 6d61 7028 7061 6972 5f74 6f5f 6a76  e_map(pair_to_jv
-00013420: 705f 6475 616c 2c20 7361 6665 5f7a 6970  p_dual, safe_zip
-00013430: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
-00013440: 745f 7461 6e67 656e 7473 2929 0a20 2020  t_tangents)).   
-00013450: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
-00013460: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
-00013470: 5f74 616e 6765 6e74 7329 0a0a 0a6a 7670  _tangents)...jvp
-00013480: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
-00013490: 732e 566d 6170 4f70 5d20 3d20 5f76 6d61  s.VmapOp] = _vma
-000134a0: 705f 6361 6c6c 5f6a 7670 0a0a 0a64 6566  p_call_jvp...def
-000134b0: 206a 7670 2866 756e 6329 3a0a 2020 2020   jvp(func):.    
-000134c0: 2222 224a 6163 6f62 6961 6e2d 7665 6374  """Jacobian-vect
-000134d0: 6f72 2070 726f 6475 6374 2074 7261 6e73  or product trans
-000134e0: 666f 726d 2066 6f72 2061 2054 6875 6e64  form for a Thund
-000134f0: 6572 2066 756e 6374 696f 6e2e 0a0a 2020  er function...  
-00013500: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00013510: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
-00013520: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
-00013530: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
-00013540: 6f72 6d65 642e 0a0a 2020 2020 5265 7475  ormed...    Retu
-00013550: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-00013560: 6c61 626c 653a 2041 2066 756e 6374 696f  lable: A functio
-00013570: 6e20 7468 6174 2063 6f6d 7075 7465 7320  n that computes 
-00013580: 7468 6520 4a61 636f 6269 616e 2d76 6563  the Jacobian-vec
-00013590: 746f 7220 7072 6f64 7563 740a 2020 2020  tor product.    
-000135a0: 2020 2020 2020 2020 7461 6b69 6e67 2070          taking p
-000135b0: 7269 6d61 6c73 2061 6e64 2074 616e 6765  rimals and tange
-000135c0: 6e74 7320 6173 2061 7267 756d 656e 7473  nts as arguments
-000135d0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-000135e0: 6566 2077 7261 7070 6572 2870 7269 6d61  ef wrapper(prima
-000135f0: 6c73 2c20 7461 6e67 656e 7473 293a 0a20  ls, tangents):. 
-00013600: 2020 2020 2020 2074 7261 6365 203d 2063         trace = c
-00013610: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
-00013620: 2866 756e 632c 202a 7072 696d 616c 7329  (func, *primals)
-00013630: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013640: 6a76 705f 6361 6c6c 2870 7269 6d61 6c73  jvp_call(primals
-00013650: 2c20 7461 6e67 656e 7473 2c20 6675 6e63  , tangents, func
-00013660: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
-00013670: 290a 0a20 2020 2072 6574 7572 6e20 7772  )..    return wr
-00013680: 6170 7065 720a 0a0a 2320 544f 444f 2054  apper...# TODO T
-00013690: 6869 7320 6675 6e63 7469 6f6e 2063 6f6d  his function com
-000136a0: 6d65 6e74 6564 206f 7574 2062 6563 6175  mented out becau
-000136b0: 7365 2069 7420 6361 6c6c 7320 6d61 6b65  se it calls make
-000136c0: 5f74 7261 6365 642c 2077 6869 6368 2064  _traced, which d
-000136d0: 6f65 7320 6e6f 7420 6578 6973 740a 2320  oes not exist.# 
-000136e0: 6465 6620 6a76 705f 6561 6765 7228 6675  def jvp_eager(fu
-000136f0: 6e63 2c20 7072 696d 616c 732c 2074 616e  nc, primals, tan
-00013700: 6765 6e74 732c 2065 7865 6375 746f 723d  gents, executor=
-00013710: 2274 6f72 6368 2229 3a0a 2320 2020 2020  "torch"):.#     
-00013720: 2222 2243 6f6d 7075 7465 7320 7468 6520  """Computes the 
-00013730: 4a61 636f 6269 616e 2d76 6563 746f 7220  Jacobian-vector 
-00013740: 7072 6f64 7563 7420 6f66 2061 2054 6875  product of a Thu
-00013750: 6e64 6572 2066 756e 6374 696f 6e2e 0a0a  nder function...
-00013760: 2320 2020 2020 4172 6773 3a0a 2320 2020  #     Args:.#   
-00013770: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
-00013780: 6162 6c65 293a 2041 2054 6875 6e64 6572  able): A Thunder
-00013790: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
-000137a0: 7472 616e 7366 6f72 6d65 642e 0a23 2020  transformed..#  
-000137b0: 2020 2020 2020 2070 7269 6d61 6c73 2028         primals (
-000137c0: 5f74 7970 655f 293a 2050 7269 6d61 6c73  _type_): Primals
-000137d0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-000137e0: 2e0a 2320 2020 2020 2020 2020 7461 6e67  ..#         tang
-000137f0: 656e 7473 2028 5f74 7970 655f 293a 2054  ents (_type_): T
-00013800: 616e 6765 6e74 7320 6f66 2074 6865 2066  angents of the f
-00013810: 756e 6374 696f 6e2e 0a23 2020 2020 2020  unction..#      
-00013820: 2020 2065 7865 6375 746f 7220 2873 7472     executor (str
-00013830: 2c20 6f70 7469 6f6e 616c 293a 2045 7865  , optional): Exe
-00013840: 6375 746f 7220 746f 2075 7365 2e20 4465  cutor to use. De
-00013850: 6661 756c 7473 2074 6f20 2274 6f72 6368  faults to "torch
-00013860: 222e 0a0a 2320 2020 2020 5265 7475 726e  "...#     Return
-00013870: 733a 0a23 2020 2020 2020 2020 2054 6865  s:.#         The
-00013880: 2072 6573 756c 7420 6f66 2074 6865 204a   result of the J
-00013890: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
-000138a0: 726f 6475 6374 2e0a 2320 2020 2020 2222  roduct..#     ""
-000138b0: 220a 2320 2020 2020 7472 6163 6520 3d20  ".#     trace = 
-000138c0: 6d61 6b65 5f74 7261 6365 2866 756e 632c  make_trace(func,
-000138d0: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
-000138e0: 6f72 2c20 2a70 7269 6d61 6c73 290a 0a23  or, *primals)..#
-000138f0: 2020 2020 2064 6566 206a 7670 5f66 756e       def jvp_fun
-00013900: 6328 2a70 7269 6d61 6c73 5f61 6e64 5f74  c(*primals_and_t
-00013910: 616e 6765 6e74 7329 3a0a 2320 2020 2020  angents):.#     
-00013920: 2020 2020 5f70 7269 6d61 6c73 2c20 5f74      _primals, _t
-00013930: 616e 6765 6e74 7320 3d20 7072 696d 616c  angents = primal
-00013940: 735f 616e 645f 7461 6e67 656e 7473 5b3a  s_and_tangents[:
-00013950: 206c 656e 2870 7269 6d61 6c73 295d 2c20   len(primals)], 
-00013960: 7072 696d 616c 735f 616e 645f 7461 6e67  primals_and_tang
-00013970: 656e 7473 5b6c 656e 2870 7269 6d61 6c73  ents[len(primals
-00013980: 2920 3a5d 0a23 2020 2020 2020 2020 2072  ) :].#         r
-00013990: 6574 7572 6e20 5f6a 7670 5f63 616c 6c5f  eturn _jvp_call_
-000139a0: 6d65 7461 6675 6e63 285f 7072 696d 616c  metafunc(_primal
-000139b0: 732c 205f 7461 6e67 656e 7473 2c20 7472  s, _tangents, tr
-000139c0: 6163 652c 2064 6574 6163 6865 643d 4661  ace, detached=Fa
-000139d0: 6c73 6529 0a0a 2320 2020 2020 6a76 705f  lse)..#     jvp_
-000139e0: 7472 6163 6520 3d20 6d61 6b65 5f74 7261  trace = make_tra
-000139f0: 6365 286a 7670 5f66 756e 632c 2065 7865  ce(jvp_func, exe
-00013a00: 6375 746f 723d 6578 6563 7574 6f72 2928  cutor=executor)(
-00013a10: 2a70 7269 6d61 6c73 2c20 2a74 616e 6765  *primals, *tange
-00013a20: 6e74 7329 0a23 2020 2020 206a 7670 5f74  nts).#     jvp_t
-00013a30: 7261 6365 6420 3d20 6d61 6b65 5f74 7261  raced = make_tra
-00013a40: 6365 6428 7061 7274 6961 6c28 6576 616c  ced(partial(eval
-00013a50: 5f74 7261 6365 2c20 6a76 705f 7472 6163  _trace, jvp_trac
-00013a60: 6529 2c20 6578 6563 7574 6f72 3d65 7865  e), executor=exe
-00013a70: 6375 746f 7229 0a23 2020 2020 2072 6574  cutor).#     ret
-00013a80: 7572 6e20 6a76 705f 7472 6163 6564 282a  urn jvp_traced(*
-00013a90: 7072 696d 616c 732c 202a 7461 6e67 656e  primals, *tangen
-00013aa0: 7473 290a 0a0a 2320 564a 5020 7472 616e  ts)...# VJP tran
-00013ab0: 7366 6f72 6d0a 2320 3d3d 3d3d 3d3d 3d3d  sform.# ========
-00013ac0: 3d3d 3d3d 3d0a 4064 6174 6163 6c61 7373  =====.@dataclass
-00013ad0: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
-00013ae0: 6173 7320 564a 5044 7561 6c3a 0a20 2020  ass VJPDual:.   
-00013af0: 2022 2222 4120 7061 6972 206f 6620 7072   """A pair of pr
-00013b00: 696d 616c 2061 6e64 2073 6176 6564 2069  imal and saved i
-00013b10: 6e66 6f72 6d61 7469 6f6e 2066 6f72 2062  nformation for b
-00013b20: 6163 6b77 6172 6420 2872 6573 6964 7561  ackward (residua
-00013b30: 6c73 292e 0a0a 2020 2020 4172 6773 3a0a  ls)...    Args:.
-00013b40: 2020 2020 2020 2020 7072 696d 616c 2028          primal (
-00013b50: 556e 696f 6e5b 5072 6f78 792c 204e 756d  Union[Proxy, Num
-00013b60: 6265 725d 293a 2050 7269 6d61 6c20 7661  ber]): Primal va
-00013b70: 6c75 652c 2069 2e65 2e2c 2074 6865 2076  lue, i.e., the v
-00013b80: 616c 7565 2062 6569 6e67 2064 6966 6665  alue being diffe
-00013b90: 7265 6e74 6961 7465 642e 0a20 2020 2020  rentiated..     
-00013ba0: 2020 2072 6573 6964 7561 6c73 2028 5475     residuals (Tu
-00013bb0: 706c 655b 5072 6f78 792c 202e 2e2e 5d29  ple[Proxy, ...])
-00013bc0: 3a20 5265 7369 6475 616c 732c 2069 2e65  : Residuals, i.e
-00013bd0: 2e2c 2074 6865 2076 616c 7565 7320 7468  ., the values th
-00013be0: 6174 2061 7265 0a20 2020 2020 2020 2020  at are.         
-00013bf0: 2020 2073 6176 6564 2066 6f72 2074 6865     saved for the
-00013c00: 2062 6163 6b77 6172 642e 0a0a 2020 2020   backward...    
-00013c10: 5969 656c 6473 3a0a 2020 2020 2020 2020  Yields:.        
-00013c20: 5475 706c 655b 5661 7269 6162 6c65 2c20  Tuple[Variable, 
-00013c30: 5475 706c 655b 5661 7269 6162 6c65 2c20  Tuple[Variable, 
-00013c40: 2e2e 2e5d 2c20 4361 6c6c 6162 6c65 5d3a  ...], Callable]:
-00013c50: 2050 7269 6d61 6c20 616e 6420 7265 7369   Primal and resi
-00013c60: 6475 616c 730a 2020 2020 2222 220a 0a20  duals.    """.. 
-00013c70: 2020 2070 7269 6d61 6c3a 2050 726f 7879     primal: Proxy
-00013c80: 207c 204e 756d 6265 720a 2020 2020 7265   | Number.    re
-00013c90: 7369 6475 616c 733a 2074 7570 6c65 5b50  siduals: tuple[P
-00013ca0: 726f 7879 2c20 2e2e 2e5d 0a0a 2020 2020  roxy, ...]..    
-00013cb0: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
-00013cc0: 6629 3a0a 2020 2020 2020 2020 7969 656c  f):.        yiel
-00013cd0: 6420 7365 6c66 2e70 7269 6d61 6c0a 2020  d self.primal.  
-00013ce0: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
-00013cf0: 2e72 6573 6964 7561 6c73 0a0a 0a63 6c61  .residuals...cla
-00013d00: 7373 204e 6f50 756c 6c62 6163 6b3a 0a20  ss NoPullback:. 
-00013d10: 2020 2022 2222 4120 6475 6d6d 7920 7075     """A dummy pu
-00013d20: 6c6c 6261 636b 2066 756e 6374 696f 6e20  llback function 
-00013d30: 7468 6174 2072 6574 7572 6e73 204e 6f6e  that returns Non
-00013d40: 6520 6f72 2072 6169 7365 7320 616e 2065  e or raises an e
-00013d50: 7272 6f72 2e22 2222 0a0a 2020 2020 6465  rror."""..    de
-00013d60: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00013d70: 206e 756d 5f61 7267 733d 3029 3a0a 2020   num_args=0):.  
-00013d80: 2020 2020 2020 7365 6c66 2e6e 756d 5f61        self.num_a
-00013d90: 7267 7320 3d20 6e75 6d5f 6172 6773 0a0a  rgs = num_args..
-00013da0: 2020 2020 6465 6620 5f5f 6361 6c6c 5f5f      def __call__
-00013db0: 2873 656c 662c 202a 6172 6773 2c20 2a2a  (self, *args, **
-00013dc0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-00013dd0: 2069 6620 7365 6c66 2e6e 756d 5f61 7267   if self.num_arg
-00013de0: 7320 3e20 303a 0a20 2020 2020 2020 2020  s > 0:.         
-00013df0: 2020 2072 6574 7572 6e20 284e 6f6e 652c     return (None,
-00013e00: 2920 2a20 7365 6c66 2e6e 756d 5f61 7267  ) * self.num_arg
-00013e10: 730a 2020 2020 2020 2020 7261 6973 6520  s.        raise 
-00013e20: 5275 6e74 696d 6545 7272 6f72 2822 5075  RuntimeError("Pu
-00013e30: 6c6c 6261 636b 2063 616c 6c65 6420 6f6e  llback called on
-00013e40: 2061 206e 6f6e 2d64 6966 6665 7265 6e74   a non-different
-00013e50: 6961 626c 6520 7379 6d62 6f6c 206f 7220  iable symbol or 
-00013e60: 6120 636f 6e73 7461 6e74 2e22 290a 0a0a  a constant.")...
-00013e70: 636c 6173 7320 5a65 726f 4261 636b 7761  class ZeroBackwa
-00013e80: 7264 3a0a 2020 2020 2222 2241 2068 656c  rd:.    """A hel
-00013e90: 7065 7220 6261 636b 7761 7264 2066 756e  per backward fun
-00013ea0: 6374 696f 6e20 7468 6174 2072 6574 7572  ction that retur
-00013eb0: 6e73 207a 6572 6f73 2e22 2222 0a0a 2020  ns zeros."""..  
-00013ec0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00013ed0: 656c 662c 206e 756d 5f61 7267 7329 3a0a  elf, num_args):.
-00013ee0: 2020 2020 2020 2020 7365 6c66 2e6e 756d          self.num
-00013ef0: 5f61 7267 7320 3d20 6e75 6d5f 6172 6773  _args = num_args
-00013f00: 0a0a 2020 2020 6465 6620 5f5f 6361 6c6c  ..    def __call
-00013f10: 5f5f 2873 656c 662c 202a 6172 6773 2c20  __(self, *args, 
-00013f20: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00013f30: 2020 2023 2041 7373 756d 696e 6720 7468     # Assuming th
-00013f40: 6174 2074 6865 2066 6972 7374 2061 7267  at the first arg
-00013f50: 756d 656e 7473 2061 7265 2074 6865 2066  uments are the f
-00013f60: 6f72 7761 7264 2061 7267 756d 656e 7473  orward arguments
-00013f70: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
-00013f80: 5f61 7267 7320 3d20 6172 6773 5b3a 2073  _args = args[: s
-00013f90: 656c 662e 6e75 6d5f 6172 6773 5d0a 0a20  elf.num_args].. 
-00013fa0: 2020 2020 2020 2064 6566 207a 6572 6f73         def zeros
-00013fb0: 5f6c 696b 6528 7829 3a0a 2020 2020 2020  _like(x):.      
-00013fc0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00013fd0: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
-00013fe0: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-00013ff0: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
-00014000: 5f6c 696b 6528 782c 2066 696c 6c5f 7661  _like(x, fill_va
-00014010: 6c75 653d 3029 0a20 2020 2020 2020 2020  lue=0).         
-00014020: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00014030: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
-00014040: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
-00014050: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
-00014060: 782e 7661 6c75 6529 2830 290a 2020 2020  x.value)(0).    
-00014070: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00014080: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-00014090: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000140a0: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
-000140b0: 7829 2830 290a 2020 2020 2020 2020 2020  x)(0).          
-000140c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000140d0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-000140e0: 6c75 6545 7272 6f72 2866 227a 6572 6f73  lueError(f"zeros
-000140f0: 5f6c 696b 6520 696e 7369 6465 205a 6572  _like inside Zer
-00014100: 6f42 6163 6b77 6172 6420 676f 7420 616e  oBackward got an
-00014110: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
-00014120: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
-00014130: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
-00014140: 706c 6528 7a65 726f 735f 6c69 6b65 2861  ple(zeros_like(a
-00014150: 7267 2920 666f 7220 6172 6720 696e 2066  rg) for arg in f
-00014160: 6f72 7761 7264 5f61 7267 7329 0a0a 0a23  orward_args)...#
-00014170: 204d 6170 7069 6e67 2066 726f 6d20 7379   Mapping from sy
-00014180: 6d62 6f6c 7320 746f 2061 7567 6d65 6e74  mbols to augment
-00014190: 6564 2070 7269 6d61 6c20 2866 6f72 7761  ed primal (forwa
-000141a0: 7264 2920 6675 6e63 7469 6f6e 7320 7573  rd) functions us
-000141b0: 6564 2069 6e20 564a 500a 2320 5468 6520  ed in VJP.# The 
-000141c0: 6175 676d 656e 7465 645f 7072 696d 616c  augmented_primal
-000141d0: 2066 756e 6374 696f 6e20 7461 6b65 7320   function takes 
-000141e0: 7468 6520 7072 696d 616c 2076 616c 7565  the primal value
-000141f0: 7320 616e 6420 7265 7475 726e 7320 7468  s and returns th
-00014200: 6520 7072 696d 616c 0a23 2072 6573 756c  e primal.# resul
-00014210: 7420 616e 6420 7468 6520 7265 7369 6475  t and the residu
-00014220: 616c 7320 2873 6176 6564 2076 616c 7565  als (saved value
-00014230: 7320 666f 7220 7468 6520 6261 636b 7761  s for the backwa
-00014240: 7264 292e 0a61 7567 6d65 6e74 6564 5f66  rd)..augmented_f
-00014250: 6f72 7761 7264 5f69 6d70 6c73 203d 207b  orward_impls = {
-00014260: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014270: 4473 2e41 434f 533a 206c 616d 6264 6120  Ds.ACOS: lambda 
-00014280: 783a 2028 7072 696d 732e 6163 6f73 2878  x: (prims.acos(x
-00014290: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-000142a0: 696d 732e 5072 696d 4944 732e 4143 4f53  ims.PrimIDs.ACOS
-000142b0: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
-000142c0: 696d 732e 6163 6f73 6828 7829 2c20 2878  ims.acosh(x), (x
-000142d0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-000142e0: 7269 6d49 4473 2e41 5349 4e3a 206c 616d  rimIDs.ASIN: lam
-000142f0: 6264 6120 783a 2028 7072 696d 732e 6173  bda x: (prims.as
-00014300: 696e 2878 292c 2028 782c 2929 2c0a 2020  in(x), (x,)),.  
-00014310: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014320: 4153 494e 483a 206c 616d 6264 6120 783a  ASINH: lambda x:
-00014330: 2028 7072 696d 732e 6173 696e 6828 7829   (prims.asinh(x)
-00014340: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00014350: 6d73 2e50 7269 6d49 4473 2e41 5441 4e3a  ms.PrimIDs.ATAN:
-00014360: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014370: 732e 6174 616e 2878 292c 2028 782c 2929  s.atan(x), (x,))
-00014380: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014390: 4944 732e 4154 414e 483a 206c 616d 6264  IDs.ATANH: lambd
-000143a0: 6120 783a 2028 7072 696d 732e 6174 616e  a x: (prims.atan
-000143b0: 6828 7829 2c20 2878 2c29 292c 0a20 2020  h(x), (x,)),.   
-000143c0: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-000143d0: 5441 4e32 3a20 6c61 6d62 6461 2078 2c20  TAN2: lambda x, 
-000143e0: 793a 2028 7072 696d 732e 6174 616e 3228  y: (prims.atan2(
-000143f0: 782c 2079 292c 2028 782c 2079 2929 2c0a  x, y), (x, y)),.
-00014400: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014410: 732e 434f 5348 3a20 6c61 6d62 6461 2078  s.COSH: lambda x
-00014420: 3a20 2870 7269 6d73 2e63 6f73 6828 7829  : (prims.cosh(x)
-00014430: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00014440: 6d73 2e50 7269 6d49 4473 2e44 4947 414d  ms.PrimIDs.DIGAM
-00014450: 4d41 3a20 6c61 6d62 6461 2078 3a20 2870  MA: lambda x: (p
-00014460: 7269 6d73 2e64 6967 616d 6d61 2878 292c  rims.digamma(x),
-00014470: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-00014480: 732e 5072 696d 4944 732e 4552 4643 3a20  s.PrimIDs.ERFC: 
-00014490: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-000144a0: 2e65 7266 6328 7829 2c20 2878 2c29 292c  .erfc(x), (x,)),
-000144b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000144c0: 4473 2e45 5246 494e 563a 206c 616d 6264  Ds.ERFINV: lambd
-000144d0: 6120 783a 2028 7072 696d 732e 6572 6669  a x: (prims.erfi
-000144e0: 6e76 2878 292c 2028 7072 696d 732e 6572  nv(x), (prims.er
-000144f0: 6669 6e76 2878 292c 2929 2c0a 2020 2020  finv(x),)),.    
-00014500: 7072 696d 732e 5072 696d 4944 732e 4552  prims.PrimIDs.ER
-00014510: 4643 494e 563a 206c 616d 6264 6120 783a  FCINV: lambda x:
-00014520: 2028 7072 696d 732e 6572 6663 696e 7628   (prims.erfcinv(
-00014530: 7829 2c20 2870 7269 6d73 2e65 7266 6369  x), (prims.erfci
-00014540: 6e76 2878 292c 2929 2c0a 2020 2020 7072  nv(x),)),.    pr
-00014550: 696d 732e 5072 696d 4944 732e 4558 5032  ims.PrimIDs.EXP2
-00014560: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00014570: 6d73 2e65 7870 3228 7829 2c20 2870 7269  ms.exp2(x), (pri
-00014580: 6d73 2e65 7870 3228 7829 2c29 292c 0a20  ms.exp2(x),)),. 
-00014590: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000145a0: 2e45 5850 4d31 3a20 6c61 6d62 6461 2078  .EXPM1: lambda x
-000145b0: 3a20 2870 7269 6d73 2e65 7870 6d31 2878  : (prims.expm1(x
-000145c0: 292c 2028 7072 696d 732e 6578 706d 3128  ), (prims.expm1(
-000145d0: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
-000145e0: 2e50 7269 6d49 4473 2e4c 4741 4d4d 413a  .PrimIDs.LGAMMA:
-000145f0: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014600: 732e 6c67 616d 6d61 2878 292c 2028 782c  s.lgamma(x), (x,
-00014610: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00014620: 696d 4944 732e 4e44 5452 493a 206c 616d  imIDs.NDTRI: lam
-00014630: 6264 6120 783a 2028 7072 696d 732e 6e64  bda x: (prims.nd
-00014640: 7472 6928 7829 2c20 2870 7269 6d73 2e6e  tri(x), (prims.n
-00014650: 6474 7269 2878 292c 2929 2c0a 2020 2020  dtri(x),)),.    
-00014660: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
-00014670: 4e48 3a20 6c61 6d62 6461 2078 3a20 2870  NH: lambda x: (p
-00014680: 7269 6d73 2e73 696e 6828 7829 2c20 2878  rims.sinh(x), (x
-00014690: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-000146a0: 7269 6d49 4473 2e53 5152 543a 206c 616d  rimIDs.SQRT: lam
-000146b0: 6264 6120 783a 2028 7072 696d 732e 7371  bda x: (prims.sq
-000146c0: 7274 2878 292c 2028 7072 696d 732e 7371  rt(x), (prims.sq
-000146d0: 7274 2878 292c 2929 2c0a 2020 2020 7072  rt(x),)),.    pr
-000146e0: 696d 732e 5072 696d 4944 732e 4c4f 4731  ims.PrimIDs.LOG1
-000146f0: 303a 206c 616d 6264 6120 783a 2028 7072  0: lambda x: (pr
-00014700: 696d 732e 6c6f 6731 3028 7829 2c20 2878  ims.log10(x), (x
-00014710: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014720: 7269 6d49 4473 2e4c 4f47 3150 3a20 6c61  rimIDs.LOG1P: la
-00014730: 6d62 6461 2078 3a20 2870 7269 6d73 2e6c  mbda x: (prims.l
-00014740: 6f67 3170 2878 292c 2028 782c 2929 2c0a  og1p(x), (x,)),.
-00014750: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014760: 732e 4c4f 4732 3a20 6c61 6d62 6461 2078  s.LOG2: lambda x
-00014770: 3a20 2870 7269 6d73 2e6c 6f67 3228 7829  : (prims.log2(x)
-00014780: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00014790: 6d73 2e50 7269 6d49 4473 2e5a 4554 413a  ms.PrimIDs.ZETA:
-000147a0: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
-000147b0: 7269 6d73 2e7a 6574 6128 782c 2079 292c  rims.zeta(x, y),
-000147c0: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
-000147d0: 696d 732e 5072 696d 4944 732e 464d 4f44  ims.PrimIDs.FMOD
-000147e0: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
-000147f0: 7072 696d 732e 666d 6f64 2878 2c20 7929  prims.fmod(x, y)
-00014800: 2c20 2878 2c20 7929 292c 0a20 2020 2070  , (x, y)),.    p
-00014810: 7269 6d73 2e50 7269 6d49 4473 2e43 4f50  rims.PrimIDs.COP
-00014820: 595f 3a20 6c61 6d62 6461 2078 2c20 793a  Y_: lambda x, y:
-00014830: 2028 7072 696d 732e 636f 7079 5f28 782c   (prims.copy_(x,
-00014840: 2079 292c 2074 7570 6c65 2829 292c 0a7d   y), tuple()),.}
-00014850: 0a0a 0a23 204d 6170 7069 6e67 2066 726f  ...# Mapping fro
-00014860: 6d20 7379 6d62 6f6c 7320 746f 2062 6163  m symbols to bac
-00014870: 6b77 6172 6420 6675 6e63 7469 6f6e 7320  kward functions 
-00014880: 7573 6564 2069 6e20 564a 500a 2320 5468  used in VJP.# Th
-00014890: 6520 6261 636b 7761 7264 2066 756e 6374  e backward funct
-000148a0: 696f 6e20 7461 6b65 7320 7468 6520 7265  ion takes the re
-000148b0: 7369 6475 616c 7320 616e 6420 636f 7461  siduals and cota
-000148c0: 6e67 656e 7473 2061 6e64 2072 6574 7572  ngents and retur
-000148d0: 6e73 2074 6865 0a23 2076 6563 746f 722d  ns the.# vector-
-000148e0: 4a61 636f 6269 616e 2070 726f 6475 6374  Jacobian product
-000148f0: 7320 666f 7220 6561 6368 2061 7267 756d  s for each argum
-00014900: 656e 742e 0a62 6163 6b77 6172 645f 696d  ent..backward_im
-00014910: 706c 7320 3d20 7b0a 2020 2020 7072 696d  pls = {.    prim
-00014920: 732e 5072 696d 4944 732e 4143 4f53 3a20  s.PrimIDs.ACOS: 
-00014930: 6c61 6d62 6461 2078 2c20 673a 202d 6720  lambda x, g: -g 
-00014940: 2f20 7072 696d 732e 7371 7274 2831 2e30  / prims.sqrt(1.0
-00014950: 202d 2078 202a 2078 292c 0a20 2020 2070   - x * x),.    p
-00014960: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
-00014970: 5348 3a20 6c61 6d62 6461 2078 2c20 673a  SH: lambda x, g:
-00014980: 2067 202a 2070 7269 6d73 2e72 7371 7274   g * prims.rsqrt
-00014990: 2878 202a 2078 202d 2031 2e30 292c 0a20  (x * x - 1.0),. 
-000149a0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000149b0: 2e41 5349 4e3a 206c 616d 6264 6120 782c  .ASIN: lambda x,
-000149c0: 2067 3a20 6720 2f20 7072 696d 732e 7371   g: g / prims.sq
-000149d0: 7274 2831 2e30 202d 2078 202a 2078 292c  rt(1.0 - x * x),
-000149e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000149f0: 4473 2e41 5349 4e48 3a20 6c61 6d62 6461  Ds.ASINH: lambda
-00014a00: 2078 2c20 673a 2067 202a 2070 7269 6d73   x, g: g * prims
-00014a10: 2e72 7371 7274 2831 2e30 202b 2078 202a  .rsqrt(1.0 + x *
-00014a20: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
-00014a30: 7269 6d49 4473 2e41 5441 4e3a 206c 616d  rimIDs.ATAN: lam
-00014a40: 6264 6120 782c 2067 3a20 6720 2f20 2831  bda x, g: g / (1
-00014a50: 2e30 202b 2078 202a 2078 292c 0a20 2020  .0 + x * x),.   
-00014a60: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00014a70: 5441 4e48 3a20 6c61 6d62 6461 2078 2c20  TANH: lambda x, 
-00014a80: 673a 2067 202f 2028 312e 3020 2d20 7820  g: g / (1.0 - x 
-00014a90: 2a20 7829 2c0a 2020 2020 7072 696d 732e  * x),.    prims.
-00014aa0: 5072 696d 4944 732e 434f 5348 3a20 6c61  PrimIDs.COSH: la
-00014ab0: 6d62 6461 2078 2c20 673a 2070 7269 6d73  mbda x, g: prims
-00014ac0: 2e6d 756c 2867 2c20 7072 696d 732e 7369  .mul(g, prims.si
-00014ad0: 6e68 2878 2929 2c0a 2020 2020 7072 696d  nh(x)),.    prim
-00014ae0: 732e 5072 696d 4944 732e 4552 4643 3a20  s.PrimIDs.ERFC: 
-00014af0: 6c61 6d62 6461 2078 2c20 673a 202d 6720  lambda x, g: -g 
-00014b00: 2a20 322e 3020 2f20 6d61 7468 2e73 7172  * 2.0 / math.sqr
-00014b10: 7428 6d61 7468 2e70 6929 202a 2070 7269  t(math.pi) * pri
-00014b20: 6d73 2e65 7870 282d 7820 2a20 7829 2c0a  ms.exp(-x * x),.
-00014b30: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014b40: 732e 4552 4649 4e56 3a20 6c61 6d62 6461  s.ERFINV: lambda
-00014b50: 2072 6573 756c 742c 2067 3a20 6720 2a20   result, g: g * 
-00014b60: 302e 3520 2a20 6d61 7468 2e73 7172 7428  0.5 * math.sqrt(
-00014b70: 6d61 7468 2e70 6929 202a 2070 7269 6d73  math.pi) * prims
-00014b80: 2e65 7870 2872 6573 756c 742a 2a32 292c  .exp(result**2),
-00014b90: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014ba0: 4473 2e45 5246 4349 4e56 3a20 6c61 6d62  Ds.ERFCINV: lamb
-00014bb0: 6461 2072 6573 756c 742c 2067 3a20 2d67  da result, g: -g
-00014bc0: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
-00014bd0: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
-00014be0: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
-00014bf0: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00014c00: 696d 4944 732e 4558 5032 3a20 6c61 6d62  imIDs.EXP2: lamb
-00014c10: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
-00014c20: 2a20 7265 7375 6c74 202a 206d 6174 682e  * result * math.
-00014c30: 6c6f 6728 322e 3029 2c0a 2020 2020 7072  log(2.0),.    pr
-00014c40: 696d 732e 5072 696d 4944 732e 4558 504d  ims.PrimIDs.EXPM
-00014c50: 313a 206c 616d 6264 6120 7265 7375 6c74  1: lambda result
-00014c60: 2c20 673a 2067 202a 2028 7265 7375 6c74  , g: g * (result
-00014c70: 202b 2031 2e30 292c 0a20 2020 2070 7269   + 1.0),.    pri
-00014c80: 6d73 2e50 7269 6d49 4473 2e4c 4741 4d4d  ms.PrimIDs.LGAMM
-00014c90: 413a 206c 616d 6264 6120 782c 2067 3a20  A: lambda x, g: 
-00014ca0: 6720 2a20 7072 696d 732e 6469 6761 6d6d  g * prims.digamm
-00014cb0: 6128 7829 2c0a 2020 2020 7072 696d 732e  a(x),.    prims.
-00014cc0: 5072 696d 4944 732e 4e44 5452 493a 206c  PrimIDs.NDTRI: l
-00014cd0: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
-00014ce0: 2067 202a 2070 7269 6d73 2e65 7870 2830   g * prims.exp(0
-00014cf0: 2e35 202a 2072 6573 756c 742a 2a32 2920  .5 * result**2) 
-00014d00: 2a20 6d61 7468 2e73 7172 7428 322e 3020  * math.sqrt(2.0 
-00014d10: 2a20 6d61 7468 2e70 6929 2c0a 2020 2020  * math.pi),.    
-00014d20: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
-00014d30: 4e48 3a20 6c61 6d62 6461 2078 2c20 673a  NH: lambda x, g:
-00014d40: 2070 7269 6d73 2e6d 756c 2867 2c20 7072   prims.mul(g, pr
-00014d50: 696d 732e 636f 7368 2878 2929 2c0a 2020  ims.cosh(x)),.  
-00014d60: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014d70: 5351 5254 3a20 6c61 6d62 6461 2072 6573  SQRT: lambda res
-00014d80: 756c 742c 2067 3a20 6720 2f20 2832 2e30  ult, g: g / (2.0
-00014d90: 202a 2072 6573 756c 7429 2c0a 2020 2020   * result),.    
-00014da0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
-00014db0: 4731 303a 206c 616d 6264 6120 782c 2067  G10: lambda x, g
-00014dc0: 3a20 6720 2f20 2878 202a 2032 2e33 3032  : g / (x * 2.302
-00014dd0: 3538 3530 3932 3939 3430 3436 292c 0a20  585092994046),. 
-00014de0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014df0: 2e4c 4f47 3150 3a20 6c61 6d62 6461 2078  .LOG1P: lambda x
-00014e00: 2c20 673a 2067 202f 2028 7820 2b20 3129  , g: g / (x + 1)
-00014e10: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014e20: 4944 732e 4c4f 4732 3a20 6c61 6d62 6461  IDs.LOG2: lambda
-00014e30: 2078 2c20 673a 2067 202f 2028 7820 2a20   x, g: g / (x * 
-00014e40: 302e 3639 3331 3437 3138 3035 3539 3934  0.69314718055994
-00014e50: 3533 292c 0a20 2020 2070 7269 6d73 2e50  53),.    prims.P
-00014e60: 7269 6d49 4473 2e46 4d4f 443a 206c 616d  rimIDs.FMOD: lam
-00014e70: 6264 6120 782c 2079 2c20 673a 2028 672c  bda x, y, g: (g,
-00014e80: 202d 6720 2a20 7072 696d 732e 7472 756e   -g * prims.trun
-00014e90: 6328 7820 2f20 7929 292c 0a20 2020 2023  c(x / y)),.    #
-00014ea0: 2054 6865 2063 6f70 7920 7368 6f75 6c64   The copy should
-00014eb0: 206e 6f74 2062 6520 6469 6666 6572 656e   not be differen
-00014ec0: 7469 6162 6c65 2e20 5765 2072 6574 7572  tiable. We retur
-00014ed0: 6e20 4e6f 6e65 2074 6f20 656e 6162 6c65  n None to enable
-00014ee0: 2074 6865 2067 656e 6572 6174 696f 6e20   the generation 
-00014ef0: 6f66 2074 6865 2062 6163 6b77 6172 6420  of the backward 
-00014f00: 6772 6170 6820 7468 726f 7567 6820 7468  graph through th
-00014f10: 656d 2e0a 2020 2020 7072 696d 732e 5072  em..    prims.Pr
-00014f20: 696d 4944 732e 434f 5059 5f3a 206c 616d  imIDs.COPY_: lam
-00014f30: 6264 6120 673a 2028 4e6f 6e65 2c20 4e6f  bda g: (None, No
-00014f40: 6e65 292c 0a7d 0a0a 0a64 6566 2072 6567  ne),.}...def reg
-00014f50: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00014f60: 666f 7277 6172 6428 6f70 293a 0a20 2020  forward(op):.   
-00014f70: 2022 2222 4465 636f 7261 746f 7220 746f   """Decorator to
-00014f80: 2072 6567 6973 7465 7220 616e 2061 7567   register an aug
-00014f90: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
-00014fa0: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
-00014fb0: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
-00014fc0: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
-00014fd0: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
-00014fe0: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
-00014ff0: 6973 7465 7220 7468 6520 6175 676d 656e  ister the augmen
-00015000: 7465 6420 666f 7277 6172 6420 696d 706c  ted forward impl
-00015010: 656d 656e 7461 7469 6f6e 2e0a 0a20 2020  ementation...   
-00015020: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00015030: 2020 4361 6c6c 6162 6c65 3a20 4465 636f    Callable: Deco
-00015040: 7261 746f 7220 6675 6e63 7469 6f6e 2e0a  rator function..
-00015050: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
-00015060: 2064 6563 6f72 6174 6f72 2866 756e 6329   decorator(func)
-00015070: 3a0a 2020 2020 2020 2020 6175 676d 656e  :.        augmen
-00015080: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
-00015090: 735b 6f70 5d20 3d20 6675 6e63 0a20 2020  s[op] = func.   
-000150a0: 2020 2020 2072 6574 7572 6e20 6675 6e63       return func
-000150b0: 0a0a 2020 2020 7265 7475 726e 2064 6563  ..    return dec
-000150c0: 6f72 6174 6f72 0a0a 0a64 6566 2072 6567  orator...def reg
-000150d0: 6973 7465 725f 6261 636b 7761 7264 286f  ister_backward(o
-000150e0: 7029 3a0a 2020 2020 2222 2244 6563 6f72  p):.    """Decor
-000150f0: 6174 6f72 2074 6f20 7265 6769 7374 6572  ator to register
-00015100: 2061 2062 6163 6b77 6172 6420 696d 706c   a backward impl
-00015110: 656d 656e 7461 7469 6f6e 2066 6f72 2061  ementation for a
-00015120: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
-00015130: 6773 3a0a 2020 2020 2020 2020 6f70 2028  gs:.        op (
-00015140: 4f70 7329 3a20 5379 6d62 6f6c 2066 6f72  Ops): Symbol for
-00015150: 2077 6869 6368 2074 6f20 7265 6769 7374   which to regist
-00015160: 6572 2074 6865 2062 6163 6b77 6172 6420  er the backward 
-00015170: 696d 706c 656d 656e 7461 7469 6f6e 2e0a  implementation..
-00015180: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00015190: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
-000151a0: 4465 636f 7261 746f 7220 6675 6e63 7469  Decorator functi
-000151b0: 6f6e 2e0a 2020 2020 2222 220a 0a20 2020  on..    """..   
-000151c0: 2064 6566 2064 6563 6f72 6174 6f72 2866   def decorator(f
-000151d0: 756e 6329 3a0a 2020 2020 2020 2020 6261  unc):.        ba
-000151e0: 636b 7761 7264 5f69 6d70 6c73 5b6f 705d  ckward_impls[op]
-000151f0: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
-00015200: 7265 7475 726e 2066 756e 630a 0a20 2020  return func..   
-00015210: 2072 6574 7572 6e20 6465 636f 7261 746f   return decorato
-00015220: 720a 0a0a 6465 6620 7265 7374 6f72 655f  r...def restore_
-00015230: 7265 6475 6365 645f 6469 6d73 2878 2c20  reduced_dims(x, 
-00015240: 7265 6475 6365 645f 6469 6d73 2c20 6f72  reduced_dims, or
-00015250: 6967 696e 616c 5f73 6861 7065 293a 0a20  iginal_shape):. 
-00015260: 2020 2022 2222 5265 7374 6f72 6573 2074     """Restores t
-00015270: 6865 2072 6564 7563 6564 2064 696d 656e  he reduced dimen
-00015280: 7369 6f6e 7320 6f66 2061 2074 656e 736f  sions of a tenso
-00015290: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
-000152a0: 2020 2020 2020 7820 2856 6172 6961 626c        x (Variabl
-000152b0: 6529 3a20 5465 6e73 6f72 2074 6f20 6265  e): Tensor to be
-000152c0: 2072 6573 6861 7065 642e 0a20 2020 2020   reshaped..     
-000152d0: 2020 2072 6564 7563 6564 5f64 696d 7320     reduced_dims 
-000152e0: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
-000152f0: 293a 2054 7570 6c65 206f 6620 7265 6475  ): Tuple of redu
-00015300: 6365 6420 6469 6d65 6e73 696f 6e73 2e0a  ced dimensions..
-00015310: 2020 2020 2020 2020 6f72 6967 696e 616c          original
-00015320: 5f73 6861 7065 2028 5475 706c 655b 696e  _shape (Tuple[in
-00015330: 742c 202e 2e2e 5d29 3a20 4f72 6967 696e  t, ...]): Origin
-00015340: 616c 2073 6861 7065 206f 6620 7468 6520  al shape of the 
-00015350: 7465 6e73 6f72 2e0a 0a20 2020 2052 6574  tensor...    Ret
-00015360: 7572 6e73 3a0a 2020 2020 2020 2020 5661  urns:.        Va
-00015370: 7269 6162 6c65 3a20 5465 6e73 6f72 2077  riable: Tensor w
-00015380: 6974 6820 7468 6520 7265 6475 6365 6420  ith the reduced 
-00015390: 6469 6d65 6e73 696f 6e73 2072 6573 746f  dimensions resto
-000153a0: 7265 642e 0a20 2020 2022 2222 0a20 2020  red..    """.   
-000153b0: 2069 6620 6f72 6967 696e 616c 5f73 6861   if original_sha
-000153c0: 7065 203d 3d20 2829 3a20 2023 2073 6361  pe == ():  # sca
-000153d0: 6c61 720a 2020 2020 2020 2020 7265 7475  lar.        retu
-000153e0: 726e 2078 0a0a 2020 2020 756e 7371 7565  rn x..    unsque
-000153f0: 657a 6564 203d 2063 6c61 6e67 2e75 6e73  ezed = clang.uns
-00015400: 7175 6565 7a65 2878 2c20 7265 6475 6365  queeze(x, reduce
-00015410: 645f 6469 6d73 290a 2020 2020 7265 7475  d_dims).    retu
-00015420: 726e 2063 6c61 6e67 2e65 7870 616e 6428  rn clang.expand(
-00015430: 756e 7371 7565 657a 6564 2c20 6f72 6967  unsqueezed, orig
-00015440: 696e 616c 5f73 6861 7065 290a 0a0a 4072  inal_shape)...@r
-00015450: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00015460: 2870 7269 6d73 2e50 7269 6d49 4473 2e5a  (prims.PrimIDs.Z
-00015470: 4554 4129 0a64 6566 207a 6574 615f 6261  ETA).def zeta_ba
-00015480: 636b 7761 7264 2878 2c20 792c 2067 293a  ckward(x, y, g):
-00015490: 0a20 2020 2023 2054 6865 2064 6572 6976  .    # The deriv
-000154a0: 6174 6976 6520 7772 7420 7468 6520 6669  ative wrt the fi
-000154b0: 7273 7420 6172 6775 6d65 6e74 2069 7320  rst argument is 
-000154c0: 6e6f 7420 6578 7072 6573 7369 626c 6520  not expressible 
-000154d0: 696e 2074 6572 6d73 206f 6620 7a65 7461  in terms of zeta
-000154e0: 206f 720a 2020 2020 2320 6f74 6865 7220   or.    # other 
-000154f0: 7370 6563 6961 6c20 6675 6e63 7469 6f6e  special function
-00015500: 730a 2020 2020 2320 5468 6572 6566 6f72  s.    # Therefor
-00015510: 652c 2077 6520 636f 6d70 7574 6520 6f6e  e, we compute on
-00015520: 6c79 2074 6865 2064 6572 6976 6174 6976  ly the derivativ
-00015530: 6520 7772 7420 7468 6520 7365 636f 6e64  e wrt the second
-00015540: 2061 7267 756d 656e 740a 2020 2020 6779   argument.    gy
-00015550: 203d 2067 202a 202d 7820 2a20 7072 696d   = g * -x * prim
-00015560: 732e 7a65 7461 2878 202b 2031 2e30 2c20  s.zeta(x + 1.0, 
-00015570: 7929 0a0a 2020 2020 2320 5265 7475 726e  y)..    # Return
-00015580: 2061 206d 6170 7070 696e 6720 6672 6f6d   a mappping from
-00015590: 2074 6865 2066 6f72 7761 7264 2061 7267   the forward arg
-000155a0: 756d 656e 7473 2074 6f20 7468 6520 6772  uments to the gr
-000155b0: 6164 6965 6e74 730a 2020 2020 7265 7475  adients.    retu
-000155c0: 726e 207b 2279 223a 2067 797d 0a0a 0a40  rn {"y": gy}...@
-000155d0: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-000155e0: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-000155f0: 4449 4741 4d4d 4129 0a64 6566 2064 6967  DIGAMMA).def dig
-00015600: 616d 6d61 5f62 6163 6b77 6172 6428 613a  amma_backward(a:
-00015610: 2050 726f 7879 2c20 6729 3a0a 2020 2020   Proxy, g):.    
-00015620: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00015630: 6368 2069 6d70 6f72 7420 706f 6c79 6761  ch import polyga
-00015640: 6d6d 610a 0a20 2020 2072 6574 7572 6e20  mma..    return 
-00015650: 6720 2a20 706f 6c79 6761 6d6d 6128 312c  g * polygamma(1,
-00015660: 2061 290a 0a0a 4072 6567 6973 7465 725f   a)...@register_
-00015670: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00015680: 6428 2274 6f72 6368 2e70 6f6c 7967 616d  d("torch.polygam
-00015690: 6d61 2229 0a64 6566 2070 6f6c 7967 616d  ma").def polygam
-000156a0: 6d61 5f61 7567 5f66 7764 286e 3a20 696e  ma_aug_fwd(n: in
-000156b0: 742c 2061 3a20 5072 6f78 7929 3a0a 2020  t, a: Proxy):.  
-000156c0: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-000156d0: 6f72 6368 2069 6d70 6f72 7420 706f 6c79  orch import poly
-000156e0: 6761 6d6d 610a 0a20 2020 2070 7269 6d61  gamma..    prima
-000156f0: 6c20 3d20 706f 6c79 6761 6d6d 6128 6e2c  l = polygamma(n,
-00015700: 2061 290a 2020 2020 7265 7369 6475 616c   a).    residual
-00015710: 7320 3d20 286e 2c20 6129 0a20 2020 2072  s = (n, a).    r
-00015720: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00015730: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00015740: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00015750: 6b77 6172 6428 2274 6f72 6368 2e70 6f6c  kward("torch.pol
-00015760: 7967 616d 6d61 2229 0a64 6566 2070 6f6c  ygamma").def pol
-00015770: 7967 616d 6d61 5f62 6163 6b77 6172 6428  ygamma_backward(
-00015780: 6e3a 2069 6e74 2c20 613a 2050 726f 7879  n: int, a: Proxy
-00015790: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
-000157a0: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-000157b0: 6f72 7420 706f 6c79 6761 6d6d 610a 0a20  ort polygamma.. 
-000157c0: 2020 2072 6574 7572 6e20 4e6f 6e65 2c20     return None, 
-000157d0: 6720 2a20 706f 6c79 6761 6d6d 6128 6e20  g * polygamma(n 
-000157e0: 2b20 312c 2061 290a 0a0a 4072 6567 6973  + 1, a)...@regis
-000157f0: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
-00015800: 6d73 2e50 7269 6d49 4473 2e41 5441 4e32  ms.PrimIDs.ATAN2
-00015810: 290a 6465 6620 6174 616e 325f 6261 636b  ).def atan2_back
-00015820: 7761 7264 2878 2c20 792c 2067 293a 0a20  ward(x, y, g):. 
-00015830: 2020 2061 6c70 6861 203d 2031 2e30 202f     alpha = 1.0 /
-00015840: 2028 7820 2a20 7820 2b20 7920 2a20 7929   (x * x + y * y)
-00015850: 0a20 2020 2067 7261 645f 7820 3d20 6720  .    grad_x = g 
-00015860: 2a20 7920 2a20 616c 7068 610a 2020 2020  * y * alpha.    
-00015870: 6772 6164 5f79 203d 2067 202a 202d 7820  grad_y = g * -x 
-00015880: 2a20 616c 7068 610a 2020 2020 7265 7475  * alpha.    retu
-00015890: 726e 2067 7261 645f 782c 2067 7261 645f  rn grad_x, grad_
-000158a0: 790a 0a0a 4072 6567 6973 7465 725f 6175  y...@register_au
-000158b0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-000158c0: 7072 696d 732e 5072 696d 4944 732e 5641  prims.PrimIDs.VA
-000158d0: 5229 0a64 6566 2076 6172 5f61 7567 5f66  R).def var_aug_f
-000158e0: 7764 2861 2c20 6469 6d2c 202a 2c20 636f  wd(a, dim, *, co
-000158f0: 7272 6563 7469 6f6e 293a 0a20 2020 2076  rrection):.    v
-00015900: 203d 2070 7269 6d73 2e76 6172 2861 2c20   = prims.var(a, 
-00015910: 6469 6d2c 2063 6f72 7265 6374 696f 6e3d  dim, correction=
-00015920: 636f 7272 6563 7469 6f6e 290a 2020 2020  correction).    
-00015930: 7265 7475 726e 2056 4a50 4475 616c 2828  return VJPDual((
-00015940: 762c 292c 2028 612c 2064 696d 2c20 636f  v,), (a, dim, co
-00015950: 7272 6563 7469 6f6e 2c20 7629 290a 0a0a  rrection, v))...
-00015960: 2320 544f 444f 3a20 6669 7820 6469 7669  # TODO: fix divi
-00015970: 7369 6f6e 2062 7920 7a65 726f 2077 6865  sion by zero whe
-00015980: 6e20 6e5f 656c 656d 5f72 6564 7563 6564  n n_elem_reduced
-00015990: 203d 3d20 3020 6f72 2077 6865 6e20 762e   == 0 or when v.
-000159a0: 6e75 6d65 6c20 3d3d 2030 0a23 2062 7920  numel == 0.# by 
-000159b0: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
-000159c0: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
-000159d0: 6172 2e0a 2320 544f 444f 3a20 6669 7820  ar..# TODO: fix 
-000159e0: 6772 6164 2077 6865 6e20 636f 7272 6563  grad when correc
-000159f0: 7469 6f6e 203e 206e 5f65 6c65 6d5f 7265  tion > n_elem_re
-00015a00: 6475 6365 642e 0a40 7265 6769 7374 6572  duced..@register
-00015a10: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
-00015a20: 5072 696d 4944 732e 5641 5229 0a64 6566  PrimIDs.VAR).def
-00015a30: 2076 6172 5f62 6163 6b77 6172 6428 612c   var_backward(a,
-00015a40: 2064 696d 2c20 636f 7272 6563 7469 6f6e   dim, correction
-00015a50: 2c20 762c 2067 293a 0a20 2020 206e 5f65  , v, g):.    n_e
-00015a60: 6c65 6d5f 7265 6475 6365 6420 3d20 612e  lem_reduced = a.
-00015a70: 6e75 6d65 6c20 2f2f 2076 2e6e 756d 656c  numel // v.numel
-00015a80: 2069 6620 612e 6e75 6d65 6c20 213d 2030   if a.numel != 0
-00015a90: 2065 6c73 6520 310a 2020 2020 6e6f 726d   else 1.    norm
-00015aa0: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
-00015ab0: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
-00015ac0: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
-00015ad0: 2020 2067 203d 2072 6573 746f 7265 5f72     g = restore_r
-00015ae0: 6564 7563 6564 5f64 696d 7328 672c 2064  educed_dims(g, d
-00015af0: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
-00015b00: 2069 6620 612e 6474 7970 6520 213d 2076   if a.dtype != v
-00015b10: 2e64 7479 7065 3a0a 2020 2020 2020 2020  .dtype:.        
-00015b20: 6120 3d20 7072 696d 732e 636f 6e76 6572  a = prims.conver
-00015b30: 745f 656c 656d 656e 745f 7479 7065 2861  t_element_type(a
-00015b40: 2c20 762e 6474 7970 6529 0a20 2020 206d  , v.dtype).    m
-00015b50: 6561 6e20 3d20 7072 696d 732e 7375 6d28  ean = prims.sum(
-00015b60: 612c 2064 696d 2920 2f20 6e5f 656c 656d  a, dim) / n_elem
-00015b70: 5f72 6564 7563 6564 0a20 2020 206d 6561  _reduced.    mea
-00015b80: 6e20 3d20 7265 7374 6f72 655f 7265 6475  n = restore_redu
-00015b90: 6365 645f 6469 6d73 286d 6561 6e2c 2064  ced_dims(mean, d
-00015ba0: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
-00015bb0: 2072 6574 7572 6e20 2832 202a 2067 202a   return (2 * g *
-00015bc0: 2028 6120 2d20 6d65 616e 2929 202f 206e   (a - mean)) / n
-00015bd0: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
-00015be0: 6c61 720a 0a0a 6465 6620 6e5f 656c 656d  lar...def n_elem
-00015bf0: 5f72 6564 7563 6564 2861 5f6e 6469 6d2c  _reduced(a_ndim,
-00015c00: 2061 5f73 6861 7065 2c20 6469 6d73 293a   a_shape, dims):
-00015c10: 0a20 2020 2064 696d 7320 3d20 7574 696c  .    dims = util
-00015c20: 732e 6361 6e6f 6e69 6361 6c69 7a65 5f64  s.canonicalize_d
-00015c30: 696d 7328 615f 6e64 696d 2c20 6469 6d73  ims(a_ndim, dims
-00015c40: 290a 2020 2020 7265 6475 6374 696f 6e5f  ).    reduction_
-00015c50: 7369 7a65 203d 2031 0a20 2020 2066 6f72  size = 1.    for
-00015c60: 2069 6478 2c20 7369 7a65 2069 6e20 656e   idx, size in en
-00015c70: 756d 6572 6174 6528 615f 7368 6170 6529  umerate(a_shape)
-00015c80: 3a0a 2020 2020 2020 2020 6966 2069 6478  :.        if idx
-00015c90: 2069 6e20 6469 6d73 3a0a 2020 2020 2020   in dims:.      
-00015ca0: 2020 2020 2020 7265 6475 6374 696f 6e5f        reduction_
-00015cb0: 7369 7a65 202a 3d20 7369 7a65 0a20 2020  size *= size.   
-00015cc0: 2072 6574 7572 6e20 7265 6475 6374 696f   return reductio
-00015cd0: 6e5f 7369 7a65 0a0a 0a64 6566 206d 6561  n_size...def mea
-00015ce0: 6e5f 6261 636b 7761 7264 2861 5f6e 6469  n_backward(a_ndi
-00015cf0: 6d2c 2061 5f73 6861 7065 2c20 6469 6d73  m, a_shape, dims
-00015d00: 2c20 6772 6164 293a 0a20 2020 206d 6561  , grad):.    mea
-00015d10: 6e5f 6c6f 6361 6c5f 6772 6164 203d 2031  n_local_grad = 1
-00015d20: 2e30 202f 206e 5f65 6c65 6d5f 7265 6475  .0 / n_elem_redu
-00015d30: 6365 6428 615f 6e64 696d 2c20 615f 7368  ced(a_ndim, a_sh
-00015d40: 6170 652c 2064 696d 7329 0a20 2020 2072  ape, dims).    r
-00015d50: 6574 7572 6e20 7265 7374 6f72 655f 7265  eturn restore_re
-00015d60: 6475 6365 645f 6469 6d73 2867 7261 642c  duced_dims(grad,
-00015d70: 2064 696d 732c 2061 5f73 6861 7065 2920   dims, a_shape) 
-00015d80: 2a20 6d65 616e 5f6c 6f63 616c 5f67 7261  * mean_local_gra
-00015d90: 640a 0a0a 4072 6567 6973 7465 725f 6175  d...@register_au
-00015da0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-00015db0: 7072 696d 732e 5072 696d 4944 732e 5041  prims.PrimIDs.PA
-00015dc0: 4429 0a64 6566 2070 6164 5f61 7567 5f66  D).def pad_aug_f
-00015dd0: 7764 2861 2c20 7061 6464 696e 675f 7661  wd(a, padding_va
-00015de0: 6c75 652c 2070 6164 6469 6e67 5f63 6f6e  lue, padding_con
-00015df0: 6669 6729 3a0a 2020 2020 7265 7475 726e  fig):.    return
-00015e00: 2056 4a50 4475 616c 2828 7072 696d 732e   VJPDual((prims.
-00015e10: 7061 6428 612c 2070 6164 6469 6e67 5f76  pad(a, padding_v
-00015e20: 616c 7565 2c20 7061 6464 696e 675f 636f  alue, padding_co
-00015e30: 6e66 6967 292c 292c 2028 612c 2070 6164  nfig),), (a, pad
-00015e40: 6469 6e67 5f63 6f6e 6669 6729 290a 0a0a  ding_config))...
-00015e50: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-00015e60: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-00015e70: 2e50 4144 290a 6465 6620 7061 645f 6261  .PAD).def pad_ba
-00015e80: 636b 7761 7264 2861 2c20 7061 6464 696e  ckward(a, paddin
-00015e90: 675f 636f 6e66 6967 2c20 6729 3a0a 2020  g_config, g):.  
-00015ea0: 2020 2320 5368 6f72 7420 6369 7263 7569    # Short circui
-00015eb0: 7420 6f6e 2065 6d70 7479 2069 6e70 7574  t on empty input
-00015ec0: 2e0a 2020 2020 6966 2061 6e79 2864 696d  ..    if any(dim
-00015ed0: 203d 3d20 3020 666f 7220 6469 6d20 696e   == 0 for dim in
-00015ee0: 2061 2e73 6861 7065 293a 0a20 2020 2020   a.shape):.     
-00015ef0: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
-00015f00: 696b 6528 612c 2066 696c 6c5f 7661 6c75  ike(a, fill_valu
-00015f10: 653d 3029 0a0a 2020 2020 2320 556e 2d70  e=0)..    # Un-p
-00015f20: 6164 2062 7920 7061 6464 696e 6720 7769  ad by padding wi
-00015f30: 7468 207a 6572 6f20 7661 6c75 6573 0a20  th zero values. 
-00015f40: 2020 207a 6572 6f5f 7061 6464 696e 675f     zero_padding_
-00015f50: 636f 6e66 6967 203d 205b 282d 6c6f 2c20  config = [(-lo, 
-00015f60: 2d68 692c 2030 2920 666f 7220 6c6f 2c20  -hi, 0) for lo, 
-00015f70: 6869 2c20 5f20 696e 2070 6164 6469 6e67  hi, _ in padding
-00015f80: 5f63 6f6e 6669 675d 0a0a 2020 2020 6720  _config]..    g 
-00015f90: 3d20 7072 696d 732e 7061 6428 672c 2030  = prims.pad(g, 0
-00015fa0: 2e30 2c20 7a65 726f 5f70 6164 6469 6e67  .0, zero_padding
-00015fb0: 5f63 6f6e 6669 6729 0a0a 2020 2020 2320  _config)..    # 
-00015fc0: 556e 2d73 6c69 6365 2062 7920 736c 6963  Un-slice by slic
-00015fd0: 696e 6720 7769 7468 2061 2073 7472 6964  ing with a strid
-00015fe0: 6520 6f66 2076 616c 7565 2028 6469 6c61  e of value (dila
-00015ff0: 7469 6f6e 202b 2031 290a 2020 2020 666f  tion + 1).    fo
-00016000: 7220 6469 6d2c 2028 5f2c 205f 2c20 6429  r dim, (_, _, d)
-00016010: 2069 6e20 656e 756d 6572 6174 6528 7061   in enumerate(pa
-00016020: 6464 696e 675f 636f 6e66 6967 293a 0a20  dding_config):. 
-00016030: 2020 2020 2020 2067 203d 2073 6c69 6365         g = slice
-00016040: 5f69 6e5f 6469 6d28 672c 2030 2c20 672e  _in_dim(g, 0, g.
-00016050: 7368 6170 655b 6469 6d5d 2c20 7374 7269  shape[dim], stri
-00016060: 6465 3d64 202b 2031 2c20 6469 6d3d 6469  de=d + 1, dim=di
-00016070: 6d29 0a0a 2020 2020 7265 7475 726e 2067  m)..    return g
-00016080: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-00016090: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
-000160a0: 7269 6d73 2e50 7269 6d49 4473 2e50 524f  rims.PrimIDs.PRO
-000160b0: 4429 0a64 6566 2070 726f 645f 6175 675f  D).def prod_aug_
-000160c0: 6677 6428 782c 2064 696d 7329 3a0a 2020  fwd(x, dims):.  
-000160d0: 2020 2222 2241 7567 6d65 6e74 6564 2070    """Augmented p
-000160e0: 726f 6420 6f70 6572 6174 696f 6e2e 0a0a  rod operation...
-000160f0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00016100: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
-00016110: 5465 6e73 6f72 2074 6f20 6265 206d 756c  Tensor to be mul
-00016120: 7469 706c 6965 642e 0a20 2020 2020 2020  tiplied..       
-00016130: 2064 696d 7320 2854 7570 6c65 5b69 6e74   dims (Tuple[int
-00016140: 2c20 2e2e 2e5d 293a 2044 696d 656e 7369  , ...]): Dimensi
-00016150: 6f6e 7320 746f 2062 6520 6d75 6c74 6970  ons to be multip
-00016160: 6c69 6564 2e0a 0a20 2020 2052 6574 7572  lied...    Retur
-00016170: 6e73 3a0a 2020 2020 2020 2020 564a 5044  ns:.        VJPD
-00016180: 7561 6c3a 2050 7269 6d61 6c20 616e 6420  ual: Primal and 
-00016190: 7265 7369 6475 616c 732e 0a20 2020 2022  residuals..    "
-000161a0: 2222 0a20 2020 2070 7269 6d61 6c20 3d20  "".    primal = 
-000161b0: 7072 696d 732e 7072 6f64 2878 2c20 6469  prims.prod(x, di
-000161c0: 6d73 290a 0a20 2020 2072 6573 6964 7561  ms)..    residua
-000161d0: 6c73 203d 2028 0a20 2020 2020 2020 2070  ls = (.        p
-000161e0: 7269 6d61 6c2c 0a20 2020 2020 2020 2078  rimal,.        x
-000161f0: 2c0a 2020 2020 2020 2020 782e 7368 6170  ,.        x.shap
-00016200: 652c 0a20 2020 2020 2020 2064 696d 732c  e,.        dims,
-00016210: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-00016220: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-00016230: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
-00016240: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00016250: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00016260: 5052 4f44 290a 6465 6620 7072 6f64 5f70  PROD).def prod_p
-00016270: 756c 6c62 6163 6b28 7072 696d 616c 2c20  ullback(primal, 
-00016280: 782c 2078 5f73 6861 7065 2c20 7265 6475  x, x_shape, redu
-00016290: 6365 645f 6469 6d73 2c20 6729 3a0a 2020  ced_dims, g):.  
-000162a0: 2020 7265 7475 726e 2070 7269 6d73 2e64    return prims.d
-000162b0: 6976 2872 6573 746f 7265 5f72 6564 7563  iv(restore_reduc
-000162c0: 6564 5f64 696d 7328 7072 696d 616c 202a  ed_dims(primal *
-000162d0: 2067 2c20 7265 6475 6365 645f 6469 6d73   g, reduced_dims
-000162e0: 2c20 785f 7368 6170 6529 2c20 7829 0a0a  , x_shape), x)..
-000162f0: 0a64 6566 206b 6565 7064 696d 5f72 6564  .def keepdim_red
-00016300: 7563 7469 6f6e 2872 6564 7563 7469 6f6e  uction(reduction
-00016310: 5f66 6e2c 2078 2c20 6469 6d73 293a 0a20  _fn, x, dims):. 
-00016320: 2020 2022 2222 4170 706c 6965 7320 7265     """Applies re
-00016330: 6475 6374 696f 6e20 616e 6420 6669 7865  duction and fixe
-00016340: 7320 6f75 7470 7574 2074 6f20 636f 6e66  s output to conf
-00016350: 6f72 6d20 746f 206b 6565 7064 696d 3d54  orm to keepdim=T
-00016360: 7275 6522 2222 0a20 2020 206f 7574 203d  rue""".    out =
-00016370: 2072 6564 7563 7469 6f6e 5f66 6e28 782c   reduction_fn(x,
-00016380: 2064 696d 7329 0a20 2020 2061 7267 6d61   dims).    argma
-00016390: 785f 7375 6d5f 6f75 745f 7368 6170 6520  x_sum_out_shape 
-000163a0: 3d20 5b78 2e73 6861 7065 5b69 5d20 6966  = [x.shape[i] if
-000163b0: 2069 206e 6f74 2069 6e20 6469 6d73 2065   i not in dims e
-000163c0: 6c73 6520 3120 666f 7220 6920 696e 2072  lse 1 for i in r
-000163d0: 616e 6765 2878 2e6e 6469 6d29 5d0a 2020  ange(x.ndim)].  
-000163e0: 2020 6272 6f61 6463 6173 745f 6469 6d73    broadcast_dims
-000163f0: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
-00016400: 616e 6765 2878 2e6e 6469 6d29 2069 6620  ange(x.ndim) if 
-00016410: 6920 6e6f 7420 696e 2064 696d 735d 0a20  i not in dims]. 
-00016420: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
-00016430: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
-00016440: 286f 7574 2c20 6172 676d 6178 5f73 756d  (out, argmax_sum
-00016450: 5f6f 7574 5f73 6861 7065 2c20 6272 6f61  _out_shape, broa
-00016460: 6463 6173 745f 6469 6d73 290a 0a0a 2320  dcast_dims)...# 
-00016470: 496e 7370 6972 6564 2066 726f 6d20 6874  Inspired from ht
-00016480: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-00016490: 2f48 4950 532f 6175 746f 6772 6164 2f62  /HIPS/autograd/b
-000164a0: 6c6f 622f 6d61 7374 6572 2f61 7574 6f67  lob/master/autog
-000164b0: 7261 642f 6e75 6d70 792f 6e75 6d70 795f  rad/numpy/numpy_
-000164c0: 766a 7073 2e70 7923 4c33 3533 0a64 6566  vjps.py#L353.def
-000164d0: 2067 7261 645f 6368 6f6f 7365 725f 6261   grad_chooser_ba
-000164e0: 636b 7761 7264 2870 7269 6d61 6c2c 2078  ckward(primal, x
-000164f0: 2c20 785f 7368 6170 652c 2072 6564 7563  , x_shape, reduc
-00016500: 6564 5f64 696d 732c 2067 293a 0a20 2020  ed_dims, g):.   
-00016510: 2022 2222 4275 696c 6473 2067 7261 6469   """Builds gradi
-00016520: 656e 7420 6f66 2066 756e 6374 696f 6e73  ent of functions
-00016530: 2074 6861 7420 6368 6f6f 7365 2061 2073   that choose a s
-00016540: 696e 676c 6520 6974 656d 2c20 7375 6368  ingle item, such
-00016550: 2061 7320 6d69 6e20 6f72 206d 6178 2e22   as min or max."
-00016560: 2222 0a20 2020 2067 5f72 6570 6561 7465  "".    g_repeate
-00016570: 6420 3d20 7265 7374 6f72 655f 7265 6475  d = restore_redu
-00016580: 6365 645f 6469 6d73 2867 2c20 7265 6475  ced_dims(g, redu
-00016590: 6365 645f 6469 6d73 2c20 785f 7368 6170  ced_dims, x_shap
-000165a0: 6529 0a20 2020 2070 7269 6d61 6c5f 7265  e).    primal_re
-000165b0: 7065 6174 6564 203d 2072 6573 746f 7265  peated = restore
-000165c0: 5f72 6564 7563 6564 5f64 696d 7328 7072  _reduced_dims(pr
-000165d0: 696d 616c 2c20 7265 6475 6365 645f 6469  imal, reduced_di
-000165e0: 6d73 2c20 785f 7368 6170 6529 0a20 2020  ms, x_shape).   
-000165f0: 2061 7267 6d61 785f 6c6f 6361 7469 6f6e   argmax_location
-00016600: 7320 3d20 7820 3d3d 2070 7269 6d61 6c5f  s = x == primal_
-00016610: 7265 7065 6174 6564 0a20 2020 2061 7267  repeated.    arg
-00016620: 6d61 785f 7375 6d20 3d20 6b65 6570 6469  max_sum = keepdi
-00016630: 6d5f 7265 6475 6374 696f 6e28 7072 696d  m_reduction(prim
-00016640: 732e 7375 6d2c 2061 7267 6d61 785f 6c6f  s.sum, argmax_lo
-00016650: 6361 7469 6f6e 732c 2072 6564 7563 6564  cations, reduced
-00016660: 5f64 696d 7329 0a20 2020 206f 7574 203d  _dims).    out =
-00016670: 2067 5f72 6570 6561 7465 6420 2a20 6172   g_repeated * ar
-00016680: 676d 6178 5f6c 6f63 6174 696f 6e73 202f  gmax_locations /
-00016690: 2061 7267 6d61 785f 7375 6d0a 2020 2020   argmax_sum.    
-000166a0: 7265 7475 726e 206f 7574 0a0a 0a72 6567  return out...reg
-000166b0: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
-000166c0: 7269 6d73 2e50 7269 6d49 4473 2e41 4d49  rims.PrimIDs.AMI
-000166d0: 4e29 2867 7261 645f 6368 6f6f 7365 725f  N)(grad_chooser_
-000166e0: 6261 636b 7761 7264 290a 0a0a 4072 6567  backward)...@reg
-000166f0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00016700: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00016710: 696d 4944 732e 414d 494e 290a 6465 6620  imIDs.AMIN).def 
-00016720: 616d 696e 5f61 7567 5f66 7764 2878 2c20  amin_aug_fwd(x, 
-00016730: 6469 6d73 293a 0a20 2020 2022 2222 4175  dims):.    """Au
-00016740: 676d 656e 7465 6420 616d 696e 206f 7065  gmented amin ope
-00016750: 7261 7469 6f6e 2e0a 2020 2020 4172 6773  ration..    Args
-00016760: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
-00016770: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
-00016780: 6f20 636f 6d70 7574 6520 616d 696e 206f  o compute amin o
-00016790: 6e2e 0a20 2020 2020 2020 2064 696d 7320  n..        dims 
-000167a0: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
-000167b0: 293a 2044 696d 656e 7369 6f6e 7320 746f  ): Dimensions to
-000167c0: 2063 6f6d 7075 7465 2061 6d69 6e20 6f76   compute amin ov
-000167d0: 6572 2e0a 2020 2020 5265 7475 726e 733a  er..    Returns:
-000167e0: 0a20 2020 2020 2020 2056 4a50 4475 616c  .        VJPDual
-000167f0: 3a20 5072 696d 616c 2061 6e64 2072 6573  : Primal and res
-00016800: 6964 7561 6c73 2e0a 2020 2020 2222 220a  iduals..    """.
-00016810: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
-00016820: 6d73 2e61 6d69 6e28 782c 2064 696d 7329  ms.amin(x, dims)
-00016830: 0a0a 2020 2020 7265 7369 6475 616c 7320  ..    residuals 
-00016840: 3d20 280a 2020 2020 2020 2020 7072 696d  = (.        prim
-00016850: 616c 2c0a 2020 2020 2020 2020 782c 0a20  al,.        x,. 
-00016860: 2020 2020 2020 2078 2e73 6861 7065 2c0a         x.shape,.
-00016870: 2020 2020 2020 2020 6469 6d73 2c0a 2020          dims,.  
-00016880: 2020 290a 0a20 2020 2072 6574 7572 6e20    )..    return 
-00016890: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-000168a0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-000168b0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-000168c0: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
-000168d0: 7269 6d49 4473 2e50 4f57 290a 6465 6620  rimIDs.POW).def 
-000168e0: 706f 775f 6175 675f 6665 6428 782c 2079  pow_aug_fed(x, y
-000168f0: 293a 0a20 2020 2022 2222 4175 676d 656e  ):.    """Augmen
-00016900: 7465 6420 7468 6520 706f 7720 6f70 6572  ted the pow oper
-00016910: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
-00016920: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
-00016930: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
-00016940: 6974 6820 7468 6520 6261 7365 2074 6f20  ith the base to 
-00016950: 6265 2065 7870 6f6e 656e 7469 6174 6564  be exponentiated
-00016960: 2e0a 2020 2020 2020 2020 7920 2856 6172  ..        y (Var
-00016970: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
-00016980: 6974 6820 706f 7765 7220 746f 2072 6169  ith power to rai
-00016990: 7365 2074 6f2e 0a0a 2020 2020 5265 7475  se to...    Retu
-000169a0: 726e 733a 0a20 2020 2020 2020 2056 4a50  rns:.        VJP
-000169b0: 4475 616c 3a20 5072 696d 616c 2061 6e64  Dual: Primal and
-000169c0: 2072 6573 6964 7561 6c73 2e0a 2020 2020   residuals..    
-000169d0: 2222 220a 2020 2020 7072 696d 616c 203d  """.    primal =
-000169e0: 2070 7269 6d73 2e70 6f77 2878 2c20 7929   prims.pow(x, y)
-000169f0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-00016a00: 2028 7072 696d 616c 2c20 782c 2079 290a   (primal, x, y).
-00016a10: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00016a20: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00016a30: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00016a40: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
-00016a50: 2e50 7269 6d49 4473 2e50 4f57 290a 6465  .PrimIDs.POW).de
-00016a60: 6620 706f 775f 6261 636b 7761 7264 2872  f pow_backward(r
-00016a70: 6573 756c 742c 2078 2c20 792c 2067 293a  esult, x, y, g):
-00016a80: 0a20 2020 2069 6d70 6f72 7420 7468 756e  .    import thun
-00016a90: 6465 722e 636c 616e 6720 6173 2074 6c61  der.clang as tla
-00016aa0: 6e67 0a0a 2020 2020 6772 6573 756c 7420  ng..    gresult 
-00016ab0: 3d20 6720 2a20 7265 7375 6c74 2020 2320  = g * result  # 
-00016ac0: 7265 7573 6520 636f 6d6d 6f6e 2066 6163  reuse common fac
-00016ad0: 746f 720a 2020 2020 6478 203d 2067 202a  tor.    dx = g *
-00016ae0: 2079 202a 2078 202a 2a20 2879 202d 2031   y * x ** (y - 1
-00016af0: 290a 2020 2020 6479 203d 2067 7265 7375  ).    dy = gresu
-00016b00: 6c74 202a 2074 6c61 6e67 2e6c 6f67 2878  lt * tlang.log(x
-00016b10: 290a 2020 2020 7265 7475 726e 2064 782c  ).    return dx,
-00016b20: 2064 790a 0a0a 4072 6567 6973 7465 725f   dy...@register_
-00016b30: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00016b40: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00016b50: 5441 4e29 0a64 6566 2074 616e 5f61 7567  TAN).def tan_aug
-00016b60: 5f66 7764 2878 293a 0a20 2020 2022 2222  _fwd(x):.    """
-00016b70: 4175 676d 656e 7465 6420 7461 6e20 6f70  Augmented tan op
-00016b80: 6572 6174 696f 6e2e 0a0a 2020 2020 4172  eration...    Ar
-00016b90: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
-00016ba0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
-00016bb0: 2074 6f20 6265 2070 6173 7365 6420 746f   to be passed to
-00016bc0: 2074 616e 2e0a 2020 2020 2222 220a 0a20   tan..    """.. 
-00016bd0: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
-00016be0: 732e 7461 6e28 7829 0a20 2020 2072 6573  s.tan(x).    res
-00016bf0: 6964 7561 6c73 203d 2028 7072 696d 616c  iduals = (primal
-00016c00: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
-00016c10: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-00016c20: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-00016c30: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
-00016c40: 696d 732e 5072 696d 4944 732e 5441 4e29  ims.PrimIDs.TAN)
-00016c50: 0a64 6566 2074 616e 5f62 6163 6b77 6172  .def tan_backwar
-00016c60: 6428 7265 7375 6c74 2c20 6729 3a0a 2020  d(result, g):.  
-00016c70: 2020 7265 7475 726e 2067 202a 2028 3120    return g * (1 
-00016c80: 2b20 7265 7375 6c74 202a 2072 6573 756c  + result * resul
-00016c90: 7429 0a0a 0a23 204e 4f54 453a 204a 6178  t)...# NOTE: Jax
-00016ca0: 2075 7365 7320 6e70 2e61 7267 736f 7274   uses np.argsort
-00016cb0: 2069 6e20 6974 7320 7472 616e 7370 6f73   in its transpos
-00016cc0: 6520 766a 7020 636f 6d70 7574 6174 696f  e vjp computatio
-00016cd0: 6e0a 6465 6620 5f61 7267 736f 7274 2873  n.def _argsort(s
-00016ce0: 6571 293a 0a20 2020 2072 6574 7572 6e20  eq):.    return 
-00016cf0: 736f 7274 6564 2872 616e 6765 286c 656e  sorted(range(len
-00016d00: 2873 6571 2929 2c20 6b65 793d 7365 712e  (seq)), key=seq.
-00016d10: 5f5f 6765 7469 7465 6d5f 5f29 0a0a 0a40  __getitem__)...@
-00016d20: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-00016d30: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
-00016d40: 2e50 7269 6d49 4473 2e44 4556 4943 455f  .PrimIDs.DEVICE_
-00016d50: 5055 5429 0a64 6566 2064 6576 6963 655f  PUT).def device_
-00016d60: 7075 745f 6175 675f 6677 6428 613a 2054  put_aug_fwd(a: T
-00016d70: 656e 736f 7250 726f 7879 2c20 6465 7669  ensorProxy, devi
-00016d80: 6365 3a20 4465 7669 6365 2920 2d3e 2054  ce: Device) -> T
-00016d90: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00016da0: 7072 696d 616c 203d 2070 7269 6d73 2e64  primal = prims.d
-00016db0: 6576 6963 655f 7075 7428 612c 2064 6576  evice_put(a, dev
-00016dc0: 6963 6529 0a20 2020 2072 6573 6964 7561  ice).    residua
-00016dd0: 6c73 203d 2028 612e 6465 7669 6365 2c29  ls = (a.device,)
-00016de0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-00016df0: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
-00016e00: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
-00016e10: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
-00016e20: 732e 5072 696d 4944 732e 4445 5649 4345  s.PrimIDs.DEVICE
-00016e30: 5f50 5554 290a 6465 6620 6465 7669 6365  _PUT).def device
-00016e40: 5f70 7574 5f62 6163 6b77 6172 6428 6f72  _put_backward(or
-00016e50: 6967 5f64 6576 6963 652c 2067 293a 0a20  ig_device, g):. 
-00016e60: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
-00016e70: 6465 7669 6365 5f70 7574 2867 2c20 6f72  device_put(g, or
-00016e80: 6967 5f64 6576 6963 6529 2c20 4e6f 6e65  ig_device), None
-00016e90: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-00016ea0: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
-00016eb0: 7269 6d73 2e50 7269 6d49 4473 2e43 4f4e  rims.PrimIDs.CON
-00016ec0: 564f 4c55 5449 4f4e 290a 6465 6620 636f  VOLUTION).def co
-00016ed0: 6e76 6f6c 7574 696f 6e5f 6175 675f 6677  nvolution_aug_fw
-00016ee0: 6428 0a20 2020 2061 3a20 5072 6f78 792c  d(.    a: Proxy,
-00016ef0: 0a20 2020 2077 6569 6768 742c 0a20 2020  .    weight,.   
-00016f00: 2062 6961 732c 0a20 2020 2073 7472 6964   bias,.    strid
-00016f10: 652c 0a20 2020 2070 6164 6469 6e67 2c0a  e,.    padding,.
-00016f20: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
-00016f30: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
-00016f40: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
-00016f50: 2c0a 2020 2020 6772 6f75 7073 2c0a 293a  ,.    groups,.):
-00016f60: 0a20 2020 2070 7269 6d61 6c20 3d20 636f  .    primal = co
-00016f70: 6e76 6f6c 7574 696f 6e28 612c 2077 6569  nvolution(a, wei
-00016f80: 6768 742c 2062 6961 732c 2073 7472 6964  ght, bias, strid
-00016f90: 652c 2070 6164 6469 6e67 2c20 6469 6c61  e, padding, dila
-00016fa0: 7469 6f6e 2c20 7472 616e 7370 6f73 6564  tion, transposed
-00016fb0: 2c20 6f75 7470 7574 5f70 6164 6469 6e67  , output_padding
-00016fc0: 2c20 6772 6f75 7073 290a 2020 2020 7265  , groups).    re
-00016fd0: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
-00016fe0: 6c2c 2061 2c20 7765 6967 6874 2c20 6269  l, a, weight, bi
-00016ff0: 6173 2c20 7374 7269 6465 2c20 7061 6464  as, stride, padd
-00017000: 696e 672c 2064 696c 6174 696f 6e2c 2074  ing, dilation, t
-00017010: 7261 6e73 706f 7365 642c 206f 7574 7075  ransposed, outpu
-00017020: 745f 7061 6464 696e 672c 2067 726f 7570  t_padding, group
-00017030: 7329 0a20 2020 2072 6574 7572 6e20 564a  s).    return VJ
-00017040: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-00017050: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-00017060: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
-00017070: 696d 732e 5072 696d 4944 732e 434f 4e56  ims.PrimIDs.CONV
-00017080: 4f4c 5554 494f 4e29 0a64 6566 2063 6f6e  OLUTION).def con
-00017090: 766f 6c75 7469 6f6e 5f62 6163 6b77 6172  volution_backwar
-000170a0: 6428 0a20 2020 206f 7574 7075 743a 2050  d(.    output: P
-000170b0: 726f 7879 2c0a 2020 2020 696e 7075 743a  roxy,.    input:
-000170c0: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
-000170d0: 6874 2c0a 2020 2020 6269 6173 2c0a 2020  ht,.    bias,.  
-000170e0: 2020 7374 7269 6465 2c0a 2020 2020 7061    stride,.    pa
-000170f0: 6464 696e 672c 0a20 2020 2064 696c 6174  dding,.    dilat
-00017100: 696f 6e2c 0a20 2020 2074 7261 6e73 706f  ion,.    transpo
-00017110: 7365 642c 0a20 2020 206f 7574 7075 745f  sed,.    output_
-00017120: 7061 6464 696e 672c 0a20 2020 2067 726f  padding,.    gro
-00017130: 7570 732c 0a20 2020 2067 7261 642c 0a29  ups,.    grad,.)
-00017140: 3a0a 2020 2020 2320 5472 616e 7370 6f73  :.    # Transpos
-00017150: 6564 2063 6f6e 766f 6c75 7469 6f6e 2069  ed convolution i
-00017160: 7320 6e6f 7420 7375 7070 6f72 7465 6421  s not supported!
-00017170: 0a20 2020 2061 7373 6572 7420 7472 616e  .    assert tran
-00017180: 7370 6f73 6564 203d 3d20 300a 0a20 2020  sposed == 0..   
-00017190: 2069 6e70 7574 5f67 7261 6420 3d20 4e6f   input_grad = No
-000171a0: 6e65 0a20 2020 2077 6569 6768 745f 6772  ne.    weight_gr
-000171b0: 6164 203d 204e 6f6e 650a 2020 2020 6269  ad = None.    bi
-000171c0: 6173 5f67 7261 6420 3d20 4e6f 6e65 0a0a  as_grad = None..
-000171d0: 2020 2020 2320 5368 6f72 7420 6369 7263      # Short circ
-000171e0: 7569 7420 6f6e 207a 6572 6f2d 6469 6d20  uit on zero-dim 
-000171f0: 6772 6164 0a20 2020 2069 6620 616e 7928  grad.    if any(
-00017200: 7320 3d3d 2030 2066 6f72 2073 2069 6e20  s == 0 for s in 
-00017210: 6772 6164 2e73 6861 7065 293a 0a20 2020  grad.shape):.   
-00017220: 2020 2020 2069 6e70 7574 5f67 7261 6420       input_grad 
-00017230: 3d20 6675 6c6c 5f6c 696b 6528 696e 7075  = full_like(inpu
-00017240: 742c 2066 696c 6c5f 7661 6c75 653d 3029  t, fill_value=0)
-00017250: 0a20 2020 2020 2020 2077 6569 6768 745f  .        weight_
-00017260: 6772 6164 203d 2066 756c 6c5f 6c69 6b65  grad = full_like
-00017270: 2877 6569 6768 742c 2066 696c 6c5f 7661  (weight, fill_va
-00017280: 6c75 653d 3029 0a20 2020 2020 2020 2069  lue=0).        i
-00017290: 6620 6269 6173 2069 7320 6e6f 7420 4e6f  f bias is not No
-000172a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000172b0: 6269 6173 5f67 7261 6420 3d20 6675 6c6c  bias_grad = full
-000172c0: 5f6c 696b 6528 6269 6173 2c20 6669 6c6c  _like(bias, fill
-000172d0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
-000172e0: 2020 7265 7475 726e 2028 696e 7075 745f    return (input_
-000172f0: 6772 6164 2c20 7765 6967 6874 5f67 7261  grad, weight_gra
-00017300: 642c 2062 6961 735f 6772 6164 2920 2b20  d, bias_grad) + 
-00017310: 2828 4e6f 6e65 2c29 202a 2036 290a 0a20  ((None,) * 6).. 
-00017320: 2020 2062 6174 6368 2c20 696e 5f63 6861     batch, in_cha
-00017330: 6e6e 656c 732c 202a 7370 6174 6961 6c5f  nnels, *spatial_
-00017340: 6469 6d73 203d 2069 6e70 7574 2e73 6861  dims = input.sha
-00017350: 7065 0a20 2020 206f 7574 5f63 6861 6e6e  pe.    out_chann
-00017360: 656c 732c 2067 696e 5f63 6861 6e6e 656c  els, gin_channel
-00017370: 732c 202a 6b65 726e 656c 5f64 696d 7320  s, *kernel_dims 
-00017380: 3d20 7765 6967 6874 2e73 6861 7065 0a20  = weight.shape. 
-00017390: 2020 2064 696d 203d 206c 656e 2873 7061     dim = len(spa
-000173a0: 7469 616c 5f64 696d 7329 0a0a 2020 2020  tial_dims)..    
-000173b0: 6465 6620 6d61 7962 655f 6578 7061 6e64  def maybe_expand
-000173c0: 5f73 6571 2873 2c20 6469 6d29 3a0a 2020  _seq(s, dim):.  
-000173d0: 2020 2020 2020 6966 206c 656e 2873 2920        if len(s) 
-000173e0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-000173f0: 2020 7265 7475 726e 2028 735b 305d 2c29    return (s[0],)
-00017400: 202a 2064 696d 0a20 2020 2020 2020 2065   * dim.        e
-00017410: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017420: 2072 6574 7572 6e20 730a 0a20 2020 2073   return s..    s
-00017430: 7472 6964 6520 3d20 6d61 7962 655f 6578  tride = maybe_ex
-00017440: 7061 6e64 5f73 6571 2873 7472 6964 652c  pand_seq(stride,
-00017450: 2064 696d 290a 2020 2020 7061 6464 696e   dim).    paddin
-00017460: 6720 3d20 6d61 7962 655f 6578 7061 6e64  g = maybe_expand
-00017470: 5f73 6571 2870 6164 6469 6e67 2c20 6469  _seq(padding, di
-00017480: 6d29 0a20 2020 2064 696c 6174 696f 6e20  m).    dilation 
-00017490: 3d20 6d61 7962 655f 6578 7061 6e64 5f73  = maybe_expand_s
-000174a0: 6571 2864 696c 6174 696f 6e2c 2064 696d  eq(dilation, dim
-000174b0: 290a 0a20 2020 2064 6566 2063 6f6e 765f  )..    def conv_
-000174c0: 7472 616e 7370 6f73 6528 7429 3a0a 2020  transpose(t):.  
-000174d0: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
-000174e0: 6d73 2e74 7261 6e73 706f 7365 2874 2c20  ms.transpose(t, 
-000174f0: 2831 2c20 3029 202b 2074 7570 6c65 2872  (1, 0) + tuple(r
-00017500: 616e 6765 2832 2c20 742e 6e64 696d 2929  ange(2, t.ndim))
-00017510: 290a 0a20 2020 2023 2069 6e70 7574 5f67  )..    # input_g
-00017520: 7261 6420 3d20 7b0a 2020 2020 6465 6620  rad = {.    def 
-00017530: 7472 616e 7370 6f73 655f 616e 645f 666c  transpose_and_fl
-00017540: 6970 5f77 6569 6768 7428 7765 6967 6874  ip_weight(weight
-00017550: 293a 0a20 2020 2020 2020 2023 2054 6865  ):.        # The
-00017560: 206c 696e 6573 2062 656c 6f77 2061 7265   lines below are
-00017570: 2074 7261 6e73 706f 7369 6e67 2074 6865   transposing the
-00017580: 2063 6861 6e6e 656c 7320 6469 6d73 2e0a   channels dims..
-00017590: 2020 2020 2020 2020 2320 5765 2061 6c73          # We als
-000175a0: 6f20 6e65 6564 2074 6f20 6578 7472 6163  o need to extrac
-000175b0: 7420 7468 6520 6772 6f75 7020 696e 666f  t the group info
-000175c0: 726d 6174 696f 6e20 616e 6420 6d65 7267  rmation and merg
-000175d0: 6520 6974 0a20 2020 2020 2020 2023 2077  e it.        # w
-000175e0: 6974 6820 7468 6520 6469 6d65 6e73 696f  ith the dimensio
-000175f0: 6e20 636f 7272 6573 706f 6e64 696e 6720  n corresponding 
-00017600: 746f 2074 6865 2022 6f75 745f 6368 616e  to the "out_chan
-00017610: 6e65 6c73 2220 6469 6d2e 0a20 2020 2020  nels" dim..     
-00017620: 2020 2023 2028 6f75 745f 6368 616e 6e65     # (out_channe
-00017630: 6c73 2c20 6769 6e5f 6368 616e 6e65 6c73  ls, gin_channels
-00017640: 2920 2d3e 2028 6769 6e5f 6368 616e 6e65  ) -> (gin_channe
-00017650: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
-00017660: 290a 2020 2020 2020 2020 7765 6967 6874  ).        weight
-00017670: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
-00017680: 6528 7765 6967 6874 290a 2020 2020 2020  e(weight).      
-00017690: 2020 2320 5370 6c69 7420 286f 7574 5f63    # Split (out_c
-000176a0: 6861 6e6e 656c 732c 2920 2d3e 2028 6772  hannels,) -> (gr
-000176b0: 6f75 7073 2c20 6f75 745f 6368 616e 6e65  oups, out_channe
-000176c0: 6c73 202f 2f20 6772 6f75 7073 290a 2020  ls // groups).  
-000176d0: 2020 2020 2020 7765 6967 6874 203d 2077        weight = w
-000176e0: 6569 6768 742e 7265 7368 6170 6528 5b67  eight.reshape([g
-000176f0: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
-00017700: 7570 732c 206f 7574 5f63 6861 6e6e 656c  ups, out_channel
-00017710: 7320 2f2f 2067 726f 7570 735d 202b 206b  s // groups] + k
-00017720: 6572 6e65 6c5f 6469 6d73 290a 2020 2020  ernel_dims).    
-00017730: 2020 2020 2320 4d6f 7669 6e67 2067 726f      # Moving gro
-00017740: 7570 7320 746f 2074 6865 206c 6566 742d  ups to the left-
-00017750: 6d6f 7374 2070 6f73 6974 696f 6e2e 0a20  most position.. 
-00017760: 2020 2020 2020 2023 2028 6769 6e5f 6368         # (gin_ch
-00017770: 616e 6e65 6c73 2c20 6772 6f75 7073 2c20  annels, groups, 
-00017780: 6f75 745f 6368 616e 6e65 6c73 202f 2f20  out_channels // 
-00017790: 6772 6f75 7073 2920 2d3e 2028 6772 6f75  groups) -> (grou
-000177a0: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
-000177b0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
-000177c0: 2f20 6772 6f75 7073 290a 2020 2020 2020  / groups).      
-000177d0: 2020 7765 6967 6874 203d 2063 6f6e 765f    weight = conv_
-000177e0: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
-000177f0: 290a 2020 2020 2020 2020 2320 5371 7561  ).        # Squa
-00017800: 7368 2028 6772 6f75 7073 2c20 6769 6e5f  sh (groups, gin_
-00017810: 6368 616e 6e65 6c73 2920 2d3e 2028 696e  channels) -> (in
-00017820: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
-00017830: 2020 2077 6569 6768 7420 3d20 7765 6967     weight = weig
-00017840: 6874 2e72 6573 6861 7065 285b 696e 5f63  ht.reshape([in_c
-00017850: 6861 6e6e 656c 732c 206f 7574 5f63 6861  hannels, out_cha
-00017860: 6e6e 656c 7320 2f2f 2067 726f 7570 735d  nnels // groups]
-00017870: 202b 206b 6572 6e65 6c5f 6469 6d73 290a   + kernel_dims).
-00017880: 0a20 2020 2020 2020 2023 2046 6c69 7020  .        # Flip 
-00017890: 7370 6174 6961 6c20 6469 6d65 6e73 696f  spatial dimensio
-000178a0: 6e73 0a20 2020 2020 2020 2077 6569 6768  ns.        weigh
-000178b0: 7420 3d20 7072 696d 732e 666c 6970 2877  t = prims.flip(w
-000178c0: 6569 6768 742c 2074 7570 6c65 2872 616e  eight, tuple(ran
-000178d0: 6765 2832 2c20 7765 6967 6874 2e6e 6469  ge(2, weight.ndi
-000178e0: 6d29 2929 0a20 2020 2020 2020 2072 6574  m))).        ret
-000178f0: 7572 6e20 7765 6967 6874 0a0a 2020 2020  urn weight..    
-00017900: 2320 5765 206e 6565 6420 746f 2070 6164  # We need to pad
-00017910: 2074 6865 2067 7261 6469 656e 7420 746f   the gradient to
-00017920: 2062 6520 6162 6c65 2074 6f20 6669 7420   be able to fit 
-00017930: 6b65 726e 656c 2077 696e 646f 7773 2e0a  kernel windows..
-00017940: 2020 2020 696e 6974 6961 6c5f 6772 6164      initial_grad
-00017950: 5f70 6164 6469 6e67 203d 205b 6420 2a20  _padding = [d * 
-00017960: 286b 202d 2031 2920 666f 7220 642c 206b  (k - 1) for d, k
-00017970: 2069 6e20 7a69 7028 6469 6c61 7469 6f6e   in zip(dilation
-00017980: 2c20 6b65 726e 656c 5f64 696d 7329 5d0a  , kernel_dims)].
-00017990: 0a20 2020 2069 6e70 7574 5f67 7261 6420  .    input_grad 
-000179a0: 3d20 636f 6e76 6f6c 7574 696f 6e28 0a20  = convolution(. 
-000179b0: 2020 2020 2020 2070 7269 6d73 2e70 6164         prims.pad
-000179c0: 280a 2020 2020 2020 2020 2020 2020 6772  (.            gr
-000179d0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-000179e0: 302e 302c 0a20 2020 2020 2020 2020 2020  0.0,.           
-000179f0: 2023 2054 6865 2070 6978 6573 2061 7265   # The pixes are
-00017a00: 2073 7472 6964 6520 6177 6179 2066 726f   stride away fro
-00017a10: 6d20 6561 6368 206f 7468 6572 2069 6e20  m each other in 
-00017a20: 7468 6520 6f72 6967 696e 616c 2069 6e70  the original inp
-00017a30: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
-00017a40: 2320 4865 6e63 6520 7765 206e 6565 6420  # Hence we need 
-00017a50: 746f 2064 696c 6174 6520 7468 6520 6772  to dilate the gr
-00017a60: 6164 6965 6e74 2062 7920 6469 6c61 7469  adient by dilati
-00017a70: 6f6e 3d73 7472 6964 6520 2d20 310a 2020  on=stride - 1.  
-00017a80: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
-00017a90: 6861 7420 7468 6572 6520 6172 6520 7374  hat there are st
-00017aa0: 7269 6465 202d 2031 207a 6572 6f73 2062  ride - 1 zeros b
-00017ab0: 6574 7765 656e 2074 6865 2070 6978 656c  etween the pixel
-00017ac0: 732e 0a20 2020 2020 2020 2020 2020 205b  s..            [
-00017ad0: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
-00017ae0: 2c20 3029 5d20 2b20 5b28 302c 2030 2c20  , 0)] + [(0, 0, 
-00017af0: 7320 2d20 3129 2066 6f72 2073 2069 6e20  s - 1) for s in 
-00017b00: 7374 7269 6465 5d2c 0a20 2020 2020 2020  stride],.       
-00017b10: 2029 2c0a 2020 2020 2020 2020 7472 616e   ),.        tran
-00017b20: 7370 6f73 655f 616e 645f 666c 6970 5f77  spose_and_flip_w
-00017b30: 6569 6768 7428 7765 6967 6874 292c 0a20  eight(weight),. 
-00017b40: 2020 2020 2020 204e 6f6e 652c 0a20 2020         None,.   
-00017b50: 2020 2020 2023 2053 6574 7469 6e67 2073       # Setting s
-00017b60: 7472 6964 6520 746f 2031 2061 7320 7468  tride to 1 as th
-00017b70: 6520 6469 7374 616e 6365 2062 6574 7765  e distance betwe
-00017b80: 656e 2070 6978 656c 7320 6973 2074 616b  en pixels is tak
-00017b90: 656e 0a20 2020 2020 2020 2023 2063 6172  en.        # car
-00017ba0: 6520 6279 2074 6865 2070 6164 2072 6967  e by the pad rig
-00017bb0: 6874 2061 626f 7665 2e0a 2020 2020 2020  ht above..      
-00017bc0: 2020 2831 2c29 2c0a 2020 2020 2020 2020    (1,),.        
-00017bd0: 696e 6974 6961 6c5f 6772 6164 5f70 6164  initial_grad_pad
-00017be0: 6469 6e67 2c0a 2020 2020 2020 2020 6469  ding,.        di
-00017bf0: 6c61 7469 6f6e 2c0a 2020 2020 2020 2020  lation,.        
-00017c00: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
-00017c10: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
-00017c20: 6e67 2c0a 2020 2020 2020 2020 6772 6f75  ng,.        grou
-00017c30: 7073 2c0a 2020 2020 290a 0a20 2020 2064  ps,.    )..    d
-00017c40: 6566 2070 6164 5f74 6f5f 696e 7075 7428  ef pad_to_input(
-00017c50: 6772 6164 293a 0a20 2020 2020 2020 2023  grad):.        #
-00017c60: 2057 6520 6e65 6564 2074 6f20 756e 7061   We need to unpa
-00017c70: 6420 7468 6520 7061 6464 696e 6720 646f  d the padding do
-00017c80: 6e65 2074 6f20 7468 6520 696e 7075 7420  ne to the input 
-00017c90: 7072 696f 7220 746f 2074 6865 2063 6f6e  prior to the con
-00017ca0: 766f 6c75 7469 6f6e 2e0a 2020 2020 2020  volution..      
-00017cb0: 2020 2320 4e6f 7465 2074 6861 7420 6c6f    # Note that lo
-00017cc0: 7720 616e 6420 6869 6768 2070 6164 6469  w and high paddi
-00017cd0: 6e67 2061 7265 206e 6f74 206e 6563 6573  ng are not neces
-00017ce0: 7361 7269 6c79 2065 7175 616c 2c20 736f  sarily equal, so
-00017cf0: 2077 6520 6361 6e6e 6f74 0a20 2020 2020   we cannot.     
-00017d00: 2020 2023 2061 6273 6f72 6220 6974 2069     # absorb it i
-00017d10: 6e74 6f20 7468 6520 636f 6e76 6f6c 7574  nto the convolut
-00017d20: 696f 6e20 6a75 7374 2079 6574 2c20 756e  ion just yet, un
-00017d30: 6c65 7373 2074 6865 2041 5049 2069 7320  less the API is 
-00017d40: 6d6f 6469 6669 6564 2e0a 2020 2020 2020  modified..      
-00017d50: 2020 7061 645f 636f 6e66 6967 203d 205b    pad_config = [
-00017d60: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
-00017d70: 2c20 3029 5d0a 2020 2020 2020 2020 666f  , 0)].        fo
-00017d80: 7220 6f2c 2069 2c20 672c 2070 2069 6e20  r o, i, g, p in 
-00017d90: 7a69 7028 6772 6164 2e73 6861 7065 5b32  zip(grad.shape[2
-00017da0: 3a5d 2c20 7370 6174 6961 6c5f 6469 6d73  :], spatial_dims
-00017db0: 2c20 696e 7075 745f 6772 6164 2e73 6861  , input_grad.sha
-00017dc0: 7065 5b32 3a5d 2c20 7061 6464 696e 6729  pe[2:], padding)
-00017dd0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00017de0: 203d 202d 700a 2020 2020 2020 2020 2020   = -p.          
-00017df0: 2020 2320 4e6f 7465 2074 6861 7420 2869    # Note that (i
-00017e00: 202b 2032 202a 2070 2920 6973 2074 6865   + 2 * p) is the
-00017e10: 2073 697a 6520 6f66 2074 6865 2070 6164   size of the pad
-00017e20: 6465 6420 696e 7075 742c 0a20 2020 2020  ded input,.     
-00017e30: 2020 2020 2020 2023 2073 6f20 7468 6520         # so the 
-00017e40: 7175 616e 7469 7479 2028 6920 2b20 3220  quantity (i + 2 
-00017e50: 2a20 7029 202d 2067 2074 656c 6c73 2075  * p) - g tells u
-00017e60: 7320 6279 2068 6f77 206d 7563 680a 2020  s by how much.  
-00017e70: 2020 2020 2020 2020 2020 2320 7765 206e            # we n
-00017e80: 6565 6420 746f 2070 6164 2074 6865 2067  eed to pad the g
-00017e90: 7261 6469 656e 7420 736f 2074 6861 7420  radient so that 
-00017ea0: 7468 6520 656c 656d 656e 7473 206f 7574  the elements out
-00017eb0: 7369 6465 0a20 2020 2020 2020 2020 2020  side.           
-00017ec0: 2023 206f 6620 7468 6520 636f 6e76 6f6c   # of the convol
-00017ed0: 7574 696f 6e20 7265 6365 6976 6520 7a65  ution receive ze
-00017ee0: 726f 2067 7261 6469 656e 742e 0a20 2020  ro gradient..   
-00017ef0: 2020 2020 2020 2020 2023 2070 2069 7320           # p is 
-00017f00: 6164 6469 7469 6f6e 616c 6c79 2073 7562  additionally sub
-00017f10: 7472 6163 7465 6420 746f 206e 6567 6174  tracted to negat
-00017f20: 6520 7468 6520 696e 7075 7427 7320 7061  e the input's pa
-00017f30: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-00017f40: 696e 2066 6f72 7761 7264 2e0a 2020 2020  in forward..    
-00017f50: 2020 2020 2020 2020 6869 203d 2028 6920          hi = (i 
-00017f60: 2b20 3220 2a20 7029 202d 2067 202d 2070  + 2 * p) - g - p
-00017f70: 0a20 2020 2020 2020 2020 2020 2070 6164  .            pad
-00017f80: 5f63 6f6e 6669 672e 6170 7065 6e64 2828  _config.append((
-00017f90: 6c6f 2c20 6869 2c20 3029 290a 2020 2020  lo, hi, 0)).    
-00017fa0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
-00017fb0: 2e70 6164 2867 7261 642c 2030 2e30 2c20  .pad(grad, 0.0, 
-00017fc0: 7061 645f 636f 6e66 6967 290a 0a20 2020  pad_config)..   
-00017fd0: 2069 6e70 7574 5f67 7261 6420 3d20 7061   input_grad = pa
-00017fe0: 645f 746f 5f69 6e70 7574 2869 6e70 7574  d_to_input(input
-00017ff0: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
-00018000: 2020 2020 2320 6269 6173 5f67 7261 6420      # bias_grad 
-00018010: 3d20 7b0a 2020 2020 6966 2062 6961 7320  = {.    if bias 
-00018020: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00018030: 2020 2020 2069 6d70 6f72 7420 7468 756e       import thun
-00018040: 6465 722e 746f 7263 6820 6173 206c 746f  der.torch as lto
-00018050: 7263 680a 0a20 2020 2020 2020 2062 6961  rch..        bia
-00018060: 735f 6772 6164 203d 206c 746f 7263 682e  s_grad = ltorch.
-00018070: 7375 6d28 6772 6164 2c20 5b64 2066 6f72  sum(grad, [d for
-00018080: 2064 2069 6e20 7261 6e67 6528 6772 6164   d in range(grad
-00018090: 2e6e 6469 6d29 2069 6620 6420 213d 2031  .ndim) if d != 1
-000180a0: 5d29 0a20 2020 2023 207d 0a0a 2020 2020  ]).    # }..    
-000180b0: 2320 7765 6967 6874 2067 7261 6420 3d20  # weight grad = 
-000180c0: 7b0a 2020 2020 6465 6620 7061 645f 7472  {.    def pad_tr
-000180d0: 616e 7370 6f73 655f 616e 645f 7075 7368  anspose_and_push
-000180e0: 5f67 726f 7570 735f 696e 746f 5f62 6174  _groups_into_bat
-000180f0: 6368 6573 2874 293a 0a20 2020 2020 2020  ches(t):.       
-00018100: 2023 2046 6972 7374 2070 6164 2c2e 2e2e   # First pad,...
-00018110: 0a20 2020 2020 2020 2023 2050 6164 2061  .        # Pad a
-00018120: 7320 6e65 6365 7373 6172 7920 736f 2074  s necessary so t
-00018130: 6861 7420 696e 2063 6f6e 766f 6c75 7469  hat in convoluti
-00018140: 6f6e 7320 7765 206e 6576 6572 2061 6476  ons we never adv
-00018150: 616e 6365 0a20 2020 2020 2020 2023 2070  ance.        # p
-00018160: 6173 7420 7265 6c65 7661 6e74 2069 6e70  ast relevant inp
-00018170: 7574 732e 0a20 2020 2020 2020 2070 6164  uts..        pad
-00018180: 5f63 6f6e 6669 6720 3d20 5b28 302c 2030  _config = [(0, 0
-00018190: 2c20 3029 2c20 2830 2c20 302c 2030 295d  , 0), (0, 0, 0)]
-000181a0: 0a20 2020 2020 2020 2066 6f72 206f 2c20  .        for o, 
-000181b0: 692c 206b 2c20 702c 2073 2c20 6420 696e  i, k, p, s, d in
-000181c0: 207a 6970 2867 7261 642e 7368 6170 655b   zip(grad.shape[
-000181d0: 323a 5d2c 2073 7061 7469 616c 5f64 696d  2:], spatial_dim
-000181e0: 732c 206b 6572 6e65 6c5f 6469 6d73 2c20  s, kernel_dims, 
-000181f0: 7061 6464 696e 672c 2073 7472 6964 652c  padding, stride,
-00018200: 2064 696c 6174 696f 6e29 3a0a 2020 2020   dilation):.    
-00018210: 2020 2020 2020 2020 2320 5061 6464 696e          # Paddin
-00018220: 6720 6672 6f6d 2062 656c 6f77 2069 7320  g from below is 
-00018230: 7468 6520 7361 6d65 2e0a 2020 2020 2020  the same..      
-00018240: 2020 2020 2020 6c6f 203d 2070 0a20 2020        lo = p.   
-00018250: 2020 2020 2020 2020 2023 2054 6865 7265           # There
-00018260: 2069 7320 616c 7761 7973 2074 6865 206d   is always the m
-00018270: 6178 2069 6e64 6578 2069 6478 2069 6e20  ax index idx in 
-00018280: 7468 6520 696e 7075 740a 2020 2020 2020  the input.      
-00018290: 2020 2020 2020 2320 7468 6520 7661 6c75        # the valu
-000182a0: 6520 6f66 2077 6869 6368 2c20 696e 7075  e of which, inpu
-000182b0: 745b 6964 785d 2c20 7468 6520 6b65 726e  t[idx], the kern
-000182c0: 656c 2074 6f75 6368 6573 2e0a 2020 2020  el touches..    
-000182d0: 2020 2020 2020 2020 2320 5468 6520 6b65          # The ke
-000182e0: 726e 656c 2072 6561 6368 2c20 6f72 206b  rnel reach, or k
-000182f0: 5f72 6561 6368 2c20 6973 2065 7861 6374  _reach, is exact
-00018300: 6c79 2069 6478 202b 2031 2e0a 2020 2020  ly idx + 1..    
-00018310: 2020 2020 2020 2020 2320 5765 2075 7365          # We use
-00018320: 2069 7420 746f 2064 6563 6964 6520 6279   it to decide by
-00018330: 2068 6f77 206d 7563 6820 7765 206e 6565   how much we nee
-00018340: 6420 746f 2070 6164 2066 726f 6d20 6162  d to pad from ab
-00018350: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
-00018360: 2320 6173 2074 6f20 6e6f 7420 6d6f 7665  # as to not move
-00018370: 2070 6173 7420 7265 6c65 7661 6e74 2076   past relevant v
-00018380: 616c 7565 732e 0a20 2020 2020 2020 2020  alues..         
-00018390: 2020 206b 5f72 6561 6368 203d 2028 6f20     k_reach = (o 
-000183a0: 2d20 3129 202a 2073 202b 2064 202a 2028  - 1) * s + d * (
-000183b0: 6b20 2d20 3129 202b 2031 0a20 2020 2020  k - 1) + 1.     
-000183c0: 2020 2020 2020 2023 2054 6865 2070 6164         # The pad
-000183d0: 2066 726f 6d20 6162 6f76 6520 6571 7561   from above equa
-000183e0: 6c73 206b 5f72 6561 6368 206d 696e 7573  ls k_reach minus
-000183f0: 2074 6865 206c 656e 6774 680a 2020 2020   the length.    
-00018400: 2020 2020 2020 2020 2320 6f66 2074 6865          # of the
-00018410: 2069 6e70 7574 2070 6164 6465 6420 6672   input padded fr
-00018420: 6f6d 2062 656c 6f77 2e0a 2020 2020 2020  om below..      
-00018430: 2020 2020 2020 6869 203d 206b 5f72 6561        hi = k_rea
-00018440: 6368 202d 2028 6920 2b20 7029 0a20 2020  ch - (i + p).   
-00018450: 2020 2020 2020 2020 2070 6164 5f63 6f6e           pad_con
-00018460: 6669 672e 6170 7065 6e64 2828 6c6f 2c20  fig.append((lo, 
-00018470: 6869 2c20 3029 290a 2020 2020 2020 2020  hi, 0)).        
-00018480: 7420 3d20 7072 696d 732e 7061 6428 742c  t = prims.pad(t,
-00018490: 2030 2e30 2c20 7061 645f 636f 6e66 6967   0.0, pad_config
-000184a0: 290a 0a20 2020 2020 2020 205f 2c20 5f2c  )..        _, _,
-000184b0: 202a 745f 7370 6174 6961 6c5f 6469 6d73   *t_spatial_dims
-000184c0: 203d 2074 2e73 6861 7065 0a0a 2020 2020   = t.shape..    
-000184d0: 2020 2020 2320 2e2e 2e20 7468 656e 2064      # ... then d
-000184e0: 6f20 7468 6520 7265 7374 2e0a 2020 2020  o the rest..    
-000184f0: 2020 2020 2320 742e 7368 6170 6520 3d3d      # t.shape ==
-00018500: 2028 6261 7463 682c 2069 6e5f 6368 616e   (batch, in_chan
-00018510: 6e65 6c73 2c20 2e2e 2e29 0a20 2020 2020  nels, ...).     
-00018520: 2020 2023 2054 6865 2072 6573 756c 7420     # The result 
-00018530: 6f66 2074 6869 7320 6675 6e63 7469 6f6e  of this function
-00018540: 2068 6173 2073 6861 7065 0a20 2020 2020   has shape.     
-00018550: 2020 2023 2028 696e 5f63 6861 6e6e 656c     # (in_channel
-00018560: 732c 2062 6174 6368 202a 2067 726f 7570  s, batch * group
-00018570: 7329 0a20 2020 2020 2020 2023 2028 6261  s).        # (ba
-00018580: 7463 682c 2069 6e5f 6368 616e 6e65 6c73  tch, in_channels
-00018590: 2920 2d3e 2028 696e 5f63 6861 6e6e 656c  ) -> (in_channel
-000185a0: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
-000185b0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
-000185c0: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
-000185d0: 2320 5370 6c69 7420 2869 6e5f 6368 616e  # Split (in_chan
-000185e0: 6e65 6c73 2c29 202d 3e20 2867 726f 7570  nels,) -> (group
-000185f0: 732c 2067 696e 5f63 6861 6e6e 656c 7329  s, gin_channels)
-00018600: 0a20 2020 2020 2020 2074 203d 2074 2e72  .        t = t.r
-00018610: 6573 6861 7065 285b 6772 6f75 7073 2c20  eshape([groups, 
-00018620: 6769 6e5f 6368 616e 6e65 6c73 2c20 6261  gin_channels, ba
-00018630: 7463 685d 202b 2074 5f73 7061 7469 616c  tch] + t_spatial
-00018640: 5f64 696d 7329 0a20 2020 2020 2020 2023  _dims).        #
-00018650: 2054 7261 6e73 706f 7365 2028 6772 6f75   Transpose (grou
-00018660: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
-00018670: 2c20 6261 7463 6829 202d 3e20 2867 696e  , batch) -> (gin
-00018680: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
-00018690: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
-000186a0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
-000186b0: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
-000186c0: 2320 466c 6174 7465 6e20 2867 726f 7570  # Flatten (group
-000186d0: 732c 2062 6174 6368 2920 2d3e 2028 6772  s, batch) -> (gr
-000186e0: 6f75 7073 202a 2062 6174 6368 2c29 0a20  oups * batch,). 
-000186f0: 2020 2020 2020 2074 203d 2074 2e72 6573         t = t.res
-00018700: 6861 7065 285b 6769 6e5f 6368 616e 6e65  hape([gin_channe
-00018710: 6c73 2c20 6772 6f75 7073 202a 2062 6174  ls, groups * bat
-00018720: 6368 5d20 2b20 745f 7370 6174 6961 6c5f  ch] + t_spatial_
-00018730: 6469 6d73 290a 2020 2020 2020 2020 7265  dims).        re
-00018740: 7475 726e 2074 0a0a 2020 2020 2320 696e  turn t..    # in
-00018750: 7075 7420 7769 6c6c 2068 6176 6520 7368  put will have sh
-00018760: 6170 6520 2867 696e 5f63 6861 6e6e 656c  ape (gin_channel
-00018770: 732c 2067 726f 7570 7320 2a20 6261 7463  s, groups * batc
-00018780: 6829 0a20 2020 2069 6e70 7574 203d 2070  h).    input = p
-00018790: 6164 5f74 7261 6e73 706f 7365 5f61 6e64  ad_transpose_and
-000187a0: 5f70 7573 685f 6772 6f75 7073 5f69 6e74  _push_groups_int
-000187b0: 6f5f 6261 7463 6865 7328 696e 7075 7429  o_batches(input)
-000187c0: 0a20 2020 2023 2067 7261 6420 7769 6c6c  .    # grad will
-000187d0: 2068 6176 6520 7368 6170 6520 286f 7574   have shape (out
-000187e0: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
-000187f0: 290a 2020 2020 2320 4e6f 7465 2074 6861  ).    # Note tha
-00018800: 7420 7468 6573 6520 7368 6170 6573 2061  t these shapes a
-00018810: 7265 2063 6f6d 7061 7469 626c 6520 666f  re compatible fo
-00018820: 7220 6120 6772 6f75 7020 636f 6e76 6f6c  r a group convol
-00018830: 7574 696f 6e2e 0a20 2020 2067 7261 6420  ution..    grad 
-00018840: 3d20 636f 6e76 5f74 7261 6e73 706f 7365  = conv_transpose
-00018850: 2867 7261 6429 0a0a 2020 2020 2320 5768  (grad)..    # Wh
-00018860: 7920 646f 2077 6520 666c 6970 2073 7472  y do we flip str
-00018870: 6964 6520 616e 6420 6469 6c61 7469 6f6e  ide and dilation
-00018880: 3f0a 2020 2020 2320 6b65 726e 656c 5b69  ?.    # kernel[i
-00018890: 5d20 616e 6420 6b65 726e 656c 5b69 202b  ] and kernel[i +
-000188a0: 2031 5d20 6172 6520 6469 6c61 7469 6f6e   1] are dilation
-000188b0: 2061 7061 7274 2066 726f 6d20 6561 6368   apart from each
-000188c0: 206f 7468 6572 2c0a 2020 2020 2320 736f   other,.    # so
-000188d0: 2064 696c 6174 696f 6e20 6265 636f 6d65   dilation become
-000188e0: 7320 7468 6520 6e65 7720 7374 7269 6465  s the new stride
-000188f0: 2e0a 2020 2020 2320 416c 6c20 7468 6520  ..    # All the 
-00018900: 656c 656d 656e 7473 2074 6861 7420 6b65  elements that ke
-00018910: 726e 656c 5b69 5d20 746f 7563 6865 7320  rnel[i] touches 
-00018920: 6172 6520 7374 7269 6465 2061 7761 7920  are stride away 
-00018930: 6672 6f6d 2065 6163 6820 6f74 6865 722c  from each other,
-00018940: 0a20 2020 2023 2068 656e 6365 2073 7472  .    # hence str
-00018950: 6964 6520 6265 636f 6d65 7320 7468 6520  ide becomes the 
-00018960: 6e65 7720 6469 6c61 7469 6f6e 2e0a 2020  new dilation..  
-00018970: 2020 7765 6967 6874 5f67 7261 6420 3d20    weight_grad = 
-00018980: 636f 6e76 6f6c 7574 696f 6e28 0a20 2020  convolution(.   
-00018990: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
-000189a0: 2020 2020 6772 6164 2c0a 2020 2020 2020      grad,.      
-000189b0: 2020 4e6f 6e65 2c0a 2020 2020 2020 2020    None,.        
-000189c0: 6469 6c61 7469 6f6e 2c20 2023 2073 6574  dilation,  # set
-000189d0: 2073 7472 6964 653d 6469 6c61 7469 6f6e   stride=dilation
-000189e0: 0a20 2020 2020 2020 2028 302c 292c 0a20  .        (0,),. 
-000189f0: 2020 2020 2020 2073 7472 6964 652c 2020         stride,  
-00018a00: 2320 7365 7420 6469 6c61 7469 6f6e 3d73  # set dilation=s
-00018a10: 7472 6964 650a 2020 2020 2020 2020 7472  tride.        tr
-00018a20: 616e 7370 6f73 6564 2c0a 2020 2020 2020  ansposed,.      
-00018a30: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
-00018a40: 2c0a 2020 2020 2020 2020 6772 6f75 7073  ,.        groups
-00018a50: 2c0a 2020 2020 290a 0a20 2020 2023 2054  ,.    )..    # T
-00018a60: 6865 2072 6573 756c 7420 6f66 2074 6865  he result of the
-00018a70: 2063 6f6e 766f 6c75 7469 6f6e 2068 6173   convolution has
-00018a80: 2073 6861 7065 2028 6769 6e5f 6368 616e   shape (gin_chan
-00018a90: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
-00018aa0: 6c73 292c 0a20 2020 2023 2073 6f20 7472  ls),.    # so tr
-00018ab0: 616e 7370 6f73 6974 696f 6e20 6973 2072  ansposition is r
-00018ac0: 6571 7569 7265 642e 0a20 2020 2077 6569  equired..    wei
-00018ad0: 6768 745f 6772 6164 203d 2063 6f6e 765f  ght_grad = conv_
-00018ae0: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
-00018af0: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
-00018b00: 2020 2020 7265 7475 726e 2028 696e 7075      return (inpu
-00018b10: 745f 6772 6164 2c20 7765 6967 6874 5f67  t_grad, weight_g
-00018b20: 7261 642c 2062 6961 735f 6772 6164 290a  rad, bias_grad).
-00018b30: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-00018b40: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
-00018b50: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
-00018b60: 2229 0a64 6566 206c 6f67 5f73 6f66 746d  ").def log_softm
-00018b70: 6178 5f61 7567 5f66 7764 2869 6e70 7574  ax_aug_fwd(input
-00018b80: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
-00018b90: 696d 3a20 696e 742c 202a 2c20 6474 7970  im: int, *, dtyp
-00018ba0: 653d 4e6f 6e65 2920 2d3e 2056 4a50 4475  e=None) -> VJPDu
-00018bb0: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
-00018bc0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-00018bd0: 7420 6c6f 675f 736f 6674 6d61 780a 0a20  t log_softmax.. 
-00018be0: 2020 2070 7269 6d61 6c20 3d20 6c6f 675f     primal = log_
-00018bf0: 736f 6674 6d61 7828 696e 7075 742c 2064  softmax(input, d
-00018c00: 696d 3d64 696d 2c20 6474 7970 653d 6474  im=dim, dtype=dt
-00018c10: 7970 6529 0a20 2020 2072 6573 6964 7561  ype).    residua
-00018c20: 6c73 203d 2028 7072 696d 616c 2c20 6469  ls = (primal, di
-00018c30: 6d2c 2069 6e70 7574 2e64 7479 7065 290a  m, input.dtype).
-00018c40: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00018c50: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00018c60: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00018c70: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-00018c80: 682e 6c6f 675f 736f 6674 6d61 7822 290a  h.log_softmax").
-00018c90: 6465 6620 6c6f 675f 736f 6674 6d61 785f  def log_softmax_
-00018ca0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
-00018cb0: 2064 696d 2c20 6474 7970 652c 2067 293a   dim, dtype, g):
-00018cc0: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00018cd0: 722e 746f 7263 6820 696d 706f 7274 206c  r.torch import l
-00018ce0: 6f67 5f73 6f66 746d 6178 5f62 6163 6b77  og_softmax_backw
-00018cf0: 6172 640a 0a20 2020 2072 6574 7572 6e20  ard..    return 
-00018d00: 6c6f 675f 736f 6674 6d61 785f 6261 636b  log_softmax_back
-00018d10: 7761 7264 2867 2c20 7072 696d 616c 2c20  ward(g, primal, 
-00018d20: 6469 6d2c 2064 7479 7065 290a 0a0a 4072  dim, dtype)...@r
-00018d30: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-00018d40: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
-00018d50: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6e  .nn.functional.n
-00018d60: 6c6c 5f6c 6f73 7322 290a 6465 6620 6e6c  ll_loss").def nl
-00018d70: 6c5f 6c6f 7373 5f61 7567 5f66 7764 280a  l_loss_aug_fwd(.
-00018d80: 2020 2020 696e 7075 743a 2050 726f 7879      input: Proxy
-00018d90: 2c0a 2020 2020 7461 7267 6574 3a20 5072  ,.    target: Pr
-00018da0: 6f78 792c 0a20 2020 2077 6569 6768 743a  oxy,.    weight:
-00018db0: 204e 6f6e 6520 7c20 5072 6f78 792c 0a20   None | Proxy,. 
-00018dc0: 2020 2069 676e 6f72 655f 696e 6465 783a     ignore_index:
-00018dd0: 2069 6e74 2c0a 2020 2020 7265 6475 6374   int,.    reduct
-00018de0: 696f 6e3a 2073 7472 2c0a 2920 2d3e 2056  ion: str,.) -> V
-00018df0: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
-00018e00: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
-00018e10: 6d70 6f72 7420 5f6e 6c6c 5f6c 6f73 735f  mport _nll_loss_
-00018e20: 6865 6c70 6572 0a0a 2020 2020 7072 696d  helper..    prim
-00018e30: 616c 2c20 746f 7461 6c5f 7765 6967 6874  al, total_weight
-00018e40: 203d 205f 6e6c 6c5f 6c6f 7373 5f68 656c   = _nll_loss_hel
-00018e50: 7065 7228 0a20 2020 2020 2020 2069 6e70  per(.        inp
-00018e60: 7574 2c0a 2020 2020 2020 2020 7461 7267  ut,.        targ
-00018e70: 6574 2c0a 2020 2020 2020 2020 7765 6967  et,.        weig
-00018e80: 6874 2c0a 2020 2020 2020 2020 6967 6e6f  ht,.        igno
-00018e90: 7265 5f69 6e64 6578 2c0a 2020 2020 2020  re_index,.      
-00018ea0: 2020 7265 6475 6374 696f 6e2c 0a20 2020    reduction,.   
-00018eb0: 2029 0a20 2020 2072 6573 6964 7561 6c73   ).    residuals
-00018ec0: 203d 2028 696e 7075 742c 2074 6172 6765   = (input, targe
-00018ed0: 742c 2077 6569 6768 742c 2072 6564 7563  t, weight, reduc
-00018ee0: 7469 6f6e 2c20 6967 6e6f 7265 5f69 6e64  tion, ignore_ind
-00018ef0: 6578 2c20 746f 7461 6c5f 7765 6967 6874  ex, total_weight
-00018f00: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-00018f10: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
-00018f20: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
-00018f30: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
-00018f40: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-00018f50: 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64 6566  l.nll_loss").def
-00018f60: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
-00018f70: 7264 2869 6e70 7574 2c20 7461 7267 6574  rd(input, target
-00018f80: 2c20 7765 6967 6874 2c20 7265 6475 6374  , weight, reduct
-00018f90: 696f 6e2c 2069 676e 6f72 655f 696e 6465  ion, ignore_inde
-00018fa0: 782c 2074 6f74 616c 5f77 6569 6768 742c  x, total_weight,
-00018fb0: 2067 293a 0a20 2020 2066 726f 6d20 7468   g):.    from th
-00018fc0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
-00018fd0: 7274 206e 6c6c 5f6c 6f73 735f 6261 636b  rt nll_loss_back
-00018fe0: 7761 7264 0a0a 2020 2020 6769 6e70 7574  ward..    ginput
-00018ff0: 203d 206e 6c6c 5f6c 6f73 735f 6261 636b   = nll_loss_back
-00019000: 7761 7264 2867 2c20 696e 7075 742c 2074  ward(g, input, t
-00019010: 6172 6765 742c 2077 6569 6768 742c 2072  arget, weight, r
-00019020: 6564 7563 7469 6f6e 2c20 6967 6e6f 7265  eduction, ignore
-00019030: 5f69 6e64 6578 2c20 746f 7461 6c5f 7765  _index, total_we
-00019040: 6967 6874 290a 2020 2020 7265 7475 726e  ight).    return
-00019050: 2067 696e 7075 742c 202a 2828 4e6f 6e65   ginput, *((None
-00019060: 2c29 202a 2034 290a 0a0a 4072 6567 6973  ,) * 4)...@regis
-00019070: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00019080: 7277 6172 6428 2274 6f72 6368 2e73 706c  rward("torch.spl
-00019090: 6974 2229 0a64 6566 2073 706c 6974 5f61  it").def split_a
-000190a0: 7567 5f66 7764 2861 3a20 5465 6e73 6f72  ug_fwd(a: Tensor
-000190b0: 5072 6f78 792c 2073 706c 6974 5f73 697a  Proxy, split_siz
-000190c0: 655f 6f72 5f73 6563 7469 6f6e 733a 2069  e_or_sections: i
-000190d0: 6e74 207c 2053 6571 7565 6e63 655b 696e  nt | Sequence[in
-000190e0: 745d 2c20 6469 6d3a 2069 6e74 203d 2030  t], dim: int = 0
-000190f0: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
-00019100: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00019110: 6f72 6368 2069 6d70 6f72 7420 7370 6c69  orch import spli
-00019120: 740a 0a20 2020 2070 7269 6d61 6c20 3d20  t..    primal = 
-00019130: 7370 6c69 7428 612c 2073 706c 6974 5f73  split(a, split_s
-00019140: 697a 655f 6f72 5f73 6563 7469 6f6e 732c  ize_or_sections,
-00019150: 2064 696d 290a 2020 2020 7265 7369 6475   dim).    residu
-00019160: 616c 7320 3d20 2864 696d 2c29 0a20 2020  als = (dim,).   
-00019170: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00019180: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00019190: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-000191a0: 6163 6b77 6172 6428 2274 6f72 6368 2e73  ackward("torch.s
-000191b0: 706c 6974 2229 0a64 6566 2073 706c 6974  plit").def split
-000191c0: 5f62 6163 6b77 6172 6428 6469 6d2c 202a  _backward(dim, *
-000191d0: 6772 6164 7329 3a0a 2020 2020 6672 6f6d  grads):.    from
-000191e0: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
-000191f0: 6d70 6f72 7420 6361 740a 0a20 2020 2072  mport cat..    r
-00019200: 6574 7572 6e20 6361 7428 6772 6164 732c  eturn cat(grads,
-00019210: 2064 696d 290a 0a0a 4072 6567 6973 7465   dim)...@registe
-00019220: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-00019230: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
-00019240: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
-00019250: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
-00019260: 6e67 5f61 7567 5f66 7764 280a 2020 2020  ng_aug_fwd(.    
-00019270: 613a 2050 726f 7879 2c0a 2020 2020 7765  a: Proxy,.    we
-00019280: 6967 6874 3a20 5072 6f78 792c 0a20 2020  ight: Proxy,.   
-00019290: 2070 6164 6469 6e67 5f69 6478 3a20 696e   padding_idx: in
-000192a0: 7420 7c20 4e6f 6e65 2c0a 2020 2020 6d61  t | None,.    ma
-000192b0: 785f 6e6f 726d 3a20 666c 6f61 7420 7c20  x_norm: float | 
-000192c0: 4e6f 6e65 2c0a 2020 2020 6e6f 726d 5f74  None,.    norm_t
-000192d0: 7970 653a 2066 6c6f 6174 2c0a 2020 2020  ype: float,.    
-000192e0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-000192f0: 6571 3a20 626f 6f6c 2c0a 2020 2020 7370  eq: bool,.    sp
-00019300: 6172 7365 3a20 626f 6f6c 2c0a 2920 2d3e  arse: bool,.) ->
-00019310: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
-00019320: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00019330: 2069 6d70 6f72 7420 656d 6265 6464 696e   import embeddin
-00019340: 670a 0a20 2020 2070 7269 6d61 6c20 3d20  g..    primal = 
-00019350: 656d 6265 6464 696e 6728 0a20 2020 2020  embedding(.     
-00019360: 2020 2061 2c0a 2020 2020 2020 2020 7765     a,.        we
-00019370: 6967 6874 2c0a 2020 2020 2020 2020 7061  ight,.        pa
-00019380: 6464 696e 675f 6964 783d 7061 6464 696e  dding_idx=paddin
-00019390: 675f 6964 782c 0a20 2020 2020 2020 206d  g_idx,.        m
-000193a0: 6178 5f6e 6f72 6d3d 6d61 785f 6e6f 726d  ax_norm=max_norm
-000193b0: 2c0a 2020 2020 2020 2020 6e6f 726d 5f74  ,.        norm_t
-000193c0: 7970 653d 6e6f 726d 5f74 7970 652c 0a20  ype=norm_type,. 
-000193d0: 2020 2020 2020 2073 6361 6c65 5f67 7261         scale_gra
-000193e0: 645f 6279 5f66 7265 713d 7363 616c 655f  d_by_freq=scale_
-000193f0: 6772 6164 5f62 795f 6672 6571 2c0a 2020  grad_by_freq,.  
-00019400: 2020 2020 2020 7370 6172 7365 3d73 7061        sparse=spa
-00019410: 7273 652c 0a20 2020 2029 0a20 2020 2072  rse,.    ).    r
-00019420: 6573 6964 7561 6c73 203d 2028 612c 2077  esiduals = (a, w
-00019430: 6569 6768 742e 7368 6170 655b 305d 2c20  eight.shape[0], 
-00019440: 7061 6464 696e 675f 6964 782c 2073 6361  padding_idx, sca
-00019450: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
-00019460: 2073 7061 7273 6529 0a20 2020 2072 6574   sparse).    ret
-00019470: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-00019480: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-00019490: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-000194a0: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
-000194b0: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
-000194c0: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
-000194d0: 6e67 5f62 6163 6b77 6172 6428 612c 206e  ng_backward(a, n
-000194e0: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
-000194f0: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
-00019500: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
-00019510: 7273 652c 2067 293a 0a20 2020 2066 726f  rse, g):.    fro
-00019520: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
-00019530: 696d 706f 7274 2065 6d62 6564 6469 6e67  import embedding
-00019540: 5f62 6163 6b77 6172 640a 0a20 2020 2070  _backward..    p
-00019550: 6164 6469 6e67 5f69 6478 203d 202d 3120  adding_idx = -1 
-00019560: 6966 2070 6164 6469 6e67 5f69 6478 2069  if padding_idx i
-00019570: 7320 4e6f 6e65 2065 6c73 6520 7061 6464  s None else padd
-00019580: 696e 675f 6964 780a 2020 2020 6777 6569  ing_idx.    gwei
-00019590: 6768 7420 3d20 656d 6265 6464 696e 675f  ght = embedding_
-000195a0: 6261 636b 7761 7264 2867 2c20 612c 206e  backward(g, a, n
-000195b0: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
-000195c0: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
-000195d0: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
-000195e0: 7273 6529 0a20 2020 2072 6574 7572 6e20  rse).    return 
-000195f0: 6777 6569 6768 740a 0a0a 4072 6567 6973  gweight...@regis
-00019600: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00019610: 7277 6172 6428 2274 6f72 6368 2e63 756d  rward("torch.cum
-00019620: 7375 6d22 290a 6465 6620 6375 6d73 756d  sum").def cumsum
-00019630: 5f61 7567 5f66 7764 2861 3a20 5072 6f78  _aug_fwd(a: Prox
-00019640: 792c 2064 696d 3a20 696e 742c 202a 2c20  y, dim: int, *, 
-00019650: 6474 7970 653a 204e 6f6e 6520 7c20 6474  dtype: None | dt
-00019660: 7970 6573 2e64 7479 7065 203d 204e 6f6e  ypes.dtype = Non
-00019670: 6529 202d 3e20 564a 5044 7561 6c3a 0a20  e) -> VJPDual:. 
-00019680: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-00019690: 746f 7263 6820 696d 706f 7274 2063 756d  torch import cum
-000196a0: 7375 6d0a 0a20 2020 2070 7269 6d61 6c20  sum..    primal 
-000196b0: 3d20 6375 6d73 756d 2861 2c20 6469 6d2c  = cumsum(a, dim,
-000196c0: 2064 7479 7065 3d64 7479 7065 290a 2020   dtype=dtype).  
-000196d0: 2020 7265 7369 6475 616c 7320 3d20 280a    residuals = (.
-000196e0: 2020 2020 2020 2020 612e 6474 7970 652c          a.dtype,
-000196f0: 0a20 2020 2020 2020 2064 696d 2c0a 2020  .        dim,.  
-00019700: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
-00019710: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
-00019720: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
-00019730: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
-00019740: 746f 7263 682e 6375 6d73 756d 2229 0a64  torch.cumsum").d
-00019750: 6566 2063 756d 7375 6d5f 6261 636b 7761  ef cumsum_backwa
-00019760: 7264 2861 5f64 7479 7065 2c20 6469 6d2c  rd(a_dtype, dim,
-00019770: 2067 293a 0a20 2020 2067 203d 2067 2e74   g):.    g = g.t
-00019780: 6f28 615f 6474 7970 6529 0a20 2020 2069  o(a_dtype).    i
-00019790: 6620 672e 6e75 6d65 6c20 3c3d 2031 206f  f g.numel <= 1 o
-000197a0: 7220 672e 7368 6170 655b 6469 6d5d 203d  r g.shape[dim] =
-000197b0: 3d20 313a 0a20 2020 2020 2020 2072 6574  = 1:.        ret
-000197c0: 7572 6e20 670a 2020 2020 7265 7475 726e  urn g.    return
-000197d0: 2067 2e66 6c69 7028 6469 6d29 2e63 756d   g.flip(dim).cum
-000197e0: 7375 6d28 6469 6d29 2e66 6c69 7028 6469  sum(dim).flip(di
-000197f0: 6d29 0a0a 0a40 7265 6769 7374 6572 5f61  m)...@register_a
-00019800: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00019810: 2822 746f 7263 682e 736f 6674 6d61 7822  ("torch.softmax"
-00019820: 290a 6465 6620 736f 6674 6d61 785f 6175  ).def softmax_au
-00019830: 675f 6677 6428 613a 2050 726f 7879 2c20  g_fwd(a: Proxy, 
-00019840: 6469 6d3a 2069 6e74 2c20 6474 7970 653a  dim: int, dtype:
-00019850: 2064 7479 7065 732e 6474 7970 6520 7c20   dtypes.dtype | 
-00019860: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
-00019870: 564a 5044 7561 6c3a 0a20 2020 2066 726f  VJPDual:.    fro
-00019880: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
-00019890: 696d 706f 7274 2073 6f66 746d 6178 0a0a  import softmax..
-000198a0: 2020 2020 7072 696d 616c 203d 2073 6f66      primal = sof
-000198b0: 746d 6178 2861 2c20 6469 6d2c 2064 7479  tmax(a, dim, dty
-000198c0: 7065 3d64 7479 7065 290a 2020 2020 7265  pe=dtype).    re
-000198d0: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
-000198e0: 6c2c 2064 696d 290a 2020 2020 7265 7475  l, dim).    retu
-000198f0: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-00019900: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
-00019910: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-00019920: 7264 2822 746f 7263 682e 736f 6674 6d61  rd("torch.softma
-00019930: 7822 290a 6465 6620 736f 6674 6d61 785f  x").def softmax_
-00019940: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
-00019950: 2064 696d 2c20 6729 3a0a 2020 2020 7265   dim, g):.    re
-00019960: 7475 726e 2070 7269 6d61 6c20 2a20 2867  turn primal * (g
-00019970: 202d 2028 7072 696d 616c 202a 2067 292e   - (primal * g).
-00019980: 7375 6d28 6469 6d2c 206b 6565 7064 696d  sum(dim, keepdim
-00019990: 3d54 7275 6529 290a 0a0a 6465 6620 6974  =True))...def it
-000199a0: 6572 5f62 6f75 6e64 5f73 796d 626f 6c73  er_bound_symbols
-000199b0: 2862 6f75 6e64 5f73 796d 626f 6c73 293a  (bound_symbols):
-000199c0: 0a20 2020 2022 2222 4974 6572 6174 6520  .    """Iterate 
-000199d0: 6f76 6572 2062 6f75 6e64 2073 796d 626f  over bound symbo
-000199e0: 6c73 2c20 736b 6970 7069 6e67 2073 796d  ls, skipping sym
-000199f0: 626f 6c73 2074 6861 7420 6172 6520 6e6f  bols that are no
-00019a00: 7420 7375 7070 6f72 7465 6420 6279 0a20  t supported by. 
-00019a10: 2020 2074 6865 2074 7261 6e73 666f 726d     the transform
-00019a20: 7320 696e 6672 6173 7472 7563 7475 7265  s infrastructure
-00019a30: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00019a40: 2020 2020 2062 6f75 6e64 5f73 796d 626f       bound_symbo
-00019a50: 6c73 2028 4c69 7374 5b42 6f75 6e64 5379  ls (List[BoundSy
-00019a60: 6d62 6f6c 5d29 3a20 4c69 7374 206f 6620  mbol]): List of 
-00019a70: 626f 756e 6420 7379 6d62 6f6c 730a 0a20  bound symbols.. 
-00019a80: 2020 2059 6965 6c64 733a 0a20 2020 2020     Yields:.     
-00019a90: 2020 2042 6f75 6e64 5379 6d62 6f6c 3a20     BoundSymbol: 
-00019aa0: 426f 756e 6420 7379 6d62 6f6c 7320 7468  Bound symbols th
-00019ab0: 6174 2061 7265 2073 7570 706f 7274 6564  at are supported
-00019ac0: 2062 7920 7468 6520 7472 616e 7366 6f72   by the transfor
-00019ad0: 6d73 0a20 2020 2020 2020 2069 6e66 7261  ms.        infra
-00019ae0: 7374 7275 6374 7572 650a 2020 2020 2222  structure.    ""
-00019af0: 220a 2020 2020 666f 7220 7379 6d62 6f6c  ".    for symbol
-00019b00: 2069 6e20 626f 756e 645f 7379 6d62 6f6c   in bound_symbol
-00019b10: 733a 0a20 2020 2020 2020 2069 6620 7379  s:.        if sy
-00019b20: 6d62 6f6c 2e73 796d 2e69 6420 696e 2074  mbol.sym.id in t
-00019b30: 7261 6e73 666f 726d 5f73 6b69 705f 6c69  ransform_skip_li
-00019b40: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-00019b50: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00019b60: 2065 6c69 6620 7379 6d62 6f6c 2e6f 7574   elif symbol.out
-00019b70: 7075 7420 6973 204e 6f6e 653a 0a20 2020  put is None:.   
-00019b80: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00019b90: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00019ba0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-00019bb0: 6420 7379 6d62 6f6c 0a0a 0a64 6566 2064  d symbol...def d
-00019bc0: 6563 6f6e 7374 7275 6374 5f66 6f72 7761  econstruct_forwa
-00019bd0: 7264 5f65 6e76 5f66 6f72 5f62 6163 6b77  rd_env_for_backw
-00019be0: 6172 6428 7472 6163 652c 2065 6e76 293a  ard(trace, env):
-00019bf0: 0a20 2020 2023 204e 6f74 6520 5b53 6176  .    # Note [Sav
-00019c00: 696e 6720 7468 6520 666f 7277 6172 6420  ing the forward 
-00019c10: 656e 7669 726f 6e6d 656e 7420 696e 2074  environment in t
-00019c20: 6865 2062 6163 6b77 6172 6420 7275 6c65  he backward rule
-00019c30: 5d0a 2020 2020 2320 5765 2063 616e 6e6f  ].    # We canno
-00019c40: 7420 7361 7665 2074 6865 2074 7261 6365  t save the trace
-00019c50: 206f 626a 6563 7420 696e 2074 6865 2072   object in the r
-00019c60: 6573 6964 7561 6c73 2062 6563 6175 7365  esiduals because
-00019c70: 2065 7865 6375 746f 7273 206d 6179 206e   executors may n
-00019c80: 6f74 0a20 2020 2023 2062 6520 6162 6c65  ot.    # be able
-00019c90: 2074 6f20 7265 7475 726e 2069 7420 666f   to return it fo
-00019ca0: 7220 7468 6520 7370 6c69 7474 6564 2066  r the splitted f
-00019cb0: 6f72 7761 7264 2f62 6163 6b77 6172 6420  orward/backward 
-00019cc0: 7061 7373 6573 2e20 496e 7374 6561 642c  passes. Instead,
-00019cd0: 2077 650a 2020 2020 2320 7361 7665 2061   we.    # save a
-00019ce0: 7267 7320 616e 6420 6b77 6172 6773 206f  rgs and kwargs o
-00019cf0: 6620 7468 6520 6f72 6967 696e 616c 2066  f the original f
-00019d00: 756e 6374 696f 6e20 6361 6c6c 2061 6e64  unction call and
-00019d10: 2072 6563 6f6e 7374 7275 6374 2074 6865   reconstruct the
-00019d20: 0a20 2020 2023 2074 7261 6365 206f 626a  .    # trace obj
-00019d30: 6563 7420 616e 6420 6974 7320 656e 7669  ect and its envi
-00019d40: 726f 6e6d 656e 7420 6469 6374 2069 6e20  ronment dict in 
-00019d50: 7468 6520 6261 636b 7761 7264 2072 756c  the backward rul
-00019d60: 652e 2048 6572 6520 7765 2072 656c 790a  e. Here we rely.
-00019d70: 2020 2020 2320 6f6e 2074 6865 2066 6163      # on the fac
-00019d80: 7420 7468 6174 2074 6865 206f 7264 6572  t that the order
-00019d90: 206f 6620 7468 6520 7379 6d62 6f6c 7320   of the symbols 
-00019da0: 696e 2074 6865 2074 7261 6365 2069 7320  in the trace is 
-00019db0: 6465 7465 726d 696e 6973 7469 630a 2020  deterministic.  
-00019dc0: 2020 2320 616e 6420 616c 7761 7973 2074    # and always t
-00019dd0: 6865 2073 616d 6520 666f 7220 7468 6520  he same for the 
-00019de0: 7361 6d65 2066 756e 6374 696f 6e20 6361  same function ca
-00019df0: 6c6c 2061 6e64 2074 6865 2073 616d 6520  ll and the same 
-00019e00: 7365 7420 6f66 0a20 2020 2023 2061 7267  set of.    # arg
-00019e10: 756d 656e 7473 2e20 5365 6520 7465 7374  uments. See test
-00019e20: 5f67 7261 642e 7079 3a74 6573 745f 746f  _grad.py:test_to
-00019e30: 7263 685f 6175 746f 6772 6164 5f66 756e  rch_autograd_fun
-00019e40: 6374 696f 6e20 666f 7220 616e 2065 7861  ction for an exa
-00019e50: 6d70 6c65 0a20 2020 2023 2077 6865 7265  mple.    # where
-00019e60: 2074 6869 7320 6973 2074 6573 7465 642e   this is tested.
-00019e70: 0a20 2020 2062 6f75 6e64 5f73 796d 626f  .    bound_symbo
-00019e80: 6c73 203d 2069 7465 725f 626f 756e 645f  ls = iter_bound_
-00019e90: 7379 6d62 6f6c 7328 7472 6163 652e 626f  symbols(trace.bo
-00019ea0: 756e 645f 7379 6d62 6f6c 7329 0a20 2020  und_symbols).   
-00019eb0: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-00019ec0: 6172 6420 3d20 7475 706c 6528 656e 765b  ard = tuple(env[
-00019ed0: 7365 7175 656e 6369 6679 2873 796d 626f  sequencify(symbo
-00019ee0: 6c2e 6f75 7470 7574 295b 305d 2e6e 616d  l.output)[0].nam
-00019ef0: 655d 2e72 6573 6964 7561 6c73 2066 6f72  e].residuals for
-00019f00: 2073 796d 626f 6c20 696e 2062 6f75 6e64   symbol in bound
-00019f10: 5f73 796d 626f 6c73 290a 2020 2020 7265  _symbols).    re
-00019f20: 7475 726e 2073 6176 6564 5f66 6f72 5f62  turn saved_for_b
-00019f30: 6163 6b77 6172 640a 0a0a 6465 6620 7265  ackward...def re
-00019f40: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
-00019f50: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
-00019f60: 7264 2874 7261 6365 2c20 7361 7665 645f  rd(trace, saved_
-00019f70: 666f 725f 6261 636b 7761 7264 293a 0a20  for_backward):. 
-00019f80: 2020 2062 6f75 6e64 5f73 796d 626f 6c73     bound_symbols
-00019f90: 203d 2069 7465 725f 626f 756e 645f 7379   = iter_bound_sy
-00019fa0: 6d62 6f6c 7328 7472 6163 652e 626f 756e  mbols(trace.boun
-00019fb0: 645f 7379 6d62 6f6c 7329 0a0a 2020 2020  d_symbols)..    
-00019fc0: 7265 636f 6e73 7472 7563 7465 645f 656e  reconstructed_en
-00019fd0: 7620 3d20 7b7d 0a0a 2020 2020 666f 7220  v = {}..    for 
-00019fe0: 6964 782c 2073 796d 2069 6e20 656e 756d  idx, sym in enum
-00019ff0: 6572 6174 6528 626f 756e 645f 7379 6d62  erate(bound_symb
-0001a000: 6f6c 7329 3a0a 2020 2020 2020 2020 6b20  ols):.        k 
-0001a010: 3d20 7365 7175 656e 6369 6679 2873 796d  = sequencify(sym
-0001a020: 2e6f 7574 7075 7429 5b30 5d2e 6e61 6d65  .output)[0].name
-0001a030: 0a20 2020 2020 2020 2076 203d 2056 4a50  .        v = VJP
-0001a040: 4475 616c 284e 6f6e 652c 2073 6176 6564  Dual(None, saved
-0001a050: 5f66 6f72 5f62 6163 6b77 6172 645b 6964  _for_backward[id
-0001a060: 785d 290a 2020 2020 2020 2020 7265 636f  x]).        reco
-0001a070: 6e73 7472 7563 7465 645f 656e 765b 6b5d  nstructed_env[k]
-0001a080: 203d 2076 0a0a 2020 2020 7265 7475 726e   = v..    return
-0001a090: 2072 6563 6f6e 7374 7275 6374 6564 5f65   reconstructed_e
-0001a0a0: 6e76 0a0a 0a64 6566 2064 6563 6f6d 706f  nv...def decompo
-0001a0b0: 7365 645f 666e 5f61 7567 5f66 7764 5f72  sed_fn_aug_fwd_r
-0001a0c0: 756c 6528 2a61 7267 732c 2064 6563 6f6d  ule(*args, decom
-0001a0d0: 706f 7365 645f 666e 2c20 2a2a 6b77 6172  posed_fn, **kwar
-0001a0e0: 6773 293a 0a20 2020 2022 2222 4175 676d  gs):.    """Augm
-0001a0f0: 656e 7465 6420 666f 7277 6172 6420 7275  ented forward ru
-0001a100: 6c65 2066 6f72 2063 6f6d 706f 7369 7465  le for composite
-0001a110: 2066 756e 6374 696f 6e73 2069 6d70 6c65   functions imple
-0001a120: 6d65 6e74 6564 2069 6e20 7465 726d 7320  mented in terms 
-0001a130: 6f66 206f 7468 6572 2066 756e 6374 696f  of other functio
-0001a140: 6e73 2074 6861 7420 6172 650a 2020 2020  ns that are.    
-0001a150: 7375 7070 6f73 6564 2074 6f20 6265 2073  supposed to be s
-0001a160: 7570 706f 7274 6564 2062 7920 7468 6520  upported by the 
-0001a170: 564a 5020 696e 6672 6173 7472 7563 7475  VJP infrastructu
-0001a180: 7265 2e0a 0a20 2020 2041 7267 733a 0a20  re...    Args:. 
-0001a190: 2020 2020 2020 2064 6563 6f6d 706f 7365         decompose
-0001a1a0: 645f 666e 2028 4361 6c6c 6162 6c65 293a  d_fn (Callable):
-0001a1b0: 2064 6563 6f6d 706f 7365 6420 7665 7273   decomposed vers
-0001a1c0: 696f 6e20 6f66 2074 6865 2066 756e 6374  ion of the funct
-0001a1d0: 696f 6e0a 0a20 2020 2052 6574 7572 6e73  ion..    Returns
-0001a1e0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-0001a1f0: 6c65 3a20 4175 676d 656e 7465 6420 666f  le: Augmented fo
-0001a200: 7277 6172 6420 7275 6c65 2066 6f72 2074  rward rule for t
-0001a210: 6865 2063 6f6d 706f 7369 7465 2066 756e  he composite fun
-0001a220: 6374 696f 6e0a 2020 2020 2222 220a 2020  ction.    """.  
-0001a230: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
-0001a240: 7563 745f 7472 6163 6528 2928 6465 636f  uct_trace()(deco
-0001a250: 6d70 6f73 6564 5f66 6e2c 202a 6172 6773  mposed_fn, *args
-0001a260: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-0001a270: 7472 6163 6520 3d20 756e 7772 6170 5f6f  trace = unwrap_o
-0001a280: 6e65 5f6c 6576 656c 5f6f 665f 7375 6273  ne_level_of_subs
-0001a290: 796d 626f 6c73 2874 7261 6365 290a 2020  ymbols(trace).  
-0001a2a0: 2020 2320 5468 6572 6520 6d61 7920 6265    # There may be
-0001a2b0: 2061 2064 6561 6420 6e6f 6465 206c 696b   a dead node lik
-0001a2c0: 6520 225f 203d 2070 7269 6d73 2e63 6f6e  e "_ = prims.con
-0001a2d0: 7665 7274 5f65 6c65 6d65 6e74 5f74 7970  vert_element_typ
-0001a2e0: 6528 302c 2066 6c6f 6174 2922 0a20 2020  e(0, float)".   
-0001a2f0: 2023 2069 6e20 7468 6520 7472 6163 652e   # in the trace.
-0001a300: 2057 6520 6e65 6564 2074 6f20 7265 6d6f   We need to remo
-0001a310: 7665 2069 7420 6265 666f 7265 2077 6520  ve it before we 
-0001a320: 6361 6e20 7573 6520 7468 6520 7472 6163  can use the trac
-0001a330: 6520 666f 720a 2020 2020 2320 6175 676d  e for.    # augm
-0001a340: 656e 7465 645f 666f 7277 6172 645f 7061  ented_forward_pa
-0001a350: 7373 2e0a 2020 2020 7472 6163 6520 3d20  ss..    trace = 
-0001a360: 6463 6528 7472 6163 6529 0a20 2020 2072  dce(trace).    r
-0001a370: 6573 756c 742c 2065 6e76 203d 2061 7567  esult, env = aug
-0001a380: 6d65 6e74 6564 5f66 6f72 7761 7264 5f70  mented_forward_p
-0001a390: 6173 7328 2a61 7267 732c 2074 7261 6365  ass(*args, trace
-0001a3a0: 3d74 7261 6365 2c20 2a2a 6b77 6172 6773  =trace, **kwargs
-0001a3b0: 290a 2020 2020 7361 7665 645f 666f 725f  ).    saved_for_
-0001a3c0: 6261 636b 7761 7264 203d 2064 6563 6f6e  backward = decon
-0001a3d0: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
-0001a3e0: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
-0001a3f0: 7472 6163 652c 2065 6e76 290a 2020 2020  trace, env).    
-0001a400: 2320 5374 6174 6963 2063 6163 6869 6e67  # Static caching
-0001a410: 2064 6f65 7320 6e6f 7420 7769 7468 2077   does not with w
-0001a420: 6974 6820 6b77 6172 6773 2064 6963 7473  ith kwargs dicts
-0001a430: 2c20 736f 2077 6527 7265 2063 6f6e 7665  , so we're conve
-0001a440: 7274 696e 6720 7468 656d 0a20 2020 2023  rting them.    #
-0001a450: 2074 6f20 4e6f 6e65 2066 6f72 206e 6f77   to None for now
-0001a460: 2077 6865 6e20 706f 7373 6962 6c65 2e0a   when possible..
-0001a470: 2020 2020 6b77 6172 6773 203d 204e 6f6e      kwargs = Non
-0001a480: 6520 6966 206e 6f74 206b 7761 7267 7320  e if not kwargs 
-0001a490: 656c 7365 206b 7761 7267 730a 2020 2020  else kwargs.    
-0001a4a0: 7265 7369 6475 616c 7320 3d20 2861 7267  residuals = (arg
-0001a4b0: 732c 206b 7761 7267 732c 2073 6176 6564  s, kwargs, saved
-0001a4c0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
-0001a4d0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-0001a4e0: 6c28 7265 7375 6c74 2c20 7265 7369 6475  l(result, residu
-0001a4f0: 616c 7329 0a0a 0a64 6566 2064 6563 6f6d  als)...def decom
-0001a500: 706f 7365 645f 666e 5f62 6163 6b77 6172  posed_fn_backwar
-0001a510: 645f 7275 6c65 2864 6563 6f6d 706f 7365  d_rule(decompose
-0001a520: 645f 666e 2c20 6172 6773 2c20 6b77 6172  d_fn, args, kwar
-0001a530: 6773 2c20 7361 7665 645f 666f 725f 6261  gs, saved_for_ba
-0001a540: 636b 7761 7264 2c20 2a67 7261 6473 293a  ckward, *grads):
-0001a550: 0a20 2020 206b 7761 7267 7320 3d20 7b7d  .    kwargs = {}
-0001a560: 2069 6620 6b77 6172 6773 2069 7320 4e6f   if kwargs is No
-0001a570: 6e65 2065 6c73 6520 6b77 6172 6773 0a20  ne else kwargs. 
-0001a580: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
-0001a590: 7275 6374 5f74 7261 6365 2829 2864 6563  ruct_trace()(dec
-0001a5a0: 6f6d 706f 7365 645f 666e 2c20 2a61 7267  omposed_fn, *arg
-0001a5b0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
-0001a5c0: 2074 7261 6365 203d 2075 6e77 7261 705f   trace = unwrap_
-0001a5d0: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
-0001a5e0: 7379 6d62 6f6c 7328 7472 6163 6529 0a20  symbols(trace). 
-0001a5f0: 2020 2074 7261 6365 203d 2064 6365 2874     trace = dce(t
-0001a600: 7261 6365 290a 2020 2020 2320 626f 756e  race).    # boun
-0001a610: 645f 7379 6d62 6f6c 7320 3d20 6974 6572  d_symbols = iter
-0001a620: 5f62 6f75 6e64 5f73 796d 626f 6c73 2874  _bound_symbols(t
-0001a630: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0001a640: 6c73 290a 2020 2020 2320 7265 636f 6e73  ls).    # recons
-0001a650: 7472 7563 7465 645f 656e 7620 3d20 7b0a  tructed_env = {.
-0001a660: 2020 2020 2320 2020 2020 7365 7175 656e      #     sequen
-0001a670: 6369 6679 2873 796d 626f 6c2e 6f75 7470  cify(symbol.outp
-0001a680: 7574 295b 305d 2e6e 616d 653a 2056 4a50  ut)[0].name: VJP
-0001a690: 4475 616c 284e 6f6e 652c 2073 6176 6564  Dual(None, saved
-0001a6a0: 5f66 6f72 5f62 6163 6b77 6172 645b 695d  _for_backward[i]
-0001a6b0: 290a 2020 2020 2320 2020 2020 666f 7220  ).    #     for 
-0001a6c0: 692c 2073 796d 626f 6c20 696e 2065 6e75  i, symbol in enu
-0001a6d0: 6d65 7261 7465 2862 6f75 6e64 5f73 796d  merate(bound_sym
-0001a6e0: 626f 6c73 290a 2020 2020 2320 7d0a 2020  bols).    # }.  
-0001a6f0: 2020 7265 636f 6e73 7472 7563 7465 645f    reconstructed_
-0001a700: 656e 7620 3d20 7265 636f 6e73 7472 7563  env = reconstruc
-0001a710: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
-0001a720: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
-0001a730: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-0001a740: 7761 7264 290a 2020 2020 7265 7375 6c74  ward).    result
-0001a750: 203d 2062 6163 6b77 6172 645f 7061 7373   = backward_pass
-0001a760: 2872 6563 6f6e 7374 7275 6374 6564 5f65  (reconstructed_e
-0001a770: 6e76 2c20 7472 6163 652c 2067 7261 6473  nv, trace, grads
-0001a780: 290a 2020 2020 6966 206c 656e 2861 7267  ).    if len(arg
-0001a790: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
-0001a7a0: 2072 6574 7572 6e20 7265 7375 6c74 5b30   return result[0
-0001a7b0: 5d0a 2020 2020 2320 4261 636b 7761 7264  ].    # Backward
-0001a7c0: 2070 6173 7320 6d69 6768 7420 7265 7475   pass might retu
-0001a7d0: 726e 2061 2064 6963 7420 7769 7468 2067  rn a dict with g
-0001a7e0: 7261 6473 2062 7574 2063 7572 7265 6e74  rads but current
-0001a7f0: 2069 6e74 6572 6661 6365 206f 660a 2020   interface of.  
-0001a800: 2020 2320 6261 636b 7761 7264 2072 756c    # backward rul
-0001a810: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
-0001a820: 7274 2069 742e 2053 6f20 7765 206a 7573  rt it. So we jus
-0001a830: 7420 6472 6f70 2069 7420 666f 7220 6e6f  t drop it for no
-0001a840: 772e 0a20 2020 2065 6c69 6620 6973 696e  w..    elif isin
-0001a850: 7374 616e 6365 2872 6573 756c 745b 2d31  stance(result[-1
-0001a860: 5d2c 2064 6963 7429 3a0a 2020 2020 2020  ], dict):.      
-0001a870: 2020 7265 7475 726e 2072 6573 756c 745b    return result[
-0001a880: 3a2d 315d 0a20 2020 2072 6574 7572 6e20  :-1].    return 
-0001a890: 7265 7375 6c74 0a0a 0a40 7265 6769 7374  result...@regist
-0001a8a0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-0001a8b0: 7761 7264 2822 746f 7263 682e 5465 6e73  ward("torch.Tens
-0001a8c0: 6f72 2e63 6f6e 7469 6775 6f75 7322 290a  or.contiguous").
-0001a8d0: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-0001a8e0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-0001a8f0: 6368 2e63 6f6e 7469 6775 6f75 7322 290a  ch.contiguous").
-0001a900: 6465 6620 636f 6e74 6967 756f 7573 5f61  def contiguous_a
-0001a910: 7567 5f66 7764 2878 3a20 5465 6e73 6f72  ug_fwd(x: Tensor
-0001a920: 5072 6f78 792c 202f 2c20 2a2c 206d 656d  Proxy, /, *, mem
-0001a930: 6f72 795f 666f 726d 6174 3a20 746f 7263  ory_format: torc
-0001a940: 682e 6d65 6d6f 7279 5f66 6f72 6d61 7420  h.memory_format 
-0001a950: 3d20 746f 7263 682e 636f 6e74 6967 756f  = torch.contiguo
-0001a960: 7573 5f66 6f72 6d61 7429 202d 3e20 564a  us_format) -> VJ
-0001a970: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
-0001a980: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-0001a990: 706f 7274 2063 6f6e 7469 6775 6f75 730a  port contiguous.
-0001a9a0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-0001a9b0: 7561 6c28 636f 6e74 6967 756f 7573 2878  ual(contiguous(x
-0001a9c0: 2c20 6d65 6d6f 7279 5f66 6f72 6d61 743d  , memory_format=
-0001a9d0: 6d65 6d6f 7279 5f66 6f72 6d61 7429 2c20  memory_format), 
-0001a9e0: 7475 706c 6528 2929 0a0a 0a40 7265 6769  tuple())...@regi
-0001a9f0: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
-0001aa00: 6f72 6368 2e54 656e 736f 722e 636f 6e74  orch.Tensor.cont
-0001aa10: 6967 756f 7573 2229 0a40 7265 6769 7374  iguous").@regist
-0001aa20: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
-0001aa30: 6368 2e63 6f6e 7469 6775 6f75 7322 290a  ch.contiguous").
-0001aa40: 6465 6620 636f 6e74 6967 756f 7573 5f62  def contiguous_b
-0001aa50: 6163 6b77 6172 6428 2a72 6573 6964 7561  ackward(*residua
-0001aa60: 6c73 5f61 6e64 5f67 7261 6429 202d 3e20  ls_and_grad) -> 
-0001aa70: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-0001aa80: 2023 2052 6573 6964 7561 6c73 2069 7320   # Residuals is 
-0001aa90: 6e6f 7420 656d 7074 7920 6265 6361 7573  not empty becaus
-0001aaa0: 6520 636f 6e74 6967 756f 7573 2073 796d  e contiguous sym
-0001aab0: 626f 6c20 6861 7320 7468 6520 7361 6d65  bol has the same
-0001aac0: 206f 7574 7075 7420 6173 2069 7473 2069   output as its i
-0001aad0: 6e70 7574 0a20 2020 2067 203d 2072 6573  nput.    g = res
-0001aae0: 6964 7561 6c73 5f61 6e64 5f67 7261 645b  iduals_and_grad[
-0001aaf0: 2d31 5d0a 2020 2020 7265 7475 726e 2067  -1].    return g
-0001ab00: 0a0a 0a64 6566 2072 6563 6970 726f 6361  ...def reciproca
-0001ab10: 6c5f 6175 675f 6677 6428 613a 2054 656e  l_aug_fwd(a: Ten
-0001ab20: 736f 7250 726f 7879 2920 2d3e 2056 4a50  sorProxy) -> VJP
-0001ab30: 4475 616c 3a0a 2020 2020 7072 696d 616c  Dual:.    primal
-0001ab40: 203d 2072 6563 6970 726f 6361 6c28 6129   = reciprocal(a)
-0001ab50: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-0001ab60: 7561 6c28 7072 696d 616c 2c20 2870 7269  ual(primal, (pri
-0001ab70: 6d61 6c2c 2929 0a0a 0a64 6566 2072 6563  mal,))...def rec
-0001ab80: 6970 726f 6361 6c5f 6261 636b 7761 7264  iprocal_backward
-0001ab90: 2870 7269 6d61 6c2c 2067 293a 0a20 2020  (primal, g):.   
-0001aba0: 2072 6574 7572 6e20 2d67 202a 2070 7269   return -g * pri
-0001abb0: 6d61 6c20 2a20 7072 696d 616c 0a0a 0a40  mal * primal...@
-0001abc0: 7061 7274 6961 6c28 7265 6769 7374 6572  partial(register
-0001abd0: 5f67 7261 642c 2070 7269 6d73 2e50 7269  _grad, prims.Pri
-0001abe0: 6d49 4473 2e52 4543 4950 524f 4341 4c29  mIDs.RECIPROCAL)
-0001abf0: 0a64 6566 2072 6563 6970 726f 6361 6c5f  .def reciprocal_
-0001ac00: 6a6f 696e 745f 666f 7277 6172 645f 6261  joint_forward_ba
-0001ac10: 636b 7761 7264 5f72 756c 6528 613a 2054  ckward_rule(a: T
-0001ac20: 656e 736f 7250 726f 7879 2920 2d3e 2054  ensorProxy) -> T
-0001ac30: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-0001ac40: 7265 7375 6c74 2c20 7361 7665 6420 3d20  result, saved = 
-0001ac50: 7265 6369 7072 6f63 616c 5f61 7567 5f66  reciprocal_aug_f
-0001ac60: 7764 2861 290a 2020 2020 6720 3d20 6765  wd(a).    g = ge
-0001ac70: 745f 6772 6164 2872 6573 756c 7429 0a20  t_grad(result). 
-0001ac80: 2020 2067 6120 3d20 7265 6369 7072 6f63     ga = reciproc
-0001ac90: 616c 5f62 6163 6b77 6172 6428 2a73 6176  al_backward(*sav
-0001aca0: 6564 2c20 6729 0a20 2020 2070 7574 5f67  ed, g).    put_g
-0001acb0: 7261 6428 612c 2067 6129 0a20 2020 2072  rad(a, ga).    r
-0001acc0: 6574 7572 6e20 7265 7375 6c74 0a0a 0a40  eturn result...@
-0001acd0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-0001ace0: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
-0001acf0: 682e 696e 6465 785f 7075 7422 290a 6465  h.index_put").de
-0001ad00: 6620 696e 6465 785f 7075 745f 6175 675f  f index_put_aug_
-0001ad10: 6677 6428 0a20 2020 2061 3a20 5465 6e73  fwd(.    a: Tens
-0001ad20: 6f72 5072 6f78 792c 202f 2c20 696e 6469  orProxy, /, indi
-0001ad30: 6365 733a 2053 6571 7565 6e63 655b 5465  ces: Sequence[Te
-0001ad40: 6e73 6f72 5072 6f78 795d 2c20 7661 6c75  nsorProxy], valu
-0001ad50: 6573 3a20 5465 6e73 6f72 5072 6f78 792c  es: TensorProxy,
-0001ad60: 2061 6363 756d 756c 6174 653a 2062 6f6f   accumulate: boo
-0001ad70: 6c20 3d20 4661 6c73 650a 2920 2d3e 2056  l = False.) -> V
-0001ad80: 4a50 4475 616c 3a0a 2020 2020 7072 696d  JPDual:.    prim
-0001ad90: 616c 203d 2063 6c61 6e67 2e69 6e64 6578  al = clang.index
-0001ada0: 5f70 7574 2861 2c20 696e 6469 6365 732c  _put(a, indices,
-0001adb0: 2076 616c 7565 732c 2061 6363 756d 756c   values, accumul
-0001adc0: 6174 6529 0a20 2020 2072 6573 6964 7561  ate).    residua
-0001add0: 6c73 203d 2028 0a20 2020 2020 2020 2069  ls = (.        i
-0001ade0: 6e64 6963 6573 2c0a 2020 2020 2020 2020  ndices,.        
-0001adf0: 7661 6c75 6573 2c0a 2020 2020 2020 2020  values,.        
-0001ae00: 6163 6375 6d75 6c61 7465 2c0a 2020 2020  accumulate,.    
-0001ae10: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-0001ae20: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
-0001ae30: 6964 7561 6c73 290a 0a0a 6465 6620 7375  iduals)...def su
-0001ae40: 6d5f 746f 2861 3a20 5465 6e73 6f72 5072  m_to(a: TensorPr
-0001ae50: 6f78 792c 2073 6861 7065 3a20 5365 7175  oxy, shape: Sequ
-0001ae60: 656e 6365 5b69 6e74 5d29 202d 3e20 5465  ence[int]) -> Te
-0001ae70: 6e73 6f72 5072 6f78 793a 0a20 2020 2069  nsorProxy:.    i
-0001ae80: 6620 6e6f 7420 7368 6170 653a 0a20 2020  f not shape:.   
-0001ae90: 2020 2020 2072 6574 7572 6e20 612e 7375       return a.su
-0001aea0: 6d28 290a 2020 2020 6c65 6164 696e 675f  m().    leading_
-0001aeb0: 6469 6d73 203d 2061 2e6e 6469 6d20 2d20  dims = a.ndim - 
-0001aec0: 6c65 6e28 7368 6170 6529 0a20 2020 2072  len(shape).    r
-0001aed0: 6564 7563 655f 6469 6d73 203d 2074 7570  educe_dims = tup
-0001aee0: 6c65 2872 616e 6765 286c 6561 6469 6e67  le(range(leading
-0001aef0: 5f64 696d 7329 2920 2b20 7475 706c 6528  _dims)) + tuple(
-0001af00: 0a20 2020 2020 2020 2069 2066 6f72 2069  .        i for i
-0001af10: 2069 6e20 7261 6e67 6528 6c65 6164 696e   in range(leadin
-0001af20: 675f 6469 6d73 2c20 612e 6e64 696d 2920  g_dims, a.ndim) 
-0001af30: 6966 2073 6861 7065 5b69 202d 206c 6561  if shape[i - lea
-0001af40: 6469 6e67 5f64 696d 735d 203d 3d20 3120  ding_dims] == 1 
-0001af50: 616e 6420 612e 7368 6170 655b 695d 2021  and a.shape[i] !
-0001af60: 3d20 310a 2020 2020 290a 2020 2020 6120  = 1.    ).    a 
-0001af70: 3d20 6c74 6f72 6368 2e73 756d 2861 2c20  = ltorch.sum(a, 
-0001af80: 6469 6d3d 7265 6475 6365 5f64 696d 732c  dim=reduce_dims,
-0001af90: 206b 6565 7064 696d 3d54 7275 6529 0a20   keepdim=True). 
-0001afa0: 2020 2069 6620 6c65 6164 696e 675f 6469     if leading_di
-0001afb0: 6d73 203e 2030 3a0a 2020 2020 2020 2020  ms > 0:.        
-0001afc0: 7265 7475 726e 206c 746f 7263 682e 7669  return ltorch.vi
-0001afd0: 6577 2861 2c20 7368 6170 6529 0a20 2020  ew(a, shape).   
-0001afe0: 2072 6574 7572 6e20 610a 0a0a 4072 6567   return a...@reg
-0001aff0: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
-0001b000: 746f 7263 682e 696e 6465 785f 7075 7422  torch.index_put"
-0001b010: 290a 6465 6620 696e 6465 785f 7075 745f  ).def index_put_
-0001b020: 6261 636b 7761 7264 2869 6e64 6963 6573  backward(indices
-0001b030: 3a20 5365 7175 656e 6365 5b54 656e 736f  : Sequence[Tenso
-0001b040: 7250 726f 7879 5d2c 2076 616c 7565 733a  rProxy], values:
-0001b050: 2054 656e 736f 7250 726f 7879 2c20 6163   TensorProxy, ac
-0001b060: 6375 6d75 6c61 7465 3a20 626f 6f6c 2c20  cumulate: bool, 
-0001b070: 673a 2054 656e 736f 7250 726f 7879 293a  g: TensorProxy):
-0001b080: 0a20 2020 2067 5f76 616c 7565 7320 3d20  .    g_values = 
-0001b090: 675b 696e 6469 6365 735d 0a20 2020 2023  g[indices].    #
-0001b0a0: 2074 6f72 6368 2068 6173 2065 7874 7261   torch has extra
-0001b0b0: 206c 6f67 6963 2074 6f20 6861 6e64 6c65   logic to handle
-0001b0c0: 2074 6865 2065 7870 616e 6465 6420 7661   the expanded va
-0001b0d0: 6c75 6573 0a20 2020 2069 6620 6e6f 7420  lues.    if not 
-0001b0e0: 7574 696c 732e 7361 6d65 5f73 6861 7065  utils.same_shape
-0001b0f0: 2867 5f76 616c 7565 732e 7368 6170 652c  (g_values.shape,
-0001b100: 2076 616c 7565 732e 7368 6170 6529 3a0a   values.shape):.
-0001b110: 2020 2020 2020 2020 6966 2063 6c61 6e67          if clang
-0001b120: 2e63 6f6d 7075 7465 5f62 726f 6164 6361  .compute_broadca
-0001b130: 7374 5f73 6861 7065 2867 5f76 616c 7565  st_shape(g_value
-0001b140: 732e 7368 6170 652c 2076 616c 7565 732e  s.shape, values.
-0001b150: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-0001b160: 2020 2020 675f 7661 6c75 6573 203d 2073      g_values = s
-0001b170: 756d 5f74 6f28 675f 7661 6c75 6573 2c20  um_to(g_values, 
-0001b180: 7661 6c75 6573 2e73 6861 7065 290a 2020  values.shape).  
-0001b190: 2020 6966 2061 6363 756d 756c 6174 653a    if accumulate:
-0001b1a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001b1b0: 672c 2067 5f76 616c 7565 730a 2020 2020  g, g_values.    
-0001b1c0: 7265 7475 726e 2063 6c61 6e67 2e69 6e64  return clang.ind
-0001b1d0: 6578 5f70 7574 2867 2c20 696e 6469 6365  ex_put(g, indice
-0001b1e0: 732c 206c 746f 7263 682e 7a65 726f 735f  s, ltorch.zeros_
-0001b1f0: 6c69 6b65 2876 616c 7565 7329 2c20 4661  like(values), Fa
-0001b200: 6c73 6529 2c20 675f 7661 6c75 6573 0a0a  lse), g_values..
-0001b210: 0a64 6566 2075 6e69 666f 726d 5f61 7567  .def uniform_aug
-0001b220: 5f66 7764 2873 6861 7065 2c20 6d69 6e76  _fwd(shape, minv
-0001b230: 616c 2c20 6d61 7876 616c 2c20 2a2c 2064  al, maxval, *, d
-0001b240: 6576 6963 652c 2064 7479 7065 293a 0a20  evice, dtype):. 
-0001b250: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
-0001b260: 732e 756e 6966 6f72 6d28 7368 6170 652c  s.uniform(shape,
-0001b270: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
-0001b280: 2064 6576 6963 653d 6465 7669 6365 2c20   device=device, 
-0001b290: 6474 7970 653d 6474 7970 6529 0a20 2020  dtype=dtype).   
-0001b2a0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-0001b2b0: 7072 696d 616c 2c20 2870 7269 6d61 6c2c  primal, (primal,
-0001b2c0: 206d 696e 7661 6c2c 206d 6178 7661 6c29   minval, maxval)
-0001b2d0: 290a 0a0a 6465 6620 756e 6966 6f72 6d5f  )...def uniform_
-0001b2e0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
-0001b2f0: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
-0001b300: 2067 293a 0a20 2020 2023 2075 6e69 666f   g):.    # unifo
-0001b310: 726d 2069 7320 696d 706c 656d 656e 7465  rm is implemente
-0001b320: 6420 6173 2028 6d61 7876 616c 202d 206d  d as (maxval - m
-0001b330: 696e 7661 6c29 202a 2075 6e69 666f 726d  inval) * uniform
-0001b340: 2873 6861 7065 2c20 302c 2031 2920 2b20  (shape, 0, 1) + 
-0001b350: 6d69 6e76 616c 0a20 2020 2075 6e73 6361  minval.    unsca
-0001b360: 6c65 645f 7072 696d 616c 203d 2028 7072  led_primal = (pr
-0001b370: 696d 616c 202d 206d 696e 7661 6c29 202f  imal - minval) /
-0001b380: 2028 6d61 7876 616c 202d 206d 696e 7661   (maxval - minva
-0001b390: 6c29 0a20 2020 2072 6564 7563 655f 616c  l).    reduce_al
-0001b3a0: 6c5f 6469 6d73 203d 2074 7570 6c65 2872  l_dims = tuple(r
-0001b3b0: 616e 6765 2867 2e6e 6469 6d29 290a 2020  ange(g.ndim)).  
-0001b3c0: 2020 7375 6d20 3d20 7061 7274 6961 6c28    sum = partial(
-0001b3d0: 7072 696d 732e 7375 6d2c 2064 696d 733d  prims.sum, dims=
-0001b3e0: 7265 6475 6365 5f61 6c6c 5f64 696d 7329  reduce_all_dims)
-0001b3f0: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
-0001b400: 2c20 7375 6d28 6720 2a20 2831 202d 2075  , sum(g * (1 - u
-0001b410: 6e73 6361 6c65 645f 7072 696d 616c 2929  nscaled_primal))
-0001b420: 2c20 7375 6d28 6720 2a20 756e 7363 616c  , sum(g * unscal
-0001b430: 6564 5f70 7269 6d61 6c29 0a0a 0a6e 6f6e  ed_primal)...non
-0001b440: 6469 6666 6572 656e 7469 6162 6c65 5f76  differentiable_v
-0001b450: 6a70 5f73 796d 626f 6c73 203d 2028 7072  jp_symbols = (pr
-0001b460: 696d 732e 5072 696d 4944 732e 4249 5457  ims.PrimIDs.BITW
-0001b470: 4953 455f 414e 442c 2070 7269 6d73 2e50  ISE_AND, prims.P
-0001b480: 7269 6d49 4473 2e53 4947 4e42 4954 2c20  rimIDs.SIGNBIT, 
-0001b490: 7072 696d 732e 5072 696d 4944 732e 4655  prims.PrimIDs.FU
-0001b4a0: 4c4c 290a 0a0a 6465 6620 6973 5f63 6f6e  LL)...def is_con
-0001b4b0: 7374 616e 745f 666f 725f 766a 7028 7379  stant_for_vjp(sy
-0001b4c0: 6d62 6f6c 3a20 7072 696d 732e 5379 6d62  mbol: prims.Symb
-0001b4d0: 6f6c 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ol) -> bool:.   
-0001b4e0: 2022 2222 4368 6563 6b20 6966 2061 2073   """Check if a s
-0001b4f0: 796d 626f 6c20 6973 2063 6f6e 7374 616e  ymbol is constan
-0001b500: 7420 666f 7220 7468 6520 564a 5020 7472  t for the VJP tr
-0001b510: 616e 7366 6f72 6d2e 0a0a 2020 2020 4172  ansform...    Ar
-0001b520: 6773 3a0a 2020 2020 2020 2020 7379 6d62  gs:.        symb
-0001b530: 6f6c 2028 7072 696d 732e 5379 6d62 6f6c  ol (prims.Symbol
-0001b540: 293a 2053 796d 626f 6c20 746f 2063 6865  ): Symbol to che
-0001b550: 636b 2e0a 0a20 2020 2052 6574 7572 6e73  ck...    Returns
-0001b560: 3a0a 2020 2020 2020 2020 626f 6f6c 3a20  :.        bool: 
-0001b570: 5472 7565 2069 6620 7468 6520 7379 6d62  True if the symb
-0001b580: 6f6c 2069 7320 636f 6e73 7461 6e74 2c20  ol is constant, 
-0001b590: 4661 6c73 6520 6f74 6865 7277 6973 652e  False otherwise.
-0001b5a0: 0a20 2020 2022 2222 0a20 2020 2061 7265  .    """.    are
-0001b5b0: 5f61 6c6c 5f61 7267 735f 6e6f 6e5f 6469  _all_args_non_di
-0001b5c0: 6666 6572 656e 7469 6162 6c65 203d 206e  fferentiable = n
-0001b5d0: 6f74 2061 6e79 2869 7369 6e73 7461 6e63  ot any(isinstanc
-0001b5e0: 6528 6172 672c 2028 466c 6f61 7450 726f  e(arg, (FloatPro
-0001b5f0: 7879 2c20 5465 6e73 6f72 5072 6f78 7929  xy, TensorProxy)
-0001b600: 2920 666f 7220 6172 6720 696e 2073 796d  ) for arg in sym
-0001b610: 626f 6c2e 666c 6174 5f61 7267 7329 0a20  bol.flat_args). 
-0001b620: 2020 2072 6574 7572 6e20 280a 2020 2020     return (.    
-0001b630: 2020 2020 6172 655f 616c 6c5f 6172 6773      are_all_args
-0001b640: 5f6e 6f6e 5f64 6966 6665 7265 6e74 6961  _non_differentia
-0001b650: 626c 650a 2020 2020 2020 2020 6f72 2073  ble.        or s
-0001b660: 796d 626f 6c2e 6172 655f 616c 6c5f 6172  ymbol.are_all_ar
-0001b670: 6773 5f63 6f6e 7374 616e 740a 2020 2020  gs_constant.    
-0001b680: 2020 2020 6f72 2073 796d 626f 6c2e 7379      or symbol.sy
-0001b690: 6d2e 6964 2069 6e20 6e6f 6e64 6966 6665  m.id in nondiffe
-0001b6a0: 7265 6e74 6961 626c 655f 766a 705f 7379  rentiable_vjp_sy
-0001b6b0: 6d62 6f6c 730a 2020 2020 290a 0a0a 6465  mbols.    )...de
-0001b6c0: 6620 766a 705f 7379 6d62 6f6c 5f6d 6170  f vjp_symbol_map
-0001b6d0: 7065 7228 7379 6d62 6f6c 3a20 7072 696d  per(symbol: prim
-0001b6e0: 732e 5379 6d62 6f6c 2c20 2a61 7267 732c  s.Symbol, *args,
-0001b6f0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0001b700: 2222 2253 796d 626f 6c20 6d61 7070 6572  """Symbol mapper
-0001b710: 2066 6f72 2074 6865 2056 4a50 2074 7261   for the VJP tra
-0001b720: 6e73 666f 726d 2e0a 0a20 2020 2041 7267  nsform...    Arg
-0001b730: 733a 0a20 2020 2020 2020 2073 796d 626f  s:.        symbo
-0001b740: 6c20 2870 7269 6d73 2e53 796d 626f 6c29  l (prims.Symbol)
-0001b750: 3a20 5379 6d62 6f6c 2074 6f20 6265 206d  : Symbol to be m
-0001b760: 6170 7065 642e 0a20 2020 2020 2020 2061  apped..        a
-0001b770: 7267 7320 2854 7570 6c65 5b56 6172 6961  rgs (Tuple[Varia
-0001b780: 626c 655d 293a 2041 7267 756d 656e 7473  ble]): Arguments
-0001b790: 2074 6f20 7468 6520 7379 6d62 6f6c 2e0a   to the symbol..
-0001b7a0: 2020 2020 2020 2020 6b77 6172 6773 2028          kwargs (
-0001b7b0: 4469 6374 5b73 7472 2c20 5661 7269 6162  Dict[str, Variab
-0001b7c0: 6c65 5d29 3a20 4b65 7977 6f72 6420 6172  le]): Keyword ar
-0001b7d0: 6775 6d65 6e74 7320 746f 2074 6865 2073  guments to the s
-0001b7e0: 796d 626f 6c2e 0a0a 2020 2020 5265 7475  ymbol...    Retu
-0001b7f0: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-0001b800: 6c61 626c 653a 2041 2066 756e 6374 696f  lable: A functio
-0001b810: 6e20 7468 6174 2063 6f6d 7075 7465 7320  n that computes 
-0001b820: 7468 6520 564a 5020 6f66 2074 6865 2073  the VJP of the s
-0001b830: 796d 626f 6c2e 0a20 2020 2022 2222 0a20  ymbol..    """. 
-0001b840: 2020 2023 2043 6f6e 7374 616e 7420 6361     # Constant ca
-0001b850: 7365 0a20 2020 2069 6620 6973 5f63 6f6e  se.    if is_con
-0001b860: 7374 616e 745f 666f 725f 766a 7028 7379  stant_for_vjp(sy
-0001b870: 6d62 6f6c 293a 0a0a 2020 2020 2020 2020  mbol):..        
-0001b880: 6465 6620 766a 705f 696d 706c 5f63 6f6e  def vjp_impl_con
-0001b890: 7374 2873 796d 626f 6c2c 202a 6172 6773  st(symbol, *args
-0001b8a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0001b8b0: 2020 2020 2020 2020 2061 7267 732c 206b           args, k
-0001b8c0: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
-0001b8d0: 286c 616d 6264 6120 783a 2078 2e70 7269  (lambda x: x.pri
-0001b8e0: 6d61 6c20 6966 2069 7369 6e73 7461 6e63  mal if isinstanc
-0001b8f0: 6528 782c 2056 4a50 4475 616c 2920 656c  e(x, VJPDual) el
-0001b900: 7365 2078 2c20 2861 7267 732c 206b 7761  se x, (args, kwa
-0001b910: 7267 7329 290a 2020 2020 2020 2020 2020  rgs)).          
-0001b920: 2020 7072 696d 616c 7320 3d20 7379 6d62    primals = symb
-0001b930: 6f6c 5f74 6f5f 6576 616c 2873 796d 626f  ol_to_eval(symbo
-0001b940: 6c29 282a 6172 6773 2c20 2a2a 6b77 6172  l)(*args, **kwar
-0001b950: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-0001b960: 6966 2069 7369 6e73 7461 6e63 6528 7072  if isinstance(pr
-0001b970: 696d 616c 732c 2053 6571 7565 6e63 6529  imals, Sequence)
-0001b980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b990: 2020 7265 7475 726e 2074 7265 655f 6d61    return tree_ma
-0001b9a0: 7028 6c61 6d62 6461 2078 3a20 564a 5044  p(lambda x: VJPD
-0001b9b0: 7561 6c28 782c 2074 7570 6c65 2829 292c  ual(x, tuple()),
-0001b9c0: 2070 7269 6d61 6c73 290a 2020 2020 2020   primals).      
-0001b9d0: 2020 2020 2020 7265 7475 726e 2056 4a50        return VJP
-0001b9e0: 4475 616c 2870 7269 6d61 6c73 2c20 7475  Dual(primals, tu
-0001b9f0: 706c 6528 2929 0a0a 2020 2020 2020 2020  ple())..        
-0001ba00: 7265 7475 726e 2070 6172 7469 616c 2876  return partial(v
-0001ba10: 6a70 5f69 6d70 6c5f 636f 6e73 742c 2073  jp_impl_const, s
-0001ba20: 796d 626f 6c29 0a0a 2020 2020 2320 4e6f  ymbol)..    # No
-0001ba30: 726d 616c 2063 6173 652c 2077 6520 6861  rmal case, we ha
-0001ba40: 7665 2061 2070 726f 7879 2074 616e 6765  ve a proxy tange
-0001ba50: 6e74 0a20 2020 2076 6a70 5f69 6d70 6c20  nt.    vjp_impl 
-0001ba60: 3d20 6175 676d 656e 7465 645f 666f 7277  = augmented_forw
-0001ba70: 6172 645f 696d 706c 732e 6765 7428 7379  ard_impls.get(sy
-0001ba80: 6d62 6f6c 2e73 796d 2e69 6429 0a0a 2020  mbol.sym.id)..  
-0001ba90: 2020 6966 205f 6765 745f 6772 6164 666e    if _get_gradfn
-0001baa0: 5f61 6e64 5f65 7865 6375 746f 7228 7379  _and_executor(sy
-0001bab0: 6d62 6f6c 295b 305d 2069 7320 6e6f 7420  mbol)[0] is not 
-0001bac0: 4e6f 6e65 3a0a 2020 2020 2020 2020 766a  None:.        vj
-0001bad0: 705f 696d 706c 2c20 6261 636b 7761 7264  p_impl, backward
-0001bae0: 5f66 6e20 3d20 6d61 6b65 5f61 7567 5f66  _fn = make_aug_f
-0001baf0: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
-0001bb00: 6172 6428 7379 6d62 6f6c 290a 0a20 2020  ard(symbol)..   
-0001bb10: 2069 6620 766a 705f 696d 706c 2069 7320   if vjp_impl is 
-0001bb20: 4e6f 6e65 3a0a 2020 2020 2020 2020 2320  None:.        # 
-0001bb30: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
-0001bb40: 6420 6120 564a 5020 666f 7220 7468 6973  d a VJP for this
-0001bb50: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
-0001bb60: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
-0001bb70: 6974 0a20 2020 2020 2020 2069 6620 6c65  it.        if le
-0001bb80: 6e28 7379 6d62 6f6c 2e73 7562 7379 6d62  n(symbol.subsymb
-0001bb90: 6f6c 7329 203e 2030 2061 6e64 206e 6f74  ols) > 0 and not
-0001bba0: 2069 7369 6e73 7461 6e63 6528 7379 6d62   isinstance(symb
-0001bbb0: 6f6c 2e73 796d 2e69 642c 2070 7269 6d73  ol.sym.id, prims
-0001bbc0: 2e50 7269 6d49 4473 293a 0a20 2020 2020  .PrimIDs):.     
-0001bbd0: 2020 2020 2020 2076 6a70 5f69 6d70 6c20         vjp_impl 
-0001bbe0: 3d20 7061 7274 6961 6c28 6465 636f 6d70  = partial(decomp
-0001bbf0: 6f73 6564 5f66 6e5f 6175 675f 6677 645f  osed_fn_aug_fwd_
-0001bc00: 7275 6c65 2c20 6465 636f 6d70 6f73 6564  rule, decomposed
-0001bc10: 5f66 6e3d 7379 6d62 6f6c 2e73 796d 290a  _fn=symbol.sym).
-0001bc20: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001bc30: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
-0001bc40: 6f75 6c64 206e 6f74 2066 696e 6420 6120  ould not find a 
-0001bc50: 564a 5020 666f 7220 7468 6973 2073 796d  VJP for this sym
-0001bc60: 626f 6c20 616e 6420 7765 2063 6f75 6c64  bol and we could
-0001bc70: 206e 6f74 2064 6563 6f6d 706f 7365 2069   not decompose i
-0001bc80: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0001bc90: 4974 2063 6f75 6c64 2062 6520 6120 746f  It could be a to
-0001bca0: 7263 682e 6472 6f70 6f75 7420 7769 7468  rch.dropout with
-0001bcb0: 2030 2e30 2070 726f 6261 6269 6c69 7479   0.0 probability
-0001bcc0: 2c20 736f 2077 6520 736b 6970 2069 740a  , so we skip it.
-0001bcd0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001bce0: 796d 626f 6c2e 7379 6d2e 6964 203d 3d20  ymbol.sym.id == 
-0001bcf0: 2274 6f72 6368 2e6e 6e2e 6675 6e63 7469  "torch.nn.functi
-0001bd00: 6f6e 616c 2e64 726f 706f 7574 223a 0a20  onal.dropout":. 
-0001bd10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001bd20: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-0001bd30: 2020 2020 2020 2070 7269 6e74 2866 2256         print(f"V
-0001bd40: 4a50 2066 6f72 207b 7379 6d62 6f6c 7d20  JP for {symbol} 
-0001bd50: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-0001bd60: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-0001bd70: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-0001bd80: 656e 7465 6445 7272 6f72 2866 2256 4a50  entedError(f"VJP
-0001bd90: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
-0001bda0: 2e69 647d 2069 7320 6e6f 7420 696d 706c  .id} is not impl
-0001bdb0: 656d 656e 7465 6422 290a 0a20 2020 2064  emented")..    d
-0001bdc0: 6566 205f 766a 705f 696d 706c 282a 6172  ef _vjp_impl(*ar
-0001bdd0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-0001bde0: 2020 2020 2020 2070 7269 6d61 6c73 2c20         primals, 
-0001bdf0: 6b77 6172 6773 203d 2074 7265 655f 6d61  kwargs = tree_ma
-0001be00: 7028 6c61 6d62 6461 2078 3a20 782e 7072  p(lambda x: x.pr
-0001be10: 696d 616c 2069 6620 6973 696e 7374 616e  imal if isinstan
-0001be20: 6365 2878 2c20 564a 5044 7561 6c29 2065  ce(x, VJPDual) e
-0001be30: 6c73 6520 782c 2028 6172 6773 2c20 6b77  lse x, (args, kw
-0001be40: 6172 6773 2929 0a20 2020 2020 2020 206f  args)).        o
-0001be50: 7574 5f70 7269 6d61 6c2c 206f 7574 5f72  ut_primal, out_r
-0001be60: 6573 6964 7561 6c73 203d 2076 6a70 5f69  esiduals = vjp_i
-0001be70: 6d70 6c28 2a70 7269 6d61 6c73 2c20 2a2a  mpl(*primals, **
-0001be80: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
-0001be90: 2023 2057 6520 6172 6520 7361 7669 6e67   # We are saving
-0001bea0: 2074 6865 2072 6573 6964 7561 6c73 2061   the residuals a
-0001beb0: 6e64 2070 756c 6c62 6163 6b20 6f6e 6c79  nd pullback only
-0001bec0: 2069 6e20 7468 6520 6669 7273 7420 6f75   in the first ou
-0001bed0: 7470 7574 0a20 2020 2020 2020 2023 2062  tput.        # b
-0001bee0: 6163 6b77 6172 645f 7061 7373 2074 6865  ackward_pass the
-0001bef0: 6e20 7265 7472 6965 7665 7320 7468 6520  n retrieves the 
-0001bf00: 7265 7369 6475 616c 7320 616e 6420 7075  residuals and pu
-0001bf10: 6c6c 6261 636b 2066 726f 6d20 7468 6520  llback from the 
-0001bf20: 6669 7273 7420 6f75 7470 7574 0a20 2020  first output.   
-0001bf30: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001bf40: 6365 286f 7574 5f70 7269 6d61 6c2c 2053  ce(out_primal, S
-0001bf50: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001bf60: 2020 2020 2020 7265 7475 726e 2028 564a        return (VJ
-0001bf70: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-0001bf80: 5b30 5d2c 206f 7574 5f72 6573 6964 7561  [0], out_residua
-0001bf90: 6c73 292c 202a 2856 4a50 4475 616c 286f  ls), *(VJPDual(o
-0001bfa0: 2c20 7475 706c 6528 2929 2066 6f72 206f  , tuple()) for o
-0001bfb0: 2069 6e20 6f75 745f 7072 696d 616c 5b31   in out_primal[1
-0001bfc0: 3a5d 2929 0a0a 2020 2020 2020 2020 7265  :]))..        re
-0001bfd0: 7475 726e 2028 564a 5044 7561 6c28 6f75  turn (VJPDual(ou
-0001bfe0: 745f 7072 696d 616c 2c20 6f75 745f 7265  t_primal, out_re
-0001bff0: 7369 6475 616c 7329 2c29 0a0a 2020 2020  siduals),)..    
-0001c000: 7265 7475 726e 205f 766a 705f 696d 706c  return _vjp_impl
-0001c010: 0a0a 0a64 6566 2063 6865 636b 5f62 7379  ...def check_bsy
-0001c020: 6d5f 666f 725f 766a 7028 6273 796d 293a  m_for_vjp(bsym):
-0001c030: 0a20 2020 2022 2222 0a20 2020 2043 6865  .    """.    Che
-0001c040: 636b 2069 6620 6120 626f 756e 6420 7379  ck if a bound sy
-0001c050: 6d62 6f6c 2069 7320 7375 7070 6f72 7465  mbol is supporte
-0001c060: 6420 6279 2076 6a70 2e0a 0a20 2020 2041  d by vjp...    A
-0001c070: 7267 733a 0a20 2020 2020 2020 2062 7379  rgs:.        bsy
-0001c080: 6d20 2842 6f75 6e64 5379 6d62 6f6c 293a  m (BoundSymbol):
-0001c090: 2054 6865 2062 6f75 6e64 2073 796d 626f   The bound symbo
-0001c0a0: 6c20 746f 2063 6865 636b 2e0a 0a20 2020  l to check...   
-0001c0b0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001c0c0: 2020 626f 6f6c 3a20 5472 7565 2069 6620    bool: True if 
-0001c0d0: 7468 6520 626f 756e 6420 7379 6d62 6f6c  the bound symbol
-0001c0e0: 2069 7320 7375 7070 6f72 7465 6420 6279   is supported by
-0001c0f0: 2076 6a70 2c20 4661 6c73 6520 6f74 6865   vjp, False othe
-0001c100: 7277 6973 652e 0a20 2020 2022 2222 0a0a  rwise..    """..
-0001c110: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
-0001c120: 6964 2069 6e20 7472 616e 7366 6f72 6d5f  id in transform_
-0001c130: 736b 6970 5f6c 6973 743a 0a20 2020 2020  skip_list:.     
-0001c140: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0001c150: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
-0001c160: 6964 2069 6e20 6261 636b 7761 7264 5f69  id in backward_i
-0001c170: 6d70 6c73 2061 6e64 2062 7379 6d2e 7379  mpls and bsym.sy
-0001c180: 6d2e 6964 2069 6e20 6175 676d 656e 7465  m.id in augmente
-0001c190: 645f 666f 7277 6172 645f 696d 706c 733a  d_forward_impls:
-0001c1a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001c1b0: 5472 7565 0a0a 2020 2020 6966 2062 7379  True..    if bsy
-0001c1c0: 6d2e 7379 6d2e 6964 2069 6e20 5f67 7261  m.sym.id in _gra
-0001c1d0: 645f 666e 5f6d 6170 3a0a 2020 2020 2020  d_fn_map:.      
-0001c1e0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-0001c1f0: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
-0001c200: 7420 6669 6e64 2061 2056 4a50 2066 6f72  t find a VJP for
-0001c210: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
-0001c220: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
-0001c230: 706f 7365 2069 740a 2020 2020 2320 696e  pose it.    # in
-0001c240: 746f 2073 7562 2d73 796d 626f 6c73 2061  to sub-symbols a
-0001c250: 6e64 2063 6865 636b 2069 6620 7468 6579  nd check if they
-0001c260: 2061 7265 2073 7570 706f 7274 6564 0a20   are supported. 
-0001c270: 2020 2069 6620 6c65 6e28 6273 796d 2e73     if len(bsym.s
-0001c280: 7562 7379 6d62 6f6c 7329 203e 2030 2061  ubsymbols) > 0 a
-0001c290: 6e64 206e 6f74 2062 7379 6d2e 7379 6d2e  nd not bsym.sym.
-0001c2a0: 6973 5f70 7269 6d3a 0a20 2020 2020 2020  is_prim:.       
-0001c2b0: 2073 7562 7472 6163 6520 3d20 636f 6e73   subtrace = cons
-0001c2c0: 7472 7563 745f 7472 6163 6528 2928 6273  truct_trace()(bs
-0001c2d0: 796d 2e73 796d 2c20 2a62 7379 6d2e 6172  ym.sym, *bsym.ar
-0001c2e0: 6773 2c20 2a2a 6273 796d 2e6b 7761 7267  gs, **bsym.kwarg
-0001c2f0: 7329 0a20 2020 2020 2020 2073 7562 7472  s).        subtr
-0001c300: 6163 6520 3d20 756e 7772 6170 5f6f 6e65  ace = unwrap_one
-0001c310: 5f6c 6576 656c 5f6f 665f 7375 6273 796d  _level_of_subsym
-0001c320: 626f 6c73 2873 7562 7472 6163 6529 0a20  bols(subtrace). 
-0001c330: 2020 2020 2020 2061 6c6c 5f73 7570 706f         all_suppo
-0001c340: 7274 6564 203d 2061 6c6c 2863 6865 636b  rted = all(check
-0001c350: 5f62 7379 6d5f 666f 725f 766a 7028 7375  _bsym_for_vjp(su
-0001c360: 6262 7379 6d29 2066 6f72 2073 7562 6273  bbsym) for subbs
-0001c370: 796d 2069 6e20 7375 6274 7261 6365 2e62  ym in subtrace.b
-0001c380: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
-0001c390: 2020 2020 2020 7265 7475 726e 2061 6c6c        return all
-0001c3a0: 5f73 7570 706f 7274 6564 0a0a 2020 2020  _supported..    
-0001c3b0: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
-0001c3c0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
-0001c3d0: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
-0001c3e0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-0001c3f0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-0001c400: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
-0001c410: 7264 2070 6173 7320 666f 7220 7468 6520  rd pass for the 
-0001c420: 564a 5020 7472 616e 7366 6f72 6d2e 0a0a  VJP transform...
-0001c430: 2020 2020 5468 6520 6175 676d 656e 7465      The augmente
-0001c440: 6420 666f 7277 6172 6420 7061 7373 2069  d forward pass i
-0001c450: 7320 6120 666f 7277 6172 6420 7061 7373  s a forward pass
-0001c460: 2074 6861 7420 7265 7475 726e 7320 7468   that returns th
-0001c470: 6520 7265 7369 6475 616c 730a 2020 2020  e residuals.    
-0001c480: 6f66 2074 6865 2066 6f72 7761 7264 2070  of the forward p
-0001c490: 6173 732e 0a20 2020 2054 6865 7365 2072  ass..    These r
-0001c4a0: 6573 6964 7561 6c73 2061 7265 2075 7365  esiduals are use
-0001c4b0: 6420 696e 2074 6865 2062 6163 6b77 6172  d in the backwar
-0001c4c0: 6420 7061 7373 2074 6f20 636f 6d70 7574  d pass to comput
-0001c4d0: 6520 7468 6520 564a 5020 616e 6420 7468  e the VJP and th
-0001c4e0: 6579 0a20 2020 2061 7265 2072 6563 6f72  ey.    are recor
-0001c4f0: 6465 6420 696e 2074 6865 2065 6e76 6972  ded in the envir
-0001c500: 6f6e 6d65 6e74 2064 6963 7469 6f6e 6172  onment dictionar
-0001c510: 7920 666f 7220 6561 6368 2076 6172 6961  y for each varia
-0001c520: 626c 652e 0a0a 2020 2020 4172 6773 3a0a  ble...    Args:.
-0001c530: 2020 2020 2020 2020 6172 6773 2028 5475          args (Tu
-0001c540: 706c 655b 5661 7269 6162 6c65 5d29 3a20  ple[Variable]): 
-0001c550: 4172 6775 6d65 6e74 7320 746f 2074 6865  Arguments to the
-0001c560: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
-0001c570: 2020 2074 7261 6365 2028 5472 6163 6529     trace (Trace)
-0001c580: 3a20 5472 6163 6520 6f66 2074 6865 2066  : Trace of the f
-0001c590: 756e 6374 696f 6e2e 0a20 2020 2020 2020  unction..       
-0001c5a0: 206b 7761 7267 7320 2844 6963 745b 7374   kwargs (Dict[st
-0001c5b0: 722c 2056 6172 6961 626c 655d 293a 204b  r, Variable]): K
-0001c5c0: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-0001c5d0: 2074 6f20 7468 6520 6675 6e63 7469 6f6e   to the function
-0001c5e0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001c5f0: 2020 2020 2020 2020 5475 706c 655b 416e          Tuple[An
-0001c600: 792c 2044 6963 745b 7374 722c 2041 6e79  y, Dict[str, Any
-0001c610: 5d5d 3a20 5475 706c 6520 6f66 2074 6865  ]]: Tuple of the
-0001c620: 2070 7269 6d61 6c20 6f75 7470 7574 7320   primal outputs 
-0001c630: 616e 6420 7468 6520 656e 7669 726f 6e6d  and the environm
-0001c640: 656e 742e 0a20 2020 2022 2222 0a20 2020  ent..    """.   
-0001c650: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
-0001c660: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-0001c670: 783a 2056 4a50 4475 616c 2878 2c20 7475  x: VJPDual(x, tu
-0001c680: 706c 6528 2929 2c20 2861 7267 732c 206b  ple()), (args, k
-0001c690: 7761 7267 7329 290a 2020 2020 7265 7375  wargs)).    resu
-0001c6a0: 6c74 2c20 656e 7620 3d20 6576 616c 5f74  lt, env = eval_t
-0001c6b0: 7261 6365 280a 2020 2020 2020 2020 7472  race(.        tr
-0001c6c0: 6163 652c 0a20 2020 2020 2020 202a 6172  ace,.        *ar
-0001c6d0: 6773 2c0a 2020 2020 2020 2020 2a2a 6b77  gs,.        **kw
-0001c6e0: 6172 6773 2c0a 2020 2020 2020 2020 7769  args,.        wi
-0001c6f0: 7468 5f65 6e76 3d54 7275 652c 0a20 2020  th_env=True,.   
-0001c700: 2020 2020 2073 796d 626f 6c5f 6d61 7070       symbol_mapp
-0001c710: 6572 3d76 6a70 5f73 796d 626f 6c5f 6d61  er=vjp_symbol_ma
-0001c720: 7070 6572 2c0a 2020 2020 290a 2020 2020  pper,.    ).    
-0001c730: 7265 7375 6c74 203d 2074 7265 655f 6d61  result = tree_ma
-0001c740: 7028 6c61 6d62 6461 2078 3a20 782e 7072  p(lambda x: x.pr
-0001c750: 696d 616c 2069 6620 6973 696e 7374 616e  imal if isinstan
-0001c760: 6365 2878 2c20 564a 5044 7561 6c29 2065  ce(x, VJPDual) e
-0001c770: 6c73 6520 782c 2072 6573 756c 7429 0a20  lse x, result). 
-0001c780: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0001c790: 2c20 656e 760a 0a0a 2320 544f 444f 3a20  , env...# TODO: 
-0001c7a0: 496e 7374 6561 6420 6f66 2075 7369 6e67  Instead of using
-0001c7b0: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
-0001c7c0: 2064 6963 7469 6f6e 6172 792c 2077 6520   dictionary, we 
-0001c7d0: 636f 756c 6420 7573 6520 7468 6520 7472  could use the tr
-0001c7e0: 6163 650a 2320 7379 6d62 6f6c 7320 6f72  ace.# symbols or
-0001c7f0: 6465 7220 2874 6861 7420 7368 6f75 6c64  der (that should
-0001c800: 2062 6520 6465 7465 726d 696e 6973 7469   be deterministi
-0001c810: 6329 2074 6f20 7265 7472 6965 7665 2074  c) to retrieve t
-0001c820: 6865 2072 6573 6964 7561 6c73 206e 6565  he residuals nee
-0001c830: 6465 640a 2320 666f 7220 7468 6520 6261  ded.# for the ba
-0001c840: 636b 7761 7264 2070 6173 732e 0a64 6566  ckward pass..def
-0001c850: 2062 6163 6b77 6172 645f 7061 7373 2866   backward_pass(f
-0001c860: 6f72 7761 7264 5f65 6e76 2c20 7472 6163  orward_env, trac
-0001c870: 652c 2069 6e69 745f 636f 7461 6e67 656e  e, init_cotangen
-0001c880: 7473 293a 0a20 2020 2022 2222 4261 636b  ts):.    """Back
-0001c890: 7761 7264 2070 6173 7320 666f 7220 7468  ward pass for th
-0001c8a0: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
-0001c8b0: 0a0a 2020 2020 5468 6520 6261 636b 7761  ..    The backwa
-0001c8c0: 7264 2070 6173 7320 6973 2061 2072 6576  rd pass is a rev
-0001c8d0: 6572 7365 206d 6f64 6520 6175 746f 6d61  erse mode automa
-0001c8e0: 7469 6320 6469 6666 6572 656e 7469 6174  tic differentiat
-0001c8f0: 696f 6e20 7061 7373 2074 6861 740a 2020  ion pass that.  
-0001c900: 2020 636f 6d70 7574 6573 2074 6865 2076    computes the v
-0001c910: 6563 746f 722d 4a61 636f 6269 616e 2070  ector-Jacobian p
-0001c920: 726f 6475 6374 2028 564a 5029 206f 6620  roduct (VJP) of 
-0001c930: 7468 6520 6675 6e63 7469 6f6e 2e0a 0a20  the function... 
-0001c940: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001c950: 2066 6f72 7761 7264 5f65 6e76 2028 4469   forward_env (Di
-0001c960: 6374 5b73 7472 2c20 416e 795d 293a 2045  ct[str, Any]): E
-0001c970: 6e76 6972 6f6e 6d65 6e74 206f 6620 7468  nvironment of th
-0001c980: 6520 666f 7277 6172 6420 7061 7373 2e0a  e forward pass..
-0001c990: 2020 2020 2020 2020 7472 6163 6520 2854          trace (T
-0001c9a0: 7261 6365 293a 2054 7261 6365 206f 6620  race): Trace of 
-0001c9b0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
-0001c9c0: 2020 2020 2020 696e 6974 5f63 6f74 616e        init_cotan
-0001c9d0: 6765 6e74 7320 2854 7570 6c65 5b56 6172  gents (Tuple[Var
-0001c9e0: 6961 626c 655d 293a 2049 6e69 7469 616c  iable]): Initial
-0001c9f0: 2063 6f74 616e 6765 6e74 732e 0a0a 2020   cotangents...  
-0001ca00: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0001ca10: 2020 2054 7570 6c65 5b50 726f 7879 2c20     Tuple[Proxy, 
-0001ca20: 2e2e 2e5d 3a20 5475 706c 6520 6f66 2074  ...]: Tuple of t
-0001ca30: 6865 2072 6573 756c 7473 206f 6620 7468  he results of th
-0001ca40: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
-0001ca50: 666f 7220 6561 6368 2069 6e70 7574 2e0a  for each input..
-0001ca60: 2020 2020 2222 220a 2020 2020 656e 7620      """.    env 
-0001ca70: 3d20 7b7d 0a0a 2020 2020 6465 6620 6765  = {}..    def ge
-0001ca80: 745f 6772 6164 2878 3a20 5661 7269 6162  t_grad(x: Variab
-0001ca90: 6c65 293a 0a20 2020 2020 2020 2069 6620  le):.        if 
-0001caa0: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
-0001cab0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
-0001cac0: 2020 2020 2023 2052 6574 7572 6e20 4e6f       # Return No
-0001cad0: 6e65 2069 6620 7468 6520 7661 7269 6162  ne if the variab
-0001cae0: 6c65 2077 6173 206e 6f74 2075 7365 6420  le was not used 
-0001caf0: 696e 2074 6865 2063 6f6d 7075 7461 7469  in the computati
-0001cb00: 6f6e 2061 6e64 0a20 2020 2020 2020 2020  on and.         
-0001cb10: 2020 2023 2068 656e 6365 206e 6f74 2069     # hence not i
-0001cb20: 6e20 7468 6520 656e 760a 2020 2020 2020  n the env.      
-0001cb30: 2020 2020 2020 7265 7475 726e 2065 6e76        return env
-0001cb40: 2e67 6574 2878 2e6e 616d 652c 204e 6f6e  .get(x.name, Non
-0001cb50: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
-0001cb60: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001cb70: 7572 6e20 780a 0a20 2020 2064 6566 2070  urn x..    def p
-0001cb80: 7574 5f67 7261 6428 763a 2056 6172 6961  ut_grad(v: Varia
-0001cb90: 626c 652c 2076 616c 3a20 416e 7929 202d  ble, val: Any) -
-0001cba0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001cbb0: 6966 2069 7369 6e73 7461 6e63 6528 762c  if isinstance(v,
-0001cbc0: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
-0001cbd0: 2020 2020 2020 2020 6966 2076 2e6e 616d          if v.nam
-0001cbe0: 6520 696e 2065 6e76 3a0a 2020 2020 2020  e in env:.      
-0001cbf0: 2020 2020 2020 2020 2020 6966 2076 616c            if val
-0001cc00: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001cc10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001cc20: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-0001cc30: 2020 2020 2023 2041 6363 756d 756c 6174       # Accumulat
-0001cc40: 6520 636f 7461 6e67 656e 7473 0a20 2020  e cotangents.   
-0001cc50: 2020 2020 2020 2020 2020 2020 2065 6e76               env
-0001cc60: 5b76 2e6e 616d 655d 203d 2063 6c61 6e67  [v.name] = clang
-0001cc70: 2e61 6464 2865 6e76 5b76 2e6e 616d 655d  .add(env[v.name]
-0001cc80: 2c20 7661 6c29 2069 6620 656e 765b 762e  , val) if env[v.
-0001cc90: 6e61 6d65 5d20 6973 206e 6f74 204e 6f6e  name] is not Non
-0001cca0: 6520 656c 7365 2076 616c 0a20 2020 2020  e else val.     
-0001ccb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001ccc0: 6e0a 2020 2020 2020 2020 2020 2020 656e  n.            en
-0001ccd0: 765b 762e 6e61 6d65 5d20 3d20 7661 6c0a  v[v.name] = val.
-0001cce0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-0001ccf0: 6e73 7461 6e63 6528 762c 2053 6571 7565  nstance(v, Seque
-0001cd00: 6e63 6529 2061 6e64 2061 6c6c 2869 7369  nce) and all(isi
-0001cd10: 6e73 7461 6e63 6528 782c 2069 6e74 2920  nstance(x, int) 
-0001cd20: 666f 7220 7820 696e 2076 293a 0a20 2020  for x in v):.   
-0001cd30: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-0001cd40: 2072 656d 6f76 6520 7768 656e 2077 6520   remove when we 
-0001cd50: 6d6f 7665 2064 696d 7320 746f 206b 7761  move dims to kwa
-0001cd60: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
-0001cd70: 7061 7373 0a20 2020 2020 2020 2065 6c69  pass.        eli
-0001cd80: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-0001cd90: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
-0001cda0: 2020 656e 765b 765d 203d 2076 616c 0a20    env[v] = val. 
-0001cdb0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-0001cdc0: 7374 616e 6365 2876 2c20 5365 7175 656e  stance(v, Sequen
-0001cdd0: 6365 2920 616e 6420 7661 6c20 6973 204e  ce) and val is N
-0001cde0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001cdf0: 2023 2062 726f 6164 6361 7374 204e 6f6e   # broadcast Non
-0001ce00: 6520 746f 2074 6865 2072 6967 6874 2073  e to the right s
-0001ce10: 6861 7065 0a20 2020 2020 2020 2020 2020  hape.           
-0001ce20: 2073 6166 655f 6d61 7028 7075 745f 6772   safe_map(put_gr
-0001ce30: 6164 2c20 762c 205b 4e6f 6e65 5d20 2a20  ad, v, [None] * 
-0001ce40: 6c65 6e28 7629 290a 2020 2020 2020 2020  len(v)).        
-0001ce50: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0001ce60: 762c 2053 6571 7565 6e63 6529 2061 6e64  v, Sequence) and
-0001ce70: 2069 7369 6e73 7461 6e63 6528 7661 6c2c   isinstance(val,
-0001ce80: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-0001ce90: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
-0001cea0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
-0001ceb0: 762c 2076 616c 290a 2020 2020 2020 2020  v, val).        
-0001cec0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001ced0: 2020 2320 536b 6970 2077 7269 7469 6e67    # Skip writing
-0001cee0: 2074 6f20 636f 6e73 7461 6e74 730a 2020   to constants.  
-0001cef0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-0001cf00: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0001cf10: 6528 696e 6974 5f63 6f74 616e 6765 6e74  e(init_cotangent
-0001cf20: 732c 2053 6571 7565 6e63 6529 2061 6e64  s, Sequence) and
-0001cf30: 206c 656e 2869 6e69 745f 636f 7461 6e67   len(init_cotang
-0001cf40: 656e 7473 2920 3d3d 2031 2061 6e64 206e  ents) == 1 and n
-0001cf50: 6f74 2069 7369 6e73 7461 6e63 6528 7472  ot isinstance(tr
-0001cf60: 6163 652e 6f75 7470 7574 2c20 5365 7175  ace.output, Sequ
-0001cf70: 656e 6365 293a 0a20 2020 2020 2020 2069  ence):.        i
-0001cf80: 6e69 745f 636f 7461 6e67 656e 7473 203d  nit_cotangents =
-0001cf90: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
-0001cfa0: 5b30 5d0a 2020 2020 7361 6665 5f6d 6170  [0].    safe_map
-0001cfb0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
-0001cfc0: 7472 6163 652e 6f75 7470 7574 2c20 696e  trace.output, in
-0001cfd0: 6974 5f63 6f74 616e 6765 6e74 7329 0a0a  it_cotangents)..
-0001cfe0: 2020 2020 666f 7220 7379 6d62 6f6c 2069      for symbol i
-0001cff0: 6e20 7265 7665 7273 6564 286c 6973 7428  n reversed(list(
-0001d000: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
-0001d010: 6c73 2874 7261 6365 2e62 6f75 6e64 5f73  ls(trace.bound_s
-0001d020: 796d 626f 6c73 2929 293a 0a20 2020 2020  ymbols))):.     
-0001d030: 2020 2073 796d 626f 6c5f 6f75 7470 7574     symbol_output
-0001d040: 203d 2073 6571 7565 6e63 6966 7928 7379   = sequencify(sy
-0001d050: 6d62 6f6c 2e6f 7574 7075 7429 0a0a 2020  mbol.output)..  
-0001d060: 2020 2020 2020 636f 7461 6e67 656e 7473        cotangents
-0001d070: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
-0001d080: 6772 6164 2c20 7379 6d62 6f6c 5f6f 7574  grad, symbol_out
-0001d090: 7075 7429 0a20 2020 2020 2020 2023 2048  put).        # H
-0001d0a0: 6176 696e 6720 6120 7369 6e67 6c65 2063  aving a single c
-0001d0b0: 6f74 616e 6765 6e74 2069 7320 6120 636f  otangent is a co
-0001d0c0: 6d6d 6f6e 2063 6173 652c 2073 6f20 7765  mmon case, so we
-0001d0d0: 2066 6c61 7474 656e 2069 740a 2020 2020   flatten it.    
-0001d0e0: 2020 2020 2320 4f74 6865 7277 6973 652c      # Otherwise,
-0001d0f0: 2077 6520 7769 6c6c 206e 6565 6420 746f   we will need to
-0001d100: 2072 6577 7269 7465 2074 6865 2070 756c   rewrite the pul
-0001d110: 6c62 6163 6b20 6675 6e63 7469 6f6e 730a  lback functions.
-0001d120: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
-0001d130: 7473 203d 2074 7265 655f 666c 6174 7465  ts = tree_flatte
-0001d140: 6e28 636f 7461 6e67 656e 7473 295b 305d  n(cotangents)[0]
-0001d150: 0a20 2020 2020 2020 2072 6573 6964 7561  .        residua
-0001d160: 6c73 203d 2066 6f72 7761 7264 5f65 6e76  ls = forward_env
-0001d170: 5b73 796d 626f 6c5f 6f75 7470 7574 5b30  [symbol_output[0
-0001d180: 5d2e 6e61 6d65 5d2e 7265 7369 6475 616c  ].name].residual
-0001d190: 730a 2020 2020 2020 2020 6966 2069 735f  s.        if is_
-0001d1a0: 636f 6e73 7461 6e74 5f66 6f72 5f76 6a70  constant_for_vjp
-0001d1b0: 2873 796d 626f 6c29 3a0a 2020 2020 2020  (symbol):.      
-0001d1c0: 2020 2020 2020 2320 5765 2063 616e 2073        # We can s
-0001d1d0: 6b69 7020 7468 6520 7075 6c6c 6261 636b  kip the pullback
-0001d1e0: 2069 6620 616c 6c20 7468 6520 6172 6775   if all the argu
-0001d1f0: 6d65 6e74 7320 6172 6520 636f 6e73 7461  ments are consta
-0001d200: 6e74 0a20 2020 2020 2020 2020 2020 2063  nt.            c
-0001d210: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-0001d220: 2069 6620 616c 6c28 636f 7461 6e67 656e   if all(cotangen
-0001d230: 7420 6973 204e 6f6e 6520 666f 7220 636f  t is None for co
-0001d240: 7461 6e67 656e 7420 696e 2063 6f74 616e  tangent in cotan
-0001d250: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
-0001d260: 2020 2020 2320 5765 2063 616e 2073 6b69      # We can ski
-0001d270: 7020 7468 6520 7075 6c6c 6261 636b 2069  p the pullback i
-0001d280: 6620 7468 6520 636f 7461 6e67 656e 7420  f the cotangent 
-0001d290: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
-0001d2a0: 2020 2020 7361 6665 5f6d 6170 2870 7574      safe_map(put
-0001d2b0: 5f67 7261 642c 2073 796d 626f 6c2e 6172  _grad, symbol.ar
-0001d2c0: 6773 2c20 284e 6f6e 652c 2920 2a20 6c65  gs, (None,) * le
-0001d2d0: 6e28 7379 6d62 6f6c 2e61 7267 7329 290a  n(symbol.args)).
-0001d2e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001d2f0: 696e 7565 0a0a 2020 2020 2020 2020 6966  inue..        if
-0001d300: 2073 796d 626f 6c2e 7379 6d2e 6964 203d   symbol.sym.id =
-0001d310: 3d20 2274 6f72 6368 2e6e 6e2e 6675 6e63  = "torch.nn.func
-0001d320: 7469 6f6e 616c 2e64 726f 706f 7574 2220  tional.dropout" 
-0001d330: 616e 6420 6e6f 7420 7379 6d62 6f6c 2e73  and not symbol.s
-0001d340: 7562 7379 6d62 6f6c 733a 0a20 2020 2020  ubsymbols:.     
-0001d350: 2020 2020 2020 2023 2057 6520 6361 6e20         # We can 
-0001d360: 736b 6970 2074 6865 2070 756c 6c62 6163  skip the pullbac
-0001d370: 6b20 6966 2074 6865 2064 726f 706f 7574  k if the dropout
-0001d380: 2070 726f 6261 6269 6c69 7479 2069 7320   probability is 
-0001d390: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
-0001d3a0: 2320 4173 7375 6d69 6e67 2074 6861 7420  # Assuming that 
-0001d3b0: 7468 6520 6472 6f70 6f75 7420 7379 6d62  the dropout symb
-0001d3c0: 6f6c 2068 6173 2074 6865 2073 616d 6520  ol has the same 
-0001d3d0: 6f75 7470 7574 2061 6e64 2061 7267 756d  output and argum
-0001d3e0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-0001d3f0: 6173 7365 7274 2073 796d 626f 6c2e 6f75  assert symbol.ou
-0001d400: 7470 7574 2e6e 616d 6520 3d3d 2073 796d  tput.name == sym
-0001d410: 626f 6c2e 6172 6773 5b30 5d2e 6e61 6d65  bol.args[0].name
-0001d420: 2c20 2244 726f 706f 7574 2073 796d 626f  , "Dropout symbo
-0001d430: 6c20 6861 7320 6120 6469 6666 6572 656e  l has a differen
-0001d440: 7420 6f75 7470 7574 2061 6e64 2061 7267  t output and arg
-0001d450: 756d 656e 7422 0a20 2020 2020 2020 2020  ument".         
-0001d460: 2020 2069 6620 7379 6d62 6f6c 2e61 7267     if symbol.arg
-0001d470: 735b 315d 203d 3d20 302e 3020 6f72 2073  s[1] == 0.0 or s
-0001d480: 796d 626f 6c2e 6172 6773 5b32 5d20 6973  ymbol.args[2] is
-0001d490: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
-0001d4a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0001d4b0: 0a0a 2020 2020 2020 2020 6261 636b 7761  ..        backwa
-0001d4c0: 7264 203d 2062 6163 6b77 6172 645f 696d  rd = backward_im
-0001d4d0: 706c 732e 6765 7428 7379 6d62 6f6c 2e73  pls.get(symbol.s
-0001d4e0: 796d 2e69 6429 0a20 2020 2020 2020 2061  ym.id).        a
-0001d4f0: 7567 5f66 6f72 7761 7264 203d 2061 7567  ug_forward = aug
-0001d500: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-0001d510: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
-0001d520: 7379 6d2e 6964 290a 0a20 2020 2020 2020  sym.id)..       
-0001d530: 2069 6620 5f67 6574 5f67 7261 6466 6e5f   if _get_gradfn_
-0001d540: 616e 645f 6578 6563 7574 6f72 2873 796d  and_executor(sym
-0001d550: 626f 6c29 5b30 5d20 6973 206e 6f74 204e  bol)[0] is not N
-0001d560: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001d570: 2061 7567 5f66 6f72 7761 7264 2c20 6261   aug_forward, ba
-0001d580: 636b 7761 7264 203d 206d 616b 655f 6175  ckward = make_au
-0001d590: 675f 666f 7277 6172 645f 616e 645f 6261  g_forward_and_ba
-0001d5a0: 636b 7761 7264 2873 796d 626f 6c29 0a0a  ckward(symbol)..
-0001d5b0: 2020 2020 2020 2020 6966 2062 6163 6b77          if backw
-0001d5c0: 6172 6420 6973 204e 6f6e 653a 0a20 2020  ard is None:.   
-0001d5d0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0001d5e0: 7379 6d62 6f6c 2e73 7562 7379 6d62 6f6c  symbol.subsymbol
-0001d5f0: 7329 203e 2030 2061 6e64 206e 6f74 2069  s) > 0 and not i
-0001d600: 7369 6e73 7461 6e63 6528 7379 6d62 6f6c  sinstance(symbol
-0001d610: 2e73 796d 2e69 642c 2070 7269 6d73 2e50  .sym.id, prims.P
-0001d620: 7269 6d49 4473 293a 0a20 2020 2020 2020  rimIDs):.       
-0001d630: 2020 2020 2020 2020 2023 2057 6520 636f           # We co
-0001d640: 756c 6420 6e6f 7420 6669 6e64 2061 2062  uld not find a b
-0001d650: 6163 6b77 6172 6420 666f 7220 7468 6973  ackward for this
-0001d660: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
-0001d670: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
-0001d680: 6974 0a20 2020 2020 2020 2020 2020 2020  it.             
-0001d690: 2020 2062 6163 6b77 6172 6420 3d20 7061     backward = pa
-0001d6a0: 7274 6961 6c28 6465 636f 6d70 6f73 6564  rtial(decomposed
-0001d6b0: 5f66 6e5f 6261 636b 7761 7264 5f72 756c  _fn_backward_rul
-0001d6c0: 652c 2073 796d 626f 6c2e 7379 6d29 0a20  e, symbol.sym). 
-0001d6d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001d6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d6f0: 2023 2057 6520 636f 756c 6420 6e6f 7420   # We could not 
-0001d700: 6669 6e64 2061 2062 6163 6b77 6172 6420  find a backward 
-0001d710: 666f 7220 7468 6973 2073 796d 626f 6c20  for this symbol 
-0001d720: 616e 6420 7765 2063 6f75 6c64 206e 6f74  and we could not
-0001d730: 2064 6563 6f6d 706f 7365 2069 740a 2020   decompose it.  
-0001d740: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0001d750: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-0001d760: 6564 4572 726f 7228 6622 4261 636b 7761  edError(f"Backwa
-0001d770: 7264 2066 6f72 207b 7379 6d62 6f6c 2e73  rd for {symbol.s
-0001d780: 796d 2e69 647d 2069 7320 6e6f 7420 696d  ym.id} is not im
-0001d790: 706c 656d 656e 7465 6422 290a 0a20 2020  plemented")..   
-0001d7a0: 2020 2020 2072 6573 756c 7420 3d20 6261       result = ba
-0001d7b0: 636b 7761 7264 282a 7265 7369 6475 616c  ckward(*residual
-0001d7c0: 732c 202a 636f 7461 6e67 656e 7473 290a  s, *cotangents).
-0001d7d0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001d7e0: 7461 6e63 6528 7265 7375 6c74 2c20 6469  tance(result, di
-0001d7f0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-0001d800: 2023 2049 6620 7468 6520 6261 636b 7761   # If the backwa
-0001d810: 7264 2072 6574 7572 6e73 2061 2064 6963  rd returns a dic
-0001d820: 742c 2077 6520 6173 7375 6d65 2074 6861  t, we assume tha
-0001d830: 7420 6974 2069 7320 6120 6469 6374 206f  t it is a dict o
-0001d840: 660a 2020 2020 2020 2020 2020 2020 2320  f.            # 
-0001d850: 666f 7277 6172 6420 6172 6775 6d65 6e74  forward argument
-0001d860: 7320 746f 2074 6865 2063 6f72 7265 7370  s to the corresp
-0001d870: 6f6e 6469 6e67 0a20 2020 2020 2020 2020  onding.         
-0001d880: 2020 2023 2067 7261 6469 656e 7473 2f63     # gradients/c
-0001d890: 6f74 616e 6765 6e74 732f 6164 6a6f 696e  otangents/adjoin
-0001d8a0: 7473 2f73 656e 7369 7469 7669 7469 6573  ts/sensitivities
-0001d8b0: 2e0a 2020 2020 2020 2020 2020 2020 7573  ..            us
-0001d8c0: 6564 5f6e 616d 6573 203d 2073 6574 2829  ed_names = set()
-0001d8d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001d8e0: 2069 2c20 286b 2c20 7629 2069 6e20 656e   i, (k, v) in en
-0001d8f0: 756d 6572 6174 6528 696e 7370 6563 742e  umerate(inspect.
-0001d900: 7369 676e 6174 7572 6528 6175 675f 666f  signature(aug_fo
-0001d910: 7277 6172 6429 2e70 6172 616d 6574 6572  rward).parameter
-0001d920: 732e 6974 656d 7328 2929 3a0a 2020 2020  s.items()):.    
-0001d930: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0001d940: 2e6b 696e 6420 696e 2028 696e 7370 6563  .kind in (inspec
-0001d950: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
-0001d960: 5449 4f4e 414c 5f4f 4e4c 592c 2069 6e73  TIONAL_ONLY, ins
-0001d970: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
-0001d980: 4f53 4954 494f 4e41 4c5f 4f52 5f4b 4559  OSITIONAL_OR_KEY
-0001d990: 574f 5244 293a 0a20 2020 2020 2020 2020  WORD):.         
-0001d9a0: 2020 2020 2020 2020 2020 2070 7574 5f67             put_g
-0001d9b0: 7261 6428 7379 6d62 6f6c 2e61 7267 735b  rad(symbol.args[
-0001d9c0: 695d 2c20 7265 7375 6c74 2e67 6574 286b  i], result.get(k
-0001d9d0: 2c20 4e6f 6e65 2929 0a20 2020 2020 2020  , None)).       
-0001d9e0: 2020 2020 2020 2020 2020 2020 2075 7365               use
-0001d9f0: 645f 6e61 6d65 732e 6164 6428 6b29 0a0a  d_names.add(k)..
-0001da00: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
-0001da10: 7220 6465 7665 6c6f 7065 7220 636f 6e76  r developer conv
-0001da20: 656e 6965 6e63 652c 2077 6520 616c 6c6f  enience, we allo
-0001da30: 7720 7573 696e 6720 7468 6520 6e61 6d65  w using the name
-0001da40: 2066 726f 6d20 7468 650a 2020 2020 2020   from the.      
-0001da50: 2020 2020 2020 2320 666f 7277 6172 6420        # forward 
-0001da60: 6d65 7461 2069 6e20 6164 6469 7469 6f6e  meta in addition
-0001da70: 2074 6f20 7468 6520 6e61 6d65 2066 726f   to the name fro
-0001da80: 6d20 7468 6520 6175 676d 656e 7465 6420  m the augmented 
-0001da90: 666f 7277 6172 640a 2020 2020 2020 2020  forward.        
-0001daa0: 2020 2020 2320 7369 676e 6174 7572 652e      # signature.
-0001dab0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-0001dac0: 6620 626f 7468 206e 616d 6573 2061 7265  f both names are
-0001dad0: 2075 7365 642c 2074 6865 206f 6e65 2066   used, the one f
-0001dae0: 726f 6d20 7468 6520 666f 7277 6172 6420  rom the forward 
-0001daf0: 6d65 7461 2074 616b 6573 0a20 2020 2020  meta takes.     
-0001db00: 2020 2020 2020 2023 2070 7265 6365 6465         # precede
-0001db10: 6e63 652e 0a20 2020 2020 2020 2020 2020  nce..           
-0001db20: 2066 6f72 2069 2c20 286b 2c20 7629 2069   for i, (k, v) i
-0001db30: 6e20 656e 756d 6572 6174 6528 696e 7370  n enumerate(insp
-0001db40: 6563 742e 7369 676e 6174 7572 6528 7379  ect.signature(sy
-0001db50: 6d62 6f6c 2e73 796d 2e6d 6574 6129 2e70  mbol.sym.meta).p
-0001db60: 6172 616d 6574 6572 732e 6974 656d 7328  arameters.items(
-0001db70: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0001db80: 2020 2020 6966 2076 2e6b 696e 6420 696e      if v.kind in
-0001db90: 2028 696e 7370 6563 742e 5061 7261 6d65   (inspect.Parame
-0001dba0: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
-0001dbb0: 4e4c 592c 2069 6e73 7065 6374 2e50 6172  NLY, inspect.Par
-0001dbc0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
-0001dbd0: 4c5f 4f52 5f4b 4559 574f 5244 293a 0a20  L_OR_KEYWORD):. 
-0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dbf0: 2020 2069 6620 6b20 6e6f 7420 696e 2075     if k not in u
-0001dc00: 7365 645f 6e61 6d65 733a 0a20 2020 2020  sed_names:.     
-0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc20: 2020 2070 7574 5f67 7261 6428 7379 6d62     put_grad(symb
-0001dc30: 6f6c 2e61 7267 735b 695d 2c20 7265 7375  ol.args[i], resu
-0001dc40: 6c74 2e67 6574 286b 2c20 4e6f 6e65 2929  lt.get(k, None))
-0001dc50: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0001dc60: 7469 6e75 650a 0a20 2020 2020 2020 2069  tinue..        i
-0001dc70: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0001dc80: 2872 6573 756c 742c 2053 6571 7565 6e63  (result, Sequenc
-0001dc90: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001dca0: 7265 7375 6c74 203d 2028 7265 7375 6c74  result = (result
-0001dcb0: 2c29 0a0a 2020 2020 2020 2020 6465 6620  ,)..        def 
-0001dcc0: 6973 5f64 6966 6665 7265 6e74 6961 626c  is_differentiabl
-0001dcd0: 6528 6172 6729 3a0a 2020 2020 2020 2020  e(arg):.        
-0001dce0: 2020 2020 6d61 7463 6820 6172 673a 0a20      match arg:. 
-0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001dd00: 6173 6520 5465 6e73 6f72 5072 6f78 7928  ase TensorProxy(
-0001dd10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001dd20: 2020 2020 2020 2072 6574 7572 6e20 6474         return dt
-0001dd30: 7970 6573 2e69 735f 696e 6578 6163 745f  ypes.is_inexact_
-0001dd40: 6474 7970 6528 6172 672e 6474 7970 6529  dtype(arg.dtype)
-0001dd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dd60: 2063 6173 6520 5365 7175 656e 6365 2829   case Sequence()
-0001dd70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001dd80: 2020 2020 2020 7265 7475 726e 2061 7267        return arg
-0001dd90: 2061 6e64 2061 6c6c 2869 7369 6e73 7461   and all(isinsta
-0001dda0: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
-0001ddb0: 7879 2920 616e 6420 6474 7970 6573 2e69  xy) and dtypes.i
-0001ddc0: 735f 696e 6578 6163 745f 6474 7970 6528  s_inexact_dtype(
-0001ddd0: 782e 6474 7970 6529 2066 6f72 2078 2069  x.dtype) for x i
-0001dde0: 6e20 6172 6729 0a20 2020 2020 2020 2020  n arg).         
-0001ddf0: 2020 2020 2020 2063 6173 6520 5f3a 0a20         case _:. 
-0001de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de10: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0001de20: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0001de30: 7379 6d62 6f6c 2e61 7267 7329 2021 3d20  symbol.args) != 
-0001de40: 286f 7269 675f 7265 735f 6c65 6e20 3a3d  (orig_res_len :=
-0001de50: 206c 656e 2872 6573 756c 7429 293a 0a20   len(result)):. 
-0001de60: 2020 2020 2020 2020 2020 2063 6865 636b             check
-0001de70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001de80: 2020 6f72 6967 5f72 6573 5f6c 656e 203c    orig_res_len <
-0001de90: 3d20 6c65 6e28 7379 6d62 6f6c 2e61 7267  = len(symbol.arg
-0001dea0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0001deb0: 2020 2020 6c61 6d62 6461 3a20 6622 4261      lambda: f"Ba
-0001dec0: 636b 7761 7264 2066 6f72 207b 7379 6d62  ckward for {symb
-0001ded0: 6f6c 2e73 796d 2e69 647d 2072 6574 7572  ol.sym.id} retur
-0001dee0: 6e65 6420 7b6f 7269 675f 7265 735f 6c65  ned {orig_res_le
-0001def0: 6e7d 2076 616c 7565 732c 2022 0a20 2020  n} values, ".   
-0001df00: 2020 2020 2020 2020 2020 2020 202b 2066               + f
-0001df10: 2262 7574 2065 7870 6563 7465 6420 6174  "but expected at
-0001df20: 206d 6f73 7420 7b6c 656e 2873 796d 626f   most {len(symbo
-0001df30: 6c2e 6172 6773 297d 222c 0a20 2020 2020  l.args)}",.     
-0001df40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001df50: 2020 2020 2023 2041 7373 756d 696e 6720       # Assuming 
-0001df60: 7468 6174 2074 6865 206e 6f6e 2d64 6966  that the non-dif
-0001df70: 6665 7265 6e74 6961 626c 6520 6172 6775  ferentiable argu
-0001df80: 6d65 6e74 7320 7765 7265 2064 726f 7070  ments were dropp
-0001df90: 6564 2066 726f 6d0a 2020 2020 2020 2020  ed from.        
-0001dfa0: 2020 2020 2320 7468 6520 6261 636b 7761      # the backwa
-0001dfb0: 7264 2066 756e 6374 696f 6e2c 2077 6520  rd function, we 
-0001dfc0: 6172 6520 676f 696e 6720 746f 2061 7070  are going to app
-0001dfd0: 656e 6420 4e6f 6e65 2074 6f20 7468 6520  end None to the 
-0001dfe0: 7265 7375 6c74 0a20 2020 2020 2020 2020  result.         
-0001dff0: 2020 2023 2074 6f20 6d61 7463 6820 7468     # to match th
-0001e000: 6520 6e75 6d62 6572 206f 6620 6172 6775  e number of argu
-0001e010: 6d65 6e74 732e 2041 6c74 6572 6e61 7469  ments. Alternati
-0001e020: 7665 6c79 2c20 7765 2063 6f75 6c64 206a  vely, we could j
-0001e030: 7573 740a 2020 2020 2020 2020 2020 2020  ust.            
-0001e040: 2320 6861 7665 2061 2066 6f72 2d6c 6f6f  # have a for-loo
-0001e050: 7020 7769 7468 2061 2063 6f6e 6469 7469  p with a conditi
-0001e060: 6f6e 616c 2077 6865 6e20 7772 6974 696e  onal when writin
-0001e070: 6720 746f 2074 6865 0a20 2020 2020 2020  g to the.       
-0001e080: 2020 2020 2023 2065 6e76 6972 6f6e 6d65       # environme
-0001e090: 6e74 2e0a 0a20 2020 2020 2020 2020 2020  nt...           
-0001e0a0: 2069 7465 725f 7265 7375 6c74 203d 2069   iter_result = i
-0001e0b0: 7465 7228 7265 7375 6c74 290a 2020 2020  ter(result).    
-0001e0c0: 2020 2020 2020 2020 6e5f 6469 6666 6572          n_differ
-0001e0d0: 656e 7469 6162 6c65 5f61 7267 7320 3d20  entiable_args = 
-0001e0e0: 7375 6d28 626f 6f6c 2869 735f 6469 6666  sum(bool(is_diff
-0001e0f0: 6572 656e 7469 6162 6c65 2861 7267 2929  erentiable(arg))
-0001e100: 2066 6f72 2061 7267 2069 6e20 7379 6d62   for arg in symb
-0001e110: 6f6c 2e61 7267 7329 0a20 2020 2020 2020  ol.args).       
-0001e120: 2020 2020 2063 6865 636b 280a 2020 2020       check(.    
-0001e130: 2020 2020 2020 2020 2020 2020 6e5f 6469              n_di
-0001e140: 6666 6572 656e 7469 6162 6c65 5f61 7267  fferentiable_arg
-0001e150: 7320 3c3d 206f 7269 675f 7265 735f 6c65  s <= orig_res_le
-0001e160: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0001e170: 2020 206c 616d 6264 613a 2066 2242 6163     lambda: f"Bac
-0001e180: 6b77 6172 6420 666f 7220 7b73 796d 626f  kward for {symbo
-0001e190: 6c2e 7379 6d2e 6964 7d20 7265 7475 726e  l.sym.id} return
-0001e1a0: 6564 207b 6f72 6967 5f72 6573 5f6c 656e  ed {orig_res_len
-0001e1b0: 7d20 7661 6c75 6528 7329 2c20 220a 2020  } value(s), ".  
-0001e1c0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-0001e1d0: 6622 6275 7420 6578 7065 6374 6564 207b  f"but expected {
-0001e1e0: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
-0001e1f0: 5f61 7267 737d 222c 0a20 2020 2020 2020  _args}",.       
-0001e200: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001e210: 2020 2020 7265 7375 6c74 203d 2074 7570      result = tup
-0001e220: 6c65 286e 6578 7428 6974 6572 5f72 6573  le(next(iter_res
-0001e230: 756c 7429 2069 6620 6973 5f64 6966 6665  ult) if is_diffe
-0001e240: 7265 6e74 6961 626c 6528 6172 6729 2065  rentiable(arg) e
-0001e250: 6c73 6520 4e6f 6e65 2066 6f72 2061 7267  lse None for arg
-0001e260: 2069 6e20 7379 6d62 6f6c 2e61 7267 7329   in symbol.args)
-0001e270: 0a0a 2020 2020 2020 2020 2320 5365 6520  ..        # See 
-0001e280: 2242 6163 6b77 6172 6420 696d 706c 2066  "Backward impl f
-0001e290: 6f72 206f 7073 206f 6620 7468 6520 7479  or ops of the ty
-0001e2a0: 7065 2053 6571 7565 6e63 655b 5465 6e73  pe Sequence[Tens
-0001e2b0: 6f72 5072 6f78 795d 2c20 2e2e 2e20 2d3e  orProxy], ... ->
-0001e2c0: 202e 2e2e 2072 6573 756c 7473 2069 6e20   ... results in 
-0001e2d0: 4e6f 6e65 2067 7261 6473 2e22 0a20 2020  None grads.".   
-0001e2e0: 2020 2020 2023 2054 6869 7320 6973 2061       # This is a
-0001e2f0: 2074 656d 706f 7261 7279 2077 6f72 6b61   temporary worka
-0001e300: 726f 756e 642e 0a20 2020 2020 2020 2069  round..        i
-0001e310: 6620 7379 6d62 6f6c 2e73 796d 2e69 6420  f symbol.sym.id 
-0001e320: 696e 2028 7072 696d 732e 5072 696d 4944  in (prims.PrimID
-0001e330: 732e 4341 542c 2022 746f 7263 682e 6361  s.CAT, "torch.ca
-0001e340: 7422 2c20 2274 6f72 6368 2e73 7461 636b  t", "torch.stack
-0001e350: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0001e360: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
-0001e370: 745f 6772 6164 2c20 7379 6d62 6f6c 2e61  t_grad, symbol.a
-0001e380: 7267 732c 2072 6573 756c 7429 0a20 2020  rgs, result).   
-0001e390: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001e3a0: 2020 2020 2020 2073 6166 655f 6d61 7028         safe_map(
-0001e3b0: 7075 745f 6772 6164 2c20 7379 6d62 6f6c  put_grad, symbol
-0001e3c0: 2e61 7267 732c 2072 6573 756c 7429 0a0a  .args, result)..
-0001e3d0: 2020 2020 6465 6620 6765 745f 696e 6578      def get_inex
-0001e3e0: 6163 745f 6474 7970 655f 6f72 5f6e 6f6e  act_dtype_or_non
-0001e3f0: 6528 7829 3a0a 2020 2020 2020 2020 6966  e(x):.        if
-0001e400: 2069 7369 6e73 7461 6e63 6528 782c 2028   isinstance(x, (
-0001e410: 5465 6e73 6f72 5072 6f78 792c 2046 7574  TensorProxy, Fut
-0001e420: 7572 6554 656e 736f 7250 726f 7879 2929  ureTensorProxy))
-0001e430: 2061 6e64 2064 7479 7065 732e 6973 5f69   and dtypes.is_i
-0001e440: 6e65 7861 6374 5f64 7479 7065 2878 2e64  nexact_dtype(x.d
-0001e450: 7479 7065 293a 0a20 2020 2020 2020 2020  type):.         
-0001e460: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
-0001e470: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001e480: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0001e490: 650a 0a20 2020 2067 6172 6773 203d 2074  e..    gargs = t
-0001e4a0: 7265 655f 6d61 7028 6765 745f 6772 6164  ree_map(get_grad
-0001e4b0: 2c20 7475 706c 6528 7472 6163 652e 6172  , tuple(trace.ar
-0001e4c0: 6773 2929 0a20 2020 2067 6b77 6172 6773  gs)).    gkwargs
-0001e4d0: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
-0001e4e0: 6772 6164 2c20 7472 6163 652e 6b77 6172  grad, trace.kwar
-0001e4f0: 6773 290a 2020 2020 676b 7761 7267 7320  gs).    gkwargs 
-0001e500: 3d20 7b6b 3a20 7620 666f 7220 6b2c 2076  = {k: v for k, v
-0001e510: 2069 6e20 676b 7761 7267 732e 6974 656d   in gkwargs.item
-0001e520: 7328 2920 6966 2076 2069 7320 6e6f 7420  s() if v is not 
-0001e530: 4e6f 6e65 7d0a 2020 2020 6761 7267 732c  None}.    gargs,
-0001e540: 2067 6b77 6172 6773 203d 2074 7265 655f   gkwargs = tree_
-0001e550: 6d61 7028 6765 745f 696e 6578 6163 745f  map(get_inexact_
-0001e560: 6474 7970 655f 6f72 5f6e 6f6e 652c 2028  dtype_or_none, (
-0001e570: 6761 7267 732c 2067 6b77 6172 6773 2929  gargs, gkwargs))
-0001e580: 0a20 2020 2072 6574 7572 6e20 6761 7267  .    return garg
-0001e590: 7320 2b20 2867 6b77 6172 6773 2c29 2069  s + (gkwargs,) i
-0001e5a0: 6620 6c65 6e28 676b 7761 7267 7329 2021  f len(gkwargs) !
-0001e5b0: 3d20 3020 656c 7365 2067 6172 6773 0a0a  = 0 else gargs..
-0001e5c0: 0a64 6566 2076 6a70 5f63 616c 6c5f 6d65  .def vjp_call_me
-0001e5d0: 7461 6675 6e63 2864 6574 6163 6865 643a  tafunc(detached:
-0001e5e0: 2062 6f6f 6c2c 2070 7269 6d61 6c73 2c20   bool, primals, 
-0001e5f0: 636f 7461 6e67 656e 7473 2c20 7472 6163  cotangents, trac
-0001e600: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
-0001e610: 6773 293a 0a20 2020 2023 2041 7373 756d  gs):.    # Assum
-0001e620: 696e 6720 7072 696d 616c 7320 6973 2066  ing primals is f
-0001e630: 6c61 740a 0a20 2020 2069 6620 6e6f 7420  lat..    if not 
-0001e640: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
-0001e650: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
-0001e660: 2020 2020 2020 2070 7269 6d61 6c73 203d         primals =
-0001e670: 2028 7072 696d 616c 732c 290a 0a20 2020   (primals,)..   
-0001e680: 2063 7478 203d 2064 6574 6163 6865 645f   ctx = detached_
-0001e690: 7472 6163 6528 2920 6966 2064 6574 6163  trace() if detac
-0001e6a0: 6865 6420 656c 7365 206e 756c 6c63 6f6e  hed else nullcon
-0001e6b0: 7465 7874 2829 0a20 2020 2077 6974 6820  text().    with 
-0001e6c0: 6374 783a 0a20 2020 2020 2020 2072 6573  ctx:.        res
-0001e6d0: 756c 742c 2065 6e76 203d 2061 7567 6d65  ult, env = augme
-0001e6e0: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
-0001e6f0: 7328 2a70 7269 6d61 6c73 2c20 7472 6163  s(*primals, trac
-0001e700: 653d 7472 6163 652c 202a 2a6b 7761 7267  e=trace, **kwarg
-0001e710: 7329 0a20 2020 2020 2020 2063 6865 636b  s).        check
-0001e720: 280a 2020 2020 2020 2020 2020 2020 6c65  (.            le
-0001e730: 6e28 7265 7375 6c74 2920 3d3d 206c 656e  n(result) == len
-0001e740: 2863 6f74 616e 6765 6e74 7329 2069 6620  (cotangents) if 
-0001e750: 6973 696e 7374 616e 6365 2872 6573 756c  isinstance(resul
-0001e760: 742c 2053 6571 7565 6e63 6529 2065 6c73  t, Sequence) els
-0001e770: 6520 5472 7565 2c0a 2020 2020 2020 2020  e True,.        
-0001e780: 2020 2020 6c61 6d62 6461 3a20 6622 4578      lambda: f"Ex
-0001e790: 7065 6374 6564 2063 6f74 616e 6765 6e74  pected cotangent
-0001e7a0: 7320 746f 2062 6520 6120 7365 7175 656e  s to be a sequen
-0001e7b0: 6365 206f 6620 6c65 6e67 7468 207b 6c65  ce of length {le
-0001e7c0: 6e28 7265 7375 6c74 297d 2c20 676f 7420  n(result)}, got 
-0001e7d0: 6120 7365 7175 656e 6365 206f 6620 6c65  a sequence of le
-0001e7e0: 6e67 7468 207b 6c65 6e28 636f 7461 6e67  ngth {len(cotang
-0001e7f0: 656e 7473 297d 222c 0a20 2020 2020 2020  ents)}",.       
-0001e800: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-0001e810: 6e20 7265 7375 6c74 2c20 6261 636b 7761  n result, backwa
-0001e820: 7264 5f70 6173 7328 656e 762c 2074 7261  rd_pass(env, tra
-0001e830: 6365 2c20 636f 7461 6e67 656e 7473 290a  ce, cotangents).
-0001e840: 0a0a 2320 544f 444f 3a20 4361 6e27 7420  ..# TODO: Can't 
-0001e850: 7573 6520 6120 5379 6d62 6f6c 2068 6572  use a Symbol her
-0001e860: 6520 6265 6361 7573 6520 6d69 7865 6420  e because mixed 
-0001e870: 6578 6563 7574 6f72 2073 7962 7379 6d62  executor sybsymb
-0001e880: 6f6c 7320 7365 656d 2074 6f20 6265 0a23  ols seem to be.#
-0001e890: 2075 6e73 7570 706f 7274 6564 2e20 5365   unsupported. Se
-0001e8a0: 6520 6973 7375 6520 2243 6f75 6c64 206e  e issue "Could n
-0001e8b0: 6f74 2066 696e 6420 616e 2065 7865 6375  ot find an execu
-0001e8c0: 746f 7220 666f 7220 626f 756e 6420 7379  tor for bound sy
-0001e8d0: 6d62 6f6c 2077 6865 6e20 6974 7320 7375  mbol when its su
-0001e8e0: 6273 796d 626f 6c73 0a23 2061 7265 206e  bsymbols.# are n
-0001e8f0: 6f74 2066 756c 6c79 2073 7570 706f 7274  ot fully support
-0001e900: 6564 2062 7920 6120 7369 6e67 6c65 2065  ed by a single e
-0001e910: 7865 6375 746f 7222 0a76 6a70 5f63 616c  xecutor".vjp_cal
-0001e920: 6c20 3d20 7061 7274 6961 6c28 0a20 2020  l = partial(.   
-0001e930: 2076 6a70 5f63 616c 6c5f 6d65 7461 6675   vjp_call_metafu
-0001e940: 6e63 2c20 4661 6c73 650a 2920 2023 2053  nc, False.)  # S
-0001e950: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
-0001e960: 726d 732e 566a 704f 702c 206e 616d 653d  rms.VjpOp, name=
-0001e970: 2276 6a70 5f63 616c 6c22 2c20 6d65 7461  "vjp_call", meta
-0001e980: 3d70 6172 7469 616c 2876 6a70 5f63 616c  =partial(vjp_cal
-0001e990: 6c5f 6d65 7461 6675 6e63 2c20 4661 6c73  l_metafunc, Fals
-0001e9a0: 6529 290a 0a0a 6465 6620 766a 7028 6675  e))...def vjp(fu
-0001e9b0: 6e63 293a 0a20 2020 2022 2222 436f 6d70  nc):.    """Comp
-0001e9c0: 7574 6573 2074 6865 2056 4a50 206f 6620  utes the VJP of 
-0001e9d0: 6120 6675 6e63 7469 6f6e 2e0a 0a20 2020  a function...   
-0001e9e0: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
-0001e9f0: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
-0001ea00: 4675 6e63 7469 6f6e 2074 6f20 6265 2064  Function to be d
-0001ea10: 6966 6665 7265 6e74 6961 7465 642e 0a20  ifferentiated.. 
-0001ea20: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-0001ea30: 5f76 6a70 2870 7269 6d61 6c73 2c20 636f  _vjp(primals, co
-0001ea40: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
-0001ea50: 6773 293a 0a20 2020 2020 2020 2066 6c61  gs):.        fla
-0001ea60: 745f 6675 6e63 2c20 666c 6174 5f61 7267  t_func, flat_arg
-0001ea70: 732c 2073 7065 6320 3d20 666c 6174 7465  s, spec = flatte
-0001ea80: 6e5f 6675 6e63 2866 756e 632c 2070 7269  n_func(func, pri
-0001ea90: 6d61 6c73 2c20 6b77 6172 6773 290a 2020  mals, kwargs).  
-0001eaa0: 2020 2020 2020 7472 6163 6520 3d20 636f        trace = co
-0001eab0: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
-0001eac0: 666c 6174 5f66 756e 632c 202a 666c 6174  flat_func, *flat
-0001ead0: 5f61 7267 7329 0a20 2020 2020 2020 2072  _args).        r
-0001eae0: 6573 756c 742c 2076 6a70 5f72 6573 756c  esult, vjp_resul
-0001eaf0: 7420 3d20 766a 705f 6361 6c6c 2866 6c61  t = vjp_call(fla
-0001eb00: 745f 6172 6773 2c20 636f 7461 6e67 656e  t_args, cotangen
-0001eb10: 7473 2c20 7472 6163 653d 7472 6163 6529  ts, trace=trace)
-0001eb20: 0a20 2020 2020 2020 2067 7072 696d 616c  .        gprimal
-0001eb30: 732c 2067 6b77 6172 6773 203d 2074 7265  s, gkwargs = tre
-0001eb40: 655f 756e 666c 6174 7465 6e28 766a 705f  e_unflatten(vjp_
-0001eb50: 7265 7375 6c74 2c20 7370 6563 290a 2020  result, spec).  
-0001eb60: 2020 2020 2020 6772 6164 7320 3d20 6770        grads = gp
-0001eb70: 7269 6d61 6c73 202b 2028 676b 7761 7267  rimals + (gkwarg
-0001eb80: 732c 2920 6966 206c 656e 2867 6b77 6172  s,) if len(gkwar
-0001eb90: 6773 2920 213d 2030 2065 6c73 6520 6770  gs) != 0 else gp
-0001eba0: 7269 6d61 6c73 0a20 2020 2020 2020 2072  rimals.        r
-0001ebb0: 6574 7572 6e20 7265 7375 6c74 2c20 6772  eturn result, gr
-0001ebc0: 6164 730a 0a20 2020 2072 6574 7572 6e20  ads..    return 
-0001ebd0: 5f76 6a70 0a0a 0a64 6566 2076 616c 7565  _vjp...def value
-0001ebe0: 5f61 6e64 5f67 7261 6428 6675 6e63 293a  _and_grad(func):
-0001ebf0: 0a20 2020 2022 2222 436f 6d70 7574 6573  .    """Computes
-0001ec00: 2074 6865 2076 616c 7565 2061 6e64 2067   the value and g
-0001ec10: 7261 6469 656e 7420 6f66 2061 2066 756e  radient of a fun
-0001ec20: 6374 696f 6e2e 0a0a 2020 2020 5468 6973  ction...    This
-0001ec30: 2069 7320 6120 636f 6e76 656e 6965 6e63   is a convenienc
-0001ec40: 6520 6675 6e63 7469 6f6e 2074 6861 7420  e function that 
-0001ec50: 636f 6d62 696e 6573 2074 6865 2066 756e  combines the fun
-0001ec60: 6374 696f 6e61 6c69 7479 206f 660a 2020  ctionality of.  
-0001ec70: 2020 6076 6a70 5f63 616c 6c60 2077 6974    `vjp_call` wit
-0001ec80: 6820 696d 706c 6963 6974 2069 6e69 7469  h implicit initi
-0001ec90: 616c 697a 6174 696f 6e20 6f66 2074 6865  alization of the
-0001eca0: 2063 6f74 616e 6765 6e74 2074 6f20 312e   cotangent to 1.
-0001ecb0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001ecc0: 2020 2020 6675 6e63 2028 4361 6c6c 6162      func (Callab
-0001ecd0: 6c65 293a 2046 756e 6374 696f 6e20 746f  le): Function to
-0001ece0: 2062 6520 6469 6666 6572 656e 7469 6174   be differentiat
-0001ecf0: 6564 2e0a 2020 2020 2222 220a 0a20 2020  ed..    """..   
-0001ed00: 2064 6566 206f 6e65 735f 6c69 6b65 2878   def ones_like(x
-0001ed10: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
-0001ed20: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
-0001ed30: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
-0001ed40: 2020 2020 2020 7265 7475 726e 2066 756c        return ful
-0001ed50: 6c5f 6c69 6b65 2878 2c20 6669 6c6c 5f76  l_like(x, fill_v
-0001ed60: 616c 7565 3d31 290a 2020 2020 2020 2020  alue=1).        
-0001ed70: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-0001ed80: 782c 204e 756d 6265 7250 726f 7879 293a  x, NumberProxy):
-0001ed90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001eda0: 7572 6e20 7479 7065 2878 2e76 616c 7565  urn type(x.value
-0001edb0: 2928 3129 0a20 2020 2020 2020 2065 6c73  )(1).        els
-0001edc0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0001edd0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0001ede0: 6622 6f6e 6573 5f6c 696b 6520 696e 7369  f"ones_like insi
-0001edf0: 6465 2076 616c 7565 5f61 6e64 5f67 7261  de value_and_gra
-0001ee00: 6420 676f 7420 616e 2075 6e73 7570 706f  d got an unsuppo
-0001ee10: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
-0001ee20: 7829 7d22 290a 0a20 2020 2064 6566 205f  x)}")..    def _
-0001ee30: 7661 6c75 655f 616e 645f 6772 6164 282a  value_and_grad(*
-0001ee40: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0001ee50: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
-0001ee60: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0001ee70: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
-0001ee80: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-0001ee90: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
-0001eea0: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
-0001eeb0: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
-0001eec0: 7472 6163 652e 6f75 7470 7574 290a 2020  trace.output).  
-0001eed0: 2020 2020 2020 7265 7475 726e 2076 6a70        return vjp
-0001eee0: 2866 756e 6329 2861 7267 732c 2063 6f74  (func)(args, cot
-0001eef0: 616e 6765 6e74 732c 202a 2a6b 7761 7267  angents, **kwarg
-0001ef00: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
-0001ef10: 7661 6c75 655f 616e 645f 6772 6164 0a0a  value_and_grad..
-0001ef20: 0a46 6f72 7761 7264 4261 636b 7761 7264  .ForwardBackward
-0001ef30: 5472 6163 6573 203d 206e 616d 6564 7475  Traces = namedtu
-0001ef40: 706c 6528 2246 6f72 7761 7264 4261 636b  ple("ForwardBack
-0001ef50: 7761 7264 5472 6163 6573 222c 205b 2266  wardTraces", ["f
-0001ef60: 6f72 7761 7264 5f74 7261 6365 222c 2022  orward_trace", "
-0001ef70: 6261 636b 7761 7264 5f74 7261 6365 225d  backward_trace"]
-0001ef80: 290a 0a0a 6465 6620 5f73 706c 6974 5f73  )...def _split_s
-0001ef90: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001efa0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
-0001efb0: 6e64 5f6f 7468 6572 280a 2020 2020 7361  nd_other(.    sa
-0001efc0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001efd0: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
-0001efe0: 626c 655d 2c0a 2920 2d3e 2074 7570 6c65  ble],.) -> tuple
-0001eff0: 5b53 6571 7565 6e63 655b 5661 7269 6162  [Sequence[Variab
-0001f000: 6c65 5d2c 2053 6571 7565 6e63 655b 5661  le], Sequence[Va
-0001f010: 7269 6162 6c65 5d5d 3a0a 2020 2020 2222  riable]]:.    ""
-0001f020: 2253 706c 6974 7320 7361 7665 645f 666f  "Splits saved_fo
-0001f030: 725f 6261 636b 7761 7264 2069 6e74 6f20  r_backward into 
-0001f040: 7465 6e73 6f72 7320 616e 6420 6f74 6865  tensors and othe
-0001f050: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
-0001f060: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
-0001f070: 6261 636b 7761 7264 2028 5365 7175 656e  backward (Sequen
-0001f080: 6365 5b56 6172 6961 626c 655d 293a 2053  ce[Variable]): S
-0001f090: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f0a0: 6420 746f 2073 706c 6974 2e0a 0a20 2020  d to split...   
-0001f0b0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001f0c0: 2020 7475 706c 655b 5365 7175 656e 6365    tuple[Sequence
-0001f0d0: 5b56 6172 6961 626c 655d 2c20 5365 7175  [Variable], Sequ
-0001f0e0: 656e 6365 5b56 6172 6961 626c 655d 5d3a  ence[Variable]]:
-0001f0f0: 2054 7570 6c65 206f 6620 7465 6e73 6f72   Tuple of tensor
-0001f100: 7320 616e 6420 6f74 6865 722e 0a20 2020  s and other..   
-0001f110: 2022 2222 0a20 2020 2069 735f 7465 6e73   """.    is_tens
-0001f120: 6f72 203d 206c 616d 6264 6120 783a 2069  or = lambda x: i
-0001f130: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
-0001f140: 736f 7250 726f 7879 290a 2020 2020 6f74  sorProxy).    ot
-0001f150: 6865 722c 2074 656e 736f 7273 203d 2075  her, tensors = u
-0001f160: 7469 6c73 2e70 6172 7469 7469 6f6e 2869  tils.partition(i
-0001f170: 735f 7465 6e73 6f72 2c20 7361 7665 645f  s_tensor, saved_
-0001f180: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-0001f190: 2020 7265 7475 726e 2074 7570 6c65 2874    return tuple(t
-0001f1a0: 656e 736f 7273 292c 2074 7570 6c65 286f  ensors), tuple(o
-0001f1b0: 7468 6572 290a 0a0a 6465 6620 5f75 7064  ther)...def _upd
-0001f1c0: 6174 655f 666f 7277 6172 645f 7769 7468  ate_forward_with
-0001f1d0: 5f6e 6577 5f73 6176 6564 5f66 6f72 5f62  _new_saved_for_b
-0001f1e0: 6163 6b77 6172 6428 666f 7277 6172 645f  ackward(forward_
-0001f1f0: 7472 6163 653a 2054 7261 6365 2c20 7361  trace: Trace, sa
-0001f200: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f210: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
-0001f220: 626c 655d 2920 2d3e 204e 6f6e 653a 0a20  ble]) -> None:. 
-0001f230: 2020 2022 2222 5570 6461 7465 7320 7468     """Updates th
-0001f240: 6520 666f 7277 6172 6420 7472 6163 6520  e forward trace 
-0001f250: 7769 7468 206e 6577 2073 6176 6564 5f66  with new saved_f
-0001f260: 6f72 5f62 6163 6b77 6172 642e 0a0a 2020  or_backward...  
-0001f270: 2020 5468 6973 2069 7320 6e65 6365 7373    This is necess
-0001f280: 6172 7920 6265 6361 7573 6520 7468 6520  ary because the 
-0001f290: 7570 6461 7465 6420 7361 7665 645f 666f  updated saved_fo
-0001f2a0: 725f 6261 636b 7761 7264 2069 7320 6e6f  r_backward is no
-0001f2b0: 7420 6176 6169 6c61 626c 650a 2020 2020  t available.    
-0001f2c0: 7768 656e 2074 6865 2066 6f72 7761 7264  when the forward
-0001f2d0: 2061 6e64 2062 6163 6b77 6172 6420 7472   and backward tr
-0001f2e0: 6163 6573 2061 7265 2063 6f6e 7374 7275  aces are constru
-0001f2f0: 6374 6564 2e0a 0a20 2020 2041 7267 733a  cted...    Args:
-0001f300: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
-0001f310: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
-0001f320: 466f 7277 6172 6420 7472 6163 6520 746f  Forward trace to
-0001f330: 2075 7064 6174 652e 0a20 2020 2020 2020   update..       
-0001f340: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001f350: 6172 6420 2853 6571 7565 6e63 655b 5661  ard (Sequence[Va
-0001f360: 7269 6162 6c65 5d29 3a20 5361 7665 645f  riable]): Saved_
-0001f370: 666f 725f 6261 636b 7761 7264 2074 6f20  for_backward to 
-0001f380: 7573 6520 746f 0a20 2020 2020 2020 2020  use to.         
-0001f390: 2020 2075 7064 6174 6520 7468 6520 666f     update the fo
-0001f3a0: 7277 6172 6420 7472 6163 652e 0a20 2020  rward trace..   
-0001f3b0: 2022 2222 0a20 2020 2073 6176 6564 5f66   """.    saved_f
-0001f3c0: 6f72 5f62 6163 6b77 6172 6420 3d20 7472  or_backward = tr
-0001f3d0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-0001f3e0: 2078 2e76 616c 7565 2069 6620 6973 696e   x.value if isin
-0001f3f0: 7374 616e 6365 2878 2c20 4e75 6d62 6572  stance(x, Number
-0001f400: 5072 6f78 7929 2065 6c73 6520 782c 2073  Proxy) else x, s
-0001f410: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f420: 6429 0a20 2020 2073 6176 6564 5f74 656e  d).    saved_ten
-0001f430: 736f 7273 2c20 7361 7665 645f 6f74 6865  sors, saved_othe
-0001f440: 7220 3d20 5f73 706c 6974 5f73 6176 6564  r = _split_saved
-0001f450: 5f66 6f72 5f62 6163 6b77 6172 645f 696e  _for_backward_in
-0001f460: 746f 5f74 656e 736f 7273 5f61 6e64 5f6f  to_tensors_and_o
-0001f470: 7468 6572 2873 6176 6564 5f66 6f72 5f62  ther(saved_for_b
-0001f480: 6163 6b77 6172 6429 0a20 2020 2061 7373  ackward).    ass
-0001f490: 6572 7420 666f 7277 6172 645f 7472 6163  ert forward_trac
-0001f4a0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
-0001f4b0: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
-0001f4c0: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
-0001f4d0: 524e 0a20 2020 206e 6577 5f72 6574 7572  RN.    new_retur
-0001f4e0: 6e20 3d20 2866 6f72 7761 7264 5f74 7261  n = (forward_tra
-0001f4f0: 6365 2e6f 7574 7075 745b 305d 2c20 2873  ce.output[0], (s
-0001f500: 6176 6564 5f74 656e 736f 7273 2c20 7361  aved_tensors, sa
-0001f510: 7665 645f 6f74 6865 7229 290a 2020 2020  ved_other)).    
-0001f520: 666f 7277 6172 645f 7472 6163 652e 626f  forward_trace.bo
-0001f530: 756e 645f 7379 6d62 6f6c 735b 2d31 5d20  und_symbols[-1] 
-0001f540: 3d20 7265 706c 6163 6528 666f 7277 6172  = replace(forwar
-0001f550: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
-0001f560: 6d62 6f6c 735b 2d31 5d2c 2061 7267 733d  mbols[-1], args=
-0001f570: 6e65 775f 7265 7475 726e 290a 0a0a 6465  new_return)...de
-0001f580: 6620 5f75 7064 6174 655f 6261 636b 7761  f _update_backwa
-0001f590: 7264 5f77 6974 685f 6e65 775f 7361 7665  rd_with_new_save
-0001f5a0: 645f 666f 725f 6261 636b 7761 7264 2862  d_for_backward(b
-0001f5b0: 6163 6b77 6172 645f 7472 6163 653a 2054  ackward_trace: T
-0001f5c0: 7261 6365 2c20 7361 7665 645f 666f 725f  race, saved_for_
-0001f5d0: 6261 636b 7761 7264 3a20 5365 7175 656e  backward: Sequen
-0001f5e0: 6365 5b56 6172 6961 626c 655d 2920 2d3e  ce[Variable]) ->
-0001f5f0: 204e 6f6e 653a 0a20 2020 2022 2222 5570   None:.    """Up
-0001f600: 6461 7465 7320 7468 6520 6261 636b 7761  dates the backwa
-0001f610: 7264 2074 7261 6365 2077 6974 6820 6e65  rd trace with ne
-0001f620: 7720 7361 7665 645f 666f 725f 6261 636b  w saved_for_back
-0001f630: 7761 7264 2e0a 0a20 2020 2054 6869 7320  ward...    This 
-0001f640: 6973 206e 6563 6573 7361 7279 2062 6563  is necessary bec
-0001f650: 6175 7365 2074 6865 2075 7064 6174 6564  ause the updated
-0001f660: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001f670: 6172 6420 6973 0a20 2020 206e 6f74 2061  ard is.    not a
-0001f680: 7661 696c 6162 6c65 2077 6865 6e20 7468  vailable when th
-0001f690: 6520 6261 636b 7761 7264 2074 7261 6365  e backward trace
-0001f6a0: 2069 7320 636f 6e73 7472 7563 7465 642e   is constructed.
-0001f6b0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001f6c0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-0001f6d0: 6365 2028 5472 6163 6529 3a20 4261 636b  ce (Trace): Back
-0001f6e0: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
-0001f6f0: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
-0001f700: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f710: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
-0001f720: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
-0001f730: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
-0001f740: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-0001f750: 7570 6461 7465 2074 6865 2062 6163 6b77  update the backw
-0001f760: 6172 6420 7472 6163 652e 0a20 2020 2022  ard trace..    "
-0001f770: 2222 0a0a 2020 2020 6465 6620 756e 7061  ""..    def unpa
-0001f780: 636b 696e 675f 666e 2873 6176 6564 5f66  cking_fn(saved_f
-0001f790: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
-0001f7a0: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
-0001f7b0: 2020 7061 7373 0a0a 2020 2020 636f 7461    pass..    cota
-0001f7c0: 6e67 656e 7473 203d 2062 6163 6b77 6172  ngents = backwar
-0001f7d0: 645f 7472 6163 652e 6172 6773 5b31 5d0a  d_trace.args[1].
-0001f7e0: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
-0001f7f0: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
-0001f800: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
-0001f810: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
-0001f820: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
-0001f830: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
-0001f840: 7761 7264 290a 2020 2020 756e 7061 636b  ward).    unpack
-0001f850: 696e 675f 7472 6163 6520 3d20 636f 6e73  ing_trace = cons
-0001f860: 7472 7563 745f 7472 6163 6528 7265 6e61  truct_trace(rena
-0001f870: 6d65 5f70 726f 7869 6573 3d46 616c 7365  me_proxies=False
-0001f880: 2c20 7573 655f 6463 653d 4661 6c73 6529  , use_dce=False)
-0001f890: 280a 2020 2020 2020 2020 756e 7061 636b  (.        unpack
-0001f8a0: 696e 675f 666e 2c20 2873 6176 6564 5f74  ing_fn, (saved_t
-0001f8b0: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
-0001f8c0: 6865 7229 2c20 636f 7461 6e67 656e 7473  her), cotangents
-0001f8d0: 0a20 2020 2029 0a20 2020 2061 7373 6572  .    ).    asser
-0001f8e0: 7420 756e 7061 636b 696e 675f 7472 6163  t unpacking_trac
-0001f8f0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
-0001f900: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
-0001f910: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
-0001f920: 524e 0a0a 2020 2020 6261 636b 7761 7264  RN..    backward
-0001f930: 5f74 7261 6365 2e61 7267 7320 3d20 756e  _trace.args = un
-0001f940: 7061 636b 696e 675f 7472 6163 652e 6172  packing_trace.ar
-0001f950: 6773 0a20 2020 2062 6163 6b77 6172 645f  gs.    backward_
-0001f960: 7472 6163 655f 6273 796d 735f 7769 7468  trace_bsyms_with
-0001f970: 6f75 745f 756e 7061 636b 696e 6720 3d20  out_unpacking = 
-0001f980: 280a 2020 2020 2020 2020 6273 796d 0a20  (.        bsym. 
-0001f990: 2020 2020 2020 2066 6f72 2062 7379 6d20         for bsym 
-0001f9a0: 696e 2062 6163 6b77 6172 645f 7472 6163  in backward_trac
-0001f9b0: 652e 626f 756e 645f 7379 6d62 6f6c 730a  e.bound_symbols.
-0001f9c0: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
-0001f9d0: 7379 6d2e 6964 0a20 2020 2020 2020 206e  sym.id.        n
-0001f9e0: 6f74 2069 6e20 280a 2020 2020 2020 2020  ot in (.        
-0001f9f0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-0001fa00: 732e 554e 5041 434b 5f45 4d50 5459 5f44  s.UNPACK_EMPTY_D
-0001fa10: 4943 542c 0a20 2020 2020 2020 2020 2020  ICT,.           
-0001fa20: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
-0001fa30: 4e50 4143 4b5f 4b45 592c 0a20 2020 2020  NPACK_KEY,.     
-0001fa40: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
-0001fa50: 6d49 4473 2e55 4e50 4143 4b5f 5345 5155  mIDs.UNPACK_SEQU
-0001fa60: 454e 4345 2c0a 2020 2020 2020 2020 2020  ENCE,.          
-0001fa70: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-0001fa80: 554e 5041 434b 5f54 5249 5649 414c 2c0a  UNPACK_TRIVIAL,.
-0001fa90: 2020 2020 2020 2020 290a 2020 2020 290a          ).    ).
-0001faa0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-0001fab0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
-0001fac0: 203d 206c 6973 7428 282a 756e 7061 636b   = list((*unpack
-0001fad0: 696e 675f 7472 6163 652e 626f 756e 645f  ing_trace.bound_
-0001fae0: 7379 6d62 6f6c 735b 3a2d 315d 2c20 2a62  symbols[:-1], *b
-0001faf0: 6163 6b77 6172 645f 7472 6163 655f 6273  ackward_trace_bs
-0001fb00: 796d 735f 7769 7468 6f75 745f 756e 7061  yms_without_unpa
-0001fb10: 636b 696e 6729 290a 0a0a 2320 4e4f 5445  cking))...# NOTE
-0001fb20: 3a20 5265 7475 726e 696e 6720 6e61 6d65  : Returning name
-0001fb30: 6474 7570 6c65 7320 6672 6f6d 2063 6f6d  dtuples from com
-0001fb40: 7069 6c65 6420 6675 6e63 7469 6f6e 7320  piled functions 
-0001fb50: 646f 6573 6e27 7420 776f 726b 2e20 5365  doesn't work. Se
-0001fb60: 653a 0a23 2022 416c 6c6f 7720 7265 7475  e:.# "Allow retu
-0001fb70: 726e 696e 6720 6e61 6d65 6474 7570 6c65  rning namedtuple
-0001fb80: 7320 6672 6f6d 2063 6f6d 7069 6c65 6420  s from compiled 
-0001fb90: 6675 6e63 7469 6f6e 7322 0a23 204e 6f74  functions".# Not
-0001fba0: 6520 5b47 7261 6420 666f 7277 6172 6420  e [Grad forward 
-0001fbb0: 6f75 7470 7574 2073 7065 635d 0a23 2049  output spec].# I
-0001fbc0: 6620 6974 2064 6964 2077 6f72 6b20 6974  f it did work it
-0001fbd0: 2077 6f75 6c64 2062 6520 6e69 6365 2074   would be nice t
-0001fbe0: 6f20 7573 6520 7468 6973 206e 616d 6564  o use this named
-0001fbf0: 7475 706c 650a 2320 696e 7374 6561 6420  tuple.# instead 
-0001fc00: 6f66 2074 6865 2070 6c61 696e 2074 7570  of the plain tup
-0001fc10: 6c65 206f 7220 6469 6374 2074 6861 7420  le or dict that 
-0001fc20: 7765 2772 6520 7573 696e 6720 6e6f 772e  we're using now.
-0001fc30: 0a54 6f72 6368 4175 746f 6772 6164 466f  .TorchAutogradFo
-0001fc40: 7277 6172 6444 6174 6120 3d20 6e61 6d65  rwardData = name
-0001fc50: 6474 7570 6c65 280a 2020 2020 2254 6f72  dtuple(.    "Tor
-0001fc60: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
-0001fc70: 6444 6174 6122 2c0a 2020 2020 5b22 6f75  dData",.    ["ou
-0001fc80: 7470 7574 222c 2022 666c 6174 5f61 7267  tput", "flat_arg
-0001fc90: 7322 2c20 2266 6c61 745f 6f75 7470 7574  s", "flat_output
-0001fca0: 225d 2c0a 290a 0a0a 6465 6620 666f 7277  "],.)...def forw
-0001fcb0: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
-0001fcc0: 5f66 726f 6d5f 7472 6163 6528 7472 6163  _from_trace(trac
-0001fcd0: 653a 2054 7261 6365 2c20 746f 7263 685f  e: Trace, torch_
-0001fce0: 6175 746f 6772 6164 3d46 616c 7365 2920  autograd=False) 
-0001fcf0: 2d3e 2046 6f72 7761 7264 4261 636b 7761  -> ForwardBackwa
-0001fd00: 7264 5472 6163 6573 3a0a 2020 2020 2222  rdTraces:.    ""
-0001fd10: 2247 656e 6572 6174 6573 2074 6865 2066  "Generates the f
-0001fd20: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
-0001fd30: 6172 6420 7061 7373 6573 2066 726f 6d20  ard passes from 
-0001fd40: 6120 7472 6163 652e 0a0a 2020 2020 5468  a trace...    Th
-0001fd50: 6973 2069 7320 6120 636f 6e76 656e 6965  is is a convenie
-0001fd60: 6e63 6520 6675 6e63 7469 6f6e 2074 6861  nce function tha
-0001fd70: 7420 636f 6d62 696e 6573 2074 6865 2066  t combines the f
-0001fd80: 756e 6374 696f 6e61 6c69 7479 206f 660a  unctionality of.
-0001fd90: 2020 2020 6061 7567 6d65 6e74 6564 5f66      `augmented_f
-0001fda0: 6f72 7761 7264 5f70 6173 7360 2061 6e64  orward_pass` and
-0001fdb0: 2060 6261 636b 7761 7264 5f70 6173 7360   `backward_pass`
-0001fdc0: 2e20 5468 6520 6d61 696e 2064 6966 6665  . The main diffe
-0001fdd0: 7265 6e63 6520 6973 2074 6861 740a 2020  rence is that.  
-0001fde0: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
-0001fdf0: 646f 6573 206e 6f74 2072 6571 7569 7265  does not require
-0001fe00: 2074 6865 2075 7365 7220 746f 2070 726f   the user to pro
-0001fe10: 7669 6465 206e 6577 2069 6e70 7574 7320  vide new inputs 
-0001fe20: 666f 7220 7468 650a 2020 2020 7472 6163  for the.    trac
-0001fe30: 6520 6576 616c 7561 7469 6f6e 2e20 496e  e evaluation. In
-0001fe40: 7374 6561 6420 6974 2075 7365 7320 7468  stead it uses th
-0001fe50: 6520 696e 7075 7473 2074 6861 7420 7765  e inputs that we
-0001fe60: 7265 2075 7365 6420 746f 2063 6f6e 7374  re used to const
-0001fe70: 7275 6374 0a20 2020 2074 6865 2074 7261  ruct.    the tra
-0001fe80: 6365 2e0a 0a20 2020 2041 7267 733a 0a20  ce...    Args:. 
-0001fe90: 2020 2020 2020 2074 7261 6365 2028 5472         trace (Tr
-0001fea0: 6163 6529 3a20 5472 6163 6520 746f 2067  ace): Trace to g
-0001feb0: 656e 6572 6174 6520 7468 6520 666f 7277  enerate the forw
-0001fec0: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-0001fed0: 2070 6173 7365 7320 6672 6f6d 2e0a 0a20   passes from... 
-0001fee0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0001fef0: 2020 2020 466f 7277 6172 6442 6163 6b77      ForwardBackw
-0001ff00: 6172 6454 7261 6365 733a 2041 206e 616d  ardTraces: A nam
-0001ff10: 6564 2074 7570 6c65 2063 6f6e 7461 696e  ed tuple contain
-0001ff20: 696e 6720 7468 6520 666f 7277 6172 6420  ing the forward 
-0001ff30: 616e 6420 6261 636b 7761 7264 0a20 2020  and backward.   
-0001ff40: 2020 2020 2020 2020 2074 7261 6365 732e           traces.
-0001ff50: 0a0a 2020 2020 4578 616d 706c 653a 0a20  ..    Example:. 
-0001ff60: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
-0001ff70: 7420 746f 7263 680a 2020 2020 2020 2020  t torch.        
-0001ff80: 3e3e 3e20 6672 6f6d 2074 6875 6e64 6572  >>> from thunder
-0001ff90: 2069 6d70 6f72 7420 636f 6d70 696c 652c   import compile,
-0001ffa0: 206c 6173 745f 7472 6163 6573 0a20 2020   last_traces.   
-0001ffb0: 2020 2020 203e 3e3e 2066 726f 6d20 7468       >>> from th
-0001ffc0: 756e 6465 722e 636f 7265 2e74 7261 6e73  under.core.trans
-0001ffd0: 666f 726d 7320 696d 706f 7274 2066 6f72  forms import for
-0001ffe0: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
-0001fff0: 645f 6672 6f6d 5f74 7261 6365 0a20 2020  d_from_trace.   
-00020000: 2020 2020 203e 3e3e 2064 6566 2066 2878       >>> def f(x
-00020010: 293a 0a20 2020 2020 2020 202e 2e2e 2020  ):.        ...  
-00020020: 2020 2072 6574 7572 6e20 746f 7263 682e     return torch.
-00020030: 7369 6e28 7829 0a20 2020 2020 2020 203e  sin(x).        >
-00020040: 3e3e 2078 203d 2074 6f72 6368 2e74 656e  >> x = torch.ten
-00020050: 736f 7228 332e 3029 0a20 2020 2020 2020  sor(3.0).       
-00020060: 203e 3e3e 2063 6620 3d20 636f 6d70 696c   >>> cf = compil
-00020070: 6528 6629 0a20 2020 2020 2020 203e 3e3e  e(f).        >>>
-00020080: 206f 7574 203d 2063 6628 7829 0a20 2020   out = cf(x).   
-00020090: 2020 2020 203e 3e3e 2074 7261 6365 203d       >>> trace =
-000200a0: 206c 6173 745f 7472 6163 6573 2863 6629   last_traces(cf)
-000200b0: 5b30 5d0a 2020 2020 2020 2020 3e3e 3e20  [0].        >>> 
-000200c0: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
-000200d0: 7761 7264 5f66 726f 6d5f 7472 6163 6528  ward_from_trace(
-000200e0: 7472 6163 6529 0a20 2020 2020 2020 202e  trace).        .
-000200f0: 2e2e 2046 6f72 7761 7264 4261 636b 7761  .. ForwardBackwa
-00020100: 7264 5472 6163 6573 280a 2020 2020 2020  rdTraces(.      
-00020110: 2020 2e2e 2e20 666f 7277 6172 645f 7472    ... forward_tr
-00020120: 6163 653d 2320 696d 706f 7274 2074 6875  ace=# import thu
-00020130: 6e64 6572 2061 7320 7468 756e 6465 720a  nder as thunder.
-00020140: 2020 2020 2020 2020 2e2e 2e20 2320 696d          ... # im
-00020150: 706f 7274 2074 6875 6e64 6572 2e63 6f72  port thunder.cor
-00020160: 652e 7072 696d 7320 6173 2070 7269 6d73  e.prims as prims
-00020170: 0a20 2020 2020 2020 202e 2e2e 2069 6d70  .        ... imp
-00020180: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
-00020190: 2020 2e2e 2e0a 2020 2020 2020 2020 2e2e    ....        ..
-000201a0: 2e20 4074 6f72 6368 2e6e 6f5f 6772 6164  . @torch.no_grad
-000201b0: 2829 0a20 2020 2020 2020 202e 2e2e 2064  ().        ... d
-000201c0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
-000201d0: 7761 7264 5f66 6e28 2a61 7267 7329 3a0a  ward_fn(*args):.
-000201e0: 2020 2020 2020 2020 2e2e 2e20 2020 2320          ...   # 
-000201f0: 6172 6773 3a20 2243 6f6c 6c65 6374 696f  args: "Collectio
-00020200: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
-00020210: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
-00020220: 2020 2020 2020 2e2e 2e20 2020 7430 2c20        ...   t0, 
-00020230: 5c0a 2020 2020 2020 2020 2e2e 2e20 2020  \.        ...   
-00020240: 3d20 6172 6773 0a20 2020 2020 2020 202e  = args.        .
-00020250: 2e2e 2020 2074 3120 3d20 7072 696d 732e  ..   t1 = prims.
-00020260: 7369 6e28 7430 2920 2023 2074 313a 2022  sin(t0)  # t1: "
-00020270: 6370 7520 6633 325b 5d22 0a20 2020 2020  cpu f32[]".     
-00020280: 2020 202e 2e2e 2020 2072 6574 7572 6e20     ...   return 
-00020290: 7431 2c20 2874 302c 292c 0a20 2020 2020  t1, (t0,),.     
-000202a0: 2020 202e 2e2e 2062 6163 6b77 6172 645f     ... backward_
-000202b0: 7472 6163 653d 2320 696d 706f 7274 2074  trace=# import t
-000202c0: 6875 6e64 6572 2061 7320 7468 756e 6465  hunder as thunde
-000202d0: 720a 2020 2020 2020 2020 2e2e 2e20 2320  r.        ... # 
-000202e0: 696d 706f 7274 2074 6875 6e64 6572 2e63  import thunder.c
-000202f0: 6f72 652e 7072 696d 7320 6173 2070 7269  ore.prims as pri
-00020300: 6d73 0a20 2020 2020 2020 202e 2e2e 2069  ms.        ... i
-00020310: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
-00020320: 2020 2020 2e2e 2e0a 2020 2020 2020 2020      ....        
-00020330: 2e2e 2e20 4074 6f72 6368 2e6e 6f5f 6772  ... @torch.no_gr
-00020340: 6164 2829 0a20 2020 2020 2020 202e 2e2e  ad().        ...
-00020350: 2064 6566 2062 6163 6b77 6172 645f 666e   def backward_fn
-00020360: 2873 6176 6564 5f66 6f72 5f62 6163 6b77  (saved_for_backw
-00020370: 6172 642c 2063 6f74 616e 6765 6e74 7329  ard, cotangents)
-00020380: 3a0a 2020 2020 2020 2020 2e2e 2e20 2020  :.        ...   
-00020390: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
-000203a0: 7761 7264 3a20 2243 6f6c 6c65 6374 696f  ward: "Collectio
-000203b0: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
-000203c0: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
-000203d0: 2020 2020 2020 2e2e 2e20 2020 2320 636f        ...   # co
-000203e0: 7461 6e67 656e 7473 3a20 2263 7075 2066  tangents: "cpu f
-000203f0: 3332 5b5d 2220 3d20 2063 6f74 616e 6765  32[]" =  cotange
-00020400: 6e74 7320 2028 7472 6976 6961 6c20 756e  nts  (trivial un
-00020410: 7061 636b 290a 2020 2020 2020 2020 2e2e  pack).        ..
-00020420: 2e20 2020 7430 2c20 5c0a 2020 2020 2020  .   t0, \.      
-00020430: 2020 2e2e 2e20 2020 3d20 7361 7665 645f    ...   = saved_
-00020440: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
-00020450: 2020 2020 202e 2e2e 2020 2074 3120 3d20       ...   t1 = 
-00020460: 7072 696d 732e 636f 7328 7430 2920 2023  prims.cos(t0)  #
-00020470: 2074 313a 2022 6370 7520 6633 325b 5d22   t1: "cpu f32[]"
-00020480: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
-00020490: 3220 3d20 7072 696d 732e 6d75 6c28 636f  2 = prims.mul(co
-000204a0: 7461 6e67 656e 7473 2c20 7431 2920 2023  tangents, t1)  #
-000204b0: 2074 323a 2022 6370 7520 6633 325b 5d22   t2: "cpu f32[]"
-000204c0: 0a20 2020 2020 2020 202e 2e2e 2020 2072  .        ...   r
-000204d0: 6574 7572 6e20 2874 322c 2929 0a20 2020  eturn (t2,)).   
-000204e0: 2022 2222 0a0a 2020 2020 6f75 7470 7574   """..    output
-000204f0: 5f73 7065 6320 3d20 4e6f 6e65 0a0a 2020  _spec = None..  
-00020500: 2020 6465 6620 6175 676d 656e 7465 645f    def augmented_
-00020510: 666f 7277 6172 645f 666e 282a 6172 6773  forward_fn(*args
-00020520: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00020530: 2020 2020 2072 6573 756c 742c 2065 6e76       result, env
-00020540: 203d 2061 7567 6d65 6e74 6564 5f66 6f72   = augmented_for
-00020550: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
-00020560: 2074 7261 6365 3d74 7261 6365 2c20 2a2a   trace=trace, **
-00020570: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00020580: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00020590: 7264 203d 2064 6563 6f6e 7374 7275 6374  rd = deconstruct
-000205a0: 5f66 6f72 7761 7264 5f65 6e76 5f66 6f72  _forward_env_for
-000205b0: 5f62 6163 6b77 6172 6428 7472 6163 652c  _backward(trace,
-000205c0: 2065 6e76 290a 2020 2020 2020 2020 6966   env).        if
-000205d0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
-000205e0: 0a20 2020 2020 2020 2020 2020 206e 6f6e  .            non
-000205f0: 6c6f 6361 6c20 6f75 7470 7574 5f73 7065  local output_spe
-00020600: 630a 2020 2020 2020 2020 2020 2020 666c  c.            fl
-00020610: 6174 5f61 7267 732c 205f 203d 2074 7265  at_args, _ = tre
-00020620: 655f 666c 6174 7465 6e28 2861 7267 732c  e_flatten((args,
-00020630: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
-00020640: 2020 2020 2020 666c 6174 5f6f 7574 7075        flat_outpu
-00020650: 742c 206f 7574 7075 745f 7370 6563 203d  t, output_spec =
-00020660: 2074 7265 655f 666c 6174 7465 6e28 7265   tree_flatten(re
-00020670: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-00020680: 2020 666c 6174 5f6f 7574 7075 7420 3d20    flat_output = 
-00020690: 7475 706c 6528 666c 6174 5f6f 7574 7075  tuple(flat_outpu
-000206a0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
-000206b0: 2053 6565 204e 6f74 6520 5b47 7261 6420   See Note [Grad 
-000206c0: 666f 7277 6172 6420 6f75 7470 7574 2073  forward output s
-000206d0: 7065 635d 0a20 2020 2020 2020 2020 2020  pec].           
-000206e0: 2066 6f72 5f61 7574 6f67 7261 6420 3d20   for_autograd = 
-000206f0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
-00020700: 7761 7264 4461 7461 280a 2020 2020 2020  wardData(.      
-00020710: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00020720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020730: 2020 666c 6174 5f61 7267 732c 0a20 2020    flat_args,.   
-00020740: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
-00020750: 745f 6f75 7470 7574 2c0a 2020 2020 2020  t_output,.      
-00020760: 2020 2020 2020 292e 5f61 7364 6963 7428        )._asdict(
-00020770: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00020780: 7475 726e 2028 666f 725f 6175 746f 6772  turn (for_autogr
-00020790: 6164 2c20 7361 7665 645f 666f 725f 6261  ad, saved_for_ba
-000207a0: 636b 7761 7264 290a 2020 2020 2020 2020  ckward).        
-000207b0: 7265 7475 726e 2072 6573 756c 742c 2073  return result, s
-000207c0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000207d0: 640a 0a20 2020 2023 2043 6f70 7920 7468  d..    # Copy th
-000207e0: 6520 7369 676e 6174 7572 6520 6f66 2074  e signature of t
-000207f0: 6865 206f 7269 6769 6e61 6c20 6675 6e63  he original func
-00020800: 7469 6f6e 2073 6f20 7468 6174 2074 6865  tion so that the
-00020810: 2061 7267 756d 656e 7473 2061 7265 0a20   arguments are. 
-00020820: 2020 2023 206e 616d 6564 2063 6f72 7265     # named corre
-00020830: 6374 6c79 2069 6e20 7468 6520 6175 676d  ctly in the augm
-00020840: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
-00020850: 7373 2069 6e73 7465 6164 206f 6620 6265  ss instead of be
-00020860: 696e 6720 6e61 6d65 640a 2020 2020 2320  ing named.    # 
-00020870: 2261 7267 7322 2061 6e64 2022 6b77 6172  "args" and "kwar
-00020880: 6773 222e 0a20 2020 2061 7567 6d65 6e74  gs"..    augment
-00020890: 6564 5f66 6f72 7761 7264 5f66 6e2e 5f5f  ed_forward_fn.__
-000208a0: 7369 676e 6174 7572 655f 5f20 3d20 696e  signature__ = in
-000208b0: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
-000208c0: 7472 6163 652e 666e 206f 7220 7472 6163  trace.fn or trac
-000208d0: 652e 7079 7468 6f6e 5f63 616c 6c61 626c  e.python_callabl
-000208e0: 6528 2929 0a0a 2020 2020 6465 6620 6f6e  e())..    def on
-000208f0: 6573 5f6c 696b 6528 7829 3a0a 2020 2020  es_like(x):.    
-00020900: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00020910: 6528 782c 2054 656e 736f 7250 726f 7879  e(x, TensorProxy
-00020920: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00020930: 6574 7572 6e20 6675 6c6c 5f6c 696b 6528  eturn full_like(
-00020940: 782c 2066 696c 6c5f 7661 6c75 653d 3129  x, fill_value=1)
-00020950: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
-00020960: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
-00020970: 6572 5072 6f78 7929 3a0a 2020 2020 2020  erProxy):.      
-00020980: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
-00020990: 6528 782e 7661 6c75 6529 2831 290a 2020  e(x.value)(1).  
-000209a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000209b0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-000209c0: 6f6e 650a 0a20 2020 2066 6f72 7761 7264  one..    forward
-000209d0: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
-000209e0: 6374 5f74 7261 6365 2829 2861 7567 6d65  ct_trace()(augme
-000209f0: 6e74 6564 5f66 6f72 7761 7264 5f66 6e2c  nted_forward_fn,
-00020a00: 202a 7472 6163 652e 6172 6773 2c20 2a2a   *trace.args, **
-00020a10: 7472 6163 652e 6b77 6172 6773 290a 2020  trace.kwargs).  
-00020a20: 2020 2320 5765 2073 6574 2066 6f72 7761    # We set forwa
-00020a30: 7264 2074 7261 6365 2074 6f20 636f 6e73  rd trace to cons
-00020a40: 7472 7563 7420 7072 6f78 6965 7320 6265  truct proxies be
-00020a50: 6361 7573 6520 7765 206e 6565 6420 7468  cause we need th
-00020a60: 6573 6520 7072 6f78 6965 7320 746f 0a20  ese proxies to. 
-00020a70: 2020 2023 2068 6176 6520 6469 6666 6572     # have differ
-00020a80: 656e 7420 6e61 6d65 7320 7468 616e 2074  ent names than t
-00020a90: 6865 206f 6e65 7320 696e 2074 6865 2066  he ones in the f
-00020aa0: 6f72 7761 7264 2074 7261 6365 2e0a 2020  orward trace..  
-00020ab0: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
-00020ac0: 7261 6365 6374 785f 746f 6b65 6e20 3d20  racectx_token = 
-00020ad0: 7365 745f 7472 6163 6563 7478 2866 6f72  set_tracectx(for
-00020ae0: 7761 7264 5f74 7261 6365 290a 2020 2020  ward_trace).    
-00020af0: 2020 2020 2320 5765 2064 6f6e 2774 2077      # We don't w
-00020b00: 616e 7420 746f 2072 6563 6f72 6420 7468  ant to record th
-00020b10: 6f73 6520 6f6e 6573 5f6c 696b 6520 6361  ose ones_like ca
-00020b20: 6c6c 7320 696e 2074 6865 2066 6f72 7761  lls in the forwa
-00020b30: 7264 2074 7261 6365 2e0a 2020 2020 2020  rd trace..      
-00020b40: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
-00020b50: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
-00020b60: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
-00020b70: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
-00020b80: 2020 2020 2020 2020 2320 4974 2773 2061          # It's a
-00020b90: 7373 756d 6564 2074 6861 7420 666f 7277  ssumed that forw
-00020ba0: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
-00020bb0: 5b30 5d20 6973 2061 2064 6963 7420 6672  [0] is a dict fr
-00020bc0: 6f6d 2054 6f72 6368 4175 746f 6772 6164  om TorchAutograd
-00020bd0: 466f 7277 6172 6444 6174 610a 2020 2020  ForwardData.    
-00020be0: 2020 2020 2020 2020 2020 2020 666c 6174              flat
-00020bf0: 5f6f 7574 7075 7420 3d20 666f 7277 6172  _output = forwar
-00020c00: 645f 7472 6163 652e 6f75 7470 7574 5b30  d_trace.output[0
-00020c10: 5d5b 2266 6c61 745f 6f75 7470 7574 225d  ]["flat_output"]
-00020c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020c30: 2063 6f74 616e 6765 6e74 7320 3d20 7574   cotangents = ut
-00020c40: 696c 732e 7365 7175 656e 6369 6679 2874  ils.sequencify(t
-00020c50: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
-00020c60: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
-00020c70: 666c 6174 5f6f 7574 7075 7429 290a 2020  flat_output)).  
-00020c80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00020c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ca0: 636f 7461 6e67 656e 7473 203d 2075 7469  cotangents = uti
-00020cb0: 6c73 2e73 6571 7565 6e63 6966 7928 7472  ls.sequencify(tr
-00020cc0: 6565 5f6d 6170 286c 616d 6264 6120 763a  ee_map(lambda v:
-00020cd0: 206f 6e65 735f 6c69 6b65 2876 292c 2074   ones_like(v), t
-00020ce0: 7261 6365 2e6f 7574 7075 7429 290a 2020  race.output)).  
-00020cf0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-00020d00: 2020 2072 6573 6574 5f74 7261 6365 6374     reset_tracect
-00020d10: 7828 7472 6163 6563 7478 5f74 6f6b 656e  x(tracectx_token
-00020d20: 290a 0a20 2020 2064 6566 2062 6163 6b77  )..    def backw
-00020d30: 6172 645f 666e 2873 6176 6564 5f66 6f72  ard_fn(saved_for
-00020d40: 5f62 6163 6b77 6172 642c 2063 6f74 616e  _backward, cotan
-00020d50: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
-00020d60: 656e 7620 3d20 7265 636f 6e73 7472 7563  env = reconstruc
-00020d70: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
-00020d80: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
-00020d90: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-00020da0: 7761 7264 290a 2020 2020 2020 2020 6966  ward).        if
-00020db0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
-00020dc0: 0a20 2020 2020 2020 2020 2020 2063 6f74  .            cot
-00020dd0: 616e 6765 6e74 7320 3d20 7472 6565 5f75  angents = tree_u
-00020de0: 6e66 6c61 7474 656e 2863 6f74 616e 6765  nflatten(cotange
-00020df0: 6e74 732c 206f 7574 7075 745f 7370 6563  nts, output_spec
-00020e00: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
-00020e10: 6261 636b 7761 7264 5f70 6173 7328 656e  backward_pass(en
-00020e20: 762c 2074 7261 6365 2c20 636f 7461 6e67  v, trace, cotang
-00020e30: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
-00020e40: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
-00020e50: 0a20 2020 2020 2020 2020 2020 2067 6b77  .            gkw
-00020e60: 6172 6773 203d 206f 7574 5b2d 315d 2069  args = out[-1] i
-00020e70: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
-00020e80: 5b2d 315d 2c20 6469 6374 2920 656c 7365  [-1], dict) else
-00020e90: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-00020ea0: 6761 7267 7320 3d20 6f75 745b 3a2d 315d  gargs = out[:-1]
-00020eb0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-00020ec0: 7574 5b2d 315d 2c20 6469 6374 2920 656c  ut[-1], dict) el
-00020ed0: 7365 206f 7574 0a20 2020 2020 2020 2020  se out.         
-00020ee0: 2020 2067 6b77 6172 6773 203d 207b 6b3a     gkwargs = {k:
-00020ef0: 2067 6b77 6172 6773 2e67 6574 286b 2c20   gkwargs.get(k, 
-00020f00: 4e6f 6e65 2920 666f 7220 6b20 696e 2074  None) for k in t
-00020f10: 7261 6365 2e6b 7761 7267 737d 0a20 2020  race.kwargs}.   
-00020f20: 2020 2020 2020 2020 206f 7574 203d 2028           out = (
-00020f30: 2a67 6172 6773 2c20 676b 7761 7267 7329  *gargs, gkwargs)
-00020f40: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00020f50: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00020f60: 6f75 7429 5b30 5d0a 2020 2020 2020 2020  out)[0].        
-00020f70: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
-00020f80: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00020f90: 7264 203d 2066 6f72 7761 7264 5f74 7261  rd = forward_tra
-00020fa0: 6365 2e6f 7574 7075 745b 315d 0a20 2020  ce.output[1].   
-00020fb0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
-00020fc0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-00020fd0: 6528 7265 6e61 6d65 5f70 726f 7869 6573  e(rename_proxies
-00020fe0: 3d46 616c 7365 2928 6261 636b 7761 7264  =False)(backward
-00020ff0: 5f66 6e2c 2073 6176 6564 5f66 6f72 5f62  _fn, saved_for_b
-00021000: 6163 6b77 6172 642c 2063 6f74 616e 6765  ackward, cotange
-00021010: 6e74 7329 0a0a 2020 2020 2320 5765 2061  nts)..    # We a
-00021020: 7265 2064 6f6e 6520 7769 7468 2063 6f6e  re done with con
-00021030: 7374 7275 6374 696e 6720 7468 6520 666f  structing the fo
-00021040: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
-00021050: 7264 2070 6173 7365 7320 6174 2074 6869  rd passes at thi
-00021060: 730a 2020 2020 2320 7374 6167 652e 2054  s.    # stage. T
-00021070: 6865 2066 6f6c 6c6f 7769 6e67 2069 7320  he following is 
-00021080: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
-00021090: 6573 7361 7279 2c20 6275 7420 6974 2773  essary, but it's
-000210a0: 2067 6f6f 6420 746f 2066 696c 7465 720a   good to filter.
-000210b0: 2020 2020 2320 6f75 7420 7468 6520 756e      # out the un
-000210c0: 7573 6564 2065 6c65 6d65 6e74 7320 6f66  used elements of
-000210d0: 2074 6865 2073 6176 6564 5f66 6f72 5f62   the saved_for_b
-000210e0: 6163 6b77 6172 6420 616e 6420 666c 6174  ackward and flat
-000210f0: 7465 6e20 6974 2066 6f72 206d 6f72 650a  ten it for more.
-00021100: 2020 2020 2320 636f 6d70 6163 7420 6261      # compact ba
-00021110: 636b 7761 7264 2074 7261 6365 2e0a 0a20  ckward trace... 
-00021120: 2020 2023 204e 6f77 2077 6520 6361 6e20     # Now we can 
-00021130: 6465 7465 726d 696e 6520 6578 6163 746c  determine exactl
-00021140: 7920 7768 6174 2773 2075 7365 6420 696e  y what's used in
-00021150: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
-00021160: 7373 2066 726f 6d20 7468 650a 2020 2020  ss from the.    
-00021170: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
-00021180: 7761 7264 2e20 5765 2063 616e 2066 6c61  ward. We can fla
-00021190: 7474 656e 2061 6e64 2066 696c 7465 7220  tten and filter 
-000211a0: 7468 6520 7361 7665 645f 666f 725f 6261  the saved_for_ba
-000211b0: 636b 7761 7264 0a20 2020 2063 6f6e 7375  ckward.    consu
-000211c0: 6d65 7273 203d 2075 7469 6c73 2e63 6f6e  mers = utils.con
-000211d0: 7375 6d65 7273 2862 6163 6b77 6172 645f  sumers(backward_
-000211e0: 7472 6163 6529 0a0a 2020 2020 2320 466f  trace)..    # Fo
-000211f0: 7277 6172 6427 7320 616e 6420 6261 636b  rward's and back
-00021200: 7761 7264 2773 2022 7361 7665 645f 666f  ward's "saved_fo
-00021210: 725f 6261 636b 7761 7264 2220 6172 6520  r_backward" are 
-00021220: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
-00021230: 7468 6520 7361 6d65 0a20 2020 2023 2061  the same.    # a
-00021240: 7320 7468 6520 7361 7665 645f 666f 725f  s the saved_for_
-00021250: 6261 636b 7761 7264 2c20 6265 6361 7573  backward, becaus
-00021260: 6520 736f 6d65 206f 7220 616c 6c20 656c  e some or all el
-00021270: 656d 656e 7473 206f 6620 7468 650a 2020  ements of the.  
-00021280: 2020 2320 7361 7665 645f 666f 725f 6261    # saved_for_ba
-00021290: 636b 7761 7264 2072 6573 756c 7473 206d  ckward results m
-000212a0: 6967 6874 2062 6520 7265 2d70 726f 7869  ight be re-proxi
-000212b0: 6669 6564 2e0a 2020 2020 6277 5f66 6c61  fied..    bw_fla
-000212c0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
-000212d0: 7761 7264 2c20 7370 6563 203d 2074 7265  ward, spec = tre
-000212e0: 655f 666c 6174 7465 6e28 6261 636b 7761  e_flatten(backwa
-000212f0: 7264 5f74 7261 6365 2e61 7267 735b 305d  rd_trace.args[0]
-00021300: 290a 2020 2020 6677 5f66 6c61 745f 7361  ).    fw_flat_sa
-00021310: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00021320: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
-00021330: 656e 2866 6f72 7761 7264 5f74 7261 6365  en(forward_trace
-00021340: 2e6f 7574 7075 745b 315d 290a 2020 2020  .output[1]).    
-00021350: 7573 6564 5f6d 6173 6b20 3d20 6c69 7374  used_mask = list
-00021360: 286c 656e 2863 6f6e 7375 6d65 7273 2e67  (len(consumers.g
-00021370: 6574 2878 2c20 2829 2929 203e 2030 2066  et(x, ())) > 0 f
-00021380: 6f72 2078 2069 6e20 6277 5f66 6c61 745f  or x in bw_flat_
-00021390: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-000213a0: 7264 290a 0a20 2020 2023 2044 6f6e 2774  rd)..    # Don't
-000213b0: 2075 7365 2074 6865 2073 616d 6520 7661   use the same va
-000213c0: 7269 6162 6c65 2074 7769 6365 2069 6e20  riable twice in 
-000213d0: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
-000213e0: 730a 2020 2020 7365 656e 203d 2073 6574  s.    seen = set
-000213f0: 2829 0a20 2020 2066 726f 6d20 7468 756e  ().    from thun
-00021400: 6465 722e 636f 7265 2e70 726f 7869 6573  der.core.proxies
-00021410: 2069 6d70 6f72 7420 5661 7269 6162 6c65   import Variable
-00021420: 0a0a 2020 2020 666f 7220 692c 2078 2069  ..    for i, x i
-00021430: 6e20 656e 756d 6572 6174 6528 6677 5f66  n enumerate(fw_f
-00021440: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
-00021450: 636b 7761 7264 293a 0a20 2020 2020 2020  ckward):.       
-00021460: 2078 203d 2076 6172 6961 626c 6569 6679   x = variableify
-00021470: 2878 290a 2020 2020 2020 2020 6966 206e  (x).        if n
-00021480: 6f74 2069 7369 6e73 7461 6e63 6528 782c  ot isinstance(x,
-00021490: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
-000214a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-000214b0: 0a20 2020 2020 2020 2069 6620 7820 696e  .        if x in
-000214c0: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
-000214d0: 2020 2075 7365 645f 6d61 736b 5b69 5d20     used_mask[i] 
-000214e0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-000214f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00021500: 2020 7365 656e 2e61 6464 2878 290a 0a20    seen.add(x).. 
-00021510: 2020 206f 6e6c 795f 7573 6564 5f66 775f     only_used_fw_
-00021520: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00021530: 7264 203d 2074 7570 6c65 2863 6f6d 7072  rd = tuple(compr
-00021540: 6573 7328 6677 5f66 6c61 745f 7361 7665  ess(fw_flat_save
-00021550: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-00021560: 7573 6564 5f6d 6173 6b29 290a 2020 2020  used_mask)).    
-00021570: 6f6e 6c79 5f75 7365 645f 6277 5f73 6176  only_used_bw_sav
-00021580: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00021590: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
-000215a0: 2862 775f 666c 6174 5f73 6176 6564 5f66  (bw_flat_saved_f
-000215b0: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
-000215c0: 645f 6d61 736b 2929 0a0a 2020 2020 2320  d_mask))..    # 
-000215d0: 5765 206e 6565 6420 746f 2075 7064 6174  We need to updat
-000215e0: 6520 7468 6520 7472 6163 6573 2077 6974  e the traces wit
-000215f0: 6820 7468 6520 6e65 7720 7361 7665 645f  h the new saved_
-00021600: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
-00021610: 205f 7570 6461 7465 5f66 6f72 7761 7264   _update_forward
-00021620: 5f77 6974 685f 6e65 775f 7361 7665 645f  _with_new_saved_
-00021630: 666f 725f 6261 636b 7761 7264 2866 6f72  for_backward(for
-00021640: 7761 7264 5f74 7261 6365 2c20 6f6e 6c79  ward_trace, only
-00021650: 5f75 7365 645f 6677 5f73 6176 6564 5f66  _used_fw_saved_f
-00021660: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
-00021670: 205f 7570 6461 7465 5f62 6163 6b77 6172   _update_backwar
-00021680: 645f 7769 7468 5f6e 6577 5f73 6176 6564  d_with_new_saved
-00021690: 5f66 6f72 5f62 6163 6b77 6172 6428 6261  _for_backward(ba
-000216a0: 636b 7761 7264 5f74 7261 6365 2c20 6f6e  ckward_trace, on
-000216b0: 6c79 5f75 7365 645f 6277 5f73 6176 6564  ly_used_bw_saved
-000216c0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
-000216d0: 2020 2066 6f72 7761 7264 5f74 7261 6365     forward_trace
-000216e0: 2e73 6574 5f70 726f 7665 6e61 6e63 6528  .set_provenance(
-000216f0: 5472 6163 6550 726f 7665 6e61 6e63 6528  TraceProvenance(
-00021700: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
-00021710: 7264 2070 6173 7322 2929 0a20 2020 2062  rd pass")).    b
-00021720: 6163 6b77 6172 645f 7472 6163 652e 7365  ackward_trace.se
-00021730: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
-00021740: 6365 5072 6f76 656e 616e 6365 2822 4261  ceProvenance("Ba
-00021750: 636b 7761 7264 2070 6173 7322 2929 0a20  ckward pass")). 
-00021760: 2020 2072 6574 7572 6e20 466f 7277 6172     return Forwar
-00021770: 6442 6163 6b77 6172 6454 7261 6365 7328  dBackwardTraces(
-00021780: 666f 7277 6172 645f 7472 6163 652c 2062  forward_trace, b
-00021790: 6163 6b77 6172 645f 7472 6163 6529 0a0a  ackward_trace)..
-000217a0: 0a23 2064 6f20 7765 2068 6170 7065 6e20  .# do we happen 
-000217b0: 746f 2077 616e 7420 746f 2072 6567 6973  to want to regis
-000217c0: 7465 7220 606c 746f 7263 6860 206f 7073  ter `ltorch` ops
-000217d0: 2073 7563 6820 6173 2060 6c74 6f72 6368   such as `ltorch
-000217e0: 2e6c 6179 6572 5f6e 6f72 6d60 2061 7320  .layer_norm` as 
-000217f0: 7765 6c6c 3f0a 6175 746f 6361 7374 5f69  well?.autocast_i
-00021800: 6d70 6c73 3a20 6469 6374 5b70 7269 6d73  mpls: dict[prims
-00021810: 2e50 7269 6d49 4473 2c20 4361 6c6c 6162  .PrimIDs, Callab
-00021820: 6c65 5d20 3d20 7b7d 0a0a 0a64 6566 2072  le] = {}...def r
-00021830: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
-00021840: 5f72 756c 6528 6f70 293a 0a20 2020 2064  _rule(op):.    d
-00021850: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
-00021860: 6329 3a0a 2020 2020 2020 2020 6175 746f  c):.        auto
-00021870: 6361 7374 5f69 6d70 6c73 5b6f 705d 203d  cast_impls[op] =
-00021880: 2066 756e 630a 2020 2020 2020 2020 7265   func.        re
-00021890: 7475 726e 2066 756e 630a 0a20 2020 2072  turn func..    r
-000218a0: 6574 7572 6e20 6465 636f 7261 746f 720a  eturn decorator.
-000218b0: 0a0a 6465 6620 6d61 7962 655f 646f 776e  ..def maybe_down
-000218c0: 6361 7374 5f74 6f28 6474 7970 652c 2061  cast_to(dtype, a
-000218d0: 7267 7329 3a0a 2020 2020 616c 6c6f 7765  rgs):.    allowe
-000218e0: 645f 646f 776e 6361 7374 5f74 7970 6573  d_downcast_types
-000218f0: 203d 2028 6474 7970 6573 2e66 6c6f 6174   = (dtypes.float
-00021900: 3136 2c20 6474 7970 6573 2e62 666c 6f61  16, dtypes.bfloa
-00021910: 7431 362c 2064 7479 7065 732e 666c 6f61  t16, dtypes.floa
-00021920: 7433 3229 0a0a 2020 2020 6465 6620 6d61  t32)..    def ma
-00021930: 705f 666e 2861 293a 0a20 2020 2020 2020  p_fn(a):.       
-00021940: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-00021950: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
-00021960: 6e64 2061 2e64 7479 7065 2069 6e20 616c  nd a.dtype in al
-00021970: 6c6f 7765 645f 646f 776e 6361 7374 5f74  lowed_downcast_t
-00021980: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
-00021990: 2020 7265 7475 726e 206d 6179 6265 5f63    return maybe_c
-000219a0: 6f6e 7665 7274 5f74 6f5f 6474 7970 6528  onvert_to_dtype(
-000219b0: 612c 2064 7479 7065 290a 2020 2020 2020  a, dtype).      
-000219c0: 2020 7265 7475 726e 2061 0a0a 2020 2020    return a..    
-000219d0: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
-000219e0: 6d61 705f 666e 2c20 6172 6773 290a 0a0a  map_fn, args)...
-000219f0: 4072 6567 6973 7465 725f 6175 746f 6361  @register_autoca
-00021a00: 7374 5f72 756c 6528 2274 6f72 6368 2e6d  st_rule("torch.m
-00021a10: 6174 6d75 6c22 290a 4072 6567 6973 7465  atmul").@registe
-00021a20: 725f 6175 746f 6361 7374 5f72 756c 6528  r_autocast_rule(
-00021a30: 7072 696d 732e 5072 696d 4944 732e 4d41  prims.PrimIDs.MA
-00021a40: 544d 554c 290a 6465 6620 6175 746f 6361  TMUL).def autoca
-00021a50: 7374 5f6d 6174 6d75 6c5f 7275 6c65 2861  st_matmul_rule(a
-00021a60: 2c20 622c 2064 7479 7065 293a 0a20 2020  , b, dtype):.   
-00021a70: 2022 2222 4175 746f 6361 7374 2072 756c   """Autocast rul
-00021a80: 6520 666f 7220 6d61 746d 756c 2222 220a  e for matmul""".
-00021a90: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
-00021aa0: 2e6d 6174 6d75 6c28 2a28 6d61 7962 655f  .matmul(*(maybe_
-00021ab0: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
-00021ac0: 652c 2028 612c 2062 2929 2929 0a0a 0a40  e, (a, b))))...@
-00021ad0: 7265 6769 7374 6572 5f61 7574 6f63 6173  register_autocas
-00021ae0: 745f 7275 6c65 2822 746f 7263 682e 6e6e  t_rule("torch.nn
-00021af0: 2e66 756e 6374 696f 6e61 6c2e 6c69 6e65  .functional.line
-00021b00: 6172 2229 0a40 7265 6769 7374 6572 5f61  ar").@register_a
-00021b10: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
-00021b20: 6d73 2e50 7269 6d49 4473 2e4c 494e 4541  ms.PrimIDs.LINEA
-00021b30: 5229 0a64 6566 2061 7574 6f63 6173 745f  R).def autocast_
-00021b40: 6c69 6e65 6172 5f72 756c 6528 612c 2077  linear_rule(a, w
-00021b50: 2c20 6269 6173 2c20 6474 7970 6529 3a0a  , bias, dtype):.
-00021b60: 2020 2020 6966 2062 6961 7320 6973 204e      if bias is N
-00021b70: 6f6e 653a 0a20 2020 2020 2020 2023 2044  one:.        # D
-00021b80: 6f6e 2774 2070 6173 7320 6062 6961 7360  on't pass `bias`
-00021b90: 2074 6f20 6d61 7962 655f 646f 776e 6361   to maybe_downca
-00021ba0: 7374 5f74 6f2e 0a20 2020 2020 2020 2064  st_to..        d
-00021bb0: 6f77 6e63 6173 745f 6172 6773 203d 206d  owncast_args = m
-00021bc0: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
-00021bd0: 2864 7479 7065 2c20 2861 2c20 7729 2920  (dtype, (a, w)) 
-00021be0: 2b20 2862 6961 732c 290a 2020 2020 656c  + (bias,).    el
-00021bf0: 7365 3a0a 2020 2020 2020 2020 646f 776e  se:.        down
-00021c00: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
-00021c10: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
-00021c20: 7970 652c 2028 612c 2077 2c20 6269 6173  ype, (a, w, bias
-00021c30: 2929 0a0a 2020 2020 7265 7475 726e 2070  ))..    return p
-00021c40: 7269 6d73 2e6c 696e 6561 7228 2a64 6f77  rims.linear(*dow
-00021c50: 6e63 6173 745f 6172 6773 290a 0a0a 4072  ncast_args)...@r
-00021c60: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
-00021c70: 5f72 756c 6528 2274 6f72 6368 2e6e 6e2e  _rule("torch.nn.
-00021c80: 6675 6e63 7469 6f6e 616c 2e73 6361 6c65  functional.scale
-00021c90: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
-00021ca0: 7465 6e74 696f 6e22 290a 6465 6620 6175  tention").def au
-00021cb0: 746f 6361 7374 5f73 6361 6c65 645f 646f  tocast_scaled_do
-00021cc0: 745f 7072 6f64 7563 745f 6174 7465 6e74  t_product_attent
-00021cd0: 696f 6e28 0a20 2020 2071 7565 7279 2c0a  ion(.    query,.
-00021ce0: 2020 2020 6b65 792c 0a20 2020 2076 616c      key,.    val
-00021cf0: 7565 2c0a 2020 2020 6174 746e 5f6d 6173  ue,.    attn_mas
-00021d00: 6b2c 0a20 2020 2064 726f 706f 7574 5f70  k,.    dropout_p
-00021d10: 2c0a 2020 2020 6973 5f63 6175 7361 6c2c  ,.    is_causal,
-00021d20: 0a20 2020 202a 2c0a 2020 2020 6474 7970  .    *,.    dtyp
-00021d30: 652c 0a20 2020 2073 6361 6c65 2c0a 293a  e,.    scale,.):
-00021d40: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00021d50: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
-00021d60: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
-00021d70: 745f 6174 7465 6e74 696f 6e0a 0a20 2020  t_attention..   
-00021d80: 2071 2c20 6b2c 2076 203d 206d 6179 6265   q, k, v = maybe
-00021d90: 5f64 6f77 6e63 6173 745f 746f 2864 7479  _downcast_to(dty
-00021da0: 7065 2c20 2871 7565 7279 2c20 6b65 792c  pe, (query, key,
-00021db0: 2076 616c 7565 2929 0a20 2020 2072 6574   value)).    ret
-00021dc0: 7572 6e20 7363 616c 6564 5f64 6f74 5f70  urn scaled_dot_p
-00021dd0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
-00021de0: 2871 2c20 6b2c 2076 2c20 6174 746e 5f6d  (q, k, v, attn_m
-00021df0: 6173 6b2c 2064 726f 706f 7574 5f70 2c20  ask, dropout_p, 
-00021e00: 6973 5f63 6175 7361 6c2c 2073 6361 6c65  is_causal, scale
-00021e10: 3d73 6361 6c65 290a 0a0a 6465 6620 6175  =scale)...def au
-00021e20: 746f 6361 7374 5f73 796d 626f 6c5f 6d61  tocast_symbol_ma
-00021e30: 7070 6572 2862 6f75 6e64 5f73 796d 626f  pper(bound_symbo
-00021e40: 6c3a 2042 6f75 6e64 5379 6d62 6f6c 496e  l: BoundSymbolIn
-00021e50: 7465 7266 6163 652c 2064 7479 7065 3a20  terface, dtype: 
-00021e60: 6474 7970 6573 2e64 7479 7065 293a 0a20  dtypes.dtype):. 
-00021e70: 2020 2022 2222 5265 7475 726e 2074 6865     """Return the
-00021e80: 2063 616c 6c61 626c 6520 696d 706c 656d   callable implem
-00021e90: 656e 7469 6e67 2074 6865 2061 7574 6f63  enting the autoc
-00021ea0: 6173 7420 7275 6c65 2066 6f72 2074 6865  ast rule for the
-00021eb0: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
-00021ec0: 6773 3a0a 2020 2020 2020 2020 626f 756e  gs:.        boun
-00021ed0: 645f 7379 6d62 6f6c 3a20 4d61 7070 6564  d_symbol: Mapped
-00021ee0: 2074 6f20 6974 7320 6175 746f 6361 7374   to its autocast
-00021ef0: 2072 756c 652e 0a0a 2020 2020 5265 7475   rule...    Retu
-00021f00: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-00021f10: 6c61 626c 653a 2054 6865 2063 616c 6c61  lable: The calla
-00021f20: 626c 6520 696d 706c 656d 656e 7469 6e67  ble implementing
-00021f30: 2074 6865 2061 7574 6f63 6173 7420 7275   the autocast ru
-00021f40: 6c65 2066 6f72 2074 6865 2073 796d 626f  le for the symbo
-00021f50: 6c2e 0a20 2020 2022 2222 0a20 2020 2061  l..    """.    a
-00021f60: 7574 6f63 6173 745f 696d 706c 3a20 4361  utocast_impl: Ca
-00021f70: 6c6c 6162 6c65 207c 204e 6f6e 6520 3d20  llable | None = 
-00021f80: 6175 746f 6361 7374 5f69 6d70 6c73 2e67  autocast_impls.g
-00021f90: 6574 2862 6f75 6e64 5f73 796d 626f 6c2e  et(bound_symbol.
-00021fa0: 7379 6d2e 6964 290a 2020 2020 7265 7475  sym.id).    retu
-00021fb0: 726e 2062 6f75 6e64 5f73 796d 626f 6c2e  rn bound_symbol.
-00021fc0: 7379 6d20 6966 2061 7574 6f63 6173 745f  sym if autocast_
-00021fd0: 696d 706c 2069 7320 4e6f 6e65 2065 6c73  impl is None els
-00021fe0: 6520 7061 7274 6961 6c28 6175 746f 6361  e partial(autoca
-00021ff0: 7374 5f69 6d70 6c2c 2064 7479 7065 3d64  st_impl, dtype=d
-00022000: 7479 7065 290a 0a0a 6465 6620 6175 746f  type)...def auto
-00022010: 6361 7374 2866 756e 633a 2043 616c 6c61  cast(func: Calla
-00022020: 626c 652c 2064 7479 7065 3a20 6474 7970  ble, dtype: dtyp
-00022030: 6573 2e64 7479 7065 293a 0a20 2020 2022  es.dtype):.    "
-00022040: 2222 5472 616e 7366 6f72 6d73 2061 2066  ""Transforms a f
-00022050: 756e 6374 696f 6e20 746f 2061 7574 6f63  unction to autoc
-00022060: 6173 7420 6365 7274 6169 6e20 6f70 6572  ast certain oper
-00022070: 6174 696f 6e73 2e0a 0a20 2020 2041 7267  ations...    Arg
-00022080: 733a 0a20 2020 2020 2020 2066 756e 633a  s:.        func:
-00022090: 2054 6865 2066 756e 6374 696f 6e20 746f   The function to
-000220a0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
-000220b0: 0a20 2020 2020 2020 2064 7479 7065 3a20  .        dtype: 
-000220c0: 5468 6520 6461 7461 2074 7970 6520 746f  The data type to
-000220d0: 2077 6869 6368 2061 7267 756d 656e 7473   which arguments
-000220e0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-000220f0: 206f 7220 7375 6220 6675 6e63 7469 6f6e   or sub function
-00022100: 7320 636f 756c 6420 6765 7420 6361 7374  s could get cast
-00022110: 2069 660a 2020 2020 2020 2020 2020 2020   if.            
-00022120: 7468 6579 2061 7265 2060 6474 7970 6573  they are `dtypes
-00022130: 2e66 6c6f 6174 3332 602e 0a0a 2020 2020  .float32`...    
-00022140: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00022150: 2043 616c 6c61 626c 653a 2054 6865 2074   Callable: The t
-00022160: 7261 6e73 666f 726d 6564 2066 756e 6374  ransformed funct
-00022170: 696f 6e0a 2020 2020 2222 220a 0a20 2020  ion.    """..   
-00022180: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00022190: 6365 2864 7479 7065 2c20 6474 7970 6573  ce(dtype, dtypes
-000221a0: 2e64 7479 7065 293a 0a20 2020 2020 2020  .dtype):.       
-000221b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000221c0: 7228 6622 6064 7479 7065 6020 6973 2065  r(f"`dtype` is e
-000221d0: 7870 6563 7465 6420 746f 2062 6520 6074  xpected to be `t
-000221e0: 6875 6e64 6572 2e64 7479 7065 2e64 7479  hunder.dtype.dty
-000221f0: 7065 6020 6275 7420 7b74 7970 6528 6474  pe` but {type(dt
-00022200: 7970 6529 7d22 290a 2020 2020 6966 2064  ype)}").    if d
-00022210: 7479 7065 206e 6f74 2069 6e20 7b64 7479  type not in {dty
-00022220: 7065 732e 666c 6f61 7431 362c 2064 7479  pes.float16, dty
-00022230: 7065 732e 6266 6c6f 6174 3136 7d3a 0a20  pes.bfloat16}:. 
-00022240: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00022250: 7565 4572 726f 7228 6622 6064 7479 7065  ueError(f"`dtype
-00022260: 6020 6973 2065 7870 6563 7465 6420 746f  ` is expected to
-00022270: 2062 6520 6569 7468 6572 2060 7468 756e   be either `thun
-00022280: 6465 722e 666c 6f61 7431 3660 206f 7220  der.float16` or 
-00022290: 6074 6875 6e64 6572 2e62 666c 6f61 7431  `thunder.bfloat1
-000222a0: 3660 2c20 6275 7420 7b64 7479 7065 7d22  6`, but {dtype}"
-000222b0: 290a 0a20 2020 2040 7772 6170 7328 6675  )..    @wraps(fu
-000222c0: 6e63 290a 2020 2020 6465 6620 7772 6170  nc).    def wrap
-000222d0: 7065 7228 2a61 7267 732c 202a 2a6b 7761  per(*args, **kwa
-000222e0: 7267 7329 3a0a 2020 2020 2020 2020 7472  rgs):.        tr
-000222f0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-00022300: 7472 6163 6528 2928 6675 6e63 2c20 2a61  trace()(func, *a
-00022310: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-00022320: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
-00022330: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
-00022340: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
-00022350: 2073 796d 626f 6c5f 6d61 7070 6572 3d70   symbol_mapper=p
-00022360: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
-00022370: 7379 6d62 6f6c 5f6d 6170 7065 722c 2064  symbol_mapper, d
-00022380: 7479 7065 3d64 7479 7065 2929 0a0a 2020  type=dtype))..  
-00022390: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
-000223a0: 0a                                       .
+000039e0: 6e73 666f 726d 280a 2020 2020 6366 6e3a  nsform(.    cfn:
+000039f0: 2043 616c 6c61 626c 652c 0a20 2020 202a   Callable,.    *
+00003a00: 2c0a 2020 2020 7472 616e 7366 6f72 6d3a  ,.    transform:
+00003a10: 2043 616c 6c61 626c 6520 7c20 4e6f 6e65   Callable | None
+00003a20: 203d 204e 6f6e 652c 0a20 2020 2065 6172   = None,.    ear
+00003a30: 6c79 5f74 7261 6e73 666f 726d 3a20 4361  ly_transform: Ca
+00003a40: 6c6c 6162 6c65 207c 204e 6f6e 6520 3d20  llable | None = 
+00003a50: 4e6f 6e65 2c0a 2020 2020 6469 7361 626c  None,.    disabl
+00003a60: 655f 746f 7263 685f 6175 746f 6772 6164  e_torch_autograd
+00003a70: 5f73 7570 706f 7274 3d46 616c 7365 2c0a  _support=False,.
+00003a80: 2920 2d3e 2043 616c 6c61 626c 653a 0a20  ) -> Callable:. 
+00003a90: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+00003aa0: 636f 6d6d 6f6e 2069 6d70 6f72 7420 5f63  common import _c
+00003ab0: 7265 6174 655f 6361 6c6c 6162 6c65 2c20  reate_callable, 
+00003ac0: 436f 6d70 696c 6544 6174 612c 2043 6f6d  CompileData, Com
+00003ad0: 7069 6c65 5374 6174 730a 0a20 2020 2063  pileStats..    c
+00003ae0: 643a 204e 6f6e 6520 7c20 416e 7920 3d20  d: None | Any = 
+00003af0: 6765 7461 7474 7228 6366 6e2c 2022 5f6c  getattr(cfn, "_l
+00003b00: 635f 6364 222c 204e 6f6e 6529 0a0a 2020  c_cd", None)..  
+00003b10: 2020 7574 696c 732e 6368 6563 6b28 6364    utils.check(cd
+00003b20: 2069 7320 6e6f 7420 4e6f 6e65 2c20 6c61   is not None, la
+00003b30: 6d62 6461 3a20 6622 4361 6e20 6f6e 6c79  mbda: f"Can only
+00003b40: 2074 7261 6e73 666f 726d 2063 6f6d 7069   transform compi
+00003b50: 6c65 6420 7468 756e 6465 7220 6675 6e63  led thunder func
+00003b60: 7469 6f6e 7322 290a 2020 2020 7574 696c  tions").    util
+00003b70: 732e 6368 6563 6b28 6973 696e 7374 616e  s.check(isinstan
+00003b80: 6365 2863 642c 2043 6f6d 7069 6c65 4461  ce(cd, CompileDa
+00003b90: 7461 292c 206c 616d 6264 613a 2066 2246  ta), lambda: f"F
+00003ba0: 6f75 6e64 2061 6e20 756e 6b6e 6f77 6e20  ound an unknown 
+00003bb0: 636f 6d70 696c 6520 6461 7461 2061 7474  compile data att
+00003bc0: 7269 6275 7465 207b 6364 7d22 290a 0a20  ribute {cd}").. 
+00003bd0: 2020 2061 7373 6572 7420 6364 2e75 7369     assert cd.usi
+00003be0: 6e67 5f6a 6974 206f 7220 6561 726c 795f  ng_jit or early_
+00003bf0: 7472 616e 7366 6f72 6d20 6973 204e 6f6e  transform is Non
+00003c00: 650a 2020 2020 6173 7365 7274 2074 7261  e.    assert tra
+00003c10: 6e73 666f 726d 2069 7320 6e6f 7420 4e6f  nsform is not No
+00003c20: 6e65 206f 7220 6561 726c 795f 7472 616e  ne or early_tran
+00003c30: 7366 6f72 6d20 6973 206e 6f74 204e 6f6e  sform is not Non
+00003c40: 650a 0a20 2020 2069 6620 6364 2e75 7369  e..    if cd.usi
+00003c50: 6e67 5f6a 6974 3a0a 2020 2020 2020 2020  ng_jit:.        
+00003c60: 6672 6f6d 2074 6875 6e64 6572 2069 6d70  from thunder imp
+00003c70: 6f72 7420 6a69 740a 0a20 2020 2020 2020  ort jit..       
+00003c80: 2065 6172 6c79 5f74 7261 6e73 666f 726d   early_transform
+00003c90: 7320 3d20 6366 6e2e 5f6c 635f 6561 726c  s = cfn._lc_earl
+00003ca0: 795f 7472 616e 7366 6f72 6d73 5b3a 5d0a  y_transforms[:].
+00003cb0: 2020 2020 2020 2020 6164 6469 7469 6f6e          addition
+00003cc0: 616c 5f74 7261 6e73 666f 726d 7320 3d20  al_transforms = 
+00003cd0: 6366 6e2e 5f6c 635f 7472 616e 7366 6f72  cfn._lc_transfor
+00003ce0: 6d73 5b3a 5d0a 2020 2020 2020 2020 6966  ms[:].        if
+00003cf0: 2065 6172 6c79 5f74 7261 6e73 666f 726d   early_transform
+00003d00: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00003d10: 2020 2020 2020 2020 2020 6561 726c 795f            early_
+00003d20: 7472 616e 7366 6f72 6d73 2e61 7070 656e  transforms.appen
+00003d30: 6428 6561 726c 795f 7472 616e 7366 6f72  d(early_transfor
+00003d40: 6d29 0a20 2020 2020 2020 2069 6620 7472  m).        if tr
+00003d50: 616e 7366 6f72 6d20 6973 206e 6f74 204e  ansform is not N
+00003d60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00003d70: 2061 6464 6974 696f 6e61 6c5f 7472 616e   additional_tran
+00003d80: 7366 6f72 6d73 2e61 7070 656e 6428 7472  sforms.append(tr
+00003d90: 616e 7366 6f72 6d29 0a20 2020 2020 2020  ansform).       
+00003da0: 206a 666e 203d 206a 6974 280a 2020 2020   jfn = jit(.    
+00003db0: 2020 2020 2020 2020 6364 2e66 6e2c 0a20          cd.fn,. 
+00003dc0: 2020 2020 2020 2020 2020 206c 616e 6763             langc
+00003dd0: 7478 3d63 642e 6c61 6e67 6374 782c 0a20  tx=cd.langctx,. 
+00003de0: 2020 2020 2020 2020 2020 2065 7865 6375             execu
+00003df0: 746f 7273 3d63 642e 6578 6563 7574 6f72  tors=cd.executor
+00003e00: 735f 6c69 7374 2c0a 2020 2020 2020 2020  s_list,.        
+00003e10: 2020 2020 7368 6172 705f 6564 6765 733d      sharp_edges=
+00003e20: 6364 2e73 6861 7270 5f65 6467 6573 2c0a  cd.sharp_edges,.
+00003e30: 2020 2020 2020 2020 2020 2020 2320 6361              # ca
+00003e40: 6368 652c 2069 6e74 6572 7072 6574 6174  che, interpretat
+00003e50: 696f 6e3f 0a20 2020 2020 2020 2020 2020  ion?.           
+00003e60: 2065 6172 6c79 5f74 7261 6e73 666f 726d   early_transform
+00003e70: 733d 6561 726c 795f 7472 616e 7366 6f72  s=early_transfor
+00003e80: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00003e90: 6164 6469 7469 6f6e 616c 5f74 7261 6e73  additional_trans
+00003ea0: 666f 726d 733d 6164 6469 7469 6f6e 616c  forms=additional
+00003eb0: 5f74 7261 6e73 666f 726d 732c 0a20 2020  _transforms,.   
+00003ec0: 2020 2020 2020 2020 2064 6973 6162 6c65           disable
+00003ed0: 5f74 6f72 6368 5f61 7574 6f67 7261 643d  _torch_autograd=
+00003ee0: 6364 2e64 6973 6162 6c65 5f74 6f72 6368  cd.disable_torch
+00003ef0: 5f61 7574 6f67 7261 645f 7375 7070 6f72  _autograd_suppor
+00003f00: 7420 6f72 2064 6973 6162 6c65 5f74 6f72  t or disable_tor
+00003f10: 6368 5f61 7574 6f67 7261 645f 7375 7070  ch_autograd_supp
+00003f20: 6f72 742c 0a20 2020 2020 2020 2020 2020  ort,.           
+00003f30: 202a 2a63 642e 636f 6d70 696c 655f 6f70   **cd.compile_op
+00003f40: 7469 6f6e 732c 0a20 2020 2020 2020 2029  tions,.        )
+00003f50: 0a20 2020 2020 2020 2066 726f 6d20 7468  .        from th
+00003f60: 756e 6465 7220 696d 706f 7274 2054 6875  under import Thu
+00003f70: 6e64 6572 4d6f 6475 6c65 0a0a 2020 2020  nderModule..    
+00003f80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00003f90: 6528 6a66 6e2c 2054 6875 6e64 6572 4d6f  e(jfn, ThunderMo
+00003fa0: 6475 6c65 293a 0a20 2020 2020 2020 2020  dule):.         
+00003fb0: 2020 206a 666e 2e5f 6f76 6572 7269 6465     jfn._override
+00003fc0: 7320 3d20 6366 6e2e 5f6f 7665 7272 6964  s = cfn._overrid
+00003fd0: 6573 0a20 2020 2020 2020 2072 6574 7572  es.        retur
+00003fe0: 6e20 6a66 6e0a 0a20 2020 2063 7320 3d20  n jfn..    cs = 
+00003ff0: 6765 7461 7474 7228 6366 6e2c 2022 5f6c  getattr(cfn, "_l
+00004000: 635f 6373 222c 204e 6f6e 6529 0a20 2020  c_cs", None).   
+00004010: 2069 6620 6373 2069 7320 4e6f 6e65 3a0a   if cs is None:.
+00004020: 2020 2020 2020 2020 6373 203d 2043 6f6d          cs = Com
+00004030: 7069 6c65 5374 6174 7328 290a 0a20 2020  pileStats()..   
+00004040: 2074 7261 6e73 666f 726d 7320 3d20 6366   transforms = cf
+00004050: 6e2e 5f6c 635f 7472 616e 7366 6f72 6d73  n._lc_transforms
+00004060: 202b 205b 7472 616e 7366 6f72 6d5d 0a20   + [transform]. 
+00004070: 2020 2070 6f74 7261 6e73 666f 726d 7320     potransforms 
+00004080: 3d20 6366 6e2e 5f6c 635f 706f 7374 5f6f  = cfn._lc_post_o
+00004090: 7074 696d 697a 6174 696f 6e5f 7472 616e  ptimization_tran
+000040a0: 7366 6f72 6d73 0a20 2020 2075 7369 6e67  sforms.    using
+000040b0: 5f67 7261 645f 7472 616e 7366 6f72 6d20  _grad_transform 
+000040c0: 3d20 6366 6e2e 5f75 7369 6e67 5f67 7261  = cfn._using_gra
+000040d0: 645f 7472 616e 7366 6f72 6d0a 0a20 2020  d_transform..   
+000040e0: 206e 6366 6e20 3d20 5f63 7265 6174 655f   ncfn = _create_
+000040f0: 6361 6c6c 6162 6c65 280a 2020 2020 2020  callable(.      
+00004100: 2020 6364 2c0a 2020 2020 2020 2020 6373    cd,.        cs
+00004110: 2c0a 2020 2020 2020 2020 7472 616e 7366  ,.        transf
+00004120: 6f72 6d73 3d74 7261 6e73 666f 726d 732c  orms=transforms,
+00004130: 0a20 2020 2020 2020 2070 6f73 745f 6f70  .        post_op
+00004140: 7469 6d69 7a61 7469 6f6e 5f74 7261 6e73  timization_trans
+00004150: 666f 726d 733d 706f 7472 616e 7366 6f72  forms=potransfor
+00004160: 6d73 2c0a 2020 2020 2020 2020 5f75 7369  ms,.        _usi
+00004170: 6e67 5f67 7261 645f 7472 616e 7366 6f72  ng_grad_transfor
+00004180: 6d3d 7573 696e 675f 6772 6164 5f74 7261  m=using_grad_tra
+00004190: 6e73 666f 726d 2c0a 2020 2020 290a 2020  nsform,.    ).  
+000041a0: 2020 7265 7475 726e 206e 6366 6e0a 0a0a    return ncfn...
+000041b0: 2320 544f 444f 2043 6f6e 7369 6465 7220  # TODO Consider 
+000041c0: 7265 6661 6374 6f72 696e 6720 7468 6973  refactoring this
+000041d0: 2077 6974 6820 7468 6520 6162 6f76 650a   with the above.
+000041e0: 2320 4865 6c70 6572 2066 756e 6374 696f  # Helper functio
+000041f0: 6e20 746f 2061 6464 2061 2070 6f73 742d  n to add a post-
+00004200: 6f70 7469 6d69 7a61 7469 6f6e 2074 7261  optimization tra
+00004210: 6e73 666f 726d 0a64 6566 2061 6464 5f70  nsform.def add_p
+00004220: 6f73 745f 6f70 7469 6d69 7a61 7469 6f6e  ost_optimization
+00004230: 5f74 7261 6e73 666f 726d 2863 666e 3a20  _transform(cfn: 
+00004240: 4361 6c6c 6162 6c65 2c20 7472 616e 7366  Callable, transf
+00004250: 6f72 6d3a 2043 616c 6c61 626c 6529 202d  orm: Callable) -
+00004260: 3e20 4361 6c6c 6162 6c65 3a0a 2020 2020  > Callable:.    
+00004270: 6672 6f6d 2074 6875 6e64 6572 2e63 6f6d  from thunder.com
+00004280: 6d6f 6e20 696d 706f 7274 205f 6372 6561  mon import _crea
+00004290: 7465 5f63 616c 6c61 626c 652c 2043 6f6d  te_callable, Com
+000042a0: 7069 6c65 4461 7461 2c20 436f 6d70 696c  pileData, Compil
+000042b0: 6553 7461 7473 0a0a 2020 2020 6364 3a20  eStats..    cd: 
+000042c0: 4e6f 6e65 207c 2041 6e79 203d 2067 6574  None | Any = get
+000042d0: 6174 7472 2863 666e 2c20 225f 6c63 5f63  attr(cfn, "_lc_c
+000042e0: 6422 2c20 4e6f 6e65 290a 0a20 2020 2075  d", None)..    u
+000042f0: 7469 6c73 2e63 6865 636b 2863 6420 6973  tils.check(cd is
+00004300: 206e 6f74 204e 6f6e 652c 206c 616d 6264   not None, lambd
+00004310: 613a 2066 2243 616e 206f 6e6c 7920 7472  a: f"Can only tr
+00004320: 616e 7366 6f72 6d20 636f 6d70 696c 6564  ansform compiled
+00004330: 2074 6875 6e64 6572 2066 756e 6374 696f   thunder functio
+00004340: 6e73 2229 0a20 2020 2075 7469 6c73 2e63  ns").    utils.c
+00004350: 6865 636b 2869 7369 6e73 7461 6e63 6528  heck(isinstance(
+00004360: 6364 2c20 436f 6d70 696c 6544 6174 6129  cd, CompileData)
+00004370: 2c20 6c61 6d62 6461 3a20 6622 466f 756e  , lambda: f"Foun
+00004380: 6420 616e 2075 6e6b 6e6f 776e 2063 6f6d  d an unknown com
+00004390: 7069 6c65 2064 6174 6120 6174 7472 6962  pile data attrib
+000043a0: 7574 6520 7b63 647d 2229 0a0a 2020 2020  ute {cd}")..    
+000043b0: 6373 203d 2043 6f6d 7069 6c65 5374 6174  cs = CompileStat
+000043c0: 7328 290a 2020 2020 7472 616e 7366 6f72  s().    transfor
+000043d0: 6d73 203d 2063 666e 2e5f 6c63 5f74 7261  ms = cfn._lc_tra
+000043e0: 6e73 666f 726d 730a 2020 2020 706f 7472  nsforms.    potr
+000043f0: 616e 7366 6f72 6d73 203d 2063 666e 2e5f  ansforms = cfn._
+00004400: 6c63 5f70 6f73 745f 6f70 7469 6d69 7a61  lc_post_optimiza
+00004410: 7469 6f6e 5f74 7261 6e73 666f 726d 7320  tion_transforms 
+00004420: 2b20 5b74 7261 6e73 666f 726d 5d0a 0a20  + [transform].. 
+00004430: 2020 206e 6366 6e20 3d20 5f63 7265 6174     ncfn = _creat
+00004440: 655f 6361 6c6c 6162 6c65 2863 642c 2063  e_callable(cd, c
+00004450: 732c 2074 7261 6e73 666f 726d 733d 7472  s, transforms=tr
+00004460: 616e 7366 6f72 6d73 2c20 706f 7374 5f6f  ansforms, post_o
+00004470: 7074 696d 697a 6174 696f 6e5f 7472 616e  ptimization_tran
+00004480: 7366 6f72 6d73 3d70 6f74 7261 6e73 666f  sforms=potransfo
+00004490: 726d 7329 0a20 2020 2072 6574 7572 6e20  rms).    return 
+000044a0: 6e63 666e 0a0a 0a23 2054 6865 206e 6f2d  ncfn...# The no-
+000044b0: 6f70 2074 7261 6e73 666f 726d 2e20 4120  op transform. A 
+000044c0: 7472 6976 6961 6c20 636f 6d70 6f73 6162  trivial composab
+000044d0: 6c65 2074 7261 6e73 666f 726d 2c20 6f6e  le transform, on
+000044e0: 6c79 2075 7365 6675 6c20 6173 2061 6e20  ly useful as an 
+000044f0: 6578 616d 706c 652e 0a64 6566 205f 6e6f  example..def _no
+00004500: 6f70 5f74 7261 6e73 666f 726d 2874 7261  op_transform(tra
+00004510: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
+00004520: 7267 7329 202d 3e20 5472 6163 653a 0a20  rgs) -> Trace:. 
+00004530: 2020 2073 7461 7274 5f74 696d 655f 6e73     start_time_ns
+00004540: 203d 2074 696d 652e 7469 6d65 5f6e 7328   = time.time_ns(
+00004550: 290a 2020 2020 6e6f 6f70 5f74 7261 6365  ).    noop_trace
+00004560: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
+00004570: 6163 6529 0a0a 2020 2020 7472 6163 6563  ace)..    tracec
+00004580: 7478 5f74 6f6b 3a20 416e 790a 2020 2020  tx_tok: Any.    
+00004590: 7472 793a 0a20 2020 2020 2020 2074 7261  try:.        tra
+000045a0: 6365 6374 785f 746f 6b20 3d20 7365 745f  cectx_tok = set_
+000045b0: 7472 6163 6563 7478 286e 6f6f 705f 7472  tracectx(noop_tr
+000045c0: 6163 6529 0a20 2020 2020 2020 2070 7269  ace).        pri
+000045d0: 6d73 2e63 6f6d 6d65 6e74 2822 5468 6973  ms.comment("This
+000045e0: 2063 6f6d 6d65 6e74 2061 6464 6564 2062   comment added b
+000045f0: 7920 7468 6520 6e6f 2d6f 7020 7472 616e  y the no-op tran
+00004600: 7366 6f72 6d22 290a 2020 2020 6669 6e61  sform").    fina
+00004610: 6c6c 793a 0a20 2020 2020 2020 2072 6573  lly:.        res
+00004620: 6574 5f74 7261 6365 6374 7828 7472 6163  et_tracectx(trac
+00004630: 6563 7478 5f74 6f6b 290a 0a20 2020 206e  ectx_tok)..    n
+00004640: 6f6f 705f 7472 6163 652e 626f 756e 645f  oop_trace.bound_
+00004650: 7379 6d62 6f6c 732e 6578 7465 6e64 2874  symbols.extend(t
+00004660: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+00004670: 6c73 290a 0a20 2020 2065 6e64 5f74 696d  ls)..    end_tim
+00004680: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
+00004690: 5f6e 7328 290a 2020 2020 656c 6170 7365  _ns().    elapse
+000046a0: 645f 7469 6d65 5f6e 7320 3d20 656e 645f  d_time_ns = end_
+000046b0: 7469 6d65 5f6e 7320 2d20 7374 6172 745f  time_ns - start_
+000046c0: 7469 6d65 5f6e 730a 2020 2020 656c 6170  time_ns.    elap
+000046d0: 7365 645f 7469 6d65 5f6d 696c 6c69 7320  sed_time_millis 
+000046e0: 3d20 656c 6170 7365 645f 7469 6d65 5f6e  = elapsed_time_n
+000046f0: 7320 2f2f 2031 3030 3030 3030 0a20 2020  s // 1000000.   
+00004700: 206e 6f6f 705f 7472 6163 652e 7365 745f   noop_trace.set_
+00004710: 7072 6f76 656e 616e 6365 2854 7261 6365  provenance(Trace
+00004720: 5072 6f76 656e 616e 6365 2866 224e 6f2d  Provenance(f"No-
+00004730: 6f70 2054 7261 6e73 666f 726d 2028 746f  op Transform (to
+00004740: 6f6b 207b 656c 6170 7365 645f 7469 6d65  ok {elapsed_time
+00004750: 5f6d 696c 6c69 737d 206d 696c 6c69 7365  _millis} millise
+00004760: 636f 6e64 7329 2229 290a 0a20 2020 2072  conds)"))..    r
+00004770: 6574 7572 6e20 6e6f 6f70 5f74 7261 6365  eturn noop_trace
+00004780: 0a0a 0a64 6566 206e 6f6f 7028 6366 6e3a  ...def noop(cfn:
+00004790: 2043 616c 6c61 626c 6529 202d 3e20 4361   Callable) -> Ca
+000047a0: 6c6c 6162 6c65 3a0a 2020 2020 7265 7475  llable:.    retu
+000047b0: 726e 2061 6464 5f74 7261 6e73 666f 726d  rn add_transform
+000047c0: 2863 666e 2c20 7472 616e 7366 6f72 6d3d  (cfn, transform=
+000047d0: 5f6e 6f6f 705f 7472 616e 7366 6f72 6d29  _noop_transform)
+000047e0: 0a0a 0a23 2054 6865 2063 6f6d 6d65 6e74  ...# The comment
+000047f0: 2066 7573 696f 6e73 2074 7261 6e73 666f   fusions transfo
+00004800: 726d 2e20 4a75 7374 2061 6464 7320 6120  rm. Just adds a 
+00004810: 636f 6d6d 656e 7420 6265 666f 7265 2061  comment before a
+00004820: 6e64 2061 6674 6572 2065 6163 6820 6675  nd after each fu
+00004830: 7369 6f6e 2e0a 2320 2020 5468 6973 2069  sion..#   This i
+00004840: 7320 616e 2065 7861 6d70 6c65 206f 6620  s an example of 
+00004850: 6120 706f 7374 2d6f 7074 696d 697a 6174  a post-optimizat
+00004860: 696f 6e20 7472 616e 7366 6f72 6d2e 0a64  ion transform..d
+00004870: 6566 205f 636f 6d6d 656e 745f 6675 7369  ef _comment_fusi
+00004880: 6f6e 735f 7472 616e 7366 6f72 6d28 7472  ons_transform(tr
+00004890: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+000048a0: 6172 6773 2920 2d3e 2054 7261 6365 3a0a  args) -> Trace:.
+000048b0: 2020 2020 7374 6172 745f 7469 6d65 5f6e      start_time_n
+000048c0: 7320 3d20 7469 6d65 2e74 696d 655f 6e73  s = time.time_ns
+000048d0: 2829 0a20 2020 2063 6f6d 6d65 6e74 6564  ().    commented
+000048e0: 5f74 7261 6365 203d 2066 726f 6d5f 7472  _trace = from_tr
+000048f0: 6163 6528 7472 6163 6529 0a0a 2020 2020  ace(trace)..    
+00004900: 6e62 7379 6d73 3a20 6c69 7374 5b42 6f75  nbsyms: list[Bou
+00004910: 6e64 5379 6d62 6f6c 5d20 3d20 5b5d 0a20  ndSymbol] = []. 
+00004920: 2020 2066 6f72 2062 7379 6d20 696e 2074     for bsym in t
+00004930: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+00004940: 6c73 3a0a 2020 2020 2020 2020 6966 2062  ls:.        if b
+00004950: 7379 6d2e 7379 6d2e 6973 5f66 7573 696f  sym.sym.is_fusio
+00004960: 6e3a 0a20 2020 2020 2020 2020 2020 2066  n:.            f
+00004970: 7573 696f 6e5f 6e61 6d65 203d 2062 7379  usion_name = bsy
+00004980: 6d2e 7379 6d2e 6e61 6d65 0a20 2020 2020  m.sym.name.     
+00004990: 2020 2020 2020 2070 7265 5f63 6f6d 6d65         pre_comme
+000049a0: 6e74 5f62 7379 6d20 3d20 7072 696d 732e  nt_bsym = prims.
+000049b0: 636f 6d6d 656e 742e 6269 6e64 2866 2242  comment.bind(f"B
+000049c0: 6566 6f72 6520 7b66 7573 696f 6e5f 6e61  efore {fusion_na
+000049d0: 6d65 7d22 2c20 6f75 7470 7574 3d4e 6f6e  me}", output=Non
+000049e0: 6529 0a20 2020 2020 2020 2020 2020 2070  e).            p
+000049f0: 6f73 745f 636f 6d6d 656e 745f 6273 796d  ost_comment_bsym
+00004a00: 203d 2070 7269 6d73 2e63 6f6d 6d65 6e74   = prims.comment
+00004a10: 2e62 696e 6428 6622 4166 7465 7220 7b66  .bind(f"After {f
+00004a20: 7573 696f 6e5f 6e61 6d65 7d22 2c20 6f75  usion_name}", ou
+00004a30: 7470 7574 3d4e 6f6e 6529 0a0a 2020 2020  tput=None)..    
+00004a40: 2020 2020 2020 2020 6e62 7379 6d73 2e65          nbsyms.e
+00004a50: 7874 656e 6428 5b70 7265 5f63 6f6d 6d65  xtend([pre_comme
+00004a60: 6e74 5f62 7379 6d2c 2062 7379 6d2c 2070  nt_bsym, bsym, p
+00004a70: 6f73 745f 636f 6d6d 656e 745f 6273 796d  ost_comment_bsym
+00004a80: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
+00004a90: 0a20 2020 2020 2020 2020 2020 206e 6273  .            nbs
+00004aa0: 796d 732e 6170 7065 6e64 2862 7379 6d29  yms.append(bsym)
+00004ab0: 0a0a 2020 2020 636f 6d6d 656e 7465 645f  ..    commented_
+00004ac0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+00004ad0: 6f6c 7320 3d20 6e62 7379 6d73 0a20 2020  ols = nbsyms.   
+00004ae0: 2065 6e64 5f74 696d 655f 6e73 203d 2074   end_time_ns = t
+00004af0: 696d 652e 7469 6d65 5f6e 7328 290a 2020  ime.time_ns().  
+00004b00: 2020 656c 6170 7365 645f 7469 6d65 5f6e    elapsed_time_n
+00004b10: 7320 3d20 656e 645f 7469 6d65 5f6e 7320  s = end_time_ns 
+00004b20: 2d20 7374 6172 745f 7469 6d65 5f6e 730a  - start_time_ns.
+00004b30: 2020 2020 656c 6170 7365 645f 7469 6d65      elapsed_time
+00004b40: 5f6d 696c 6c69 7320 3d20 656c 6170 7365  _millis = elapse
+00004b50: 645f 7469 6d65 5f6e 7320 2f2f 2031 3030  d_time_ns // 100
+00004b60: 3030 3030 0a0a 2020 2020 636f 6d6d 656e  0000..    commen
+00004b70: 7465 645f 7472 6163 652e 7365 745f 7072  ted_trace.set_pr
+00004b80: 6f76 656e 616e 6365 2854 7261 6365 5072  ovenance(TracePr
+00004b90: 6f76 656e 616e 6365 2866 2243 6f6d 6d65  ovenance(f"Comme
+00004ba0: 6e74 2046 7573 696f 6e73 2028 746f 6f6b  nt Fusions (took
+00004bb0: 207b 656c 6170 7365 645f 7469 6d65 5f6d   {elapsed_time_m
+00004bc0: 696c 6c69 737d 206d 696c 6c69 7365 636f  illis} milliseco
+00004bd0: 6e64 7329 2229 290a 0a20 2020 2072 6574  nds)"))..    ret
+00004be0: 7572 6e20 636f 6d6d 656e 7465 645f 7472  urn commented_tr
+00004bf0: 6163 650a 0a0a 6465 6620 636f 6d6d 656e  ace...def commen
+00004c00: 745f 6675 7369 6f6e 7328 6366 6e3a 2043  t_fusions(cfn: C
+00004c10: 616c 6c61 626c 6529 202d 3e20 4361 6c6c  allable) -> Call
+00004c20: 6162 6c65 3a0a 2020 2020 7265 7475 726e  able:.    return
+00004c30: 2061 6464 5f70 6f73 745f 6f70 7469 6d69   add_post_optimi
+00004c40: 7a61 7469 6f6e 5f74 7261 6e73 666f 726d  zation_transform
+00004c50: 2863 666e 2c20 5f63 6f6d 6d65 6e74 5f66  (cfn, _comment_f
+00004c60: 7573 696f 6e73 5f74 7261 6e73 666f 726d  usions_transform
+00004c70: 290a 0a0a 230a 2320 4865 6c70 6572 2066  )...#.# Helper f
+00004c80: 756e 6374 696f 6e73 2066 6f72 2063 6f6d  unctions for com
+00004c90: 706f 7361 626c 6520 7472 616e 7366 6f72  posable transfor
+00004ca0: 6d73 0a23 0a0a 0a23 2046 6c61 7474 656e  ms.#...# Flatten
+00004cb0: 7320 6120 6c69 7374 206f 6620 626f 756e  s a list of boun
+00004cc0: 6420 7379 6d62 6f6c 732c 2072 6574 7572  d symbols, retur
+00004cd0: 6e69 6e67 2074 6865 2066 6c61 7474 656e  ning the flatten
+00004ce0: 6564 206c 6973 740a 6465 6620 666c 6174  ed list.def flat
+00004cf0: 7465 6e5f 666f 725f 7472 616e 7366 6f72  ten_for_transfor
+00004d00: 6d28 7368 6f75 6c64 5f66 6c61 7474 656e  m(should_flatten
+00004d10: 3a20 4361 6c6c 6162 6c65 2c20 6273 796d  : Callable, bsym
+00004d20: 733a 206c 6973 745b 426f 756e 6453 796d  s: list[BoundSym
+00004d30: 626f 6c5d 2920 2d3e 206c 6973 745b 426f  bol]) -> list[Bo
+00004d40: 756e 6453 796d 626f 6c5d 3a0a 2020 2020  undSymbol]:.    
+00004d50: 666c 6174 7465 6e65 643a 206c 6973 745b  flattened: list[
+00004d60: 426f 756e 6453 796d 626f 6c5d 203d 205b  BoundSymbol] = [
+00004d70: 5d0a 0a20 2020 2064 6566 205f 666c 6174  ]..    def _flat
+00004d80: 7465 6e28 6273 796d 3a20 426f 756e 6453  ten(bsym: BoundS
+00004d90: 796d 626f 6c29 3a0a 2020 2020 2020 2020  ymbol):.        
+00004da0: 6966 2073 686f 756c 645f 666c 6174 7465  if should_flatte
+00004db0: 6e28 6273 796d 293a 0a20 2020 2020 2020  n(bsym):.       
+00004dc0: 2020 2020 2063 6865 636b 280a 2020 2020       check(.    
+00004dd0: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+00004de0: 6273 796d 2e73 7562 7379 6d62 6f6c 7329  bsym.subsymbols)
+00004df0: 203e 2030 2c0a 2020 2020 2020 2020 2020   > 0,.          
+00004e00: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+00004e10: 4e6f 2067 7261 6420 7275 6c65 2066 6f75  No grad rule fou
+00004e20: 6e64 2066 6f72 207b 6273 796d 7d20 616e  nd for {bsym} an
+00004e30: 6420 6e6f 2073 7562 7379 6d62 6f6c 7320  d no subsymbols 
+00004e40: 696e 7369 6465 2069 7420 746f 2063 7265  inside it to cre
+00004e50: 6174 6520 6120 6772 6164 2066 6f72 6d75  ate a grad formu
+00004e60: 6c61 222c 0a20 2020 2020 2020 2020 2020  la",.           
+00004e70: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
+00004e80: 6f72 2073 6273 796d 2069 6e20 6273 796d  or sbsym in bsym
+00004e90: 2e73 7562 7379 6d62 6f6c 733a 0a20 2020  .subsymbols:.   
+00004ea0: 2020 2020 2020 2020 2020 2020 205f 666c               _fl
+00004eb0: 6174 7465 6e28 7362 7379 6d29 0a20 2020  atten(sbsym).   
+00004ec0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00004ed0: 2020 2020 2020 2066 6c61 7474 656e 6564         flattened
+00004ee0: 2e61 7070 656e 6428 6273 796d 290a 0a20  .append(bsym).. 
+00004ef0: 2020 2066 6f72 2062 7379 6d20 696e 2062     for bsym in b
+00004f00: 7379 6d73 3a0a 2020 2020 2020 2020 5f66  syms:.        _f
+00004f10: 6c61 7474 656e 2862 7379 6d29 0a0a 2020  latten(bsym)..  
+00004f20: 2020 7265 7475 726e 2066 6c61 7474 656e    return flatten
+00004f30: 6564 0a0a 0a23 0a23 2050 6861 6e74 6f6d  ed...#.# Phantom
+00004f40: 2067 7261 6420 7472 616e 7366 6f72 6d0a   grad transform.
+00004f50: 230a 0a23 0a23 2046 756e 6374 696f 6e73  #..#.# Functions
+00004f60: 2072 656c 6174 6564 2074 6f20 6675 6e63   related to func
+00004f70: 7469 6f6e 616c 697a 696e 6720 5468 756e  tionalizing Thun
+00004f80: 6465 724f 7074 696d 697a 6564 4d6f 6475  derOptimizedModu
+00004f90: 6c65 730a 230a 0a0a 2320 544f 444f 2054  les.#...# TODO T
+00004fa0: 6573 7420 7769 7468 2062 7566 6665 7273  est with buffers
+00004fb0: 0a64 6566 2070 6f70 756c 6174 655f 6772  .def populate_gr
+00004fc0: 6164 7328 6772 6164 733a 206c 6973 745b  ads(grads: list[
+00004fd0: 5465 6e73 6f72 5072 6f78 795d 2c20 746f  TensorProxy], to
+00004fe0: 6d3a 204e 6f6e 6520 7c20 746f 7263 682e  m: None | torch.
+00004ff0: 6e6e 2e4d 6f64 756c 6520 3d20 4e6f 6e65  nn.Module = None
+00005000: 2c20 6172 6773 3d4e 6f6e 652c 206b 7761  , args=None, kwa
+00005010: 7267 733d 4e6f 6e65 2920 2d3e 204e 6f6e  rgs=None) -> Non
+00005020: 653a 0a20 2020 2069 6478 3a20 696e 7420  e:.    idx: int 
+00005030: 3d20 300a 2020 2020 6672 6f6d 2074 6875  = 0.    from thu
+00005040: 6e64 6572 2069 6d70 6f72 7420 5468 756e  nder import Thun
+00005050: 6465 724d 6f64 756c 652c 2063 6f6d 7069  derModule, compi
+00005060: 6c65 5f64 6174 610a 0a20 2020 2069 6620  le_data..    if 
+00005070: 6973 696e 7374 616e 6365 2874 6f6d 2c20  isinstance(tom, 
+00005080: 5468 756e 6465 724d 6f64 756c 6529 206f  ThunderModule) o
+00005090: 7220 636f 6d70 696c 655f 6461 7461 2874  r compile_data(t
+000050a0: 6f6d 292e 7573 696e 675f 6a69 743a 0a20  om).using_jit:. 
+000050b0: 2020 2020 2020 2061 7373 6572 7420 6172         assert ar
+000050c0: 6773 2069 7320 6e6f 7420 4e6f 6e65 2c20  gs is not None, 
+000050d0: 2270 6f70 756c 6174 6520 6772 6164 206e  "populate grad n
+000050e0: 6565 6473 2061 7267 7320 2861 6e64 2070  eeds args (and p
+000050f0: 6f73 7369 626c 7920 6b77 6172 6773 2920  ossibly kwargs) 
+00005100: 746f 2077 6f72 6b20 7769 7468 2054 6875  to work with Thu
+00005110: 6e64 6572 4d6f 6475 6c65 7322 0a20 2020  nderModules".   
+00005120: 2020 2020 2069 6620 6b77 6172 6773 2069       if kwargs i
+00005130: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00005140: 2020 2020 6b77 6172 6773 203d 207b 7d0a      kwargs = {}.
+00005150: 2020 2020 2020 2020 5f2c 2063 6f6d 7075          _, compu
+00005160: 7461 7469 6f6e 5f69 6e70 7574 732c 205f  tation_inputs, _
+00005170: 203d 2063 6f6d 7069 6c65 5f64 6174 6128   = compile_data(
+00005180: 746f 6d29 2e67 6574 5f63 6f6d 7075 7461  tom).get_computa
+00005190: 7469 6f6e 5f61 6e64 5f69 6e70 7574 7328  tion_and_inputs(
+000051a0: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+000051b0: 0a20 2020 2020 2020 2066 6f72 2070 2069  .        for p i
+000051c0: 6e20 636f 6d70 7574 6174 696f 6e5f 696e  n computation_in
+000051d0: 7075 7473 3a0a 2020 2020 2020 2020 2020  puts:.          
+000051e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000051f0: 702c 2074 6f72 6368 2e54 656e 736f 7229  p, torch.Tensor)
+00005200: 2061 6e64 2070 2e72 6571 7569 7265 735f   and p.requires_
+00005210: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
+00005220: 2020 2020 2020 2320 5375 7070 6f72 7473        # Supports
+00005230: 2067 7261 6420 6163 6375 6d75 6c61 7469   grad accumulati
+00005240: 6f6e 2028 6c69 6b65 2077 6865 6e20 7765  on (like when we
+00005250: 6967 6874 2074 7969 6e67 290a 2020 2020  ight tying).    
+00005260: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00005270: 2e67 7261 6420 6973 206e 6f74 204e 6f6e  .grad is not Non
+00005280: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00005290: 2020 2020 2020 2070 2e67 7261 6420 2b3d         p.grad +=
+000052a0: 2067 7261 6473 5b69 6478 5d0a 2020 2020   grads[idx].    
+000052b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000052c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000052d0: 2020 2020 2020 702e 6772 6164 203d 2067        p.grad = g
+000052e0: 7261 6473 5b69 6478 5d0a 2020 2020 2020  rads[idx].      
+000052f0: 2020 2020 2020 2020 2020 6964 7820 2b3d            idx +=
+00005300: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
+00005310: 6e0a 0a20 2020 2023 2053 686f 7274 2d63  n..    # Short-c
+00005320: 6972 6375 6974 7320 6966 2074 6865 7265  ircuits if there
+00005330: 2061 7265 206e 6f20 6172 6773 206f 7220   are no args or 
+00005340: 6b77 6172 6773 0a20 2020 2069 6620 6172  kwargs.    if ar
+00005350: 6773 2069 7320 4e6f 6e65 2061 6e64 206b  gs is None and k
+00005360: 7761 7267 7320 6973 204e 6f6e 653a 0a20  wargs is None:. 
+00005370: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00005380: 2020 2066 6c61 7473 2c20 5f20 3d20 7472     flats, _ = tr
+00005390: 6565 5f66 6c61 7474 656e 2828 6172 6773  ee_flatten((args
+000053a0: 2c20 6b77 6172 6773 2929 0a20 2020 2066  , kwargs)).    f
+000053b0: 6f72 2066 2069 6e20 666c 6174 733a 0a20  or f in flats:. 
+000053c0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+000053d0: 616e 6365 2866 2c20 746f 7263 682e 5465  ance(f, torch.Te
+000053e0: 6e73 6f72 2920 616e 6420 662e 7265 7175  nsor) and f.requ
+000053f0: 6972 6573 5f67 7261 643a 0a20 2020 2020  ires_grad:.     
+00005400: 2020 2020 2020 2066 2e67 7261 6420 3d20         f.grad = 
+00005410: 6772 6164 735b 6964 785d 0a20 2020 2020  grads[idx].     
+00005420: 2020 2020 2020 2069 6478 202b 3d20 310a         idx += 1.
+00005430: 0a0a 6465 6620 6578 7472 6163 745f 6772  ..def extract_gr
+00005440: 6164 7328 6d6f 6475 6c65 3a20 746f 7263  ads(module: torc
+00005450: 682e 6e6e 2e4d 6f64 756c 6529 202d 3e20  h.nn.Module) -> 
+00005460: 7475 706c 655b 746f 7263 682e 5465 6e73  tuple[torch.Tens
+00005470: 6f72 2c20 2e2e 2e5d 3a0a 2020 2020 6772  or, ...]:.    gr
+00005480: 6164 7320 3d20 7475 706c 6528 0a20 2020  ads = tuple(.   
+00005490: 2020 2020 2066 2e67 7261 640a 2020 2020       f.grad.    
+000054a0: 2020 2020 666f 7220 6620 696e 2063 6861      for f in cha
+000054b0: 696e 286d 6f64 756c 652e 7061 7261 6d65  in(module.parame
+000054c0: 7465 7273 2829 2c20 6d6f 6475 6c65 2e62  ters(), module.b
+000054d0: 7566 6665 7273 2829 290a 2020 2020 2020  uffers()).      
+000054e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000054f0: 662c 2074 6f72 6368 2e54 656e 736f 7229  f, torch.Tensor)
+00005500: 2061 6e64 2066 2e72 6571 7569 7265 735f   and f.requires_
+00005510: 6772 6164 2061 6e64 2066 2e67 7261 6420  grad and f.grad 
+00005520: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00005530: 290a 2020 2020 7265 7475 726e 2067 7261  ).    return gra
+00005540: 6473 0a0a 0a64 6566 2063 6c65 6172 5f67  ds...def clear_g
+00005550: 7261 6473 286d 6f64 756c 653a 2074 6f72  rads(module: tor
+00005560: 6368 2e6e 6e2e 4d6f 6475 6c65 2920 2d3e  ch.nn.Module) ->
+00005570: 204e 6f6e 653a 0a20 2020 2069 6620 6e6f   None:.    if no
+00005580: 7420 6973 696e 7374 616e 6365 286d 6f64  t isinstance(mod
+00005590: 756c 652c 2074 6f72 6368 2e6e 6e2e 4d6f  ule, torch.nn.Mo
+000055a0: 6475 6c65 293a 0a20 2020 2020 2020 2072  dule):.        r
+000055b0: 6574 7572 6e0a 0a20 2020 2066 6f72 2070  eturn..    for p
+000055c0: 2069 6e20 6d6f 6475 6c65 2e70 6172 616d   in module.param
+000055d0: 6574 6572 7328 293a 0a20 2020 2020 2020  eters():.       
+000055e0: 2070 2e67 7261 6420 3d20 4e6f 6e65 0a20   p.grad = None. 
+000055f0: 2020 2066 6f72 2062 2069 6e20 6d6f 6475     for b in modu
+00005600: 6c65 2e62 7566 6665 7273 2829 3a0a 2020  le.buffers():.  
+00005610: 2020 2020 2020 622e 6772 6164 203d 204e        b.grad = N
+00005620: 6f6e 650a 0a0a 6672 6f6d 2074 6875 6e64  one...from thund
+00005630: 6572 2e63 6f72 652e 696e 7465 7270 7265  er.core.interpre
+00005640: 7465 7220 696d 706f 7274 206d 616b 655f  ter import make_
+00005650: 6f70 6171 7565 0a66 726f 6d20 7468 756e  opaque.from thun
+00005660: 6465 722e 636f 7265 2e6c 616e 6763 7478  der.core.langctx
+00005670: 7320 696d 706f 7274 206c 616e 6763 7478  s import langctx
+00005680: 2c20 4c61 6e67 7561 6765 730a 0a0a 2320  , Languages...# 
+00005690: 544f 444f 2052 4331 2052 6570 6c61 6365  TODO RC1 Replace
+000056a0: 2077 6974 6820 6c61 6e67 6374 780a 6465   with langctx.de
+000056b0: 6620 746f 7263 6863 7478 2866 6e29 3a0a  f torchctx(fn):.
+000056c0: 2020 2020 5f66 6e20 3d20 6c61 6e67 6374      _fn = langct
+000056d0: 7828 4c61 6e67 7561 6765 732e 544f 5243  x(Languages.TORC
+000056e0: 4829 2866 6e29 0a20 2020 2072 6574 7572  H)(fn).    retur
+000056f0: 6e20 6d61 6b65 5f6f 7061 7175 6528 5f66  n make_opaque(_f
+00005700: 6e29 0a0a 0a5f 6772 6164 5f66 6e5f 6d61  n)..._grad_fn_ma
+00005710: 703a 2064 6963 745b 416e 792c 2043 616c  p: dict[Any, Cal
+00005720: 6c61 626c 655d 203d 207b 7d0a 0a0a 6465  lable] = {}...de
+00005730: 6620 7265 6769 7374 6572 5f67 7261 6428  f register_grad(
+00005740: 7379 6d5f 6f72 5f69 643a 2053 796d 626f  sym_or_id: Symbo
+00005750: 6c20 7c20 416e 792c 2067 7261 6466 6e3a  l | Any, gradfn:
+00005760: 2043 616c 6c61 626c 6529 202d 3e20 4e6f   Callable) -> No
+00005770: 6e65 3a0a 2020 2020 6964 3a20 416e 7920  ne:.    id: Any 
+00005780: 3d20 7379 6d5f 6f72 5f69 640a 2020 2020  = sym_or_id.    
+00005790: 6966 2069 7369 6e73 7461 6e63 6528 7379  if isinstance(sy
+000057a0: 6d5f 6f72 5f69 642c 2053 796d 626f 6c29  m_or_id, Symbol)
+000057b0: 3a0a 2020 2020 2020 2020 6964 203d 2073  :.        id = s
+000057c0: 796d 5f6f 725f 6964 2e69 640a 2020 2020  ym_or_id.id.    
+000057d0: 5f67 7261 645f 666e 5f6d 6170 5b69 645d  _grad_fn_map[id]
+000057e0: 203d 2067 7261 6466 6e0a 0a0a 2320 4772   = gradfn...# Gr
+000057f0: 6164 2066 756e 6374 696f 6e73 2066 6f72  ad functions for
+00005800: 2070 7269 6d73 0a66 726f 6d20 7468 756e   prims.from thun
+00005810: 6465 722e 636f 7265 2e70 7269 6d73 2069  der.core.prims i
+00005820: 6d70 6f72 7420 5072 696d 4944 7320 6173  mport PrimIDs as
+00005830: 2070 6964 732c 2067 6574 5f67 7261 642c   pids, get_grad,
+00005840: 2070 7574 5f67 7261 640a 0a0a 2320 4120   put_grad...# A 
+00005850: 6765 6e65 7261 6c69 7a61 7469 6f6e 206f  generalization o
+00005860: 6620 7072 696d 732e 7075 745f 6772 6164  f prims.put_grad
+00005870: 2074 6f20 7079 7472 6565 730a 2320 544f   to pytrees.# TO
+00005880: 444f 2043 6f6e 7369 6465 7220 7661 6c69  DO Consider vali
+00005890: 6461 7469 6e67 2074 6861 7420 7468 6520  dating that the 
+000058a0: 7370 6563 7320 6172 6520 7468 6520 7361  specs are the sa
+000058b0: 6d65 0a23 2054 4f44 4f20 436f 6e73 6964  me.# TODO Consid
+000058c0: 6572 2076 616c 6964 6174 696e 6720 7468  er validating th
+000058d0: 6174 2074 6861 7420 6f62 6a65 6374 2072  at that object r
+000058e0: 6571 7569 7265 7320 6772 6164 2028 616e  equires grad (an
+000058f0: 6420 6669 6c74 6572 696e 6720 6f2e 772e  d filtering o.w.
+00005900: 290a 6465 6620 7075 745f 6772 6164 7328  ).def put_grads(
+00005910: 612c 2067 293a 0a20 2020 2066 6c61 7473  a, g):.    flats
+00005920: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
+00005930: 656e 2861 290a 2020 2020 666c 6174 6772  en(a).    flatgr
+00005940: 6164 732c 205f 203d 2074 7265 655f 666c  ads, _ = tree_fl
+00005950: 6174 7465 6e28 6729 0a0a 2020 2020 666f  atten(g)..    fo
+00005960: 7220 662c 2066 6720 696e 207a 6970 2866  r f, fg in zip(f
+00005970: 6c61 7473 2c20 666c 6174 6772 6164 7329  lats, flatgrads)
+00005980: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
+00005990: 6e73 7461 6e63 6528 662c 2054 656e 736f  nstance(f, Tenso
+000059a0: 7250 726f 7879 2920 616e 6420 6973 696e  rProxy) and isin
+000059b0: 7374 616e 6365 2866 672c 2054 656e 736f  stance(fg, Tenso
+000059c0: 7250 726f 7879 293a 0a20 2020 2020 2020  rProxy):.       
+000059d0: 2020 2020 2070 7574 5f67 7261 6428 662c       put_grad(f,
+000059e0: 2066 6729 0a0a 0a23 0a23 2055 6e70 6163   fg)...#.# Unpac
+000059f0: 6b69 6e67 206f 7065 7261 746f 7220 6772  king operator gr
+00005a00: 6164 730a 230a 0a23 204e 4f54 4520 7072  ads.#..# NOTE pr
+00005a10: 696d 732e 756e 7061 636b 5f65 6d70 7479  ims.unpack_empty
+00005a20: 5f64 6963 7420 6372 6561 7465 7320 6e6f  _dict creates no
+00005a30: 2067 7261 6420 6173 736f 6369 6174 696f   grad associatio
+00005a40: 6e73 0a72 6567 6973 7465 725f 6772 6164  ns.register_grad
+00005a50: 2870 6964 732e 554e 5041 434b 5f45 4d50  (pids.UNPACK_EMP
+00005a60: 5459 5f44 4943 542c 2070 7269 6d73 2e75  TY_DICT, prims.u
+00005a70: 6e70 6163 6b5f 656d 7074 795f 6469 6374  npack_empty_dict
+00005a80: 290a 0a23 204e 4f54 4520 7072 696d 732e  )..# NOTE prims.
+00005a90: 756e 7061 636b 5f6b 6579 2063 7265 6174  unpack_key creat
+00005aa0: 6573 206e 6f20 6772 6164 2061 7373 6f63  es no grad assoc
+00005ab0: 6961 7469 6f6e 730a 7265 6769 7374 6572  iations.register
+00005ac0: 5f67 7261 6428 7069 6473 2e55 4e50 4143  _grad(pids.UNPAC
+00005ad0: 4b5f 4b45 592c 2070 7269 6d73 2e75 6e70  K_KEY, prims.unp
+00005ae0: 6163 6b5f 6b65 7929 0a0a 2320 4e4f 5445  ack_key)..# NOTE
+00005af0: 2070 7269 6d73 2e75 6e70 6163 6b5f 7365   prims.unpack_se
+00005b00: 7175 656e 6365 2063 7265 6174 6573 206e  quence creates n
+00005b10: 6f20 6772 6164 2061 7373 6f63 6961 7469  o grad associati
+00005b20: 6f6e 730a 7265 6769 7374 6572 5f67 7261  ons.register_gra
+00005b30: 6428 7069 6473 2e55 4e50 4143 4b5f 5345  d(pids.UNPACK_SE
+00005b40: 5155 454e 4345 2c20 7072 696d 732e 756e  QUENCE, prims.un
+00005b50: 7061 636b 5f73 6571 7565 6e63 6529 0a0a  pack_sequence)..
+00005b60: 0a23 0a23 2044 6174 6120 6d6f 7665 6d65  .#.# Data moveme
+00005b70: 6e74 2061 6e64 2074 7261 6e73 666f 726d  nt and transform
+00005b80: 6174 696f 6e20 6f70 6572 6174 6f72 2067  ation operator g
+00005b90: 7261 6473 0a23 0a40 746f 7263 6863 7478  rads.#.@torchctx
+00005ba0: 0a64 6566 205f 636f 6e76 6572 745f 656c  .def _convert_el
+00005bb0: 656d 656e 745f 7479 7065 5f70 7269 6d5f  ement_type_prim_
+00005bc0: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
+00005bd0: 2054 656e 736f 7250 726f 7879 2c20 6474   TensorProxy, dt
+00005be0: 7970 653a 2074 7970 6520 7c20 6474 7970  ype: type | dtyp
+00005bf0: 6573 2e64 7479 7065 2920 2d3e 204e 756d  es.dtype) -> Num
+00005c00: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00005c10: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00005c20: 6d73 2e63 6f6e 7665 7274 5f65 6c65 6d65  ms.convert_eleme
+00005c30: 6e74 5f74 7970 6528 612c 2064 7479 7065  nt_type(a, dtype
+00005c40: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00005c50: 7261 6428 6677 6429 0a20 2020 2067 5f63  rad(fwd).    g_c
+00005c60: 6f6e 7665 7274 6564 203d 2070 7269 6d73  onverted = prims
+00005c70: 2e63 6f6e 7665 7274 5f65 6c65 6d65 6e74  .convert_element
+00005c80: 5f74 7970 6528 672c 2064 7479 7065 732e  _type(g, dtypes.
+00005c90: 746f 5f64 7479 7065 2861 2929 0a20 2020  to_dtype(a)).   
+00005ca0: 2070 7574 5f67 7261 6428 612c 2067 5f63   put_grad(a, g_c
+00005cb0: 6f6e 7665 7274 6564 290a 0a20 2020 2072  onverted)..    r
+00005cc0: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00005cd0: 7374 6572 5f67 7261 6428 7069 6473 2e43  ster_grad(pids.C
+00005ce0: 4f4e 5645 5254 5f45 4c45 4d45 4e54 5f54  ONVERT_ELEMENT_T
+00005cf0: 5950 452c 205f 636f 6e76 6572 745f 656c  YPE, _convert_el
+00005d00: 656d 656e 745f 7479 7065 5f70 7269 6d5f  ement_type_prim_
+00005d10: 6772 6164 290a 0a23 0a23 2054 656e 736f  grad)..#.# Tenso
+00005d20: 7220 6372 6561 7469 6f6e 206f 7065 7261  r creation opera
+00005d30: 746f 7220 6772 6164 730a 230a 0a23 204e  tor grads.#..# N
+00005d40: 4f54 4520 7072 696d 732e 6675 6c6c 2063  OTE prims.full c
+00005d50: 7265 6174 6573 206e 6f20 6772 6164 2061  reates no grad a
+00005d60: 7373 6f63 6961 7469 6f6e 730a 7265 6769  ssociations.regi
+00005d70: 7374 6572 5f67 7261 6428 7069 6473 2e46  ster_grad(pids.F
+00005d80: 554c 4c2c 2070 7269 6d73 2e66 756c 6c29  ULL, prims.full)
+00005d90: 0a0a 2320 4e4f 5445 2070 7269 6d73 2e69  ..# NOTE prims.i
+00005da0: 6f74 6120 6372 6561 7465 7320 6e6f 2067  ota creates no g
+00005db0: 7261 6420 6173 736f 6369 6174 696f 6e73  rad associations
+00005dc0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00005dd0: 6964 732e 494f 5441 2c20 7072 696d 732e  ids.IOTA, prims.
+00005de0: 696f 7461 290a 0a0a 6465 6620 5f75 6e69  iota)...def _uni
+00005df0: 666f 726d 5f67 7261 6428 7368 6170 652c  form_grad(shape,
+00005e00: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
+00005e10: 202a 2c20 6465 7669 6365 2c20 6474 7970   *, device, dtyp
+00005e20: 6529 3a0a 2020 2020 6677 642c 2073 6176  e):.    fwd, sav
+00005e30: 6564 203d 2075 6e69 666f 726d 5f61 7567  ed = uniform_aug
+00005e40: 5f66 7764 2873 6861 7065 2c20 6d69 6e76  _fwd(shape, minv
+00005e50: 616c 2c20 6d61 7876 616c 2c20 6465 7669  al, maxval, devi
+00005e60: 6365 3d64 6576 6963 652c 2064 7479 7065  ce=device, dtype
+00005e70: 3d64 7479 7065 290a 2020 2020 6720 3d20  =dtype).    g = 
+00005e80: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00005e90: 2020 5f2c 2067 6d69 6e76 616c 2c20 676d    _, gminval, gm
+00005ea0: 6178 7661 6c20 3d20 756e 6966 6f72 6d5f  axval = uniform_
+00005eb0: 6261 636b 7761 7264 282a 7361 7665 642c  backward(*saved,
+00005ec0: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
+00005ed0: 7328 286d 696e 7661 6c2c 206d 6178 7661  s((minval, maxva
+00005ee0: 6c29 2c20 2867 6d69 6e76 616c 2c20 676d  l), (gminval, gm
+00005ef0: 6178 7661 6c29 290a 2020 2020 7265 7475  axval)).    retu
+00005f00: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00005f10: 725f 6772 6164 2870 6964 732e 554e 4946  r_grad(pids.UNIF
+00005f20: 4f52 4d2c 205f 756e 6966 6f72 6d5f 6772  ORM, _uniform_gr
+00005f30: 6164 290a 0a23 0a23 2052 6573 6861 7069  ad)..#.# Reshapi
+00005f40: 6e67 2061 6e64 2070 6572 6d75 7469 6e67  ng and permuting
+00005f50: 206f 7065 7261 746f 7220 6772 6164 730a   operator grads.
+00005f60: 230a 0a0a 4074 6f72 6368 6374 780a 6465  #...@torchctx.de
+00005f70: 6620 5f62 726f 6164 6361 7374 5f69 6e5f  f _broadcast_in_
+00005f80: 6469 6d5f 7072 696d 5f67 7261 6428 0a20  dim_prim_grad(. 
+00005f90: 2020 2061 3a20 5465 6e73 6f72 5072 6f78     a: TensorProx
+00005fa0: 792c 2073 6861 7065 3a20 5365 7175 656e  y, shape: Sequen
+00005fb0: 6365 5b69 6e74 5d2c 2062 726f 6164 6361  ce[int], broadca
+00005fc0: 7374 5f64 696d 656e 7369 6f6e 733a 2053  st_dimensions: S
+00005fd0: 6571 7565 6e63 655b 696e 745d 0a29 202d  equence[int].) -
+00005fe0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00005ff0: 2020 2066 7764 203d 2070 7269 6d73 2e62     fwd = prims.b
+00006000: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
+00006010: 612c 2073 6861 7065 2c20 6272 6f61 6463  a, shape, broadc
+00006020: 6173 745f 6469 6d65 6e73 696f 6e73 290a  ast_dimensions).
+00006030: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00006040: 6428 6677 6429 0a0a 2020 2020 756e 6974  d(fwd)..    unit
+00006050: 5f64 696d 7320 3d20 7475 706c 6528 6920  _dims = tuple(i 
+00006060: 666f 7220 692c 2073 2069 6e20 656e 756d  for i, s in enum
+00006070: 6572 6174 6528 612e 7368 6170 6529 2069  erate(a.shape) i
+00006080: 6620 7320 3d3d 2031 290a 2020 2020 6263  f s == 1).    bc
+00006090: 6173 745f 6469 6d73 203d 2074 7570 6c65  ast_dims = tuple
+000060a0: 2862 2066 6f72 2069 2c20 6220 696e 2065  (b for i, b in e
+000060b0: 6e75 6d65 7261 7465 2862 726f 6164 6361  numerate(broadca
+000060c0: 7374 5f64 696d 656e 7369 6f6e 7329 2069  st_dimensions) i
+000060d0: 6620 6920 6e6f 7420 696e 2075 6e69 745f  f i not in unit_
+000060e0: 6469 6d73 290a 2020 2020 7265 6475 6365  dims).    reduce
+000060f0: 5f64 696d 7320 3d20 7475 706c 6528 7320  _dims = tuple(s 
+00006100: 666f 7220 692c 2073 2069 6e20 656e 756d  for i, s in enum
+00006110: 6572 6174 6528 7261 6e67 6528 6c65 6e28  erate(range(len(
+00006120: 7368 6170 6529 2929 2069 6620 6920 6e6f  shape))) if i no
+00006130: 7420 696e 2062 6361 7374 5f64 696d 7329  t in bcast_dims)
+00006140: 0a0a 2020 2020 6720 3d20 6c74 6f72 6368  ..    g = ltorch
+00006150: 2e73 756d 2867 2c20 7265 6475 6365 5f64  .sum(g, reduce_d
+00006160: 696d 7329 0a0a 2020 2020 2320 4e4f 5445  ims)..    # NOTE
+00006170: 2054 6869 7320 6d75 7374 2062 6520 636c   This must be cl
+00006180: 616e 672e 756e 7371 7565 657a 6520 6265  ang.unsqueeze be
+00006190: 6361 7573 6520 746f 7263 682e 756e 7371  cause torch.unsq
+000061a0: 7565 657a 652c 2075 6e6c 696b 6520 636c  ueeze, unlike cl
+000061b0: 616e 672e 756e 7371 7565 657a 652c 206f  ang.unsqueeze, o
+000061c0: 6e6c 7920 6163 6365 7074 7320 616e 2069  nly accepts an i
+000061d0: 6e74 6567 6572 0a20 2020 2023 2020 2028  nteger.    #   (
+000061e0: 7075 7420 616e 6f74 6865 7220 7761 792c  put another way,
+000061f0: 2074 6f72 6368 206f 6e6c 7920 616c 6c6f   torch only allo
+00006200: 7773 206f 6e65 2075 6e73 7175 6565 7a65  ws one unsqueeze
+00006210: 2061 7420 6120 7469 6d65 290a 2020 2020   at a time).    
+00006220: 6720 3d20 636c 616e 672e 756e 7371 7565  g = clang.unsque
+00006230: 657a 6528 672c 2075 6e69 745f 6469 6d73  eze(g, unit_dims
+00006240: 290a 0a20 2020 2070 7574 5f67 7261 6428  )..    put_grad(
+00006250: 612c 2067 290a 0a20 2020 2072 6574 7572  a, g)..    retur
+00006260: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+00006270: 5f67 7261 6428 7069 6473 2e42 524f 4144  _grad(pids.BROAD
+00006280: 4341 5354 5f49 4e5f 4449 4d2c 205f 6272  CAST_IN_DIM, _br
+00006290: 6f61 6463 6173 745f 696e 5f64 696d 5f70  oadcast_in_dim_p
+000062a0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+000062b0: 6368 6374 780a 6465 6620 5f63 6174 5f70  chctx.def _cat_p
+000062c0: 7269 6d5f 6772 6164 2874 656e 736f 7273  rim_grad(tensors
+000062d0: 3a20 6c69 7374 5b54 656e 736f 7250 726f  : list[TensorPro
+000062e0: 7879 5d2c 202f 2c20 6469 6d3a 2069 6e74  xy], /, dim: int
+000062f0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00006300: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00006310: 732e 6361 7428 7465 6e73 6f72 732c 2064  s.cat(tensors, d
+00006320: 696d 290a 0a20 2020 2067 203d 2067 6574  im)..    g = get
+00006330: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
+00006340: 736c 6963 655f 7374 6172 743a 2069 6e74  slice_start: int
+00006350: 203d 2030 0a20 2020 2074 3a20 5465 6e73   = 0.    t: Tens
+00006360: 6f72 5072 6f78 790a 2020 2020 666f 7220  orProxy.    for 
+00006370: 7420 696e 2074 656e 736f 7273 3a0a 2020  t in tensors:.  
+00006380: 2020 2020 2020 6469 6d5f 6c65 6e3a 2069        dim_len: i
+00006390: 6e74 203d 2074 2e73 6861 7065 5b64 696d  nt = t.shape[dim
+000063a0: 5d0a 2020 2020 2020 2020 736c 6963 655f  ].        slice_
+000063b0: 656e 643a 2069 6e74 203d 2073 6c69 6365  end: int = slice
+000063c0: 5f73 7461 7274 202b 2064 696d 5f6c 656e  _start + dim_len
+000063d0: 0a20 2020 2020 2020 2067 5f73 6c69 6365  .        g_slice
+000063e0: 3a20 5465 6e73 6f72 5072 6f78 7920 3d20  : TensorProxy = 
+000063f0: 636c 616e 672e 736c 6963 655f 696e 5f64  clang.slice_in_d
+00006400: 696d 2867 2c20 736c 6963 655f 7374 6172  im(g, slice_star
+00006410: 742c 2073 6c69 6365 5f65 6e64 2c20 6469  t, slice_end, di
+00006420: 6d3d 6469 6d29 0a20 2020 2020 2020 2073  m=dim).        s
+00006430: 6c69 6365 5f73 7461 7274 203d 2073 6c69  lice_start = sli
+00006440: 6365 5f65 6e64 0a20 2020 2020 2020 2070  ce_end.        p
+00006450: 7574 5f67 7261 6428 742c 2067 5f73 6c69  ut_grad(t, g_sli
+00006460: 6365 290a 0a20 2020 2072 6574 7572 6e20  ce)..    return 
+00006470: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00006480: 7261 6428 7069 6473 2e43 4154 2c20 5f63  rad(pids.CAT, _c
+00006490: 6174 5f70 7269 6d5f 6772 6164 290a 0a0a  at_prim_grad)...
+000064a0: 6465 6620 5f72 6573 6861 7065 5f70 7269  def _reshape_pri
+000064b0: 6d5f 6772 6164 2861 3a20 5465 6e73 6f72  m_grad(a: Tensor
+000064c0: 5072 6f78 792c 2073 6861 7065 3a20 7475  Proxy, shape: tu
+000064d0: 706c 655b 696e 742c 202e 2e2e 5d29 202d  ple[int, ...]) -
+000064e0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+000064f0: 2020 2066 7764 203d 2070 7269 6d73 2e72     fwd = prims.r
+00006500: 6573 6861 7065 2861 2c20 7368 6170 6529  eshape(a, shape)
+00006510: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
+00006520: 6164 2866 7764 290a 0a20 2020 2061 5f67  ad(fwd)..    a_g
+00006530: 7261 6420 3d20 7072 696d 732e 7265 7368  rad = prims.resh
+00006540: 6170 6528 672c 2061 2e73 6861 7065 290a  ape(g, a.shape).
+00006550: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00006560: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00006570: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00006580: 6572 5f67 7261 6428 7069 6473 2e52 4553  er_grad(pids.RES
+00006590: 4841 5045 2c20 5f72 6573 6861 7065 5f70  HAPE, _reshape_p
+000065a0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
+000065b0: 6368 6374 780a 6465 6620 5f73 6c69 6365  chctx.def _slice
+000065c0: 5f70 7269 6d5f 6772 6164 280a 2020 2020  _prim_grad(.    
+000065d0: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+000065e0: 7374 6172 745f 696e 6469 6365 733a 2053  start_indices: S
+000065f0: 6571 7565 6e63 655b 696e 745d 2c20 656e  equence[int], en
+00006600: 645f 696e 6469 6365 733a 2053 6571 7565  d_indices: Seque
+00006610: 6e63 655b 696e 745d 2c20 7374 7269 6465  nce[int], stride
+00006620: 733a 204e 6f6e 6520 7c20 5365 7175 656e  s: None | Sequen
+00006630: 6365 5b69 6e74 5d20 3d20 4e6f 6e65 0a29  ce[int] = None.)
+00006640: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
+00006650: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00006660: 2e73 6c69 6365 5f70 7269 6d28 612c 2073  .slice_prim(a, s
+00006670: 7461 7274 5f69 6e64 6963 6573 2c20 656e  tart_indices, en
+00006680: 645f 696e 6469 6365 732c 2073 7472 6964  d_indices, strid
+00006690: 6573 290a 0a20 2020 2067 203d 2067 6574  es)..    g = get
+000066a0: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
+000066b0: 7061 6464 696e 6720 3d20 4e6f 6e65 0a20  padding = None. 
+000066c0: 2020 2069 6620 7374 7269 6465 7320 6973     if strides is
+000066d0: 204e 6f6e 6520 6f72 206e 702e 616c 6c28   None or np.all(
+000066e0: 6e70 2e65 7175 616c 2873 7472 6964 6573  np.equal(strides
+000066f0: 2c20 3129 293a 0a20 2020 2020 2020 2070  , 1)):.        p
+00006700: 6164 6469 6e67 203d 2074 7570 6c65 287a  adding = tuple(z
+00006710: 6970 2873 7461 7274 5f69 6e64 6963 6573  ip(start_indices
+00006720: 2c20 6e70 2e73 7562 7472 6163 7428 612e  , np.subtract(a.
+00006730: 7368 6170 652c 2065 6e64 5f69 6e64 6963  shape, end_indic
+00006740: 6573 292c 2028 302c 2920 2a20 6c65 6e28  es), (0,) * len(
+00006750: 7374 6172 745f 696e 6469 6365 7329 2929  start_indices)))
+00006760: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00006770: 2020 2072 6561 6c5f 6c69 6d69 7473 203d     real_limits =
+00006780: 206e 702e 6164 6428 0a20 2020 2020 2020   np.add(.       
+00006790: 2020 2020 2073 7461 7274 5f69 6e64 6963       start_indic
+000067a0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+000067b0: 6e70 2e77 6865 7265 286e 702e 6571 7561  np.where(np.equa
+000067c0: 6c28 672e 7368 6170 652c 2030 292c 2030  l(g.shape, 0), 0
+000067d0: 2c20 6e70 2e61 6464 2831 2c20 6e70 2e6d  , np.add(1, np.m
+000067e0: 756c 7469 706c 7928 6e70 2e73 7562 7472  ultiply(np.subtr
+000067f0: 6163 7428 672e 7368 6170 652c 2031 292c  act(g.shape, 1),
+00006800: 2073 7472 6964 6573 2929 292c 0a20 2020   strides))),.   
+00006810: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
+00006820: 6164 6469 6e67 203d 2074 7570 6c65 287a  adding = tuple(z
+00006830: 6970 2873 7461 7274 5f69 6e64 6963 6573  ip(start_indices
+00006840: 2c20 6e70 2e73 7562 7472 6163 7428 612e  , np.subtract(a.
+00006850: 7368 6170 652c 2072 6561 6c5f 6c69 6d69  shape, real_limi
+00006860: 7473 292c 206e 702e 7375 6274 7261 6374  ts), np.subtract
+00006870: 2873 7472 6964 6573 2c20 3129 2929 0a0a  (strides, 1)))..
+00006880: 2020 2020 2320 436f 6e76 6572 7473 204e      # Converts N
+00006890: 756d 5079 206e 756d 6265 7273 2074 6f20  umPy numbers to 
+000068a0: 5079 7468 6f6e 2069 6e74 730a 2020 2020  Python ints.    
+000068b0: 2320 544f 444f 2053 686f 756c 6420 7765  # TODO Should we
+000068c0: 2073 7570 706f 7274 204e 756d 5079 206e   support NumPy n
+000068d0: 756d 6265 7273 2062 6574 7465 723f 0a20  umbers better?. 
+000068e0: 2020 2070 6164 6469 6e67 203d 2074 7265     padding = tre
+000068f0: 655f 6d61 7028 696e 742c 2070 6164 6469  e_map(int, paddi
+00006900: 6e67 290a 2020 2020 615f 6772 6164 203d  ng).    a_grad =
+00006910: 2070 7269 6d73 2e70 6164 2867 2c20 636f   prims.pad(g, co
+00006920: 6e73 745f 6173 2830 2c20 672e 6474 7970  nst_as(0, g.dtyp
+00006930: 6529 2c20 7061 6464 696e 6729 0a20 2020  e), padding).   
+00006940: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
+00006950: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+00006960: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+00006970: 6772 6164 2870 6964 732e 534c 4943 452c  grad(pids.SLICE,
+00006980: 205f 736c 6963 655f 7072 696d 5f67 7261   _slice_prim_gra
+00006990: 6429 0a0a 0a40 746f 7263 6863 7478 0a64  d)...@torchctx.d
+000069a0: 6566 205f 7371 7565 657a 655f 7072 696d  ef _squeeze_prim
+000069b0: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
+000069c0: 726f 7879 2c20 2f2c 2064 696d 733a 2074  roxy, /, dims: t
+000069d0: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 2920  uple[int, ...]) 
+000069e0: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
+000069f0: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
+00006a00: 7371 7565 657a 6528 612c 2074 7570 6c65  squeeze(a, tuple
+00006a10: 2864 696d 7329 290a 0a20 2020 2067 203d  (dims))..    g =
+00006a20: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
+00006a30: 2020 2023 204e 4f54 4520 5468 6973 2063     # NOTE This c
+00006a40: 616c 6c73 2063 6c61 6e67 2e75 6e73 7175  alls clang.unsqu
+00006a50: 6565 7a65 2c20 616e 6420 6e6f 7420 746f  eeze, and not to
+00006a60: 7263 682e 756e 7371 7565 657a 652c 2062  rch.unsqueeze, b
+00006a70: 6563 6175 7365 2074 6f72 6368 2e75 6e73  ecause torch.uns
+00006a80: 7175 6565 7a65 206f 6e6c 7920 7375 7070  queeze only supp
+00006a90: 6f72 7473 0a20 2020 2023 2020 2075 6e73  orts.    #   uns
+00006aa0: 7175 6565 7a69 6e67 2061 2073 696e 676c  queezing a singl
+00006ab0: 6520 6469 6d65 6e73 696f 6e0a 2020 2020  e dimension.    
+00006ac0: 615f 6772 6164 203d 2063 6c61 6e67 2e75  a_grad = clang.u
+00006ad0: 6e73 7175 6565 7a65 2867 2c20 6469 6d73  nsqueeze(g, dims
+00006ae0: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+00006af0: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00006b00: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00006b10: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
+00006b20: 5155 4545 5a45 2c20 5f73 7175 6565 7a65  QUEEZE, _squeeze
+00006b30: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
+00006b40: 6f72 6368 6374 780a 6465 6620 5f74 616b  orchctx.def _tak
+00006b50: 655f 7072 696d 5f67 7261 6428 613a 2054  e_prim_grad(a: T
+00006b60: 656e 736f 7250 726f 7879 2c20 696e 6465  ensorProxy, inde
+00006b70: 783a 2054 656e 736f 7250 726f 7879 2c20  x: TensorProxy, 
+00006b80: 6469 6d3a 2069 6e74 2920 2d3e 2054 656e  dim: int) -> Ten
+00006b90: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+00006ba0: 6420 3d20 7072 696d 732e 7461 6b65 2861  d = prims.take(a
+00006bb0: 2c20 696e 6465 782c 2064 696d 290a 0a20  , index, dim).. 
+00006bc0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00006bd0: 6677 6429 0a0a 2020 2020 2320 544f 444f  fwd)..    # TODO
+00006be0: 2053 7769 7463 6820 746f 206c 746f 7263   Switch to ltorc
+00006bf0: 682e 696e 6465 785f 6164 643f 0a20 2020  h.index_add?.   
+00006c00: 2023 204e 4f54 4520 496e 7465 6e74 696f   # NOTE Intentio
+00006c10: 6e61 6c6c 7920 6e6f 7420 6361 6c6c 696e  nally not callin
+00006c20: 6720 7a65 726f 735f 6c69 6b65 2074 6f20  g zeros_like to 
+00006c30: 6176 6f69 6420 7072 6573 6572 7669 6e67  avoid preserving
+00006c40: 2061 0a20 2020 2023 2054 4f44 4f20 5570   a.    # TODO Up
+00006c50: 6461 7465 2074 6f20 6361 6c6c 206c 746f  date to call lto
+00006c60: 7263 682e 7a65 726f 730a 2020 2020 7a65  rch.zeros.    ze
+00006c70: 726f 7320 3d20 7072 696d 732e 6675 6c6c  ros = prims.full
+00006c80: 2861 2e73 6861 7065 2c20 6669 6c6c 5f76  (a.shape, fill_v
+00006c90: 616c 7565 3d30 2c20 6465 7669 6365 3d61  alue=0, device=a
+00006ca0: 2e64 6576 6963 652c 2064 7479 7065 3d61  .device, dtype=a
+00006cb0: 2e64 7479 7065 290a 2020 2020 615f 6772  .dtype).    a_gr
+00006cc0: 6164 203d 2070 7269 6d73 2e69 6e64 6578  ad = prims.index
+00006cd0: 5f61 6464 287a 6572 6f73 2c20 696e 6465  _add(zeros, inde
+00006ce0: 782c 2067 2c20 6469 6d29 0a20 2020 2070  x, g, dim).    p
+00006cf0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+00006d00: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+00006d10: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00006d20: 6164 2870 6964 732e 5441 4b45 2c20 5f74  ad(pids.TAKE, _t
+00006d30: 616b 655f 7072 696d 5f67 7261 6429 0a0a  ake_prim_grad)..
+00006d40: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+00006d50: 6761 7468 6572 5f70 7269 6d5f 6772 6164  gather_prim_grad
+00006d60: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
+00006d70: 2069 6e64 6578 3a20 5465 6e73 6f72 5072   index: TensorPr
+00006d80: 6f78 792c 2064 696d 3a20 696e 7429 202d  oxy, dim: int) -
+00006d90: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00006da0: 2020 2066 7764 203d 2070 7269 6d73 2e67     fwd = prims.g
+00006db0: 6174 6865 7228 612c 2069 6e64 6578 2c20  ather(a, index, 
+00006dc0: 6469 6d29 0a0a 2020 2020 6720 3d20 6765  dim)..    g = ge
+00006dd0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00006de0: 2320 4e4f 5445 2049 6e74 656e 7469 6f6e  # NOTE Intention
+00006df0: 616c 6c79 206e 6f74 2063 616c 6c69 6e67  ally not calling
+00006e00: 207a 6572 6f73 5f6c 696b 6520 746f 2061   zeros_like to a
+00006e10: 766f 6964 2070 7265 7365 7276 696e 6720  void preserving 
+00006e20: 5465 6e73 6f72 5072 6f78 7920 612e 0a20  TensorProxy a.. 
+00006e30: 2020 2023 2054 4f44 4f20 5570 6461 7465     # TODO Update
+00006e40: 2074 6f20 6361 6c6c 206c 746f 7263 682e   to call ltorch.
+00006e50: 7a65 726f 730a 2020 2020 7a65 726f 7320  zeros.    zeros 
+00006e60: 3d20 7072 696d 732e 6675 6c6c 2861 2e73  = prims.full(a.s
+00006e70: 6861 7065 2c20 6669 6c6c 5f76 616c 7565  hape, fill_value
+00006e80: 3d30 2c20 6465 7669 6365 3d61 2e64 6576  =0, device=a.dev
+00006e90: 6963 652c 2064 7479 7065 3d61 2e64 7479  ice, dtype=a.dty
+00006ea0: 7065 290a 2020 2020 615f 6772 6164 203d  pe).    a_grad =
+00006eb0: 2070 7269 6d73 2e73 6361 7474 6572 5f61   prims.scatter_a
+00006ec0: 6464 287a 6572 6f73 2c20 696e 6465 782c  dd(zeros, index,
+00006ed0: 2067 2c20 6469 6d29 0a20 2020 2070 7574   g, dim).    put
+00006ee0: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
+00006ef0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00006f00: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00006f10: 2870 6964 732e 4741 5448 4552 2c20 5f67  (pids.GATHER, _g
+00006f20: 6174 6865 725f 7072 696d 5f67 7261 6429  ather_prim_grad)
+00006f30: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00006f40: 205f 7461 6b65 5f61 6c6f 6e67 5f61 7869   _take_along_axi
+00006f50: 735f 7072 696d 5f67 7261 6428 613a 2054  s_prim_grad(a: T
+00006f60: 656e 736f 7250 726f 7879 2c20 696e 6465  ensorProxy, inde
+00006f70: 783a 2054 656e 736f 7250 726f 7879 2c20  x: TensorProxy, 
+00006f80: 6469 6d3a 2069 6e74 2920 2d3e 2054 656e  dim: int) -> Ten
+00006f90: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+00006fa0: 6420 3d20 7072 696d 732e 7461 6b65 5f61  d = prims.take_a
+00006fb0: 6c6f 6e67 5f61 7869 7328 612c 2069 6e64  long_axis(a, ind
+00006fc0: 6578 2c20 6469 6d29 0a0a 2020 2020 6720  ex, dim)..    g 
+00006fd0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00006fe0: 2020 2020 2320 4e4f 5445 2049 6e74 656e      # NOTE Inten
+00006ff0: 7469 6f6e 616c 6c79 206e 6f74 2063 616c  tionally not cal
+00007000: 6c69 6e67 207a 6572 6f73 5f6c 696b 6520  ling zeros_like 
+00007010: 746f 2061 766f 6964 2070 7265 7365 7276  to avoid preserv
+00007020: 696e 6720 5465 6e73 6f72 5072 6f78 7920  ing TensorProxy 
+00007030: 612e 0a20 2020 2023 2054 4f44 4f20 5570  a..    # TODO Up
+00007040: 6461 7465 2074 6f20 6361 6c6c 206c 746f  date to call lto
+00007050: 7263 682e 7a65 726f 730a 2020 2020 7a65  rch.zeros.    ze
+00007060: 726f 7320 3d20 7072 696d 732e 6675 6c6c  ros = prims.full
+00007070: 2861 2e73 6861 7065 2c20 6669 6c6c 5f76  (a.shape, fill_v
+00007080: 616c 7565 3d30 2c20 6465 7669 6365 3d61  alue=0, device=a
+00007090: 2e64 6576 6963 652c 2064 7479 7065 3d61  .device, dtype=a
+000070a0: 2e64 7479 7065 290a 2020 2020 615f 6772  .dtype).    a_gr
+000070b0: 6164 203d 2070 7269 6d73 2e73 6361 7474  ad = prims.scatt
+000070c0: 6572 5f61 6464 287a 6572 6f73 2c20 696e  er_add(zeros, in
+000070d0: 6465 782c 2067 2c20 6469 6d29 0a20 2020  dex, g, dim).   
+000070e0: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
+000070f0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+00007100: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+00007110: 6772 6164 2870 6964 732e 5441 4b45 5f41  grad(pids.TAKE_A
+00007120: 4c4f 4e47 5f41 5849 532c 205f 7461 6b65  LONG_AXIS, _take
+00007130: 5f61 6c6f 6e67 5f61 7869 735f 7072 696d  _along_axis_prim
+00007140: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
+00007150: 7478 0a64 6566 205f 7472 616e 7370 6f73  tx.def _transpos
+00007160: 655f 7072 696d 5f67 7261 6428 613a 2054  e_prim_grad(a: T
+00007170: 656e 736f 7250 726f 7879 2c20 7065 726d  ensorProxy, perm
+00007180: 7574 6174 696f 6e3a 2074 7570 6c65 5b69  utation: tuple[i
+00007190: 6e74 2c20 2e2e 2e5d 2920 2d3e 2054 656e  nt, ...]) -> Ten
+000071a0: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+000071b0: 6420 3d20 7072 696d 732e 7472 616e 7370  d = prims.transp
+000071c0: 6f73 6528 612c 2074 7570 6c65 2870 6572  ose(a, tuple(per
+000071d0: 6d75 7461 7469 6f6e 2929 0a0a 2020 2020  mutation))..    
+000071e0: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+000071f0: 290a 2020 2020 756e 646f 203d 205f 6172  ).    undo = _ar
+00007200: 6773 6f72 7428 7065 726d 7574 6174 696f  gsort(permutatio
+00007210: 6e29 0a20 2020 2061 5f67 7261 6420 3d20  n).    a_grad = 
+00007220: 7072 696d 732e 7472 616e 7370 6f73 6528  prims.transpose(
+00007230: 672c 2074 7570 6c65 2875 6e64 6f29 290a  g, tuple(undo)).
+00007240: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00007250: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00007260: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00007270: 6572 5f67 7261 6428 7069 6473 2e54 5241  er_grad(pids.TRA
+00007280: 4e53 504f 5345 2c20 5f74 7261 6e73 706f  NSPOSE, _transpo
+00007290: 7365 5f70 7269 6d5f 6772 6164 290a 0a23  se_prim_grad)..#
+000072a0: 0a23 204d 656d 6f72 7920 6c61 796f 7574  .# Memory layout
+000072b0: 206f 7065 7261 746f 7220 6772 6164 730a   operator grads.
+000072c0: 230a 0a0a 4074 6f72 6368 6374 780a 6465  #...@torchctx.de
+000072d0: 6620 5f73 7472 6964 655f 6f72 6465 725f  f _stride_order_
+000072e0: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
+000072f0: 736f 7250 726f 7879 2c20 2f2c 206f 7264  sorProxy, /, ord
+00007300: 6572 3a20 5365 7175 656e 6365 5b69 6e74  er: Sequence[int
+00007310: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
+00007320: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00007330: 6d73 2e73 7472 6964 655f 6f72 6465 7228  ms.stride_order(
+00007340: 612c 206f 7264 6572 290a 0a20 2020 2067  a, order)..    g
+00007350: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00007360: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
+00007370: 2067 290a 0a20 2020 2072 6574 7572 6e20   g)..    return 
+00007380: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00007390: 7261 6428 7069 6473 2e53 5452 4944 455f  rad(pids.STRIDE_
+000073a0: 4f52 4445 522c 205f 7374 7269 6465 5f6f  ORDER, _stride_o
+000073b0: 7264 6572 5f70 7269 6d5f 6772 6164 290a  rder_prim_grad).
+000073c0: 0a0a 230a 2320 456c 656d 656e 7477 6973  ..#.# Elementwis
+000073d0: 6520 756e 6172 7920 6f70 6572 6174 6f72  e unary operator
+000073e0: 2067 7261 6473 0a23 0a40 746f 7263 6863   grads.#.@torchc
+000073f0: 7478 0a64 6566 205f 6162 735f 7072 696d  tx.def _abs_prim
+00007400: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
+00007410: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
+00007420: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
+00007430: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00007440: 3d20 7072 696d 732e 6162 7328 6129 0a0a  = prims.abs(a)..
+00007450: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007460: 2866 7764 290a 2020 2020 7075 745f 6772  (fwd).    put_gr
+00007470: 6164 2861 2c20 6720 2a20 6c74 6f72 6368  ad(a, g * ltorch
+00007480: 2e73 6967 6e28 6129 290a 0a20 2020 2072  .sign(a))..    r
+00007490: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+000074a0: 7374 6572 5f67 7261 6428 7069 6473 2e41  ster_grad(pids.A
+000074b0: 4253 2c20 5f61 6273 5f70 7269 6d5f 6772  BS, _abs_prim_gr
+000074c0: 6164 290a 0a0a 6465 6620 5f63 6f73 5f70  ad)...def _cos_p
+000074d0: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+000074e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+000074f0: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
+00007500: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00007510: 7764 203d 2070 7269 6d73 2e63 6f73 2861  wd = prims.cos(a
+00007520: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00007530: 7261 6428 6677 6429 0a20 2020 2070 7574  rad(fwd).    put
+00007540: 5f67 7261 6428 612c 2067 202a 2028 2d70  _grad(a, g * (-p
+00007550: 7269 6d73 2e73 696e 2861 2929 290a 0a20  rims.sin(a))).. 
+00007560: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00007570: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00007580: 6473 2e43 4f53 2c20 5f63 6f73 5f70 7269  ds.COS, _cos_pri
+00007590: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
+000075a0: 6374 780a 6465 6620 5f65 7266 5f70 7269  ctx.def _erf_pri
+000075b0: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
+000075c0: 207c 2054 656e 736f 7250 726f 7879 2920   | TensorProxy) 
+000075d0: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
+000075e0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+000075f0: 203d 2070 7269 6d73 2e65 7266 2861 290a   = prims.erf(a).
+00007600: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00007610: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00007620: 6420 3d20 3220 2f20 6d61 7468 2e73 7172  d = 2 / math.sqr
+00007630: 7428 6d61 7468 2e70 6929 202a 206c 746f  t(math.pi) * lto
+00007640: 7263 682e 6578 7028 2d28 612a 2a32 2929  rch.exp(-(a**2))
+00007650: 202a 2067 0a20 2020 2070 7574 5f67 7261   * g.    put_gra
+00007660: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
+00007670: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00007680: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00007690: 732e 4552 462c 205f 6572 665f 7072 696d  s.ERF, _erf_prim
+000076a0: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
+000076b0: 7478 0a64 6566 205f 6578 705f 7072 696d  tx.def _exp_prim
+000076c0: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
+000076d0: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
+000076e0: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
+000076f0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00007700: 3d20 7072 696d 732e 6578 7028 6129 0a0a  = prims.exp(a)..
+00007710: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007720: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
+00007730: 203d 2067 202a 2066 7764 0a20 2020 2070   = g * fwd.    p
+00007740: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+00007750: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+00007760: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00007770: 6164 2870 6964 732e 4558 502c 205f 6578  ad(pids.EXP, _ex
+00007780: 705f 7072 696d 5f67 7261 6429 0a0a 0a40  p_prim_grad)...@
+00007790: 746f 7263 6863 7478 0a64 6566 205f 6c6f  torchctx.def _lo
+000077a0: 675f 7072 696d 5f67 7261 6428 613a 204e  g_prim_grad(a: N
+000077b0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+000077c0: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
+000077d0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+000077e0: 2020 6677 6420 3d20 7072 696d 732e 6c6f    fwd = prims.lo
+000077f0: 6728 6129 0a0a 2020 2020 6720 3d20 6765  g(a)..    g = ge
+00007800: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00007810: 615f 6772 6164 203d 2067 202f 2061 0a20  a_grad = g / a. 
+00007820: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
+00007830: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
+00007840: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00007850: 725f 6772 6164 2870 6964 732e 4c4f 472c  r_grad(pids.LOG,
+00007860: 205f 6c6f 675f 7072 696d 5f67 7261 6429   _log_prim_grad)
+00007870: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00007880: 205f 6e65 675f 7072 696d 5f67 7261 6428   _neg_prim_grad(
+00007890: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+000078a0: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
+000078b0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+000078c0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+000078d0: 732e 6e65 6728 6129 0a0a 2020 2020 6720  s.neg(a)..    g 
+000078e0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+000078f0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00007900: 2d67 290a 0a20 2020 2072 6574 7572 6e20  -g)..    return 
+00007910: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00007920: 7261 6428 7069 6473 2e4e 4547 2c20 5f6e  rad(pids.NEG, _n
+00007930: 6567 5f70 7269 6d5f 6772 6164 290a 0a0a  eg_prim_grad)...
+00007940: 4074 6f72 6368 6374 780a 6465 6620 5f72  @torchctx.def _r
+00007950: 7371 7274 5f70 7269 6d5f 6772 6164 2861  sqrt_prim_grad(a
+00007960: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+00007970: 7250 726f 7879 2c20 2f29 202d 3e20 4e75  rProxy, /) -> Nu
+00007980: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007990: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+000079a0: 696d 732e 7273 7172 7428 6129 0a0a 2020  ims.rsqrt(a)..  
+000079b0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+000079c0: 7764 290a 2020 2020 2320 416e 2061 6c74  wd).    # An alt
+000079d0: 6572 6e61 7469 7665 2064 6572 6976 6174  ernative derivat
+000079e0: 696f 6e20 7573 6564 2062 7920 4a41 5820  ion used by JAX 
+000079f0: 6973 202d 302e 3520 2a20 6720 2a20 7273  is -0.5 * g * rs
+00007a00: 7172 7428 7829 202f 2078 0a20 2020 2023  qrt(x) / x.    #
+00007a10: 2077 6865 7265 2072 7371 7274 2878 2920   where rsqrt(x) 
+00007a20: 616e 6420 7820 6172 6520 7361 7665 6420  and x are saved 
+00007a30: 666f 7220 7468 6520 6261 636b 7761 7264  for the backward
+00007a40: 7320 7061 7373 2e0a 2020 2020 2320 5468  s pass..    # Th
+00007a50: 6973 2064 6572 6976 6174 696f 6e20 7761  is derivation wa
+00007a60: 7320 7365 6c65 6374 6564 2062 6563 6175  s selected becau
+00007a70: 7365 2069 7420 6176 6f69 6473 2073 6176  se it avoids sav
+00007a80: 696e 6720 7468 6520 696e 7075 7420 7465  ing the input te
+00007a90: 6e73 6f72 2e0a 2020 2020 615f 6772 6164  nsor..    a_grad
+00007aa0: 203d 202d 302e 3520 2a20 6720 2a20 6677   = -0.5 * g * fw
+00007ab0: 642a 2a33 2e30 0a20 2020 2070 7574 5f67  d**3.0.    put_g
+00007ac0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+00007ad0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00007ae0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00007af0: 6964 732e 5253 5152 542c 205f 7273 7172  ids.RSQRT, _rsqr
+00007b00: 745f 7072 696d 5f67 7261 6429 0a0a 0a64  t_prim_grad)...d
+00007b10: 6566 205f 7369 6e5f 7072 696d 5f67 7261  ef _sin_prim_gra
+00007b20: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
+00007b30: 6e73 6f72 5072 6f78 7929 202d 3e20 4e75  nsorProxy) -> Nu
+00007b40: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007b50: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00007b60: 696d 732e 7369 6e28 6129 0a0a 2020 2020  ims.sin(a)..    
+00007b70: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+00007b80: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+00007b90: 2c20 6720 2a20 7072 696d 732e 636f 7328  , g * prims.cos(
+00007ba0: 6129 290a 0a20 2020 2072 6574 7572 6e20  a))..    return 
+00007bb0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00007bc0: 7261 6428 7069 6473 2e53 494e 2c20 5f73  rad(pids.SIN, _s
+00007bd0: 696e 5f70 7269 6d5f 6772 6164 290a 0a0a  in_prim_grad)...
+00007be0: 4074 6f72 6368 6374 780a 6465 6620 5f74  @torchctx.def _t
+00007bf0: 616e 685f 7072 696d 5f67 7261 6428 613a  anh_prim_grad(a:
+00007c00: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007c10: 5072 6f78 792c 202f 2920 2d3e 204e 756d  Proxy, /) -> Num
+00007c20: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007c30: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00007c40: 6d73 2e74 616e 6828 6129 0a0a 2020 2020  ms.tanh(a)..    
+00007c50: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+00007c60: 290a 2020 2020 615f 6772 6164 203d 2067  ).    a_grad = g
+00007c70: 202a 2028 3120 2d20 6677 6420 2a20 6677   * (1 - fwd * fw
+00007c80: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
+00007c90: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
+00007ca0: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00007cb0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00007cc0: 5441 4e48 2c20 5f74 616e 685f 7072 696d  TANH, _tanh_prim
+00007cd0: 5f67 7261 6429 0a0a 230a 2320 456c 656d  _grad)..#.# Elem
+00007ce0: 656e 7477 6973 6520 6269 6e61 7279 206f  entwise binary o
+00007cf0: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
+00007d00: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
+00007d10: 5f61 6464 5f70 7269 6d5f 6772 6164 2861  _add_prim_grad(a
+00007d20: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+00007d30: 7250 726f 7879 2c20 623a 204e 756d 6265  rProxy, b: Numbe
+00007d40: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
+00007d50: 202f 2920 2d3e 204e 756d 6265 7220 7c20   /) -> Number | 
+00007d60: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007d70: 2066 7764 203d 2061 202b 2062 0a0a 2020   fwd = a + b..  
+00007d80: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00007d90: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
+00007da0: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
+00007db0: 670a 2020 2020 7075 745f 6772 6164 7328  g.    put_grads(
+00007dc0: 2861 2c20 6229 2c20 2861 5f67 7261 642c  (a, b), (a_grad,
+00007dd0: 2062 5f67 7261 6429 290a 0a20 2020 2072   b_grad))..    r
+00007de0: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00007df0: 7374 6572 5f67 7261 6428 7069 6473 2e41  ster_grad(pids.A
+00007e00: 4444 2c20 5f61 6464 5f70 7269 6d5f 6772  DD, _add_prim_gr
+00007e10: 6164 290a 0a0a 2320 4e4f 5445 2054 6865  ad)...# NOTE The
+00007e20: 2066 6f6c 6c6f 7769 6e67 2067 7261 6420   following grad 
+00007e30: 6465 6669 6e69 7469 6f6e 2072 656c 6965  definition relie
+00007e40: 7320 6f6e 2074 6865 2066 6163 7420 7468  s on the fact th
+00007e50: 6174 206f 6e6c 7920 696e 6578 6163 7420  at only inexact 
+00007e60: 6474 7970 6573 2061 7265 2064 6966 6665  dtypes are diffe
+00007e70: 7265 6e74 6961 626c 652c 0a23 2020 2061  rentiable,.#   a
+00007e80: 6e64 2074 6f72 6368 2773 2074 7275 6520  nd torch's true 
+00007e90: 6469 7669 7369 6f6e 206f 7065 7261 746f  division operato
+00007ea0: 7220 616e 6420 7468 6520 6469 7669 7369  r and the divisi
+00007eb0: 6f6e 2070 7269 6d69 7469 7665 2061 6772  on primitive agr
+00007ec0: 6565 206f 6e20 7468 6f73 6520 7479 7065  ee on those type
+00007ed0: 730a 4074 6f72 6368 6374 780a 6465 6620  s.@torchctx.def 
+00007ee0: 5f64 6976 5f70 7269 6d5f 6772 6164 2861  _div_prim_grad(a
+00007ef0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+00007f00: 7250 726f 7879 2c20 623a 204e 756d 6265  rProxy, b: Numbe
+00007f10: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
+00007f20: 202f 2920 2d3e 204e 756d 6265 7220 7c20   /) -> Number | 
+00007f30: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007f40: 2066 7764 203d 2061 202f 2062 0a0a 2020   fwd = a / b..  
+00007f50: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+00007f60: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
+00007f70: 2067 202f 2062 0a20 2020 2062 5f67 7261   g / b.    b_gra
+00007f80: 6420 3d20 2d67 202a 2028 2861 202f 2062  d = -g * ((a / b
+00007f90: 2920 2f20 6229 0a20 2020 2070 7574 5f67  ) / b).    put_g
+00007fa0: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
+00007fb0: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
+00007fc0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00007fd0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00007fe0: 6964 732e 4449 562c 205f 6469 765f 7072  ids.DIV, _div_pr
+00007ff0: 696d 5f67 7261 6429 0a0a 2320 436f 6d70  im_grad)..# Comp
+00008000: 6172 6973 6f6e 206f 7065 7261 746f 7273  arison operators
+00008010: 202d 2d20 7468 6573 6520 6372 6561 7465   -- these create
+00008020: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
+00008030: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
+00008040: 7261 6428 7069 6473 2e45 512c 2070 7269  rad(pids.EQ, pri
+00008050: 6d73 2e65 7129 0a72 6567 6973 7465 725f  ms.eq).register_
+00008060: 6772 6164 2870 6964 732e 4745 2c20 7072  grad(pids.GE, pr
+00008070: 696d 732e 6765 290a 7265 6769 7374 6572  ims.ge).register
+00008080: 5f67 7261 6428 7069 6473 2e4c 542c 2070  _grad(pids.LT, p
+00008090: 7269 6d73 2e6c 7429 0a72 6567 6973 7465  rims.lt).registe
+000080a0: 725f 6772 6164 2870 6964 732e 4e45 2c20  r_grad(pids.NE, 
+000080b0: 7072 696d 732e 6e65 290a 7265 6769 7374  prims.ne).regist
+000080c0: 6572 5f67 7261 6428 7069 6473 2e47 542c  er_grad(pids.GT,
+000080d0: 2070 7269 6d73 2e67 7429 0a72 6567 6973   prims.gt).regis
+000080e0: 7465 725f 6772 6164 2870 6964 732e 4c45  ter_grad(pids.LE
+000080f0: 2c20 7072 696d 732e 6c65 290a 0a0a 4074  , prims.le)...@t
+00008100: 6f72 6368 6374 780a 6465 6620 5f6d 756c  orchctx.def _mul
+00008110: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
+00008120: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00008130: 7879 2c20 623a 204e 756d 6265 7220 7c20  xy, b: Number | 
+00008140: 5465 6e73 6f72 5072 6f78 792c 202f 2920  TensorProxy, /) 
+00008150: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
+00008160: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00008170: 203d 2061 202a 2062 0a0a 2020 2020 6720   = a * b..    g 
+00008180: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00008190: 2020 2020 615f 6772 6164 203d 2062 202a      a_grad = b *
+000081a0: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
+000081b0: 6120 2a20 670a 2020 2020 7075 745f 6772  a * g.    put_gr
+000081c0: 6164 7328 2861 2c20 6229 2c20 2861 5f67  ads((a, b), (a_g
+000081d0: 7261 642c 2062 5f67 7261 6429 290a 0a20  rad, b_grad)).. 
+000081e0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+000081f0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00008200: 6473 2e4d 554c 2c20 5f6d 756c 5f70 7269  ds.MUL, _mul_pri
+00008210: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
+00008220: 6374 780a 6465 6620 5f73 7562 5f70 7269  ctx.def _sub_pri
+00008230: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
+00008240: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
+00008250: 623a 204e 756d 6265 7220 7c20 5465 6e73  b: Number | Tens
+00008260: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
+00008270: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00008280: 3a0a 2020 2020 6677 6420 3d20 6120 2d20  :.    fwd = a - 
+00008290: 620a 0a20 2020 2067 203d 2067 6574 5f67  b..    g = get_g
+000082a0: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+000082b0: 7261 6420 3d20 670a 2020 2020 625f 6772  rad = g.    b_gr
+000082c0: 6164 203d 202d 670a 2020 2020 7075 745f  ad = -g.    put_
+000082d0: 6772 6164 7328 2861 2c20 6229 2c20 2861  grads((a, b), (a
+000082e0: 5f67 7261 642c 2062 5f67 7261 6429 290a  _grad, b_grad)).
+000082f0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00008300: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+00008310: 7069 6473 2e53 5542 2c20 5f73 7562 5f70  pids.SUB, _sub_p
+00008320: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
+00008330: 436f 6e64 6974 696f 6e61 6c20 6f70 6572  Conditional oper
+00008340: 6174 6f72 2067 7261 6473 0a23 0a0a 0a64  ator grads.#...d
+00008350: 6566 205f 7768 6572 655f 7072 696d 5f67  ef _where_prim_g
+00008360: 7261 6428 7072 6564 3a20 4e75 6d62 6572  rad(pred: Number
+00008370: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
+00008380: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+00008390: 6f72 5072 6f78 792c 2062 3a20 4e75 6d62  orProxy, b: Numb
+000083a0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+000083b0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+000083c0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+000083d0: 732e 7768 6572 6528 7072 6564 2c20 612c  s.where(pred, a,
+000083e0: 2062 290a 0a20 2020 2067 203d 2067 6574   b)..    g = get
+000083f0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
+00008400: 5f67 7261 6420 3d20 6c74 6f72 6368 2e77  _grad = ltorch.w
+00008410: 6865 7265 2870 7265 642c 2067 2c20 3029  here(pred, g, 0)
+00008420: 0a20 2020 2062 5f67 7261 6420 3d20 6c74  .    b_grad = lt
+00008430: 6f72 6368 2e77 6865 7265 2870 7265 642c  orch.where(pred,
+00008440: 2030 2c20 6729 0a20 2020 2070 7574 5f67   0, g).    put_g
+00008450: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
+00008460: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
+00008470: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008480: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008490: 6964 732e 5748 4552 452c 205f 7768 6572  ids.WHERE, _wher
+000084a0: 655f 7072 696d 5f67 7261 6429 0a0a 230a  e_prim_grad)..#.
+000084b0: 2320 5265 6475 6374 696f 6e20 6f70 6572  # Reduction oper
+000084c0: 6174 6f72 2067 7261 6473 0a23 0a0a 0a23  ator grads.#...#
+000084d0: 2054 4f44 4f20 5265 7669 6577 2074 7765   TODO Review twe
+000084e0: 616b 696e 6720 6772 6164 5f63 686f 6f73  aking grad_choos
+000084f0: 6572 5f70 756c 6c62 6163 6b20 696e 7465  er_pullback inte
+00008500: 7266 6163 650a 6465 6620 5f61 6d61 785f  rface.def _amax_
+00008510: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
+00008520: 736f 7250 726f 7879 2c20 2f2c 2064 696d  sorProxy, /, dim
+00008530: 733a 2053 6571 7565 6e63 655b 696e 745d  s: Sequence[int]
+00008540: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00008550: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00008560: 732e 616d 6178 2861 2c20 6469 6d73 290a  s.amax(a, dims).
+00008570: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00008580: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00008590: 6420 3d20 6772 6164 5f63 686f 6f73 6572  d = grad_chooser
+000085a0: 5f62 6163 6b77 6172 6428 6677 642c 2061  _backward(fwd, a
+000085b0: 2c20 612e 7368 6170 652c 2064 696d 732c  , a.shape, dims,
+000085c0: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
+000085d0: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
+000085e0: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+000085f0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00008600: 2e41 4d41 582c 205f 616d 6178 5f70 7269  .AMAX, _amax_pri
+00008610: 6d5f 6772 6164 290a 0a0a 6465 6620 5f73  m_grad)...def _s
+00008620: 756d 5f70 7269 6d5f 6772 6164 2861 3a20  um_prim_grad(a: 
+00008630: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+00008640: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
+00008650: 6e74 5d29 202d 3e20 5465 6e73 6f72 5072  nt]) -> TensorPr
+00008660: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00008670: 7269 6d73 2e73 756d 2861 2c20 6469 6d73  rims.sum(a, dims
+00008680: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00008690: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+000086a0: 7261 6420 3d20 7265 7374 6f72 655f 7265  rad = restore_re
+000086b0: 6475 6365 645f 6469 6d73 2867 2c20 6469  duced_dims(g, di
+000086c0: 6d73 2c20 612e 7368 6170 6529 0a20 2020  ms, a.shape).   
+000086d0: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
+000086e0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+000086f0: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+00008700: 6772 6164 2870 6964 732e 5355 4d2c 205f  grad(pids.SUM, _
+00008710: 7375 6d5f 7072 696d 5f67 7261 6429 0a0a  sum_prim_grad)..
+00008720: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+00008730: 746f 706b 5f70 7269 6d5f 6772 6164 280a  topk_prim_grad(.
+00008740: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
+00008750: 7879 2c20 2f2c 206b 3a20 696e 742c 2064  xy, /, k: int, d
+00008760: 696d 3a20 4e6f 6e65 207c 2069 6e74 203d  im: None | int =
+00008770: 204e 6f6e 652c 206c 6172 6765 7374 3a20   None, largest: 
+00008780: 626f 6f6c 203d 2054 7275 652c 2073 6f72  bool = True, sor
+00008790: 7465 643a 2062 6f6f 6c20 3d20 5472 7565  ted: bool = True
+000087a0: 2c20 2a2c 206f 7574 3d4e 6f6e 650a 293a  , *, out=None.):
+000087b0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+000087c0: 2e74 6f70 6b28 612c 206b 2c20 6469 6d2c  .topk(a, k, dim,
+000087d0: 206c 6172 6765 7374 2c20 736f 7274 6564   largest, sorted
+000087e0: 2c20 6f75 743d 6f75 7429 0a20 2020 2076  , out=out).    v
+000087f0: 616c 2c20 6964 7820 3d20 6677 640a 0a20  al, idx = fwd.. 
+00008800: 2020 2076 616c 5f67 7261 6420 3d20 6765     val_grad = ge
+00008810: 745f 6772 6164 2876 616c 290a 0a20 2020  t_grad(val)..   
+00008820: 2061 5f67 7261 6420 3d20 6c74 6f72 6368   a_grad = ltorch
+00008830: 2e7a 6572 6f73 5f6c 696b 6528 6129 0a20  .zeros_like(a). 
+00008840: 2020 2023 2054 4f44 4f3a 2072 6570 6c61     # TODO: repla
+00008850: 6365 2077 6974 6820 7363 6174 7465 7220  ce with scatter 
+00008860: 6f6e 6365 2077 6520 6861 7665 2069 742e  once we have it.
+00008870: 0a20 2020 2023 2073 6361 7474 6572 5f61  .    # scatter_a
+00008880: 6464 2069 7320 6120 7072 696d 2061 6e64  dd is a prim and
+00008890: 2069 7420 7265 6c69 6573 206f 6e20 6174   it relies on at
+000088a0: 6f6d 6963 206f 7073 2e0a 2020 2020 615f  omic ops..    a_
+000088b0: 6772 6164 203d 206c 746f 7263 682e 7363  grad = ltorch.sc
+000088c0: 6174 7465 725f 6164 6428 615f 6772 6164  atter_add(a_grad
+000088d0: 2c20 6469 6d2c 2069 6478 2c20 7661 6c5f  , dim, idx, val_
+000088e0: 6772 6164 290a 2020 2020 7075 745f 6772  grad).    put_gr
+000088f0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
+00008900: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00008910: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00008920: 6473 2e54 4f50 4b2c 205f 746f 706b 5f70  ds.TOPK, _topk_p
+00008930: 7269 6d5f 6772 6164 290a 0a0a 2320 544f  rim_grad)...# TO
+00008940: 444f 2046 6978 2064 6976 6973 696f 6e20  DO Fix division 
+00008950: 6279 207a 6572 6f20 7768 656e 206e 5f65  by zero when n_e
+00008960: 6c65 6d5f 7265 6475 6365 6420 3d3d 2030  lem_reduced == 0
+00008970: 206f 7220 7768 656e 206d 6561 6e2e 6e75   or when mean.nu
+00008980: 6d65 6c20 3d3d 2030 0a23 2020 2062 7920  mel == 0.#   by 
+00008990: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
+000089a0: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
+000089b0: 6172 2e0a 2320 544f 444f 2046 6978 2067  ar..# TODO Fix g
+000089c0: 7261 6420 7768 656e 2063 6f72 7265 6374  rad when correct
+000089d0: 696f 6e20 3e20 6e5f 656c 656d 5f72 6564  ion > n_elem_red
+000089e0: 7563 6564 2e0a 4074 6f72 6368 6374 780a  uced..@torchctx.
+000089f0: 6465 6620 5f76 6172 5f6d 6561 6e5f 7072  def _var_mean_pr
+00008a00: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
+00008a10: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
+00008a20: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
+00008a30: 2a2c 2063 6f72 7265 6374 696f 6e3a 204e  *, correction: N
+00008a40: 756d 6265 7229 202d 3e20 5465 6e73 6f72  umber) -> Tensor
+00008a50: 5072 6f78 793a 0a20 2020 2076 2c20 6d20  Proxy:.    v, m 
+00008a60: 3d20 7072 696d 732e 7661 725f 6d65 616e  = prims.var_mean
+00008a70: 2861 2c20 6469 6d73 2c20 636f 7272 6563  (a, dims, correc
+00008a80: 7469 6f6e 3d63 6f72 7265 6374 696f 6e29  tion=correction)
+00008a90: 0a0a 2020 2020 6776 203d 2067 6574 5f67  ..    gv = get_g
+00008aa0: 7261 6428 7629 0a20 2020 2067 6d20 3d20  rad(v).    gm = 
+00008ab0: 6765 745f 6772 6164 286d 290a 0a20 2020  get_grad(m)..   
+00008ac0: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
+00008ad0: 3d20 612e 6e75 6d65 6c28 2920 2f2f 206d  = a.numel() // m
+00008ae0: 2e6e 756d 656c 2829 2069 6620 612e 6e75  .numel() if a.nu
+00008af0: 6d65 6c28 2920 213d 2030 2065 6c73 6520  mel() != 0 else 
+00008b00: 310a 0a20 2020 2023 2043 6f6d 7075 7465  1..    # Compute
+00008b10: 7320 6d65 616e 2062 7764 0a20 2020 206d  s mean bwd.    m
+00008b20: 6561 6e5f 7363 616c 6520 3d20 312e 3020  ean_scale = 1.0 
+00008b30: 2f20 6e5f 656c 656d 5f72 6564 7563 6564  / n_elem_reduced
+00008b40: 0a20 2020 206d 6561 6e5f 6772 6164 203d  .    mean_grad =
+00008b50: 206d 6561 6e5f 7363 616c 6520 2a20 7265   mean_scale * re
+00008b60: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
+00008b70: 6d73 2867 6d2c 2064 696d 732c 2061 2e73  ms(gm, dims, a.s
+00008b80: 6861 7065 290a 0a20 2020 2023 2043 6f6d  hape)..    # Com
+00008b90: 7075 7465 7320 7661 7220 6277 640a 2020  putes var bwd.  
+00008ba0: 2020 6e6f 726d 616c 697a 6174 696f 6e5f    normalization_
+00008bb0: 7363 616c 6172 203d 206e 5f65 6c65 6d5f  scalar = n_elem_
+00008bc0: 7265 6475 6365 6420 2d20 636f 7272 6563  reduced - correc
+00008bd0: 7469 6f6e 0a20 2020 2072 6573 746f 7265  tion.    restore
+00008be0: 645f 6776 203d 2072 6573 746f 7265 5f72  d_gv = restore_r
+00008bf0: 6564 7563 6564 5f64 696d 7328 6776 2c20  educed_dims(gv, 
+00008c00: 6469 6d73 2c20 612e 7368 6170 6529 0a20  dims, a.shape). 
+00008c10: 2020 2023 2049 6e73 6572 7469 6e67 2061     # Inserting a
+00008c20: 2063 6f6e 7665 7273 696f 6e20 746f 2074   conversion to t
+00008c30: 6865 2073 616d 6520 6474 7970 6520 746f  he same dtype to
+00008c40: 2064 6973 6162 6c65 206e 7646 7573 6572   disable nvFuser
+00008c50: 2065 7865 6375 746f 7273 2773 0a20 2020   executors's.   
+00008c60: 2023 2062 6f6f 6b65 6e64 206f 7074 696d   # bookend optim
+00008c70: 697a 6174 696f 6e20 286e 765f 656e 6162  ization (nv_enab
+00008c80: 6c65 5f62 6f6f 6b65 6e64 292c 2077 6869  le_bookend), whi
+00008c90: 6368 2063 616e 2063 6175 7365 2074 6865  ch can cause the
+00008ca0: 2062 6163 6b77 6172 640a 2020 2020 2320   backward.    # 
+00008cb0: 7061 7373 2074 6f20 6765 6e65 7261 7465  pass to generate
+00008cc0: 2074 776f 206b 6572 6e65 6c73 0a20 2020   two kernels.   
+00008cd0: 206d 6561 6e5f 6d64 7479 7065 203d 2070   mean_mdtype = p
+00008ce0: 7269 6d73 2e63 6f6e 7665 7274 5f65 6c65  rims.convert_ele
+00008cf0: 6d65 6e74 5f74 7970 6528 6d2c 206d 2e64  ment_type(m, m.d
+00008d00: 7479 7065 290a 2020 2020 7265 7374 6f72  type).    restor
+00008d10: 6564 5f6d 6561 6e20 3d20 7265 7374 6f72  ed_mean = restor
+00008d20: 655f 7265 6475 6365 645f 6469 6d73 286d  e_reduced_dims(m
+00008d30: 6561 6e5f 6d64 7479 7065 2c20 6469 6d73  ean_mdtype, dims
+00008d40: 2c20 612e 7368 6170 6529 0a20 2020 2076  , a.shape).    v
+00008d50: 6172 5f67 7261 6420 3d20 2832 202a 2072  ar_grad = (2 * r
+00008d60: 6573 746f 7265 645f 6776 202a 2028 6120  estored_gv * (a 
+00008d70: 2d20 7265 7374 6f72 6564 5f6d 6561 6e29  - restored_mean)
+00008d80: 2920 2f20 6e6f 726d 616c 697a 6174 696f  ) / normalizatio
+00008d90: 6e5f 7363 616c 6172 0a0a 2020 2020 7075  n_scalar..    pu
+00008da0: 745f 6772 6164 2861 2c20 6d65 616e 5f67  t_grad(a, mean_g
+00008db0: 7261 6420 2b20 7661 725f 6772 6164 290a  rad + var_grad).
+00008dc0: 0a20 2020 2072 6574 7572 6e20 762c 206d  .    return v, m
+00008dd0: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00008de0: 2870 6964 732e 5641 525f 4d45 414e 2c20  (pids.VAR_MEAN, 
+00008df0: 5f76 6172 5f6d 6561 6e5f 7072 696d 5f67  _var_mean_prim_g
+00008e00: 7261 6429 0a0a 0a23 0a23 204c 696e 6561  rad)...#.# Linea
+00008e10: 7220 616c 6765 6272 6120 6f70 6572 6174  r algebra operat
+00008e20: 6f72 2067 7261 6473 0a23 0a40 746f 7263  or grads.#.@torc
+00008e30: 6863 7478 0a64 6566 205f 6c69 6e65 6172  hctx.def _linear
+00008e40: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
+00008e50: 6e73 6f72 5072 6f78 792c 2077 3a20 5465  nsorProxy, w: Te
+00008e60: 6e73 6f72 5072 6f78 792c 2062 6961 733a  nsorProxy, bias:
+00008e70: 204e 6f6e 6520 7c20 5465 6e73 6f72 5072   None | TensorPr
+00008e80: 6f78 7929 202d 3e20 5465 6e73 6f72 5072  oxy) -> TensorPr
+00008e90: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00008ea0: 7269 6d73 2e6c 696e 6561 7228 612c 2077  rims.linear(a, w
+00008eb0: 2c20 6269 6173 290a 0a20 2020 2067 203d  , bias)..    g =
+00008ec0: 2067 6574 5f67 7261 6428 6677 6429 0a0a   get_grad(fwd)..
+00008ed0: 2020 2020 6669 7273 745f 6469 6d20 3d20      first_dim = 
+00008ee0: 2d32 0a20 2020 2067 7261 645f 6120 3d20  -2.    grad_a = 
+00008ef0: 6c74 6f72 6368 2e6d 6174 6d75 6c28 672e  ltorch.matmul(g.
+00008f00: 7265 7368 6170 6528 2d31 2c20 672e 7368  reshape(-1, g.sh
+00008f10: 6170 655b 2d31 5d29 2c20 7729 2e72 6573  ape[-1]), w).res
+00008f20: 6861 7065 2861 2e73 6861 7065 290a 0a20  hape(a.shape).. 
+00008f30: 2020 2067 7261 645f 773a 2054 656e 736f     grad_w: Tenso
+00008f40: 7250 726f 7879 0a20 2020 2069 6620 612e  rProxy.    if a.
+00008f50: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+00008f60: 2020 2067 7261 645f 7720 3d20 6c74 6f72     grad_w = ltor
+00008f70: 6368 2e6d 6174 6d75 6c28 672e 756e 7371  ch.matmul(g.unsq
+00008f80: 7565 657a 6528 6669 7273 745f 6469 6d29  ueeze(first_dim)
+00008f90: 2e6d 542c 2061 2e75 6e73 7175 6565 7a65  .mT, a.unsqueeze
+00008fa0: 2866 6972 7374 5f64 696d 2929 0a20 2020  (first_dim)).   
+00008fb0: 2065 6c73 653a 0a20 2020 2020 2020 2067   else:.        g
+00008fc0: 7261 645f 7720 3d20 6c74 6f72 6368 2e6d  rad_w = ltorch.m
+00008fd0: 6174 6d75 6c28 672e 7265 7368 6170 6528  atmul(g.reshape(
+00008fe0: 2d31 2c20 672e 7368 6170 655b 2d31 5d29  -1, g.shape[-1])
+00008ff0: 2e6d 542c 2061 2e72 6573 6861 7065 282d  .mT, a.reshape(-
+00009000: 312c 2061 2e73 6861 7065 5b2d 315d 2929  1, a.shape[-1]))
+00009010: 0a0a 2020 2020 7075 745f 6772 6164 7328  ..    put_grads(
+00009020: 2861 2c20 7729 2c20 2867 7261 645f 612c  (a, w), (grad_a,
+00009030: 2067 7261 645f 7729 290a 0a20 2020 2069   grad_w))..    i
+00009040: 6620 6269 6173 2069 7320 6e6f 7420 4e6f  f bias is not No
+00009050: 6e65 3a0a 2020 2020 2020 2020 6966 2067  ne:.        if g
+00009060: 2e6e 6469 6d20 3e20 313a 0a20 2020 2020  .ndim > 1:.     
+00009070: 2020 2020 2020 2067 7261 645f 6269 6173         grad_bias
+00009080: 203d 206c 746f 7263 682e 7375 6d28 672c   = ltorch.sum(g,
+00009090: 2074 7570 6c65 2872 616e 6765 2867 2e6e   tuple(range(g.n
+000090a0: 6469 6d20 2d20 3129 2929 0a20 2020 2020  dim - 1))).     
+000090b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000090c0: 2020 2020 2067 7261 645f 6269 6173 203d       grad_bias =
+000090d0: 2067 0a20 2020 2020 2020 2070 7574 5f67   g.        put_g
+000090e0: 7261 6428 6269 6173 2c20 6772 6164 5f62  rad(bias, grad_b
+000090f0: 6961 7329 0a0a 2020 2020 7265 7475 726e  ias)..    return
+00009100: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+00009110: 6772 6164 2870 6964 732e 4c49 4e45 4152  grad(pids.LINEAR
+00009120: 2c20 5f6c 696e 6561 725f 7072 696d 5f67  , _linear_prim_g
+00009130: 7261 6429 0a0a 0a23 2054 4f44 4f20 4164  rad)...# TODO Ad
+00009140: 6420 6578 706c 6963 6974 206c 746f 7263  d explicit ltorc
+00009150: 6820 7673 2063 6c61 6e67 206d 6f64 756c  h vs clang modul
+00009160: 6520 746f 2074 6865 2074 656e 736f 7220  e to the tensor 
+00009170: 6f70 6572 6174 696f 6e73 2062 656c 6f77  operations below
+00009180: 0a23 2054 4f44 4f20 636f 756c 6420 7765  .# TODO could we
+00009190: 2067 6574 2072 6964 206f 6620 7468 6520   get rid of the 
+000091a0: 6669 6e61 6c20 7371 7565 657a 6573 2069  final squeezes i
+000091b0: 6e20 7468 6520 622e 6e64 696d 203d 3d20  n the b.ndim == 
+000091c0: 3120 6361 7365 2061 6e64 2074 6865 2061  1 case and the a
+000091d0: 2e6e 6469 6d20 3d3d 2031 2063 6173 653f  .ndim == 1 case?
+000091e0: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+000091f0: 6d61 746d 756c 5f70 7269 6d5f 6772 6164  matmul_prim_grad
+00009200: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
+00009210: 2062 3a20 5465 6e73 6f72 5072 6f78 792c   b: TensorProxy,
+00009220: 202f 2920 2d3e 2054 656e 736f 7250 726f   /) -> TensorPro
+00009230: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00009240: 696d 732e 6d61 746d 756c 2861 2c20 6229  ims.matmul(a, b)
+00009250: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00009260: 6428 6677 6429 0a0a 2020 2020 6c61 7374  d(fwd)..    last
+00009270: 5f64 696d 203d 2028 2d31 2c29 0a20 2020  _dim = (-1,).   
+00009280: 2066 6972 7374 5f64 696d 203d 2028 2d32   first_dim = (-2
+00009290: 2c29 0a20 2020 2069 6620 612e 6e64 696d  ,).    if a.ndim
+000092a0: 203d 3d20 3120 616e 6420 622e 6e64 696d   == 1 and b.ndim
+000092b0: 203d 3d20 313a 0a20 2020 2020 2020 2070   == 1:.        p
+000092c0: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
+000092d0: 2028 6720 2a20 622c 2067 202a 2061 2929   (g * b, g * a))
+000092e0: 0a20 2020 2065 6c69 6620 622e 6e64 696d  .    elif b.ndim
+000092f0: 203d 3d20 313a 0a20 2020 2020 2020 2067   == 1:.        g
+00009300: 6120 3d20 756e 7371 7565 657a 6528 672c  a = unsqueeze(g,
+00009310: 206c 6173 745f 6469 6d29 2040 2075 6e73   last_dim) @ uns
+00009320: 7175 6565 7a65 2862 2c20 6c61 7374 5f64  queeze(b, last_d
+00009330: 696d 292e 6d54 0a20 2020 2020 2020 2067  im).mT.        g
+00009340: 6220 3d20 612e 6d54 2040 2075 6e73 7175  b = a.mT @ unsqu
+00009350: 6565 7a65 2867 2c20 6c61 7374 5f64 696d  eeze(g, last_dim
+00009360: 290a 2020 2020 2020 2020 6966 2067 2e6e  ).        if g.n
+00009370: 6469 6d20 3e20 313a 0a20 2020 2020 2020  dim > 1:.       
+00009380: 2020 2020 2067 6220 3d20 7371 7565 657a       gb = squeez
+00009390: 6528 6762 2c20 6c61 7374 5f64 696d 290a  e(gb, last_dim).
+000093a0: 2020 2020 2020 2020 2020 2020 6762 203d              gb =
+000093b0: 206c 746f 7263 682e 7375 6d28 6762 2c20   ltorch.sum(gb, 
+000093c0: 7475 706c 6528 7261 6e67 6528 6762 2e6e  tuple(range(gb.n
+000093d0: 6469 6d20 2d20 3129 2929 0a20 2020 2020  dim - 1))).     
+000093e0: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
+000093f0: 2062 292c 2028 6761 2c20 6762 2e73 7175   b), (ga, gb.squ
+00009400: 6565 7a65 2829 2929 0a20 2020 2065 6c69  eeze())).    eli
+00009410: 6620 612e 6e64 696d 203d 3d20 313a 0a20  f a.ndim == 1:. 
+00009420: 2020 2020 2020 2067 6120 3d20 756e 7371         ga = unsq
+00009430: 7565 657a 6528 672c 2066 6972 7374 5f64  ueeze(g, first_d
+00009440: 696d 2920 4020 622e 6d54 0a20 2020 2020  im) @ b.mT.     
+00009450: 2020 2069 6620 672e 6e64 696d 203e 2031     if g.ndim > 1
+00009460: 3a0a 2020 2020 2020 2020 2020 2020 6761  :.            ga
+00009470: 203d 206c 746f 7263 682e 7375 6d28 6761   = ltorch.sum(ga
+00009480: 2c20 7475 706c 6528 7261 6e67 6528 6761  , tuple(range(ga
+00009490: 2e6e 6469 6d20 2d20 3129 2929 0a20 2020  .ndim - 1))).   
+000094a0: 2020 2020 2067 6220 3d20 756e 7371 7565       gb = unsque
+000094b0: 657a 6528 612c 2066 6972 7374 5f64 696d  eze(a, first_dim
+000094c0: 292e 6d54 2040 2075 6e73 7175 6565 7a65  ).mT @ unsqueeze
+000094d0: 2867 2c20 6669 7273 745f 6469 6d29 0a20  (g, first_dim). 
+000094e0: 2020 2020 2020 2070 7574 5f67 7261 6473         put_grads
+000094f0: 2828 612c 2062 292c 2028 6761 2e73 7175  ((a, b), (ga.squ
+00009500: 6565 7a65 2829 2c20 6762 2929 0a20 2020  eeze(), gb)).   
+00009510: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
+00009520: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
+00009530: 2028 6720 4020 622e 6d54 2c20 612e 6d54   (g @ b.mT, a.mT
+00009540: 2040 2067 2929 0a0a 2020 2020 7265 7475   @ g))..    retu
+00009550: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00009560: 725f 6772 6164 2870 6964 732e 4d41 544d  r_grad(pids.MATM
+00009570: 554c 2c20 5f6d 6174 6d75 6c5f 7072 696d  UL, _matmul_prim
+00009580: 5f67 7261 6429 0a0a 230a 2320 4e4e 206f  _grad)..#.# NN o
+00009590: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
+000095a0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
+000095b0: 5f65 6d62 6564 6469 6e67 5f70 7269 6d5f  _embedding_prim_
+000095c0: 6772 6164 280a 2020 2020 613a 2054 656e  grad(.    a: Ten
+000095d0: 736f 7250 726f 7879 2c20 2f2c 2077 6569  sorProxy, /, wei
+000095e0: 6768 742c 202a 2c20 7061 6464 696e 675f  ght, *, padding_
+000095f0: 6964 783d 2d31 2c20 6d61 785f 6e6f 726d  idx=-1, max_norm
+00009600: 3d4e 6f6e 652c 206e 6f72 6d5f 7479 7065  =None, norm_type
+00009610: 3d32 2e30 2c20 7363 616c 655f 6772 6164  =2.0, scale_grad
+00009620: 5f62 795f 6672 6571 3d46 616c 7365 2c20  _by_freq=False, 
+00009630: 7370 6172 7365 3d46 616c 7365 0a29 202d  sparse=False.) -
+00009640: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00009650: 2020 2066 7764 203d 2070 7269 6d73 2e65     fwd = prims.e
+00009660: 6d62 6564 6469 6e67 280a 2020 2020 2020  mbedding(.      
+00009670: 2020 612c 0a20 2020 2020 2020 2077 6569    a,.        wei
+00009680: 6768 742c 0a20 2020 2020 2020 2070 6164  ght,.        pad
+00009690: 6469 6e67 5f69 6478 3d70 6164 6469 6e67  ding_idx=padding
+000096a0: 5f69 6478 2c0a 2020 2020 2020 2020 6d61  _idx,.        ma
+000096b0: 785f 6e6f 726d 3d6d 6178 5f6e 6f72 6d2c  x_norm=max_norm,
+000096c0: 0a20 2020 2020 2020 206e 6f72 6d5f 7479  .        norm_ty
+000096d0: 7065 3d6e 6f72 6d5f 7479 7065 2c0a 2020  pe=norm_type,.  
+000096e0: 2020 2020 2020 7363 616c 655f 6772 6164        scale_grad
+000096f0: 5f62 795f 6672 6571 3d73 6361 6c65 5f67  _by_freq=scale_g
+00009700: 7261 645f 6279 5f66 7265 712c 0a20 2020  rad_by_freq,.   
+00009710: 2020 2020 2073 7061 7273 653d 7370 6172       sparse=spar
+00009720: 7365 2c0a 2020 2020 290a 0a20 2020 2067  se,.    )..    g
+00009730: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00009740: 0a20 2020 2061 5f67 7261 6420 3d20 7072  .    a_grad = pr
+00009750: 696d 732e 656d 6265 6464 696e 675f 6261  ims.embedding_ba
+00009760: 636b 7761 7264 2867 2c20 612c 2077 6569  ckward(g, a, wei
+00009770: 6768 742e 7368 6170 655b 305d 2c20 7061  ght.shape[0], pa
+00009780: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
+00009790: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
+000097a0: 7061 7273 6529 0a20 2020 2070 7574 5f67  parse).    put_g
+000097b0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+000097c0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+000097d0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+000097e0: 6964 732e 454d 4245 4444 494e 472c 205f  ids.EMBEDDING, _
+000097f0: 656d 6265 6464 696e 675f 7072 696d 5f67  embedding_prim_g
+00009800: 7261 6429 0a0a 230a 2320 5068 616e 746f  rad)..#.# Phanto
+00009810: 6d20 6772 6164 2074 7261 6e73 666f 726d  m grad transform
+00009820: 2068 656c 7065 7273 0a23 0a0a 0a64 6566   helpers.#...def
+00009830: 205f 6765 745f 6772 6164 666e 5f61 6e64   _get_gradfn_and
+00009840: 5f65 7865 6375 746f 7228 0a20 2020 2062  _executor(.    b
+00009850: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
+00009860: 2c20 2a2c 2065 7865 6375 746f 7273 5f6c  , *, executors_l
+00009870: 6973 743a 2053 6571 7565 6e63 655b 416e  ist: Sequence[An
+00009880: 795d 203d 2074 7570 6c65 2829 0a29 202d  y] = tuple().) -
+00009890: 3e20 7475 706c 655b 4361 6c6c 6162 6c65  > tuple[Callable
+000098a0: 207c 204e 6f6e 652c 2045 7865 6375 746f   | None, Executo
+000098b0: 7220 7c20 4e6f 6e65 5d3a 0a20 2020 2063  r | None]:.    c
+000098c0: 6420 3d20 6765 745f 636f 6d70 696c 655f  d = get_compile_
+000098d0: 6461 7461 2829 0a20 2020 2065 7865 6375  data().    execu
+000098e0: 746f 7273 5f6c 6973 7420 3d20 6364 2e65  tors_list = cd.e
+000098f0: 7865 6375 746f 7273 5f6c 6973 7420 6966  xecutors_list if
+00009900: 2063 6420 6973 206e 6f74 204e 6f6e 6520   cd is not None 
+00009910: 656c 7365 2065 7865 6375 746f 7273 5f6c  else executors_l
+00009920: 6973 740a 2020 2020 2320 4368 6563 6b73  ist.    # Checks
+00009930: 2069 6620 7468 6520 6578 6563 7574 6f72   if the executor
+00009940: 2077 6869 6368 2068 6173 2070 7269 6f72   which has prior
+00009950: 6974 7920 666f 7220 7468 6973 206f 7065  ity for this ope
+00009960: 7261 7469 6f6e 2068 6173 2061 2073 7065  ration has a spe
+00009970: 6369 6669 6320 6772 6164 2074 7261 6e73  cific grad trans
+00009980: 666f 726d 2066 6f72 2069 740a 2020 2020  form for it.    
+00009990: 666f 7220 6578 2069 6e20 6578 6563 7574  for ex in execut
+000099a0: 6f72 735f 6c69 7374 3a0a 2020 2020 2020  ors_list:.      
+000099b0: 2020 6966 2065 782e 6361 6e5f 6578 6563    if ex.can_exec
+000099c0: 7574 655f 6f72 5f66 7573 6528 6273 796d  ute_or_fuse(bsym
+000099d0: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
+000099e0: 785f 6772 6164 5f74 7261 6e73 666f 726d  x_grad_transform
+000099f0: 3a20 4e6f 6e65 207c 2043 616c 6c61 626c  : None | Callabl
+00009a00: 6520 3d20 6578 2e67 6574 5f67 7261 645f  e = ex.get_grad_
+00009a10: 7472 616e 7366 6f72 6d28 6273 796d 2e73  transform(bsym.s
+00009a20: 796d 290a 2020 2020 2020 2020 2020 2020  ym).            
+00009a30: 6966 2065 785f 6772 6164 5f74 7261 6e73  if ex_grad_trans
+00009a40: 666f 726d 2069 7320 6e6f 7420 4e6f 6e65  form is not None
+00009a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009a60: 2020 7265 7475 726e 2065 785f 6772 6164    return ex_grad
+00009a70: 5f74 7261 6e73 666f 726d 2c20 6578 0a20  _transform, ex. 
+00009a80: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00009a90: 0a0a 2020 2020 2320 4966 2074 6865 2065  ..    # If the e
+00009aa0: 7865 6375 746f 7220 646f 6573 6e27 7420  xecutor doesn't 
+00009ab0: 6465 6669 6e65 2069 7473 206f 776e 2067  define its own g
+00009ac0: 7261 6420 7472 616e 7366 6f72 6d2c 2074  rad transform, t
+00009ad0: 6869 7320 6a75 7374 2072 6574 7572 6e73  his just returns
+00009ae0: 2074 6865 2064 6566 6175 6c74 2067 7261   the default gra
+00009af0: 6420 7472 616e 7366 6f72 6d20 666f 7220  d transform for 
+00009b00: 7468 6520 6273 796d 0a20 2020 2067 7261  the bsym.    gra
+00009b10: 6466 6e20 3d20 5f67 7261 645f 666e 5f6d  dfn = _grad_fn_m
+00009b20: 6170 2e67 6574 2862 7379 6d2e 7379 6d2e  ap.get(bsym.sym.
+00009b30: 6964 2c20 4e6f 6e65 290a 2020 2020 7265  id, None).    re
+00009b40: 7475 726e 2067 7261 6466 6e2c 204e 6f6e  turn gradfn, Non
+00009b50: 650a 0a0a 2320 5468 6520 6465 6661 756c  e...# The defaul
+00009b60: 7420 6772 6164 2073 7065 6369 6669 6572  t grad specifier
+00009b70: 2066 6f72 2074 6865 2067 7261 6420 7472   for the grad tr
+00009b80: 616e 7366 6f72 6d0a 2320 2020 466f 7220  ansform.#   For 
+00009b90: 6561 6368 2074 656e 736f 7220 6f75 7470  each tensor outp
+00009ba0: 7574 2022 6f22 2072 6571 7569 7269 6e67  ut "o" requiring
+00009bb0: 2067 7261 642c 2073 7065 6369 6669 6573   grad, specifies
+00009bc0: 2061 2067 7261 6420 6f66 206f 6e65 735f   a grad of ones_
+00009bd0: 6c69 6b65 286f 290a 6465 6620 5f67 7261  like(o).def _gra
+00009be0: 645f 7370 6563 6966 6965 725f 6465 6661  d_specifier_defa
+00009bf0: 756c 7428 7079 7472 6565 3a20 416e 7929  ult(pytree: Any)
+00009c00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 666c   -> None:.    fl
+00009c10: 6174 732c 205f 203d 2074 7265 655f 666c  ats, _ = tree_fl
+00009c20: 6174 7465 6e28 7079 7472 6565 290a 0a20  atten(pytree).. 
+00009c30: 2020 2066 6f72 2066 2069 6e20 666c 6174     for f in flat
+00009c40: 733a 0a20 2020 2020 2020 2069 6620 6973  s:.        if is
+00009c50: 696e 7374 616e 6365 2866 2c20 5465 6e73  instance(f, Tens
+00009c60: 6f72 5072 6f78 7929 2061 6e64 2066 2e72  orProxy) and f.r
+00009c70: 6571 7569 7265 735f 6772 6164 3a0a 2020  equires_grad:.  
+00009c80: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00009c90: 2054 6869 7320 7573 6573 2063 6c61 6e67   This uses clang
+00009ca0: 2e6f 6e65 735f 6c69 6b65 2066 6f72 206e  .ones_like for n
+00009cb0: 6f77 2062 6563 6175 7365 206c 746f 7263  ow because ltorc
+00009cc0: 682e 6f6e 6573 5f6c 696b 6520 7769 6c6c  h.ones_like will
+00009cd0: 2065 7874 656e 6420 7468 650a 2020 2020   extend the.    
+00009ce0: 2020 2020 2020 2020 2320 2020 6c69 6665          #   life
+00009cf0: 7469 6d65 206f 6620 662c 2077 6869 6c65  time of f, while
+00009d00: 2063 6c61 6e67 2e6f 6e65 735f 6c69 6b65   clang.ones_like
+00009d10: 2077 696c 6c20 6578 7472 6163 7420 7468   will extract th
+00009d20: 6520 6d65 7461 6461 7461 206f 6620 6620  e metadata of f 
+00009d30: 6174 2074 7261 6365 2074 696d 650a 2020  at trace time.  
+00009d40: 2020 2020 2020 2020 2020 7072 696d 732e            prims.
+00009d50: 7075 745f 6772 6164 2866 2c20 636c 616e  put_grad(f, clan
+00009d60: 672e 6675 6c6c 5f6c 696b 6528 662c 2031  g.full_like(f, 1
+00009d70: 2e30 2929 0a0a 0a23 2054 4f44 4f20 5465  .0))...# TODO Te
+00009d80: 7374 2077 6974 6820 6275 6666 6572 730a  st with buffers.
+00009d90: 6465 6620 5f67 7261 645f 6f75 745f 7370  def _grad_out_sp
+00009da0: 6563 6966 6965 725f 6465 6661 756c 7428  ecifier_default(
+00009db0: 7079 7472 6565 3a20 416e 7929 202d 3e20  pytree: Any) -> 
+00009dc0: 6c69 7374 5b54 656e 736f 7250 726f 7879  list[TensorProxy
+00009dd0: 5d3a 0a20 2020 2066 6c61 7473 2c20 5f20  ]:.    flats, _ 
+00009de0: 3d20 7472 6565 5f66 6c61 7474 656e 2870  = tree_flatten(p
+00009df0: 7974 7265 6529 0a20 2020 2067 7261 6473  ytree).    grads
+00009e00: 203d 206c 6973 7428 5b70 7269 6d73 2e67   = list([prims.g
+00009e10: 6574 5f67 7261 6428 6629 2066 6f72 2066  et_grad(f) for f
+00009e20: 2069 6e20 666c 6174 7320 6966 2069 7369   in flats if isi
+00009e30: 6e73 7461 6e63 6528 662c 2054 656e 736f  nstance(f, Tenso
+00009e40: 7250 726f 7879 2920 616e 6420 662e 7265  rProxy) and f.re
+00009e50: 7175 6972 6573 5f67 7261 645d 290a 2020  quires_grad]).  
+00009e60: 2020 7265 7475 726e 2067 7261 6473 0a0a    return grads..
+00009e70: 0a23 2054 4f44 4f20 466f 726d 616c 6c79  .# TODO Formally
+00009e80: 2064 6566 696e 6520 7468 6520 2267 7261   define the "gra
+00009e90: 6469 656e 7422 206f 6620 6120 7465 6e73  dient" of a tens
+00009ea0: 6f72 0a23 2054 4f44 4f20 4966 206e 6f6e  or.# TODO If non
+00009eb0: 6520 6f66 2074 6865 2069 6e70 7574 7320  e of the inputs 
+00009ec0: 746f 2061 6e20 6f70 6572 6174 696f 6e20  to an operation 
+00009ed0: 7265 7175 6972 6520 6772 6164 2c20 7468  require grad, th
+00009ee0: 656e 2077 6520 636f 756c 6420 6c65 6176  en we could leav
+00009ef0: 6520 7468 6174 206f 7065 7261 7469 6f6e  e that operation
+00009f00: 2061 6c6f 6e65 0a23 2020 2054 6869 7320   alone.#   This 
+00009f10: 636f 756c 6420 6163 7475 616c 6c79 2069  could actually i
+00009f20: 6d70 726f 7665 2070 6572 666f 726d 616e  mprove performan
+00009f30: 6365 2069 6620 7468 6520 6f70 6572 6174  ce if the operat
+00009f40: 696f 6e20 7065 7266 6f72 6d73 2065 7874  ion performs ext
+00009f50: 7261 2063 6f6d 7075 7461 7469 6f6e 7320  ra computations 
+00009f60: 696e 2069 7473 2067 7261 6420 7472 616e  in its grad tran
+00009f70: 7366 6f72 6d0a 2320 2020 4120 776f 726b  sform.#   A work
+00009f80: 6172 6f75 6e64 2066 6f72 2074 6869 7320  around for this 
+00009f90: 776f 756c 6420 6265 2066 6f72 2074 6865  would be for the
+00009fa0: 206f 7065 7261 7469 6f6e 2069 7473 656c   operation itsel
+00009fb0: 6620 746f 2063 6865 636b 2069 6620 6974  f to check if it
+00009fc0: 7320 696e 7075 7420 7265 7175 6972 6573  s input requires
+00009fd0: 2067 7261 6420 6f72 206e 6f74 0a23 2054   grad or not.# T
+00009fe0: 7261 6e73 666f 726d 7320 6120 6675 6e63  ransforms a func
+00009ff0: 7469 6f6e 2074 6f20 636f 6d70 7574 6520  tion to compute 
+0000a000: 7468 6520 2267 7261 6469 656e 7422 206f  the "gradient" o
+0000a010: 6620 6974 7320 696e 7075 7473 2072 6571  f its inputs req
+0000a020: 7569 7269 6e67 2067 7261 642c 2070 6f73  uiring grad, pos
+0000a030: 7369 626c 790a 2320 2020 6d6f 6469 6669  sibly.#   modifi
+0000a040: 6564 2062 7920 7468 6520 6772 6164 2073  ed by the grad s
+0000a050: 7065 6369 6669 6572 7320 2873 6565 2062  pecifiers (see b
+0000a060: 656c 6f77 292e 0a23 2054 6865 206f 7074  elow)..# The opt
+0000a070: 696f 6e61 6c20 6772 6164 5f73 7065 6369  ional grad_speci
+0000a080: 6669 6572 2061 7267 756d 656e 7420 6163  fier argument ac
+0000a090: 6365 7074 7320 7468 6520 6675 6e63 7469  cepts the functi
+0000a0a0: 6f6e 2773 206f 7574 7075 742c 2072 756e  on's output, run
+0000a0b0: 7320 696e 2061 206e 6f2d 6772 6164 2063  s in a no-grad c
+0000a0c0: 6f6e 7465 7874 2c0a 2320 2020 616e 6420  ontext,.#   and 
+0000a0d0: 6361 6e20 7075 7420 6772 6164 7320 2875  can put grads (u
+0000a0e0: 7369 6e67 2070 7269 6d73 2e70 7574 5f67  sing prims.put_g
+0000a0f0: 7261 6428 2929 2066 6f72 2074 656e 736f  rad()) for tenso
+0000a100: 7273 2e20 4279 2064 6566 6175 6c74 2c20  rs. By default, 
+0000a110: 666f 7220 6576 6572 7920 7465 6e73 6f72  for every tensor
+0000a120: 206f 7574 7075 7420 226f 220a 2320 2020   output "o".#   
+0000a130: 7468 6174 2072 6571 7569 7265 7320 6772  that requires gr
+0000a140: 6164 2c20 6120 6772 6164 206f 6620 6f6e  ad, a grad of on
+0000a150: 6573 5f6c 696b 6528 6f29 2069 7320 7075  es_like(o) is pu
+0000a160: 742e 0a23 2054 6865 206f 7074 696f 6e61  t..# The optiona
+0000a170: 6c20 6772 6164 5f6f 7574 5f73 7065 6369  l grad_out_speci
+0000a180: 6669 6572 2061 6363 6570 7473 2074 6865  fier accepts the
+0000a190: 2066 756e 6374 696f 6e27 7320 696e 7075   function's inpu
+0000a1a0: 7420 616e 6420 6361 6e20 6361 6c6c 2070  t and can call p
+0000a1b0: 7269 6d73 2e67 6574 5f67 7261 6428 2920  rims.get_grad() 
+0000a1c0: 746f 0a23 2020 2061 6371 7569 7265 2061  to.#   acquire a
+0000a1d0: 6e64 2072 6574 7572 6e20 6772 6164 6965  nd return gradie
+0000a1e0: 6e74 7320 6173 2064 6573 6972 6564 2e20  nts as desired. 
+0000a1f0: 4279 2064 6566 6175 6c74 2c20 7468 6520  By default, the 
+0000a200: 696e 7075 7420 6973 2066 6c61 7474 656e  input is flatten
+0000a210: 6564 0a23 2020 2028 7472 6565 5f66 6c61  ed.#   (tree_fla
+0000a220: 7474 656e 2861 7267 732c 206b 7761 7267  tten(args, kwarg
+0000a230: 7329 2920 616e 6420 6120 666c 6174 206c  s)) and a flat l
+0000a240: 6973 7420 6f66 2067 7261 6473 2066 6f72  ist of grads for
+0000a250: 2061 6c6c 2074 656e 736f 7273 2072 6571   all tensors req
+0000a260: 7569 7269 6e67 2067 7261 640a 2320 2020  uiring grad.#   
+0000a270: 616e 6420 4e6f 6e65 2066 6f72 206f 7468  and None for oth
+0000a280: 6572 2069 6e70 7574 7320 6973 2072 6574  er inputs is ret
+0000a290: 7572 6e65 642e 0a23 2054 6865 2061 6c67  urned..# The alg
+0000a2a0: 6f72 6974 686d 2066 6f72 206d 6f64 6966  orithm for modif
+0000a2b0: 7969 6e67 2074 6865 2070 726f 6772 616d  ying the program
+0000a2c0: 2068 6173 2074 6865 2066 6f6c 6c6f 7769   has the followi
+0000a2d0: 6e67 2073 7465 7073 3a0a 2320 2020 3129  ng steps:.#   1)
+0000a2e0: 2046 6c61 7474 656e 7320 7468 6520 6f72   Flattens the or
+0000a2f0: 6967 696e 616c 2074 7261 6365 2066 6f72  iginal trace for
+0000a300: 2074 6865 2067 7261 6420 7472 616e 7366   the grad transf
+0000a310: 6f72 6d20 2d2d 2065 6e73 7569 6e67 2074  orm -- ensuing t
+0000a320: 6861 7420 616c 6c20 746f 702d 6c65 7665  hat all top-leve
+0000a330: 6c20 7379 6d62 6f6c 7320 6861 7665 0a23  l symbols have.#
+0000a340: 2020 2020 2020 2061 2067 7261 6420 6675         a grad fu
+0000a350: 6e63 7469 6f6e 2e0a 6465 6620 6772 6164  nction..def grad
+0000a360: 280a 2020 2020 6366 6e2c 2067 7261 645f  (.    cfn, grad_
+0000a370: 7370 6563 6966 6965 723a 2043 616c 6c61  specifier: Calla
+0000a380: 626c 6520 3d20 5f67 7261 645f 7370 6563  ble = _grad_spec
+0000a390: 6966 6965 725f 6465 6661 756c 742c 2067  ifier_default, g
+0000a3a0: 7261 645f 6f75 745f 7370 6563 6966 6965  rad_out_specifie
+0000a3b0: 723a 2043 616c 6c61 626c 6520 3d20 5f67  r: Callable = _g
+0000a3c0: 7261 645f 6f75 745f 7370 6563 6966 6965  rad_out_specifie
+0000a3d0: 725f 6465 6661 756c 740a 2920 2d3e 2043  r_default.) -> C
+0000a3e0: 616c 6c61 626c 653a 0a20 2020 2023 2043  allable:.    # C
+0000a3f0: 7265 6174 6573 2061 2063 7573 746f 6d20  reates a custom 
+0000a400: 7472 616e 7366 6f72 6d20 6361 6c6c 6162  transform callab
+0000a410: 6c65 2074 6861 7420 6269 6e64 7320 7468  le that binds th
+0000a420: 6520 6164 6469 7469 6f6e 616c 2061 7267  e additional arg
+0000a430: 756d 656e 7473 2074 6f20 7468 6520 6772  uments to the gr
+0000a440: 6164 2074 7261 6e73 666f 726d 0a20 2020  ad transform.   
+0000a450: 2040 6c61 6e67 6374 7828 4c61 6e67 7561   @langctx(Langua
+0000a460: 6765 732e 434c 414e 4729 0a20 2020 2064  ges.CLANG).    d
+0000a470: 6566 205f 6772 6164 5f74 7261 6e73 666f  ef _grad_transfo
+0000a480: 726d 2874 7263 3a20 5472 6163 652c 202a  rm(trc: Trace, *
+0000a490: 2c20 6578 6563 7574 6f72 735f 6c69 7374  , executors_list
+0000a4a0: 3a20 5365 7175 656e 6365 5b41 6e79 5d29  : Sequence[Any])
+0000a4b0: 202d 3e20 5472 6163 653a 0a20 2020 2020   -> Trace:.     
+0000a4c0: 2020 2073 7461 7274 5f74 696d 655f 6e73     start_time_ns
+0000a4d0: 203d 2074 696d 652e 7469 6d65 5f6e 7328   = time.time_ns(
+0000a4e0: 290a 0a20 2020 2020 2020 2023 2053 5445  )..        # STE
+0000a4f0: 5020 4f4e 4520 2d2d 2046 6c61 7474 656e  P ONE -- Flatten
+0000a500: 7320 616e 6420 6463 6573 0a0a 2020 2020  s and dces..    
+0000a510: 2020 2020 2320 5265 7475 726e 7320 5472      # Returns Tr
+0000a520: 7565 2069 6620 7468 6520 6273 796d 2068  ue if the bsym h
+0000a530: 6173 206e 6f20 6772 6164 2066 756e 6374  as no grad funct
+0000a540: 696f 6e2c 2061 6e64 2073 6f20 6d75 7374  ion, and so must
+0000a550: 2062 6520 666c 6174 7465 6e65 6420 666f   be flattened fo
+0000a560: 7220 7468 6520 6772 6164 2074 7261 6e73  r the grad trans
+0000a570: 666f 726d 0a20 2020 2020 2020 206e 6576  form.        nev
+0000a580: 6572 5f66 6c61 7474 656e 3a20 7365 745b  er_flatten: set[
+0000a590: 4861 7368 6162 6c65 5d20 3d20 7b70 7269  Hashable] = {pri
+0000a5a0: 6d73 2e50 7269 6d49 4473 2e52 4554 5552  ms.PrimIDs.RETUR
+0000a5b0: 4e2c 2070 7269 6d73 2e50 7269 6d49 4473  N, prims.PrimIDs
+0000a5c0: 2e55 4e50 4143 4b5f 5452 4956 4941 4c7d  .UNPACK_TRIVIAL}
+0000a5d0: 0a0a 2020 2020 2020 2020 6465 6620 7368  ..        def sh
+0000a5e0: 6f75 6c64 5f66 6c61 7474 656e 5f66 6f72  ould_flatten_for
+0000a5f0: 5f67 7261 6428 6273 796d 3a20 426f 756e  _grad(bsym: Boun
+0000a600: 6453 796d 626f 6c29 202d 3e20 626f 6f6c  dSymbol) -> bool
+0000a610: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000a620: 2062 7379 6d2e 7379 6d2e 6964 2069 6e20   bsym.sym.id in 
+0000a630: 6e65 7665 725f 666c 6174 7465 6e3a 0a20  never_flatten:. 
+0000a640: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000a650: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+0000a660: 2020 2020 2020 2020 2067 7261 6466 6e3a           gradfn:
+0000a670: 204e 6f6e 6520 7c20 4361 6c6c 6162 6c65   None | Callable
+0000a680: 0a20 2020 2020 2020 2020 2020 2067 7261  .            gra
+0000a690: 6466 6e2c 205f 203d 205f 6765 745f 6772  dfn, _ = _get_gr
+0000a6a0: 6164 666e 5f61 6e64 5f65 7865 6375 746f  adfn_and_executo
+0000a6b0: 7228 6273 796d 2c20 6578 6563 7574 6f72  r(bsym, executor
+0000a6c0: 735f 6c69 7374 3d65 7865 6375 746f 7273  s_list=executors
+0000a6d0: 5f6c 6973 7429 0a20 2020 2020 2020 2020  _list).         
+0000a6e0: 2020 2072 6574 7572 6e20 6772 6164 666e     return gradfn
+0000a6f0: 2069 7320 4e6f 6e65 0a0a 2020 2020 2020   is None..      
+0000a700: 2020 2320 544f 444f 2052 4331 3a20 6d61    # TODO RC1: ma
+0000a710: 7962 6520 6d6f 7665 2074 6f20 7072 6f64  ybe move to prod
+0000a720: 7563 6520 7468 6573 6520 616c 7761 7973  uce these always
+0000a730: 206f 6e20 6372 6561 7469 6f6e 0a20 2020   on creation.   
+0000a740: 2020 2020 2069 6620 7472 632e 6b77 6172       if trc.kwar
+0000a750: 6773 2069 7320 4e6f 6e65 3a0a 2020 2020  gs is None:.    
+0000a760: 2020 2020 2020 2020 7472 632e 6b77 6172          trc.kwar
+0000a770: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
+0000a780: 6966 2074 7263 2e66 6e20 6973 204e 6f6e  if trc.fn is Non
+0000a790: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+0000a7a0: 7263 2e66 6e20 3d20 7472 632e 7079 7468  rc.fn = trc.pyth
+0000a7b0: 6f6e 5f63 616c 6c61 626c 6528 290a 0a20  on_callable().. 
+0000a7c0: 2020 2020 2020 2067 7261 6474 7263 203d         gradtrc =
+0000a7d0: 2066 726f 6d5f 7472 6163 6528 7472 6329   from_trace(trc)
+0000a7e0: 0a20 2020 2020 2020 2066 6c61 7474 656e  .        flatten
+0000a7f0: 6564 5f62 7379 6d73 3a20 6c69 7374 5b42  ed_bsyms: list[B
+0000a800: 6f75 6e64 5379 6d62 6f6c 5d20 3d20 666c  oundSymbol] = fl
+0000a810: 6174 7465 6e5f 666f 725f 7472 616e 7366  atten_for_transf
+0000a820: 6f72 6d28 7368 6f75 6c64 5f66 6c61 7474  orm(should_flatt
+0000a830: 656e 5f66 6f72 5f67 7261 642c 2074 7263  en_for_grad, trc
+0000a840: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
+0000a850: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
+0000a860: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
+0000a870: 666c 6174 7465 6e65 645f 6273 796d 730a  flattened_bsyms.
+0000a880: 2020 2020 2020 2020 6772 6164 7472 6320          gradtrc 
+0000a890: 3d20 6463 6528 6772 6164 7472 6329 0a0a  = dce(gradtrc)..
+0000a8a0: 2020 2020 2020 2020 2320 5354 4550 2054          # STEP T
+0000a8b0: 574f 202d 2d20 5265 706c 6163 6573 206f  WO -- Replaces o
+0000a8c0: 7269 6769 6e61 6c20 6361 6c6c 7320 7769  riginal calls wi
+0000a8d0: 7468 2067 7261 6420 6361 6c6c 730a 0a20  th grad calls.. 
+0000a8e0: 2020 2020 2020 2023 2044 6566 696e 6573         # Defines
+0000a8f0: 2074 6865 2076 6973 6974 6f72 2070 6174   the visitor pat
+0000a900: 7465 726e 2066 6f72 2074 6865 2066 6972  tern for the fir
+0000a910: 7374 2070 6173 7320 6f66 2074 6865 2067  st pass of the g
+0000a920: 7261 6420 7472 616e 7366 6f72 6d2c 0a20  rad transform,. 
+0000a930: 2020 2020 2020 2023 2020 2077 6869 6368         #   which
+0000a940: 2073 7761 7073 2042 6f75 6e64 5379 6d62   swaps BoundSymb
+0000a950: 6f6c 7320 7769 7468 2074 6865 6972 2067  ols with their g
+0000a960: 7261 6420 6675 6e63 7469 6f6e 730a 2020  rad functions.  
+0000a970: 2020 2020 2020 6465 6620 7669 7369 745f        def visit_
+0000a980: 2862 7379 6d3a 2042 6f75 6e64 5379 6d62  (bsym: BoundSymb
+0000a990: 6f6c 2920 2d3e 2043 616c 6c61 626c 653a  ol) -> Callable:
+0000a9a0: 0a20 2020 2020 2020 2020 2020 2067 7261  .            gra
+0000a9b0: 6466 6e3a 204e 6f6e 6520 7c20 4361 6c6c  dfn: None | Call
+0000a9c0: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
+0000a9d0: 2067 7261 6466 6e2c 205f 203d 205f 6765   gradfn, _ = _ge
+0000a9e0: 745f 6772 6164 666e 5f61 6e64 5f65 7865  t_gradfn_and_exe
+0000a9f0: 6375 746f 7228 6273 796d 2c20 6578 6563  cutor(bsym, exec
+0000aa00: 7574 6f72 735f 6c69 7374 3d65 7865 6375  utors_list=execu
+0000aa10: 746f 7273 5f6c 6973 7429 0a20 2020 2020  tors_list).     
+0000aa20: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
+0000aa30: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+0000aa40: 6164 666e 2069 7320 6e6f 7420 4e6f 6e65  adfn is not None
+0000aa50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000aa60: 2020 6c61 6d62 6461 3a20 6622 4661 696c    lambda: f"Fail
+0000aa70: 6564 2074 6f20 6669 6e64 2061 2067 7261  ed to find a gra
+0000aa80: 6466 6e20 666f 7220 7b62 7379 6d3d 7d20  dfn for {bsym=} 
+0000aa90: 6166 7465 7220 666c 6174 7465 6e69 6e67  after flattening
+0000aaa0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000aab0: 2020 2065 7863 6570 7469 6f6e 5f74 7970     exception_typ
+0000aac0: 653d 4173 7365 7274 696f 6e45 7272 6f72  e=AssertionError
+0000aad0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000aae0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000aaf0: 726e 2067 7261 6466 6e0a 0a20 2020 2020  rn gradfn..     
+0000ab00: 2020 2040 7772 6170 7328 7472 632e 666e     @wraps(trc.fn
+0000ab10: 2e6d 6574 6120 6966 2069 7369 6e73 7461  .meta if isinsta
+0000ab20: 6e63 6528 7472 632e 666e 2c20 5379 6d62  nce(trc.fn, Symb
+0000ab30: 6f6c 2920 656c 7365 2074 7263 2e66 6e29  ol) else trc.fn)
+0000ab40: 0a20 2020 2020 2020 2064 6566 2069 6e74  .        def int
+0000ab50: 6572 7072 6574 696e 675f 666e 282a 6172  erpreting_fn(*ar
+0000ab60: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0000ab70: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0000ab80: 7420 3d20 6576 616c 5f74 7261 6365 2867  t = eval_trace(g
+0000ab90: 7261 6474 7263 2c20 2a61 7267 732c 2073  radtrc, *args, s
+0000aba0: 796d 626f 6c5f 6d61 7070 6572 3d76 6973  ymbol_mapper=vis
+0000abb0: 6974 5f2c 202a 2a6b 7761 7267 7329 0a20  it_, **kwargs). 
+0000abc0: 2020 2020 2020 2020 2020 2023 2053 6574             # Set
+0000abd0: 7320 6772 6164 7320 666f 7220 6f75 7470  s grads for outp
+0000abe0: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
+0000abf0: 2054 4f44 4f20 5468 6973 2065 6666 6563   TODO This effec
+0000ac00: 7469 7665 6c79 2072 756e 7320 696e 2061  tively runs in a
+0000ac10: 206e 6f20 6772 6164 2063 6f6e 7465 7874   no grad context
+0000ac20: 202d 2d20 7368 6f75 6c64 2069 7420 7275   -- should it ru
+0000ac30: 6e20 696e 2061 2067 7261 6420 636f 6e74  n in a grad cont
+0000ac40: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
+0000ac50: 2023 2020 206f 7220 7368 6f75 6c64 2074   #   or should t
+0000ac60: 6865 7265 2062 6520 7468 6520 6f70 7469  here be the opti
+0000ac70: 6f6e 2074 6f20 7275 6e20 6974 2069 6e20  on to run it in 
+0000ac80: 6120 6772 6164 2063 6f6e 7465 7874 3f0a  a grad context?.
+0000ac90: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+0000aca0: 5f73 7065 6369 6669 6572 2872 6573 756c  _specifier(resul
+0000acb0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
+0000acc0: 2043 6f6e 7374 7275 6374 7320 7265 7475   Constructs retu
+0000acd0: 726e 2076 616c 7565 0a20 2020 2020 2020  rn value.       
+0000ace0: 2020 2020 2066 6c61 745f 6772 6164 7320       flat_grads 
+0000acf0: 3d20 6772 6164 5f6f 7574 5f73 7065 6369  = grad_out_speci
+0000ad00: 6669 6572 2828 6172 6773 2c20 6b77 6172  fier((args, kwar
+0000ad10: 6773 2929 0a20 2020 2020 2020 2020 2020  gs)).           
+0000ad20: 2072 6574 7572 6e20 666c 6174 5f67 7261   return flat_gra
+0000ad30: 6473 0a0a 2020 2020 2020 2020 2320 4e4f  ds..        # NO
+0000ad40: 5445 2041 6674 6572 2074 6869 7320 6361  TE After this ca
+0000ad50: 6c6c 2074 6865 2067 7261 6474 7263 2069  ll the gradtrc i
+0000ad60: 7320 696e 7661 6c69 642c 2062 6563 6175  s invalid, becau
+0000ad70: 7365 3a0a 2020 2020 2020 2020 2320 2020  se:.        #   
+0000ad80: 3129 2054 6865 206e 6f6e 2d65 7865 6375  1) The non-execu
+0000ad90: 7461 626c 6520 7075 745f 6772 6164 206f  table put_grad o
+0000ada0: 7065 7261 7469 6f6e 7320 6172 6520 7374  perations are st
+0000adb0: 696c 6c20 696e 2074 6865 2074 7261 6365  ill in the trace
+0000adc0: 2c20 616e 6420 6d75 6c74 6970 6c65 2063  , and multiple c
+0000add0: 616c 6c73 2074 6f20 7075 7420 6772 6164  alls to put grad
+0000ade0: 2061 7265 206e 6f74 2061 6363 756d 756c   are not accumul
+0000adf0: 6174 6564 0a20 2020 2020 2020 2023 2020  ated.        #  
+0000ae00: 2032 2920 5468 6520 6e6f 6e2d 6578 6563   2) The non-exec
+0000ae10: 7574 6162 6c65 2067 6574 5f67 7261 6420  utable get_grad 
+0000ae20: 6f70 6572 6174 696f 6e73 2061 7265 2073  operations are s
+0000ae30: 7469 6c6c 2069 6e20 7468 6520 7472 6163  till in the trac
+0000ae40: 652c 2061 6e64 2074 6865 7920 6d61 7920  e, and they may 
+0000ae50: 7072 6f64 7563 6520 6469 6666 6572 656e  produce differen
+0000ae60: 7420 7072 6f78 6965 7320 7768 656e 0a20  t proxies when. 
+0000ae70: 2020 2020 2020 2023 2020 2020 2020 2063         #       c
+0000ae80: 616c 6c65 6420 6f6e 2074 6865 2073 616d  alled on the sam
+0000ae90: 6520 696e 7075 7473 0a20 2020 2020 2020  e inputs.       
+0000aea0: 2023 2020 2033 2920 5468 6520 6f70 6572   #   3) The oper
+0000aeb0: 6174 696f 6e73 2061 7265 206e 6f74 2069  ations are not i
+0000aec0: 6e20 6120 7661 6c69 6420 6f72 6465 720a  n a valid order.
+0000aed0: 2020 2020 2020 2020 6772 6164 7472 6320          gradtrc 
+0000aee0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+0000aef0: 6528 0a20 2020 2020 2020 2020 2020 2072  e(.            r
+0000af00: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
+0000af10: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+0000af20: 2075 7365 5f64 6365 3d46 616c 7365 2c0a   use_dce=False,.
+0000af30: 2020 2020 2020 2020 2928 696e 7465 7270          )(interp
+0000af40: 7265 7469 6e67 5f66 6e2c 202a 6772 6164  reting_fn, *grad
+0000af50: 7472 632e 6172 6773 2c20 2a2a 6772 6164  trc.args, **grad
+0000af60: 7472 632e 6b77 6172 6773 290a 2020 2020  trc.kwargs).    
+0000af70: 2020 2020 6772 6164 7472 632e 7363 6f70      gradtrc.scop
+0000af80: 6573 203d 205b 6772 6164 7472 632e 626f  es = [gradtrc.bo
+0000af90: 756e 645f 7379 6d62 6f6c 735d 0a20 2020  und_symbols].   
+0000afa0: 2020 2020 2067 7261 6474 7263 2e5f 636f       gradtrc._co
+0000afb0: 6d70 6c65 7465 203d 2046 616c 7365 0a0a  mplete = False..
+0000afc0: 2020 2020 2020 2020 2320 5354 4550 2054          # STEP T
+0000afd0: 4852 4545 202d 2d20 4861 6e64 6c65 7320  HREE -- Handles 
+0000afe0: 7075 745f 6772 6164 2061 6e64 2067 6574  put_grad and get
+0000aff0: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
+0000b000: 2061 6e64 2061 6363 756d 756c 6174 6573   and accumulates
+0000b010: 2067 7261 6469 656e 7473 0a0a 2020 2020   gradients..    
+0000b020: 2020 2020 2320 4163 6375 6d75 6c61 7465      # Accumulate
+0000b030: 7320 6772 6164 6965 6e74 732c 2063 7265  s gradients, cre
+0000b040: 6174 696e 6720 7468 6520 7072 696d 616c  ating the primal
+0000b050: 202d 3e20 6163 6375 6d75 6c61 7465 6420   -> accumulated 
+0000b060: 6772 6164 206d 6170 7069 6e67 0a20 2020  grad mapping.   
+0000b070: 2020 2020 2023 2053 6574 7320 7468 6520       # Sets the 
+0000b080: 7472 6163 696e 6720 636f 6e74 6578 7420  tracing context 
+0000b090: 736f 2061 6363 756d 756c 6174 696f 6e20  so accumulation 
+0000b0a0: 6f70 6572 6174 696f 6e73 2061 7265 2072  operations are r
+0000b0b0: 6563 6f72 6465 6420 696e 746f 2074 6865  ecorded into the
+0000b0c0: 2074 7261 6365 0a20 2020 2020 2020 2074   trace.        t
+0000b0d0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000b0e0: 7472 6163 6563 7478 5f74 6f6b 203d 2073  tracectx_tok = s
+0000b0f0: 6574 5f74 7261 6365 6374 7828 6772 6164  et_tracectx(grad
+0000b100: 7472 6329 0a0a 2020 2020 2020 2020 2020  trc)..          
+0000b110: 2020 2320 4d61 7073 2070 7269 6d61 6c73    # Maps primals
+0000b120: 2074 6f20 7468 6569 7220 6772 6164 6965   to their gradie
+0000b130: 6e74 7320 2877 6869 6368 2061 7265 2072  nts (which are r
+0000b140: 6574 7572 6e65 6420 6672 6f6d 2063 616c  eturned from cal
+0000b150: 6c69 6e67 2067 6574 5f67 7261 6420 6f6e  ling get_grad on
+0000b160: 2074 6865 2070 7269 6d61 6c29 0a20 2020   the primal).   
+0000b170: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
+0000b180: 5f74 6f5f 6769 6e70 7574 5f6d 6170 3a20  _to_ginput_map: 
+0000b190: 6469 6374 5b56 6172 6961 626c 652c 2054  dict[Variable, T
+0000b1a0: 656e 736f 7250 726f 7879 5d20 3d20 7b7d  ensorProxy] = {}
+0000b1b0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000b1c0: 4861 6e64 6c65 7320 7075 745f 6772 6164  Handles put_grad
+0000b1d0: 206f 7065 7261 7469 6f6e 730a 2020 2020   operations.    
+0000b1e0: 2020 2020 2020 2020 2320 4e4f 5445 2054          # NOTE T
+0000b1f0: 6869 7320 6d6f 6469 6669 6573 2061 206c  his modifies a l
+0000b200: 6973 7420 7468 6174 2069 7320 6265 696e  ist that is bein
+0000b210: 6720 656e 756d 6572 6174 6564 206f 7665  g enumerated ove
+0000b220: 722c 2062 7574 2069 7427 7320 4f4b 2062  r, but it's OK b
+0000b230: 6563 6175 7365 2077 6527 7265 206f 6e6c  ecause we're onl
+0000b240: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
+0000b250: 2020 6170 7065 6e64 696e 6720 746f 2074    appending to t
+0000b260: 6865 2065 6e64 206f 6620 7468 6520 6c69  he end of the li
+0000b270: 7374 0a20 2020 2020 2020 2020 2020 2062  st.            b
+0000b280: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
+0000b290: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000b2a0: 2062 7379 6d20 696e 2067 7261 6474 7263   bsym in gradtrc
+0000b2b0: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
+0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2d0: 6964 3a20 4861 7368 6162 6c65 203d 2062  id: Hashable = b
+0000b2e0: 7379 6d2e 7379 6d2e 6964 0a20 2020 2020  sym.sym.id.     
+0000b2f0: 2020 2020 2020 2020 2020 2069 6620 6964             if id
+0000b300: 2069 7320 7069 6473 2e50 5554 5f47 5241   is pids.PUT_GRA
+0000b310: 443a 0a20 2020 2020 2020 2020 2020 2020  D:.             
+0000b320: 2020 2020 2020 2070 7269 6d61 6c3a 204e         primal: N
+0000b330: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+0000b340: 6f78 790a 2020 2020 2020 2020 2020 2020  oxy.            
+0000b350: 2020 2020 2020 2020 6772 6164 3a20 4e75          grad: Nu
+0000b360: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+0000b370: 7879 0a20 2020 2020 2020 2020 2020 2020  xy.             
+0000b380: 2020 2020 2020 2070 7269 6d61 6c2c 2067         primal, g
+0000b390: 7261 6420 3d20 6273 796d 2e66 6c61 745f  rad = bsym.flat_
+0000b3a0: 6172 6773 0a0a 2020 2020 2020 2020 2020  args..          
+0000b3b0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+0000b3c0: 2053 7570 706f 7274 2061 7574 6f67 7261   Support autogra
+0000b3d0: 6420 6f6e 206e 756d 6265 7273 0a20 2020  d on numbers.   
+0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3f0: 2023 2046 696c 7465 7273 2063 616c 6c73   # Filters calls
+0000b400: 2074 6f20 7075 745f 6772 6164 2074 6861   to put_grad tha
+0000b410: 7420 776f 756c 6420 7075 7420 6120 6772  t would put a gr
+0000b420: 6164 206f 6e20 6120 6e6f 6e2d 7465 6e73  ad on a non-tens
+0000b430: 6f72 206f 7220 6120 7465 6e73 6f72 2074  or or a tensor t
+0000b440: 6861 7420 646f 6573 6e27 7420 7265 7175  hat doesn't requ
+0000b450: 6972 6520 6772 6164 0a20 2020 2020 2020  ire grad.       
+0000b460: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000b470: 6e6f 7420 6973 696e 7374 616e 6365 2870  not isinstance(p
+0000b480: 7269 6d61 6c2c 2054 656e 736f 7250 726f  rimal, TensorPro
+0000b490: 7879 2920 6f72 206e 6f74 2070 7269 6d61  xy) or not prima
+0000b4a0: 6c2e 7265 7175 6972 6573 5f67 7261 643a  l.requires_grad:
+0000b4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b4c0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0000b4d0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+0000b4e0: 2020 2020 2020 2023 2054 4f44 4f20 5375         # TODO Su
+0000b4f0: 7070 6f72 7420 636f 6d70 6c65 7820 6175  pport complex au
+0000b500: 746f 6772 6164 0a20 2020 2020 2020 2020  tograd.         
+0000b510: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0000b520: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000b530: 2020 2020 2020 2020 2020 6e6f 7420 6474            not dt
+0000b540: 7970 6573 2e69 735f 636f 6d70 6c65 785f  ypes.is_complex_
+0000b550: 6474 7970 6528 6474 7970 6573 2e74 6f5f  dtype(dtypes.to_
+0000b560: 6474 7970 6528 7072 696d 616c 2929 2c0a  dtype(primal)),.
+0000b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b580: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0000b590: 6622 436f 6d70 6c65 7820 6772 6164 2069  f"Complex grad i
+0000b5a0: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
+0000b5b0: 7965 7422 2c0a 2020 2020 2020 2020 2020  yet",.          
+0000b5c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5e0: 2076 7072 696d 616c 3a20 5661 7269 6162   vprimal: Variab
+0000b5f0: 6c65 203d 2076 6172 6961 626c 6569 6679  le = variableify
+0000b600: 2870 7269 6d61 6c29 0a20 2020 2020 2020  (primal).       
+0000b610: 2020 2020 2020 2020 2020 2020 2061 6363               acc
+0000b620: 756d 3a20 4e6f 6e65 207c 2054 656e 736f  um: None | Tenso
+0000b630: 7250 726f 7879 203d 2070 7269 6d61 6c73  rProxy = primals
+0000b640: 5f74 6f5f 6769 6e70 7574 5f6d 6170 2e67  _to_ginput_map.g
+0000b650: 6574 2876 7072 696d 616c 2c20 4e6f 6e65  et(vprimal, None
+0000b660: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b670: 2020 2020 2020 2069 6620 6163 6375 6d20         if accum 
+0000b680: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0000b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6a0: 2070 7269 6d61 6c73 5f74 6f5f 6769 6e70   primals_to_ginp
+0000b6b0: 7574 5f6d 6170 5b76 7072 696d 616c 5d20  ut_map[vprimal] 
+0000b6c0: 3d20 6772 6164 0a20 2020 2020 2020 2020  = grad.         
+0000b6d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000b6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b6f0: 2020 2020 2020 2020 2061 6363 756d 203d           accum =
+0000b700: 2061 6363 756d 202b 2067 7261 640a 2020   accum + grad.  
+0000b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b720: 2020 2020 2020 7072 696d 616c 735f 746f        primals_to
+0000b730: 5f67 696e 7075 745f 6d61 705b 7670 7269  _ginput_map[vpri
+0000b740: 6d61 6c5d 203d 2061 6363 756d 0a0a 2020  mal] = accum..  
+0000b750: 2020 2020 2020 2020 2020 2320 4861 6e64            # Hand
+0000b760: 6c65 7320 6765 745f 6772 6164 206f 7065  les get_grad ope
+0000b770: 7261 7469 6f6e 730a 0a20 2020 2020 2020  rations..       
+0000b780: 2020 2020 2023 2052 6573 6574 7320 7468       # Resets th
+0000b790: 6520 7377 6170 6d61 7020 666f 7220 6772  e swapmap for gr
+0000b7a0: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
+0000b7b0: 7377 6170 6d61 703a 2064 6963 745b 5661  swapmap: dict[Va
+0000b7c0: 7269 6162 6c65 2c20 5072 6f78 795d 203d  riable, Proxy] =
+0000b7d0: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+0000b7e0: 2066 6f72 2062 7379 6d20 696e 2067 7261   for bsym in gra
+0000b7f0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000b800: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0000b810: 2020 2020 6964 3a20 4861 7368 6162 6c65      id: Hashable
+0000b820: 203d 2062 7379 6d2e 7379 6d2e 6964 0a20   = bsym.sym.id. 
+0000b830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b840: 6620 6964 2069 7320 7069 6473 2e47 4554  f id is pids.GET
+0000b850: 5f47 5241 443a 0a20 2020 2020 2020 2020  _GRAD:.         
+0000b860: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
+0000b870: 6c3a 204e 756d 6265 7220 7c20 5465 6e73  l: Number | Tens
+0000b880: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
+0000b890: 2020 2020 2020 2020 2020 2020 2870 7269              (pri
+0000b8a0: 6d61 6c2c 2920 3d20 6273 796d 2e66 6c61  mal,) = bsym.fla
+0000b8b0: 745f 6172 6773 0a20 2020 2020 2020 2020  t_args.         
+0000b8c0: 2020 2020 2020 2020 2020 2067 7261 643a             grad:
+0000b8d0: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+0000b8e0: 5072 6f78 7920 3d20 6273 796d 2e6f 7574  Proxy = bsym.out
+0000b8f0: 7075 740a 0a20 2020 2020 2020 2020 2020  put..           
+0000b900: 2020 2020 2020 2020 2076 7072 696d 616c           vprimal
+0000b910: 3a20 5661 7269 6162 6c65 0a20 2020 2020  : Variable.     
+0000b920: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0000b930: 6772 6164 3a20 5661 7269 6162 6c65 0a20  grad: Variable. 
+0000b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b950: 2020 2076 7072 696d 616c 2c20 7667 7261     vprimal, vgra
+0000b960: 6420 3d20 7661 7269 6162 6c65 6966 7928  d = variableify(
+0000b970: 7072 696d 616c 292c 2076 6172 6961 626c  primal), variabl
+0000b980: 6569 6679 2867 7261 6429 0a0a 2020 2020  eify(grad)..    
+0000b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9a0: 6163 7475 616c 5f67 7261 643a 204e 6f6e  actual_grad: Non
+0000b9b0: 6520 7c20 5465 6e73 6f72 5072 6f78 7920  e | TensorProxy 
+0000b9c0: 3d20 7072 696d 616c 735f 746f 5f67 696e  = primals_to_gin
+0000b9d0: 7075 745f 6d61 702e 6765 7428 7670 7269  put_map.get(vpri
+0000b9e0: 6d61 6c2c 204e 6f6e 6529 0a0a 2020 2020  mal, None)..    
+0000b9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba00: 2320 4e4f 5445 2049 6620 6163 7475 616c  # NOTE If actual
+0000ba10: 5f67 7261 6420 6973 204e 6f6e 6520 7468  _grad is None th
+0000ba20: 656e 2074 6865 7265 2773 2061 2067 6574  en there's a get
+0000ba30: 5f67 7261 6428 2920 7265 7175 6573 7420  _grad() request 
+0000ba40: 666f 7220 6120 7465 6e73 6f72 2077 6869  for a tensor whi
+0000ba50: 6368 0a20 2020 2020 2020 2020 2020 2020  ch.             
+0000ba60: 2020 2020 2020 2023 2020 2068 6173 206e         #   has n
+0000ba70: 6f20 7075 745f 6772 6164 2829 2c20 736f  o put_grad(), so
+0000ba80: 2077 6520 7265 7475 726e 207a 6572 6f73   we return zeros
+0000ba90: 2066 6f72 2074 6865 2067 7261 640a 2020   for the grad.  
+0000baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bab0: 2020 2320 544f 444f 2052 6576 6973 6974    # TODO Revisit
+0000bac0: 2074 6869 7320 2d2d 2063 616e 2077 6520   this -- can we 
+0000bad0: 7265 6d6f 7665 2074 6865 7365 2063 6f6d  remove these com
+0000bae0: 7075 7461 7469 6f6e 732c 206f 7220 7573  putations, or us
+0000baf0: 6520 6120 7370 6563 6961 6c20 5a65 726f  e a special Zero
+0000bb00: 5465 6e73 6f72 0a20 2020 2020 2020 2020  Tensor.         
+0000bb10: 2020 2020 2020 2020 2020 2023 2020 2074             #   t
+0000bb20: 6f20 7369 6d70 6c69 6679 2074 6865 6d3f  o simplify them?
+0000bb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bb40: 2020 2020 2069 6620 6163 7475 616c 5f67       if actual_g
+0000bb50: 7261 6420 6973 204e 6f6e 653a 0a20 2020  rad is None:.   
+0000bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb70: 2020 2020 2061 6374 7561 6c5f 6772 6164       actual_grad
+0000bb80: 203d 206c 746f 7263 682e 7a65 726f 735f   = ltorch.zeros_
+0000bb90: 6c69 6b65 2870 7269 6d61 6c29 0a20 2020  like(primal).   
+0000bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bbb0: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
+0000bbc0: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
+0000bbd0: 616c 5d20 3d20 6163 7475 616c 5f67 7261  al] = actual_gra
+0000bbe0: 640a 0a20 2020 2020 2020 2020 2020 2020  d..             
+0000bbf0: 2020 2020 2020 2023 2055 7064 6174 6573         # Updates
+0000bc00: 2074 6865 2067 7261 6420 616c 6961 7320   the grad alias 
+0000bc10: 6d61 700a 2020 2020 2020 2020 2020 2020  map.            
+0000bc20: 2020 2020 2020 2020 7661 6374 7561 6c5f          vactual_
+0000bc30: 6772 6164 3a20 5661 7269 6162 6c65 203d  grad: Variable =
+0000bc40: 2076 6172 6961 626c 6569 6679 2861 6374   variableify(act
+0000bc50: 7561 6c5f 6772 6164 290a 2020 2020 2020  ual_grad).      
+0000bc60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000bc70: 2076 6163 7475 616c 5f67 7261 6420 213d   vactual_grad !=
+0000bc80: 2076 6772 6164 3a0a 2020 2020 2020 2020   vgrad:.        
+0000bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bca0: 7377 6170 6d61 705b 7667 7261 645d 203d  swapmap[vgrad] =
+0000bcb0: 2061 6374 7561 6c5f 6772 6164 0a0a 2020   actual_grad..  
+0000bcc0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+0000bcd0: 2020 2020 2020 2020 2020 2023 2052 6573             # Res
+0000bce0: 746f 7265 7320 7363 6f70 650a 2020 2020  tores scope.    
+0000bcf0: 2020 2020 2020 2020 7265 7365 745f 7472          reset_tr
+0000bd00: 6163 6563 7478 2874 7261 6365 6374 785f  acectx(tracectx_
+0000bd10: 746f 6b29 0a0a 2020 2020 2020 2020 2320  tok)..        # 
+0000bd20: 4669 6c74 6572 7320 7075 745f 6772 6164  Filters put_grad
+0000bd30: 2061 6e64 2067 6574 5f67 7261 6420 6f70   and get_grad op
+0000bd40: 6572 6174 696f 6e73 2061 6e64 2061 7070  erations and app
+0000bd50: 6c69 6573 2074 6865 2073 7761 706d 6170  lies the swapmap
+0000bd60: 0a20 2020 2020 2020 2064 6566 205f 6669  .        def _fi
+0000bd70: 6c74 6572 2862 7379 6d3a 2042 6f75 6e64  lter(bsym: Bound
+0000bd80: 5379 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a  Symbol) -> bool:
+0000bd90: 0a20 2020 2020 2020 2020 2020 2069 643a  .            id:
+0000bda0: 2048 6173 6861 626c 6520 3d20 6273 796d   Hashable = bsym
+0000bdb0: 2e73 796d 2e69 640a 2020 2020 2020 2020  .sym.id.        
+0000bdc0: 2020 2020 7265 7475 726e 2069 6420 696e      return id in
+0000bdd0: 2028 7069 6473 2e50 5554 5f47 5241 442c   (pids.PUT_GRAD,
+0000bde0: 2070 6964 732e 4745 545f 4752 4144 290a   pids.GET_GRAD).
+0000bdf0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000be00: 2e62 6f75 6e64 5f73 796d 626f 6c73 203d  .bound_symbols =
+0000be10: 205b 0a20 2020 2020 2020 2020 2020 2062   [.            b
+0000be20: 7379 6d2e 6672 6f6d 5f62 7379 6d5f 7377  sym.from_bsym_sw
+0000be30: 6170 5f70 726f 7869 6573 2873 7761 706d  ap_proxies(swapm
+0000be40: 6170 2920 666f 7220 6273 796d 2069 6e20  ap) for bsym in 
+0000be50: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
+0000be60: 6d62 6f6c 7320 6966 206e 6f74 205f 6669  mbols if not _fi
+0000be70: 6c74 6572 2862 7379 6d29 0a20 2020 2020  lter(bsym).     
+0000be80: 2020 205d 0a0a 2020 2020 2020 2020 2320     ]..        # 
+0000be90: 5354 4550 2046 4f55 5220 2d2d 2d20 4f72  STEP FOUR --- Or
+0000bea0: 6465 7273 2074 6865 206f 7065 7261 7469  ders the operati
+0000beb0: 6f6e 730a 2020 2020 2020 2020 2320 544f  ons.        # TO
+0000bec0: 444f 2043 6f6e 7369 6465 7220 616c 7465  DO Consider alte
+0000bed0: 726e 6174 6976 6520 7363 6865 6475 6c69  rnative scheduli
+0000bee0: 6e67 2061 6c67 6f72 6974 686d 732c 206d  ng algorithms, m
+0000bef0: 6179 6265 2062 7920 7573 696e 6720 6772  aybe by using gr
+0000bf00: 6170 6820 6665 6174 7572 6573 0a20 2020  aph features.   
+0000bf10: 2020 2020 2023 2020 2053 6f6d 6520 6964       #   Some id
+0000bf20: 6561 7320 6172 6520 6c6f 6f6b 696e 6720  eas are looking 
+0000bf30: 6174 206d 656d 6f72 792d 7361 7669 6e67  at memory-saving
+0000bf40: 206e 6f64 6573 2c20 616e 6420 6e6f 6465   nodes, and node
+0000bf50: 7320 7769 7468 2061 2068 6967 6820 696e  s with a high in
+0000bf60: 2d64 6567 7265 6520 6f72 2068 6967 6820  -degree or high 
+0000bf70: 6f75 742d 6465 6772 6565 0a0a 2020 2020  out-degree..    
+0000bf80: 2020 2020 2320 4372 6561 7465 7320 616e      # Creates an
+0000bf90: 2069 6e69 7469 616c 2076 616c 6964 206f   initial valid o
+0000bfa0: 7264 6572 696e 6720 746f 2044 4345 2c20  rdering to DCE, 
+0000bfb0: 736f 2074 6861 7420 6164 6469 7469 6f6e  so that addition
+0000bfc0: 616c 206f 7264 6572 696e 6720 616e 616c  al ordering anal
+0000bfd0: 7973 6973 2064 6f65 736e 2774 206e 6565  ysis doesn't nee
+0000bfe0: 6420 746f 2063 6f6e 7369 6465 7220 616c  d to consider al
+0000bff0: 6c20 7379 6d62 6f6c 730a 2020 2020 2020  l symbols.      
+0000c000: 2020 726f 6f74 732c 206c 6561 7665 7320    roots, leaves 
+0000c010: 3d20 6273 796d 5f6c 6973 745f 746f 5f64  = bsym_list_to_d
+0000c020: 6167 2867 7261 6474 7263 2e62 6f75 6e64  ag(gradtrc.bound
+0000c030: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
+0000c040: 2020 6f72 6465 7265 645f 6273 796d 7320    ordered_bsyms 
+0000c050: 3d20 746f 706f 736f 7274 5f62 7379 6d5f  = toposort_bsym_
+0000c060: 6461 6728 726f 6f74 732c 2054 4f50 4f53  dag(roots, TOPOS
+0000c070: 4f52 545f 4f52 4445 522e 544f 505f 444f  ORT_ORDER.TOP_DO
+0000c080: 574e 290a 2020 2020 2020 2020 6772 6164  WN).        grad
+0000c090: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000c0a0: 7320 3d20 6f72 6465 7265 645f 6273 796d  s = ordered_bsym
+0000c0b0: 730a 2020 2020 2020 2020 6772 6164 7472  s.        gradtr
+0000c0c0: 6320 3d20 6463 6528 6772 6164 7472 6329  c = dce(gradtrc)
+0000c0d0: 0a0a 2020 2020 2020 2020 2320 4964 656e  ..        # Iden
+0000c0e0: 7469 6669 6573 2074 6865 206f 7264 6572  tifies the order
+0000c0f0: 206f 6620 426f 756e 6453 796d 626f 6c73   of BoundSymbols
+0000c100: 2075 7369 6e67 2061 2022 4446 5320 616e   using a "DFS an
+0000c110: 6420 6368 6169 6e22 2061 6c67 6f72 6974  d chain" algorit
+0000c120: 686d 0a20 2020 2020 2020 2023 2054 4f44  hm.        # TOD
+0000c130: 4f20 456c 6162 6f72 6174 6520 6f6e 2074  O Elaborate on t
+0000c140: 6869 7320 616c 676f 7269 7468 6d20 616e  his algorithm an
+0000c150: 6420 7468 6520 696d 706c 656d 656e 7461  d the implementa
+0000c160: 7469 6f6e 0a20 2020 2020 2020 2072 6f6f  tion.        roo
+0000c170: 7473 2c20 6c65 6176 6573 203d 2062 7379  ts, leaves = bsy
+0000c180: 6d5f 6c69 7374 5f74 6f5f 6461 6728 6772  m_list_to_dag(gr
+0000c190: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
+0000c1a0: 6f6c 7329 0a20 2020 2020 2020 2063 6865  ols).        che
+0000c1b0: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+0000c1c0: 6c65 6e28 6c65 6176 6573 2920 3d3d 2031  len(leaves) == 1
+0000c1d0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+0000c1e0: 6d62 6461 3a20 6622 4578 7065 6374 6564  mbda: f"Expected
+0000c1f0: 206f 6e6c 7920 6f6e 6520 6c65 6166 206e   only one leaf n
+0000c200: 6f64 6520 7768 656e 2073 6f72 7469 6e67  ode when sorting
+0000c210: 2066 6f72 2067 7261 642c 2066 6f75 6e64   for grad, found
+0000c220: 2074 6865 7265 2077 6572 6520 7b6c 656e   there were {len
+0000c230: 286c 6561 7665 7329 7d20 6c65 6176 6573  (leaves)} leaves
+0000c240: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+0000c250: 2020 2020 2028 6c65 6166 2c29 203d 206c       (leaf,) = l
+0000c260: 6561 7665 730a 0a20 2020 2020 2020 2023  eaves..        #
+0000c270: 2043 6f6d 7075 7465 7320 7468 6520 7465   Computes the te
+0000c280: 6e73 6f72 206d 656d 6f72 7920 7573 6564  nsor memory used
+0000c290: 2062 7920 7468 6520 6769 7665 6e20 7079   by the given py
+0000c2a0: 7472 6565 0a20 2020 2020 2020 2064 6566  tree.        def
+0000c2b0: 206d 656d 6f72 795f 7573 6564 2870 7974   memory_used(pyt
+0000c2c0: 7265 6529 202d 3e20 696e 743a 0a20 2020  ree) -> int:.   
+0000c2d0: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
+0000c2e0: 7573 653a 2069 6e74 203d 2030 0a0a 2020  use: int = 0..  
+0000c2f0: 2020 2020 2020 2020 2020 6465 6620 636f            def co
+0000c300: 756e 745f 6d65 6d6f 7279 5f75 7365 2878  unt_memory_use(x
+0000c310: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c320: 2020 206e 6f6e 6c6f 6361 6c20 6d65 6d6f     nonlocal memo
+0000c330: 7279 5f75 7365 0a20 2020 2020 2020 2020  ry_use.         
+0000c340: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000c350: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
+0000c360: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
+0000c370: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
+0000c380: 5f75 7365 202b 3d20 782e 6474 7970 652e  _use += x.dtype.
+0000c390: 5f62 7974 6573 202a 2078 2e6e 756d 656c  _bytes * x.numel
+0000c3a0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
+0000c3b0: 6565 5f6d 6170 2863 6f75 6e74 5f6d 656d  ee_map(count_mem
+0000c3c0: 6f72 795f 7573 652c 2070 7974 7265 6529  ory_use, pytree)
+0000c3d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000c3e0: 7572 6e20 6d65 6d6f 7279 5f75 7365 0a0a  urn memory_use..
+0000c3f0: 2020 2020 2020 2020 2320 5472 7565 2077          # True w
+0000c400: 6865 6e20 6120 6e6f 6465 2069 7320 6120  hen a node is a 
+0000c410: 226c 696e 6b22 202d 2d20 6120 6e6f 6465  "link" -- a node
+0000c420: 2077 6974 6820 6f6e 6c79 206f 6e65 2063   with only one c
+0000c430: 6869 6c64 2061 6e64 2061 7420 6d6f 7374  hild and at most
+0000c440: 206f 6e65 2070 6172 656e 740a 2020 2020   one parent.    
+0000c450: 2020 2020 2320 2020 436f 6e63 6570 7475      #   Conceptu
+0000c460: 616c 6c79 2074 6865 206e 6f64 6520 6973  ally the node is
+0000c470: 2061 2022 6c69 6e6b 2220 696e 2061 2063   a "link" in a c
+0000c480: 6861 696e 206f 6620 6e6f 6465 7320 6c69  hain of nodes li
+0000c490: 6b65 2041 202d 3e20 4220 2d3e 2043 0a20  ke A -> B -> C. 
+0000c4a0: 2020 2020 2020 2064 6566 2069 735f 6c69         def is_li
+0000c4b0: 6e6b 286e 3a20 4e6f 6465 2920 2d3e 2062  nk(n: Node) -> b
+0000c4c0: 6f6f 6c3a 0a20 2020 2020 2020 2020 2020  ool:.           
+0000c4d0: 205f 6973 5f6c 696e 6b20 3d20 6c65 6e28   _is_link = len(
+0000c4e0: 6e2e 6368 696c 6472 656e 2920 3d3d 2031  n.children) == 1
+0000c4f0: 2061 6e64 206c 656e 286e 2e70 6172 656e   and len(n.paren
+0000c500: 7473 2920 3c3d 2031 0a20 2020 2020 2020  ts) <= 1.       
+0000c510: 2020 2020 2072 6574 7572 6e20 5f69 735f       return _is_
+0000c520: 6c69 6e6b 0a0a 2020 2020 2020 2020 636f  link..        co
+0000c530: 756e 7465 723a 2069 6e74 203d 2030 0a0a  unter: int = 0..
+0000c540: 2020 2020 2020 2020 6465 6620 5f63 6861          def _cha
+0000c550: 696e 2863 3a20 6c69 7374 5b4e 6f64 655d  in(c: list[Node]
+0000c560: 2c20 656e 643a 204e 6f64 6529 202d 3e20  , end: Node) -> 
+0000c570: 6c69 7374 5b4e 6f64 655d 3a0a 2020 2020  list[Node]:.    
+0000c580: 2020 2020 2020 2020 6e6f 6e6c 6f63 616c          nonlocal
+0000c590: 2063 6f75 6e74 6572 0a0a 2020 2020 2020   counter..      
+0000c5a0: 2020 2020 2020 2320 544f 444f 2045 7870        # TODO Exp
+0000c5b0: 6572 696d 656e 7420 7769 7468 206e 6f74  eriment with not
+0000c5c0: 2061 6c77 6179 7320 6675 7369 6e67 2074   always fusing t
+0000c5d0: 6869 7320 696e 746f 2074 6865 2063 6f6e  his into the con
+0000c5e0: 7375 6d65 7220 2d2d 2074 6865 7265 2063  sumer -- there c
+0000c5f0: 6f75 6c64 2062 6520 616e 0a20 2020 2020  ould be an.     
+0000c600: 2020 2020 2020 2023 2020 2069 6e74 6572         #   inter
+0000c610: 6573 7469 6e67 206d 696e 6375 740a 2020  esting mincut.  
+0000c620: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+0000c630: 2049 6e20 7468 6973 2063 6173 6520 7468   In this case th
+0000c640: 6520 6368 6169 6e20 6361 6e6e 6f74 2062  e chain cannot b
+0000c650: 6520 6578 7465 6e64 6564 2c20 616e 6420  e extended, and 
+0000c660: 6974 7320 6f72 6967 696e 2069 7320 696e  its origin is in
+0000c670: 7075 7420 746f 2074 6865 2066 756e 6374  put to the funct
+0000c680: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0000c690: 2320 2020 736f 2074 6869 7320 6a75 7374  #   so this just
+0000c6a0: 2066 7573 6573 2069 7420 696e 746f 2074   fuses it into t
+0000c6b0: 6865 2063 6f6e 7375 6d65 720a 2020 2020  he consumer.    
+0000c6c0: 2020 2020 2020 2020 6966 206c 656e 2865          if len(e
+0000c6d0: 6e64 2e70 6172 656e 7473 2920 3d3d 2030  nd.parents) == 0
+0000c6e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c6f0: 2020 666f 7220 6e20 696e 2063 3a0a 2020    for n in c:.  
+0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c710: 2020 6e2e 6e75 6d62 6572 203d 2063 6f75    n.number = cou
+0000c720: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
+0000c730: 2020 2020 2020 2020 2063 6f75 6e74 6572           counter
+0000c740: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0000c750: 2020 2020 2020 7265 7475 726e 205b 5d0a        return [].
+0000c760: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0000c770: 4f54 4520 6c65 6e28 656e 642e 7061 7265  OTE len(end.pare
+0000c780: 6e74 7329 203d 3d20 3120 6f6e 2074 6869  nts) == 1 on thi
+0000c790: 7320 7061 7468 0a20 2020 2020 2020 2020  s path.         
+0000c7a0: 2020 2028 7061 7265 6e74 2c29 203d 2065     (parent,) = e
+0000c7b0: 6e64 2e70 6172 656e 7473 0a0a 2020 2020  nd.parents..    
+0000c7c0: 2020 2020 2020 2020 2320 4578 7465 6e64          # Extend
+0000c7d0: 7320 7468 6520 6368 6169 6e20 6966 2074  s the chain if t
+0000c7e0: 6865 2070 6172 656e 7420 6973 2061 206c  he parent is a l
+0000c7f0: 696e 6b0a 2020 2020 2020 2020 2020 2020  ink.            
+0000c800: 6966 2069 735f 6c69 6e6b 2870 6172 656e  if is_link(paren
+0000c810: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0000c820: 2020 2020 632e 6170 7065 6e64 2870 6172      c.append(par
+0000c830: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+0000c840: 2020 2020 2072 6574 7572 6e20 5f63 6861       return _cha
+0000c850: 696e 2863 2c20 7061 7265 6e74 290a 0a20  in(c, parent).. 
+0000c860: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
+0000c870: 4520 496e 2074 6869 7320 6361 7365 2074  E In this case t
+0000c880: 6865 2063 6861 696e 2068 6173 2061 2070  he chain has a p
+0000c890: 6172 656e 7420 7468 6174 2069 7320 6e6f  arent that is no
+0000c8a0: 7420 6120 6c69 6e6b 0a20 2020 2020 2020  t a link.       
+0000c8b0: 2020 2020 2023 2046 696e 6473 2074 6865       # Finds the
+0000c8c0: 206d 696e 6375 740a 2020 2020 2020 2020   mincut.        
+0000c8d0: 2020 2020 6d69 6e63 7574 5f69 6478 3a20      mincut_idx: 
+0000c8e0: 696e 7420 3d20 6c65 6e28 6329 0a20 2020  int = len(c).   
+0000c8f0: 2020 2020 2020 2020 206d 696e 5f6d 656d           min_mem
+0000c900: 6f72 795f 7573 6167 653a 2069 6e74 203d  ory_usage: int =
+0000c910: 206d 656d 6f72 795f 7573 6564 2870 6172   memory_used(par
+0000c920: 656e 742e 6273 796d 2e6f 7574 7075 7429  ent.bsym.output)
+0000c930: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0000c940: 7220 6964 782c 206e 2069 6e20 656e 756d  r idx, n in enum
+0000c950: 6572 6174 6528 6329 3a0a 2020 2020 2020  erate(c):.      
+0000c960: 2020 2020 2020 2020 2020 6d65 6d20 3d20            mem = 
+0000c970: 6d65 6d6f 7279 5f75 7365 6428 6e2e 6273  memory_used(n.bs
+0000c980: 796d 2e6f 7574 7075 7429 0a20 2020 2020  ym.output).     
+0000c990: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
+0000c9a0: 6d20 3c20 6d69 6e5f 6d65 6d6f 7279 5f75  m < min_memory_u
+0000c9b0: 7361 6765 3a0a 2020 2020 2020 2020 2020  sage:.          
+0000c9c0: 2020 2020 2020 2020 2020 6d69 6e63 7574            mincut
+0000c9d0: 5f69 6478 203d 2069 6478 0a20 2020 2020  _idx = idx.     
+0000c9e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000c9f0: 696e 5f6d 656d 6f72 795f 7573 6167 6520  in_memory_usage 
+0000ca00: 3d20 6d65 6d0a 0a20 2020 2020 2020 2020  = mem..         
+0000ca10: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
+0000ca20: 2065 6e75 6d65 7261 7465 2863 293a 0a20   enumerate(c):. 
+0000ca30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000ca40: 6620 6964 7820 3c20 6d69 6e63 7574 5f69  f idx < mincut_i
+0000ca50: 6478 3a0a 2020 2020 2020 2020 2020 2020  dx:.            
+0000ca60: 2020 2020 2020 2020 6e2e 6e75 6d62 6572          n.number
+0000ca70: 203d 2063 6f75 6e74 6572 0a20 2020 2020   = counter.     
+0000ca80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000ca90: 6f75 6e74 6572 202b 3d20 310a 0a20 2020  ounter += 1..   
+0000caa0: 2020 2020 2020 2020 2023 2052 6574 7572           # Retur
+0000cab0: 6e73 2074 6865 2070 726f 6475 6365 722d  ns the producer-
+0000cac0: 7369 6465 2063 6861 696e 2063 7574 2069  side chain cut i
+0000cad0: 6620 6974 2065 7869 7374 730a 2020 2020  f it exists.    
+0000cae0: 2020 2020 2020 2020 6966 206d 696e 6375          if mincu
+0000caf0: 745f 6964 7820 3c20 6c65 6e28 6329 3a0a  t_idx < len(c):.
+0000cb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb10: 7265 7475 726e 205b 635b 6d69 6e63 7574  return [c[mincut
+0000cb20: 5f69 6478 5d5d 0a20 2020 2020 2020 2020  _idx]].         
+0000cb30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000cb40: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000cb50: 6d69 6e63 7574 5f69 6478 203d 3d20 6c65  mincut_idx == le
+0000cb60: 6e28 6329 0a20 2020 2020 2020 2020 2020  n(c).           
+0000cb70: 2020 2020 2072 6574 7572 6e20 656e 642e       return end.
+0000cb80: 7061 7265 6e74 730a 0a20 2020 2020 2020  parents..       
+0000cb90: 2064 6566 2063 6861 696e 5f6f 7574 286e   def chain_out(n
+0000cba0: 3a20 4e6f 6465 2c20 7374 6163 6b3a 206c  : Node, stack: l
+0000cbb0: 6973 745b 4e6f 6465 5d29 202d 3e20 4e6f  ist[Node]) -> No
+0000cbc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000cbd0: 2320 5368 6f72 742d 6369 7263 7569 7473  # Short-circuits
+0000cbe0: 2069 6620 7468 6520 6f72 6967 696e 616c   if the original
+0000cbf0: 206e 6f64 6520 6e20 6361 6e6e 6f74 2062   node n cannot b
+0000cc00: 6520 7061 7274 206f 6620 6120 6368 6169  e part of a chai
+0000cc10: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+0000cc20: 206e 6f74 2069 735f 6c69 6e6b 286e 293a   not is_link(n):
+0000cc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cc40: 2073 7461 636b 2e61 7070 656e 6428 6e29   stack.append(n)
+0000cc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cc60: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0000cc70: 2020 2020 2023 204e 4f54 4520 6973 5f6c       # NOTE is_l
+0000cc80: 696e 6b28 6e29 203d 3d20 5472 7565 0a20  ink(n) == True. 
+0000cc90: 2020 2020 2020 2020 2020 2070 6f73 745f             post_
+0000cca0: 6368 6169 6e3a 206c 6973 745b 4e6f 6465  chain: list[Node
+0000ccb0: 5d20 3d20 5f63 6861 696e 285b 6e5d 2c20  ] = _chain([n], 
+0000ccc0: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
+0000ccd0: 666f 7220 7063 2069 6e20 706f 7374 5f63  for pc in post_c
+0000cce0: 6861 696e 3a0a 2020 2020 2020 2020 2020  hain:.          
+0000ccf0: 2020 2020 2020 7374 6163 6b2e 6170 7065        stack.appe
+0000cd00: 6e64 2870 6329 0a0a 2020 2020 2020 2020  nd(pc)..        
+0000cd10: 7374 6163 6b3a 206c 6973 745b 4e6f 6465  stack: list[Node
+0000cd20: 5d20 3d20 5b6c 6561 665d 0a20 2020 2020  ] = [leaf].     
+0000cd30: 2020 2077 6869 6c65 206c 656e 2873 7461     while len(sta
+0000cd40: 636b 2920 3e20 303a 0a20 2020 2020 2020  ck) > 0:.       
+0000cd50: 2020 2020 206e 3a20 4e6f 6465 203d 2073       n: Node = s
+0000cd60: 7461 636b 2e70 6f70 2829 0a0a 2020 2020  tack.pop()..    
+0000cd70: 2020 2020 2020 2020 6966 206e 2e6e 756d          if n.num
+0000cd80: 6265 7220 6973 206e 6f74 204e 6f6e 653a  ber is not None:
+0000cd90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cda0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0000cdb0: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
+0000cdc0: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
+0000cdd0: 2020 2020 2020 636f 756e 7465 7220 2b3d        counter +=
+0000cde0: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
+0000cdf0: 666f 7220 7020 696e 206e 2e70 6172 656e  for p in n.paren
+0000ce00: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0000ce10: 2020 2020 6368 6169 6e5f 6f75 7428 702c      chain_out(p,
+0000ce20: 2073 7461 636b 290a 0a20 2020 2020 2020   stack)..       
+0000ce30: 2064 6566 205f 7365 6c65 6374 6f72 2865   def _selector(e
+0000ce40: 6c69 6769 626c 655f 6e6f 6465 733a 206c  ligible_nodes: l
+0000ce50: 6973 745b 4e6f 6465 5d29 202d 3e20 696e  ist[Node]) -> in
+0000ce60: 743a 0a20 2020 2020 2020 2020 2020 206d  t:.            m
+0000ce70: 696e 5f69 6478 3a20 696e 7420 3d20 300a  in_idx: int = 0.
+0000ce80: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+0000ce90: 6e75 6d62 6572 3a20 696e 7420 3d20 656c  number: int = el
+0000cea0: 6967 6962 6c65 5f6e 6f64 6573 5b30 5d2e  igible_nodes[0].
+0000ceb0: 6e75 6d62 6572 0a0a 2020 2020 2020 2020  number..        
+0000cec0: 2020 2020 2320 4e4f 5445 2041 6c74 686f      # NOTE Altho
+0000ced0: 7567 6820 7765 2776 6520 616c 7265 6164  ugh we've alread
+0000cee0: 7920 7072 6f63 6573 7365 6420 7468 6520  y processed the 
+0000cef0: 6669 7273 7420 656c 656d 656e 7420 6865  first element he
+0000cf00: 7265 2c20 7468 6973 2073 7469 6c6c 0a20  re, this still. 
+0000cf10: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
+0000cf20: 6e75 6d65 7261 7465 7320 7468 6520 656e  numerates the en
+0000cf30: 7469 7265 206c 6973 7420 6320 746f 2061  tire list c to a
+0000cf40: 6c69 676e 2074 6865 2065 6e75 6d65 7261  lign the enumera
+0000cf50: 7469 6f6e 2069 6478 2070 726f 7065 726c  tion idx properl
+0000cf60: 790a 2020 2020 2020 2020 2020 2020 666f  y.            fo
+0000cf70: 7220 6964 782c 206e 2069 6e20 656e 756d  r idx, n in enum
+0000cf80: 6572 6174 6528 656c 6967 6962 6c65 5f6e  erate(eligible_n
+0000cf90: 6f64 6573 293a 0a20 2020 2020 2020 2020  odes):.         
+0000cfa0: 2020 2020 2020 2063 6865 636b 286e 2e6e         check(n.n
+0000cfb0: 756d 6265 7220 6973 206e 6f74 204e 6f6e  umber is not Non
+0000cfc0: 652c 206c 616d 6264 613a 2066 2245 7870  e, lambda: f"Exp
+0000cfd0: 6563 7465 6420 6561 6368 206e 6f64 6520  ected each node 
+0000cfe0: 746f 2062 6520 6e75 6d62 6572 6564 2c20  to be numbered, 
+0000cff0: 6275 7420 7b6e 7d20 7761 7320 6e6f 7422  but {n} was not"
+0000d000: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000d010: 2020 2069 6620 6e2e 6e75 6d62 6572 203c     if n.number <
+0000d020: 206d 696e 5f6e 756d 6265 723a 0a20 2020   min_number:.   
+0000d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d040: 206d 696e 5f69 6478 203d 2069 6478 0a20   min_idx = idx. 
+0000d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d060: 2020 206d 696e 5f6e 756d 6265 7220 3d20     min_number = 
+0000d070: 6e2e 6e75 6d62 6572 0a0a 2020 2020 2020  n.number..      
+0000d080: 2020 2020 2020 7265 7475 726e 206d 696e        return min
+0000d090: 5f69 6478 0a0a 2020 2020 2020 2020 736f  _idx..        so
+0000d0a0: 7274 6564 5f62 7379 6d73 203d 2074 6f70  rted_bsyms = top
+0000d0b0: 6f73 6f72 745f 6273 796d 5f64 6167 286c  osort_bsym_dag(l
+0000d0c0: 6561 7665 732c 2074 6f70 6f73 6f72 745f  eaves, toposort_
+0000d0d0: 6f72 6465 723d 544f 504f 534f 5254 5f4f  order=TOPOSORT_O
+0000d0e0: 5244 4552 2e42 4f54 544f 4d5f 5550 2c20  RDER.BOTTOM_UP, 
+0000d0f0: 7365 6c65 6374 6f72 3d5f 7365 6c65 6374  selector=_select
+0000d100: 6f72 290a 2020 2020 2020 2020 6772 6164  or).        grad
+0000d110: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000d120: 7320 3d20 736f 7274 6564 5f62 7379 6d73  s = sorted_bsyms
+0000d130: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000d140: 203d 2064 6365 2867 7261 6474 7263 290a   = dce(gradtrc).
+0000d150: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
+0000d160: 436f 6e73 6964 6572 2068 6f77 2074 6f20  Consider how to 
+0000d170: 6861 6e64 6c65 2067 7261 6420 772e 722e  handle grad w.r.
+0000d180: 742e 206f 6e6c 7920 736f 6d65 206f 7574  t. only some out
+0000d190: 7075 7473 202d 2d20 7368 6f75 6c64 2061  puts -- should a
+0000d1a0: 6c6c 2067 7261 640a 2020 2020 2020 2020  ll grad.        
+0000d1b0: 2320 2020 6f70 6572 6174 696f 6e73 2075  #   operations u
+0000d1c0: 7369 6e67 2074 6865 206f 7468 6572 206f  sing the other o
+0000d1d0: 7574 7075 7420 6265 2072 656d 6f76 6564  utput be removed
+0000d1e0: 3f20 5768 6174 206b 696e 6420 6f66 2061  ? What kind of a
+0000d1f0: 7373 756d 7074 696f 6e20 646f 6573 2074  ssumption does t
+0000d200: 6861 740a 2020 2020 2020 2020 2320 2020  hat.        #   
+0000d210: 6d61 6b65 2061 626f 7574 2074 6865 2067  make about the g
+0000d220: 7261 6420 7374 7275 6374 7572 653f 2050  rad structure? P
+0000d230: 726f 6261 626c 7920 736f 6d65 206b 696e  robably some kin
+0000d240: 6420 6f66 2069 6e64 6570 656e 6465 6e63  d of independenc
+0000d250: 6520 6173 7375 6d70 7469 6f6e 3f20 4172  e assumption? Ar
+0000d260: 650a 2020 2020 2020 2020 2320 2020 7468  e.        #   th
+0000d270: 6572 6520 7072 6163 7469 6361 6c20 6578  ere practical ex
+0000d280: 616d 706c 6573 2077 6865 7265 2074 6861  amples where tha
+0000d290: 7427 7320 616e 2069 7373 7565 3f0a 0a20  t's an issue?.. 
+0000d2a0: 2020 2020 2020 2065 6e64 5f74 696d 655f         end_time_
+0000d2b0: 6e73 203d 2074 696d 652e 7469 6d65 5f6e  ns = time.time_n
+0000d2c0: 7328 290a 2020 2020 2020 2020 656c 6170  s().        elap
+0000d2d0: 7365 645f 7469 6d65 5f6e 7320 3d20 656e  sed_time_ns = en
+0000d2e0: 645f 7469 6d65 5f6e 7320 2d20 7374 6172  d_time_ns - star
+0000d2f0: 745f 7469 6d65 5f6e 730a 2020 2020 2020  t_time_ns.      
+0000d300: 2020 656c 6170 7365 645f 7469 6d65 5f6d    elapsed_time_m
+0000d310: 696c 6c69 7320 3d20 656c 6170 7365 645f  illis = elapsed_
+0000d320: 7469 6d65 5f6e 7320 2f2f 2031 3030 3030  time_ns // 10000
+0000d330: 3030 0a20 2020 2020 2020 2067 7261 6474  00.        gradt
+0000d340: 7263 2e73 6574 5f70 726f 7665 6e61 6e63  rc.set_provenanc
+0000d350: 6528 5472 6163 6550 726f 7665 6e61 6e63  e(TraceProvenanc
+0000d360: 6528 6622 4772 6164 2028 746f 6f6b 207b  e(f"Grad (took {
+0000d370: 656c 6170 7365 645f 7469 6d65 5f6d 696c  elapsed_time_mil
+0000d380: 6c69 737d 206d 696c 6c69 7365 636f 6e64  lis} millisecond
+0000d390: 7329 2229 290a 0a20 2020 2020 2020 2072  s)"))..        r
+0000d3a0: 6574 7572 6e20 6772 6164 7472 630a 0a20  eturn gradtrc.. 
+0000d3b0: 2020 2023 204e 4f54 4520 5468 6973 2069     # NOTE This i
+0000d3c0: 7320 6120 6b6c 7564 6765 2074 6f20 696e  s a kludge to in
+0000d3d0: 6469 6361 7465 2074 6861 7420 7765 2073  dicate that we s
+0000d3e0: 686f 756c 646e 2774 2075 7365 2050 7954  houldn't use PyT
+0000d3f0: 6f72 6368 2773 2061 7574 6f67 7261 6420  orch's autograd 
+0000d400: 6265 6361 7573 650a 2020 2020 2320 2020  because.    #   
+0000d410: 7765 2772 6520 7573 696e 6720 6f75 7220  we're using our 
+0000d420: 6f77 6e20 6175 746f 6772 6164 2074 7261  own autograd tra
+0000d430: 6e73 666f 726d 0a20 2020 2063 666e 2e5f  nsform.    cfn._
+0000d440: 7573 696e 675f 6772 6164 5f74 7261 6e73  using_grad_trans
+0000d450: 666f 726d 203d 2054 7275 650a 0a20 2020  form = True..   
+0000d460: 2072 6574 7572 6e20 6164 645f 7472 616e   return add_tran
+0000d470: 7366 6f72 6d28 6366 6e2c 2074 7261 6e73  sform(cfn, trans
+0000d480: 666f 726d 3d5f 6772 6164 5f74 7261 6e73  form=_grad_trans
+0000d490: 666f 726d 2c20 6469 7361 626c 655f 746f  form, disable_to
+0000d4a0: 7263 685f 6175 746f 6772 6164 5f73 7570  rch_autograd_sup
+0000d4b0: 706f 7274 3d54 7275 6529 0a0a 0a64 6566  port=True)...def
+0000d4c0: 2067 7261 645f 7631 280a 2020 2020 6366   grad_v1(.    cf
+0000d4d0: 6e2c 0a29 202d 3e20 4361 6c6c 6162 6c65  n,.) -> Callable
+0000d4e0: 3a0a 2020 2020 6465 6620 6772 6164 2866  :.    def grad(f
+0000d4f0: 756e 6329 3a0a 2020 2020 2020 2020 6465  unc):.        de
+0000d500: 6620 6772 6164 5f66 756e 6328 2a61 7267  f grad_func(*arg
+0000d510: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000d520: 2020 2020 2020 2020 2020 5f2c 2067 7261            _, gra
+0000d530: 6473 203d 2076 616c 7565 5f61 6e64 5f67  ds = value_and_g
+0000d540: 7261 6428 6675 6e63 2928 2a61 7267 732c  rad(func)(*args,
+0000d550: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
+0000d560: 2020 2020 2020 2067 7261 6473 203d 205b         grads = [
+0000d570: 6720 666f 7220 6720 696e 2067 7261 6473  g for g in grads
+0000d580: 2069 6620 6720 6973 206e 6f74 204e 6f6e   if g is not Non
+0000d590: 655d 0a20 2020 2020 2020 2020 2020 2072  e].            r
+0000d5a0: 6574 7572 6e20 6772 6164 730a 0a20 2020  eturn grads..   
+0000d5b0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
+0000d5c0: 5f66 756e 630a 0a20 2020 2064 6566 205f  _func..    def _
+0000d5d0: 6772 6164 5f74 7261 6e73 666f 726d 2874  grad_transform(t
+0000d5e0: 7263 3a20 5472 6163 652c 202a 2c20 6578  rc: Trace, *, ex
+0000d5f0: 6563 7574 6f72 735f 6c69 7374 3a20 5365  ecutors_list: Se
+0000d600: 7175 656e 6365 5b41 6e79 5d29 202d 3e20  quence[Any]) -> 
+0000d610: 5472 6163 653a 0a20 2020 2020 2020 2067  Trace:.        g
+0000d620: 7261 6474 7263 203d 2063 6f6e 7374 7275  radtrc = constru
+0000d630: 6374 5f74 7261 6365 2829 2867 7261 6428  ct_trace()(grad(
+0000d640: 7472 632e 7079 7468 6f6e 5f63 616c 6c61  trc.python_calla
+0000d650: 626c 6528 2929 2c20 2a74 7263 2e61 7267  ble()), *trc.arg
+0000d660: 732c 202a 2a74 7263 2e6b 7761 7267 7329  s, **trc.kwargs)
+0000d670: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000d680: 6772 6164 7472 630a 0a20 2020 2063 666e  gradtrc..    cfn
+0000d690: 2e5f 7573 696e 675f 6772 6164 5f74 7261  ._using_grad_tra
+0000d6a0: 6e73 666f 726d 203d 2054 7275 650a 2020  nsform = True.  
+0000d6b0: 2020 7265 7475 726e 2061 6464 5f74 7261    return add_tra
+0000d6c0: 6e73 666f 726d 2863 666e 2c20 7472 616e  nsform(cfn, tran
+0000d6d0: 7366 6f72 6d3d 5f67 7261 645f 7472 616e  sform=_grad_tran
+0000d6e0: 7366 6f72 6d2c 2064 6973 6162 6c65 5f74  sform, disable_t
+0000d6f0: 6f72 6368 5f61 7574 6f67 7261 645f 7375  orch_autograd_su
+0000d700: 7070 6f72 743d 5472 7565 290a 0a0a 636c  pport=True)...cl
+0000d710: 6173 7320 5472 616e 7366 6f72 6d73 2845  ass Transforms(E
+0000d720: 6e75 6d29 3a0a 2020 2020 4964 656e 7469  num):.    Identi
+0000d730: 7479 4f70 203d 2061 7574 6f28 290a 2020  tyOp = auto().  
+0000d740: 2020 566d 6170 4f70 203d 2061 7574 6f28    VmapOp = auto(
+0000d750: 290a 2020 2020 4a76 704f 7020 3d20 6175  ).    JvpOp = au
+0000d760: 746f 2829 0a20 2020 2056 6a70 4f70 203d  to().    VjpOp =
+0000d770: 2061 7574 6f28 290a 0a0a 406c 7275 5f63   auto()...@lru_c
+0000d780: 6163 6865 286d 6178 7369 7a65 3d4e 6f6e  ache(maxsize=Non
+0000d790: 6529 0a64 6566 2073 796d 626f 6c5f 746f  e).def symbol_to
+0000d7a0: 5f65 7661 6c28 626f 756e 645f 7379 6d62  _eval(bound_symb
+0000d7b0: 6f6c 293a 0a20 2020 2022 2222 4d61 7020  ol):.    """Map 
+0000d7c0: 6120 426f 756e 6453 796d 626f 6c20 746f  a BoundSymbol to
+0000d7d0: 2061 2066 756e 6374 696f 6e20 7468 6174   a function that
+0000d7e0: 2065 7661 6c75 6174 6573 2069 742e 0a0a   evaluates it...
+0000d7f0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000d800: 2020 626f 756e 645f 7379 6d62 6f6c 3a20    bound_symbol: 
+0000d810: 426f 756e 6453 796d 626f 6c20 746f 206d  BoundSymbol to m
+0000d820: 6170 0a20 2020 2022 2222 0a20 2020 2023  ap.    """.    #
+0000d830: 2053 796d 626f 6c20 6973 2063 616c 6c61   Symbol is calla
+0000d840: 626c 650a 2020 2020 7265 7475 726e 2062  ble.    return b
+0000d850: 6f75 6e64 5f73 796d 626f 6c2e 7379 6d0a  ound_symbol.sym.
+0000d860: 0a0a 2320 544f 444f 3a20 4375 7272 656e  ..# TODO: Curren
+0000d870: 746c 7920 7765 2075 7365 2074 7261 6365  tly we use trace
+0000d880: 2e61 7267 7320 616e 6420 7472 6163 652e  .args and trace.
+0000d890: 6b77 6172 6773 2074 6f20 6765 7420 7468  kwargs to get th
+0000d8a0: 6520 6172 6775 6d65 6e74 730a 2320 4d61  e arguments.# Ma
+0000d8b0: 7962 6520 7765 2073 686f 756c 6420 7573  ybe we should us
+0000d8c0: 6520 7468 6573 6520 696e 7374 6561 640a  e these instead.
+0000d8d0: 7472 616e 7366 6f72 6d5f 736b 6970 5f6c  transform_skip_l
+0000d8e0: 6973 7420 3d20 280a 2020 2020 7072 696d  ist = (.    prim
+0000d8f0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+0000d900: 5f45 4d50 5459 5f44 4943 542c 0a20 2020  _EMPTY_DICT,.   
+0000d910: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
+0000d920: 4e50 4143 4b5f 4b45 592c 0a20 2020 2070  NPACK_KEY,.    p
+0000d930: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
+0000d940: 4143 4b5f 5345 5155 454e 4345 2c0a 2020  ACK_SEQUENCE,.  
+0000d950: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+0000d960: 554e 5041 434b 5f54 5249 5649 414c 2c0a  UNPACK_TRIVIAL,.
+0000d970: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+0000d980: 732e 5245 5455 524e 2c0a 290a 0a0a 6465  s.RETURN,.)...de
+0000d990: 6620 6576 616c 5f74 7261 6365 2874 7261  f eval_trace(tra
+0000d9a0: 6365 2c20 2a61 7267 732c 2073 796d 626f  ce, *args, symbo
+0000d9b0: 6c5f 6d61 7070 6572 3d73 796d 626f 6c5f  l_mapper=symbol_
+0000d9c0: 746f 5f65 7661 6c2c 2077 6974 685f 656e  to_eval, with_en
+0000d9d0: 763d 4661 6c73 652c 202a 2a6b 7761 7267  v=False, **kwarg
+0000d9e0: 7329 3a0a 2020 2020 2222 2245 7661 6c75  s):.    """Evalu
+0000d9f0: 6174 6520 6120 7472 6163 652e 0a0a 2020  ate a trace...  
+0000da00: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000da10: 7472 6163 653a 2074 7261 6365 2074 6f20  trace: trace to 
+0000da20: 6576 616c 7561 7465 0a20 2020 2020 2020  evaluate.       
+0000da30: 202a 6172 6773 3a20 6172 6775 6d65 6e74   *args: argument
+0000da40: 7320 746f 2065 7661 6c75 6174 6520 7468  s to evaluate th
+0000da50: 6520 7472 6163 6520 7769 7468 0a20 2020  e trace with.   
+0000da60: 2020 2020 2073 796d 626f 6c5f 6d61 7070       symbol_mapp
+0000da70: 6572 3a20 6675 6e63 7469 6f6e 2074 6861  er: function tha
+0000da80: 7420 6d61 7073 2061 2073 796d 626f 6c20  t maps a symbol 
+0000da90: 746f 2061 2066 756e 6374 696f 6e20 7468  to a function th
+0000daa0: 6174 2065 7661 6c75 6174 6573 2069 740a  at evaluates it.
+0000dab0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+0000dac0: 3a20 6b65 7977 6f72 6420 6172 6775 6d65  : keyword argume
+0000dad0: 6e74 7320 746f 2065 7661 6c75 6174 6520  nts to evaluate 
+0000dae0: 7468 6520 7472 6163 6520 7769 7468 0a0a  the trace with..
+0000daf0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0000db00: 2020 2020 2072 6573 756c 7420 6f66 2065       result of e
+0000db10: 7661 6c75 6174 696e 6720 7468 6520 7472  valuating the tr
+0000db20: 6163 650a 2020 2020 2222 220a 2020 2020  ace.    """.    
+0000db30: 656e 7620 3d20 7b7d 0a0a 2020 2020 6465  env = {}..    de
+0000db40: 6620 7265 6164 2878 3a20 5661 7269 6162  f read(x: Variab
+0000db50: 6c65 293a 0a20 2020 2020 2020 2069 6620  le):.        if 
+0000db60: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
+0000db70: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
+0000db80: 2020 2020 2072 6574 7572 6e20 656e 765b       return env[
+0000db90: 782e 6e61 6d65 5d0a 2020 2020 2020 2020  x.name].        
+0000dba0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000dbb0: 2020 7265 7475 726e 2078 0a0a 2020 2020    return x..    
+0000dbc0: 6465 6620 7772 6974 6528 763a 2056 6172  def write(v: Var
+0000dbd0: 6961 626c 652c 2076 616c 3a20 416e 792c  iable, val: Any,
+0000dbe0: 2061 6c6c 6f77 5f64 7570 6c69 6361 7465   allow_duplicate
+0000dbf0: 733d 4661 6c73 6529 202d 3e20 4e6f 6e65  s=False) -> None
+0000dc00: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+0000dc10: 2069 7369 6e73 7461 6e63 6528 762c 2056   isinstance(v, V
+0000dc20: 6172 6961 626c 6529 3a0a 2020 2020 2020  ariable):.      
+0000dc30: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0000dc40: 2020 2020 2023 2044 7570 6c69 6361 7465       # Duplicate
+0000dc50: 7320 6172 6520 616c 6c6f 7765 6420 616e  s are allowed an
+0000dc60: 6420 6f76 6572 7772 6974 7465 6e0a 2020  d overwritten.  
+0000dc70: 2020 2020 2020 6966 2076 2e6e 616d 6520        if v.name 
+0000dc80: 696e 2065 6e76 3a0a 2020 2020 2020 2020  in env:.        
+0000dc90: 2020 2020 6966 2061 6c6c 6f77 5f64 7570      if allow_dup
+0000dca0: 6c69 6361 7465 733a 0a20 2020 2020 2020  licates:.       
+0000dcb0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000dcc0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000dcd0: 6520 5661 6c75 6545 7272 6f72 2866 2256  e ValueError(f"V
+0000dce0: 6172 6961 626c 6520 7b76 2e6e 616d 657d  ariable {v.name}
+0000dcf0: 2069 7320 6265 696e 6720 6f76 6572 7772   is being overwr
+0000dd00: 6974 7465 6e20 7468 6973 2069 7320 6e6f  itten this is no
+0000dd10: 7420 616c 6c6f 7765 6422 290a 2020 2020  t allowed").    
+0000dd20: 2020 2020 656e 765b 762e 6e61 6d65 5d20      env[v.name] 
+0000dd30: 3d20 7661 6c0a 0a20 2020 2073 6166 655f  = val..    safe_
+0000dd40: 6d61 705f 666c 6174 2877 7269 7465 2c20  map_flat(write, 
+0000dd50: 6c69 7374 2874 7261 6365 2e61 7267 7329  list(trace.args)
+0000dd60: 2c20 6c69 7374 2861 7267 7329 290a 2020  , list(args)).  
+0000dd70: 2020 7361 6665 5f6d 6170 5f66 6c61 7428    safe_map_flat(
+0000dd80: 7772 6974 652c 206c 6973 7428 7472 6163  write, list(trac
+0000dd90: 652e 6b77 6172 6773 2e76 616c 7565 7328  e.kwargs.values(
+0000dda0: 2929 2c20 6c69 7374 286b 7761 7267 732e  )), list(kwargs.
+0000ddb0: 7661 6c75 6573 2829 2929 0a0a 2020 2020  values()))..    
+0000ddc0: 666f 7220 7379 6d62 6f6c 2069 6e20 7472  for symbol in tr
+0000ddd0: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0000dde0: 733a 0a20 2020 2020 2020 2069 6620 7379  s:.        if sy
+0000ddf0: 6d62 6f6c 2e73 796d 2e69 6420 696e 2074  mbol.sym.id in t
+0000de00: 7261 6e73 666f 726d 5f73 6b69 705f 6c69  ransform_skip_li
+0000de10: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+0000de20: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+0000de30: 2061 7267 7320 3d20 7472 6565 5f6d 6170   args = tree_map
+0000de40: 2872 6561 642c 2073 796d 626f 6c2e 6172  (read, symbol.ar
+0000de50: 6773 290a 2020 2020 2020 2020 6b77 6172  gs).        kwar
+0000de60: 6773 203d 2074 7265 655f 6d61 7028 7265  gs = tree_map(re
+0000de70: 6164 2c20 7379 6d62 6f6c 2e6b 7761 7267  ad, symbol.kwarg
+0000de80: 7329 0a20 2020 2020 2020 2070 7269 6d5f  s).        prim_
+0000de90: 6675 6e63 203d 2073 796d 626f 6c5f 6d61  func = symbol_ma
+0000dea0: 7070 6572 2873 796d 626f 6c29 0a20 2020  pper(symbol).   
+0000deb0: 2020 2020 2069 6620 7072 696d 5f66 756e       if prim_fun
+0000dec0: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
+0000ded0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0000dee0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0000def0: 2070 7269 6d5f 6675 6e63 282a 6172 6773   prim_func(*args
+0000df00: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0000df10: 2020 2020 7361 6665 5f6d 6170 5f66 6c61      safe_map_fla
+0000df20: 7428 7772 6974 652c 206c 6973 7428 7365  t(write, list(se
+0000df30: 7175 656e 6369 6679 2873 796d 626f 6c2e  quencify(symbol.
+0000df40: 6f75 7470 7574 2929 2c20 6c69 7374 2873  output)), list(s
+0000df50: 6571 7565 6e63 6966 7928 7265 7375 6c74  equencify(result
+0000df60: 2929 290a 0a20 2020 2069 6620 7769 7468  )))..    if with
+0000df70: 5f65 6e76 3a0a 2020 2020 2020 2020 7265  _env:.        re
+0000df80: 7475 726e 2074 7265 655f 6d61 7028 7265  turn tree_map(re
+0000df90: 6164 2c20 7472 6163 652e 6f75 7470 7574  ad, trace.output
+0000dfa0: 292c 2065 6e76 0a0a 2020 2020 7265 7475  ), env..    retu
+0000dfb0: 726e 2074 7265 655f 6d61 7028 7265 6164  rn tree_map(read
+0000dfc0: 2c20 7472 6163 652e 6f75 7470 7574 290a  , trace.output).
+0000dfd0: 0a0a 6465 6620 5f69 6465 6e74 6974 795f  ..def _identity_
+0000dfe0: 6361 6c6c 5f6d 6574 6166 756e 6328 2a61  call_metafunc(*a
+0000dff0: 7267 732c 2074 7261 6365 3a20 5472 6163  rgs, trace: Trac
+0000e000: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
+0000e010: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
+0000e020: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
+0000e030: 2072 6574 7572 6e20 6576 616c 5f74 7261   return eval_tra
+0000e040: 6365 2874 7261 6365 2c20 2a61 7267 732c  ce(trace, *args,
+0000e050: 202a 2a6b 7761 7267 7329 0a0a 0a69 6465   **kwargs)...ide
+0000e060: 6e74 6974 795f 6361 6c6c 203d 2053 796d  ntity_call = Sym
+0000e070: 626f 6c28 6964 3d54 7261 6e73 666f 726d  bol(id=Transform
+0000e080: 732e 4964 656e 7469 7479 4f70 2c20 6e61  s.IdentityOp, na
+0000e090: 6d65 3d22 6964 656e 7469 7479 5f63 616c  me="identity_cal
+0000e0a0: 6c22 2c20 6d65 7461 3d5f 6964 656e 7469  l", meta=_identi
+0000e0b0: 7479 5f63 616c 6c5f 6d65 7461 6675 6e63  ty_call_metafunc
+0000e0c0: 290a 0a0a 6465 6620 6964 656e 7469 7479  )...def identity
+0000e0d0: 2866 756e 6329 3a0a 2020 2020 2222 2249  (func):.    """I
+0000e0e0: 6465 6e74 6974 7920 7472 616e 7366 6f72  dentity transfor
+0000e0f0: 6d20 666f 7220 6120 5468 756e 6465 7220  m for a Thunder 
+0000e100: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2041  function...    A
+0000e110: 7267 733a 0a20 2020 2020 2020 2066 756e  rgs:.        fun
+0000e120: 6320 2843 616c 6c61 626c 6529 3a20 4120  c (Callable): A 
+0000e130: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
+0000e140: 2074 6f20 6265 2074 7261 6e73 666f 726d   to be transform
+0000e150: 6564 2e0a 2020 2020 2222 220a 0a20 2020  ed..    """..   
+0000e160: 2064 6566 2077 7261 7070 6572 282a 6172   def wrapper(*ar
+0000e170: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0000e180: 2020 2020 2020 2074 7261 6365 203d 2063         trace = c
+0000e190: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+0000e1a0: 2866 756e 632c 202a 6172 6773 2c20 2a2a  (func, *args, **
+0000e1b0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0000e1c0: 7265 7475 726e 2069 6465 6e74 6974 795f  return identity_
+0000e1d0: 6361 6c6c 282a 6172 6773 2c20 2a2a 6b77  call(*args, **kw
+0000e1e0: 6172 6773 2c20 7472 6163 653d 7472 6163  args, trace=trac
+0000e1f0: 6529 0a0a 2020 2020 7265 7475 726e 2077  e)..    return w
+0000e200: 7261 7070 6572 0a0a 0a64 6566 205f 6964  rapper...def _id
+0000e210: 656e 7469 7479 5f63 616c 6c5f 7079 746f  entity_call_pyto
+0000e220: 7263 6828 2a61 7267 732c 2074 7261 6365  rch(*args, trace
+0000e230: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+0000e240: 7329 3a0a 2020 2020 696d 706f 7274 2074  s):.    import t
+0000e250: 6f72 6368 0a0a 2020 2020 6465 6620 7379  orch..    def sy
+0000e260: 6d62 6f6c 5f6d 6170 7065 7228 6f70 293a  mbol_mapper(op):
+0000e270: 0a20 2020 2020 2020 2069 6620 6f70 2e6f  .        if op.o
+0000e280: 7020 3d3d 2054 7261 6e73 666f 726d 732e  p == Transforms.
+0000e290: 4964 656e 7469 7479 4f70 3a0a 2020 2020  IdentityOp:.    
+0000e2a0: 2020 2020 2020 2020 7265 7475 726e 205f          return _
+0000e2b0: 6964 656e 7469 7479 5f63 616c 6c5f 7079  identity_call_py
+0000e2c0: 746f 7263 680a 0a20 2020 2020 2020 2074  torch..        t
+0000e2d0: 6f72 6368 5f6f 7020 3d20 6f70 735f 746f  orch_op = ops_to
+0000e2e0: 5f74 6f72 6368 5f6f 7073 5f6d 6170 5b6f  _torch_ops_map[o
+0000e2f0: 702e 6f70 5d0a 2020 2020 2020 2020 6966  p.op].        if
+0000e300: 2069 7369 6e73 7461 6e63 6528 746f 7263   isinstance(torc
+0000e310: 685f 6f70 2c20 7374 7229 3a0a 2020 2020  h_op, str):.    
+0000e320: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+0000e330: 6574 6174 7472 2874 6f72 6368 2c20 746f  etattr(torch, to
+0000e340: 7263 685f 6f70 2e73 7472 6970 2822 7079  rch_op.strip("py
+0000e350: 746f 7263 682e 2229 290a 2020 2020 2020  torch.")).      
+0000e360: 2020 7265 7475 726e 2074 6f72 6368 5f6f    return torch_o
+0000e370: 700a 0a20 2020 2077 6974 6820 6465 7461  p..    with deta
+0000e380: 6368 6564 5f74 7261 6365 2829 3a0a 2020  ched_trace():.  
+0000e390: 2020 2020 2020 7265 7475 726e 2065 7661        return eva
+0000e3a0: 6c5f 7472 6163 6528 7472 6163 652c 202a  l_trace(trace, *
+0000e3b0: 6172 6773 2c20 2a2a 6b77 6172 6773 2c20  args, **kwargs, 
+0000e3c0: 7379 6d62 6f6c 5f6d 6170 7065 723d 7379  symbol_mapper=sy
+0000e3d0: 6d62 6f6c 5f6d 6170 7065 7229 0a0a 0a23  mbol_mapper)...#
+0000e3e0: 2052 6567 6973 7465 7220 7468 6520 6964   Register the id
+0000e3f0: 656e 7469 7479 2063 616c 6c20 666f 7220  entity call for 
+0000e400: 5079 546f 7263 6820 6578 6563 7574 6f72  PyTorch executor
+0000e410: 2e0a 2320 6f70 735f 746f 5f74 6f72 6368  ..# ops_to_torch
+0000e420: 5f6f 7073 5f6d 6170 5b54 7261 6e73 666f  _ops_map[Transfo
+0000e430: 726d 732e 4964 656e 7469 7479 4f70 5d20  rms.IdentityOp] 
+0000e440: 3d20 5f69 6465 6e74 6974 795f 6361 6c6c  = _identity_call
+0000e450: 5f70 7974 6f72 6368 0a0a 0a23 2056 4d41  _pytorch...# VMA
+0000e460: 5020 7472 616e 7366 6f72 6d0a 2320 2d2d  P transform.# --
+0000e470: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a 636c  -----------...cl
+0000e480: 6173 7320 4e6f 744d 6170 7065 643a 0a20  ass NotMapped:. 
+0000e490: 2020 2022 2222 5265 7072 6573 656e 7473     """Represents
+0000e4a0: 2061 206e 6f6e 2d62 6174 6368 6564 2064   a non-batched d
+0000e4b0: 696d 656e 7369 6f6e 2e22 2222 0a0a 2020  imension."""..  
+0000e4c0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+0000e4d0: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0000e4e0: 7475 726e 2022 6e6f 745f 6d61 7070 6564  turn "not_mapped
+0000e4f0: 220a 0a0a 4064 6174 6163 6c61 7373 2866  "...@dataclass(f
+0000e500: 726f 7a65 6e3d 5472 7565 290a 636c 6173  rozen=True).clas
+0000e510: 7320 4261 7463 6865 6456 616c 7565 3a0a  s BatchedValue:.
+0000e520: 2020 2020 2222 2242 6174 6368 6564 2076      """Batched v
+0000e530: 616c 7565 2066 6f72 2074 6865 2076 6d61  alue for the vma
+0000e540: 7020 7472 616e 7366 6f72 6d2e 0a0a 2020  p transform...  
+0000e550: 2020 4174 7472 6962 7574 6573 3a0a 2020    Attributes:.  
+0000e560: 2020 2020 2020 7661 6c75 653a 2042 6174        value: Bat
+0000e570: 6368 6564 2076 616c 7565 2e0a 2020 2020  ched value..    
+0000e580: 2020 2020 6261 7463 685f 6469 6d3a 2042      batch_dim: B
+0000e590: 6174 6368 696e 6720 6469 6d65 6e73 696f  atching dimensio
+0000e5a0: 6e20 6f72 206e 6f74 5f6d 6170 7065 640a  n or not_mapped.
+0000e5b0: 2020 2020 2222 220a 0a20 2020 2076 616c      """..    val
+0000e5c0: 7565 3a20 416e 790a 2020 2020 6261 7463  ue: Any.    batc
+0000e5d0: 685f 6469 6d3a 2069 6e74 207c 204e 6f74  h_dim: int | Not
+0000e5e0: 4d61 7070 6564 0a0a 2020 2020 6465 6620  Mapped..    def 
+0000e5f0: 5f5f 6974 6572 5f5f 2873 656c 6629 3a0a  __iter__(self):.
+0000e600: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+0000e610: 6c66 2e76 616c 7565 0a20 2020 2020 2020  lf.value.       
+0000e620: 2079 6965 6c64 2073 656c 662e 6261 7463   yield self.batc
+0000e630: 685f 6469 6d0a 0a0a 6465 6620 7061 6972  h_dim...def pair
+0000e640: 5f74 6f5f 6261 7463 6865 645f 7661 6c75  _to_batched_valu
+0000e650: 6528 7061 6972 293a 0a20 2020 2022 2222  e(pair):.    """
+0000e660: 436f 6e76 6572 7473 2061 2070 6169 7220  Converts a pair 
+0000e670: 746f 2061 2042 6174 6368 6564 5661 6c75  to a BatchedValu
+0000e680: 652e 0a0a 2020 2020 4172 6773 3a0a 2020  e...    Args:.  
+0000e690: 2020 2020 2020 7061 6972 2028 5365 7175        pair (Sequ
+0000e6a0: 656e 6365 293a 2050 6169 7220 746f 2063  ence): Pair to c
+0000e6b0: 6f6e 7665 7274 2e0a 0a20 2020 2052 6574  onvert...    Ret
+0000e6c0: 7572 6e73 3a0a 2020 2020 2020 2020 4261  urns:.        Ba
+0000e6d0: 7463 6865 6456 616c 7565 3a20 4261 7463  tchedValue: Batc
+0000e6e0: 6865 6456 616c 7565 2072 6570 7265 7365  hedValue represe
+0000e6f0: 6e74 6174 696f 6e20 6f66 2074 6865 2070  ntation of the p
+0000e700: 6169 722e 0a20 2020 2022 2222 0a20 2020  air..    """.   
+0000e710: 2069 6620 6973 696e 7374 616e 6365 2870   if isinstance(p
+0000e720: 6169 722c 2042 6174 6368 6564 5661 6c75  air, BatchedValu
+0000e730: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
+0000e740: 726e 2070 6169 720a 2020 2020 656c 7365  rn pair.    else
+0000e750: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0000e760: 2069 7369 6e73 7461 6e63 6528 7061 6972   isinstance(pair
+0000e770: 2c20 5365 7175 656e 6365 2920 616e 6420  , Sequence) and 
+0000e780: 6c65 6e28 7061 6972 2920 3d3d 2032 0a20  len(pair) == 2. 
+0000e790: 2020 2020 2020 2072 6574 7572 6e20 4261         return Ba
+0000e7a0: 7463 6865 6456 616c 7565 282a 7061 6972  tchedValue(*pair
+0000e7b0: 290a 0a0a 6465 6620 7665 6374 6f72 697a  )...def vectoriz
+0000e7c0: 6564 5f62 6174 6368 6572 2870 7269 6d2c  ed_batcher(prim,
+0000e7d0: 2061 7869 735f 7369 7a65 2c20 6261 7463   axis_size, batc
+0000e7e0: 6865 645f 7661 6c75 6573 2c20 2a2a 6b77  hed_values, **kw
+0000e7f0: 6172 6773 293a 0a20 2020 2062 6174 6368  args):.    batch
+0000e800: 5f64 696d 203d 2062 6174 6368 6564 5f76  _dim = batched_v
+0000e810: 616c 7565 735b 305d 2e62 6174 6368 5f64  alues[0].batch_d
+0000e820: 696d 0a20 2020 2061 7373 6572 7420 616c  im.    assert al
+0000e830: 6c28 0a20 2020 2020 2020 2062 6174 6368  l(.        batch
+0000e840: 5f64 696d 203d 3d20 6276 2e62 6174 6368  _dim == bv.batch
+0000e850: 5f64 696d 2066 6f72 2062 7620 696e 2062  _dim for bv in b
+0000e860: 6174 6368 6564 5f76 616c 7565 735b 313a  atched_values[1:
+0000e870: 5d0a 2020 2020 292c 2066 2260 7665 6374  ].    ), f"`vect
+0000e880: 6f72 697a 6564 5f62 6174 6368 6572 6020  orized_batcher` 
+0000e890: 676f 7420 6469 6666 6572 656e 7420 6261  got different ba
+0000e8a0: 7463 6865 6420 6469 6d65 6e73 696f 6e73  tched dimensions
+0000e8b0: 207b 5b62 762e 6261 7463 685f 6469 6d20   {[bv.batch_dim 
+0000e8c0: 666f 7220 6276 2069 6e20 6261 7463 6865  for bv in batche
+0000e8d0: 645f 7661 6c75 6573 5d7d 220a 2020 2020  d_values]}".    
+0000e8e0: 7265 7475 726e 2042 6174 6368 6564 5661  return BatchedVa
+0000e8f0: 6c75 6528 7072 696d 282a 5b62 762e 7661  lue(prim(*[bv.va
+0000e900: 6c75 6520 666f 7220 6276 2069 6e20 6261  lue for bv in ba
+0000e910: 7463 6865 645f 7661 6c75 6573 5d2c 202a  tched_values], *
+0000e920: 2a6b 7761 7267 7329 2c20 6261 7463 685f  *kwargs), batch_
+0000e930: 6469 6d29 0a0a 0a6e 6f74 5f6d 6170 7065  dim)...not_mappe
+0000e940: 6420 3d20 4e6f 744d 6170 7065 6428 290a  d = NotMapped().
+0000e950: 0a0a 6465 6620 6d6f 7665 6469 6d28 782c  ..def movedim(x,
+0000e960: 2073 7263 3a20 696e 742c 2064 7374 3a20   src: int, dst: 
+0000e970: 696e 7429 3a0a 2020 2020 7065 726d 203d  int):.    perm =
+0000e980: 205b 6920 666f 7220 6920 696e 2072 616e   [i for i in ran
+0000e990: 6765 2878 2e6e 6469 6d29 2069 6620 6920  ge(x.ndim) if i 
+0000e9a0: 213d 2073 7263 5d0a 2020 2020 7065 726d  != src].    perm
+0000e9b0: 2e69 6e73 6572 7428 6473 742c 2073 7263  .insert(dst, src
+0000e9c0: 290a 2020 2020 7265 7475 726e 2070 7269  ).    return pri
+0000e9d0: 6d73 2e74 7261 6e73 706f 7365 2878 2c20  ms.transpose(x, 
+0000e9e0: 7475 706c 6528 7065 726d 2929 0a0a 0a64  tuple(perm))...d
+0000e9f0: 6566 206d 6f76 655f 6261 7463 685f 6469  ef move_batch_di
+0000ea00: 6d28 6178 6973 5f73 697a 652c 2073 7263  m(axis_size, src
+0000ea10: 2c20 6473 742c 2078 293a 0a20 2020 2069  , dst, x):.    i
+0000ea20: 6620 7372 6320 6973 206e 6f74 5f6d 6170  f src is not_map
+0000ea30: 7065 643a 0a20 2020 2020 2020 2069 6620  ped:.        if 
+0000ea40: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+0000ea50: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
+0000ea60: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
+0000ea70: 2020 2020 7461 7267 6574 5f73 6861 7065      target_shape
+0000ea80: 203d 206c 6973 7428 782e 7368 6170 6529   = list(x.shape)
+0000ea90: 0a20 2020 2020 2020 2074 6172 6765 745f  .        target_
+0000eaa0: 7368 6170 652e 696e 7365 7274 2864 7374  shape.insert(dst
+0000eab0: 2c20 6178 6973 5f73 697a 6529 0a20 2020  , axis_size).   
+0000eac0: 2020 2020 2062 6361 7374 5f64 696d 7320       bcast_dims 
+0000ead0: 3d20 6c69 7374 2872 616e 6765 286c 656e  = list(range(len
+0000eae0: 2874 6172 6765 745f 7368 6170 6529 2929  (target_shape)))
+0000eaf0: 0a20 2020 2020 2020 2062 6361 7374 5f64  .        bcast_d
+0000eb00: 696d 732e 706f 7028 6473 7429 0a20 2020  ims.pop(dst).   
+0000eb10: 2020 2020 2072 6574 7572 6e20 7072 696d       return prim
+0000eb20: 732e 6272 6f61 6463 6173 745f 696e 5f64  s.broadcast_in_d
+0000eb30: 696d 2878 2c20 7461 7267 6574 5f73 6861  im(x, target_sha
+0000eb40: 7065 2c20 6263 6173 745f 6469 6d73 290a  pe, bcast_dims).
+0000eb50: 2020 2020 656c 6966 2073 7263 203d 3d20      elif src == 
+0000eb60: 6473 743a 0a20 2020 2020 2020 2072 6574  dst:.        ret
+0000eb70: 7572 6e20 780a 2020 2020 656c 7365 3a0a  urn x.    else:.
+0000eb80: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+0000eb90: 6f76 6564 696d 2878 2c20 7372 632c 2064  ovedim(x, src, d
+0000eba0: 7374 290a 0a0a 6465 6620 6269 6e61 7279  st)...def binary
+0000ebb0: 5f6f 705f 6261 7463 6869 6e67 5f72 756c  _op_batching_rul
+0000ebc0: 6528 6f70 3a20 7072 696d 732e 5072 696d  e(op: prims.Prim
+0000ebd0: 4944 732c 2061 7869 735f 7369 7a65 3a20  IDs, axis_size: 
+0000ebe0: 696e 742c 2076 616c 735f 696e 3a20 4261  int, vals_in: Ba
+0000ebf0: 7463 6865 6456 616c 7565 293a 0a20 2020  tchedValue):.   
+0000ec00: 2028 2878 2c20 785f 6264 696d 292c 2028   ((x, x_bdim), (
+0000ec10: 792c 2079 5f62 6469 6d29 2920 3d20 7661  y, y_bdim)) = va
+0000ec20: 6c73 5f69 6e0a 2020 2020 6966 2078 5f62  ls_in.    if x_b
+0000ec30: 6469 6d20 213d 2079 5f62 6469 6d3a 0a20  dim != y_bdim:. 
+0000ec40: 2020 2020 2020 2069 6620 785f 6264 696d         if x_bdim
+0000ec50: 2069 7320 6e6f 745f 6d61 7070 6564 3a0a   is not_mapped:.
+0000ec60: 2020 2020 2020 2020 2020 2020 7820 3d20              x = 
+0000ec70: 6d6f 7665 5f62 6174 6368 5f64 696d 2861  move_batch_dim(a
+0000ec80: 7869 735f 7369 7a65 2c20 785f 6264 696d  xis_size, x_bdim
+0000ec90: 2c20 795f 6264 696d 2c20 7829 0a20 2020  , y_bdim, x).   
+0000eca0: 2020 2020 2020 2020 2078 5f62 6469 6d20           x_bdim 
+0000ecb0: 3d20 795f 6264 696d 0a20 2020 2020 2020  = y_bdim.       
+0000ecc0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ecd0: 2020 2079 203d 206d 6f76 655f 6261 7463     y = move_batc
+0000ece0: 685f 6469 6d28 6178 6973 5f73 697a 652c  h_dim(axis_size,
+0000ecf0: 2079 5f62 6469 6d2c 2078 5f62 6469 6d2c   y_bdim, x_bdim,
+0000ed00: 2079 290a 2020 2020 7265 7475 726e 2042   y).    return B
+0000ed10: 6174 6368 6564 5661 6c75 6528 6f70 2878  atchedValue(op(x
+0000ed20: 2c20 7929 2c20 785f 6264 696d 290a 0a0a  , y), x_bdim)...
+0000ed30: 6465 6620 7369 6e5f 766d 6170 2861 7869  def sin_vmap(axi
+0000ed40: 735f 7369 7a65 3a20 696e 742c 2061 3a20  s_size: int, a: 
+0000ed50: 4261 7463 6865 6456 616c 7565 2920 2d3e  BatchedValue) ->
+0000ed60: 2042 6174 6368 6564 5661 6c75 653a 0a20   BatchedValue:. 
+0000ed70: 2020 2072 6574 7572 6e20 7665 6374 6f72     return vector
+0000ed80: 697a 6564 5f62 6174 6368 6572 2870 7269  ized_batcher(pri
+0000ed90: 6d73 2e73 696e 2c20 6178 6973 5f73 697a  ms.sin, axis_siz
+0000eda0: 652c 2028 612c 2929 0a0a 0a64 6566 2063  e, (a,))...def c
+0000edb0: 6f73 5f76 6d61 7028 6178 6973 5f73 697a  os_vmap(axis_siz
+0000edc0: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
+0000edd0: 6564 5661 6c75 6529 202d 3e20 4261 7463  edValue) -> Batc
+0000ede0: 6865 6456 616c 7565 3a0a 2020 2020 7265  hedValue:.    re
+0000edf0: 7475 726e 2076 6563 746f 7269 7a65 645f  turn vectorized_
+0000ee00: 6261 7463 6865 7228 7072 696d 732e 636f  batcher(prims.co
+0000ee10: 732c 2061 7869 735f 7369 7a65 2c20 2861  s, axis_size, (a
+0000ee20: 2c29 290a 0a0a 6465 6620 6d75 6c5f 766d  ,))...def mul_vm
+0000ee30: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
+0000ee40: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
+0000ee50: 7565 2c20 623a 2042 6174 6368 6564 5661  ue, b: BatchedVa
+0000ee60: 6c75 6529 202d 3e20 4261 7463 6865 6456  lue) -> BatchedV
+0000ee70: 616c 7565 3a0a 2020 2020 7265 7475 726e  alue:.    return
+0000ee80: 2062 696e 6172 795f 6f70 5f62 6174 6368   binary_op_batch
+0000ee90: 696e 675f 7275 6c65 2870 7269 6d73 2e6d  ing_rule(prims.m
+0000eea0: 756c 2c20 6178 6973 5f73 697a 652c 2028  ul, axis_size, (
+0000eeb0: 612c 2062 2929 0a0a 0a64 6566 2061 6464  a, b))...def add
+0000eec0: 5f76 6d61 7028 6178 6973 5f73 697a 653a  _vmap(axis_size:
+0000eed0: 2069 6e74 2c20 613a 2042 6174 6368 6564   int, a: Batched
+0000eee0: 5661 6c75 652c 2062 3a20 4261 7463 6865  Value, b: Batche
+0000eef0: 6456 616c 7565 2920 2d3e 2042 6174 6368  dValue) -> Batch
+0000ef00: 6564 5661 6c75 653a 0a20 2020 2072 6574  edValue:.    ret
+0000ef10: 7572 6e20 6269 6e61 7279 5f6f 705f 6261  urn binary_op_ba
+0000ef20: 7463 6869 6e67 5f72 756c 6528 7072 696d  tching_rule(prim
+0000ef30: 732e 6164 642c 2061 7869 735f 7369 7a65  s.add, axis_size
+0000ef40: 2c20 2861 2c20 6229 290a 0a0a 6465 6620  , (a, b))...def 
+0000ef50: 7375 6d5f 766d 6170 2861 7869 735f 7369  sum_vmap(axis_si
+0000ef60: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
+0000ef70: 6865 6456 616c 7565 2c20 6469 6d73 3a20  hedValue, dims: 
+0000ef80: 5365 7175 656e 6365 5b69 6e74 5d2c 202a  Sequence[int], *
+0000ef90: 2a6b 7761 7267 7329 202d 3e20 4261 7463  *kwargs) -> Batc
+0000efa0: 6865 6456 616c 7565 3a0a 2020 2020 6264  hedValue:.    bd
+0000efb0: 696d 203d 2061 2e62 6174 6368 5f64 696d  im = a.batch_dim
+0000efc0: 0a20 2020 2023 2054 4f44 4f3a 2072 656d  .    # TODO: rem
+0000efd0: 6f76 6520 7468 6973 2077 6865 6e20 6469  ove this when di
+0000efe0: 6d73 2062 6563 6f6d 6573 2061 206d 616e  ms becomes a man
+0000eff0: 6461 746f 7279 206b 7761 7267 0a20 2020  datory kwarg.   
+0000f000: 2069 6620 6c65 6e28 6469 6d73 2920 3e20   if len(dims) > 
+0000f010: 303a 0a20 2020 2020 2020 2064 696d 732c  0:.        dims,
+0000f020: 205f 203d 2073 6166 655f 7a69 7028 2a64   _ = safe_zip(*d
+0000f030: 696d 7329 0a20 2020 2064 696d 735f 6265  ims).    dims_be
+0000f040: 666f 7265 203d 2074 7570 6c65 2865 6c20  fore = tuple(el 
+0000f050: 666f 7220 656c 2069 6e20 6469 6d73 2069  for el in dims i
+0000f060: 6620 656c 203c 2062 6469 6d29 0a20 2020  f el < bdim).   
+0000f070: 2064 696d 735f 6166 7465 7220 3d20 7475   dims_after = tu
+0000f080: 706c 6528 656c 202b 2031 2066 6f72 2065  ple(el + 1 for e
+0000f090: 6c20 696e 2064 696d 7320 6966 2065 6c20  l in dims if el 
+0000f0a0: 3e3d 2062 6469 6d29 0a20 2020 2062 6174  >= bdim).    bat
+0000f0b0: 6368 6564 5f64 696d 7320 3d20 6469 6d73  ched_dims = dims
+0000f0c0: 5f62 6566 6f72 6520 2b20 6469 6d73 5f61  _before + dims_a
+0000f0d0: 6674 6572 0a20 2020 2072 6574 7572 6e20  fter.    return 
+0000f0e0: 7665 6374 6f72 697a 6564 5f62 6174 6368  vectorized_batch
+0000f0f0: 6572 2870 7269 6d73 2e73 756d 2c20 6178  er(prims.sum, ax
+0000f100: 6973 5f73 697a 652c 2028 612c 292c 2064  is_size, (a,), d
+0000f110: 696d 733d 6261 7463 6865 645f 6469 6d73  ims=batched_dims
+0000f120: 2c20 2a2a 6b77 6172 6773 290a 0a0a 2320  , **kwargs)...# 
+0000f130: 544f 444f 3a20 506c 6561 7365 2074 6573  TODO: Please tes
+0000f140: 7420 7468 6973 2065 7874 656e 7369 7665  t this extensive
+0000f150: 6c79 0a64 6566 2062 726f 6164 6361 7374  ly.def broadcast
+0000f160: 5f69 6e5f 6469 6d5f 766d 6170 280a 2020  _in_dim_vmap(.  
+0000f170: 2020 6178 6973 5f73 697a 653a 2069 6e74    axis_size: int
+0000f180: 2c20 613a 2042 6174 6368 6564 5661 6c75  , a: BatchedValu
+0000f190: 652c 2073 6861 7065 3a20 5365 7175 656e  e, shape: Sequen
+0000f1a0: 6365 5b42 6174 6368 6564 5661 6c75 655d  ce[BatchedValue]
+0000f1b0: 2c20 6272 6f61 6463 6173 745f 6469 6d65  , broadcast_dime
+0000f1c0: 6e73 696f 6e73 3a20 5365 7175 656e 6365  nsions: Sequence
+0000f1d0: 5b42 6174 6368 6564 5661 6c75 655d 0a29  [BatchedValue].)
+0000f1e0: 202d 3e20 4261 7463 6865 6456 616c 7565   -> BatchedValue
+0000f1f0: 3a0a 2020 2020 6264 696d 203d 2061 2e62  :.    bdim = a.b
+0000f200: 6174 6368 5f64 696d 0a20 2020 2023 2054  atch_dim.    # T
+0000f210: 4f44 4f3a 2072 656d 6f76 6520 7468 6973  ODO: remove this
+0000f220: 2077 6865 6e20 7368 6170 6520 616e 6420   when shape and 
+0000f230: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+0000f240: 696f 6e73 2062 6563 6f6d 6520 6d61 6e64  ions become mand
+0000f250: 6174 6f72 7920 6b77 6172 6773 0a20 2020  atory kwargs.   
+0000f260: 2073 6861 7065 2c20 5f20 3d20 7361 6665   shape, _ = safe
+0000f270: 5f7a 6970 282a 7368 6170 6529 0a20 2020  _zip(*shape).   
+0000f280: 2069 6620 6c65 6e28 6272 6f61 6463 6173   if len(broadcas
+0000f290: 745f 6469 6d65 6e73 696f 6e73 2920 3e20  t_dimensions) > 
+0000f2a0: 303a 0a20 2020 2020 2020 2062 726f 6164  0:.        broad
+0000f2b0: 6361 7374 5f64 696d 656e 7369 6f6e 732c  cast_dimensions,
+0000f2c0: 205f 203d 2073 6166 655f 7a69 7028 2a62   _ = safe_zip(*b
+0000f2d0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000f2e0: 6f6e 7329 0a20 2020 2069 6620 6264 696d  ons).    if bdim
+0000f2f0: 2069 7320 6e6f 745f 6d61 7070 6564 3a0a   is not_mapped:.
+0000f300: 2020 2020 2020 2020 7265 7475 726e 2042          return B
+0000f310: 6174 6368 6564 5661 6c75 6528 7072 696d  atchedValue(prim
+0000f320: 732e 6272 6f61 6463 6173 745f 696e 5f64  s.broadcast_in_d
+0000f330: 696d 2861 2e76 616c 7565 2c20 7368 6170  im(a.value, shap
+0000f340: 652c 2062 726f 6164 6361 7374 5f64 696d  e, broadcast_dim
+0000f350: 656e 7369 6f6e 7329 2c20 6264 696d 290a  ensions), bdim).
+0000f360: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f370: 2020 6e65 775f 6264 696d 203d 2062 6469    new_bdim = bdi
+0000f380: 6d20 2b20 7375 6d28 3120 666f 7220 6469  m + sum(1 for di
+0000f390: 6d20 696e 2062 726f 6164 6361 7374 5f64  m in broadcast_d
+0000f3a0: 696d 656e 7369 6f6e 7320 6966 2064 696d  imensions if dim
+0000f3b0: 203c 2062 6469 6d29 0a20 2020 2020 2020   < bdim).       
+0000f3c0: 206e 6577 5f73 6861 7065 203d 206c 6973   new_shape = lis
+0000f3d0: 7428 7368 6170 6529 0a20 2020 2020 2020  t(shape).       
+0000f3e0: 206e 6577 5f73 6861 7065 2e69 6e73 6572   new_shape.inser
+0000f3f0: 7428 6e65 775f 6264 696d 2c20 6178 6973  t(new_bdim, axis
+0000f400: 5f73 697a 6529 0a20 2020 2020 2020 206e  _size).        n
+0000f410: 6577 5f62 726f 6164 6361 7374 5f64 696d  ew_broadcast_dim
+0000f420: 656e 7369 6f6e 7320 3d20 2830 2c29 202b  ensions = (0,) +
+0000f430: 2074 7570 6c65 2864 696d 202b 2031 2069   tuple(dim + 1 i
+0000f440: 6620 6469 6d20 3e3d 2062 6469 6d20 656c  f dim >= bdim el
+0000f450: 7365 2064 696d 2066 6f72 2064 696d 2069  se dim for dim i
+0000f460: 6e20 6272 6f61 6463 6173 745f 6469 6d65  n broadcast_dime
+0000f470: 6e73 696f 6e73 290a 2020 2020 2020 2020  nsions).        
+0000f480: 6966 2062 726f 6164 6361 7374 5f64 696d  if broadcast_dim
+0000f490: 656e 7369 6f6e 7320 3d3d 2028 293a 0a20  ensions == ():. 
+0000f4a0: 2020 2020 2020 2020 2020 206e 6577 5f62             new_b
+0000f4b0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000f4c0: 6f6e 7320 3d20 2829 0a20 2020 2020 2020  ons = ().       
+0000f4d0: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
+0000f4e0: 616c 7565 2870 7269 6d73 2e62 726f 6164  alue(prims.broad
+0000f4f0: 6361 7374 5f69 6e5f 6469 6d28 612e 7661  cast_in_dim(a.va
+0000f500: 6c75 652c 206e 6577 5f73 6861 7065 2c20  lue, new_shape, 
+0000f510: 6e65 775f 6272 6f61 6463 6173 745f 6469  new_broadcast_di
+0000f520: 6d65 6e73 696f 6e73 292c 206e 6577 5f62  mensions), new_b
+0000f530: 6469 6d29 0a0a 0a76 6d61 705f 696d 706c  dim)...vmap_impl
+0000f540: 733a 2064 6963 745b 7072 696d 732e 5379  s: dict[prims.Sy
+0000f550: 6d62 6f6c 2c20 4361 6c6c 6162 6c65 5d20  mbol, Callable] 
+0000f560: 3d20 6469 6374 2829 0a0a 0a64 6566 2075  = dict()...def u
+0000f570: 6e77 7261 705f 6f6e 655f 6c65 7665 6c5f  nwrap_one_level_
+0000f580: 6f66 5f73 7562 7379 6d62 6f6c 7328 7472  of_subsymbols(tr
+0000f590: 6163 6529 3a0a 2020 2020 6e65 775f 7379  ace):.    new_sy
+0000f5a0: 6d62 6f6c 735f 6974 6572 203d 2028 0a20  mbols_iter = (. 
+0000f5b0: 2020 2020 2020 2062 6f75 6e64 5f73 796d         bound_sym
+0000f5c0: 626f 6c2e 7375 6273 796d 626f 6c73 2069  bol.subsymbols i
+0000f5d0: 6620 6c65 6e28 626f 756e 645f 7379 6d62  f len(bound_symb
+0000f5e0: 6f6c 2e73 7562 7379 6d62 6f6c 7329 203e  ol.subsymbols) >
+0000f5f0: 2030 2065 6c73 6520 5b62 6f75 6e64 5f73   0 else [bound_s
+0000f600: 796d 626f 6c5d 0a20 2020 2020 2020 2066  ymbol].        f
+0000f610: 6f72 2062 6f75 6e64 5f73 796d 626f 6c20  or bound_symbol 
+0000f620: 696e 2074 7261 6365 2e62 6f75 6e64 5f73  in trace.bound_s
+0000f630: 796d 626f 6c73 0a20 2020 2029 0a20 2020  ymbols.    ).   
+0000f640: 206e 6577 5f73 796d 626f 6c73 203d 206c   new_symbols = l
+0000f650: 6973 7428 6368 6169 6e2e 6672 6f6d 5f69  ist(chain.from_i
+0000f660: 7465 7261 626c 6528 6e65 775f 7379 6d62  terable(new_symb
+0000f670: 6f6c 735f 6974 6572 2929 0a20 2020 2074  ols_iter)).    t
+0000f680: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0000f690: 6c73 203d 206e 6577 5f73 796d 626f 6c73  ls = new_symbols
+0000f6a0: 0a20 2020 2072 6574 7572 6e20 7472 6163  .    return trac
+0000f6b0: 650a 0a0a 6465 6620 6465 636f 6d70 6f73  e...def decompos
+0000f6c0: 6564 5f66 6e5f 766d 6170 5f72 756c 6528  ed_fn_vmap_rule(
+0000f6d0: 6178 6973 5f73 697a 652c 202a 6172 6773  axis_size, *args
+0000f6e0: 2c20 666e 2c20 2a2a 6b77 6172 6773 293a  , fn, **kwargs):
+0000f6f0: 0a20 2020 2061 7267 732c 2069 6e5f 6469  .    args, in_di
+0000f700: 6d73 203d 2075 6e7a 6970 3228 6172 6773  ms = unzip2(args
+0000f710: 290a 2020 2020 756e 6261 7463 6865 645f  ).    unbatched_
+0000f720: 6172 6773 203d 2074 7265 655f 6d61 7028  args = tree_map(
+0000f730: 6c61 6d62 6461 2078 3a20 7265 6d6f 7665  lambda x: remove
+0000f740: 5f62 6174 6368 5f64 696d 2878 2920 6966  _batch_dim(x) if
+0000f750: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
+0000f760: 656e 736f 7250 726f 7879 2920 656c 7365  ensorProxy) else
+0000f770: 2078 2c20 6172 6773 290a 2020 2020 7472   x, args).    tr
+0000f780: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+0000f790: 7472 6163 6528 2928 666e 2c20 2a75 6e62  trace()(fn, *unb
+0000f7a0: 6174 6368 6564 5f61 7267 732c 202a 2a6b  atched_args, **k
+0000f7b0: 7761 7267 7329 0a20 2020 2074 7261 6365  wargs).    trace
+0000f7c0: 203d 2075 6e77 7261 705f 6f6e 655f 6c65   = unwrap_one_le
+0000f7d0: 7665 6c5f 6f66 5f73 7562 7379 6d62 6f6c  vel_of_subsymbol
+0000f7e0: 7328 7472 6163 6529 0a20 2020 206f 7574  s(trace).    out
+0000f7f0: 7320 3d20 5f76 6d61 705f 6361 6c6c 5f6d  s = _vmap_call_m
+0000f800: 6574 6166 756e 6328 4661 6c73 652c 2061  etafunc(False, a
+0000f810: 7267 732c 2069 6e5f 6469 6d73 2c20 302c  rgs, in_dims, 0,
+0000f820: 2061 7869 735f 7369 7a65 2c20 6675 6e63   axis_size, func
+0000f830: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
+0000f840: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0000f850: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
+0000f860: 7473 2c20 5365 7175 656e 6365 293a 0a20  ts, Sequence):. 
+0000f870: 2020 2020 2020 206f 7574 5f64 696d 7320         out_dims 
+0000f880: 3d20 2830 2c29 202a 206c 656e 286f 7574  = (0,) * len(out
+0000f890: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+0000f8a0: 6e20 7361 6665 5f6d 6170 2870 6169 725f  n safe_map(pair_
+0000f8b0: 746f 5f62 6174 6368 6564 5f76 616c 7565  to_batched_value
+0000f8c0: 2c20 7361 6665 5f7a 6970 286f 7574 732c  , safe_zip(outs,
+0000f8d0: 206f 7574 5f64 696d 7329 290a 2020 2020   out_dims)).    
+0000f8e0: 7265 7475 726e 2042 6174 6368 6564 5661  return BatchedVa
+0000f8f0: 6c75 6528 6f75 7473 2c20 3029 0a0a 0a76  lue(outs, 0)...v
+0000f900: 6d61 705f 696d 706c 735b 7072 696d 732e  map_impls[prims.
+0000f910: 5072 696d 4944 732e 5349 4e5d 203d 2073  PrimIDs.SIN] = s
+0000f920: 696e 5f76 6d61 700a 766d 6170 5f69 6d70  in_vmap.vmap_imp
+0000f930: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+0000f940: 2e43 4f53 5d20 3d20 636f 735f 766d 6170  .COS] = cos_vmap
+0000f950: 0a76 6d61 705f 696d 706c 735b 7072 696d  .vmap_impls[prim
+0000f960: 732e 5072 696d 4944 732e 4d55 4c5d 203d  s.PrimIDs.MUL] =
+0000f970: 206d 756c 5f76 6d61 700a 766d 6170 5f69   mul_vmap.vmap_i
+0000f980: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
+0000f990: 4473 2e41 4444 5d20 3d20 6164 645f 766d  Ds.ADD] = add_vm
+0000f9a0: 6170 0a76 6d61 705f 696d 706c 735b 7072  ap.vmap_impls[pr
+0000f9b0: 696d 732e 5072 696d 4944 732e 5355 4d5d  ims.PrimIDs.SUM]
+0000f9c0: 203d 2073 756d 5f76 6d61 700a 766d 6170   = sum_vmap.vmap
+0000f9d0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+0000f9e0: 6d49 4473 2e42 524f 4144 4341 5354 5f49  mIDs.BROADCAST_I
+0000f9f0: 4e5f 4449 4d5d 203d 2062 726f 6164 6361  N_DIM] = broadca
+0000fa00: 7374 5f69 6e5f 6469 6d5f 766d 6170 0a0a  st_in_dim_vmap..
+0000fa10: 0a64 6566 2076 6d61 705f 7379 6d62 6f6c  .def vmap_symbol
+0000fa20: 5f6d 6170 7065 7228 7379 6d62 6f6c 3a20  _mapper(symbol: 
+0000fa30: 7072 696d 732e 5379 6d62 6f6c 2c20 2a2c  prims.Symbol, *,
+0000fa40: 2061 7869 735f 7369 7a65 3a20 696e 7429   axis_size: int)
+0000fa50: 3a0a 2020 2020 2222 224d 6170 7320 6120  :.    """Maps a 
+0000fa60: 7379 6d62 6f6c 2074 6f20 6120 766d 6170  symbol to a vmap
+0000fa70: 2066 756e 6374 696f 6e20 7468 6174 2065   function that e
+0000fa80: 7661 6c75 6174 6573 2069 742e 0a0a 2020  valuates it...  
+0000fa90: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000faa0: 7379 6d62 6f6c 2028 7072 696d 732e 5379  symbol (prims.Sy
+0000fab0: 6d62 6f6c 293a 2053 796d 626f 6c20 746f  mbol): Symbol to
+0000fac0: 2065 7661 6c75 6174 652e 0a0a 2020 2020   evaluate...    
+0000fad0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+0000fae0: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
+0000faf0: 726f 723a 2049 6620 7468 6520 766d 6170  ror: If the vmap
+0000fb00: 2066 6f72 2074 6865 2073 796d 626f 6c20   for the symbol 
+0000fb10: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+0000fb20: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
+0000fb30: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
+0000fb40: 6c65 3a20 766d 6170 2066 756e 6374 696f  le: vmap functio
+0000fb50: 6e20 7468 6174 2065 7661 6c75 6174 6573  n that evaluates
+0000fb60: 2074 6865 2073 796d 626f 6c2e 0a20 2020   the symbol..   
+0000fb70: 2022 2222 0a0a 2020 2020 6465 6620 7772   """..    def wr
+0000fb80: 6170 5f61 7267 2878 293a 0a20 2020 2020  ap_arg(x):.     
+0000fb90: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000fba0: 2878 2c20 4261 7463 6865 6456 616c 7565  (x, BatchedValue
+0000fbb0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000fbc0: 6574 7572 6e20 780a 2020 2020 2020 2020  eturn x.        
+0000fbd0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0000fbe0: 782c 204e 756d 6265 7229 3a0a 2020 2020  x, Number):.    
+0000fbf0: 2020 2020 2020 2020 7265 7475 726e 2042          return B
+0000fc00: 6174 6368 6564 5661 6c75 6528 782c 206e  atchedValue(x, n
+0000fc10: 6f74 5f6d 6170 7065 6429 0a20 2020 2020  ot_mapped).     
+0000fc20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000fc30: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000fc40: 4572 726f 7228 6622 766d 6170 2077 7261  Error(f"vmap wra
+0000fc50: 705f 6172 6720 676f 7420 616e 2075 6e73  p_arg got an uns
+0000fc60: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
+0000fc70: 7970 6528 7829 7d22 290a 0a20 2020 2069  ype(x)}")..    i
+0000fc80: 6620 7379 6d62 6f6c 2e61 7265 5f61 6c6c  f symbol.are_all
+0000fc90: 5f61 7267 735f 636f 6e73 7461 6e74 3a0a  _args_constant:.
+0000fca0: 0a20 2020 2020 2020 2064 6566 205f 766d  .        def _vm
+0000fcb0: 6170 5f69 6d70 6c5f 636f 6e73 7428 7379  ap_impl_const(sy
+0000fcc0: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
+0000fcd0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0000fce0: 2020 2020 6f75 7420 3d20 7379 6d62 6f6c      out = symbol
+0000fcf0: 5f74 6f5f 6576 616c 2873 796d 626f 6c29  _to_eval(symbol)
+0000fd00: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000fd10: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0000fd20: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+0000fd30: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
+0000fd40: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000fd50: 7572 6e20 7361 6665 5f6d 6170 2870 6169  urn safe_map(pai
+0000fd60: 725f 746f 5f62 6174 6368 6564 5f76 616c  r_to_batched_val
+0000fd70: 7565 2c20 7361 6665 5f7a 6970 2861 7267  ue, safe_zip(arg
+0000fd80: 732c 205b 6e6f 745f 6d61 7070 6564 5d20  s, [not_mapped] 
+0000fd90: 2a20 6c65 6e28 6f75 7429 2929 0a0a 2020  * len(out)))..  
+0000fda0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000fdb0: 2042 6174 6368 6564 5661 6c75 6528 6f75   BatchedValue(ou
+0000fdc0: 742c 206e 6f74 5f6d 6170 7065 6429 0a0a  t, not_mapped)..
+0000fdd0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+0000fde0: 6172 7469 616c 285f 766d 6170 5f69 6d70  artial(_vmap_imp
+0000fdf0: 6c5f 636f 6e73 742c 2073 796d 626f 6c29  l_const, symbol)
+0000fe00: 0a0a 2020 2020 766d 6170 5f69 6d70 6c20  ..    vmap_impl 
+0000fe10: 3d20 766d 6170 5f69 6d70 6c73 2e67 6574  = vmap_impls.get
+0000fe20: 2873 796d 626f 6c2e 7379 6d2e 6964 290a  (symbol.sym.id).
+0000fe30: 2020 2020 6966 2076 6d61 705f 696d 706c      if vmap_impl
+0000fe40: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000fe50: 2020 6966 206c 656e 2873 796d 626f 6c2e    if len(symbol.
+0000fe60: 7375 6273 796d 626f 6c73 2920 3e20 303a  subsymbols) > 0:
+0000fe70: 0a20 2020 2020 2020 2020 2020 2076 6d61  .            vma
+0000fe80: 705f 696d 706c 203d 2070 6172 7469 616c  p_impl = partial
+0000fe90: 2864 6563 6f6d 706f 7365 645f 666e 5f76  (decomposed_fn_v
+0000fea0: 6d61 705f 7275 6c65 2c20 666e 3d73 796d  map_rule, fn=sym
+0000feb0: 626f 6c2e 7379 6d29 0a20 2020 2020 2020  bol.sym).       
+0000fec0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000fed0: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+0000fee0: 656d 656e 7465 6445 7272 6f72 2866 2276  ementedError(f"v
+0000fef0: 6d61 7020 666f 7220 7b73 796d 626f 6c2e  map for {symbol.
+0000ff00: 7379 6d2e 6964 7d20 6973 206e 6f74 2069  sym.id} is not i
+0000ff10: 6d70 6c65 6d65 6e74 6564 2229 0a0a 2020  mplemented")..  
+0000ff20: 2020 6465 6620 5f76 6d61 705f 696d 706c    def _vmap_impl
+0000ff30: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000ff40: 293a 0a20 2020 2020 2020 2061 7267 7320  ):.        args 
+0000ff50: 3d20 7472 6565 5f6d 6170 2877 7261 705f  = tree_map(wrap_
+0000ff60: 6172 672c 2061 7267 7329 0a20 2020 2020  arg, args).     
+0000ff70: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
+0000ff80: 696e 7374 616e 6365 2861 7267 2c20 4261  instance(arg, Ba
+0000ff90: 7463 6865 6456 616c 7565 2920 666f 7220  tchedValue) for 
+0000ffa0: 6172 6720 696e 2074 7265 655f 666c 6174  arg in tree_flat
+0000ffb0: 7465 6e28 6172 6773 295b 305d 290a 2020  ten(args)[0]).  
+0000ffc0: 2020 2020 2020 7265 7475 726e 2076 6d61        return vma
+0000ffd0: 705f 696d 706c 2861 7869 735f 7369 7a65  p_impl(axis_size
+0000ffe0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+0000fff0: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
+00010000: 766d 6170 5f69 6d70 6c0a 0a0a 6465 6620  vmap_impl...def 
+00010010: 7265 6d6f 7665 5f62 6174 6368 5f64 696d  remove_batch_dim
+00010020: 2874 656e 736f 723a 2054 656e 736f 7250  (tensor: TensorP
+00010030: 726f 7879 2c20 6261 7463 685f 6469 6d3a  roxy, batch_dim:
+00010040: 2069 6e74 203d 2030 2920 2d3e 2054 656e   int = 0) -> Ten
+00010050: 736f 7250 726f 7879 3a0a 2020 2020 2222  sorProxy:.    ""
+00010060: 2252 656d 6f76 6573 2074 6865 2062 6174  "Removes the bat
+00010070: 6368 2064 696d 656e 7369 6f6e 2066 726f  ch dimension fro
+00010080: 6d20 6120 7465 6e73 6f72 2e0a 0a20 2020  m a tensor...   
+00010090: 2041 7267 733a 0a20 2020 2020 2020 2074   Args:.        t
+000100a0: 656e 736f 7220 2854 656e 736f 7250 726f  ensor (TensorPro
+000100b0: 7879 293a 2054 656e 736f 7220 746f 2072  xy): Tensor to r
+000100c0: 656d 6f76 6520 7468 6520 6261 7463 6820  emove the batch 
+000100d0: 6469 6d65 6e73 696f 6e20 6672 6f6d 2e0a  dimension from..
+000100e0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+000100f0: 2020 2020 2020 5465 6e73 6f72 5072 6f78        TensorProx
+00010100: 793a 2054 656e 736f 7220 7769 7468 2074  y: Tensor with t
+00010110: 6865 2062 6174 6368 2064 696d 656e 7369  he batch dimensi
+00010120: 6f6e 2072 656d 6f76 6564 2e0a 2020 2020  on removed..    
+00010130: 2222 220a 2020 2020 6e65 775f 7368 6170  """.    new_shap
+00010140: 6520 3d20 7465 6e73 6f72 2e73 6861 7065  e = tensor.shape
+00010150: 5b3a 6261 7463 685f 6469 6d5d 202b 2074  [:batch_dim] + t
+00010160: 656e 736f 722e 7368 6170 655b 6261 7463  ensor.shape[batc
+00010170: 685f 6469 6d20 2b20 3120 3a5d 0a20 2020  h_dim + 1 :].   
+00010180: 2072 6574 7572 6e20 5465 6e73 6f72 5072   return TensorPr
+00010190: 6f78 7928 6c69 6b65 3d74 656e 736f 722c  oxy(like=tensor,
+000101a0: 2073 6861 7065 3d6e 6577 5f73 6861 7065   shape=new_shape
+000101b0: 290a 0a0a 2320 544f 444f 3a20 696e 204a  )...# TODO: in J
+000101c0: 4158 2061 7267 732c 2069 6e5f 6469 6d73  AX args, in_dims
+000101d0: 2061 7265 2066 6c61 7474 656e 6564 2074   are flattened t
+000101e0: 6865 2073 616d 6520 7761 790a 2320 544f  he same way.# TO
+000101f0: 444f 3a20 696e 204a 4158 206f 7574 5f64  DO: in JAX out_d
+00010200: 696d 7320 6172 6520 666c 6174 7465 6e65  ims are flattene
+00010210: 6420 6173 2077 656c 6c0a 6465 6620 5f76  d as well.def _v
+00010220: 6d61 705f 6361 6c6c 5f6d 6574 6166 756e  map_call_metafun
+00010230: 6328 6465 7461 6368 6564 3a20 626f 6f6c  c(detached: bool
+00010240: 2c20 6172 6773 2c20 696e 5f64 696d 732c  , args, in_dims,
+00010250: 206f 7574 5f64 696d 732c 2061 7869 735f   out_dims, axis_
+00010260: 7369 7a65 2c20 6675 6e63 7469 6f6e 5f74  size, function_t
+00010270: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
+00010280: 7761 7267 7329 3a0a 2020 2020 2222 224d  wargs):.    """M
+00010290: 6574 6166 756e 6374 696f 6e20 666f 7220  etafunction for 
+000102a0: 766d 6170 2063 616c 6c2e 0a0a 2020 2020  vmap call...    
+000102b0: 4172 6773 3a0a 2020 2020 2020 2020 6465  Args:.        de
+000102c0: 7461 6368 6564 2028 626f 6f6c 293a 2057  tached (bool): W
+000102d0: 6865 7468 6572 2074 6f20 6465 7461 6368  hether to detach
+000102e0: 2074 6865 2074 7261 6365 2e0a 2020 2020   the trace..    
+000102f0: 2020 2020 6172 6773 2028 5475 706c 655b      args (Tuple[
+00010300: 5072 6f78 795d 293a 2041 7267 756d 656e  Proxy]): Argumen
+00010310: 7473 2074 6f20 7468 6520 6675 6e63 7469  ts to the functi
+00010320: 6f6e 2e0a 2020 2020 2020 2020 696e 5f64  on..        in_d
+00010330: 696d 7320 2854 7570 6c65 5b69 6e74 5d29  ims (Tuple[int])
+00010340: 3a20 4261 7463 6820 6469 6d65 6e73 696f  : Batch dimensio
+00010350: 6e20 666f 7220 6561 6368 2061 7267 756d  n for each argum
+00010360: 656e 742e 0a20 2020 2020 2020 206f 7574  ent..        out
+00010370: 5f64 696d 7320 2854 7570 6c65 5b69 6e74  _dims (Tuple[int
+00010380: 5d29 3a20 4261 7463 6820 6469 6d65 6e73  ]): Batch dimens
+00010390: 696f 6e20 666f 7220 7265 7475 726e 2076  ion for return v
+000103a0: 616c 7565 732e 0a20 2020 2020 2020 2066  alues..        f
+000103b0: 756e 6374 696f 6e5f 7472 6163 6520 2854  unction_trace (T
+000103c0: 7261 6365 293a 2054 7261 6365 2074 6f20  race): Trace to 
+000103d0: 7573 6520 666f 7220 7468 6520 6675 6e63  use for the func
+000103e0: 7469 6f6e 2e0a 2020 2020 2020 2020 6b77  tion..        kw
+000103f0: 6172 6773 3a20 4b65 7977 6f72 6420 6172  args: Keyword ar
+00010400: 6775 6d65 6e74 732e 0a0a 2020 2020 5261  guments...    Ra
+00010410: 6973 6573 3a0a 2020 2020 2020 2020 4173  ises:.        As
+00010420: 7365 7274 696f 6e45 7272 6f72 3a20 4966  sertionError: If
+00010430: 2074 6865 2076 6d61 7020 666f 7220 6b65   the vmap for ke
+00010440: 7977 6f72 6420 6172 6775 6d65 6e74 7320  yword arguments 
+00010450: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+00010460: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
+00010470: 3a0a 2020 2020 2020 2020 5265 7375 6c74  :.        Result
+00010480: 206f 6620 7468 6520 766d 6170 2074 7261   of the vmap tra
+00010490: 6e73 666f 726d 2e0a 2020 2020 2222 220a  nsform..    """.
+000104a0: 2020 2020 636f 6d6d 6f6e 5f64 6576 6963      common_devic
+000104b0: 6520 3d20 7b78 2e64 6576 6963 6520 666f  e = {x.device fo
+000104c0: 7220 7820 696e 2061 7267 7320 6966 2069  r x in args if i
+000104d0: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
+000104e0: 736f 7250 726f 7879 297d 0a20 2020 2061  sorProxy)}.    a
+000104f0: 7373 6572 7420 6c65 6e28 636f 6d6d 6f6e  ssert len(common
+00010500: 5f64 6576 6963 6529 203c 3d20 312c 2022  _device) <= 1, "
+00010510: 766d 6170 2066 6f72 206d 756c 7469 706c  vmap for multipl
+00010520: 6520 6465 7669 6365 7320 6973 206e 6f74  e devices is not
+00010530: 2069 6d70 6c65 6d65 6e74 6564 220a 2020   implemented".  
+00010540: 2020 2863 6f6d 6d6f 6e5f 6465 7669 6365    (common_device
+00010550: 2c29 203d 2063 6f6d 6d6f 6e5f 6465 7669  ,) = common_devi
+00010560: 6365 2069 6620 6c65 6e28 636f 6d6d 6f6e  ce if len(common
+00010570: 5f64 6576 6963 6529 203d 3d20 3120 656c  _device) == 1 el
+00010580: 7365 2028 6370 752c 290a 0a20 2020 2069  se (cpu,)..    i
+00010590: 6620 6178 6973 5f73 697a 6520 6973 204e  f axis_size is N
+000105a0: 6f6e 653a 0a20 2020 2020 2020 2028 6178  one:.        (ax
+000105b0: 6973 5f73 697a 652c 2920 3d20 7b78 2e73  is_size,) = {x.s
+000105c0: 6861 7065 5b61 785d 2066 6f72 2078 2c20  hape[ax] for x, 
+000105d0: 6178 2069 6e20 7a69 7028 6172 6773 2c20  ax in zip(args, 
+000105e0: 696e 5f64 696d 7329 2069 6620 6178 2069  in_dims) if ax i
+000105f0: 7320 6e6f 7420 6e6f 745f 6d61 7070 6564  s not not_mapped
+00010600: 7d0a 2020 2020 696e 5f64 696d 7320 3d20  }.    in_dims = 
+00010610: 696e 5f64 696d 7320 6966 2069 7369 6e73  in_dims if isins
+00010620: 7461 6e63 6528 696e 5f64 696d 732c 2053  tance(in_dims, S
+00010630: 6571 7565 6e63 6529 2065 6c73 6520 2869  equence) else (i
+00010640: 6e5f 6469 6d73 2c29 0a20 2020 2069 6e5f  n_dims,).    in_
+00010650: 6469 6d73 203d 2074 7570 6c65 286e 6f74  dims = tuple(not
+00010660: 5f6d 6170 7065 6420 6966 2069 7369 6e73  _mapped if isins
+00010670: 7461 6e63 6528 612c 204e 756d 6265 7229  tance(a, Number)
+00010680: 2065 6c73 6520 6420 666f 7220 612c 2064   else d for a, d
+00010690: 2069 6e20 7361 6665 5f7a 6970 2861 7267   in safe_zip(arg
+000106a0: 732c 2069 6e5f 6469 6d73 2929 0a20 2020  s, in_dims)).   
+000106b0: 206f 7574 5f64 696d 7320 3d20 6f75 745f   out_dims = out_
+000106c0: 6469 6d73 2069 6620 6973 696e 7374 616e  dims if isinstan
+000106d0: 6365 286f 7574 5f64 696d 732c 2053 6571  ce(out_dims, Seq
+000106e0: 7565 6e63 6529 2065 6c73 6520 286f 7574  uence) else (out
+000106f0: 5f64 696d 732c 290a 0a20 2020 2063 7478  _dims,)..    ctx
+00010700: 203d 2064 6574 6163 6865 645f 7472 6163   = detached_trac
+00010710: 6528 2920 6966 2064 6574 6163 6865 6420  e() if detached 
+00010720: 656c 7365 206e 756c 6c63 6f6e 7465 7874  else nullcontext
+00010730: 2829 0a20 2020 2077 6974 6820 6374 783a  ().    with ctx:
+00010740: 0a20 2020 2020 2020 2023 2057 6520 7072  .        # We pr
+00010750: 6f70 6167 6174 6520 7468 6520 4261 7463  opagate the Batc
+00010760: 6856 616c 7565 2074 6872 6f75 6768 2074  hValue through t
+00010770: 6865 2074 7261 6365 2c20 616e 6420 7468  he trace, and th
+00010780: 656e 2075 6e77 7261 7020 6974 2061 7420  en unwrap it at 
+00010790: 7468 6520 656e 640a 2020 2020 2020 2020  the end.        
+000107a0: 6261 7463 6865 645f 6172 6773 203d 2073  batched_args = s
+000107b0: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+000107c0: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
+000107d0: 6166 655f 7a69 7028 6172 6773 2c20 696e  afe_zip(args, in
+000107e0: 5f64 696d 7329 290a 2020 2020 2020 2020  _dims)).        
+000107f0: 7265 7375 6c74 203d 2065 7661 6c5f 7472  result = eval_tr
+00010800: 6163 6528 0a20 2020 2020 2020 2020 2020  ace(.           
+00010810: 2066 756e 6374 696f 6e5f 7472 6163 652c   function_trace,
+00010820: 202a 6261 7463 6865 645f 6172 6773 2c20   *batched_args, 
+00010830: 7379 6d62 6f6c 5f6d 6170 7065 723d 7061  symbol_mapper=pa
+00010840: 7274 6961 6c28 766d 6170 5f73 796d 626f  rtial(vmap_symbo
+00010850: 6c5f 6d61 7070 6572 2c20 6178 6973 5f73  l_mapper, axis_s
+00010860: 697a 653d 6178 6973 5f73 697a 6529 2c20  ize=axis_size), 
+00010870: 2a2a 6b77 6172 6773 0a20 2020 2020 2020  **kwargs.       
+00010880: 2029 0a20 2020 2020 2020 2023 2055 6e77   ).        # Unw
+00010890: 7261 7070 696e 6720 7468 6520 4261 7463  rapping the Batc
+000108a0: 6865 6456 616c 7565 2773 0a20 2020 2020  hedValue's.     
+000108b0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000108c0: 2872 6573 756c 742c 2053 6571 7565 6e63  (result, Sequenc
+000108d0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+000108e0: 666c 6174 5f72 6573 756c 742c 2073 7065  flat_result, spe
+000108f0: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
+00010900: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
+00010910: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+00010920: 6973 696e 7374 616e 6365 2878 2c20 4261  isinstance(x, Ba
+00010930: 7463 6865 6456 616c 7565 2920 666f 7220  tchedValue) for 
+00010940: 7820 696e 2066 6c61 745f 7265 7375 6c74  x in flat_result
+00010950: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
+00010960: 7473 2c20 6264 696d 7320 3d20 756e 7a69  ts, bdims = unzi
+00010970: 7032 2866 6c61 745f 7265 7375 6c74 290a  p2(flat_result).
+00010980: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+00010990: 444f 3a20 6861 6e64 6c65 2074 6865 2063  DO: handle the c
+000109a0: 6173 6520 7768 6572 6520 6f75 745f 6469  ase where out_di
+000109b0: 6d73 2069 7320 6120 7369 6e67 6c65 2076  ms is a single v
+000109c0: 616c 7565 2062 6574 7465 720a 2020 2020  alue better.    
+000109d0: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
+000109e0: 7574 5f64 696d 7329 203d 3d20 313a 0a20  ut_dims) == 1:. 
+000109f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00010a00: 7574 5f64 696d 7320 3d20 6f75 745f 6469  ut_dims = out_di
+00010a10: 6d73 202a 206c 656e 286f 7574 7329 0a20  ms * len(outs). 
+00010a20: 2020 2020 2020 2020 2020 206f 7574 7320             outs 
+00010a30: 3d20 7361 6665 5f6d 6170 2870 6172 7469  = safe_map(parti
+00010a40: 616c 286d 6f76 655f 6261 7463 685f 6469  al(move_batch_di
+00010a50: 6d2c 2061 7869 735f 7369 7a65 292c 2062  m, axis_size), b
+00010a60: 6469 6d73 2c20 6f75 745f 6469 6d73 2c20  dims, out_dims, 
+00010a70: 6f75 7473 290a 2020 2020 2020 2020 2020  outs).          
+00010a80: 2020 7265 7475 726e 2074 7265 655f 756e    return tree_un
+00010a90: 666c 6174 7465 6e28 6f75 7473 2c20 7370  flatten(outs, sp
+00010aa0: 6563 290a 2020 2020 2020 2020 6966 2069  ec).        if i
+00010ab0: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+00010ac0: 2c20 4e75 6d62 6572 2920 616e 6420 6178  , Number) and ax
+00010ad0: 6973 5f73 697a 6520 6973 206e 6f74 204e  is_size is not N
+00010ae0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00010af0: 2023 2054 4f44 4f3a 2066 6574 6368 2074   # TODO: fetch t
+00010b00: 6865 2064 6566 6175 6c74 2064 6576 6963  he default devic
+00010b10: 6520 6672 6f6d 2074 6865 2063 6f6e 7465  e from the conte
+00010b20: 7874 0a20 2020 2020 2020 2020 2020 2072  xt.            r
+00010b30: 6573 756c 7420 3d20 6675 6c6c 2873 6861  esult = full(sha
+00010b40: 7065 3d28 292c 2066 696c 6c5f 7661 6c75  pe=(), fill_valu
+00010b50: 653d 7265 7375 6c74 2c20 6465 7669 6365  e=result, device
+00010b60: 3d63 6f6d 6d6f 6e5f 6465 7669 6365 290a  =common_device).
+00010b70: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00010b80: 6c74 203d 2042 6174 6368 6564 5661 6c75  lt = BatchedValu
+00010b90: 6528 7265 7375 6c74 2c20 6e6f 745f 6d61  e(result, not_ma
+00010ba0: 7070 6564 290a 2020 2020 2020 2020 656c  pped).        el
+00010bb0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00010bc0: 7375 6c74 2c20 4261 7463 6865 6456 616c  sult, BatchedVal
+00010bd0: 7565 2920 616e 6420 6973 696e 7374 616e  ue) and isinstan
+00010be0: 6365 2872 6573 756c 742e 7661 6c75 652c  ce(result.value,
+00010bf0: 204e 756d 6265 7229 2061 6e64 2061 7869   Number) and axi
+00010c00: 735f 7369 7a65 2069 7320 6e6f 7420 4e6f  s_size is not No
+00010c10: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010c20: 7265 7375 6c74 203d 2042 6174 6368 6564  result = Batched
+00010c30: 5661 6c75 6528 6675 6c6c 2873 6861 7065  Value(full(shape
+00010c40: 3d28 292c 2066 696c 6c5f 7661 6c75 653d  =(), fill_value=
+00010c50: 7265 7375 6c74 2e76 616c 7565 2c20 6465  result.value, de
+00010c60: 7669 6365 3d63 6f6d 6d6f 6e5f 6465 7669  vice=common_devi
+00010c70: 6365 292c 2072 6573 756c 742e 6261 7463  ce), result.batc
+00010c80: 685f 6469 6d29 0a20 2020 2020 2020 2061  h_dim).        a
+00010c90: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00010ca0: 2872 6573 756c 742c 2042 6174 6368 6564  (result, Batched
+00010cb0: 5661 6c75 6529 0a20 2020 2020 2020 206f  Value).        o
+00010cc0: 7574 203d 206d 6f76 655f 6261 7463 685f  ut = move_batch_
+00010cd0: 6469 6d28 6178 6973 5f73 697a 652c 2072  dim(axis_size, r
+00010ce0: 6573 756c 742e 6261 7463 685f 6469 6d2c  esult.batch_dim,
+00010cf0: 206f 7574 5f64 696d 735b 305d 2c20 7265   out_dims[0], re
+00010d00: 7375 6c74 2e76 616c 7565 290a 2020 2020  sult.value).    
+00010d10: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
+00010d20: 0a76 6d61 705f 6361 6c6c 203d 2053 796d  .vmap_call = Sym
+00010d30: 626f 6c28 6964 3d54 7261 6e73 666f 726d  bol(id=Transform
+00010d40: 732e 566d 6170 4f70 2c20 6e61 6d65 3d22  s.VmapOp, name="
+00010d50: 766d 6170 5f63 616c 6c22 2c20 6d65 7461  vmap_call", meta
+00010d60: 3d70 6172 7469 616c 285f 766d 6170 5f63  =partial(_vmap_c
+00010d70: 616c 6c5f 6d65 7461 6675 6e63 2c20 4661  all_metafunc, Fa
+00010d80: 6c73 6529 290a 0a0a 2320 544f 444f 3a20  lse))...# TODO: 
+00010d90: 686f 7720 7368 6f75 6c64 2077 6520 6861  how should we ha
+00010da0: 6e64 6c65 206f 7574 5f64 696d 7320 6865  ndle out_dims he
+00010db0: 7265 3f0a 2320 616c 7468 6f75 6768 2068  re?.# although h
+00010dc0: 6572 6520 7765 2061 7265 2063 616c 6c69  ere we are calli
+00010dd0: 6e67 2076 6d61 7020 6f66 2069 6465 6e74  ng vmap of ident
+00010de0: 6974 792c 2073 6f20 7765 2073 686f 756c  ity, so we shoul
+00010df0: 6420 6b6e 6f77 2066 726f 6d20 7468 6520  d know from the 
+00010e00: 6361 6c6c 2074 6f20 766d 6170 0a23 2054  call to vmap.# T
+00010e10: 6869 7320 7368 6f75 6c64 2062 6520 6669  his should be fi
+00010e20: 6e65 2e20 4966 2077 6520 6861 7665 2076  ne. If we have v
+00010e30: 6d61 7028 6964 656e 7469 7479 2866 756e  map(identity(fun
+00010e40: 6329 2c20 6f75 745f 6469 6d73 3d4e 2920  c), out_dims=N) 
+00010e50: 7468 656e 2074 6869 7320 7275 6c65 2069  then this rule i
+00010e60: 7320 6669 7273 7420 7573 6564 0a23 2074  s first used.# t
+00010e70: 6f20 6765 7420 7468 6520 766d 6170 7065  o get the vmappe
+00010e80: 6420 7265 7375 6c74 206f 6620 6964 656e  d result of iden
+00010e90: 7469 7479 2866 756e 6329 2069 6e20 766d  tity(func) in vm
+00010ea0: 6170 5f73 796d 626f 6c5f 6d61 7070 6572  ap_symbol_mapper
+00010eb0: 2c20 616e 6420 6f75 745f 6469 6d73 2069  , and out_dims i
+00010ec0: 7320 6861 6e64 6c65 640a 2320 6166 7465  s handled.# afte
+00010ed0: 7220 7468 6174 2069 6e20 7468 6520 6f75  r that in the ou
+00010ee0: 7465 7220 5f76 6d61 705f 6361 6c6c 5f6d  ter _vmap_call_m
+00010ef0: 6574 6166 756e 632e 0a64 6566 205f 6964  etafunc..def _id
+00010f00: 656e 7469 7479 5f63 616c 6c5f 766d 6170  entity_call_vmap
+00010f10: 2861 7869 735f 7369 7a65 2c20 2a62 6174  (axis_size, *bat
+00010f20: 6368 6564 5f61 7267 732c 2074 7261 6365  ched_args, trace
+00010f30: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+00010f40: 7329 3a0a 2020 2020 6172 6773 2c20 696e  s):.    args, in
+00010f50: 5f64 696d 7320 3d20 756e 7a69 7032 2862  _dims = unzip2(b
+00010f60: 6174 6368 6564 5f61 7267 7329 0a20 2020  atched_args).   
+00010f70: 206f 7574 5f64 696d 7320 3d20 3020 2023   out_dims = 0  #
+00010f80: 2046 6978 6d65 0a20 2020 206f 7574 732c   Fixme.    outs,
+00010f90: 206f 7574 5f64 696d 7320 3d20 5f76 6d61   out_dims = _vma
+00010fa0: 705f 6361 6c6c 5f6d 6574 6166 756e 6328  p_call_metafunc(
+00010fb0: 4661 6c73 652c 2061 7267 732c 2069 6e5f  False, args, in_
+00010fc0: 6469 6d73 2c20 6f75 745f 6469 6d73 2c20  dims, out_dims, 
+00010fd0: 6178 6973 5f73 697a 652c 2066 756e 6374  axis_size, funct
+00010fe0: 696f 6e5f 7472 6163 653d 7472 6163 652c  ion_trace=trace,
+00010ff0: 202a 2a6b 7761 7267 7329 0a20 2020 2069   **kwargs).    i
+00011000: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+00011010: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+00011020: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
+00011030: 655f 6d61 7028 7061 6972 5f74 6f5f 6261  e_map(pair_to_ba
+00011040: 7463 6865 645f 7661 6c75 652c 2073 6166  tched_value, saf
+00011050: 655f 7a69 7028 6f75 7473 2c20 6f75 745f  e_zip(outs, out_
+00011060: 6469 6d73 2929 0a20 2020 2072 6574 7572  dims)).    retur
+00011070: 6e20 4261 7463 6865 6456 616c 7565 286f  n BatchedValue(o
+00011080: 7574 732c 206f 7574 5f64 696d 7329 0a0a  uts, out_dims)..
+00011090: 0a76 6d61 705f 696d 706c 735b 5472 616e  .vmap_impls[Tran
+000110a0: 7366 6f72 6d73 2e49 6465 6e74 6974 794f  sforms.IdentityO
+000110b0: 705d 203d 205f 6964 656e 7469 7479 5f63  p] = _identity_c
+000110c0: 616c 6c5f 766d 6170 0a0a 0a64 6566 205f  all_vmap...def _
+000110d0: 6a76 705f 6361 6c6c 5f76 6d61 7028 6178  jvp_call_vmap(ax
+000110e0: 6973 5f73 697a 652c 2062 6174 6368 6564  is_size, batched
+000110f0: 5f70 7269 6d61 6c73 2c20 6261 7463 6865  _primals, batche
+00011100: 645f 7461 6e67 656e 7473 2c20 2a2c 2066  d_tangents, *, f
+00011110: 756e 6374 696f 6e5f 7472 6163 653a 2054  unction_trace: T
+00011120: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
+00011130: 0a20 2020 2070 7269 6d61 6c73 2c20 7072  .    primals, pr
+00011140: 696d 616c 735f 6264 696d 7320 3d20 7361  imals_bdims = sa
+00011150: 6665 5f7a 6970 282a 6261 7463 6865 645f  fe_zip(*batched_
+00011160: 7072 696d 616c 7329 0a20 2020 2074 616e  primals).    tan
+00011170: 6765 6e74 732c 2074 616e 6765 6e74 735f  gents, tangents_
+00011180: 6264 696d 7320 3d20 7361 6665 5f7a 6970  bdims = safe_zip
+00011190: 282a 6261 7463 6865 645f 7461 6e67 656e  (*batched_tangen
+000111a0: 7473 290a 2020 2020 6a76 705f 6675 6e63  ts).    jvp_func
+000111b0: 203d 2070 6172 7469 616c 285f 6a76 705f   = partial(_jvp_
+000111c0: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
+000111d0: 616c 7365 2c20 6675 6e63 7469 6f6e 5f74  alse, function_t
+000111e0: 7261 6365 3d66 756e 6374 696f 6e5f 7472  race=function_tr
+000111f0: 6163 6529 0a20 2020 2076 6d61 7070 6564  ace).    vmapped
+00011200: 5f6a 7670 5f66 756e 6320 3d20 766d 6170  _jvp_func = vmap
+00011210: 286a 7670 5f66 756e 632c 2069 6e5f 6469  (jvp_func, in_di
+00011220: 6d73 3d28 7072 696d 616c 735f 6264 696d  ms=(primals_bdim
+00011230: 732c 2074 616e 6765 6e74 735f 6264 696d  s, tangents_bdim
+00011240: 7329 2c20 6178 6973 5f73 697a 653d 6178  s), axis_size=ax
+00011250: 6973 5f73 697a 6529 0a20 2020 2072 6573  is_size).    res
+00011260: 756c 7420 3d20 766d 6170 7065 645f 6a76  ult = vmapped_jv
+00011270: 705f 6675 6e63 2870 7269 6d61 6c73 2c20  p_func(primals, 
+00011280: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
+00011290: 6773 290a 2020 2020 7265 7475 726e 2074  gs).    return t
+000112a0: 7265 655f 6d61 7028 6c61 6d62 6461 2078  ree_map(lambda x
+000112b0: 3a20 4261 7463 6865 6456 616c 7565 2878  : BatchedValue(x
+000112c0: 2c20 3029 2c20 7265 7375 6c74 290a 0a0a  , 0), result)...
+000112d0: 766d 6170 5f69 6d70 6c73 5b54 7261 6e73  vmap_impls[Trans
+000112e0: 666f 726d 732e 4a76 704f 705d 203d 205f  forms.JvpOp] = _
+000112f0: 6a76 705f 6361 6c6c 5f76 6d61 700a 0a0a  jvp_call_vmap...
+00011300: 6465 6620 766d 6170 2866 756e 632c 2069  def vmap(func, i
+00011310: 6e5f 6469 6d73 3d30 2c20 6f75 745f 6469  n_dims=0, out_di
+00011320: 6d73 3d30 2c20 6178 6973 5f73 697a 653d  ms=0, axis_size=
+00011330: 4e6f 6e65 293a 0a20 2020 2022 2222 5665  None):.    """Ve
+00011340: 6374 6f72 697a 696e 6720 7472 616e 7366  ctorizing transf
+00011350: 6f72 6d20 666f 7220 6120 5468 756e 6465  orm for a Thunde
+00011360: 7220 6675 6e63 7469 6f6e 2e0a 0a20 2020  r function...   
+00011370: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
+00011380: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
+00011390: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
+000113a0: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
+000113b0: 726d 6564 2e0a 0a20 2020 2052 6574 7572  rmed...    Retur
+000113c0: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+000113d0: 6162 6c65 3a20 4120 766d 6170 7065 6420  able: A vmapped 
+000113e0: 7665 7273 696f 6e20 6f66 2074 6865 2066  version of the f
+000113f0: 756e 6374 696f 6e2e 0a20 2020 2022 2222  unction..    """
+00011400: 0a0a 2020 2020 2320 544f 444f 3a20 666c  ..    # TODO: fl
+00011410: 6174 7465 6e0a 2020 2020 2320 496e 204a  atten.    # In J
+00011420: 4158 2066 6c61 7474 656e 696e 6720 6f66  AX flattening of
+00011430: 2069 6e5f 6469 6d73 2069 7320 7261 7468   in_dims is rath
+00011440: 6572 2063 6f6d 706c 6963 6174 6564 2062  er complicated b
+00011450: 6563 6175 7365 2069 7420 6361 6e20 6f70  ecause it can op
+00011460: 7469 6f6e 616c 6c79 2062 650a 2020 2020  tionally be.    
+00011470: 2320 7370 6563 6966 6965 6420 6173 2061  # specified as a
+00011480: 20e2 809c 7072 6566 6978 e280 9d20 7079   ...prefix... py
+00011490: 7472 6565 2c20 6d65 616e 696e 6720 7468  tree, meaning th
+000114a0: 6174 2061 2073 696e 676c 6520 6c65 6166  at a single leaf
+000114b0: 2076 616c 7565 2063 616e 2062 6520 6170   value can be ap
+000114c0: 706c 6965 640a 2020 2020 2320 746f 2061  plied.    # to a
+000114d0: 6e20 656e 7469 7265 2073 7562 2d70 7974  n entire sub-pyt
+000114e0: 7265 652e 0a0a 2020 2020 6465 6620 666c  ree...    def fl
+000114f0: 6174 7465 6e5f 6675 6e63 5f66 6f72 5f76  atten_func_for_v
+00011500: 6d61 7028 6675 6e63 2c20 6172 6773 2c20  map(func, args, 
+00011510: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00011520: 2066 6c61 745f 6172 6773 2c20 7370 6563   flat_args, spec
+00011530: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+00011540: 2861 7267 732c 206b 7761 7267 7329 290a  (args, kwargs)).
+00011550: 0a20 2020 2020 2020 2064 6566 2066 6c61  .        def fla
+00011560: 745f 6675 6e63 282a 666c 6174 5f61 7267  t_func(*flat_arg
+00011570: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00011580: 666e 5f61 7267 732c 2066 6e5f 6b77 6172  fn_args, fn_kwar
+00011590: 6773 203d 2074 7265 655f 756e 666c 6174  gs = tree_unflat
+000115a0: 7465 6e28 666c 6174 5f61 7267 732c 2073  ten(flat_args, s
+000115b0: 7065 6329 0a20 2020 2020 2020 2020 2020  pec).           
+000115c0: 2072 6574 7572 6e20 6675 6e63 282a 666e   return func(*fn
+000115d0: 5f61 7267 732c 202a 2a66 6e5f 6b77 6172  _args, **fn_kwar
+000115e0: 6773 290a 0a20 2020 2020 2020 2072 6574  gs)..        ret
+000115f0: 7572 6e20 666c 6174 5f66 756e 632c 2066  urn flat_func, f
+00011600: 6c61 745f 6172 6773 2c20 7370 6563 0a0a  lat_args, spec..
+00011610: 2020 2020 6465 6620 7772 6170 7065 7228      def wrapper(
+00011620: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00011630: 3a0a 2020 2020 2020 2020 6675 6e63 5f66  :.        func_f
+00011640: 6c61 742c 2061 7267 735f 666c 6174 2c20  lat, args_flat, 
+00011650: 6172 6773 5f73 7065 6320 3d20 666c 6174  args_spec = flat
+00011660: 7465 6e5f 6675 6e63 5f66 6f72 5f76 6d61  ten_func_for_vma
+00011670: 7028 6675 6e63 2c20 6172 6773 2c20 6b77  p(func, args, kw
+00011680: 6172 6773 290a 2020 2020 2020 2020 6966  args).        if
+00011690: 2069 7369 6e73 7461 6e63 6528 696e 5f64   isinstance(in_d
+000116a0: 696d 732c 2069 6e74 293a 0a20 2020 2020  ims, int):.     
+000116b0: 2020 2020 2020 2069 6e5f 6469 6d73 5f66         in_dims_f
+000116c0: 6c61 7420 3d20 2869 6e5f 6469 6d73 2c29  lat = (in_dims,)
+000116d0: 202a 206c 656e 2861 7267 735f 666c 6174   * len(args_flat
+000116e0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+000116f0: 2020 2020 2020 2020 2020 2020 696e 5f64              in_d
+00011700: 696d 735f 666c 6174 2c20 696e 5f64 696d  ims_flat, in_dim
+00011710: 735f 7370 6563 203d 2074 7265 655f 666c  s_spec = tree_fl
+00011720: 6174 7465 6e28 696e 5f64 696d 7329 0a20  atten(in_dims). 
+00011730: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00011740: 7420 6c65 6e28 696e 5f64 696d 735f 666c  t len(in_dims_fl
+00011750: 6174 2920 3d3d 206c 656e 2861 7267 735f  at) == len(args_
+00011760: 666c 6174 292c 2022 696e 5f64 696d 7320  flat), "in_dims 
+00011770: 6d75 7374 2068 6176 6520 7468 6520 7361  must have the sa
+00011780: 6d65 206c 656e 6774 6820 6173 2061 7267  me length as arg
+00011790: 732c 206b 7761 7267 7322 0a20 2020 2020  s, kwargs".     
+000117a0: 2020 2075 6e62 6174 6368 6564 5f61 7267     unbatched_arg
+000117b0: 735f 666c 6174 203d 205b 7265 6d6f 7665  s_flat = [remove
+000117c0: 5f62 6174 6368 5f64 696d 2861 7267 2920  _batch_dim(arg) 
+000117d0: 6966 2069 7369 6e73 7461 6e63 6528 6172  if isinstance(ar
+000117e0: 672c 2054 656e 736f 7250 726f 7879 2920  g, TensorProxy) 
+000117f0: 656c 7365 2061 7267 2066 6f72 2061 7267  else arg for arg
+00011800: 2069 6e20 6172 6773 5f66 6c61 745d 0a20   in args_flat]. 
+00011810: 2020 2020 2020 2074 7261 6365 203d 2063         trace = c
+00011820: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+00011830: 2866 756e 635f 666c 6174 2c20 2a75 6e62  (func_flat, *unb
+00011840: 6174 6368 6564 5f61 7267 735f 666c 6174  atched_args_flat
+00011850: 290a 2020 2020 2020 2020 6f75 7473 203d  ).        outs =
+00011860: 2076 6d61 705f 6361 6c6c 2861 7267 735f   vmap_call(args_
+00011870: 666c 6174 2c20 696e 5f64 696d 735f 666c  flat, in_dims_fl
+00011880: 6174 2c20 6f75 745f 6469 6d73 2c20 6178  at, out_dims, ax
+00011890: 6973 5f73 697a 653d 6178 6973 5f73 697a  is_size=axis_siz
+000118a0: 652c 2066 756e 6374 696f 6e5f 7472 6163  e, function_trac
+000118b0: 653d 7472 6163 6529 0a20 2020 2020 2020  e=trace).       
+000118c0: 2072 6574 7572 6e20 6f75 7473 0a0a 2020   return outs..  
+000118d0: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
+000118e0: 0a0a 0a23 2054 4f44 4f20 5468 6973 2066  ...# TODO This f
+000118f0: 756e 6374 696f 6e20 636f 6d6d 656e 7465  unction commente
+00011900: 6420 6f75 7420 6265 6361 7573 6520 6974  d out because it
+00011910: 2063 616c 6c73 206d 616b 655f 7472 6163   calls make_trac
+00011920: 6564 2c20 7768 6963 6820 646f 6573 206e  ed, which does n
+00011930: 6f74 2065 7869 7374 0a23 2064 6566 2076  ot exist.# def v
+00011940: 6d61 705f 6561 6765 7228 6675 6e63 2c20  map_eager(func, 
+00011950: 6172 6773 2c20 696e 5f64 696d 733d 302c  args, in_dims=0,
+00011960: 206f 7574 5f64 696d 733d 302c 2061 7869   out_dims=0, axi
+00011970: 735f 7369 7a65 3d4e 6f6e 652c 2065 7865  s_size=None, exe
+00011980: 6375 746f 723d 2274 6f72 6368 2229 3a0a  cutor="torch"):.
+00011990: 2320 2020 2020 2222 2243 6f6d 7075 7465  #     """Compute
+000119a0: 7320 7468 6520 766d 6170 206f 6620 6120  s the vmap of a 
+000119b0: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
+000119c0: 2e0a 0a23 2020 2020 2041 7267 733a 0a23  ...#     Args:.#
+000119d0: 2020 2020 2020 2020 2066 756e 6320 2843           func (C
+000119e0: 616c 6c61 626c 6529 3a20 4120 5468 756e  allable): A Thun
+000119f0: 6465 7220 6675 6e63 7469 6f6e 2074 6f20  der function to 
+00011a00: 6265 2074 7261 6e73 666f 726d 6564 2e0a  be transformed..
+00011a10: 2320 2020 2020 2020 2020 6172 6773 2028  #         args (
+00011a20: 5f74 7970 655f 293a 2041 7267 7320 6f66  _type_): Args of
+00011a30: 2074 6865 2066 756e 6374 696f 6e2e 0a23   the function..#
+00011a40: 2020 2020 2020 2020 2065 7865 6375 746f           executo
+00011a50: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
+00011a60: 293a 2045 7865 6375 746f 7220 746f 2075  ): Executor to u
+00011a70: 7365 2e20 4465 6661 756c 7473 2074 6f20  se. Defaults to 
+00011a80: 2274 6f72 6368 222e 0a0a 2320 2020 2020  "torch"...#     
+00011a90: 5265 7475 726e 733a 0a23 2020 2020 2020  Returns:.#      
+00011aa0: 2020 2054 6865 2072 6573 756c 7420 6f66     The result of
+00011ab0: 2074 6865 2076 6d61 7070 6564 2066 756e   the vmapped fun
+00011ac0: 6374 696f 6e2e 0a23 2020 2020 2022 2222  ction..#     """
+00011ad0: 0a23 2020 2020 2023 2054 4f44 4f3a 2066  .#     # TODO: f
+00011ae0: 6978 2074 6869 7320 2d20 6e6f 7420 616c  ix this - not al
+00011af0: 6c20 6172 6773 206d 6179 2062 6520 6261  l args may be ba
+00011b00: 7463 6865 640a 2320 2020 2020 2320 544f  tched.#     # TO
+00011b10: 444f 3a20 6865 7265 2077 6520 6173 7375  DO: here we assu
+00011b20: 6d65 2062 6174 6368 2061 7869 7320 6973  me batch axis is
+00011b30: 2030 0a23 2020 2020 2076 6d61 705f 7472   0.#     vmap_tr
+00011b40: 6163 6520 3d20 6d61 6b65 5f74 7261 6365  ace = make_trace
+00011b50: 280a 2320 2020 2020 2020 2020 766d 6170  (.#         vmap
+00011b60: 2866 756e 632c 2069 6e5f 6469 6d73 3d69  (func, in_dims=i
+00011b70: 6e5f 6469 6d73 2c20 6f75 745f 6469 6d73  n_dims, out_dims
+00011b80: 3d6f 7574 5f64 696d 732c 2061 7869 735f  =out_dims, axis_
+00011b90: 7369 7a65 3d61 7869 735f 7369 7a65 292c  size=axis_size),
+00011ba0: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
+00011bb0: 6f72 2c0a 2320 2020 2020 2020 2020 2a61  or,.#         *a
+00011bc0: 7267 7329 0a23 2020 2020 2076 6d61 705f  rgs).#     vmap_
+00011bd0: 7472 6163 6564 203d 206d 616b 655f 7472  traced = make_tr
+00011be0: 6163 6564 2870 6172 7469 616c 2865 7661  aced(partial(eva
+00011bf0: 6c5f 7472 6163 652c 2076 6d61 705f 7472  l_trace, vmap_tr
+00011c00: 6163 6529 2c20 6578 6563 7574 6f72 3d65  ace), executor=e
+00011c10: 7865 6375 746f 7229 0a23 2020 2020 2072  xecutor).#     r
+00011c20: 6574 7572 6e20 766d 6170 5f74 7261 6365  eturn vmap_trace
+00011c30: 6428 2a61 7267 7329 0a0a 0a23 204a 5650  d(*args)...# JVP
+00011c40: 2074 7261 6e73 666f 726d 0a23 202d 2d2d   transform.# ---
+00011c50: 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a40 6461  ----------...@da
+00011c60: 7461 636c 6173 7328 6672 6f7a 656e 3d54  taclass(frozen=T
+00011c70: 7275 6529 0a63 6c61 7373 204a 5650 4475  rue).class JVPDu
+00011c80: 616c 3a0a 2020 2020 2222 2244 7561 6c20  al:.    """Dual 
+00011c90: 6e75 6d62 6572 2066 6f72 2074 6865 204a  number for the J
+00011ca0: 5650 2074 7261 6e73 666f 726d 2e0a 0a20  VP transform... 
+00011cb0: 2020 2041 7474 7269 6275 7465 733a 0a20     Attributes:. 
+00011cc0: 2020 2020 2020 2070 7269 6d61 6c3a 2050         primal: P
+00011cd0: 7269 6d61 6c20 7661 6c75 652e 0a20 2020  rimal value..   
+00011ce0: 2020 2020 2074 616e 6765 6e74 3a20 5461       tangent: Ta
+00011cf0: 6e67 656e 7420 7661 6c75 652e 0a20 2020  ngent value..   
+00011d00: 2022 2222 0a0a 2020 2020 7072 696d 616c   """..    primal
+00011d10: 3a20 416e 790a 2020 2020 7461 6e67 656e  : Any.    tangen
+00011d20: 743a 2041 6e79 0a0a 2020 2020 6465 6620  t: Any..    def 
+00011d30: 5f5f 6974 6572 5f5f 2873 656c 6629 3a0a  __iter__(self):.
+00011d40: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+00011d50: 6c66 2e70 7269 6d61 6c0a 2020 2020 2020  lf.primal.      
+00011d60: 2020 7969 656c 6420 7365 6c66 2e74 616e    yield self.tan
+00011d70: 6765 6e74 0a0a 0a64 6566 2070 6169 725f  gent...def pair_
+00011d80: 746f 5f6a 7670 5f64 7561 6c28 7061 6972  to_jvp_dual(pair
+00011d90: 293a 0a20 2020 2022 2222 436f 6e76 6572  ):.    """Conver
+00011da0: 7473 2061 2070 6169 7220 746f 2061 204a  ts a pair to a J
+00011db0: 5650 4475 616c 2e0a 0a20 2020 2041 7267  VPDual...    Arg
+00011dc0: 733a 0a20 2020 2020 2020 2070 6169 7220  s:.        pair 
+00011dd0: 2853 6571 7565 6e63 6529 3a20 5061 6972  (Sequence): Pair
+00011de0: 2074 6f20 636f 6e76 6572 742e 0a0a 2020   to convert...  
+00011df0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00011e00: 2020 204a 5650 4475 616c 3a20 4a56 5044     JVPDual: JVPD
+00011e10: 7561 6c20 7265 7072 6573 656e 7461 7469  ual representati
+00011e20: 6f6e 206f 6620 7468 6520 7061 6972 2e0a  on of the pair..
+00011e30: 2020 2020 2222 220a 2020 2020 6966 2069      """.    if i
+00011e40: 7369 6e73 7461 6e63 6528 7061 6972 2c20  sinstance(pair, 
+00011e50: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
+00011e60: 2020 7265 7475 726e 2070 6169 720a 2020    return pair.  
+00011e70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00011e80: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00011e90: 6528 7061 6972 2c20 5365 7175 656e 6365  e(pair, Sequence
+00011ea0: 2920 616e 6420 6c65 6e28 7061 6972 2920  ) and len(pair) 
+00011eb0: 3d3d 2032 0a20 2020 2020 2020 2072 6574  == 2.        ret
+00011ec0: 7572 6e20 4a56 5044 7561 6c28 2a70 6169  urn JVPDual(*pai
+00011ed0: 7229 0a0a 0a64 6566 2073 696e 5f6a 7670  r)...def sin_jvp
+00011ee0: 2861 3a20 4a56 5044 7561 6c29 3a0a 2020  (a: JVPDual):.  
+00011ef0: 2020 782c 2078 6420 3d20 610a 2020 2020    x, xd = a.    
+00011f00: 7265 7475 726e 204a 5650 4475 616c 2870  return JVPDual(p
+00011f10: 7269 6d73 2e73 696e 2878 292c 2070 7269  rims.sin(x), pri
+00011f20: 6d73 2e63 6f73 2878 2920 2a20 7864 290a  ms.cos(x) * xd).
+00011f30: 0a0a 6465 6620 6d75 6c5f 6a76 7028 613a  ..def mul_jvp(a:
+00011f40: 204a 5650 4475 616c 2c20 623a 204a 5650   JVPDual, b: JVP
+00011f50: 4475 616c 293a 0a20 2020 2078 2c20 7864  Dual):.    x, xd
+00011f60: 203d 2061 0a20 2020 2079 2c20 7964 203d   = a.    y, yd =
+00011f70: 2062 0a20 2020 2072 6574 7572 6e20 4a56   b.    return JV
+00011f80: 5044 7561 6c28 7820 2a20 792c 2078 202a  PDual(x * y, x *
+00011f90: 2079 6420 2b20 7920 2a20 7864 290a 0a0a   yd + y * xd)...
+00011fa0: 6465 6620 6164 645f 6a76 7028 613a 204a  def add_jvp(a: J
+00011fb0: 5650 4475 616c 2c20 623a 204a 5650 4475  VPDual, b: JVPDu
+00011fc0: 616c 293a 0a20 2020 2078 2c20 7864 203d  al):.    x, xd =
+00011fd0: 2061 0a20 2020 2079 2c20 7964 203d 2062   a.    y, yd = b
+00011fe0: 0a20 2020 2072 6574 7572 6e20 4a56 5044  .    return JVPD
+00011ff0: 7561 6c28 7820 2b20 792c 2078 6420 2b20  ual(x + y, xd + 
+00012000: 7964 290a 0a0a 6465 6620 6272 6f61 6463  yd)...def broadc
+00012010: 6173 745f 696e 5f64 696d 5f6a 7670 2861  ast_in_dim_jvp(a
+00012020: 3a20 4a56 5044 7561 6c2c 2073 6861 7065  : JVPDual, shape
+00012030: 3a20 7475 706c 655b 4a56 5044 7561 6c2c  : tuple[JVPDual,
+00012040: 202e 2e2e 5d2c 2062 726f 6164 6361 7374   ...], broadcast
+00012050: 5f64 696d 656e 7369 6f6e 733a 2074 7570  _dimensions: tup
+00012060: 6c65 5b4a 5650 4475 616c 2c20 2e2e 2e5d  le[JVPDual, ...]
+00012070: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
+00012080: 2020 782c 2078 6420 3d20 610a 2020 2020    x, xd = a.    
+00012090: 2320 544f 444f 3a20 7368 6170 6520 616e  # TODO: shape an
+000120a0: 6420 6272 6f61 6463 6173 745f 6469 6d65  d broadcast_dime
+000120b0: 6e73 696f 6e73 2073 686f 756c 6420 6265  nsions should be
+000120c0: 2074 7570 6c65 7320 6f66 2069 6e74 730a   tuples of ints.
+000120d0: 2020 2020 2320 6275 7420 666f 7220 6e6f      # but for no
+000120e0: 7720 6974 2773 2061 2074 7570 6c65 206f  w it's a tuple o
+000120f0: 6620 4a56 5044 7561 6c73 0a20 2020 2069  f JVPDuals.    i
+00012100: 6620 6c65 6e28 7368 6170 6529 203e 2030  f len(shape) > 0
+00012110: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
+00012120: 7368 6170 655b 305d 2c20 4a56 5044 7561  shape[0], JVPDua
+00012130: 6c29 3a0a 2020 2020 2020 2020 7368 6170  l):.        shap
+00012140: 652c 205f 203d 2073 6166 655f 7a69 7028  e, _ = safe_zip(
+00012150: 2a73 6861 7065 290a 2020 2020 6966 206c  *shape).    if l
+00012160: 656e 2862 726f 6164 6361 7374 5f64 696d  en(broadcast_dim
+00012170: 656e 7369 6f6e 7329 203e 2030 2061 6e64  ensions) > 0 and
+00012180: 2069 7369 6e73 7461 6e63 6528 6272 6f61   isinstance(broa
+00012190: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+000121a0: 5b30 5d2c 204a 5650 4475 616c 293a 0a20  [0], JVPDual):. 
+000121b0: 2020 2020 2020 2062 726f 6164 6361 7374         broadcast
+000121c0: 5f64 696d 656e 7369 6f6e 732c 205f 203d  _dimensions, _ =
+000121d0: 2073 6166 655f 7a69 7028 2a62 726f 6164   safe_zip(*broad
+000121e0: 6361 7374 5f64 696d 656e 7369 6f6e 7329  cast_dimensions)
+000121f0: 0a20 2020 2072 6574 7572 6e20 4a56 5044  .    return JVPD
+00012200: 7561 6c28 0a20 2020 2020 2020 2070 7269  ual(.        pri
+00012210: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
+00012220: 6469 6d28 782c 2073 6861 7065 2c20 6272  dim(x, shape, br
+00012230: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+00012240: 6e73 292c 2070 7269 6d73 2e62 726f 6164  ns), prims.broad
+00012250: 6361 7374 5f69 6e5f 6469 6d28 7864 2c20  cast_in_dim(xd, 
+00012260: 7368 6170 652c 2062 726f 6164 6361 7374  shape, broadcast
+00012270: 5f64 696d 656e 7369 6f6e 7329 0a20 2020  _dimensions).   
+00012280: 2029 0a0a 0a64 6566 2075 6e70 6163 6b5f   )...def unpack_
+00012290: 7365 7175 656e 6365 5f6a 7670 2873 6571  sequence_jvp(seq
+000122a0: 7565 6e63 653a 204a 5650 4475 616c 2c20  uence: JVPDual, 
+000122b0: 6c65 6e67 7468 3a20 4a56 5044 7561 6c29  length: JVPDual)
+000122c0: 202d 3e20 4a56 5044 7561 6c3a 0a20 2020   -> JVPDual:.   
+000122d0: 2078 203d 2074 7265 655f 6d61 7028 6c61   x = tree_map(la
+000122e0: 6d62 6461 2078 3a20 782e 7072 696d 616c  mbda x: x.primal
+000122f0: 2c20 7365 7175 656e 6365 290a 2020 2020  , sequence).    
+00012300: 7864 203d 2074 7265 655f 6d61 7028 6c61  xd = tree_map(la
+00012310: 6d62 6461 2078 3a20 782e 7461 6e67 656e  mbda x: x.tangen
+00012320: 742c 2073 6571 7565 6e63 6529 0a20 2020  t, sequence).   
+00012330: 206c 656e 6774 682c 205f 203d 206c 656e   length, _ = len
+00012340: 6774 680a 2020 2020 7072 696d 616c 7320  gth.    primals 
+00012350: 3d20 7072 696d 732e 756e 7061 636b 5f73  = prims.unpack_s
+00012360: 6571 7565 6e63 6528 782c 206c 656e 6774  equence(x, lengt
+00012370: 6829 0a20 2020 2074 616e 6765 6e74 7320  h).    tangents 
+00012380: 3d20 7072 696d 732e 756e 7061 636b 5f73  = prims.unpack_s
+00012390: 6571 7565 6e63 6528 7864 2c20 6c65 6e67  equence(xd, leng
+000123a0: 7468 290a 2020 2020 7265 7475 726e 2073  th).    return s
+000123b0: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+000123c0: 6a76 705f 6475 616c 2c20 7361 6665 5f7a  jvp_dual, safe_z
+000123d0: 6970 2870 7269 6d61 6c73 2c20 7461 6e67  ip(primals, tang
+000123e0: 656e 7473 2929 0a0a 0a64 6566 2075 6e70  ents))...def unp
+000123f0: 6163 6b5f 7472 6976 6961 6c5f 6a76 7028  ack_trivial_jvp(
+00012400: 783a 204a 5650 4475 616c 2920 2d3e 204a  x: JVPDual) -> J
+00012410: 5650 4475 616c 3a0a 2020 2020 7265 7475  VPDual:.    retu
+00012420: 726e 2078 0a0a 0a6a 7670 5f69 6d70 6c73  rn x...jvp_impls
+00012430: 3a20 6469 6374 5b70 7269 6d73 2e53 796d  : dict[prims.Sym
+00012440: 626f 6c2c 2043 616c 6c61 626c 655d 203d  bol, Callable] =
+00012450: 2064 6963 7428 290a 0a6a 7670 5f69 6d70   dict()..jvp_imp
+00012460: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+00012470: 2e53 494e 5d20 3d20 7369 6e5f 6a76 700a  .SIN] = sin_jvp.
+00012480: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
+00012490: 5072 696d 4944 732e 4d55 4c5d 203d 206d  PrimIDs.MUL] = m
+000124a0: 756c 5f6a 7670 0a6a 7670 5f69 6d70 6c73  ul_jvp.jvp_impls
+000124b0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e41  [prims.PrimIDs.A
+000124c0: 4444 5d20 3d20 6164 645f 6a76 700a 6a76  DD] = add_jvp.jv
+000124d0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
+000124e0: 696d 4944 732e 4252 4f41 4443 4153 545f  imIDs.BROADCAST_
+000124f0: 494e 5f44 494d 5d20 3d20 6272 6f61 6463  IN_DIM] = broadc
+00012500: 6173 745f 696e 5f64 696d 5f6a 7670 0a23  ast_in_dim_jvp.#
+00012510: 206a 7670 5f69 6d70 6c73 5b70 7269 6d73   jvp_impls[prims
+00012520: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
+00012530: 5345 5155 454e 4345 5d20 3d20 756e 7061  SEQUENCE] = unpa
+00012540: 636b 5f73 6571 7565 6e63 655f 6a76 700a  ck_sequence_jvp.
+00012550: 2320 6a76 705f 696d 706c 735b 7072 696d  # jvp_impls[prim
+00012560: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+00012570: 5f54 5249 5649 414c 5d20 3d20 756e 7061  _TRIVIAL] = unpa
+00012580: 636b 5f74 7269 7669 616c 5f6a 7670 0a0a  ck_trivial_jvp..
+00012590: 0a64 6566 206a 7670 5f73 796d 626f 6c5f  .def jvp_symbol_
+000125a0: 6d61 7070 6572 2873 796d 626f 6c3a 2070  mapper(symbol: p
+000125b0: 7269 6d73 2e53 796d 626f 6c29 3a0a 2020  rims.Symbol):.  
+000125c0: 2020 2222 224d 6170 7320 6120 7379 6d62    """Maps a symb
+000125d0: 6f6c 2074 6f20 6120 4a56 5020 6675 6e63  ol to a JVP func
+000125e0: 7469 6f6e 2074 6861 7420 6576 616c 7561  tion that evalua
+000125f0: 7465 7320 6974 2e0a 0a20 2020 2041 7267  tes it...    Arg
+00012600: 733a 0a20 2020 2020 2020 2073 796d 626f  s:.        symbo
+00012610: 6c20 2870 7269 6d73 2e53 796d 626f 6c29  l (prims.Symbol)
+00012620: 3a20 5379 6d62 6f6c 2074 6f20 6576 616c  : Symbol to eval
+00012630: 7561 7465 2e0a 0a20 2020 2052 6169 7365  uate...    Raise
+00012640: 733a 0a20 2020 2020 2020 204e 6f74 496d  s:.        NotIm
+00012650: 706c 656d 656e 7465 6445 7272 6f72 3a20  plementedError: 
+00012660: 4966 2074 6865 204a 5650 2066 6f72 2074  If the JVP for t
+00012670: 6865 2073 796d 626f 6c20 6973 206e 6f74  he symbol is not
+00012680: 2069 6d70 6c65 6d65 6e74 6564 2e0a 0a20   implemented... 
+00012690: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+000126a0: 2020 2020 4361 6c6c 6162 6c65 3a20 4a56      Callable: JV
+000126b0: 5020 6675 6e63 7469 6f6e 2074 6861 7420  P function that 
+000126c0: 6576 616c 7561 7465 7320 7468 6520 7379  evaluates the sy
+000126d0: 6d62 6f6c 2e0a 2020 2020 2222 220a 0a20  mbol..    """.. 
+000126e0: 2020 2064 6566 2077 7261 705f 6172 6728     def wrap_arg(
+000126f0: 7829 3a0a 2020 2020 2020 2020 6966 2069  x):.        if i
+00012700: 7369 6e73 7461 6e63 6528 782c 204a 5650  sinstance(x, JVP
+00012710: 4475 616c 293a 0a20 2020 2020 2020 2020  Dual):.         
+00012720: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
+00012730: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00012740: 6e63 6528 782c 204e 756d 6265 7229 3a0a  nce(x, Number):.
+00012750: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012760: 726e 204a 5650 4475 616c 2878 2c20 7479  rn JVPDual(x, ty
+00012770: 7065 2878 2928 3029 290a 2020 2020 2020  pe(x)(0)).      
+00012780: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00012790: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000127a0: 7272 6f72 2866 224a 5650 2077 7261 705f  rror(f"JVP wrap_
+000127b0: 6172 6720 676f 7420 616e 2075 6e73 7570  arg got an unsup
+000127c0: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
+000127d0: 6528 7829 7d22 290a 0a20 2020 2023 2049  e(x)}")..    # I
+000127e0: 6620 7379 6d62 6f6c 2e61 7267 7320 646f  f symbol.args do
+000127f0: 6573 6e27 7420 6861 7665 2073 7562 636c  esn't have subcl
+00012800: 6173 7365 7320 6f66 2056 6172 6961 626c  asses of Variabl
+00012810: 652c 2074 6865 6e20 7765 206e 6565 6420  e, then we need 
+00012820: 746f 2072 6574 7572 6e20 6120 7a65 726f  to return a zero
+00012830: 2074 616e 6765 6e74 0a20 2020 2023 2054   tangent.    # T
+00012840: 4f44 4f3a 2074 6865 7265 206d 6179 2062  ODO: there may b
+00012850: 6520 6120 6265 7474 6572 2077 6179 2074  e a better way t
+00012860: 6f20 6465 7465 6374 2063 6f6e 7374 616e  o detect constan
+00012870: 7473 2069 6e20 7468 6520 7472 6163 650a  ts in the trace.
+00012880: 2020 2020 6966 2073 796d 626f 6c2e 6172      if symbol.ar
+00012890: 655f 616c 6c5f 6172 6773 5f63 6f6e 7374  e_all_args_const
+000128a0: 616e 743a 0a0a 2020 2020 2020 2020 6465  ant:..        de
+000128b0: 6620 7a65 726f 735f 6c69 6b65 2878 293a  f zeros_like(x):
+000128c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000128d0: 6973 696e 7374 616e 6365 2878 2c20 5465  isinstance(x, Te
+000128e0: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
+000128f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012900: 726e 2066 756c 6c5f 6c69 6b65 2878 2c20  rn full_like(x, 
+00012910: 6669 6c6c 5f76 616c 7565 3d30 290a 2020  fill_value=0).  
+00012920: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00012930: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
+00012940: 6265 7250 726f 7879 293a 0a20 2020 2020  berProxy):.     
+00012950: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00012960: 6e20 7479 7065 2878 2e76 616c 7565 2928  n type(x.value)(
+00012970: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
+00012980: 6c69 6620 6973 696e 7374 616e 6365 2878  lif isinstance(x
+00012990: 2c20 4e75 6d62 6572 293a 0a20 2020 2020  , Number):.     
+000129a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000129b0: 6e20 7479 7065 2878 2928 3029 0a20 2020  n type(x)(0).   
+000129c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000129d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000129e0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000129f0: 6622 7a65 726f 735f 6c69 6b65 2069 6e73  f"zeros_like ins
+00012a00: 6964 6520 4a56 5020 676f 7420 616e 2075  ide JVP got an u
+00012a10: 6e73 7570 706f 7274 6564 2074 7970 6520  nsupported type 
+00012a20: 7b74 7970 6528 7829 7d22 290a 0a20 2020  {type(x)}")..   
+00012a30: 2020 2020 2064 6566 206a 7670 5f69 6d70       def jvp_imp
+00012a40: 6c5f 636f 6e73 7428 7379 6d62 6f6c 2c20  l_const(symbol, 
+00012a50: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00012a60: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00012a70: 696d 616c 7320 3d20 7379 6d62 6f6c 5f74  imals = symbol_t
+00012a80: 6f5f 6576 616c 2873 796d 626f 6c29 282a  o_eval(symbol)(*
+00012a90: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+00012aa0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00012ab0: 7369 6e73 7461 6e63 6528 7072 696d 616c  sinstance(primal
+00012ac0: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+00012ad0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00012ae0: 6e67 656e 7473 203d 2074 7570 6c65 287a  ngents = tuple(z
+00012af0: 6572 6f73 5f6c 696b 6528 7029 2066 6f72  eros_like(p) for
+00012b00: 2070 2069 6e20 7072 696d 616c 7329 0a20   p in primals). 
+00012b10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012b20: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
+00012b30: 6169 725f 746f 5f6a 7670 5f64 7561 6c2c  air_to_jvp_dual,
+00012b40: 2073 6166 655f 7a69 7028 7072 696d 616c   safe_zip(primal
+00012b50: 732c 2074 616e 6765 6e74 7329 290a 2020  s, tangents)).  
+00012b60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00012b70: 204a 5650 4475 616c 2870 7269 6d61 6c73   JVPDual(primals
+00012b80: 2c20 7a65 726f 735f 6c69 6b65 2870 7269  , zeros_like(pri
+00012b90: 6d61 6c73 2929 0a0a 2020 2020 2020 2020  mals))..        
+00012ba0: 7265 7475 726e 2070 6172 7469 616c 286a  return partial(j
+00012bb0: 7670 5f69 6d70 6c5f 636f 6e73 742c 2073  vp_impl_const, s
+00012bc0: 796d 626f 6c29 0a0a 2020 2020 2320 4e6f  ymbol)..    # No
+00012bd0: 726d 616c 2063 6173 652c 2077 6520 6861  rmal case, we ha
+00012be0: 7665 2061 2070 726f 7879 2074 616e 6765  ve a proxy tange
+00012bf0: 6e74 0a20 2020 206a 7670 5f69 6d70 6c20  nt.    jvp_impl 
+00012c00: 3d20 6a76 705f 696d 706c 732e 6765 7428  = jvp_impls.get(
+00012c10: 7379 6d62 6f6c 2e73 796d 2e69 6429 0a20  symbol.sym.id). 
+00012c20: 2020 2069 6620 6a76 705f 696d 706c 2069     if jvp_impl i
+00012c30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00012c40: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
+00012c50: 6e74 6564 4572 726f 7228 6622 4a56 5020  ntedError(f"JVP 
+00012c60: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
+00012c70: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
+00012c80: 6d65 6e74 6564 2229 0a0a 2020 2020 6465  mented")..    de
+00012c90: 6620 5f6a 7670 5f69 6d70 6c28 2a61 7267  f _jvp_impl(*arg
+00012ca0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+00012cb0: 2020 2020 2020 6172 6773 203d 2074 7265        args = tre
+00012cc0: 655f 6d61 7028 7772 6170 5f61 7267 2c20  e_map(wrap_arg, 
+00012cd0: 6172 6773 290a 2020 2020 2020 2020 2320  args).        # 
+00012ce0: 4578 7065 6374 696e 6720 4a56 5044 7561  Expecting JVPDua
+00012cf0: 6c73 2077 7261 7070 696e 6720 7061 6972  ls wrapping pair
+00012d00: 7320 6f66 2070 7269 6d61 6c73 2061 6e64  s of primals and
+00012d10: 2074 616e 6765 6e74 730a 2020 2020 2020   tangents.      
+00012d20: 2020 6173 7365 7274 2061 6c6c 2869 7369    assert all(isi
+00012d30: 6e73 7461 6e63 6528 6172 672c 204a 5650  nstance(arg, JVP
+00012d40: 4475 616c 2920 666f 7220 6172 6720 696e  Dual) for arg in
+00012d50: 2074 7265 655f 666c 6174 7465 6e28 6172   tree_flatten(ar
+00012d60: 6773 295b 305d 290a 2020 2020 2020 2020  gs)[0]).        
+00012d70: 7265 7475 726e 206a 7670 5f69 6d70 6c28  return jvp_impl(
+00012d80: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00012d90: 0a0a 2020 2020 7265 7475 726e 205f 6a76  ..    return _jv
+00012da0: 705f 696d 706c 0a0a 0a64 6566 205f 6a76  p_impl...def _jv
+00012db0: 705f 6361 6c6c 5f6d 6574 6166 756e 6328  p_call_metafunc(
+00012dc0: 6465 7461 6368 6564 3a20 626f 6f6c 2c20  detached: bool, 
+00012dd0: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+00012de0: 732c 202a 2c20 6675 6e63 7469 6f6e 5f74  s, *, function_t
+00012df0: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
+00012e00: 7761 7267 7329 3a0a 2020 2020 2222 224d  wargs):.    """M
+00012e10: 6574 6166 756e 6374 696f 6e20 666f 7220  etafunction for 
+00012e20: 7468 6520 4a56 5020 7472 616e 7366 6f72  the JVP transfor
+00012e30: 6d2e 0a0a 2020 2020 4172 6773 3a0a 2020  m...    Args:.  
+00012e40: 2020 2020 2020 6465 7461 6368 6564 2028        detached (
+00012e50: 626f 6f6c 293a 2057 6865 7468 6572 2074  bool): Whether t
+00012e60: 6f20 6465 7461 6368 2074 6865 2074 7261  o detach the tra
+00012e70: 6365 2e0a 2020 2020 2020 2020 7072 696d  ce..        prim
+00012e80: 616c 7320 2854 7570 6c65 5b50 726f 7879  als (Tuple[Proxy
+00012e90: 5d29 3a20 5072 696d 616c 2076 616c 7565  ]): Primal value
+00012ea0: 732e 0a20 2020 2020 2020 2074 616e 6765  s..        tange
+00012eb0: 6e74 7320 2854 7570 6c65 5b50 726f 7879  nts (Tuple[Proxy
+00012ec0: 5d29 3a20 5461 6e67 656e 7420 7661 6c75  ]): Tangent valu
+00012ed0: 6573 2e0a 2020 2020 2020 2020 6675 6e63  es..        func
+00012ee0: 7469 6f6e 5f74 7261 6365 2028 5472 6163  tion_trace (Trac
+00012ef0: 6529 3a20 5472 6163 6520 6f66 2074 6865  e): Trace of the
+00012f00: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
+00012f10: 7472 616e 7366 6f72 6d65 642e 0a20 2020  transformed..   
+00012f20: 2020 2020 206b 7761 7267 733a 204b 6579       kwargs: Key
+00012f30: 776f 7264 2061 7267 756d 656e 7473 2e0a  word arguments..
+00012f40: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+00012f50: 2020 2020 2041 7373 6572 7469 6f6e 4572       AssertionEr
+00012f60: 726f 723a 2049 6620 7468 6520 4a56 5020  ror: If the JVP 
+00012f70: 666f 7220 6b65 7977 6f72 6420 6172 6775  for keyword argu
+00012f80: 6d65 6e74 7320 6973 206e 6f74 2069 6d70  ments is not imp
+00012f90: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
+00012fa0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00012fb0: 5265 7375 6c74 206f 6620 7468 6520 4a56  Result of the JV
+00012fc0: 5020 7472 616e 7366 6f72 6d2e 0a20 2020  P transform..   
+00012fd0: 2022 2222 0a20 2020 2061 7373 6572 7420   """.    assert 
+00012fe0: 6c65 6e28 6b77 6172 6773 2920 3d3d 2030  len(kwargs) == 0
+00012ff0: 2c20 224a 5650 2066 6f72 206b 7761 7267  , "JVP for kwarg
+00013000: 7320 6973 206e 6f74 2069 6d70 6c65 6d65  s is not impleme
+00013010: 6e74 6564 220a 0a20 2020 2063 7478 203d  nted"..    ctx =
+00013020: 2064 6574 6163 6865 645f 7472 6163 6528   detached_trace(
+00013030: 2920 6966 2064 6574 6163 6865 6420 656c  ) if detached el
+00013040: 7365 206e 756c 6c63 6f6e 7465 7874 2829  se nullcontext()
+00013050: 0a20 2020 2077 6974 6820 6374 783a 0a20  .    with ctx:. 
+00013060: 2020 2020 2020 2023 2057 7261 7070 696e         # Wrappin
+00013070: 6720 7468 6520 7072 696d 616c 7320 616e  g the primals an
+00013080: 6420 7461 6e67 656e 7473 2069 6e20 4a56  d tangents in JV
+00013090: 5044 7561 6c73 2069 7320 6e6f 7420 7374  PDuals is not st
+000130a0: 7269 6374 6c79 206e 6563 6573 7361 7279  rictly necessary
+000130b0: 2c20 6275 7420 6974 206d 616b 6573 0a20  , but it makes. 
+000130c0: 2020 2020 2020 2023 2074 6865 2063 6f64         # the cod
+000130d0: 6520 6d6f 7265 2072 6561 6461 626c 650a  e more readable.
+000130e0: 2020 2020 2020 2020 2320 5765 2070 726f          # We pro
+000130f0: 7061 6761 7465 2074 6865 204a 5650 4475  pagate the JVPDu
+00013100: 616c 7320 7468 726f 7567 6820 7468 6520  als through the 
+00013110: 7472 6163 652c 2061 6e64 2074 6865 6e20  trace, and then 
+00013120: 756e 7772 6170 2074 6865 6d20 6174 2074  unwrap them at t
+00013130: 6865 2065 6e64 0a20 2020 2020 2020 2070  he end.        p
+00013140: 7269 6d61 6c73 5f74 616e 6765 6e74 735f  rimals_tangents_
+00013150: 6475 616c 7320 3d20 7361 6665 5f6d 6170  duals = safe_map
+00013160: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
+00013170: 6c2c 2073 6166 655f 7a69 7028 7072 696d  l, safe_zip(prim
+00013180: 616c 732c 2074 616e 6765 6e74 7329 290a  als, tangents)).
+00013190: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+000131a0: 2065 7661 6c5f 7472 6163 6528 6675 6e63   eval_trace(func
+000131b0: 7469 6f6e 5f74 7261 6365 2c20 2a70 7269  tion_trace, *pri
+000131c0: 6d61 6c73 5f74 616e 6765 6e74 735f 6475  mals_tangents_du
+000131d0: 616c 732c 2073 796d 626f 6c5f 6d61 7070  als, symbol_mapp
+000131e0: 6572 3d6a 7670 5f73 796d 626f 6c5f 6d61  er=jvp_symbol_ma
+000131f0: 7070 6572 290a 2020 2020 2020 2020 2320  pper).        # 
+00013200: 556e 7772 6170 7069 6e67 2074 6865 204a  Unwrapping the J
+00013210: 5650 4475 616c 730a 2020 2020 2020 2020  VPDuals.        
+00013220: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00013230: 7375 6c74 2c20 5365 7175 656e 6365 293a  sult, Sequence):
+00013240: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00013250: 6572 7420 616c 6c28 6973 696e 7374 616e  ert all(isinstan
+00013260: 6365 2878 2c20 4a56 5044 7561 6c29 2066  ce(x, JVPDual) f
+00013270: 6f72 2078 2069 6e20 7265 7375 6c74 290a  or x in result).
+00013280: 2020 2020 2020 2020 2020 2020 7072 696d              prim
+00013290: 616c 732c 2074 616e 6765 6e74 7320 3d20  als, tangents = 
+000132a0: 756e 7a69 7032 2872 6573 756c 7429 0a20  unzip2(result). 
+000132b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000132c0: 6e20 7072 696d 616c 732c 2074 616e 6765  n primals, tange
+000132d0: 6e74 730a 2020 2020 2020 2020 6173 7365  nts.        asse
+000132e0: 7274 2069 7369 6e73 7461 6e63 6528 7265  rt isinstance(re
+000132f0: 7375 6c74 2c20 4a56 5044 7561 6c29 0a20  sult, JVPDual). 
+00013300: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00013310: 7375 6c74 2e70 7269 6d61 6c2c 2072 6573  sult.primal, res
+00013320: 756c 742e 7461 6e67 656e 740a 0a0a 6a76  ult.tangent...jv
+00013330: 705f 6361 6c6c 203d 2053 796d 626f 6c28  p_call = Symbol(
+00013340: 6964 3d54 7261 6e73 666f 726d 732e 4a76  id=Transforms.Jv
+00013350: 704f 702c 206e 616d 653d 226a 7670 5f63  pOp, name="jvp_c
+00013360: 616c 6c22 2c20 6d65 7461 3d70 6172 7469  all", meta=parti
+00013370: 616c 285f 6a76 705f 6361 6c6c 5f6d 6574  al(_jvp_call_met
+00013380: 6166 756e 632c 2046 616c 7365 2929 0a0a  afunc, False))..
+00013390: 0a64 6566 205f 6964 656e 7469 7479 5f63  .def _identity_c
+000133a0: 616c 6c5f 6a76 7028 2a61 7267 733a 204a  all_jvp(*args: J
+000133b0: 5650 4475 616c 2c20 7472 6163 653a 2054  VPDual, trace: T
+000133c0: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
+000133d0: 0a20 2020 2070 7269 6d61 6c73 2c20 7461  .    primals, ta
+000133e0: 6e67 656e 7473 203d 2075 6e7a 6970 3228  ngents = unzip2(
+000133f0: 6172 6773 290a 2020 2020 6f75 745f 7072  args).    out_pr
+00013400: 696d 616c 732c 206f 7574 5f74 616e 6765  imals, out_tange
+00013410: 6e74 7320 3d20 5f6a 7670 5f63 616c 6c5f  nts = _jvp_call_
+00013420: 6d65 7461 6675 6e63 2846 616c 7365 2c20  metafunc(False, 
+00013430: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+00013440: 732c 2074 7261 6365 2c20 2a2a 6b77 6172  s, trace, **kwar
+00013450: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
+00013460: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
+00013470: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+00013480: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
+00013490: 655f 6d61 7028 7061 6972 5f74 6f5f 6a76  e_map(pair_to_jv
+000134a0: 705f 6475 616c 2c20 7361 6665 5f7a 6970  p_dual, safe_zip
+000134b0: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
+000134c0: 745f 7461 6e67 656e 7473 2929 0a20 2020  t_tangents)).   
+000134d0: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
+000134e0: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
+000134f0: 5f74 616e 6765 6e74 7329 0a0a 0a6a 7670  _tangents)...jvp
+00013500: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
+00013510: 732e 4964 656e 7469 7479 4f70 5d20 3d20  s.IdentityOp] = 
+00013520: 5f69 6465 6e74 6974 795f 6361 6c6c 5f6a  _identity_call_j
+00013530: 7670 0a0a 0a64 6566 205f 766d 6170 5f63  vp...def _vmap_c
+00013540: 616c 6c5f 6a76 7028 6172 6773 3a20 4a56  all_jvp(args: JV
+00013550: 5044 7561 6c2c 2069 6e5f 6469 6d73 2c20  PDual, in_dims, 
+00013560: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
+00013570: 697a 652c 2074 7261 6365 3a20 5472 6163  ize, trace: Trac
+00013580: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
+00013590: 2020 7072 696d 616c 732c 2074 616e 6765    primals, tange
+000135a0: 6e74 7320 3d20 7361 6665 5f7a 6970 282a  nts = safe_zip(*
+000135b0: 6172 6773 290a 2020 2020 696e 5f64 696d  args).    in_dim
+000135c0: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
+000135d0: 2a69 6e5f 6469 6d73 290a 2020 2020 6f75  *in_dims).    ou
+000135e0: 745f 6469 6d73 2c20 5f20 3d20 7361 6665  t_dims, _ = safe
+000135f0: 5f7a 6970 282a 6f75 745f 6469 6d73 290a  _zip(*out_dims).
+00013600: 2020 2020 766d 6170 7065 645f 7472 6163      vmapped_trac
+00013610: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
+00013620: 6163 6528 2928 0a20 2020 2020 2020 2076  ace()(.        v
+00013630: 6d61 7028 7061 7274 6961 6c28 6576 616c  map(partial(eval
+00013640: 5f74 7261 6365 2c20 7472 6163 6529 2c20  _trace, trace), 
+00013650: 696e 5f64 696d 733d 696e 5f64 696d 732c  in_dims=in_dims,
+00013660: 206f 7574 5f64 696d 733d 6f75 745f 6469   out_dims=out_di
+00013670: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
+00013680: 6973 5f73 697a 6529 2c20 2a70 7269 6d61  is_size), *prima
+00013690: 6c73 0a20 2020 2029 0a20 2020 2076 6d61  ls.    ).    vma
+000136a0: 7070 6564 5f66 756e 6320 3d20 7061 7274  pped_func = part
+000136b0: 6961 6c28 6576 616c 5f74 7261 6365 2c20  ial(eval_trace, 
+000136c0: 766d 6170 7065 645f 7472 6163 6529 0a20  vmapped_trace). 
+000136d0: 2020 206f 7574 5f70 7269 6d61 6c73 2c20     out_primals, 
+000136e0: 6f75 745f 7461 6e67 656e 7473 203d 206a  out_tangents = j
+000136f0: 7670 2876 6d61 7070 6564 5f66 756e 6329  vp(vmapped_func)
+00013700: 2870 7269 6d61 6c73 2c20 7461 6e67 656e  (primals, tangen
+00013710: 7473 2c20 2a2a 6b77 6172 6773 290a 2020  ts, **kwargs).  
+00013720: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00013730: 6f75 745f 7072 696d 616c 732c 2053 6571  out_primals, Seq
+00013740: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
+00013750: 7265 7475 726e 2073 6166 655f 6d61 7028  return safe_map(
+00013760: 7061 6972 5f74 6f5f 6a76 705f 6475 616c  pair_to_jvp_dual
+00013770: 2c20 7361 6665 5f7a 6970 286f 7574 5f70  , safe_zip(out_p
+00013780: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
+00013790: 656e 7473 2929 0a20 2020 2072 6574 7572  ents)).    retur
+000137a0: 6e20 4a56 5044 7561 6c28 6f75 745f 7072  n JVPDual(out_pr
+000137b0: 696d 616c 732c 206f 7574 5f74 616e 6765  imals, out_tange
+000137c0: 6e74 7329 0a0a 0a6a 7670 5f69 6d70 6c73  nts)...jvp_impls
+000137d0: 5b54 7261 6e73 666f 726d 732e 566d 6170  [Transforms.Vmap
+000137e0: 4f70 5d20 3d20 5f76 6d61 705f 6361 6c6c  Op] = _vmap_call
+000137f0: 5f6a 7670 0a0a 0a64 6566 206a 7670 2866  _jvp...def jvp(f
+00013800: 756e 6329 3a0a 2020 2020 2222 224a 6163  unc):.    """Jac
+00013810: 6f62 6961 6e2d 7665 6374 6f72 2070 726f  obian-vector pro
+00013820: 6475 6374 2074 7261 6e73 666f 726d 2066  duct transform f
+00013830: 6f72 2061 2054 6875 6e64 6572 2066 756e  or a Thunder fun
+00013840: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
+00013850: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
+00013860: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
+00013870: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
+00013880: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+00013890: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+000138a0: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
+000138b0: 2041 2066 756e 6374 696f 6e20 7468 6174   A function that
+000138c0: 2063 6f6d 7075 7465 7320 7468 6520 4a61   computes the Ja
+000138d0: 636f 6269 616e 2d76 6563 746f 7220 7072  cobian-vector pr
+000138e0: 6f64 7563 740a 2020 2020 2020 2020 2020  oduct.          
+000138f0: 2020 7461 6b69 6e67 2070 7269 6d61 6c73    taking primals
+00013900: 2061 6e64 2074 616e 6765 6e74 7320 6173   and tangents as
+00013910: 2061 7267 756d 656e 7473 2e0a 2020 2020   arguments..    
+00013920: 2222 220a 0a20 2020 2064 6566 2077 7261  """..    def wra
+00013930: 7070 6572 2870 7269 6d61 6c73 2c20 7461  pper(primals, ta
+00013940: 6e67 656e 7473 293a 0a20 2020 2020 2020  ngents):.       
+00013950: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
+00013960: 6374 5f74 7261 6365 2829 2866 756e 632c  ct_trace()(func,
+00013970: 202a 7072 696d 616c 7329 0a20 2020 2020   *primals).     
+00013980: 2020 2072 6574 7572 6e20 6a76 705f 6361     return jvp_ca
+00013990: 6c6c 2870 7269 6d61 6c73 2c20 7461 6e67  ll(primals, tang
+000139a0: 656e 7473 2c20 6675 6e63 7469 6f6e 5f74  ents, function_t
+000139b0: 7261 6365 3d74 7261 6365 290a 0a20 2020  race=trace)..   
+000139c0: 2072 6574 7572 6e20 7772 6170 7065 720a   return wrapper.
+000139d0: 0a0a 2320 544f 444f 2054 6869 7320 6675  ..# TODO This fu
+000139e0: 6e63 7469 6f6e 2063 6f6d 6d65 6e74 6564  nction commented
+000139f0: 206f 7574 2062 6563 6175 7365 2069 7420   out because it 
+00013a00: 6361 6c6c 7320 6d61 6b65 5f74 7261 6365  calls make_trace
+00013a10: 642c 2077 6869 6368 2064 6f65 7320 6e6f  d, which does no
+00013a20: 7420 6578 6973 740a 2320 6465 6620 6a76  t exist.# def jv
+00013a30: 705f 6561 6765 7228 6675 6e63 2c20 7072  p_eager(func, pr
+00013a40: 696d 616c 732c 2074 616e 6765 6e74 732c  imals, tangents,
+00013a50: 2065 7865 6375 746f 723d 2274 6f72 6368   executor="torch
+00013a60: 2229 3a0a 2320 2020 2020 2222 2243 6f6d  "):.#     """Com
+00013a70: 7075 7465 7320 7468 6520 4a61 636f 6269  putes the Jacobi
+00013a80: 616e 2d76 6563 746f 7220 7072 6f64 7563  an-vector produc
+00013a90: 7420 6f66 2061 2054 6875 6e64 6572 2066  t of a Thunder f
+00013aa0: 756e 6374 696f 6e2e 0a0a 2320 2020 2020  unction...#     
+00013ab0: 4172 6773 3a0a 2320 2020 2020 2020 2020  Args:.#         
+00013ac0: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
+00013ad0: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
+00013ae0: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
+00013af0: 6f72 6d65 642e 0a23 2020 2020 2020 2020  ormed..#        
+00013b00: 2070 7269 6d61 6c73 2028 5f74 7970 655f   primals (_type_
+00013b10: 293a 2050 7269 6d61 6c73 206f 6620 7468  ): Primals of th
+00013b20: 6520 6675 6e63 7469 6f6e 2e0a 2320 2020  e function..#   
+00013b30: 2020 2020 2020 7461 6e67 656e 7473 2028        tangents (
+00013b40: 5f74 7970 655f 293a 2054 616e 6765 6e74  _type_): Tangent
+00013b50: 7320 6f66 2074 6865 2066 756e 6374 696f  s of the functio
+00013b60: 6e2e 0a23 2020 2020 2020 2020 2065 7865  n..#         exe
+00013b70: 6375 746f 7220 2873 7472 2c20 6f70 7469  cutor (str, opti
+00013b80: 6f6e 616c 293a 2045 7865 6375 746f 7220  onal): Executor 
+00013b90: 746f 2075 7365 2e20 4465 6661 756c 7473  to use. Defaults
+00013ba0: 2074 6f20 2274 6f72 6368 222e 0a0a 2320   to "torch"...# 
+00013bb0: 2020 2020 5265 7475 726e 733a 0a23 2020      Returns:.#  
+00013bc0: 2020 2020 2020 2054 6865 2072 6573 756c         The resul
+00013bd0: 7420 6f66 2074 6865 204a 6163 6f62 6961  t of the Jacobia
+00013be0: 6e2d 7665 6374 6f72 2070 726f 6475 6374  n-vector product
+00013bf0: 2e0a 2320 2020 2020 2222 220a 2320 2020  ..#     """.#   
+00013c00: 2020 7472 6163 6520 3d20 6d61 6b65 5f74    trace = make_t
+00013c10: 7261 6365 2866 756e 632c 2065 7865 6375  race(func, execu
+00013c20: 746f 723d 6578 6563 7574 6f72 2c20 2a70  tor=executor, *p
+00013c30: 7269 6d61 6c73 290a 0a23 2020 2020 2064  rimals)..#     d
+00013c40: 6566 206a 7670 5f66 756e 6328 2a70 7269  ef jvp_func(*pri
+00013c50: 6d61 6c73 5f61 6e64 5f74 616e 6765 6e74  mals_and_tangent
+00013c60: 7329 3a0a 2320 2020 2020 2020 2020 5f70  s):.#         _p
+00013c70: 7269 6d61 6c73 2c20 5f74 616e 6765 6e74  rimals, _tangent
+00013c80: 7320 3d20 7072 696d 616c 735f 616e 645f  s = primals_and_
+00013c90: 7461 6e67 656e 7473 5b3a 206c 656e 2870  tangents[: len(p
+00013ca0: 7269 6d61 6c73 295d 2c20 7072 696d 616c  rimals)], primal
+00013cb0: 735f 616e 645f 7461 6e67 656e 7473 5b6c  s_and_tangents[l
+00013cc0: 656e 2870 7269 6d61 6c73 2920 3a5d 0a23  en(primals) :].#
+00013cd0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013ce0: 5f6a 7670 5f63 616c 6c5f 6d65 7461 6675  _jvp_call_metafu
+00013cf0: 6e63 285f 7072 696d 616c 732c 205f 7461  nc(_primals, _ta
+00013d00: 6e67 656e 7473 2c20 7472 6163 652c 2064  ngents, trace, d
+00013d10: 6574 6163 6865 643d 4661 6c73 6529 0a0a  etached=False)..
+00013d20: 2320 2020 2020 6a76 705f 7472 6163 6520  #     jvp_trace 
+00013d30: 3d20 6d61 6b65 5f74 7261 6365 286a 7670  = make_trace(jvp
+00013d40: 5f66 756e 632c 2065 7865 6375 746f 723d  _func, executor=
+00013d50: 6578 6563 7574 6f72 2928 2a70 7269 6d61  executor)(*prima
+00013d60: 6c73 2c20 2a74 616e 6765 6e74 7329 0a23  ls, *tangents).#
+00013d70: 2020 2020 206a 7670 5f74 7261 6365 6420       jvp_traced 
+00013d80: 3d20 6d61 6b65 5f74 7261 6365 6428 7061  = make_traced(pa
+00013d90: 7274 6961 6c28 6576 616c 5f74 7261 6365  rtial(eval_trace
+00013da0: 2c20 6a76 705f 7472 6163 6529 2c20 6578  , jvp_trace), ex
+00013db0: 6563 7574 6f72 3d65 7865 6375 746f 7229  ecutor=executor)
+00013dc0: 0a23 2020 2020 2072 6574 7572 6e20 6a76  .#     return jv
+00013dd0: 705f 7472 6163 6564 282a 7072 696d 616c  p_traced(*primal
+00013de0: 732c 202a 7461 6e67 656e 7473 290a 0a0a  s, *tangents)...
+00013df0: 2320 564a 5020 7472 616e 7366 6f72 6d0a  # VJP transform.
+00013e00: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  # =============.
+00013e10: 4064 6174 6163 6c61 7373 2866 726f 7a65  @dataclass(froze
+00013e20: 6e3d 5472 7565 290a 636c 6173 7320 564a  n=True).class VJ
+00013e30: 5044 7561 6c3a 0a20 2020 2022 2222 4120  PDual:.    """A 
+00013e40: 7061 6972 206f 6620 7072 696d 616c 2061  pair of primal a
+00013e50: 6e64 2073 6176 6564 2069 6e66 6f72 6d61  nd saved informa
+00013e60: 7469 6f6e 2066 6f72 2062 6163 6b77 6172  tion for backwar
+00013e70: 6420 2872 6573 6964 7561 6c73 292e 0a0a  d (residuals)...
+00013e80: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00013e90: 2020 7072 696d 616c 2028 556e 696f 6e5b    primal (Union[
+00013ea0: 5072 6f78 792c 204e 756d 6265 725d 293a  Proxy, Number]):
+00013eb0: 2050 7269 6d61 6c20 7661 6c75 652c 2069   Primal value, i
+00013ec0: 2e65 2e2c 2074 6865 2076 616c 7565 2062  .e., the value b
+00013ed0: 6569 6e67 2064 6966 6665 7265 6e74 6961  eing differentia
+00013ee0: 7465 642e 0a20 2020 2020 2020 2072 6573  ted..        res
+00013ef0: 6964 7561 6c73 2028 5475 706c 655b 5072  iduals (Tuple[Pr
+00013f00: 6f78 792c 202e 2e2e 5d29 3a20 5265 7369  oxy, ...]): Resi
+00013f10: 6475 616c 732c 2069 2e65 2e2c 2074 6865  duals, i.e., the
+00013f20: 2076 616c 7565 7320 7468 6174 2061 7265   values that are
+00013f30: 0a20 2020 2020 2020 2020 2020 2073 6176  .            sav
+00013f40: 6564 2066 6f72 2074 6865 2062 6163 6b77  ed for the backw
+00013f50: 6172 642e 0a0a 2020 2020 5969 656c 6473  ard...    Yields
+00013f60: 3a0a 2020 2020 2020 2020 5475 706c 655b  :.        Tuple[
+00013f70: 5661 7269 6162 6c65 2c20 5475 706c 655b  Variable, Tuple[
+00013f80: 5661 7269 6162 6c65 2c20 2e2e 2e5d 2c20  Variable, ...], 
+00013f90: 4361 6c6c 6162 6c65 5d3a 2050 7269 6d61  Callable]: Prima
+00013fa0: 6c20 616e 6420 7265 7369 6475 616c 730a  l and residuals.
+00013fb0: 2020 2020 2222 220a 0a20 2020 2070 7269      """..    pri
+00013fc0: 6d61 6c3a 2050 726f 7879 207c 204e 756d  mal: Proxy | Num
+00013fd0: 6265 720a 2020 2020 7265 7369 6475 616c  ber.    residual
+00013fe0: 733a 2074 7570 6c65 5b50 726f 7879 2c20  s: tuple[Proxy, 
+00013ff0: 2e2e 2e5d 0a0a 2020 2020 6465 6620 5f5f  ...]..    def __
+00014000: 6974 6572 5f5f 2873 656c 6629 3a0a 2020  iter__(self):.  
+00014010: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
+00014020: 2e70 7269 6d61 6c0a 2020 2020 2020 2020  .primal.        
+00014030: 7969 656c 6420 7365 6c66 2e72 6573 6964  yield self.resid
+00014040: 7561 6c73 0a0a 0a63 6c61 7373 204e 6f50  uals...class NoP
+00014050: 756c 6c62 6163 6b3a 0a20 2020 2022 2222  ullback:.    """
+00014060: 4120 6475 6d6d 7920 7075 6c6c 6261 636b  A dummy pullback
+00014070: 2066 756e 6374 696f 6e20 7468 6174 2072   function that r
+00014080: 6574 7572 6e73 204e 6f6e 6520 6f72 2072  eturns None or r
+00014090: 6169 7365 7320 616e 2065 7272 6f72 2e22  aises an error."
+000140a0: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+000140b0: 6974 5f5f 2873 656c 662c 206e 756d 5f61  it__(self, num_a
+000140c0: 7267 733d 3029 3a0a 2020 2020 2020 2020  rgs=0):.        
+000140d0: 7365 6c66 2e6e 756d 5f61 7267 7320 3d20  self.num_args = 
+000140e0: 6e75 6d5f 6172 6773 0a0a 2020 2020 6465  num_args..    de
+000140f0: 6620 5f5f 6361 6c6c 5f5f 2873 656c 662c  f __call__(self,
+00014100: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00014110: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+00014120: 6c66 2e6e 756d 5f61 7267 7320 3e20 303a  lf.num_args > 0:
+00014130: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00014140: 7572 6e20 284e 6f6e 652c 2920 2a20 7365  urn (None,) * se
+00014150: 6c66 2e6e 756d 5f61 7267 730a 2020 2020  lf.num_args.    
+00014160: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00014170: 6545 7272 6f72 2822 5075 6c6c 6261 636b  eError("Pullback
+00014180: 2063 616c 6c65 6420 6f6e 2061 206e 6f6e   called on a non
+00014190: 2d64 6966 6665 7265 6e74 6961 626c 6520  -differentiable 
+000141a0: 7379 6d62 6f6c 206f 7220 6120 636f 6e73  symbol or a cons
+000141b0: 7461 6e74 2e22 290a 0a0a 636c 6173 7320  tant.")...class 
+000141c0: 5a65 726f 4261 636b 7761 7264 3a0a 2020  ZeroBackward:.  
+000141d0: 2020 2222 2241 2068 656c 7065 7220 6261    """A helper ba
+000141e0: 636b 7761 7264 2066 756e 6374 696f 6e20  ckward function 
+000141f0: 7468 6174 2072 6574 7572 6e73 207a 6572  that returns zer
+00014200: 6f73 2e22 2222 0a0a 2020 2020 6465 6620  os."""..    def 
+00014210: 5f5f 696e 6974 5f5f 2873 656c 662c 206e  __init__(self, n
+00014220: 756d 5f61 7267 7329 3a0a 2020 2020 2020  um_args):.      
+00014230: 2020 7365 6c66 2e6e 756d 5f61 7267 7320    self.num_args 
+00014240: 3d20 6e75 6d5f 6172 6773 0a0a 2020 2020  = num_args..    
+00014250: 6465 6620 5f5f 6361 6c6c 5f5f 2873 656c  def __call__(sel
+00014260: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
+00014270: 6773 293a 0a20 2020 2020 2020 2023 2041  gs):.        # A
+00014280: 7373 756d 696e 6720 7468 6174 2074 6865  ssuming that the
+00014290: 2066 6972 7374 2061 7267 756d 656e 7473   first arguments
+000142a0: 2061 7265 2074 6865 2066 6f72 7761 7264   are the forward
+000142b0: 2061 7267 756d 656e 7473 0a20 2020 2020   arguments.     
+000142c0: 2020 2066 6f72 7761 7264 5f61 7267 7320     forward_args 
+000142d0: 3d20 6172 6773 5b3a 2073 656c 662e 6e75  = args[: self.nu
+000142e0: 6d5f 6172 6773 5d0a 0a20 2020 2020 2020  m_args]..       
+000142f0: 2064 6566 207a 6572 6f73 5f6c 696b 6528   def zeros_like(
+00014300: 7829 3a0a 2020 2020 2020 2020 2020 2020  x):.            
+00014310: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+00014320: 2054 656e 736f 7250 726f 7879 293a 0a20   TensorProxy):. 
+00014330: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00014340: 6574 7572 6e20 6675 6c6c 5f6c 696b 6528  eturn full_like(
+00014350: 782c 2066 696c 6c5f 7661 6c75 653d 3029  x, fill_value=0)
+00014360: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00014370: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+00014380: 4e75 6d62 6572 5072 6f78 7929 3a0a 2020  NumberProxy):.  
+00014390: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000143a0: 7475 726e 2074 7970 6528 782e 7661 6c75  turn type(x.valu
+000143b0: 6529 2830 290a 2020 2020 2020 2020 2020  e)(0).          
+000143c0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+000143d0: 6528 782c 204e 756d 6265 7229 3a0a 2020  e(x, Number):.  
+000143e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000143f0: 7475 726e 2074 7970 6528 7829 2830 290a  turn type(x)(0).
+00014400: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00014410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014420: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00014430: 6f72 2866 227a 6572 6f73 5f6c 696b 6520  or(f"zeros_like 
+00014440: 696e 7369 6465 205a 6572 6f42 6163 6b77  inside ZeroBackw
+00014450: 6172 6420 676f 7420 616e 2075 6e73 7570  ard got an unsup
+00014460: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
+00014470: 6528 7829 7d22 290a 0a20 2020 2020 2020  e(x)}")..       
+00014480: 2072 6574 7572 6e20 7475 706c 6528 7a65   return tuple(ze
+00014490: 726f 735f 6c69 6b65 2861 7267 2920 666f  ros_like(arg) fo
+000144a0: 7220 6172 6720 696e 2066 6f72 7761 7264  r arg in forward
+000144b0: 5f61 7267 7329 0a0a 0a23 204d 6170 7069  _args)...# Mappi
+000144c0: 6e67 2066 726f 6d20 7379 6d62 6f6c 7320  ng from symbols 
+000144d0: 746f 2061 7567 6d65 6e74 6564 2070 7269  to augmented pri
+000144e0: 6d61 6c20 2866 6f72 7761 7264 2920 6675  mal (forward) fu
+000144f0: 6e63 7469 6f6e 7320 7573 6564 2069 6e20  nctions used in 
+00014500: 564a 500a 2320 5468 6520 6175 676d 656e  VJP.# The augmen
+00014510: 7465 645f 7072 696d 616c 2066 756e 6374  ted_primal funct
+00014520: 696f 6e20 7461 6b65 7320 7468 6520 7072  ion takes the pr
+00014530: 696d 616c 2076 616c 7565 7320 616e 6420  imal values and 
+00014540: 7265 7475 726e 7320 7468 6520 7072 696d  returns the prim
+00014550: 616c 0a23 2072 6573 756c 7420 616e 6420  al.# result and 
+00014560: 7468 6520 7265 7369 6475 616c 7320 2873  the residuals (s
+00014570: 6176 6564 2076 616c 7565 7320 666f 7220  aved values for 
+00014580: 7468 6520 6261 636b 7761 7264 292e 0a61  the backward)..a
+00014590: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+000145a0: 5f69 6d70 6c73 203d 207b 0a20 2020 2070  _impls = {.    p
+000145b0: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
+000145c0: 533a 206c 616d 6264 6120 783a 2028 7072  S: lambda x: (pr
+000145d0: 696d 732e 6163 6f73 2878 292c 2028 782c  ims.acos(x), (x,
+000145e0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000145f0: 696d 4944 732e 4143 4f53 483a 206c 616d  imIDs.ACOSH: lam
+00014600: 6264 6120 783a 2028 7072 696d 732e 6163  bda x: (prims.ac
+00014610: 6f73 6828 7829 2c20 2878 2c29 292c 0a20  osh(x), (x,)),. 
+00014620: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014630: 2e41 5349 4e3a 206c 616d 6264 6120 783a  .ASIN: lambda x:
+00014640: 2028 7072 696d 732e 6173 696e 2878 292c   (prims.asin(x),
+00014650: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00014660: 732e 5072 696d 4944 732e 4153 494e 483a  s.PrimIDs.ASINH:
+00014670: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014680: 732e 6173 696e 6828 7829 2c20 2878 2c29  s.asinh(x), (x,)
+00014690: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+000146a0: 6d49 4473 2e41 5441 4e3a 206c 616d 6264  mIDs.ATAN: lambd
+000146b0: 6120 783a 2028 7072 696d 732e 6174 616e  a x: (prims.atan
+000146c0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+000146d0: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
+000146e0: 414e 483a 206c 616d 6264 6120 783a 2028  ANH: lambda x: (
+000146f0: 7072 696d 732e 6174 616e 6828 7829 2c20  prims.atanh(x), 
+00014700: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
+00014710: 2e50 7269 6d49 4473 2e41 5441 4e32 3a20  .PrimIDs.ATAN2: 
+00014720: 6c61 6d62 6461 2078 2c20 793a 2028 7072  lambda x, y: (pr
+00014730: 696d 732e 6174 616e 3228 782c 2079 292c  ims.atan2(x, y),
+00014740: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
+00014750: 696d 732e 5072 696d 4944 732e 434f 5348  ims.PrimIDs.COSH
+00014760: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00014770: 6d73 2e63 6f73 6828 7829 2c20 2878 2c29  ms.cosh(x), (x,)
+00014780: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014790: 6d49 4473 2e44 4947 414d 4d41 3a20 6c61  mIDs.DIGAMMA: la
+000147a0: 6d62 6461 2078 3a20 2870 7269 6d73 2e64  mbda x: (prims.d
+000147b0: 6967 616d 6d61 2878 292c 2028 782c 2929  igamma(x), (x,))
+000147c0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+000147d0: 4944 732e 4552 4643 3a20 6c61 6d62 6461  IDs.ERFC: lambda
+000147e0: 2078 3a20 2870 7269 6d73 2e65 7266 6328   x: (prims.erfc(
+000147f0: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
+00014800: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+00014810: 494e 563a 206c 616d 6264 6120 783a 2028  INV: lambda x: (
+00014820: 7072 696d 732e 6572 6669 6e76 2878 292c  prims.erfinv(x),
+00014830: 2028 7072 696d 732e 6572 6669 6e76 2878   (prims.erfinv(x
+00014840: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
+00014850: 5072 696d 4944 732e 4552 4643 494e 563a  PrimIDs.ERFCINV:
+00014860: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014870: 732e 6572 6663 696e 7628 7829 2c20 2870  s.erfcinv(x), (p
+00014880: 7269 6d73 2e65 7266 6369 6e76 2878 292c  rims.erfcinv(x),
+00014890: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000148a0: 696d 4944 732e 4558 5032 3a20 6c61 6d62  imIDs.EXP2: lamb
+000148b0: 6461 2078 3a20 2870 7269 6d73 2e65 7870  da x: (prims.exp
+000148c0: 3228 7829 2c20 2870 7269 6d73 2e65 7870  2(x), (prims.exp
+000148d0: 3228 7829 2c29 292c 0a20 2020 2070 7269  2(x),)),.    pri
+000148e0: 6d73 2e50 7269 6d49 4473 2e45 5850 4d31  ms.PrimIDs.EXPM1
+000148f0: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00014900: 6d73 2e65 7870 6d31 2878 292c 2028 7072  ms.expm1(x), (pr
+00014910: 696d 732e 6578 706d 3128 7829 2c29 292c  ims.expm1(x),)),
+00014920: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014930: 4473 2e4c 4741 4d4d 413a 206c 616d 6264  Ds.LGAMMA: lambd
+00014940: 6120 783a 2028 7072 696d 732e 6c67 616d  a x: (prims.lgam
+00014950: 6d61 2878 292c 2028 782c 2929 2c0a 2020  ma(x), (x,)),.  
+00014960: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014970: 4e44 5452 493a 206c 616d 6264 6120 783a  NDTRI: lambda x:
+00014980: 2028 7072 696d 732e 6e64 7472 6928 7829   (prims.ndtri(x)
+00014990: 2c20 2870 7269 6d73 2e6e 6474 7269 2878  , (prims.ndtri(x
+000149a0: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
+000149b0: 5072 696d 4944 732e 5349 4e48 3a20 6c61  PrimIDs.SINH: la
+000149c0: 6d62 6461 2078 3a20 2870 7269 6d73 2e73  mbda x: (prims.s
+000149d0: 696e 6828 7829 2c20 2878 2c29 292c 0a20  inh(x), (x,)),. 
+000149e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000149f0: 2e53 5152 543a 206c 616d 6264 6120 783a  .SQRT: lambda x:
+00014a00: 2028 7072 696d 732e 7371 7274 2878 292c   (prims.sqrt(x),
+00014a10: 2028 7072 696d 732e 7371 7274 2878 292c   (prims.sqrt(x),
+00014a20: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00014a30: 696d 4944 732e 4c4f 4731 303a 206c 616d  imIDs.LOG10: lam
+00014a40: 6264 6120 783a 2028 7072 696d 732e 6c6f  bda x: (prims.lo
+00014a50: 6731 3028 7829 2c20 2878 2c29 292c 0a20  g10(x), (x,)),. 
+00014a60: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014a70: 2e4c 4f47 3150 3a20 6c61 6d62 6461 2078  .LOG1P: lambda x
+00014a80: 3a20 2870 7269 6d73 2e6c 6f67 3170 2878  : (prims.log1p(x
+00014a90: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+00014aa0: 696d 732e 5072 696d 4944 732e 4c4f 4732  ims.PrimIDs.LOG2
+00014ab0: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00014ac0: 6d73 2e6c 6f67 3228 7829 2c20 2878 2c29  ms.log2(x), (x,)
+00014ad0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014ae0: 6d49 4473 2e5a 4554 413a 206c 616d 6264  mIDs.ZETA: lambd
+00014af0: 6120 782c 2079 3a20 2870 7269 6d73 2e7a  a x, y: (prims.z
+00014b00: 6574 6128 782c 2079 292c 2028 782c 2079  eta(x, y), (x, y
+00014b10: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00014b20: 696d 4944 732e 464d 4f44 3a20 6c61 6d62  imIDs.FMOD: lamb
+00014b30: 6461 2078 2c20 793a 2028 7072 696d 732e  da x, y: (prims.
+00014b40: 666d 6f64 2878 2c20 7929 2c20 2878 2c20  fmod(x, y), (x, 
+00014b50: 7929 292c 0a20 2020 2070 7269 6d73 2e50  y)),.    prims.P
+00014b60: 7269 6d49 4473 2e43 4f50 595f 3a20 6c61  rimIDs.COPY_: la
+00014b70: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
+00014b80: 732e 636f 7079 5f28 782c 2079 292c 2074  s.copy_(x, y), t
+00014b90: 7570 6c65 2829 292c 0a7d 0a0a 0a23 204d  uple()),.}...# M
+00014ba0: 6170 7069 6e67 2066 726f 6d20 7379 6d62  apping from symb
+00014bb0: 6f6c 7320 746f 2062 6163 6b77 6172 6420  ols to backward 
+00014bc0: 6675 6e63 7469 6f6e 7320 7573 6564 2069  functions used i
+00014bd0: 6e20 564a 500a 2320 5468 6520 6261 636b  n VJP.# The back
+00014be0: 7761 7264 2066 756e 6374 696f 6e20 7461  ward function ta
+00014bf0: 6b65 7320 7468 6520 7265 7369 6475 616c  kes the residual
+00014c00: 7320 616e 6420 636f 7461 6e67 656e 7473  s and cotangents
+00014c10: 2061 6e64 2072 6574 7572 6e73 2074 6865   and returns the
+00014c20: 0a23 2076 6563 746f 722d 4a61 636f 6269  .# vector-Jacobi
+00014c30: 616e 2070 726f 6475 6374 7320 666f 7220  an products for 
+00014c40: 6561 6368 2061 7267 756d 656e 742e 0a62  each argument..b
+00014c50: 6163 6b77 6172 645f 696d 706c 7320 3d20  ackward_impls = 
+00014c60: 7b0a 2020 2020 7072 696d 732e 5072 696d  {.    prims.Prim
+00014c70: 4944 732e 4143 4f53 3a20 6c61 6d62 6461  IDs.ACOS: lambda
+00014c80: 2078 2c20 673a 202d 6720 2f20 7072 696d   x, g: -g / prim
+00014c90: 732e 7371 7274 2831 2e30 202d 2078 202a  s.sqrt(1.0 - x *
+00014ca0: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
+00014cb0: 7269 6d49 4473 2e41 434f 5348 3a20 6c61  rimIDs.ACOSH: la
+00014cc0: 6d62 6461 2078 2c20 673a 2067 202a 2070  mbda x, g: g * p
+00014cd0: 7269 6d73 2e72 7371 7274 2878 202a 2078  rims.rsqrt(x * x
+00014ce0: 202d 2031 2e30 292c 0a20 2020 2070 7269   - 1.0),.    pri
+00014cf0: 6d73 2e50 7269 6d49 4473 2e41 5349 4e3a  ms.PrimIDs.ASIN:
+00014d00: 206c 616d 6264 6120 782c 2067 3a20 6720   lambda x, g: g 
+00014d10: 2f20 7072 696d 732e 7371 7274 2831 2e30  / prims.sqrt(1.0
+00014d20: 202d 2078 202a 2078 292c 0a20 2020 2070   - x * x),.    p
+00014d30: 7269 6d73 2e50 7269 6d49 4473 2e41 5349  rims.PrimIDs.ASI
+00014d40: 4e48 3a20 6c61 6d62 6461 2078 2c20 673a  NH: lambda x, g:
+00014d50: 2067 202a 2070 7269 6d73 2e72 7371 7274   g * prims.rsqrt
+00014d60: 2831 2e30 202b 2078 202a 2078 292c 0a20  (1.0 + x * x),. 
+00014d70: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014d80: 2e41 5441 4e3a 206c 616d 6264 6120 782c  .ATAN: lambda x,
+00014d90: 2067 3a20 6720 2f20 2831 2e30 202b 2078   g: g / (1.0 + x
+00014da0: 202a 2078 292c 0a20 2020 2070 7269 6d73   * x),.    prims
+00014db0: 2e50 7269 6d49 4473 2e41 5441 4e48 3a20  .PrimIDs.ATANH: 
+00014dc0: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
+00014dd0: 2028 312e 3020 2d20 7820 2a20 7829 2c0a   (1.0 - x * x),.
+00014de0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014df0: 732e 434f 5348 3a20 6c61 6d62 6461 2078  s.COSH: lambda x
+00014e00: 2c20 673a 2070 7269 6d73 2e6d 756c 2867  , g: prims.mul(g
+00014e10: 2c20 7072 696d 732e 7369 6e68 2878 2929  , prims.sinh(x))
+00014e20: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014e30: 4944 732e 4552 4643 3a20 6c61 6d62 6461  IDs.ERFC: lambda
+00014e40: 2078 2c20 673a 202d 6720 2a20 322e 3020   x, g: -g * 2.0 
+00014e50: 2f20 6d61 7468 2e73 7172 7428 6d61 7468  / math.sqrt(math
+00014e60: 2e70 6929 202a 2070 7269 6d73 2e65 7870  .pi) * prims.exp
+00014e70: 282d 7820 2a20 7829 2c0a 2020 2020 7072  (-x * x),.    pr
+00014e80: 696d 732e 5072 696d 4944 732e 4552 4649  ims.PrimIDs.ERFI
+00014e90: 4e56 3a20 6c61 6d62 6461 2072 6573 756c  NV: lambda resul
+00014ea0: 742c 2067 3a20 6720 2a20 302e 3520 2a20  t, g: g * 0.5 * 
+00014eb0: 6d61 7468 2e73 7172 7428 6d61 7468 2e70  math.sqrt(math.p
+00014ec0: 6929 202a 2070 7269 6d73 2e65 7870 2872  i) * prims.exp(r
+00014ed0: 6573 756c 742a 2a32 292c 0a20 2020 2070  esult**2),.    p
+00014ee0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+00014ef0: 4349 4e56 3a20 6c61 6d62 6461 2072 6573  CINV: lambda res
+00014f00: 756c 742c 2067 3a20 2d67 202a 2030 2e35  ult, g: -g * 0.5
+00014f10: 202a 206d 6174 682e 7371 7274 286d 6174   * math.sqrt(mat
+00014f20: 682e 7069 2920 2a20 7072 696d 732e 6578  h.pi) * prims.ex
+00014f30: 7028 7265 7375 6c74 2a2a 3229 2c0a 2020  p(result**2),.  
+00014f40: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014f50: 4558 5032 3a20 6c61 6d62 6461 2072 6573  EXP2: lambda res
+00014f60: 756c 742c 2067 3a20 6720 2a20 7265 7375  ult, g: g * resu
+00014f70: 6c74 202a 206d 6174 682e 6c6f 6728 322e  lt * math.log(2.
+00014f80: 3029 2c0a 2020 2020 7072 696d 732e 5072  0),.    prims.Pr
+00014f90: 696d 4944 732e 4558 504d 313a 206c 616d  imIDs.EXPM1: lam
+00014fa0: 6264 6120 7265 7375 6c74 2c20 673a 2067  bda result, g: g
+00014fb0: 202a 2028 7265 7375 6c74 202b 2031 2e30   * (result + 1.0
+00014fc0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014fd0: 6d49 4473 2e4c 4741 4d4d 413a 206c 616d  mIDs.LGAMMA: lam
+00014fe0: 6264 6120 782c 2067 3a20 6720 2a20 7072  bda x, g: g * pr
+00014ff0: 696d 732e 6469 6761 6d6d 6128 7829 2c0a  ims.digamma(x),.
+00015000: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00015010: 732e 4e44 5452 493a 206c 616d 6264 6120  s.NDTRI: lambda 
+00015020: 7265 7375 6c74 2c20 673a 2067 202a 2070  result, g: g * p
+00015030: 7269 6d73 2e65 7870 2830 2e35 202a 2072  rims.exp(0.5 * r
+00015040: 6573 756c 742a 2a32 2920 2a20 6d61 7468  esult**2) * math
+00015050: 2e73 7172 7428 322e 3020 2a20 6d61 7468  .sqrt(2.0 * math
+00015060: 2e70 6929 2c0a 2020 2020 7072 696d 732e  .pi),.    prims.
+00015070: 5072 696d 4944 732e 5349 4e48 3a20 6c61  PrimIDs.SINH: la
+00015080: 6d62 6461 2078 2c20 673a 2070 7269 6d73  mbda x, g: prims
+00015090: 2e6d 756c 2867 2c20 7072 696d 732e 636f  .mul(g, prims.co
+000150a0: 7368 2878 2929 2c0a 2020 2020 7072 696d  sh(x)),.    prim
+000150b0: 732e 5072 696d 4944 732e 5351 5254 3a20  s.PrimIDs.SQRT: 
+000150c0: 6c61 6d62 6461 2072 6573 756c 742c 2067  lambda result, g
+000150d0: 3a20 6720 2f20 2832 2e30 202a 2072 6573  : g / (2.0 * res
+000150e0: 756c 7429 2c0a 2020 2020 7072 696d 732e  ult),.    prims.
+000150f0: 5072 696d 4944 732e 4c4f 4731 303a 206c  PrimIDs.LOG10: l
+00015100: 616d 6264 6120 782c 2067 3a20 6720 2f20  ambda x, g: g / 
+00015110: 2878 202a 2032 2e33 3032 3538 3530 3932  (x * 2.302585092
+00015120: 3939 3430 3436 292c 0a20 2020 2070 7269  994046),.    pri
+00015130: 6d73 2e50 7269 6d49 4473 2e4c 4f47 3150  ms.PrimIDs.LOG1P
+00015140: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
+00015150: 202f 2028 7820 2b20 3129 2c0a 2020 2020   / (x + 1),.    
+00015160: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
+00015170: 4732 3a20 6c61 6d62 6461 2078 2c20 673a  G2: lambda x, g:
+00015180: 2067 202f 2028 7820 2a20 302e 3639 3331   g / (x * 0.6931
+00015190: 3437 3138 3035 3539 3934 3533 292c 0a20  471805599453),. 
+000151a0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000151b0: 2e46 4d4f 443a 206c 616d 6264 6120 782c  .FMOD: lambda x,
+000151c0: 2079 2c20 673a 2028 672c 202d 6720 2a20   y, g: (g, -g * 
+000151d0: 7072 696d 732e 7472 756e 6328 7820 2f20  prims.trunc(x / 
+000151e0: 7929 292c 0a20 2020 2023 2054 6865 2063  y)),.    # The c
+000151f0: 6f70 7920 7368 6f75 6c64 206e 6f74 2062  opy should not b
+00015200: 6520 6469 6666 6572 656e 7469 6162 6c65  e differentiable
+00015210: 2e20 5765 2072 6574 7572 6e20 4e6f 6e65  . We return None
+00015220: 2074 6f20 656e 6162 6c65 2074 6865 2067   to enable the g
+00015230: 656e 6572 6174 696f 6e20 6f66 2074 6865  eneration of the
+00015240: 2062 6163 6b77 6172 6420 6772 6170 6820   backward graph 
+00015250: 7468 726f 7567 6820 7468 656d 2e0a 2020  through them..  
+00015260: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00015270: 434f 5059 5f3a 206c 616d 6264 6120 673a  COPY_: lambda g:
+00015280: 2028 4e6f 6e65 2c20 4e6f 6e65 292c 0a7d   (None, None),.}
+00015290: 0a0a 0a64 6566 2072 6567 6973 7465 725f  ...def register_
+000152a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+000152b0: 6428 6f70 293a 0a20 2020 2022 2222 4465  d(op):.    """De
+000152c0: 636f 7261 746f 7220 746f 2072 6567 6973  corator to regis
+000152d0: 7465 7220 616e 2061 7567 6d65 6e74 6564  ter an augmented
+000152e0: 2066 6f72 7761 7264 2069 6d70 6c65 6d65   forward impleme
+000152f0: 6e74 6174 696f 6e20 666f 7220 6120 7379  ntation for a sy
+00015300: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
+00015310: 0a20 2020 2020 2020 206f 7020 284f 7073  .        op (Ops
+00015320: 293a 2053 796d 626f 6c20 666f 7220 7768  ): Symbol for wh
+00015330: 6963 6820 746f 2072 6567 6973 7465 7220  ich to register 
+00015340: 7468 6520 6175 676d 656e 7465 6420 666f  the augmented fo
+00015350: 7277 6172 6420 696d 706c 656d 656e 7461  rward implementa
+00015360: 7469 6f6e 2e0a 0a20 2020 2052 6574 7572  tion...    Retur
+00015370: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+00015380: 6162 6c65 3a20 4465 636f 7261 746f 7220  able: Decorator 
+00015390: 6675 6e63 7469 6f6e 2e0a 2020 2020 2222  function..    ""
+000153a0: 220a 0a20 2020 2064 6566 2064 6563 6f72  "..    def decor
+000153b0: 6174 6f72 2866 756e 6329 3a0a 2020 2020  ator(func):.    
+000153c0: 2020 2020 6175 676d 656e 7465 645f 666f      augmented_fo
+000153d0: 7277 6172 645f 696d 706c 735b 6f70 5d20  rward_impls[op] 
+000153e0: 3d20 6675 6e63 0a20 2020 2020 2020 2072  = func.        r
+000153f0: 6574 7572 6e20 6675 6e63 0a0a 2020 2020  eturn func..    
+00015400: 7265 7475 726e 2064 6563 6f72 6174 6f72  return decorator
+00015410: 0a0a 0a64 6566 2072 6567 6973 7465 725f  ...def register_
+00015420: 6261 636b 7761 7264 286f 7029 3a0a 2020  backward(op):.  
+00015430: 2020 2222 2244 6563 6f72 6174 6f72 2074    """Decorator t
+00015440: 6f20 7265 6769 7374 6572 2061 2062 6163  o register a bac
+00015450: 6b77 6172 6420 696d 706c 656d 656e 7461  kward implementa
+00015460: 7469 6f6e 2066 6f72 2061 2073 796d 626f  tion for a symbo
+00015470: 6c2e 0a0a 2020 2020 4172 6773 3a0a 2020  l...    Args:.  
+00015480: 2020 2020 2020 6f70 2028 4f70 7329 3a20        op (Ops): 
+00015490: 5379 6d62 6f6c 2066 6f72 2077 6869 6368  Symbol for which
+000154a0: 2074 6f20 7265 6769 7374 6572 2074 6865   to register the
+000154b0: 2062 6163 6b77 6172 6420 696d 706c 656d   backward implem
+000154c0: 656e 7461 7469 6f6e 2e0a 0a20 2020 2052  entation...    R
+000154d0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000154e0: 4361 6c6c 6162 6c65 3a20 4465 636f 7261  Callable: Decora
+000154f0: 746f 7220 6675 6e63 7469 6f6e 2e0a 2020  tor function..  
+00015500: 2020 2222 220a 0a20 2020 2064 6566 2064    """..    def d
+00015510: 6563 6f72 6174 6f72 2866 756e 6329 3a0a  ecorator(func):.
+00015520: 2020 2020 2020 2020 6261 636b 7761 7264          backward
+00015530: 5f69 6d70 6c73 5b6f 705d 203d 2066 756e  _impls[op] = fun
+00015540: 630a 2020 2020 2020 2020 7265 7475 726e  c.        return
+00015550: 2066 756e 630a 0a20 2020 2072 6574 7572   func..    retur
+00015560: 6e20 6465 636f 7261 746f 720a 0a0a 6465  n decorator...de
+00015570: 6620 7265 7374 6f72 655f 7265 6475 6365  f restore_reduce
+00015580: 645f 6469 6d73 2878 2c20 7265 6475 6365  d_dims(x, reduce
+00015590: 645f 6469 6d73 2c20 6f72 6967 696e 616c  d_dims, original
+000155a0: 5f73 6861 7065 293a 0a20 2020 2022 2222  _shape):.    """
+000155b0: 5265 7374 6f72 6573 2074 6865 2072 6564  Restores the red
+000155c0: 7563 6564 2064 696d 656e 7369 6f6e 7320  uced dimensions 
+000155d0: 6f66 2061 2074 656e 736f 722e 0a0a 2020  of a tensor...  
+000155e0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000155f0: 7820 2856 6172 6961 626c 6529 3a20 5465  x (Variable): Te
+00015600: 6e73 6f72 2074 6f20 6265 2072 6573 6861  nsor to be resha
+00015610: 7065 642e 0a20 2020 2020 2020 2072 6564  ped..        red
+00015620: 7563 6564 5f64 696d 7320 2854 7570 6c65  uced_dims (Tuple
+00015630: 5b69 6e74 2c20 2e2e 2e5d 293a 2054 7570  [int, ...]): Tup
+00015640: 6c65 206f 6620 7265 6475 6365 6420 6469  le of reduced di
+00015650: 6d65 6e73 696f 6e73 2e0a 2020 2020 2020  mensions..      
+00015660: 2020 6f72 6967 696e 616c 5f73 6861 7065    original_shape
+00015670: 2028 5475 706c 655b 696e 742c 202e 2e2e   (Tuple[int, ...
+00015680: 5d29 3a20 4f72 6967 696e 616c 2073 6861  ]): Original sha
+00015690: 7065 206f 6620 7468 6520 7465 6e73 6f72  pe of the tensor
+000156a0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+000156b0: 2020 2020 2020 2020 5661 7269 6162 6c65          Variable
+000156c0: 3a20 5465 6e73 6f72 2077 6974 6820 7468  : Tensor with th
+000156d0: 6520 7265 6475 6365 6420 6469 6d65 6e73  e reduced dimens
+000156e0: 696f 6e73 2072 6573 746f 7265 642e 0a20  ions restored.. 
+000156f0: 2020 2022 2222 0a20 2020 2069 6620 6f72     """.    if or
+00015700: 6967 696e 616c 5f73 6861 7065 203d 3d20  iginal_shape == 
+00015710: 2829 3a20 2023 2073 6361 6c61 720a 2020  ():  # scalar.  
+00015720: 2020 2020 2020 7265 7475 726e 2078 0a0a        return x..
+00015730: 2020 2020 756e 7371 7565 657a 6564 203d      unsqueezed =
+00015740: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
+00015750: 2878 2c20 7265 6475 6365 645f 6469 6d73  (x, reduced_dims
+00015760: 290a 2020 2020 7265 7475 726e 2063 6c61  ).    return cla
+00015770: 6e67 2e65 7870 616e 6428 756e 7371 7565  ng.expand(unsque
+00015780: 657a 6564 2c20 6f72 6967 696e 616c 5f73  ezed, original_s
+00015790: 6861 7065 290a 0a0a 4072 6567 6973 7465  hape)...@registe
+000157a0: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+000157b0: 2e50 7269 6d49 4473 2e5a 4554 4129 0a64  .PrimIDs.ZETA).d
+000157c0: 6566 207a 6574 615f 6261 636b 7761 7264  ef zeta_backward
+000157d0: 2878 2c20 792c 2067 293a 0a20 2020 2023  (x, y, g):.    #
+000157e0: 2054 6865 2064 6572 6976 6174 6976 6520   The derivative 
+000157f0: 7772 7420 7468 6520 6669 7273 7420 6172  wrt the first ar
+00015800: 6775 6d65 6e74 2069 7320 6e6f 7420 6578  gument is not ex
+00015810: 7072 6573 7369 626c 6520 696e 2074 6572  pressible in ter
+00015820: 6d73 206f 6620 7a65 7461 206f 720a 2020  ms of zeta or.  
+00015830: 2020 2320 6f74 6865 7220 7370 6563 6961    # other specia
+00015840: 6c20 6675 6e63 7469 6f6e 730a 2020 2020  l functions.    
+00015850: 2320 5468 6572 6566 6f72 652c 2077 6520  # Therefore, we 
+00015860: 636f 6d70 7574 6520 6f6e 6c79 2074 6865  compute only the
+00015870: 2064 6572 6976 6174 6976 6520 7772 7420   derivative wrt 
+00015880: 7468 6520 7365 636f 6e64 2061 7267 756d  the second argum
+00015890: 656e 740a 2020 2020 6779 203d 2067 202a  ent.    gy = g *
+000158a0: 202d 7820 2a20 7072 696d 732e 7a65 7461   -x * prims.zeta
+000158b0: 2878 202b 2031 2e30 2c20 7929 0a0a 2020  (x + 1.0, y)..  
+000158c0: 2020 2320 5265 7475 726e 2061 206d 6170    # Return a map
+000158d0: 7070 696e 6720 6672 6f6d 2074 6865 2066  pping from the f
+000158e0: 6f72 7761 7264 2061 7267 756d 656e 7473  orward arguments
+000158f0: 2074 6f20 7468 6520 6772 6164 6965 6e74   to the gradient
+00015900: 730a 2020 2020 7265 7475 726e 207b 2279  s.    return {"y
+00015910: 223a 2067 797d 0a0a 0a40 7265 6769 7374  ": gy}...@regist
+00015920: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00015930: 732e 5072 696d 4944 732e 4449 4741 4d4d  s.PrimIDs.DIGAMM
+00015940: 4129 0a64 6566 2064 6967 616d 6d61 5f62  A).def digamma_b
+00015950: 6163 6b77 6172 6428 613a 2050 726f 7879  ackward(a: Proxy
+00015960: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
+00015970: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00015980: 6f72 7420 706f 6c79 6761 6d6d 610a 0a20  ort polygamma.. 
+00015990: 2020 2072 6574 7572 6e20 6720 2a20 706f     return g * po
+000159a0: 6c79 6761 6d6d 6128 312c 2061 290a 0a0a  lygamma(1, a)...
+000159b0: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+000159c0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
+000159d0: 6368 2e70 6f6c 7967 616d 6d61 2229 0a64  ch.polygamma").d
+000159e0: 6566 2070 6f6c 7967 616d 6d61 5f61 7567  ef polygamma_aug
+000159f0: 5f66 7764 286e 3a20 696e 742c 2061 3a20  _fwd(n: int, a: 
+00015a00: 5072 6f78 7929 3a0a 2020 2020 6672 6f6d  Proxy):.    from
+00015a10: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00015a20: 6d70 6f72 7420 706f 6c79 6761 6d6d 610a  mport polygamma.
+00015a30: 0a20 2020 2070 7269 6d61 6c20 3d20 706f  .    primal = po
+00015a40: 6c79 6761 6d6d 6128 6e2c 2061 290a 2020  lygamma(n, a).  
+00015a50: 2020 7265 7369 6475 616c 7320 3d20 286e    residuals = (n
+00015a60: 2c20 6129 0a20 2020 2072 6574 7572 6e20  , a).    return 
+00015a70: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00015a80: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00015a90: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00015aa0: 2274 6f72 6368 2e70 6f6c 7967 616d 6d61  "torch.polygamma
+00015ab0: 2229 0a64 6566 2070 6f6c 7967 616d 6d61  ").def polygamma
+00015ac0: 5f62 6163 6b77 6172 6428 6e3a 2069 6e74  _backward(n: int
+00015ad0: 2c20 613a 2050 726f 7879 2c20 6729 3a0a  , a: Proxy, g):.
+00015ae0: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+00015af0: 2e74 6f72 6368 2069 6d70 6f72 7420 706f  .torch import po
+00015b00: 6c79 6761 6d6d 610a 0a20 2020 2072 6574  lygamma..    ret
+00015b10: 7572 6e20 4e6f 6e65 2c20 6720 2a20 706f  urn None, g * po
+00015b20: 6c79 6761 6d6d 6128 6e20 2b20 312c 2061  lygamma(n + 1, a
+00015b30: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
+00015b40: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
+00015b50: 6d49 4473 2e41 5441 4e32 290a 6465 6620  mIDs.ATAN2).def 
+00015b60: 6174 616e 325f 6261 636b 7761 7264 2878  atan2_backward(x
+00015b70: 2c20 792c 2067 293a 0a20 2020 2061 6c70  , y, g):.    alp
+00015b80: 6861 203d 2031 2e30 202f 2028 7820 2a20  ha = 1.0 / (x * 
+00015b90: 7820 2b20 7920 2a20 7929 0a20 2020 2067  x + y * y).    g
+00015ba0: 7261 645f 7820 3d20 6720 2a20 7920 2a20  rad_x = g * y * 
+00015bb0: 616c 7068 610a 2020 2020 6772 6164 5f79  alpha.    grad_y
+00015bc0: 203d 2067 202a 202d 7820 2a20 616c 7068   = g * -x * alph
+00015bd0: 610a 2020 2020 7265 7475 726e 2067 7261  a.    return gra
+00015be0: 645f 782c 2067 7261 645f 790a 0a0a 4072  d_x, grad_y...@r
+00015bf0: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+00015c00: 645f 666f 7277 6172 6428 7072 696d 732e  d_forward(prims.
+00015c10: 5072 696d 4944 732e 5641 5229 0a64 6566  PrimIDs.VAR).def
+00015c20: 2076 6172 5f61 7567 5f66 7764 2861 2c20   var_aug_fwd(a, 
+00015c30: 6469 6d2c 202a 2c20 636f 7272 6563 7469  dim, *, correcti
+00015c40: 6f6e 293a 0a20 2020 2076 203d 2070 7269  on):.    v = pri
+00015c50: 6d73 2e76 6172 2861 2c20 6469 6d2c 2063  ms.var(a, dim, c
+00015c60: 6f72 7265 6374 696f 6e3d 636f 7272 6563  orrection=correc
+00015c70: 7469 6f6e 290a 2020 2020 7265 7475 726e  tion).    return
+00015c80: 2056 4a50 4475 616c 2828 762c 292c 2028   VJPDual((v,), (
+00015c90: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
+00015ca0: 6f6e 2c20 7629 290a 0a0a 2320 544f 444f  on, v))...# TODO
+00015cb0: 3a20 6669 7820 6469 7669 7369 6f6e 2062  : fix division b
+00015cc0: 7920 7a65 726f 2077 6865 6e20 6e5f 656c  y zero when n_el
+00015cd0: 656d 5f72 6564 7563 6564 203d 3d20 3020  em_reduced == 0 
+00015ce0: 6f72 2077 6865 6e20 762e 6e75 6d65 6c20  or when v.numel 
+00015cf0: 3d3d 2030 0a23 2062 7920 7265 7475 726e  == 0.# by return
+00015d00: 696e 6720 7a65 726f 735f 6c69 6b65 2861  ing zeros_like(a
+00015d10: 2920 6f72 2073 696d 696c 6172 2e0a 2320  ) or similar..# 
+00015d20: 544f 444f 3a20 6669 7820 6772 6164 2077  TODO: fix grad w
+00015d30: 6865 6e20 636f 7272 6563 7469 6f6e 203e  hen correction >
+00015d40: 206e 5f65 6c65 6d5f 7265 6475 6365 642e   n_elem_reduced.
+00015d50: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00015d60: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+00015d70: 732e 5641 5229 0a64 6566 2076 6172 5f62  s.VAR).def var_b
+00015d80: 6163 6b77 6172 6428 612c 2064 696d 2c20  ackward(a, dim, 
+00015d90: 636f 7272 6563 7469 6f6e 2c20 762c 2067  correction, v, g
+00015da0: 293a 0a20 2020 206e 5f65 6c65 6d5f 7265  ):.    n_elem_re
+00015db0: 6475 6365 6420 3d20 612e 6e75 6d65 6c28  duced = a.numel(
+00015dc0: 2920 2f2f 2076 2e6e 756d 656c 2829 2069  ) // v.numel() i
+00015dd0: 6620 612e 6e75 6d65 6c28 2920 213d 2030  f a.numel() != 0
+00015de0: 2065 6c73 6520 310a 2020 2020 6e6f 726d   else 1.    norm
+00015df0: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
+00015e00: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
+00015e10: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
+00015e20: 2020 2067 203d 2072 6573 746f 7265 5f72     g = restore_r
+00015e30: 6564 7563 6564 5f64 696d 7328 672c 2064  educed_dims(g, d
+00015e40: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
+00015e50: 2069 6620 612e 6474 7970 6520 213d 2076   if a.dtype != v
+00015e60: 2e64 7479 7065 3a0a 2020 2020 2020 2020  .dtype:.        
+00015e70: 6120 3d20 7072 696d 732e 636f 6e76 6572  a = prims.conver
+00015e80: 745f 656c 656d 656e 745f 7479 7065 2861  t_element_type(a
+00015e90: 2c20 762e 6474 7970 6529 0a20 2020 206d  , v.dtype).    m
+00015ea0: 6561 6e20 3d20 7072 696d 732e 7375 6d28  ean = prims.sum(
+00015eb0: 612c 2064 696d 2920 2f20 6e5f 656c 656d  a, dim) / n_elem
+00015ec0: 5f72 6564 7563 6564 0a20 2020 206d 6561  _reduced.    mea
+00015ed0: 6e20 3d20 7265 7374 6f72 655f 7265 6475  n = restore_redu
+00015ee0: 6365 645f 6469 6d73 286d 6561 6e2c 2064  ced_dims(mean, d
+00015ef0: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
+00015f00: 2072 6574 7572 6e20 2832 202a 2067 202a   return (2 * g *
+00015f10: 2028 6120 2d20 6d65 616e 2929 202f 206e   (a - mean)) / n
+00015f20: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
+00015f30: 6c61 720a 0a0a 6465 6620 6e5f 656c 656d  lar...def n_elem
+00015f40: 5f72 6564 7563 6564 2861 5f6e 6469 6d2c  _reduced(a_ndim,
+00015f50: 2061 5f73 6861 7065 2c20 6469 6d73 293a   a_shape, dims):
+00015f60: 0a20 2020 2064 696d 7320 3d20 7574 696c  .    dims = util
+00015f70: 732e 6361 6e6f 6e69 6361 6c69 7a65 5f64  s.canonicalize_d
+00015f80: 696d 7328 615f 6e64 696d 2c20 6469 6d73  ims(a_ndim, dims
+00015f90: 290a 2020 2020 7265 6475 6374 696f 6e5f  ).    reduction_
+00015fa0: 7369 7a65 203d 2031 0a20 2020 2066 6f72  size = 1.    for
+00015fb0: 2069 6478 2c20 7369 7a65 2069 6e20 656e   idx, size in en
+00015fc0: 756d 6572 6174 6528 615f 7368 6170 6529  umerate(a_shape)
+00015fd0: 3a0a 2020 2020 2020 2020 6966 2069 6478  :.        if idx
+00015fe0: 2069 6e20 6469 6d73 3a0a 2020 2020 2020   in dims:.      
+00015ff0: 2020 2020 2020 7265 6475 6374 696f 6e5f        reduction_
+00016000: 7369 7a65 202a 3d20 7369 7a65 0a20 2020  size *= size.   
+00016010: 2072 6574 7572 6e20 7265 6475 6374 696f   return reductio
+00016020: 6e5f 7369 7a65 0a0a 0a64 6566 206d 6561  n_size...def mea
+00016030: 6e5f 6261 636b 7761 7264 2861 5f6e 6469  n_backward(a_ndi
+00016040: 6d2c 2061 5f73 6861 7065 2c20 6469 6d73  m, a_shape, dims
+00016050: 2c20 6772 6164 293a 0a20 2020 206d 6561  , grad):.    mea
+00016060: 6e5f 6c6f 6361 6c5f 6772 6164 203d 2031  n_local_grad = 1
+00016070: 2e30 202f 206e 5f65 6c65 6d5f 7265 6475  .0 / n_elem_redu
+00016080: 6365 6428 615f 6e64 696d 2c20 615f 7368  ced(a_ndim, a_sh
+00016090: 6170 652c 2064 696d 7329 0a20 2020 2072  ape, dims).    r
+000160a0: 6574 7572 6e20 7265 7374 6f72 655f 7265  eturn restore_re
+000160b0: 6475 6365 645f 6469 6d73 2867 7261 642c  duced_dims(grad,
+000160c0: 2064 696d 732c 2061 5f73 6861 7065 2920   dims, a_shape) 
+000160d0: 2a20 6d65 616e 5f6c 6f63 616c 5f67 7261  * mean_local_gra
+000160e0: 640a 0a0a 4072 6567 6973 7465 725f 6175  d...@register_au
+000160f0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+00016100: 7072 696d 732e 5072 696d 4944 732e 5041  prims.PrimIDs.PA
+00016110: 4429 0a64 6566 2070 6164 5f61 7567 5f66  D).def pad_aug_f
+00016120: 7764 2861 2c20 7061 6464 696e 675f 7661  wd(a, padding_va
+00016130: 6c75 652c 2070 6164 6469 6e67 5f63 6f6e  lue, padding_con
+00016140: 6669 6729 3a0a 2020 2020 7265 7475 726e  fig):.    return
+00016150: 2056 4a50 4475 616c 2828 7072 696d 732e   VJPDual((prims.
+00016160: 7061 6428 612c 2070 6164 6469 6e67 5f76  pad(a, padding_v
+00016170: 616c 7565 2c20 7061 6464 696e 675f 636f  alue, padding_co
+00016180: 6e66 6967 292c 292c 2028 612c 2070 6164  nfig),), (a, pad
+00016190: 6469 6e67 5f63 6f6e 6669 6729 290a 0a0a  ding_config))...
+000161a0: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+000161b0: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+000161c0: 2e50 4144 290a 6465 6620 7061 645f 6261  .PAD).def pad_ba
+000161d0: 636b 7761 7264 2861 2c20 7061 6464 696e  ckward(a, paddin
+000161e0: 675f 636f 6e66 6967 2c20 6729 3a0a 2020  g_config, g):.  
+000161f0: 2020 2320 5368 6f72 7420 6369 7263 7569    # Short circui
+00016200: 7420 6f6e 2065 6d70 7479 2069 6e70 7574  t on empty input
+00016210: 2e0a 2020 2020 6966 2061 6e79 2864 696d  ..    if any(dim
+00016220: 203d 3d20 3020 666f 7220 6469 6d20 696e   == 0 for dim in
+00016230: 2061 2e73 6861 7065 293a 0a20 2020 2020   a.shape):.     
+00016240: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
+00016250: 696b 6528 612c 2066 696c 6c5f 7661 6c75  ike(a, fill_valu
+00016260: 653d 3029 0a0a 2020 2020 2320 556e 2d70  e=0)..    # Un-p
+00016270: 6164 2062 7920 7061 6464 696e 6720 7769  ad by padding wi
+00016280: 7468 207a 6572 6f20 7661 6c75 6573 0a20  th zero values. 
+00016290: 2020 207a 6572 6f5f 7061 6464 696e 675f     zero_padding_
+000162a0: 636f 6e66 6967 203d 205b 282d 6c6f 2c20  config = [(-lo, 
+000162b0: 2d68 692c 2030 2920 666f 7220 6c6f 2c20  -hi, 0) for lo, 
+000162c0: 6869 2c20 5f20 696e 2070 6164 6469 6e67  hi, _ in padding
+000162d0: 5f63 6f6e 6669 675d 0a0a 2020 2020 6720  _config]..    g 
+000162e0: 3d20 7072 696d 732e 7061 6428 672c 2030  = prims.pad(g, 0
+000162f0: 2e30 2c20 7a65 726f 5f70 6164 6469 6e67  .0, zero_padding
+00016300: 5f63 6f6e 6669 6729 0a0a 2020 2020 2320  _config)..    # 
+00016310: 556e 2d73 6c69 6365 2062 7920 736c 6963  Un-slice by slic
+00016320: 696e 6720 7769 7468 2061 2073 7472 6964  ing with a strid
+00016330: 6520 6f66 2076 616c 7565 2028 6469 6c61  e of value (dila
+00016340: 7469 6f6e 202b 2031 290a 2020 2020 666f  tion + 1).    fo
+00016350: 7220 6469 6d2c 2028 5f2c 205f 2c20 6429  r dim, (_, _, d)
+00016360: 2069 6e20 656e 756d 6572 6174 6528 7061   in enumerate(pa
+00016370: 6464 696e 675f 636f 6e66 6967 293a 0a20  dding_config):. 
+00016380: 2020 2020 2020 2067 203d 2073 6c69 6365         g = slice
+00016390: 5f69 6e5f 6469 6d28 672c 2030 2c20 672e  _in_dim(g, 0, g.
+000163a0: 7368 6170 655b 6469 6d5d 2c20 7374 7269  shape[dim], stri
+000163b0: 6465 3d64 202b 2031 2c20 6469 6d3d 6469  de=d + 1, dim=di
+000163c0: 6d29 0a0a 2020 2020 7265 7475 726e 2067  m)..    return g
+000163d0: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+000163e0: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+000163f0: 7269 6d73 2e50 7269 6d49 4473 2e50 524f  rims.PrimIDs.PRO
+00016400: 4429 0a64 6566 2070 726f 645f 6175 675f  D).def prod_aug_
+00016410: 6677 6428 782c 2064 696d 7329 3a0a 2020  fwd(x, dims):.  
+00016420: 2020 2222 2241 7567 6d65 6e74 6564 2070    """Augmented p
+00016430: 726f 6420 6f70 6572 6174 696f 6e2e 0a0a  rod operation...
+00016440: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00016450: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
+00016460: 5465 6e73 6f72 2074 6f20 6265 206d 756c  Tensor to be mul
+00016470: 7469 706c 6965 642e 0a20 2020 2020 2020  tiplied..       
+00016480: 2064 696d 7320 2854 7570 6c65 5b69 6e74   dims (Tuple[int
+00016490: 2c20 2e2e 2e5d 293a 2044 696d 656e 7369  , ...]): Dimensi
+000164a0: 6f6e 7320 746f 2062 6520 6d75 6c74 6970  ons to be multip
+000164b0: 6c69 6564 2e0a 0a20 2020 2052 6574 7572  lied...    Retur
+000164c0: 6e73 3a0a 2020 2020 2020 2020 564a 5044  ns:.        VJPD
+000164d0: 7561 6c3a 2050 7269 6d61 6c20 616e 6420  ual: Primal and 
+000164e0: 7265 7369 6475 616c 732e 0a20 2020 2022  residuals..    "
+000164f0: 2222 0a20 2020 2070 7269 6d61 6c20 3d20  "".    primal = 
+00016500: 7072 696d 732e 7072 6f64 2878 2c20 6469  prims.prod(x, di
+00016510: 6d73 290a 0a20 2020 2072 6573 6964 7561  ms)..    residua
+00016520: 6c73 203d 2028 0a20 2020 2020 2020 2070  ls = (.        p
+00016530: 7269 6d61 6c2c 0a20 2020 2020 2020 2078  rimal,.        x
+00016540: 2c0a 2020 2020 2020 2020 782e 7368 6170  ,.        x.shap
+00016550: 652c 0a20 2020 2020 2020 2064 696d 732c  e,.        dims,
+00016560: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
+00016570: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+00016580: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
+00016590: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+000165a0: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+000165b0: 5052 4f44 290a 6465 6620 7072 6f64 5f70  PROD).def prod_p
+000165c0: 756c 6c62 6163 6b28 7072 696d 616c 2c20  ullback(primal, 
+000165d0: 782c 2078 5f73 6861 7065 2c20 7265 6475  x, x_shape, redu
+000165e0: 6365 645f 6469 6d73 2c20 6729 3a0a 2020  ced_dims, g):.  
+000165f0: 2020 7265 7475 726e 2070 7269 6d73 2e64    return prims.d
+00016600: 6976 2872 6573 746f 7265 5f72 6564 7563  iv(restore_reduc
+00016610: 6564 5f64 696d 7328 7072 696d 616c 202a  ed_dims(primal *
+00016620: 2067 2c20 7265 6475 6365 645f 6469 6d73   g, reduced_dims
+00016630: 2c20 785f 7368 6170 6529 2c20 7829 0a0a  , x_shape), x)..
+00016640: 0a64 6566 206b 6565 7064 696d 5f72 6564  .def keepdim_red
+00016650: 7563 7469 6f6e 2872 6564 7563 7469 6f6e  uction(reduction
+00016660: 5f66 6e2c 2078 2c20 6469 6d73 293a 0a20  _fn, x, dims):. 
+00016670: 2020 2022 2222 4170 706c 6965 7320 7265     """Applies re
+00016680: 6475 6374 696f 6e20 616e 6420 6669 7865  duction and fixe
+00016690: 7320 6f75 7470 7574 2074 6f20 636f 6e66  s output to conf
+000166a0: 6f72 6d20 746f 206b 6565 7064 696d 3d54  orm to keepdim=T
+000166b0: 7275 6522 2222 0a20 2020 206f 7574 203d  rue""".    out =
+000166c0: 2072 6564 7563 7469 6f6e 5f66 6e28 782c   reduction_fn(x,
+000166d0: 2064 696d 7329 0a20 2020 2061 7267 6d61   dims).    argma
+000166e0: 785f 7375 6d5f 6f75 745f 7368 6170 6520  x_sum_out_shape 
+000166f0: 3d20 5b78 2e73 6861 7065 5b69 5d20 6966  = [x.shape[i] if
+00016700: 2069 206e 6f74 2069 6e20 6469 6d73 2065   i not in dims e
+00016710: 6c73 6520 3120 666f 7220 6920 696e 2072  lse 1 for i in r
+00016720: 616e 6765 2878 2e6e 6469 6d29 5d0a 2020  ange(x.ndim)].  
+00016730: 2020 6272 6f61 6463 6173 745f 6469 6d73    broadcast_dims
+00016740: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
+00016750: 616e 6765 2878 2e6e 6469 6d29 2069 6620  ange(x.ndim) if 
+00016760: 6920 6e6f 7420 696e 2064 696d 735d 0a20  i not in dims]. 
+00016770: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+00016780: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
+00016790: 286f 7574 2c20 6172 676d 6178 5f73 756d  (out, argmax_sum
+000167a0: 5f6f 7574 5f73 6861 7065 2c20 6272 6f61  _out_shape, broa
+000167b0: 6463 6173 745f 6469 6d73 290a 0a0a 2320  dcast_dims)...# 
+000167c0: 496e 7370 6972 6564 2066 726f 6d20 6874  Inspired from ht
+000167d0: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+000167e0: 2f48 4950 532f 6175 746f 6772 6164 2f62  /HIPS/autograd/b
+000167f0: 6c6f 622f 6d61 7374 6572 2f61 7574 6f67  lob/master/autog
+00016800: 7261 642f 6e75 6d70 792f 6e75 6d70 795f  rad/numpy/numpy_
+00016810: 766a 7073 2e70 7923 4c33 3533 0a64 6566  vjps.py#L353.def
+00016820: 2067 7261 645f 6368 6f6f 7365 725f 6261   grad_chooser_ba
+00016830: 636b 7761 7264 2870 7269 6d61 6c2c 2078  ckward(primal, x
+00016840: 2c20 785f 7368 6170 652c 2072 6564 7563  , x_shape, reduc
+00016850: 6564 5f64 696d 732c 2067 293a 0a20 2020  ed_dims, g):.   
+00016860: 2022 2222 4275 696c 6473 2067 7261 6469   """Builds gradi
+00016870: 656e 7420 6f66 2066 756e 6374 696f 6e73  ent of functions
+00016880: 2074 6861 7420 6368 6f6f 7365 2061 2073   that choose a s
+00016890: 696e 676c 6520 6974 656d 2c20 7375 6368  ingle item, such
+000168a0: 2061 7320 6d69 6e20 6f72 206d 6178 2e22   as min or max."
+000168b0: 2222 0a20 2020 2067 5f72 6570 6561 7465  "".    g_repeate
+000168c0: 6420 3d20 7265 7374 6f72 655f 7265 6475  d = restore_redu
+000168d0: 6365 645f 6469 6d73 2867 2c20 7265 6475  ced_dims(g, redu
+000168e0: 6365 645f 6469 6d73 2c20 785f 7368 6170  ced_dims, x_shap
+000168f0: 6529 0a20 2020 2070 7269 6d61 6c5f 7265  e).    primal_re
+00016900: 7065 6174 6564 203d 2072 6573 746f 7265  peated = restore
+00016910: 5f72 6564 7563 6564 5f64 696d 7328 7072  _reduced_dims(pr
+00016920: 696d 616c 2c20 7265 6475 6365 645f 6469  imal, reduced_di
+00016930: 6d73 2c20 785f 7368 6170 6529 0a20 2020  ms, x_shape).   
+00016940: 2061 7267 6d61 785f 6c6f 6361 7469 6f6e   argmax_location
+00016950: 7320 3d20 7820 3d3d 2070 7269 6d61 6c5f  s = x == primal_
+00016960: 7265 7065 6174 6564 0a20 2020 2061 7267  repeated.    arg
+00016970: 6d61 785f 7375 6d20 3d20 6b65 6570 6469  max_sum = keepdi
+00016980: 6d5f 7265 6475 6374 696f 6e28 7072 696d  m_reduction(prim
+00016990: 732e 7375 6d2c 2061 7267 6d61 785f 6c6f  s.sum, argmax_lo
+000169a0: 6361 7469 6f6e 732c 2072 6564 7563 6564  cations, reduced
+000169b0: 5f64 696d 7329 0a20 2020 206f 7574 203d  _dims).    out =
+000169c0: 2067 5f72 6570 6561 7465 6420 2a20 6172   g_repeated * ar
+000169d0: 676d 6178 5f6c 6f63 6174 696f 6e73 202f  gmax_locations /
+000169e0: 2061 7267 6d61 785f 7375 6d0a 2020 2020   argmax_sum.    
+000169f0: 7265 7475 726e 206f 7574 0a0a 0a72 6567  return out...reg
+00016a00: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+00016a10: 7269 6d73 2e50 7269 6d49 4473 2e41 4d49  rims.PrimIDs.AMI
+00016a20: 4e29 2867 7261 645f 6368 6f6f 7365 725f  N)(grad_chooser_
+00016a30: 6261 636b 7761 7264 290a 0a0a 4072 6567  backward)...@reg
+00016a40: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00016a50: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00016a60: 696d 4944 732e 414d 494e 290a 6465 6620  imIDs.AMIN).def 
+00016a70: 616d 696e 5f61 7567 5f66 7764 2878 2c20  amin_aug_fwd(x, 
+00016a80: 6469 6d73 293a 0a20 2020 2022 2222 4175  dims):.    """Au
+00016a90: 676d 656e 7465 6420 616d 696e 206f 7065  gmented amin ope
+00016aa0: 7261 7469 6f6e 2e0a 2020 2020 4172 6773  ration..    Args
+00016ab0: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+00016ac0: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
+00016ad0: 6f20 636f 6d70 7574 6520 616d 696e 206f  o compute amin o
+00016ae0: 6e2e 0a20 2020 2020 2020 2064 696d 7320  n..        dims 
+00016af0: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
+00016b00: 293a 2044 696d 656e 7369 6f6e 7320 746f  ): Dimensions to
+00016b10: 2063 6f6d 7075 7465 2061 6d69 6e20 6f76   compute amin ov
+00016b20: 6572 2e0a 2020 2020 5265 7475 726e 733a  er..    Returns:
+00016b30: 0a20 2020 2020 2020 2056 4a50 4475 616c  .        VJPDual
+00016b40: 3a20 5072 696d 616c 2061 6e64 2072 6573  : Primal and res
+00016b50: 6964 7561 6c73 2e0a 2020 2020 2222 220a  iduals..    """.
+00016b60: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
+00016b70: 6d73 2e61 6d69 6e28 782c 2064 696d 7329  ms.amin(x, dims)
+00016b80: 0a0a 2020 2020 7265 7369 6475 616c 7320  ..    residuals 
+00016b90: 3d20 280a 2020 2020 2020 2020 7072 696d  = (.        prim
+00016ba0: 616c 2c0a 2020 2020 2020 2020 782c 0a20  al,.        x,. 
+00016bb0: 2020 2020 2020 2078 2e73 6861 7065 2c0a         x.shape,.
+00016bc0: 2020 2020 2020 2020 6469 6d73 2c0a 2020          dims,.  
+00016bd0: 2020 290a 0a20 2020 2072 6574 7572 6e20    )..    return 
+00016be0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00016bf0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00016c00: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+00016c10: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
+00016c20: 7269 6d49 4473 2e50 4f57 290a 6465 6620  rimIDs.POW).def 
+00016c30: 706f 775f 6175 675f 6665 6428 782c 2079  pow_aug_fed(x, y
+00016c40: 293a 0a20 2020 2022 2222 4175 676d 656e  ):.    """Augmen
+00016c50: 7465 6420 7468 6520 706f 7720 6f70 6572  ted the pow oper
+00016c60: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
+00016c70: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+00016c80: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
+00016c90: 6974 6820 7468 6520 6261 7365 2074 6f20  ith the base to 
+00016ca0: 6265 2065 7870 6f6e 656e 7469 6174 6564  be exponentiated
+00016cb0: 2e0a 2020 2020 2020 2020 7920 2856 6172  ..        y (Var
+00016cc0: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
+00016cd0: 6974 6820 706f 7765 7220 746f 2072 6169  ith power to rai
+00016ce0: 7365 2074 6f2e 0a0a 2020 2020 5265 7475  se to...    Retu
+00016cf0: 726e 733a 0a20 2020 2020 2020 2056 4a50  rns:.        VJP
+00016d00: 4475 616c 3a20 5072 696d 616c 2061 6e64  Dual: Primal and
+00016d10: 2072 6573 6964 7561 6c73 2e0a 2020 2020   residuals..    
+00016d20: 2222 220a 2020 2020 7072 696d 616c 203d  """.    primal =
+00016d30: 2070 7269 6d73 2e70 6f77 2878 2c20 7929   prims.pow(x, y)
+00016d40: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+00016d50: 2028 7072 696d 616c 2c20 782c 2079 290a   (primal, x, y).
+00016d60: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00016d70: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00016d80: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00016d90: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00016da0: 2e50 7269 6d49 4473 2e50 4f57 290a 6465  .PrimIDs.POW).de
+00016db0: 6620 706f 775f 6261 636b 7761 7264 2872  f pow_backward(r
+00016dc0: 6573 756c 742c 2078 2c20 792c 2067 293a  esult, x, y, g):
+00016dd0: 0a20 2020 2069 6d70 6f72 7420 7468 756e  .    import thun
+00016de0: 6465 722e 636c 616e 6720 6173 2074 6c61  der.clang as tla
+00016df0: 6e67 0a0a 2020 2020 6772 6573 756c 7420  ng..    gresult 
+00016e00: 3d20 6720 2a20 7265 7375 6c74 2020 2320  = g * result  # 
+00016e10: 7265 7573 6520 636f 6d6d 6f6e 2066 6163  reuse common fac
+00016e20: 746f 720a 2020 2020 6478 203d 2067 202a  tor.    dx = g *
+00016e30: 2079 202a 2078 202a 2a20 2879 202d 2031   y * x ** (y - 1
+00016e40: 290a 2020 2020 6479 203d 2067 7265 7375  ).    dy = gresu
+00016e50: 6c74 202a 2074 6c61 6e67 2e6c 6f67 2878  lt * tlang.log(x
+00016e60: 290a 2020 2020 7265 7475 726e 2064 782c  ).    return dx,
+00016e70: 2064 790a 0a0a 4072 6567 6973 7465 725f   dy...@register_
+00016e80: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00016e90: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00016ea0: 5441 4e29 0a64 6566 2074 616e 5f61 7567  TAN).def tan_aug
+00016eb0: 5f66 7764 2878 293a 0a20 2020 2022 2222  _fwd(x):.    """
+00016ec0: 4175 676d 656e 7465 6420 7461 6e20 6f70  Augmented tan op
+00016ed0: 6572 6174 696f 6e2e 0a0a 2020 2020 4172  eration...    Ar
+00016ee0: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
+00016ef0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
+00016f00: 2074 6f20 6265 2070 6173 7365 6420 746f   to be passed to
+00016f10: 2074 616e 2e0a 2020 2020 2222 220a 0a20   tan..    """.. 
+00016f20: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
+00016f30: 732e 7461 6e28 7829 0a20 2020 2072 6573  s.tan(x).    res
+00016f40: 6964 7561 6c73 203d 2028 7072 696d 616c  iduals = (primal
+00016f50: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
+00016f60: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00016f70: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00016f80: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00016f90: 696d 732e 5072 696d 4944 732e 5441 4e29  ims.PrimIDs.TAN)
+00016fa0: 0a64 6566 2074 616e 5f62 6163 6b77 6172  .def tan_backwar
+00016fb0: 6428 7265 7375 6c74 2c20 6729 3a0a 2020  d(result, g):.  
+00016fc0: 2020 7265 7475 726e 2067 202a 2028 3120    return g * (1 
+00016fd0: 2b20 7265 7375 6c74 202a 2072 6573 756c  + result * resul
+00016fe0: 7429 0a0a 0a23 204e 4f54 453a 204a 6178  t)...# NOTE: Jax
+00016ff0: 2075 7365 7320 6e70 2e61 7267 736f 7274   uses np.argsort
+00017000: 2069 6e20 6974 7320 7472 616e 7370 6f73   in its transpos
+00017010: 6520 766a 7020 636f 6d70 7574 6174 696f  e vjp computatio
+00017020: 6e0a 6465 6620 5f61 7267 736f 7274 2873  n.def _argsort(s
+00017030: 6571 293a 0a20 2020 2072 6574 7572 6e20  eq):.    return 
+00017040: 736f 7274 6564 2872 616e 6765 286c 656e  sorted(range(len
+00017050: 2873 6571 2929 2c20 6b65 793d 7365 712e  (seq)), key=seq.
+00017060: 5f5f 6765 7469 7465 6d5f 5f29 0a0a 0a40  __getitem__)...@
+00017070: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00017080: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
+00017090: 2e50 7269 6d49 4473 2e44 4556 4943 455f  .PrimIDs.DEVICE_
+000170a0: 5055 5429 0a64 6566 2064 6576 6963 655f  PUT).def device_
+000170b0: 7075 745f 6175 675f 6677 6428 613a 2054  put_aug_fwd(a: T
+000170c0: 656e 736f 7250 726f 7879 2c20 6465 7669  ensorProxy, devi
+000170d0: 6365 3a20 4465 7669 6365 2920 2d3e 2054  ce: Device) -> T
+000170e0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+000170f0: 7072 696d 616c 203d 2070 7269 6d73 2e64  primal = prims.d
+00017100: 6576 6963 655f 7075 7428 612c 2064 6576  evice_put(a, dev
+00017110: 6963 6529 0a20 2020 2072 6573 6964 7561  ice).    residua
+00017120: 6c73 203d 2028 612e 6465 7669 6365 2c29  ls = (a.device,)
+00017130: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+00017140: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
+00017150: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
+00017160: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00017170: 732e 5072 696d 4944 732e 4445 5649 4345  s.PrimIDs.DEVICE
+00017180: 5f50 5554 290a 6465 6620 6465 7669 6365  _PUT).def device
+00017190: 5f70 7574 5f62 6163 6b77 6172 6428 6f72  _put_backward(or
+000171a0: 6967 5f64 6576 6963 652c 2067 293a 0a20  ig_device, g):. 
+000171b0: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+000171c0: 6465 7669 6365 5f70 7574 2867 2c20 6f72  device_put(g, or
+000171d0: 6967 5f64 6576 6963 6529 2c20 4e6f 6e65  ig_device), None
+000171e0: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+000171f0: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+00017200: 7269 6d73 2e50 7269 6d49 4473 2e43 4f4e  rims.PrimIDs.CON
+00017210: 564f 4c55 5449 4f4e 290a 6465 6620 636f  VOLUTION).def co
+00017220: 6e76 6f6c 7574 696f 6e5f 6175 675f 6677  nvolution_aug_fw
+00017230: 6428 0a20 2020 2061 3a20 5072 6f78 792c  d(.    a: Proxy,
+00017240: 0a20 2020 2077 6569 6768 742c 0a20 2020  .    weight,.   
+00017250: 2062 6961 732c 0a20 2020 2073 7472 6964   bias,.    strid
+00017260: 652c 0a20 2020 2070 6164 6469 6e67 2c0a  e,.    padding,.
+00017270: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
+00017280: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
+00017290: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+000172a0: 2c0a 2020 2020 6772 6f75 7073 2c0a 293a  ,.    groups,.):
+000172b0: 0a20 2020 2070 7269 6d61 6c20 3d20 636f  .    primal = co
+000172c0: 6e76 6f6c 7574 696f 6e28 612c 2077 6569  nvolution(a, wei
+000172d0: 6768 742c 2062 6961 732c 2073 7472 6964  ght, bias, strid
+000172e0: 652c 2070 6164 6469 6e67 2c20 6469 6c61  e, padding, dila
+000172f0: 7469 6f6e 2c20 7472 616e 7370 6f73 6564  tion, transposed
+00017300: 2c20 6f75 7470 7574 5f70 6164 6469 6e67  , output_padding
+00017310: 2c20 6772 6f75 7073 290a 2020 2020 7265  , groups).    re
+00017320: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
+00017330: 6c2c 2061 2c20 7765 6967 6874 2c20 6269  l, a, weight, bi
+00017340: 6173 2c20 7374 7269 6465 2c20 7061 6464  as, stride, padd
+00017350: 696e 672c 2064 696c 6174 696f 6e2c 2074  ing, dilation, t
+00017360: 7261 6e73 706f 7365 642c 206f 7574 7075  ransposed, outpu
+00017370: 745f 7061 6464 696e 672c 2067 726f 7570  t_padding, group
+00017380: 7329 0a20 2020 2072 6574 7572 6e20 564a  s).    return VJ
+00017390: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+000173a0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+000173b0: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+000173c0: 696d 732e 5072 696d 4944 732e 434f 4e56  ims.PrimIDs.CONV
+000173d0: 4f4c 5554 494f 4e29 0a64 6566 2063 6f6e  OLUTION).def con
+000173e0: 766f 6c75 7469 6f6e 5f62 6163 6b77 6172  volution_backwar
+000173f0: 6428 0a20 2020 206f 7574 7075 743a 2050  d(.    output: P
+00017400: 726f 7879 2c0a 2020 2020 696e 7075 743a  roxy,.    input:
+00017410: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
+00017420: 6874 2c0a 2020 2020 6269 6173 2c0a 2020  ht,.    bias,.  
+00017430: 2020 7374 7269 6465 2c0a 2020 2020 7061    stride,.    pa
+00017440: 6464 696e 672c 0a20 2020 2064 696c 6174  dding,.    dilat
+00017450: 696f 6e2c 0a20 2020 2074 7261 6e73 706f  ion,.    transpo
+00017460: 7365 642c 0a20 2020 206f 7574 7075 745f  sed,.    output_
+00017470: 7061 6464 696e 672c 0a20 2020 2067 726f  padding,.    gro
+00017480: 7570 732c 0a20 2020 2067 7261 642c 0a29  ups,.    grad,.)
+00017490: 3a0a 2020 2020 2320 5472 616e 7370 6f73  :.    # Transpos
+000174a0: 6564 2063 6f6e 766f 6c75 7469 6f6e 2069  ed convolution i
+000174b0: 7320 6e6f 7420 7375 7070 6f72 7465 6421  s not supported!
+000174c0: 0a20 2020 2061 7373 6572 7420 7472 616e  .    assert tran
+000174d0: 7370 6f73 6564 203d 3d20 300a 0a20 2020  sposed == 0..   
+000174e0: 2069 6e70 7574 5f67 7261 6420 3d20 4e6f   input_grad = No
+000174f0: 6e65 0a20 2020 2077 6569 6768 745f 6772  ne.    weight_gr
+00017500: 6164 203d 204e 6f6e 650a 2020 2020 6269  ad = None.    bi
+00017510: 6173 5f67 7261 6420 3d20 4e6f 6e65 0a0a  as_grad = None..
+00017520: 2020 2020 2320 5368 6f72 7420 6369 7263      # Short circ
+00017530: 7569 7420 6f6e 207a 6572 6f2d 6469 6d20  uit on zero-dim 
+00017540: 6772 6164 0a20 2020 2069 6620 616e 7928  grad.    if any(
+00017550: 7320 3d3d 2030 2066 6f72 2073 2069 6e20  s == 0 for s in 
+00017560: 6772 6164 2e73 6861 7065 293a 0a20 2020  grad.shape):.   
+00017570: 2020 2020 2069 6e70 7574 5f67 7261 6420       input_grad 
+00017580: 3d20 6675 6c6c 5f6c 696b 6528 696e 7075  = full_like(inpu
+00017590: 742c 2066 696c 6c5f 7661 6c75 653d 3029  t, fill_value=0)
+000175a0: 0a20 2020 2020 2020 2077 6569 6768 745f  .        weight_
+000175b0: 6772 6164 203d 2066 756c 6c5f 6c69 6b65  grad = full_like
+000175c0: 2877 6569 6768 742c 2066 696c 6c5f 7661  (weight, fill_va
+000175d0: 6c75 653d 3029 0a20 2020 2020 2020 2069  lue=0).        i
+000175e0: 6620 6269 6173 2069 7320 6e6f 7420 4e6f  f bias is not No
+000175f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00017600: 6269 6173 5f67 7261 6420 3d20 6675 6c6c  bias_grad = full
+00017610: 5f6c 696b 6528 6269 6173 2c20 6669 6c6c  _like(bias, fill
+00017620: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+00017630: 2020 7265 7475 726e 2028 696e 7075 745f    return (input_
+00017640: 6772 6164 2c20 7765 6967 6874 5f67 7261  grad, weight_gra
+00017650: 642c 2062 6961 735f 6772 6164 2920 2b20  d, bias_grad) + 
+00017660: 2828 4e6f 6e65 2c29 202a 2036 290a 0a20  ((None,) * 6).. 
+00017670: 2020 2062 6174 6368 2c20 696e 5f63 6861     batch, in_cha
+00017680: 6e6e 656c 732c 202a 7370 6174 6961 6c5f  nnels, *spatial_
+00017690: 6469 6d73 203d 2069 6e70 7574 2e73 6861  dims = input.sha
+000176a0: 7065 0a20 2020 206f 7574 5f63 6861 6e6e  pe.    out_chann
+000176b0: 656c 732c 2067 696e 5f63 6861 6e6e 656c  els, gin_channel
+000176c0: 732c 202a 6b65 726e 656c 5f64 696d 7320  s, *kernel_dims 
+000176d0: 3d20 7765 6967 6874 2e73 6861 7065 0a20  = weight.shape. 
+000176e0: 2020 2064 696d 203d 206c 656e 2873 7061     dim = len(spa
+000176f0: 7469 616c 5f64 696d 7329 0a0a 2020 2020  tial_dims)..    
+00017700: 6465 6620 6d61 7962 655f 6578 7061 6e64  def maybe_expand
+00017710: 5f73 6571 2873 2c20 6469 6d29 3a0a 2020  _seq(s, dim):.  
+00017720: 2020 2020 2020 6966 206c 656e 2873 2920        if len(s) 
+00017730: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00017740: 2020 7265 7475 726e 2028 735b 305d 2c29    return (s[0],)
+00017750: 202a 2064 696d 0a20 2020 2020 2020 2065   * dim.        e
+00017760: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00017770: 2072 6574 7572 6e20 730a 0a20 2020 2073   return s..    s
+00017780: 7472 6964 6520 3d20 6d61 7962 655f 6578  tride = maybe_ex
+00017790: 7061 6e64 5f73 6571 2873 7472 6964 652c  pand_seq(stride,
+000177a0: 2064 696d 290a 2020 2020 7061 6464 696e   dim).    paddin
+000177b0: 6720 3d20 6d61 7962 655f 6578 7061 6e64  g = maybe_expand
+000177c0: 5f73 6571 2870 6164 6469 6e67 2c20 6469  _seq(padding, di
+000177d0: 6d29 0a20 2020 2064 696c 6174 696f 6e20  m).    dilation 
+000177e0: 3d20 6d61 7962 655f 6578 7061 6e64 5f73  = maybe_expand_s
+000177f0: 6571 2864 696c 6174 696f 6e2c 2064 696d  eq(dilation, dim
+00017800: 290a 0a20 2020 2064 6566 2063 6f6e 765f  )..    def conv_
+00017810: 7472 616e 7370 6f73 6528 7429 3a0a 2020  transpose(t):.  
+00017820: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
+00017830: 6d73 2e74 7261 6e73 706f 7365 2874 2c20  ms.transpose(t, 
+00017840: 2831 2c20 3029 202b 2074 7570 6c65 2872  (1, 0) + tuple(r
+00017850: 616e 6765 2832 2c20 742e 6e64 696d 2929  ange(2, t.ndim))
+00017860: 290a 0a20 2020 2023 2069 6e70 7574 5f67  )..    # input_g
+00017870: 7261 6420 3d20 7b0a 2020 2020 6465 6620  rad = {.    def 
+00017880: 7472 616e 7370 6f73 655f 616e 645f 666c  transpose_and_fl
+00017890: 6970 5f77 6569 6768 7428 7765 6967 6874  ip_weight(weight
+000178a0: 293a 0a20 2020 2020 2020 2023 2054 6865  ):.        # The
+000178b0: 206c 696e 6573 2062 656c 6f77 2061 7265   lines below are
+000178c0: 2074 7261 6e73 706f 7369 6e67 2074 6865   transposing the
+000178d0: 2063 6861 6e6e 656c 7320 6469 6d73 2e0a   channels dims..
+000178e0: 2020 2020 2020 2020 2320 5765 2061 6c73          # We als
+000178f0: 6f20 6e65 6564 2074 6f20 6578 7472 6163  o need to extrac
+00017900: 7420 7468 6520 6772 6f75 7020 696e 666f  t the group info
+00017910: 726d 6174 696f 6e20 616e 6420 6d65 7267  rmation and merg
+00017920: 6520 6974 0a20 2020 2020 2020 2023 2077  e it.        # w
+00017930: 6974 6820 7468 6520 6469 6d65 6e73 696f  ith the dimensio
+00017940: 6e20 636f 7272 6573 706f 6e64 696e 6720  n corresponding 
+00017950: 746f 2074 6865 2022 6f75 745f 6368 616e  to the "out_chan
+00017960: 6e65 6c73 2220 6469 6d2e 0a20 2020 2020  nels" dim..     
+00017970: 2020 2023 2028 6f75 745f 6368 616e 6e65     # (out_channe
+00017980: 6c73 2c20 6769 6e5f 6368 616e 6e65 6c73  ls, gin_channels
+00017990: 2920 2d3e 2028 6769 6e5f 6368 616e 6e65  ) -> (gin_channe
+000179a0: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
+000179b0: 290a 2020 2020 2020 2020 7765 6967 6874  ).        weight
+000179c0: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
+000179d0: 6528 7765 6967 6874 290a 2020 2020 2020  e(weight).      
+000179e0: 2020 2320 5370 6c69 7420 286f 7574 5f63    # Split (out_c
+000179f0: 6861 6e6e 656c 732c 2920 2d3e 2028 6772  hannels,) -> (gr
+00017a00: 6f75 7073 2c20 6f75 745f 6368 616e 6e65  oups, out_channe
+00017a10: 6c73 202f 2f20 6772 6f75 7073 290a 2020  ls // groups).  
+00017a20: 2020 2020 2020 7765 6967 6874 203d 2077        weight = w
+00017a30: 6569 6768 742e 7265 7368 6170 6528 5b67  eight.reshape([g
+00017a40: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
+00017a50: 7570 732c 206f 7574 5f63 6861 6e6e 656c  ups, out_channel
+00017a60: 7320 2f2f 2067 726f 7570 735d 202b 206b  s // groups] + k
+00017a70: 6572 6e65 6c5f 6469 6d73 290a 2020 2020  ernel_dims).    
+00017a80: 2020 2020 2320 4d6f 7669 6e67 2067 726f      # Moving gro
+00017a90: 7570 7320 746f 2074 6865 206c 6566 742d  ups to the left-
+00017aa0: 6d6f 7374 2070 6f73 6974 696f 6e2e 0a20  most position.. 
+00017ab0: 2020 2020 2020 2023 2028 6769 6e5f 6368         # (gin_ch
+00017ac0: 616e 6e65 6c73 2c20 6772 6f75 7073 2c20  annels, groups, 
+00017ad0: 6f75 745f 6368 616e 6e65 6c73 202f 2f20  out_channels // 
+00017ae0: 6772 6f75 7073 2920 2d3e 2028 6772 6f75  groups) -> (grou
+00017af0: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
+00017b00: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
+00017b10: 2f20 6772 6f75 7073 290a 2020 2020 2020  / groups).      
+00017b20: 2020 7765 6967 6874 203d 2063 6f6e 765f    weight = conv_
+00017b30: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
+00017b40: 290a 2020 2020 2020 2020 2320 5371 7561  ).        # Squa
+00017b50: 7368 2028 6772 6f75 7073 2c20 6769 6e5f  sh (groups, gin_
+00017b60: 6368 616e 6e65 6c73 2920 2d3e 2028 696e  channels) -> (in
+00017b70: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
+00017b80: 2020 2077 6569 6768 7420 3d20 7765 6967     weight = weig
+00017b90: 6874 2e72 6573 6861 7065 285b 696e 5f63  ht.reshape([in_c
+00017ba0: 6861 6e6e 656c 732c 206f 7574 5f63 6861  hannels, out_cha
+00017bb0: 6e6e 656c 7320 2f2f 2067 726f 7570 735d  nnels // groups]
+00017bc0: 202b 206b 6572 6e65 6c5f 6469 6d73 290a   + kernel_dims).
+00017bd0: 0a20 2020 2020 2020 2023 2046 6c69 7020  .        # Flip 
+00017be0: 7370 6174 6961 6c20 6469 6d65 6e73 696f  spatial dimensio
+00017bf0: 6e73 0a20 2020 2020 2020 2077 6569 6768  ns.        weigh
+00017c00: 7420 3d20 7072 696d 732e 666c 6970 2877  t = prims.flip(w
+00017c10: 6569 6768 742c 2074 7570 6c65 2872 616e  eight, tuple(ran
+00017c20: 6765 2832 2c20 7765 6967 6874 2e6e 6469  ge(2, weight.ndi
+00017c30: 6d29 2929 0a20 2020 2020 2020 2072 6574  m))).        ret
+00017c40: 7572 6e20 7765 6967 6874 0a0a 2020 2020  urn weight..    
+00017c50: 2320 5765 206e 6565 6420 746f 2070 6164  # We need to pad
+00017c60: 2074 6865 2067 7261 6469 656e 7420 746f   the gradient to
+00017c70: 2062 6520 6162 6c65 2074 6f20 6669 7420   be able to fit 
+00017c80: 6b65 726e 656c 2077 696e 646f 7773 2e0a  kernel windows..
+00017c90: 2020 2020 696e 6974 6961 6c5f 6772 6164      initial_grad
+00017ca0: 5f70 6164 6469 6e67 203d 205b 6420 2a20  _padding = [d * 
+00017cb0: 286b 202d 2031 2920 666f 7220 642c 206b  (k - 1) for d, k
+00017cc0: 2069 6e20 7a69 7028 6469 6c61 7469 6f6e   in zip(dilation
+00017cd0: 2c20 6b65 726e 656c 5f64 696d 7329 5d0a  , kernel_dims)].
+00017ce0: 0a20 2020 2069 6e70 7574 5f67 7261 6420  .    input_grad 
+00017cf0: 3d20 636f 6e76 6f6c 7574 696f 6e28 0a20  = convolution(. 
+00017d00: 2020 2020 2020 2070 7269 6d73 2e70 6164         prims.pad
+00017d10: 280a 2020 2020 2020 2020 2020 2020 6772  (.            gr
+00017d20: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00017d30: 302e 302c 0a20 2020 2020 2020 2020 2020  0.0,.           
+00017d40: 2023 2054 6865 2070 6978 6573 2061 7265   # The pixes are
+00017d50: 2073 7472 6964 6520 6177 6179 2066 726f   stride away fro
+00017d60: 6d20 6561 6368 206f 7468 6572 2069 6e20  m each other in 
+00017d70: 7468 6520 6f72 6967 696e 616c 2069 6e70  the original inp
+00017d80: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
+00017d90: 2320 4865 6e63 6520 7765 206e 6565 6420  # Hence we need 
+00017da0: 746f 2064 696c 6174 6520 7468 6520 6772  to dilate the gr
+00017db0: 6164 6965 6e74 2062 7920 6469 6c61 7469  adient by dilati
+00017dc0: 6f6e 3d73 7472 6964 6520 2d20 310a 2020  on=stride - 1.  
+00017dd0: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
+00017de0: 6861 7420 7468 6572 6520 6172 6520 7374  hat there are st
+00017df0: 7269 6465 202d 2031 207a 6572 6f73 2062  ride - 1 zeros b
+00017e00: 6574 7765 656e 2074 6865 2070 6978 656c  etween the pixel
+00017e10: 732e 0a20 2020 2020 2020 2020 2020 205b  s..            [
+00017e20: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
+00017e30: 2c20 3029 5d20 2b20 5b28 302c 2030 2c20  , 0)] + [(0, 0, 
+00017e40: 7320 2d20 3129 2066 6f72 2073 2069 6e20  s - 1) for s in 
+00017e50: 7374 7269 6465 5d2c 0a20 2020 2020 2020  stride],.       
+00017e60: 2029 2c0a 2020 2020 2020 2020 7472 616e   ),.        tran
+00017e70: 7370 6f73 655f 616e 645f 666c 6970 5f77  spose_and_flip_w
+00017e80: 6569 6768 7428 7765 6967 6874 292c 0a20  eight(weight),. 
+00017e90: 2020 2020 2020 204e 6f6e 652c 0a20 2020         None,.   
+00017ea0: 2020 2020 2023 2053 6574 7469 6e67 2073       # Setting s
+00017eb0: 7472 6964 6520 746f 2031 2061 7320 7468  tride to 1 as th
+00017ec0: 6520 6469 7374 616e 6365 2062 6574 7765  e distance betwe
+00017ed0: 656e 2070 6978 656c 7320 6973 2074 616b  en pixels is tak
+00017ee0: 656e 0a20 2020 2020 2020 2023 2063 6172  en.        # car
+00017ef0: 6520 6279 2074 6865 2070 6164 2072 6967  e by the pad rig
+00017f00: 6874 2061 626f 7665 2e0a 2020 2020 2020  ht above..      
+00017f10: 2020 2831 2c29 2c0a 2020 2020 2020 2020    (1,),.        
+00017f20: 696e 6974 6961 6c5f 6772 6164 5f70 6164  initial_grad_pad
+00017f30: 6469 6e67 2c0a 2020 2020 2020 2020 6469  ding,.        di
+00017f40: 6c61 7469 6f6e 2c0a 2020 2020 2020 2020  lation,.        
+00017f50: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
+00017f60: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
+00017f70: 6e67 2c0a 2020 2020 2020 2020 6772 6f75  ng,.        grou
+00017f80: 7073 2c0a 2020 2020 290a 0a20 2020 2064  ps,.    )..    d
+00017f90: 6566 2070 6164 5f74 6f5f 696e 7075 7428  ef pad_to_input(
+00017fa0: 6772 6164 293a 0a20 2020 2020 2020 2023  grad):.        #
+00017fb0: 2057 6520 6e65 6564 2074 6f20 756e 7061   We need to unpa
+00017fc0: 6420 7468 6520 7061 6464 696e 6720 646f  d the padding do
+00017fd0: 6e65 2074 6f20 7468 6520 696e 7075 7420  ne to the input 
+00017fe0: 7072 696f 7220 746f 2074 6865 2063 6f6e  prior to the con
+00017ff0: 766f 6c75 7469 6f6e 2e0a 2020 2020 2020  volution..      
+00018000: 2020 2320 4e6f 7465 2074 6861 7420 6c6f    # Note that lo
+00018010: 7720 616e 6420 6869 6768 2070 6164 6469  w and high paddi
+00018020: 6e67 2061 7265 206e 6f74 206e 6563 6573  ng are not neces
+00018030: 7361 7269 6c79 2065 7175 616c 2c20 736f  sarily equal, so
+00018040: 2077 6520 6361 6e6e 6f74 0a20 2020 2020   we cannot.     
+00018050: 2020 2023 2061 6273 6f72 6220 6974 2069     # absorb it i
+00018060: 6e74 6f20 7468 6520 636f 6e76 6f6c 7574  nto the convolut
+00018070: 696f 6e20 6a75 7374 2079 6574 2c20 756e  ion just yet, un
+00018080: 6c65 7373 2074 6865 2041 5049 2069 7320  less the API is 
+00018090: 6d6f 6469 6669 6564 2e0a 2020 2020 2020  modified..      
+000180a0: 2020 7061 645f 636f 6e66 6967 203d 205b    pad_config = [
+000180b0: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
+000180c0: 2c20 3029 5d0a 2020 2020 2020 2020 666f  , 0)].        fo
+000180d0: 7220 6f2c 2069 2c20 672c 2070 2069 6e20  r o, i, g, p in 
+000180e0: 7a69 7028 6772 6164 2e73 6861 7065 5b32  zip(grad.shape[2
+000180f0: 3a5d 2c20 7370 6174 6961 6c5f 6469 6d73  :], spatial_dims
+00018100: 2c20 696e 7075 745f 6772 6164 2e73 6861  , input_grad.sha
+00018110: 7065 5b32 3a5d 2c20 7061 6464 696e 6729  pe[2:], padding)
+00018120: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00018130: 203d 202d 700a 2020 2020 2020 2020 2020   = -p.          
+00018140: 2020 2320 4e6f 7465 2074 6861 7420 2869    # Note that (i
+00018150: 202b 2032 202a 2070 2920 6973 2074 6865   + 2 * p) is the
+00018160: 2073 697a 6520 6f66 2074 6865 2070 6164   size of the pad
+00018170: 6465 6420 696e 7075 742c 0a20 2020 2020  ded input,.     
+00018180: 2020 2020 2020 2023 2073 6f20 7468 6520         # so the 
+00018190: 7175 616e 7469 7479 2028 6920 2b20 3220  quantity (i + 2 
+000181a0: 2a20 7029 202d 2067 2074 656c 6c73 2075  * p) - g tells u
+000181b0: 7320 6279 2068 6f77 206d 7563 680a 2020  s by how much.  
+000181c0: 2020 2020 2020 2020 2020 2320 7765 206e            # we n
+000181d0: 6565 6420 746f 2070 6164 2074 6865 2067  eed to pad the g
+000181e0: 7261 6469 656e 7420 736f 2074 6861 7420  radient so that 
+000181f0: 7468 6520 656c 656d 656e 7473 206f 7574  the elements out
+00018200: 7369 6465 0a20 2020 2020 2020 2020 2020  side.           
+00018210: 2023 206f 6620 7468 6520 636f 6e76 6f6c   # of the convol
+00018220: 7574 696f 6e20 7265 6365 6976 6520 7a65  ution receive ze
+00018230: 726f 2067 7261 6469 656e 742e 0a20 2020  ro gradient..   
+00018240: 2020 2020 2020 2020 2023 2070 2069 7320           # p is 
+00018250: 6164 6469 7469 6f6e 616c 6c79 2073 7562  additionally sub
+00018260: 7472 6163 7465 6420 746f 206e 6567 6174  tracted to negat
+00018270: 6520 7468 6520 696e 7075 7427 7320 7061  e the input's pa
+00018280: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00018290: 696e 2066 6f72 7761 7264 2e0a 2020 2020  in forward..    
+000182a0: 2020 2020 2020 2020 6869 203d 2028 6920          hi = (i 
+000182b0: 2b20 3220 2a20 7029 202d 2067 202d 2070  + 2 * p) - g - p
+000182c0: 0a20 2020 2020 2020 2020 2020 2070 6164  .            pad
+000182d0: 5f63 6f6e 6669 672e 6170 7065 6e64 2828  _config.append((
+000182e0: 6c6f 2c20 6869 2c20 3029 290a 2020 2020  lo, hi, 0)).    
+000182f0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+00018300: 2e70 6164 2867 7261 642c 2030 2e30 2c20  .pad(grad, 0.0, 
+00018310: 7061 645f 636f 6e66 6967 290a 0a20 2020  pad_config)..   
+00018320: 2069 6e70 7574 5f67 7261 6420 3d20 7061   input_grad = pa
+00018330: 645f 746f 5f69 6e70 7574 2869 6e70 7574  d_to_input(input
+00018340: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
+00018350: 2020 2020 2320 6269 6173 5f67 7261 6420      # bias_grad 
+00018360: 3d20 7b0a 2020 2020 6966 2062 6961 7320  = {.    if bias 
+00018370: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00018380: 2020 2020 2069 6d70 6f72 7420 7468 756e       import thun
+00018390: 6465 722e 746f 7263 6820 6173 206c 746f  der.torch as lto
+000183a0: 7263 680a 0a20 2020 2020 2020 2062 6961  rch..        bia
+000183b0: 735f 6772 6164 203d 206c 746f 7263 682e  s_grad = ltorch.
+000183c0: 7375 6d28 6772 6164 2c20 5b64 2066 6f72  sum(grad, [d for
+000183d0: 2064 2069 6e20 7261 6e67 6528 6772 6164   d in range(grad
+000183e0: 2e6e 6469 6d29 2069 6620 6420 213d 2031  .ndim) if d != 1
+000183f0: 5d29 0a20 2020 2023 207d 0a0a 2020 2020  ]).    # }..    
+00018400: 2320 7765 6967 6874 2067 7261 6420 3d20  # weight grad = 
+00018410: 7b0a 2020 2020 6465 6620 7061 645f 7472  {.    def pad_tr
+00018420: 616e 7370 6f73 655f 616e 645f 7075 7368  anspose_and_push
+00018430: 5f67 726f 7570 735f 696e 746f 5f62 6174  _groups_into_bat
+00018440: 6368 6573 2874 293a 0a20 2020 2020 2020  ches(t):.       
+00018450: 2023 2046 6972 7374 2070 6164 2c2e 2e2e   # First pad,...
+00018460: 0a20 2020 2020 2020 2023 2050 6164 2061  .        # Pad a
+00018470: 7320 6e65 6365 7373 6172 7920 736f 2074  s necessary so t
+00018480: 6861 7420 696e 2063 6f6e 766f 6c75 7469  hat in convoluti
+00018490: 6f6e 7320 7765 206e 6576 6572 2061 6476  ons we never adv
+000184a0: 616e 6365 0a20 2020 2020 2020 2023 2070  ance.        # p
+000184b0: 6173 7420 7265 6c65 7661 6e74 2069 6e70  ast relevant inp
+000184c0: 7574 732e 0a20 2020 2020 2020 2070 6164  uts..        pad
+000184d0: 5f63 6f6e 6669 6720 3d20 5b28 302c 2030  _config = [(0, 0
+000184e0: 2c20 3029 2c20 2830 2c20 302c 2030 295d  , 0), (0, 0, 0)]
+000184f0: 0a20 2020 2020 2020 2066 6f72 206f 2c20  .        for o, 
+00018500: 692c 206b 2c20 702c 2073 2c20 6420 696e  i, k, p, s, d in
+00018510: 207a 6970 2867 7261 642e 7368 6170 655b   zip(grad.shape[
+00018520: 323a 5d2c 2073 7061 7469 616c 5f64 696d  2:], spatial_dim
+00018530: 732c 206b 6572 6e65 6c5f 6469 6d73 2c20  s, kernel_dims, 
+00018540: 7061 6464 696e 672c 2073 7472 6964 652c  padding, stride,
+00018550: 2064 696c 6174 696f 6e29 3a0a 2020 2020   dilation):.    
+00018560: 2020 2020 2020 2020 2320 5061 6464 696e          # Paddin
+00018570: 6720 6672 6f6d 2062 656c 6f77 2069 7320  g from below is 
+00018580: 7468 6520 7361 6d65 2e0a 2020 2020 2020  the same..      
+00018590: 2020 2020 2020 6c6f 203d 2070 0a20 2020        lo = p.   
+000185a0: 2020 2020 2020 2020 2023 2054 6865 7265           # There
+000185b0: 2069 7320 616c 7761 7973 2074 6865 206d   is always the m
+000185c0: 6178 2069 6e64 6578 2069 6478 2069 6e20  ax index idx in 
+000185d0: 7468 6520 696e 7075 740a 2020 2020 2020  the input.      
+000185e0: 2020 2020 2020 2320 7468 6520 7661 6c75        # the valu
+000185f0: 6520 6f66 2077 6869 6368 2c20 696e 7075  e of which, inpu
+00018600: 745b 6964 785d 2c20 7468 6520 6b65 726e  t[idx], the kern
+00018610: 656c 2074 6f75 6368 6573 2e0a 2020 2020  el touches..    
+00018620: 2020 2020 2020 2020 2320 5468 6520 6b65          # The ke
+00018630: 726e 656c 2072 6561 6368 2c20 6f72 206b  rnel reach, or k
+00018640: 5f72 6561 6368 2c20 6973 2065 7861 6374  _reach, is exact
+00018650: 6c79 2069 6478 202b 2031 2e0a 2020 2020  ly idx + 1..    
+00018660: 2020 2020 2020 2020 2320 5765 2075 7365          # We use
+00018670: 2069 7420 746f 2064 6563 6964 6520 6279   it to decide by
+00018680: 2068 6f77 206d 7563 6820 7765 206e 6565   how much we nee
+00018690: 6420 746f 2070 6164 2066 726f 6d20 6162  d to pad from ab
+000186a0: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
+000186b0: 2320 6173 2074 6f20 6e6f 7420 6d6f 7665  # as to not move
+000186c0: 2070 6173 7420 7265 6c65 7661 6e74 2076   past relevant v
+000186d0: 616c 7565 732e 0a20 2020 2020 2020 2020  alues..         
+000186e0: 2020 206b 5f72 6561 6368 203d 2028 6f20     k_reach = (o 
+000186f0: 2d20 3129 202a 2073 202b 2064 202a 2028  - 1) * s + d * (
+00018700: 6b20 2d20 3129 202b 2031 0a20 2020 2020  k - 1) + 1.     
+00018710: 2020 2020 2020 2023 2054 6865 2070 6164         # The pad
+00018720: 2066 726f 6d20 6162 6f76 6520 6571 7561   from above equa
+00018730: 6c73 206b 5f72 6561 6368 206d 696e 7573  ls k_reach minus
+00018740: 2074 6865 206c 656e 6774 680a 2020 2020   the length.    
+00018750: 2020 2020 2020 2020 2320 6f66 2074 6865          # of the
+00018760: 2069 6e70 7574 2070 6164 6465 6420 6672   input padded fr
+00018770: 6f6d 2062 656c 6f77 2e0a 2020 2020 2020  om below..      
+00018780: 2020 2020 2020 6869 203d 206b 5f72 6561        hi = k_rea
+00018790: 6368 202d 2028 6920 2b20 7029 0a20 2020  ch - (i + p).   
+000187a0: 2020 2020 2020 2020 2070 6164 5f63 6f6e           pad_con
+000187b0: 6669 672e 6170 7065 6e64 2828 6c6f 2c20  fig.append((lo, 
+000187c0: 6869 2c20 3029 290a 2020 2020 2020 2020  hi, 0)).        
+000187d0: 7420 3d20 7072 696d 732e 7061 6428 742c  t = prims.pad(t,
+000187e0: 2030 2e30 2c20 7061 645f 636f 6e66 6967   0.0, pad_config
+000187f0: 290a 0a20 2020 2020 2020 205f 2c20 5f2c  )..        _, _,
+00018800: 202a 745f 7370 6174 6961 6c5f 6469 6d73   *t_spatial_dims
+00018810: 203d 2074 2e73 6861 7065 0a0a 2020 2020   = t.shape..    
+00018820: 2020 2020 2320 2e2e 2e20 7468 656e 2064      # ... then d
+00018830: 6f20 7468 6520 7265 7374 2e0a 2020 2020  o the rest..    
+00018840: 2020 2020 2320 742e 7368 6170 6520 3d3d      # t.shape ==
+00018850: 2028 6261 7463 682c 2069 6e5f 6368 616e   (batch, in_chan
+00018860: 6e65 6c73 2c20 2e2e 2e29 0a20 2020 2020  nels, ...).     
+00018870: 2020 2023 2054 6865 2072 6573 756c 7420     # The result 
+00018880: 6f66 2074 6869 7320 6675 6e63 7469 6f6e  of this function
+00018890: 2068 6173 2073 6861 7065 0a20 2020 2020   has shape.     
+000188a0: 2020 2023 2028 696e 5f63 6861 6e6e 656c     # (in_channel
+000188b0: 732c 2062 6174 6368 202a 2067 726f 7570  s, batch * group
+000188c0: 7329 0a20 2020 2020 2020 2023 2028 6261  s).        # (ba
+000188d0: 7463 682c 2069 6e5f 6368 616e 6e65 6c73  tch, in_channels
+000188e0: 2920 2d3e 2028 696e 5f63 6861 6e6e 656c  ) -> (in_channel
+000188f0: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
+00018900: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
+00018910: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
+00018920: 2320 5370 6c69 7420 2869 6e5f 6368 616e  # Split (in_chan
+00018930: 6e65 6c73 2c29 202d 3e20 2867 726f 7570  nels,) -> (group
+00018940: 732c 2067 696e 5f63 6861 6e6e 656c 7329  s, gin_channels)
+00018950: 0a20 2020 2020 2020 2074 203d 2074 2e72  .        t = t.r
+00018960: 6573 6861 7065 285b 6772 6f75 7073 2c20  eshape([groups, 
+00018970: 6769 6e5f 6368 616e 6e65 6c73 2c20 6261  gin_channels, ba
+00018980: 7463 685d 202b 2074 5f73 7061 7469 616c  tch] + t_spatial
+00018990: 5f64 696d 7329 0a20 2020 2020 2020 2023  _dims).        #
+000189a0: 2054 7261 6e73 706f 7365 2028 6772 6f75   Transpose (grou
+000189b0: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
+000189c0: 2c20 6261 7463 6829 202d 3e20 2867 696e  , batch) -> (gin
+000189d0: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
+000189e0: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
+000189f0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
+00018a00: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
+00018a10: 2320 466c 6174 7465 6e20 2867 726f 7570  # Flatten (group
+00018a20: 732c 2062 6174 6368 2920 2d3e 2028 6772  s, batch) -> (gr
+00018a30: 6f75 7073 202a 2062 6174 6368 2c29 0a20  oups * batch,). 
+00018a40: 2020 2020 2020 2074 203d 2074 2e72 6573         t = t.res
+00018a50: 6861 7065 285b 6769 6e5f 6368 616e 6e65  hape([gin_channe
+00018a60: 6c73 2c20 6772 6f75 7073 202a 2062 6174  ls, groups * bat
+00018a70: 6368 5d20 2b20 745f 7370 6174 6961 6c5f  ch] + t_spatial_
+00018a80: 6469 6d73 290a 2020 2020 2020 2020 7265  dims).        re
+00018a90: 7475 726e 2074 0a0a 2020 2020 2320 696e  turn t..    # in
+00018aa0: 7075 7420 7769 6c6c 2068 6176 6520 7368  put will have sh
+00018ab0: 6170 6520 2867 696e 5f63 6861 6e6e 656c  ape (gin_channel
+00018ac0: 732c 2067 726f 7570 7320 2a20 6261 7463  s, groups * batc
+00018ad0: 6829 0a20 2020 2069 6e70 7574 203d 2070  h).    input = p
+00018ae0: 6164 5f74 7261 6e73 706f 7365 5f61 6e64  ad_transpose_and
+00018af0: 5f70 7573 685f 6772 6f75 7073 5f69 6e74  _push_groups_int
+00018b00: 6f5f 6261 7463 6865 7328 696e 7075 7429  o_batches(input)
+00018b10: 0a20 2020 2023 2067 7261 6420 7769 6c6c  .    # grad will
+00018b20: 2068 6176 6520 7368 6170 6520 286f 7574   have shape (out
+00018b30: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
+00018b40: 290a 2020 2020 2320 4e6f 7465 2074 6861  ).    # Note tha
+00018b50: 7420 7468 6573 6520 7368 6170 6573 2061  t these shapes a
+00018b60: 7265 2063 6f6d 7061 7469 626c 6520 666f  re compatible fo
+00018b70: 7220 6120 6772 6f75 7020 636f 6e76 6f6c  r a group convol
+00018b80: 7574 696f 6e2e 0a20 2020 2067 7261 6420  ution..    grad 
+00018b90: 3d20 636f 6e76 5f74 7261 6e73 706f 7365  = conv_transpose
+00018ba0: 2867 7261 6429 0a0a 2020 2020 2320 5768  (grad)..    # Wh
+00018bb0: 7920 646f 2077 6520 666c 6970 2073 7472  y do we flip str
+00018bc0: 6964 6520 616e 6420 6469 6c61 7469 6f6e  ide and dilation
+00018bd0: 3f0a 2020 2020 2320 6b65 726e 656c 5b69  ?.    # kernel[i
+00018be0: 5d20 616e 6420 6b65 726e 656c 5b69 202b  ] and kernel[i +
+00018bf0: 2031 5d20 6172 6520 6469 6c61 7469 6f6e   1] are dilation
+00018c00: 2061 7061 7274 2066 726f 6d20 6561 6368   apart from each
+00018c10: 206f 7468 6572 2c0a 2020 2020 2320 736f   other,.    # so
+00018c20: 2064 696c 6174 696f 6e20 6265 636f 6d65   dilation become
+00018c30: 7320 7468 6520 6e65 7720 7374 7269 6465  s the new stride
+00018c40: 2e0a 2020 2020 2320 416c 6c20 7468 6520  ..    # All the 
+00018c50: 656c 656d 656e 7473 2074 6861 7420 6b65  elements that ke
+00018c60: 726e 656c 5b69 5d20 746f 7563 6865 7320  rnel[i] touches 
+00018c70: 6172 6520 7374 7269 6465 2061 7761 7920  are stride away 
+00018c80: 6672 6f6d 2065 6163 6820 6f74 6865 722c  from each other,
+00018c90: 0a20 2020 2023 2068 656e 6365 2073 7472  .    # hence str
+00018ca0: 6964 6520 6265 636f 6d65 7320 7468 6520  ide becomes the 
+00018cb0: 6e65 7720 6469 6c61 7469 6f6e 2e0a 2020  new dilation..  
+00018cc0: 2020 7765 6967 6874 5f67 7261 6420 3d20    weight_grad = 
+00018cd0: 636f 6e76 6f6c 7574 696f 6e28 0a20 2020  convolution(.   
+00018ce0: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+00018cf0: 2020 2020 6772 6164 2c0a 2020 2020 2020      grad,.      
+00018d00: 2020 4e6f 6e65 2c0a 2020 2020 2020 2020    None,.        
+00018d10: 6469 6c61 7469 6f6e 2c20 2023 2073 6574  dilation,  # set
+00018d20: 2073 7472 6964 653d 6469 6c61 7469 6f6e   stride=dilation
+00018d30: 0a20 2020 2020 2020 2028 302c 292c 0a20  .        (0,),. 
+00018d40: 2020 2020 2020 2073 7472 6964 652c 2020         stride,  
+00018d50: 2320 7365 7420 6469 6c61 7469 6f6e 3d73  # set dilation=s
+00018d60: 7472 6964 650a 2020 2020 2020 2020 7472  tride.        tr
+00018d70: 616e 7370 6f73 6564 2c0a 2020 2020 2020  ansposed,.      
+00018d80: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00018d90: 2c0a 2020 2020 2020 2020 6772 6f75 7073  ,.        groups
+00018da0: 2c0a 2020 2020 290a 0a20 2020 2023 2054  ,.    )..    # T
+00018db0: 6865 2072 6573 756c 7420 6f66 2074 6865  he result of the
+00018dc0: 2063 6f6e 766f 6c75 7469 6f6e 2068 6173   convolution has
+00018dd0: 2073 6861 7065 2028 6769 6e5f 6368 616e   shape (gin_chan
+00018de0: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
+00018df0: 6c73 292c 0a20 2020 2023 2073 6f20 7472  ls),.    # so tr
+00018e00: 616e 7370 6f73 6974 696f 6e20 6973 2072  ansposition is r
+00018e10: 6571 7569 7265 642e 0a20 2020 2077 6569  equired..    wei
+00018e20: 6768 745f 6772 6164 203d 2063 6f6e 765f  ght_grad = conv_
+00018e30: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
+00018e40: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
+00018e50: 2020 2020 7265 7475 726e 2028 696e 7075      return (inpu
+00018e60: 745f 6772 6164 2c20 7765 6967 6874 5f67  t_grad, weight_g
+00018e70: 7261 642c 2062 6961 735f 6772 6164 290a  rad, bias_grad).
+00018e80: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+00018e90: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+00018ea0: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
+00018eb0: 2229 0a64 6566 206c 6f67 5f73 6f66 746d  ").def log_softm
+00018ec0: 6178 5f61 7567 5f66 7764 2869 6e70 7574  ax_aug_fwd(input
+00018ed0: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
+00018ee0: 696d 3a20 696e 742c 202a 2c20 6474 7970  im: int, *, dtyp
+00018ef0: 653d 4e6f 6e65 2920 2d3e 2056 4a50 4475  e=None) -> VJPDu
+00018f00: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
+00018f10: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+00018f20: 7420 6c6f 675f 736f 6674 6d61 780a 0a20  t log_softmax.. 
+00018f30: 2020 2070 7269 6d61 6c20 3d20 6c6f 675f     primal = log_
+00018f40: 736f 6674 6d61 7828 696e 7075 742c 2064  softmax(input, d
+00018f50: 696d 3d64 696d 2c20 6474 7970 653d 6474  im=dim, dtype=dt
+00018f60: 7970 6529 0a20 2020 2072 6573 6964 7561  ype).    residua
+00018f70: 6c73 203d 2028 7072 696d 616c 2c20 6469  ls = (primal, di
+00018f80: 6d2c 2069 6e70 7574 2e64 7479 7065 290a  m, input.dtype).
+00018f90: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00018fa0: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00018fb0: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00018fc0: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
+00018fd0: 682e 6c6f 675f 736f 6674 6d61 7822 290a  h.log_softmax").
+00018fe0: 6465 6620 6c6f 675f 736f 6674 6d61 785f  def log_softmax_
+00018ff0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+00019000: 2064 696d 2c20 6474 7970 652c 2067 293a   dim, dtype, g):
+00019010: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00019020: 722e 746f 7263 6820 696d 706f 7274 206c  r.torch import l
+00019030: 6f67 5f73 6f66 746d 6178 5f62 6163 6b77  og_softmax_backw
+00019040: 6172 640a 0a20 2020 2072 6574 7572 6e20  ard..    return 
+00019050: 6c6f 675f 736f 6674 6d61 785f 6261 636b  log_softmax_back
+00019060: 7761 7264 2867 2c20 7072 696d 616c 2c20  ward(g, primal, 
+00019070: 6469 6d2c 2064 7479 7065 290a 0a0a 4072  dim, dtype)...@r
+00019080: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+00019090: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
+000190a0: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6e  .nn.functional.n
+000190b0: 6c6c 5f6c 6f73 7322 290a 6465 6620 6e6c  ll_loss").def nl
+000190c0: 6c5f 6c6f 7373 5f61 7567 5f66 7764 280a  l_loss_aug_fwd(.
+000190d0: 2020 2020 696e 7075 743a 2050 726f 7879      input: Proxy
+000190e0: 2c0a 2020 2020 7461 7267 6574 3a20 5072  ,.    target: Pr
+000190f0: 6f78 792c 0a20 2020 2077 6569 6768 743a  oxy,.    weight:
+00019100: 204e 6f6e 6520 7c20 5072 6f78 792c 0a20   None | Proxy,. 
+00019110: 2020 2069 676e 6f72 655f 696e 6465 783a     ignore_index:
+00019120: 2069 6e74 2c0a 2020 2020 7265 6475 6374   int,.    reduct
+00019130: 696f 6e3a 2073 7472 2c0a 2920 2d3e 2056  ion: str,.) -> V
+00019140: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
+00019150: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00019160: 6d70 6f72 7420 5f6e 6c6c 5f6c 6f73 735f  mport _nll_loss_
+00019170: 6865 6c70 6572 0a0a 2020 2020 7072 696d  helper..    prim
+00019180: 616c 2c20 746f 7461 6c5f 7765 6967 6874  al, total_weight
+00019190: 203d 205f 6e6c 6c5f 6c6f 7373 5f68 656c   = _nll_loss_hel
+000191a0: 7065 7228 0a20 2020 2020 2020 2069 6e70  per(.        inp
+000191b0: 7574 2c0a 2020 2020 2020 2020 7461 7267  ut,.        targ
+000191c0: 6574 2c0a 2020 2020 2020 2020 7765 6967  et,.        weig
+000191d0: 6874 2c0a 2020 2020 2020 2020 6967 6e6f  ht,.        igno
+000191e0: 7265 5f69 6e64 6578 2c0a 2020 2020 2020  re_index,.      
+000191f0: 2020 7265 6475 6374 696f 6e2c 0a20 2020    reduction,.   
+00019200: 2029 0a20 2020 2072 6573 6964 7561 6c73   ).    residuals
+00019210: 203d 2028 696e 7075 742c 2074 6172 6765   = (input, targe
+00019220: 742c 2077 6569 6768 742c 2072 6564 7563  t, weight, reduc
+00019230: 7469 6f6e 2c20 6967 6e6f 7265 5f69 6e64  tion, ignore_ind
+00019240: 6578 2c20 746f 7461 6c5f 7765 6967 6874  ex, total_weight
+00019250: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+00019260: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+00019270: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+00019280: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
+00019290: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+000192a0: 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64 6566  l.nll_loss").def
+000192b0: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
+000192c0: 7264 2869 6e70 7574 2c20 7461 7267 6574  rd(input, target
+000192d0: 2c20 7765 6967 6874 2c20 7265 6475 6374  , weight, reduct
+000192e0: 696f 6e2c 2069 676e 6f72 655f 696e 6465  ion, ignore_inde
+000192f0: 782c 2074 6f74 616c 5f77 6569 6768 742c  x, total_weight,
+00019300: 2067 293a 0a20 2020 2066 726f 6d20 7468   g):.    from th
+00019310: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
+00019320: 7274 206e 6c6c 5f6c 6f73 735f 6261 636b  rt nll_loss_back
+00019330: 7761 7264 0a0a 2020 2020 6769 6e70 7574  ward..    ginput
+00019340: 203d 206e 6c6c 5f6c 6f73 735f 6261 636b   = nll_loss_back
+00019350: 7761 7264 2867 2c20 696e 7075 742c 2074  ward(g, input, t
+00019360: 6172 6765 742c 2077 6569 6768 742c 2072  arget, weight, r
+00019370: 6564 7563 7469 6f6e 2c20 6967 6e6f 7265  eduction, ignore
+00019380: 5f69 6e64 6578 2c20 746f 7461 6c5f 7765  _index, total_we
+00019390: 6967 6874 290a 2020 2020 7265 7475 726e  ight).    return
+000193a0: 2067 696e 7075 742c 202a 2828 4e6f 6e65   ginput, *((None
+000193b0: 2c29 202a 2034 290a 0a0a 4072 6567 6973  ,) * 4)...@regis
+000193c0: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+000193d0: 7277 6172 6428 2274 6f72 6368 2e73 706c  rward("torch.spl
+000193e0: 6974 2229 0a64 6566 2073 706c 6974 5f61  it").def split_a
+000193f0: 7567 5f66 7764 2861 3a20 5465 6e73 6f72  ug_fwd(a: Tensor
+00019400: 5072 6f78 792c 2073 706c 6974 5f73 697a  Proxy, split_siz
+00019410: 655f 6f72 5f73 6563 7469 6f6e 733a 2069  e_or_sections: i
+00019420: 6e74 207c 2053 6571 7565 6e63 655b 696e  nt | Sequence[in
+00019430: 745d 2c20 6469 6d3a 2069 6e74 203d 2030  t], dim: int = 0
+00019440: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
+00019450: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00019460: 6f72 6368 2069 6d70 6f72 7420 7370 6c69  orch import spli
+00019470: 740a 0a20 2020 2070 7269 6d61 6c20 3d20  t..    primal = 
+00019480: 7370 6c69 7428 612c 2073 706c 6974 5f73  split(a, split_s
+00019490: 697a 655f 6f72 5f73 6563 7469 6f6e 732c  ize_or_sections,
+000194a0: 2064 696d 290a 2020 2020 7265 7369 6475   dim).    residu
+000194b0: 616c 7320 3d20 2864 696d 2c29 0a20 2020  als = (dim,).   
+000194c0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+000194d0: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+000194e0: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+000194f0: 6163 6b77 6172 6428 2274 6f72 6368 2e73  ackward("torch.s
+00019500: 706c 6974 2229 0a64 6566 2073 706c 6974  plit").def split
+00019510: 5f62 6163 6b77 6172 6428 6469 6d2c 202a  _backward(dim, *
+00019520: 6772 6164 7329 3a0a 2020 2020 6672 6f6d  grads):.    from
+00019530: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00019540: 6d70 6f72 7420 6361 740a 0a20 2020 2072  mport cat..    r
+00019550: 6574 7572 6e20 6361 7428 6772 6164 732c  eturn cat(grads,
+00019560: 2064 696d 290a 0a0a 4072 6567 6973 7465   dim)...@registe
+00019570: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+00019580: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
+00019590: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
+000195a0: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
+000195b0: 6e67 5f61 7567 5f66 7764 280a 2020 2020  ng_aug_fwd(.    
+000195c0: 613a 2050 726f 7879 2c0a 2020 2020 7765  a: Proxy,.    we
+000195d0: 6967 6874 3a20 5072 6f78 792c 0a20 2020  ight: Proxy,.   
+000195e0: 2070 6164 6469 6e67 5f69 6478 3a20 696e   padding_idx: in
+000195f0: 7420 7c20 4e6f 6e65 2c0a 2020 2020 6d61  t | None,.    ma
+00019600: 785f 6e6f 726d 3a20 666c 6f61 7420 7c20  x_norm: float | 
+00019610: 4e6f 6e65 2c0a 2020 2020 6e6f 726d 5f74  None,.    norm_t
+00019620: 7970 653a 2066 6c6f 6174 2c0a 2020 2020  ype: float,.    
+00019630: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+00019640: 6571 3a20 626f 6f6c 2c0a 2020 2020 7370  eq: bool,.    sp
+00019650: 6172 7365 3a20 626f 6f6c 2c0a 2920 2d3e  arse: bool,.) ->
+00019660: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
+00019670: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00019680: 2069 6d70 6f72 7420 656d 6265 6464 696e   import embeddin
+00019690: 670a 0a20 2020 2070 7269 6d61 6c20 3d20  g..    primal = 
+000196a0: 656d 6265 6464 696e 6728 0a20 2020 2020  embedding(.     
+000196b0: 2020 2061 2c0a 2020 2020 2020 2020 7765     a,.        we
+000196c0: 6967 6874 2c0a 2020 2020 2020 2020 7061  ight,.        pa
+000196d0: 6464 696e 675f 6964 783d 7061 6464 696e  dding_idx=paddin
+000196e0: 675f 6964 782c 0a20 2020 2020 2020 206d  g_idx,.        m
+000196f0: 6178 5f6e 6f72 6d3d 6d61 785f 6e6f 726d  ax_norm=max_norm
+00019700: 2c0a 2020 2020 2020 2020 6e6f 726d 5f74  ,.        norm_t
+00019710: 7970 653d 6e6f 726d 5f74 7970 652c 0a20  ype=norm_type,. 
+00019720: 2020 2020 2020 2073 6361 6c65 5f67 7261         scale_gra
+00019730: 645f 6279 5f66 7265 713d 7363 616c 655f  d_by_freq=scale_
+00019740: 6772 6164 5f62 795f 6672 6571 2c0a 2020  grad_by_freq,.  
+00019750: 2020 2020 2020 7370 6172 7365 3d73 7061        sparse=spa
+00019760: 7273 652c 0a20 2020 2029 0a20 2020 2072  rse,.    ).    r
+00019770: 6573 6964 7561 6c73 203d 2028 612c 2077  esiduals = (a, w
+00019780: 6569 6768 742e 7368 6170 655b 305d 2c20  eight.shape[0], 
+00019790: 7061 6464 696e 675f 6964 782c 2073 6361  padding_idx, sca
+000197a0: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
+000197b0: 2073 7061 7273 6529 0a20 2020 2072 6574   sparse).    ret
+000197c0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+000197d0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+000197e0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000197f0: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
+00019800: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
+00019810: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
+00019820: 6e67 5f62 6163 6b77 6172 6428 612c 206e  ng_backward(a, n
+00019830: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
+00019840: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
+00019850: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
+00019860: 7273 652c 2067 293a 0a20 2020 2066 726f  rse, g):.    fro
+00019870: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00019880: 696d 706f 7274 2065 6d62 6564 6469 6e67  import embedding
+00019890: 5f62 6163 6b77 6172 640a 0a20 2020 2070  _backward..    p
+000198a0: 6164 6469 6e67 5f69 6478 203d 202d 3120  adding_idx = -1 
+000198b0: 6966 2070 6164 6469 6e67 5f69 6478 2069  if padding_idx i
+000198c0: 7320 4e6f 6e65 2065 6c73 6520 7061 6464  s None else padd
+000198d0: 696e 675f 6964 780a 2020 2020 6777 6569  ing_idx.    gwei
+000198e0: 6768 7420 3d20 656d 6265 6464 696e 675f  ght = embedding_
+000198f0: 6261 636b 7761 7264 2867 2c20 612c 206e  backward(g, a, n
+00019900: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
+00019910: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
+00019920: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
+00019930: 7273 6529 0a20 2020 2072 6574 7572 6e20  rse).    return 
+00019940: 6777 6569 6768 740a 0a0a 4072 6567 6973  gweight...@regis
+00019950: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00019960: 7277 6172 6428 2274 6f72 6368 2e63 756d  rward("torch.cum
+00019970: 7375 6d22 290a 6465 6620 6375 6d73 756d  sum").def cumsum
+00019980: 5f61 7567 5f66 7764 2861 3a20 5072 6f78  _aug_fwd(a: Prox
+00019990: 792c 2064 696d 3a20 696e 742c 202a 2c20  y, dim: int, *, 
+000199a0: 6474 7970 653a 204e 6f6e 6520 7c20 6474  dtype: None | dt
+000199b0: 7970 6573 2e64 7479 7065 203d 204e 6f6e  ypes.dtype = Non
+000199c0: 6529 202d 3e20 564a 5044 7561 6c3a 0a20  e) -> VJPDual:. 
+000199d0: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+000199e0: 746f 7263 6820 696d 706f 7274 2063 756d  torch import cum
+000199f0: 7375 6d0a 0a20 2020 2070 7269 6d61 6c20  sum..    primal 
+00019a00: 3d20 6375 6d73 756d 2861 2c20 6469 6d2c  = cumsum(a, dim,
+00019a10: 2064 7479 7065 3d64 7479 7065 290a 2020   dtype=dtype).  
+00019a20: 2020 7265 7369 6475 616c 7320 3d20 280a    residuals = (.
+00019a30: 2020 2020 2020 2020 612e 6474 7970 652c          a.dtype,
+00019a40: 0a20 2020 2020 2020 2064 696d 2c0a 2020  .        dim,.  
+00019a50: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
+00019a60: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00019a70: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
+00019a80: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
+00019a90: 746f 7263 682e 6375 6d73 756d 2229 0a64  torch.cumsum").d
+00019aa0: 6566 2063 756d 7375 6d5f 6261 636b 7761  ef cumsum_backwa
+00019ab0: 7264 2861 5f64 7479 7065 2c20 6469 6d2c  rd(a_dtype, dim,
+00019ac0: 2067 293a 0a20 2020 2067 203d 2067 2e74   g):.    g = g.t
+00019ad0: 6f28 615f 6474 7970 6529 0a20 2020 2069  o(a_dtype).    i
+00019ae0: 6620 672e 6e75 6d65 6c28 2920 3c3d 2031  f g.numel() <= 1
+00019af0: 206f 7220 672e 7368 6170 655b 6469 6d5d   or g.shape[dim]
+00019b00: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
+00019b10: 6574 7572 6e20 670a 2020 2020 7265 7475  eturn g.    retu
+00019b20: 726e 2067 2e66 6c69 7028 6469 6d29 2e63  rn g.flip(dim).c
+00019b30: 756d 7375 6d28 6469 6d29 2e66 6c69 7028  umsum(dim).flip(
+00019b40: 6469 6d29 0a0a 0a40 7265 6769 7374 6572  dim)...@register
+00019b50: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+00019b60: 7264 2822 746f 7263 682e 736f 6674 6d61  rd("torch.softma
+00019b70: 7822 290a 6465 6620 736f 6674 6d61 785f  x").def softmax_
+00019b80: 6175 675f 6677 6428 613a 2050 726f 7879  aug_fwd(a: Proxy
+00019b90: 2c20 6469 6d3a 2069 6e74 2c20 6474 7970  , dim: int, dtyp
+00019ba0: 653a 2064 7479 7065 732e 6474 7970 6520  e: dtypes.dtype 
+00019bb0: 7c20 4e6f 6e65 203d 204e 6f6e 6529 202d  | None = None) -
+00019bc0: 3e20 564a 5044 7561 6c3a 0a20 2020 2066  > VJPDual:.    f
+00019bd0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+00019be0: 6820 696d 706f 7274 2073 6f66 746d 6178  h import softmax
+00019bf0: 0a0a 2020 2020 7072 696d 616c 203d 2073  ..    primal = s
+00019c00: 6f66 746d 6178 2861 2c20 6469 6d2c 2064  oftmax(a, dim, d
+00019c10: 7479 7065 3d64 7479 7065 290a 2020 2020  type=dtype).    
+00019c20: 7265 7369 6475 616c 7320 3d20 2870 7269  residuals = (pri
+00019c30: 6d61 6c2c 2064 696d 290a 2020 2020 7265  mal, dim).    re
+00019c40: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+00019c50: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+00019c60: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00019c70: 7761 7264 2822 746f 7263 682e 736f 6674  ward("torch.soft
+00019c80: 6d61 7822 290a 6465 6620 736f 6674 6d61  max").def softma
+00019c90: 785f 6261 636b 7761 7264 2870 7269 6d61  x_backward(prima
+00019ca0: 6c2c 2064 696d 2c20 6729 3a0a 2020 2020  l, dim, g):.    
+00019cb0: 7265 7475 726e 2070 7269 6d61 6c20 2a20  return primal * 
+00019cc0: 2867 202d 2028 7072 696d 616c 202a 2067  (g - (primal * g
+00019cd0: 292e 7375 6d28 6469 6d2c 206b 6565 7064  ).sum(dim, keepd
+00019ce0: 696d 3d54 7275 6529 290a 0a0a 6465 6620  im=True))...def 
+00019cf0: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
+00019d00: 6c73 2862 6f75 6e64 5f73 796d 626f 6c73  ls(bound_symbols
+00019d10: 293a 0a20 2020 2022 2222 4974 6572 6174  ):.    """Iterat
+00019d20: 6520 6f76 6572 2062 6f75 6e64 2073 796d  e over bound sym
+00019d30: 626f 6c73 2c20 736b 6970 7069 6e67 2073  bols, skipping s
+00019d40: 796d 626f 6c73 2074 6861 7420 6172 6520  ymbols that are 
+00019d50: 6e6f 7420 7375 7070 6f72 7465 6420 6279  not supported by
+00019d60: 0a20 2020 2074 6865 2074 7261 6e73 666f  .    the transfo
+00019d70: 726d 7320 696e 6672 6173 7472 7563 7475  rms infrastructu
+00019d80: 7265 2e0a 0a20 2020 2041 7267 733a 0a20  re...    Args:. 
+00019d90: 2020 2020 2020 2062 6f75 6e64 5f73 796d         bound_sym
+00019da0: 626f 6c73 2028 4c69 7374 5b42 6f75 6e64  bols (List[Bound
+00019db0: 5379 6d62 6f6c 5d29 3a20 4c69 7374 206f  Symbol]): List o
+00019dc0: 6620 626f 756e 6420 7379 6d62 6f6c 730a  f bound symbols.
+00019dd0: 0a20 2020 2059 6965 6c64 733a 0a20 2020  .    Yields:.   
+00019de0: 2020 2020 2042 6f75 6e64 5379 6d62 6f6c       BoundSymbol
+00019df0: 3a20 426f 756e 6420 7379 6d62 6f6c 7320  : Bound symbols 
+00019e00: 7468 6174 2061 7265 2073 7570 706f 7274  that are support
+00019e10: 6564 2062 7920 7468 6520 7472 616e 7366  ed by the transf
+00019e20: 6f72 6d73 0a20 2020 2020 2020 2069 6e66  orms.        inf
+00019e30: 7261 7374 7275 6374 7572 650a 2020 2020  rastructure.    
+00019e40: 2222 220a 2020 2020 666f 7220 7379 6d62  """.    for symb
+00019e50: 6f6c 2069 6e20 626f 756e 645f 7379 6d62  ol in bound_symb
+00019e60: 6f6c 733a 0a20 2020 2020 2020 2069 6620  ols:.        if 
+00019e70: 7379 6d62 6f6c 2e73 796d 2e69 6420 696e  symbol.sym.id in
+00019e80: 2074 7261 6e73 666f 726d 5f73 6b69 705f   transform_skip_
+00019e90: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+00019ea0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00019eb0: 2020 2065 6c69 6620 7379 6d62 6f6c 2e6f     elif symbol.o
+00019ec0: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
+00019ed0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00019ee0: 6e75 650a 2020 2020 2020 2020 656c 7365  nue.        else
+00019ef0: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
+00019f00: 656c 6420 7379 6d62 6f6c 0a0a 0a64 6566  eld symbol...def
+00019f10: 2064 6563 6f6e 7374 7275 6374 5f66 6f72   deconstruct_for
+00019f20: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
+00019f30: 6b77 6172 6428 7472 6163 652c 2065 6e76  kward(trace, env
+00019f40: 293a 0a20 2020 2023 204e 6f74 6520 5b53  ):.    # Note [S
+00019f50: 6176 696e 6720 7468 6520 666f 7277 6172  aving the forwar
+00019f60: 6420 656e 7669 726f 6e6d 656e 7420 696e  d environment in
+00019f70: 2074 6865 2062 6163 6b77 6172 6420 7275   the backward ru
+00019f80: 6c65 5d0a 2020 2020 2320 5765 2063 616e  le].    # We can
+00019f90: 6e6f 7420 7361 7665 2074 6865 2074 7261  not save the tra
+00019fa0: 6365 206f 626a 6563 7420 696e 2074 6865  ce object in the
+00019fb0: 2072 6573 6964 7561 6c73 2062 6563 6175   residuals becau
+00019fc0: 7365 2065 7865 6375 746f 7273 206d 6179  se executors may
+00019fd0: 206e 6f74 0a20 2020 2023 2062 6520 6162   not.    # be ab
+00019fe0: 6c65 2074 6f20 7265 7475 726e 2069 7420  le to return it 
+00019ff0: 666f 7220 7468 6520 7370 6c69 7474 6564  for the splitted
+0001a000: 2066 6f72 7761 7264 2f62 6163 6b77 6172   forward/backwar
+0001a010: 6420 7061 7373 6573 2e20 496e 7374 6561  d passes. Instea
+0001a020: 642c 2077 650a 2020 2020 2320 7361 7665  d, we.    # save
+0001a030: 2061 7267 7320 616e 6420 6b77 6172 6773   args and kwargs
+0001a040: 206f 6620 7468 6520 6f72 6967 696e 616c   of the original
+0001a050: 2066 756e 6374 696f 6e20 6361 6c6c 2061   function call a
+0001a060: 6e64 2072 6563 6f6e 7374 7275 6374 2074  nd reconstruct t
+0001a070: 6865 0a20 2020 2023 2074 7261 6365 206f  he.    # trace o
+0001a080: 626a 6563 7420 616e 6420 6974 7320 656e  bject and its en
+0001a090: 7669 726f 6e6d 656e 7420 6469 6374 2069  vironment dict i
+0001a0a0: 6e20 7468 6520 6261 636b 7761 7264 2072  n the backward r
+0001a0b0: 756c 652e 2048 6572 6520 7765 2072 656c  ule. Here we rel
+0001a0c0: 790a 2020 2020 2320 6f6e 2074 6865 2066  y.    # on the f
+0001a0d0: 6163 7420 7468 6174 2074 6865 206f 7264  act that the ord
+0001a0e0: 6572 206f 6620 7468 6520 7379 6d62 6f6c  er of the symbol
+0001a0f0: 7320 696e 2074 6865 2074 7261 6365 2069  s in the trace i
+0001a100: 7320 6465 7465 726d 696e 6973 7469 630a  s deterministic.
+0001a110: 2020 2020 2320 616e 6420 616c 7761 7973      # and always
+0001a120: 2074 6865 2073 616d 6520 666f 7220 7468   the same for th
+0001a130: 6520 7361 6d65 2066 756e 6374 696f 6e20  e same function 
+0001a140: 6361 6c6c 2061 6e64 2074 6865 2073 616d  call and the sam
+0001a150: 6520 7365 7420 6f66 0a20 2020 2023 2061  e set of.    # a
+0001a160: 7267 756d 656e 7473 2e20 5365 6520 7465  rguments. See te
+0001a170: 7374 5f67 7261 642e 7079 3a74 6573 745f  st_grad.py:test_
+0001a180: 746f 7263 685f 6175 746f 6772 6164 5f66  torch_autograd_f
+0001a190: 756e 6374 696f 6e20 666f 7220 616e 2065  unction for an e
+0001a1a0: 7861 6d70 6c65 0a20 2020 2023 2077 6865  xample.    # whe
+0001a1b0: 7265 2074 6869 7320 6973 2074 6573 7465  re this is teste
+0001a1c0: 642e 0a20 2020 2062 6f75 6e64 5f73 796d  d..    bound_sym
+0001a1d0: 626f 6c73 203d 2069 7465 725f 626f 756e  bols = iter_boun
+0001a1e0: 645f 7379 6d62 6f6c 7328 7472 6163 652e  d_symbols(trace.
+0001a1f0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
+0001a200: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+0001a210: 6b77 6172 6420 3d20 7475 706c 6528 656e  kward = tuple(en
+0001a220: 765b 7365 7175 656e 6369 6679 2873 796d  v[sequencify(sym
+0001a230: 626f 6c2e 6f75 7470 7574 295b 305d 2e6e  bol.output)[0].n
+0001a240: 616d 655d 2e72 6573 6964 7561 6c73 2066  ame].residuals f
+0001a250: 6f72 2073 796d 626f 6c20 696e 2062 6f75  or symbol in bou
+0001a260: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
+0001a270: 7265 7475 726e 2073 6176 6564 5f66 6f72  return saved_for
+0001a280: 5f62 6163 6b77 6172 640a 0a0a 6465 6620  _backward...def 
+0001a290: 7265 636f 6e73 7472 7563 745f 666f 7277  reconstruct_forw
+0001a2a0: 6172 645f 656e 765f 666f 725f 6261 636b  ard_env_for_back
+0001a2b0: 7761 7264 2874 7261 6365 2c20 7361 7665  ward(trace, save
+0001a2c0: 645f 666f 725f 6261 636b 7761 7264 293a  d_for_backward):
+0001a2d0: 0a20 2020 2062 6f75 6e64 5f73 796d 626f  .    bound_symbo
+0001a2e0: 6c73 203d 2069 7465 725f 626f 756e 645f  ls = iter_bound_
+0001a2f0: 7379 6d62 6f6c 7328 7472 6163 652e 626f  symbols(trace.bo
+0001a300: 756e 645f 7379 6d62 6f6c 7329 0a0a 2020  und_symbols)..  
+0001a310: 2020 7265 636f 6e73 7472 7563 7465 645f    reconstructed_
+0001a320: 656e 7620 3d20 7b7d 0a0a 2020 2020 666f  env = {}..    fo
+0001a330: 7220 6964 782c 2073 796d 2069 6e20 656e  r idx, sym in en
+0001a340: 756d 6572 6174 6528 626f 756e 645f 7379  umerate(bound_sy
+0001a350: 6d62 6f6c 7329 3a0a 2020 2020 2020 2020  mbols):.        
+0001a360: 6b20 3d20 7365 7175 656e 6369 6679 2873  k = sequencify(s
+0001a370: 796d 2e6f 7574 7075 7429 5b30 5d2e 6e61  ym.output)[0].na
+0001a380: 6d65 0a20 2020 2020 2020 2076 203d 2056  me.        v = V
+0001a390: 4a50 4475 616c 284e 6f6e 652c 2073 6176  JPDual(None, sav
+0001a3a0: 6564 5f66 6f72 5f62 6163 6b77 6172 645b  ed_for_backward[
+0001a3b0: 6964 785d 290a 2020 2020 2020 2020 7265  idx]).        re
+0001a3c0: 636f 6e73 7472 7563 7465 645f 656e 765b  constructed_env[
+0001a3d0: 6b5d 203d 2076 0a0a 2020 2020 7265 7475  k] = v..    retu
+0001a3e0: 726e 2072 6563 6f6e 7374 7275 6374 6564  rn reconstructed
+0001a3f0: 5f65 6e76 0a0a 0a64 6566 2064 6563 6f6d  _env...def decom
+0001a400: 706f 7365 645f 666e 5f61 7567 5f66 7764  posed_fn_aug_fwd
+0001a410: 5f72 756c 6528 2a61 7267 732c 2064 6563  _rule(*args, dec
+0001a420: 6f6d 706f 7365 645f 666e 2c20 2a2a 6b77  omposed_fn, **kw
+0001a430: 6172 6773 293a 0a20 2020 2022 2222 4175  args):.    """Au
+0001a440: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
+0001a450: 7275 6c65 2066 6f72 2063 6f6d 706f 7369  rule for composi
+0001a460: 7465 2066 756e 6374 696f 6e73 2069 6d70  te functions imp
+0001a470: 6c65 6d65 6e74 6564 2069 6e20 7465 726d  lemented in term
+0001a480: 7320 6f66 206f 7468 6572 2066 756e 6374  s of other funct
+0001a490: 696f 6e73 2074 6861 7420 6172 650a 2020  ions that are.  
+0001a4a0: 2020 7375 7070 6f73 6564 2074 6f20 6265    supposed to be
+0001a4b0: 2073 7570 706f 7274 6564 2062 7920 7468   supported by th
+0001a4c0: 6520 564a 5020 696e 6672 6173 7472 7563  e VJP infrastruc
+0001a4d0: 7475 7265 2e0a 0a20 2020 2041 7267 733a  ture...    Args:
+0001a4e0: 0a20 2020 2020 2020 2064 6563 6f6d 706f  .        decompo
+0001a4f0: 7365 645f 666e 2028 4361 6c6c 6162 6c65  sed_fn (Callable
+0001a500: 293a 2064 6563 6f6d 706f 7365 6420 7665  ): decomposed ve
+0001a510: 7273 696f 6e20 6f66 2074 6865 2066 756e  rsion of the fun
+0001a520: 6374 696f 6e0a 0a20 2020 2052 6574 7572  ction..    Retur
+0001a530: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+0001a540: 6162 6c65 3a20 4175 676d 656e 7465 6420  able: Augmented 
+0001a550: 666f 7277 6172 6420 7275 6c65 2066 6f72  forward rule for
+0001a560: 2074 6865 2063 6f6d 706f 7369 7465 2066   the composite f
+0001a570: 756e 6374 696f 6e0a 2020 2020 2222 220a  unction.    """.
+0001a580: 2020 2020 7472 6163 6520 3d20 636f 6e73      trace = cons
+0001a590: 7472 7563 745f 7472 6163 6528 2928 6465  truct_trace()(de
+0001a5a0: 636f 6d70 6f73 6564 5f66 6e2c 202a 6172  composed_fn, *ar
+0001a5b0: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
+0001a5c0: 2020 7472 6163 6520 3d20 756e 7772 6170    trace = unwrap
+0001a5d0: 5f6f 6e65 5f6c 6576 656c 5f6f 665f 7375  _one_level_of_su
+0001a5e0: 6273 796d 626f 6c73 2874 7261 6365 290a  bsymbols(trace).
+0001a5f0: 2020 2020 2320 5468 6572 6520 6d61 7920      # There may 
+0001a600: 6265 2061 2064 6561 6420 6e6f 6465 206c  be a dead node l
+0001a610: 696b 6520 225f 203d 2070 7269 6d73 2e63  ike "_ = prims.c
+0001a620: 6f6e 7665 7274 5f65 6c65 6d65 6e74 5f74  onvert_element_t
+0001a630: 7970 6528 302c 2066 6c6f 6174 2922 0a20  ype(0, float)". 
+0001a640: 2020 2023 2069 6e20 7468 6520 7472 6163     # in the trac
+0001a650: 652e 2057 6520 6e65 6564 2074 6f20 7265  e. We need to re
+0001a660: 6d6f 7665 2069 7420 6265 666f 7265 2077  move it before w
+0001a670: 6520 6361 6e20 7573 6520 7468 6520 7472  e can use the tr
+0001a680: 6163 6520 666f 720a 2020 2020 2320 6175  ace for.    # au
+0001a690: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
+0001a6a0: 7061 7373 2e0a 2020 2020 7472 6163 6520  pass..    trace 
+0001a6b0: 3d20 6463 6528 7472 6163 6529 0a20 2020  = dce(trace).   
+0001a6c0: 2072 6573 756c 742c 2065 6e76 203d 2061   result, env = a
+0001a6d0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001a6e0: 5f70 6173 7328 2a61 7267 732c 2074 7261  _pass(*args, tra
+0001a6f0: 6365 3d74 7261 6365 2c20 2a2a 6b77 6172  ce=trace, **kwar
+0001a700: 6773 290a 2020 2020 7361 7665 645f 666f  gs).    saved_fo
+0001a710: 725f 6261 636b 7761 7264 203d 2064 6563  r_backward = dec
+0001a720: 6f6e 7374 7275 6374 5f66 6f72 7761 7264  onstruct_forward
+0001a730: 5f65 6e76 5f66 6f72 5f62 6163 6b77 6172  _env_for_backwar
+0001a740: 6428 7472 6163 652c 2065 6e76 290a 2020  d(trace, env).  
+0001a750: 2020 2320 5374 6174 6963 2063 6163 6869    # Static cachi
+0001a760: 6e67 2064 6f65 7320 6e6f 7420 7769 7468  ng does not with
+0001a770: 2077 6974 6820 6b77 6172 6773 2064 6963   with kwargs dic
+0001a780: 7473 2c20 736f 2077 6527 7265 2063 6f6e  ts, so we're con
+0001a790: 7665 7274 696e 6720 7468 656d 0a20 2020  verting them.   
+0001a7a0: 2023 2074 6f20 4e6f 6e65 2066 6f72 206e   # to None for n
+0001a7b0: 6f77 2077 6865 6e20 706f 7373 6962 6c65  ow when possible
+0001a7c0: 2e0a 2020 2020 6b77 6172 6773 203d 204e  ..    kwargs = N
+0001a7d0: 6f6e 6520 6966 206e 6f74 206b 7761 7267  one if not kwarg
+0001a7e0: 7320 656c 7365 206b 7761 7267 730a 2020  s else kwargs.  
+0001a7f0: 2020 7265 7369 6475 616c 7320 3d20 2861    residuals = (a
+0001a800: 7267 732c 206b 7761 7267 732c 2073 6176  rgs, kwargs, sav
+0001a810: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+0001a820: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+0001a830: 7561 6c28 7265 7375 6c74 2c20 7265 7369  ual(result, resi
+0001a840: 6475 616c 7329 0a0a 0a64 6566 2064 6563  duals)...def dec
+0001a850: 6f6d 706f 7365 645f 666e 5f62 6163 6b77  omposed_fn_backw
+0001a860: 6172 645f 7275 6c65 2864 6563 6f6d 706f  ard_rule(decompo
+0001a870: 7365 645f 666e 2c20 6172 6773 2c20 6b77  sed_fn, args, kw
+0001a880: 6172 6773 2c20 7361 7665 645f 666f 725f  args, saved_for_
+0001a890: 6261 636b 7761 7264 2c20 2a67 7261 6473  backward, *grads
+0001a8a0: 293a 0a20 2020 206b 7761 7267 7320 3d20  ):.    kwargs = 
+0001a8b0: 7b7d 2069 6620 6b77 6172 6773 2069 7320  {} if kwargs is 
+0001a8c0: 4e6f 6e65 2065 6c73 6520 6b77 6172 6773  None else kwargs
+0001a8d0: 0a20 2020 2074 7261 6365 203d 2063 6f6e  .    trace = con
+0001a8e0: 7374 7275 6374 5f74 7261 6365 2829 2864  struct_trace()(d
+0001a8f0: 6563 6f6d 706f 7365 645f 666e 2c20 2a61  ecomposed_fn, *a
+0001a900: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+0001a910: 2020 2074 7261 6365 203d 2075 6e77 7261     trace = unwra
+0001a920: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
+0001a930: 7562 7379 6d62 6f6c 7328 7472 6163 6529  ubsymbols(trace)
+0001a940: 0a20 2020 2074 7261 6365 203d 2064 6365  .    trace = dce
+0001a950: 2874 7261 6365 290a 2020 2020 2320 626f  (trace).    # bo
+0001a960: 756e 645f 7379 6d62 6f6c 7320 3d20 6974  und_symbols = it
+0001a970: 6572 5f62 6f75 6e64 5f73 796d 626f 6c73  er_bound_symbols
+0001a980: 2874 7261 6365 2e62 6f75 6e64 5f73 796d  (trace.bound_sym
+0001a990: 626f 6c73 290a 2020 2020 2320 7265 636f  bols).    # reco
+0001a9a0: 6e73 7472 7563 7465 645f 656e 7620 3d20  nstructed_env = 
+0001a9b0: 7b0a 2020 2020 2320 2020 2020 7365 7175  {.    #     sequ
+0001a9c0: 656e 6369 6679 2873 796d 626f 6c2e 6f75  encify(symbol.ou
+0001a9d0: 7470 7574 295b 305d 2e6e 616d 653a 2056  tput)[0].name: V
+0001a9e0: 4a50 4475 616c 284e 6f6e 652c 2073 6176  JPDual(None, sav
+0001a9f0: 6564 5f66 6f72 5f62 6163 6b77 6172 645b  ed_for_backward[
+0001aa00: 695d 290a 2020 2020 2320 2020 2020 666f  i]).    #     fo
+0001aa10: 7220 692c 2073 796d 626f 6c20 696e 2065  r i, symbol in e
+0001aa20: 6e75 6d65 7261 7465 2862 6f75 6e64 5f73  numerate(bound_s
+0001aa30: 796d 626f 6c73 290a 2020 2020 2320 7d0a  ymbols).    # }.
+0001aa40: 2020 2020 7265 636f 6e73 7472 7563 7465      reconstructe
+0001aa50: 645f 656e 7620 3d20 7265 636f 6e73 7472  d_env = reconstr
+0001aa60: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
+0001aa70: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
+0001aa80: 6365 2c20 7361 7665 645f 666f 725f 6261  ce, saved_for_ba
+0001aa90: 636b 7761 7264 290a 2020 2020 7265 7375  ckward).    resu
+0001aaa0: 6c74 203d 2062 6163 6b77 6172 645f 7061  lt = backward_pa
+0001aab0: 7373 2872 6563 6f6e 7374 7275 6374 6564  ss(reconstructed
+0001aac0: 5f65 6e76 2c20 7472 6163 652c 2067 7261  _env, trace, gra
+0001aad0: 6473 290a 2020 2020 6966 206c 656e 2861  ds).    if len(a
+0001aae0: 7267 7329 203d 3d20 313a 0a20 2020 2020  rgs) == 1:.     
+0001aaf0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001ab00: 5b30 5d0a 2020 2020 2320 4261 636b 7761  [0].    # Backwa
+0001ab10: 7264 2070 6173 7320 6d69 6768 7420 7265  rd pass might re
+0001ab20: 7475 726e 2061 2064 6963 7420 7769 7468  turn a dict with
+0001ab30: 2067 7261 6473 2062 7574 2063 7572 7265   grads but curre
+0001ab40: 6e74 2069 6e74 6572 6661 6365 206f 660a  nt interface of.
+0001ab50: 2020 2020 2320 6261 636b 7761 7264 2072      # backward r
+0001ab60: 756c 6520 646f 6573 206e 6f74 2073 7570  ule does not sup
+0001ab70: 706f 7274 2069 742e 2053 6f20 7765 206a  port it. So we j
+0001ab80: 7573 7420 6472 6f70 2069 7420 666f 7220  ust drop it for 
+0001ab90: 6e6f 772e 0a20 2020 2065 6c69 6620 6973  now..    elif is
+0001aba0: 696e 7374 616e 6365 2872 6573 756c 745b  instance(result[
+0001abb0: 2d31 5d2c 2064 6963 7429 3a0a 2020 2020  -1], dict):.    
+0001abc0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001abd0: 745b 3a2d 315d 0a20 2020 2072 6574 7572  t[:-1].    retur
+0001abe0: 6e20 7265 7375 6c74 0a0a 0a40 7265 6769  n result...@regi
+0001abf0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+0001ac00: 6f72 7761 7264 2822 746f 7263 682e 5465  orward("torch.Te
+0001ac10: 6e73 6f72 2e63 6f6e 7469 6775 6f75 7322  nsor.contiguous"
+0001ac20: 290a 4072 6567 6973 7465 725f 6175 676d  ).@register_augm
+0001ac30: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+0001ac40: 6f72 6368 2e63 6f6e 7469 6775 6f75 7322  orch.contiguous"
+0001ac50: 290a 6465 6620 636f 6e74 6967 756f 7573  ).def contiguous
+0001ac60: 5f61 7567 5f66 7764 2878 3a20 5465 6e73  _aug_fwd(x: Tens
+0001ac70: 6f72 5072 6f78 792c 202f 2c20 2a2c 206d  orProxy, /, *, m
+0001ac80: 656d 6f72 795f 666f 726d 6174 3a20 746f  emory_format: to
+0001ac90: 7263 682e 6d65 6d6f 7279 5f66 6f72 6d61  rch.memory_forma
+0001aca0: 7420 3d20 746f 7263 682e 636f 6e74 6967  t = torch.contig
+0001acb0: 756f 7573 5f66 6f72 6d61 7429 202d 3e20  uous_format) -> 
+0001acc0: 564a 5044 7561 6c3a 0a20 2020 2066 726f  VJPDual:.    fro
+0001acd0: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+0001ace0: 696d 706f 7274 2063 6f6e 7469 6775 6f75  import contiguou
+0001acf0: 730a 0a20 2020 2072 6574 7572 6e20 564a  s..    return VJ
+0001ad00: 5044 7561 6c28 636f 6e74 6967 756f 7573  PDual(contiguous
+0001ad10: 2878 2c20 6d65 6d6f 7279 5f66 6f72 6d61  (x, memory_forma
+0001ad20: 743d 6d65 6d6f 7279 5f66 6f72 6d61 7429  t=memory_format)
+0001ad30: 2c20 7475 706c 6528 2929 0a0a 0a40 7265  , tuple())...@re
+0001ad40: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+0001ad50: 2274 6f72 6368 2e54 656e 736f 722e 636f  "torch.Tensor.co
+0001ad60: 6e74 6967 756f 7573 2229 0a40 7265 6769  ntiguous").@regi
+0001ad70: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
+0001ad80: 6f72 6368 2e63 6f6e 7469 6775 6f75 7322  orch.contiguous"
+0001ad90: 290a 6465 6620 636f 6e74 6967 756f 7573  ).def contiguous
+0001ada0: 5f62 6163 6b77 6172 6428 2a72 6573 6964  _backward(*resid
+0001adb0: 7561 6c73 5f61 6e64 5f67 7261 6429 202d  uals_and_grad) -
+0001adc0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+0001add0: 2020 2023 2052 6573 6964 7561 6c73 2069     # Residuals i
+0001ade0: 7320 6e6f 7420 656d 7074 7920 6265 6361  s not empty beca
+0001adf0: 7573 6520 636f 6e74 6967 756f 7573 2073  use contiguous s
+0001ae00: 796d 626f 6c20 6861 7320 7468 6520 7361  ymbol has the sa
+0001ae10: 6d65 206f 7574 7075 7420 6173 2069 7473  me output as its
+0001ae20: 2069 6e70 7574 0a20 2020 2067 203d 2072   input.    g = r
+0001ae30: 6573 6964 7561 6c73 5f61 6e64 5f67 7261  esiduals_and_gra
+0001ae40: 645b 2d31 5d0a 2020 2020 7265 7475 726e  d[-1].    return
+0001ae50: 2067 0a0a 0a64 6566 2072 6563 6970 726f   g...def recipro
+0001ae60: 6361 6c5f 6175 675f 6677 6428 613a 2054  cal_aug_fwd(a: T
+0001ae70: 656e 736f 7250 726f 7879 2920 2d3e 2056  ensorProxy) -> V
+0001ae80: 4a50 4475 616c 3a0a 2020 2020 7072 696d  JPDual:.    prim
+0001ae90: 616c 203d 2072 6563 6970 726f 6361 6c28  al = reciprocal(
+0001aea0: 6129 0a20 2020 2072 6574 7572 6e20 564a  a).    return VJ
+0001aeb0: 5044 7561 6c28 7072 696d 616c 2c20 2870  PDual(primal, (p
+0001aec0: 7269 6d61 6c2c 2929 0a0a 0a64 6566 2072  rimal,))...def r
+0001aed0: 6563 6970 726f 6361 6c5f 6261 636b 7761  eciprocal_backwa
+0001aee0: 7264 2870 7269 6d61 6c2c 2067 293a 0a20  rd(primal, g):. 
+0001aef0: 2020 2072 6574 7572 6e20 2d67 202a 2070     return -g * p
+0001af00: 7269 6d61 6c20 2a20 7072 696d 616c 0a0a  rimal * primal..
+0001af10: 0a40 7061 7274 6961 6c28 7265 6769 7374  .@partial(regist
+0001af20: 6572 5f67 7261 642c 2070 7269 6d73 2e50  er_grad, prims.P
+0001af30: 7269 6d49 4473 2e52 4543 4950 524f 4341  rimIDs.RECIPROCA
+0001af40: 4c29 0a64 6566 2072 6563 6970 726f 6361  L).def reciproca
+0001af50: 6c5f 6a6f 696e 745f 666f 7277 6172 645f  l_joint_forward_
+0001af60: 6261 636b 7761 7264 5f72 756c 6528 613a  backward_rule(a:
+0001af70: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
+0001af80: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+0001af90: 2020 7265 7375 6c74 2c20 7361 7665 6420    result, saved 
+0001afa0: 3d20 7265 6369 7072 6f63 616c 5f61 7567  = reciprocal_aug
+0001afb0: 5f66 7764 2861 290a 2020 2020 6720 3d20  _fwd(a).    g = 
+0001afc0: 6765 745f 6772 6164 2872 6573 756c 7429  get_grad(result)
+0001afd0: 0a20 2020 2067 6120 3d20 7265 6369 7072  .    ga = recipr
+0001afe0: 6f63 616c 5f62 6163 6b77 6172 6428 2a73  ocal_backward(*s
+0001aff0: 6176 6564 2c20 6729 0a20 2020 2070 7574  aved, g).    put
+0001b000: 5f67 7261 6428 612c 2067 6129 0a20 2020  _grad(a, ga).   
+0001b010: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+0001b020: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+0001b030: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
+0001b040: 7263 682e 696e 6465 785f 7075 7422 290a  rch.index_put").
+0001b050: 6465 6620 696e 6465 785f 7075 745f 6175  def index_put_au
+0001b060: 675f 6677 6428 0a20 2020 2061 3a20 5465  g_fwd(.    a: Te
+0001b070: 6e73 6f72 5072 6f78 792c 202f 2c20 696e  nsorProxy, /, in
+0001b080: 6469 6365 733a 2053 6571 7565 6e63 655b  dices: Sequence[
+0001b090: 5465 6e73 6f72 5072 6f78 795d 2c20 7661  TensorProxy], va
+0001b0a0: 6c75 6573 3a20 5465 6e73 6f72 5072 6f78  lues: TensorProx
+0001b0b0: 792c 2061 6363 756d 756c 6174 653a 2062  y, accumulate: b
+0001b0c0: 6f6f 6c20 3d20 4661 6c73 650a 2920 2d3e  ool = False.) ->
+0001b0d0: 2056 4a50 4475 616c 3a0a 2020 2020 7072   VJPDual:.    pr
+0001b0e0: 696d 616c 203d 2063 6c61 6e67 2e69 6e64  imal = clang.ind
+0001b0f0: 6578 5f70 7574 2861 2c20 696e 6469 6365  ex_put(a, indice
+0001b100: 732c 2076 616c 7565 732c 2061 6363 756d  s, values, accum
+0001b110: 756c 6174 6529 0a20 2020 2072 6573 6964  ulate).    resid
+0001b120: 7561 6c73 203d 2028 0a20 2020 2020 2020  uals = (.       
+0001b130: 2069 6e64 6963 6573 2c0a 2020 2020 2020   indices,.      
+0001b140: 2020 7661 6c75 6573 2c0a 2020 2020 2020    values,.      
+0001b150: 2020 6163 6375 6d75 6c61 7465 2c0a 2020    accumulate,.  
+0001b160: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
+0001b170: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+0001b180: 6573 6964 7561 6c73 290a 0a0a 6465 6620  esiduals)...def 
+0001b190: 7375 6d5f 746f 2861 3a20 5465 6e73 6f72  sum_to(a: Tensor
+0001b1a0: 5072 6f78 792c 2073 6861 7065 3a20 5365  Proxy, shape: Se
+0001b1b0: 7175 656e 6365 5b69 6e74 5d29 202d 3e20  quence[int]) -> 
+0001b1c0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+0001b1d0: 2069 6620 6e6f 7420 7368 6170 653a 0a20   if not shape:. 
+0001b1e0: 2020 2020 2020 2072 6574 7572 6e20 612e         return a.
+0001b1f0: 7375 6d28 290a 2020 2020 6c65 6164 696e  sum().    leadin
+0001b200: 675f 6469 6d73 203d 2061 2e6e 6469 6d20  g_dims = a.ndim 
+0001b210: 2d20 6c65 6e28 7368 6170 6529 0a20 2020  - len(shape).   
+0001b220: 2072 6564 7563 655f 6469 6d73 203d 2074   reduce_dims = t
+0001b230: 7570 6c65 2872 616e 6765 286c 6561 6469  uple(range(leadi
+0001b240: 6e67 5f64 696d 7329 2920 2b20 7475 706c  ng_dims)) + tupl
+0001b250: 6528 0a20 2020 2020 2020 2069 2066 6f72  e(.        i for
+0001b260: 2069 2069 6e20 7261 6e67 6528 6c65 6164   i in range(lead
+0001b270: 696e 675f 6469 6d73 2c20 612e 6e64 696d  ing_dims, a.ndim
+0001b280: 2920 6966 2073 6861 7065 5b69 202d 206c  ) if shape[i - l
+0001b290: 6561 6469 6e67 5f64 696d 735d 203d 3d20  eading_dims] == 
+0001b2a0: 3120 616e 6420 612e 7368 6170 655b 695d  1 and a.shape[i]
+0001b2b0: 2021 3d20 310a 2020 2020 290a 2020 2020   != 1.    ).    
+0001b2c0: 6120 3d20 6c74 6f72 6368 2e73 756d 2861  a = ltorch.sum(a
+0001b2d0: 2c20 6469 6d3d 7265 6475 6365 5f64 696d  , dim=reduce_dim
+0001b2e0: 732c 206b 6565 7064 696d 3d54 7275 6529  s, keepdim=True)
+0001b2f0: 0a20 2020 2069 6620 6c65 6164 696e 675f  .    if leading_
+0001b300: 6469 6d73 203e 2030 3a0a 2020 2020 2020  dims > 0:.      
+0001b310: 2020 7265 7475 726e 206c 746f 7263 682e    return ltorch.
+0001b320: 7669 6577 2861 2c20 7368 6170 6529 0a20  view(a, shape). 
+0001b330: 2020 2072 6574 7572 6e20 610a 0a0a 4072     return a...@r
+0001b340: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+0001b350: 2822 746f 7263 682e 696e 6465 785f 7075  ("torch.index_pu
+0001b360: 7422 290a 6465 6620 696e 6465 785f 7075  t").def index_pu
+0001b370: 745f 6261 636b 7761 7264 2869 6e64 6963  t_backward(indic
+0001b380: 6573 3a20 5365 7175 656e 6365 5b54 656e  es: Sequence[Ten
+0001b390: 736f 7250 726f 7879 5d2c 2076 616c 7565  sorProxy], value
+0001b3a0: 733a 2054 656e 736f 7250 726f 7879 2c20  s: TensorProxy, 
+0001b3b0: 6163 6375 6d75 6c61 7465 3a20 626f 6f6c  accumulate: bool
+0001b3c0: 2c20 673a 2054 656e 736f 7250 726f 7879  , g: TensorProxy
+0001b3d0: 293a 0a20 2020 2067 5f76 616c 7565 7320  ):.    g_values 
+0001b3e0: 3d20 675b 696e 6469 6365 735d 0a20 2020  = g[indices].   
+0001b3f0: 2023 2074 6f72 6368 2068 6173 2065 7874   # torch has ext
+0001b400: 7261 206c 6f67 6963 2074 6f20 6861 6e64  ra logic to hand
+0001b410: 6c65 2074 6865 2065 7870 616e 6465 6420  le the expanded 
+0001b420: 7661 6c75 6573 0a20 2020 2069 6620 6e6f  values.    if no
+0001b430: 7420 7574 696c 732e 7361 6d65 5f73 6861  t utils.same_sha
+0001b440: 7065 2867 5f76 616c 7565 732e 7368 6170  pe(g_values.shap
+0001b450: 652c 2076 616c 7565 732e 7368 6170 6529  e, values.shape)
+0001b460: 3a0a 2020 2020 2020 2020 6966 2063 6c61  :.        if cla
+0001b470: 6e67 2e63 6f6d 7075 7465 5f62 726f 6164  ng.compute_broad
+0001b480: 6361 7374 5f73 6861 7065 2867 5f76 616c  cast_shape(g_val
+0001b490: 7565 732e 7368 6170 652c 2076 616c 7565  ues.shape, value
+0001b4a0: 732e 7368 6170 6529 3a0a 2020 2020 2020  s.shape):.      
+0001b4b0: 2020 2020 2020 675f 7661 6c75 6573 203d        g_values =
+0001b4c0: 2073 756d 5f74 6f28 675f 7661 6c75 6573   sum_to(g_values
+0001b4d0: 2c20 7661 6c75 6573 2e73 6861 7065 290a  , values.shape).
+0001b4e0: 2020 2020 6966 2061 6363 756d 756c 6174      if accumulat
+0001b4f0: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+0001b500: 6e20 672c 2067 5f76 616c 7565 730a 2020  n g, g_values.  
+0001b510: 2020 7265 7475 726e 2063 6c61 6e67 2e69    return clang.i
+0001b520: 6e64 6578 5f70 7574 2867 2c20 696e 6469  ndex_put(g, indi
+0001b530: 6365 732c 206c 746f 7263 682e 7a65 726f  ces, ltorch.zero
+0001b540: 735f 6c69 6b65 2876 616c 7565 7329 2c20  s_like(values), 
+0001b550: 4661 6c73 6529 2c20 675f 7661 6c75 6573  False), g_values
+0001b560: 0a0a 0a64 6566 2075 6e69 666f 726d 5f61  ...def uniform_a
+0001b570: 7567 5f66 7764 2873 6861 7065 2c20 6d69  ug_fwd(shape, mi
+0001b580: 6e76 616c 2c20 6d61 7876 616c 2c20 2a2c  nval, maxval, *,
+0001b590: 2064 6576 6963 652c 2064 7479 7065 293a   device, dtype):
+0001b5a0: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
+0001b5b0: 696d 732e 756e 6966 6f72 6d28 7368 6170  ims.uniform(shap
+0001b5c0: 652c 206d 696e 7661 6c2c 206d 6178 7661  e, minval, maxva
+0001b5d0: 6c2c 2064 6576 6963 653d 6465 7669 6365  l, device=device
+0001b5e0: 2c20 6474 7970 653d 6474 7970 6529 0a20  , dtype=dtype). 
+0001b5f0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+0001b600: 6c28 7072 696d 616c 2c20 2870 7269 6d61  l(primal, (prima
+0001b610: 6c2c 206d 696e 7661 6c2c 206d 6178 7661  l, minval, maxva
+0001b620: 6c29 290a 0a0a 6465 6620 756e 6966 6f72  l))...def unifor
+0001b630: 6d5f 6261 636b 7761 7264 2870 7269 6d61  m_backward(prima
+0001b640: 6c2c 206d 696e 7661 6c2c 206d 6178 7661  l, minval, maxva
+0001b650: 6c2c 2067 293a 0a20 2020 2023 2075 6e69  l, g):.    # uni
+0001b660: 666f 726d 2069 7320 696d 706c 656d 656e  form is implemen
+0001b670: 7465 6420 6173 2028 6d61 7876 616c 202d  ted as (maxval -
+0001b680: 206d 696e 7661 6c29 202a 2075 6e69 666f   minval) * unifo
+0001b690: 726d 2873 6861 7065 2c20 302c 2031 2920  rm(shape, 0, 1) 
+0001b6a0: 2b20 6d69 6e76 616c 0a20 2020 2075 6e73  + minval.    uns
+0001b6b0: 6361 6c65 645f 7072 696d 616c 203d 2028  caled_primal = (
+0001b6c0: 7072 696d 616c 202d 206d 696e 7661 6c29  primal - minval)
+0001b6d0: 202f 2028 6d61 7876 616c 202d 206d 696e   / (maxval - min
+0001b6e0: 7661 6c29 0a20 2020 2072 6564 7563 655f  val).    reduce_
+0001b6f0: 616c 6c5f 6469 6d73 203d 2074 7570 6c65  all_dims = tuple
+0001b700: 2872 616e 6765 2867 2e6e 6469 6d29 290a  (range(g.ndim)).
+0001b710: 2020 2020 7375 6d20 3d20 7061 7274 6961      sum = partia
+0001b720: 6c28 7072 696d 732e 7375 6d2c 2064 696d  l(prims.sum, dim
+0001b730: 733d 7265 6475 6365 5f61 6c6c 5f64 696d  s=reduce_all_dim
+0001b740: 7329 0a20 2020 2072 6574 7572 6e20 4e6f  s).    return No
+0001b750: 6e65 2c20 7375 6d28 6720 2a20 2831 202d  ne, sum(g * (1 -
+0001b760: 2075 6e73 6361 6c65 645f 7072 696d 616c   unscaled_primal
+0001b770: 2929 2c20 7375 6d28 6720 2a20 756e 7363  )), sum(g * unsc
+0001b780: 616c 6564 5f70 7269 6d61 6c29 0a0a 0a6e  aled_primal)...n
+0001b790: 6f6e 6469 6666 6572 656e 7469 6162 6c65  ondifferentiable
+0001b7a0: 5f76 6a70 5f73 796d 626f 6c73 203d 2028  _vjp_symbols = (
+0001b7b0: 7072 696d 732e 5072 696d 4944 732e 4249  prims.PrimIDs.BI
+0001b7c0: 5457 4953 455f 414e 442c 2070 7269 6d73  TWISE_AND, prims
+0001b7d0: 2e50 7269 6d49 4473 2e53 4947 4e42 4954  .PrimIDs.SIGNBIT
+0001b7e0: 2c20 7072 696d 732e 5072 696d 4944 732e  , prims.PrimIDs.
+0001b7f0: 4655 4c4c 290a 0a0a 6465 6620 6973 5f63  FULL)...def is_c
+0001b800: 6f6e 7374 616e 745f 666f 725f 766a 7028  onstant_for_vjp(
+0001b810: 7379 6d62 6f6c 3a20 7072 696d 732e 5379  symbol: prims.Sy
+0001b820: 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a 0a20  mbol) -> bool:. 
+0001b830: 2020 2022 2222 4368 6563 6b20 6966 2061     """Check if a
+0001b840: 2073 796d 626f 6c20 6973 2063 6f6e 7374   symbol is const
+0001b850: 616e 7420 666f 7220 7468 6520 564a 5020  ant for the VJP 
+0001b860: 7472 616e 7366 6f72 6d2e 0a0a 2020 2020  transform...    
+0001b870: 4172 6773 3a0a 2020 2020 2020 2020 7379  Args:.        sy
+0001b880: 6d62 6f6c 2028 7072 696d 732e 5379 6d62  mbol (prims.Symb
+0001b890: 6f6c 293a 2053 796d 626f 6c20 746f 2063  ol): Symbol to c
+0001b8a0: 6865 636b 2e0a 0a20 2020 2052 6574 7572  heck...    Retur
+0001b8b0: 6e73 3a0a 2020 2020 2020 2020 626f 6f6c  ns:.        bool
+0001b8c0: 3a20 5472 7565 2069 6620 7468 6520 7379  : True if the sy
+0001b8d0: 6d62 6f6c 2069 7320 636f 6e73 7461 6e74  mbol is constant
+0001b8e0: 2c20 4661 6c73 6520 6f74 6865 7277 6973  , False otherwis
+0001b8f0: 652e 0a20 2020 2022 2222 0a20 2020 2061  e..    """.    a
+0001b900: 7265 5f61 6c6c 5f61 7267 735f 6e6f 6e5f  re_all_args_non_
+0001b910: 6469 6666 6572 656e 7469 6162 6c65 203d  differentiable =
+0001b920: 206e 6f74 2061 6e79 2869 7369 6e73 7461   not any(isinsta
+0001b930: 6e63 6528 6172 672c 2028 466c 6f61 7450  nce(arg, (FloatP
+0001b940: 726f 7879 2c20 5465 6e73 6f72 5072 6f78  roxy, TensorProx
+0001b950: 7929 2920 666f 7220 6172 6720 696e 2073  y)) for arg in s
+0001b960: 796d 626f 6c2e 666c 6174 5f61 7267 7329  ymbol.flat_args)
+0001b970: 0a20 2020 2072 6574 7572 6e20 280a 2020  .    return (.  
+0001b980: 2020 2020 2020 6172 655f 616c 6c5f 6172        are_all_ar
+0001b990: 6773 5f6e 6f6e 5f64 6966 6665 7265 6e74  gs_non_different
+0001b9a0: 6961 626c 650a 2020 2020 2020 2020 6f72  iable.        or
+0001b9b0: 2073 796d 626f 6c2e 6172 655f 616c 6c5f   symbol.are_all_
+0001b9c0: 6172 6773 5f63 6f6e 7374 616e 740a 2020  args_constant.  
+0001b9d0: 2020 2020 2020 6f72 2073 796d 626f 6c2e        or symbol.
+0001b9e0: 7379 6d2e 6964 2069 6e20 6e6f 6e64 6966  sym.id in nondif
+0001b9f0: 6665 7265 6e74 6961 626c 655f 766a 705f  ferentiable_vjp_
+0001ba00: 7379 6d62 6f6c 730a 2020 2020 290a 0a0a  symbols.    )...
+0001ba10: 6465 6620 766a 705f 7379 6d62 6f6c 5f6d  def vjp_symbol_m
+0001ba20: 6170 7065 7228 7379 6d62 6f6c 3a20 7072  apper(symbol: pr
+0001ba30: 696d 732e 5379 6d62 6f6c 2c20 2a61 7267  ims.Symbol, *arg
+0001ba40: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0001ba50: 2020 2222 2253 796d 626f 6c20 6d61 7070    """Symbol mapp
+0001ba60: 6572 2066 6f72 2074 6865 2056 4a50 2074  er for the VJP t
+0001ba70: 7261 6e73 666f 726d 2e0a 0a20 2020 2041  ransform...    A
+0001ba80: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
+0001ba90: 626f 6c20 2870 7269 6d73 2e53 796d 626f  bol (prims.Symbo
+0001baa0: 6c29 3a20 5379 6d62 6f6c 2074 6f20 6265  l): Symbol to be
+0001bab0: 206d 6170 7065 642e 0a20 2020 2020 2020   mapped..       
+0001bac0: 2061 7267 7320 2854 7570 6c65 5b56 6172   args (Tuple[Var
+0001bad0: 6961 626c 655d 293a 2041 7267 756d 656e  iable]): Argumen
+0001bae0: 7473 2074 6f20 7468 6520 7379 6d62 6f6c  ts to the symbol
+0001baf0: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+0001bb00: 2028 4469 6374 5b73 7472 2c20 5661 7269   (Dict[str, Vari
+0001bb10: 6162 6c65 5d29 3a20 4b65 7977 6f72 6420  able]): Keyword 
+0001bb20: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
+0001bb30: 2073 796d 626f 6c2e 0a0a 2020 2020 5265   symbol...    Re
+0001bb40: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
+0001bb50: 616c 6c61 626c 653a 2041 2066 756e 6374  allable: A funct
+0001bb60: 696f 6e20 7468 6174 2063 6f6d 7075 7465  ion that compute
+0001bb70: 7320 7468 6520 564a 5020 6f66 2074 6865  s the VJP of the
+0001bb80: 2073 796d 626f 6c2e 0a20 2020 2022 2222   symbol..    """
+0001bb90: 0a20 2020 2023 2043 6f6e 7374 616e 7420  .    # Constant 
+0001bba0: 6361 7365 0a20 2020 2069 6620 6973 5f63  case.    if is_c
+0001bbb0: 6f6e 7374 616e 745f 666f 725f 766a 7028  onstant_for_vjp(
+0001bbc0: 7379 6d62 6f6c 293a 0a0a 2020 2020 2020  symbol):..      
+0001bbd0: 2020 6465 6620 766a 705f 696d 706c 5f63    def vjp_impl_c
+0001bbe0: 6f6e 7374 2873 796d 626f 6c2c 202a 6172  onst(symbol, *ar
+0001bbf0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0001bc00: 2020 2020 2020 2020 2020 2061 7267 732c             args,
+0001bc10: 206b 7761 7267 7320 3d20 7472 6565 5f6d   kwargs = tree_m
+0001bc20: 6170 286c 616d 6264 6120 783a 2078 2e70  ap(lambda x: x.p
+0001bc30: 7269 6d61 6c20 6966 2069 7369 6e73 7461  rimal if isinsta
+0001bc40: 6e63 6528 782c 2056 4a50 4475 616c 2920  nce(x, VJPDual) 
+0001bc50: 656c 7365 2078 2c20 2861 7267 732c 206b  else x, (args, k
+0001bc60: 7761 7267 7329 290a 2020 2020 2020 2020  wargs)).        
+0001bc70: 2020 2020 7072 696d 616c 7320 3d20 7379      primals = sy
+0001bc80: 6d62 6f6c 5f74 6f5f 6576 616c 2873 796d  mbol_to_eval(sym
+0001bc90: 626f 6c29 282a 6172 6773 2c20 2a2a 6b77  bol)(*args, **kw
+0001bca0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+0001bcb0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001bcc0: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
+0001bcd0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001bce0: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+0001bcf0: 6d61 7028 6c61 6d62 6461 2078 3a20 564a  map(lambda x: VJ
+0001bd00: 5044 7561 6c28 782c 2074 7570 6c65 2829  PDual(x, tuple()
+0001bd10: 292c 2070 7269 6d61 6c73 290a 2020 2020  ), primals).    
+0001bd20: 2020 2020 2020 2020 7265 7475 726e 2056          return V
+0001bd30: 4a50 4475 616c 2870 7269 6d61 6c73 2c20  JPDual(primals, 
+0001bd40: 7475 706c 6528 2929 0a0a 2020 2020 2020  tuple())..      
+0001bd50: 2020 7265 7475 726e 2070 6172 7469 616c    return partial
+0001bd60: 2876 6a70 5f69 6d70 6c5f 636f 6e73 742c  (vjp_impl_const,
+0001bd70: 2073 796d 626f 6c29 0a0a 2020 2020 2320   symbol)..    # 
+0001bd80: 4e6f 726d 616c 2063 6173 652c 2077 6520  Normal case, we 
+0001bd90: 6861 7665 2061 2070 726f 7879 2074 616e  have a proxy tan
+0001bda0: 6765 6e74 0a20 2020 2076 6a70 5f69 6d70  gent.    vjp_imp
+0001bdb0: 6c20 3d20 6175 676d 656e 7465 645f 666f  l = augmented_fo
+0001bdc0: 7277 6172 645f 696d 706c 732e 6765 7428  rward_impls.get(
+0001bdd0: 7379 6d62 6f6c 2e73 796d 2e69 6429 0a0a  symbol.sym.id)..
+0001bde0: 2020 2020 6966 205f 6765 745f 6772 6164      if _get_grad
+0001bdf0: 666e 5f61 6e64 5f65 7865 6375 746f 7228  fn_and_executor(
+0001be00: 7379 6d62 6f6c 295b 305d 2069 7320 6e6f  symbol)[0] is no
+0001be10: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001be20: 766a 705f 696d 706c 2c20 6261 636b 7761  vjp_impl, backwa
+0001be30: 7264 5f66 6e20 3d20 6d61 6b65 5f61 7567  rd_fn = make_aug
+0001be40: 5f66 6f72 7761 7264 5f61 6e64 5f62 6163  _forward_and_bac
+0001be50: 6b77 6172 6428 7379 6d62 6f6c 290a 0a20  kward(symbol).. 
+0001be60: 2020 2069 6620 766a 705f 696d 706c 2069     if vjp_impl i
+0001be70: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001be80: 2320 5765 2063 6f75 6c64 206e 6f74 2066  # We could not f
+0001be90: 696e 6420 6120 564a 5020 666f 7220 7468  ind a VJP for th
+0001bea0: 6973 2073 796d 626f 6c2c 2073 6f20 7765  is symbol, so we
+0001beb0: 2074 7279 2074 6f20 6465 636f 6d70 6f73   try to decompos
+0001bec0: 6520 6974 0a20 2020 2020 2020 2069 6620  e it.        if 
+0001bed0: 6c65 6e28 7379 6d62 6f6c 2e73 7562 7379  len(symbol.subsy
+0001bee0: 6d62 6f6c 7329 203e 2030 2061 6e64 206e  mbols) > 0 and n
+0001bef0: 6f74 2069 7369 6e73 7461 6e63 6528 7379  ot isinstance(sy
+0001bf00: 6d62 6f6c 2e73 796d 2e69 642c 2070 7269  mbol.sym.id, pri
+0001bf10: 6d73 2e50 7269 6d49 4473 293a 0a20 2020  ms.PrimIDs):.   
+0001bf20: 2020 2020 2020 2020 2076 6a70 5f69 6d70           vjp_imp
+0001bf30: 6c20 3d20 7061 7274 6961 6c28 6465 636f  l = partial(deco
+0001bf40: 6d70 6f73 6564 5f66 6e5f 6175 675f 6677  mposed_fn_aug_fw
+0001bf50: 645f 7275 6c65 2c20 6465 636f 6d70 6f73  d_rule, decompos
+0001bf60: 6564 5f66 6e3d 7379 6d62 6f6c 2e73 796d  ed_fn=symbol.sym
+0001bf70: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001bf80: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0001bf90: 2063 6f75 6c64 206e 6f74 2066 696e 6420   could not find 
+0001bfa0: 6120 564a 5020 666f 7220 7468 6973 2073  a VJP for this s
+0001bfb0: 796d 626f 6c20 616e 6420 7765 2063 6f75  ymbol and we cou
+0001bfc0: 6c64 206e 6f74 2064 6563 6f6d 706f 7365  ld not decompose
+0001bfd0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+0001bfe0: 2320 4974 2063 6f75 6c64 2062 6520 6120  # It could be a 
+0001bff0: 746f 7263 682e 6472 6f70 6f75 7420 7769  torch.dropout wi
+0001c000: 7468 2030 2e30 2070 726f 6261 6269 6c69  th 0.0 probabili
+0001c010: 7479 2c20 736f 2077 6520 736b 6970 2069  ty, so we skip i
+0001c020: 740a 2020 2020 2020 2020 2020 2020 6966  t.            if
+0001c030: 2073 796d 626f 6c2e 7379 6d2e 6964 203d   symbol.sym.id =
+0001c040: 3d20 2274 6f72 6368 2e6e 6e2e 6675 6e63  = "torch.nn.func
+0001c050: 7469 6f6e 616c 2e64 726f 706f 7574 223a  tional.dropout":
+0001c060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c070: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
+0001c080: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+0001c090: 2256 4a50 2066 6f72 207b 7379 6d62 6f6c  "VJP for {symbol
+0001c0a0: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
+0001c0b0: 6e74 6564 2229 0a20 2020 2020 2020 2020  nted").         
+0001c0c0: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+0001c0d0: 656d 656e 7465 6445 7272 6f72 2866 2256  ementedError(f"V
+0001c0e0: 4a50 2066 6f72 207b 7379 6d62 6f6c 2e73  JP for {symbol.s
+0001c0f0: 796d 2e69 647d 2069 7320 6e6f 7420 696d  ym.id} is not im
+0001c100: 706c 656d 656e 7465 6422 290a 0a20 2020  plemented")..   
+0001c110: 2064 6566 205f 766a 705f 696d 706c 282a   def _vjp_impl(*
+0001c120: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+0001c130: 0a20 2020 2020 2020 2070 7269 6d61 6c73  .        primals
+0001c140: 2c20 6b77 6172 6773 203d 2074 7265 655f  , kwargs = tree_
+0001c150: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+0001c160: 7072 696d 616c 2069 6620 6973 696e 7374  primal if isinst
+0001c170: 616e 6365 2878 2c20 564a 5044 7561 6c29  ance(x, VJPDual)
+0001c180: 2065 6c73 6520 782c 2028 6172 6773 2c20   else x, (args, 
+0001c190: 6b77 6172 6773 2929 0a20 2020 2020 2020  kwargs)).       
+0001c1a0: 206f 7574 5f70 7269 6d61 6c2c 206f 7574   out_primal, out
+0001c1b0: 5f72 6573 6964 7561 6c73 203d 2076 6a70  _residuals = vjp
+0001c1c0: 5f69 6d70 6c28 2a70 7269 6d61 6c73 2c20  _impl(*primals, 
+0001c1d0: 2a2a 6b77 6172 6773 290a 0a20 2020 2020  **kwargs)..     
+0001c1e0: 2020 2023 2057 6520 6172 6520 7361 7669     # We are savi
+0001c1f0: 6e67 2074 6865 2072 6573 6964 7561 6c73  ng the residuals
+0001c200: 2061 6e64 2070 756c 6c62 6163 6b20 6f6e   and pullback on
+0001c210: 6c79 2069 6e20 7468 6520 6669 7273 7420  ly in the first 
+0001c220: 6f75 7470 7574 0a20 2020 2020 2020 2023  output.        #
+0001c230: 2062 6163 6b77 6172 645f 7061 7373 2074   backward_pass t
+0001c240: 6865 6e20 7265 7472 6965 7665 7320 7468  hen retrieves th
+0001c250: 6520 7265 7369 6475 616c 7320 616e 6420  e residuals and 
+0001c260: 7075 6c6c 6261 636b 2066 726f 6d20 7468  pullback from th
+0001c270: 6520 6669 7273 7420 6f75 7470 7574 0a20  e first output. 
+0001c280: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0001c290: 616e 6365 286f 7574 5f70 7269 6d61 6c2c  ance(out_primal,
+0001c2a0: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+0001c2b0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+0001c2c0: 564a 5044 7561 6c28 6f75 745f 7072 696d  VJPDual(out_prim
+0001c2d0: 616c 5b30 5d2c 206f 7574 5f72 6573 6964  al[0], out_resid
+0001c2e0: 7561 6c73 292c 202a 2856 4a50 4475 616c  uals), *(VJPDual
+0001c2f0: 286f 2c20 7475 706c 6528 2929 2066 6f72  (o, tuple()) for
+0001c300: 206f 2069 6e20 6f75 745f 7072 696d 616c   o in out_primal
+0001c310: 5b31 3a5d 2929 0a0a 2020 2020 2020 2020  [1:]))..        
+0001c320: 7265 7475 726e 2028 564a 5044 7561 6c28  return (VJPDual(
+0001c330: 6f75 745f 7072 696d 616c 2c20 6f75 745f  out_primal, out_
+0001c340: 7265 7369 6475 616c 7329 2c29 0a0a 2020  residuals),)..  
+0001c350: 2020 7265 7475 726e 205f 766a 705f 696d    return _vjp_im
+0001c360: 706c 0a0a 0a64 6566 2063 6865 636b 5f62  pl...def check_b
+0001c370: 7379 6d5f 666f 725f 766a 7028 6273 796d  sym_for_vjp(bsym
+0001c380: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+0001c390: 6865 636b 2069 6620 6120 626f 756e 6420  heck if a bound 
+0001c3a0: 7379 6d62 6f6c 2069 7320 7375 7070 6f72  symbol is suppor
+0001c3b0: 7465 6420 6279 2076 6a70 2e0a 0a20 2020  ted by vjp...   
+0001c3c0: 2041 7267 733a 0a20 2020 2020 2020 2062   Args:.        b
+0001c3d0: 7379 6d20 2842 6f75 6e64 5379 6d62 6f6c  sym (BoundSymbol
+0001c3e0: 293a 2054 6865 2062 6f75 6e64 2073 796d  ): The bound sym
+0001c3f0: 626f 6c20 746f 2063 6865 636b 2e0a 0a20  bol to check... 
+0001c400: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0001c410: 2020 2020 626f 6f6c 3a20 5472 7565 2069      bool: True i
+0001c420: 6620 7468 6520 626f 756e 6420 7379 6d62  f the bound symb
+0001c430: 6f6c 2069 7320 7375 7070 6f72 7465 6420  ol is supported 
+0001c440: 6279 2076 6a70 2c20 4661 6c73 6520 6f74  by vjp, False ot
+0001c450: 6865 7277 6973 652e 0a20 2020 2022 2222  herwise..    """
+0001c460: 0a0a 2020 2020 6966 2062 7379 6d2e 7379  ..    if bsym.sy
+0001c470: 6d2e 6964 2069 6e20 7472 616e 7366 6f72  m.id in transfor
+0001c480: 6d5f 736b 6970 5f6c 6973 743a 0a20 2020  m_skip_list:.   
+0001c490: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+0001c4a0: 0a0a 2020 2020 6966 2062 7379 6d2e 7379  ..    if bsym.sy
+0001c4b0: 6d2e 6964 2069 6e20 6261 636b 7761 7264  m.id in backward
+0001c4c0: 5f69 6d70 6c73 2061 6e64 2062 7379 6d2e  _impls and bsym.
+0001c4d0: 7379 6d2e 6964 2069 6e20 6175 676d 656e  sym.id in augmen
+0001c4e0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
+0001c4f0: 733a 0a20 2020 2020 2020 2072 6574 7572  s:.        retur
+0001c500: 6e20 5472 7565 0a0a 2020 2020 6966 2062  n True..    if b
+0001c510: 7379 6d2e 7379 6d2e 6964 2069 6e20 5f67  sym.sym.id in _g
+0001c520: 7261 645f 666e 5f6d 6170 3a0a 2020 2020  rad_fn_map:.    
+0001c530: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+0001c540: 0a20 2020 2023 2057 6520 636f 756c 6420  .    # We could 
+0001c550: 6e6f 7420 6669 6e64 2061 2056 4a50 2066  not find a VJP f
+0001c560: 6f72 2074 6869 7320 7379 6d62 6f6c 2c20  or this symbol, 
+0001c570: 736f 2077 6520 7472 7920 746f 2064 6563  so we try to dec
+0001c580: 6f6d 706f 7365 2069 740a 2020 2020 2320  ompose it.    # 
+0001c590: 696e 746f 2073 7562 2d73 796d 626f 6c73  into sub-symbols
+0001c5a0: 2061 6e64 2063 6865 636b 2069 6620 7468   and check if th
+0001c5b0: 6579 2061 7265 2073 7570 706f 7274 6564  ey are supported
+0001c5c0: 0a20 2020 2069 6620 6c65 6e28 6273 796d  .    if len(bsym
+0001c5d0: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
+0001c5e0: 2061 6e64 206e 6f74 2062 7379 6d2e 7379   and not bsym.sy
+0001c5f0: 6d2e 6973 5f70 7269 6d3a 0a20 2020 2020  m.is_prim:.     
+0001c600: 2020 2073 7562 7472 6163 6520 3d20 636f     subtrace = co
+0001c610: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+0001c620: 6273 796d 2e73 796d 2c20 2a62 7379 6d2e  bsym.sym, *bsym.
+0001c630: 6172 6773 2c20 2a2a 6273 796d 2e6b 7761  args, **bsym.kwa
+0001c640: 7267 7329 0a20 2020 2020 2020 2073 7562  rgs).        sub
+0001c650: 7472 6163 6520 3d20 756e 7772 6170 5f6f  trace = unwrap_o
+0001c660: 6e65 5f6c 6576 656c 5f6f 665f 7375 6273  ne_level_of_subs
+0001c670: 796d 626f 6c73 2873 7562 7472 6163 6529  ymbols(subtrace)
+0001c680: 0a20 2020 2020 2020 2061 6c6c 5f73 7570  .        all_sup
+0001c690: 706f 7274 6564 203d 2061 6c6c 2863 6865  ported = all(che
+0001c6a0: 636b 5f62 7379 6d5f 666f 725f 766a 7028  ck_bsym_for_vjp(
+0001c6b0: 7375 6262 7379 6d29 2066 6f72 2073 7562  subbsym) for sub
+0001c6c0: 6273 796d 2069 6e20 7375 6274 7261 6365  bsym in subtrace
+0001c6d0: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
+0001c6e0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0001c6f0: 6c6c 5f73 7570 706f 7274 6564 0a0a 2020  ll_supported..  
+0001c700: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+0001c710: 0a64 6566 2061 7567 6d65 6e74 6564 5f66  .def augmented_f
+0001c720: 6f72 7761 7264 5f70 6173 7328 2a61 7267  orward_pass(*arg
+0001c730: 732c 2074 7261 6365 3a20 5472 6163 652c  s, trace: Trace,
+0001c740: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0001c750: 2222 2241 7567 6d65 6e74 6564 2066 6f72  """Augmented for
+0001c760: 7761 7264 2070 6173 7320 666f 7220 7468  ward pass for th
+0001c770: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
+0001c780: 0a0a 2020 2020 5468 6520 6175 676d 656e  ..    The augmen
+0001c790: 7465 6420 666f 7277 6172 6420 7061 7373  ted forward pass
+0001c7a0: 2069 7320 6120 666f 7277 6172 6420 7061   is a forward pa
+0001c7b0: 7373 2074 6861 7420 7265 7475 726e 7320  ss that returns 
+0001c7c0: 7468 6520 7265 7369 6475 616c 730a 2020  the residuals.  
+0001c7d0: 2020 6f66 2074 6865 2066 6f72 7761 7264    of the forward
+0001c7e0: 2070 6173 732e 0a20 2020 2054 6865 7365   pass..    These
+0001c7f0: 2072 6573 6964 7561 6c73 2061 7265 2075   residuals are u
+0001c800: 7365 6420 696e 2074 6865 2062 6163 6b77  sed in the backw
+0001c810: 6172 6420 7061 7373 2074 6f20 636f 6d70  ard pass to comp
+0001c820: 7574 6520 7468 6520 564a 5020 616e 6420  ute the VJP and 
+0001c830: 7468 6579 0a20 2020 2061 7265 2072 6563  they.    are rec
+0001c840: 6f72 6465 6420 696e 2074 6865 2065 6e76  orded in the env
+0001c850: 6972 6f6e 6d65 6e74 2064 6963 7469 6f6e  ironment diction
+0001c860: 6172 7920 666f 7220 6561 6368 2076 6172  ary for each var
+0001c870: 6961 626c 652e 0a0a 2020 2020 4172 6773  iable...    Args
+0001c880: 3a0a 2020 2020 2020 2020 6172 6773 2028  :.        args (
+0001c890: 5475 706c 655b 5661 7269 6162 6c65 5d29  Tuple[Variable])
+0001c8a0: 3a20 4172 6775 6d65 6e74 7320 746f 2074  : Arguments to t
+0001c8b0: 6865 2066 756e 6374 696f 6e2e 0a20 2020  he function..   
+0001c8c0: 2020 2020 2074 7261 6365 2028 5472 6163       trace (Trac
+0001c8d0: 6529 3a20 5472 6163 6520 6f66 2074 6865  e): Trace of the
+0001c8e0: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
+0001c8f0: 2020 206b 7761 7267 7320 2844 6963 745b     kwargs (Dict[
+0001c900: 7374 722c 2056 6172 6961 626c 655d 293a  str, Variable]):
+0001c910: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
+0001c920: 7473 2074 6f20 7468 6520 6675 6e63 7469  ts to the functi
+0001c930: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
+0001c940: 3a0a 2020 2020 2020 2020 5475 706c 655b  :.        Tuple[
+0001c950: 416e 792c 2044 6963 745b 7374 722c 2041  Any, Dict[str, A
+0001c960: 6e79 5d5d 3a20 5475 706c 6520 6f66 2074  ny]]: Tuple of t
+0001c970: 6865 2070 7269 6d61 6c20 6f75 7470 7574  he primal output
+0001c980: 7320 616e 6420 7468 6520 656e 7669 726f  s and the enviro
+0001c990: 6e6d 656e 742e 0a20 2020 2022 2222 0a20  nment..    """. 
+0001c9a0: 2020 2061 7267 732c 206b 7761 7267 7320     args, kwargs 
+0001c9b0: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
+0001c9c0: 6120 783a 2056 4a50 4475 616c 2878 2c20  a x: VJPDual(x, 
+0001c9d0: 7475 706c 6528 2929 2c20 2861 7267 732c  tuple()), (args,
+0001c9e0: 206b 7761 7267 7329 290a 2020 2020 7265   kwargs)).    re
+0001c9f0: 7375 6c74 2c20 656e 7620 3d20 6576 616c  sult, env = eval
+0001ca00: 5f74 7261 6365 280a 2020 2020 2020 2020  _trace(.        
+0001ca10: 7472 6163 652c 0a20 2020 2020 2020 202a  trace,.        *
+0001ca20: 6172 6773 2c0a 2020 2020 2020 2020 2a2a  args,.        **
+0001ca30: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+0001ca40: 7769 7468 5f65 6e76 3d54 7275 652c 0a20  with_env=True,. 
+0001ca50: 2020 2020 2020 2073 796d 626f 6c5f 6d61         symbol_ma
+0001ca60: 7070 6572 3d76 6a70 5f73 796d 626f 6c5f  pper=vjp_symbol_
+0001ca70: 6d61 7070 6572 2c0a 2020 2020 290a 2020  mapper,.    ).  
+0001ca80: 2020 7265 7375 6c74 203d 2074 7265 655f    result = tree_
+0001ca90: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+0001caa0: 7072 696d 616c 2069 6620 6973 696e 7374  primal if isinst
+0001cab0: 616e 6365 2878 2c20 564a 5044 7561 6c29  ance(x, VJPDual)
+0001cac0: 2065 6c73 6520 782c 2072 6573 756c 7429   else x, result)
+0001cad0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+0001cae0: 6c74 2c20 656e 760a 0a0a 2320 544f 444f  lt, env...# TODO
+0001caf0: 3a20 496e 7374 6561 6420 6f66 2075 7369  : Instead of usi
+0001cb00: 6e67 2074 6865 2065 6e76 6972 6f6e 6d65  ng the environme
+0001cb10: 6e74 2064 6963 7469 6f6e 6172 792c 2077  nt dictionary, w
+0001cb20: 6520 636f 756c 6420 7573 6520 7468 6520  e could use the 
+0001cb30: 7472 6163 650a 2320 7379 6d62 6f6c 7320  trace.# symbols 
+0001cb40: 6f72 6465 7220 2874 6861 7420 7368 6f75  order (that shou
+0001cb50: 6c64 2062 6520 6465 7465 726d 696e 6973  ld be determinis
+0001cb60: 7469 6329 2074 6f20 7265 7472 6965 7665  tic) to retrieve
+0001cb70: 2074 6865 2072 6573 6964 7561 6c73 206e   the residuals n
+0001cb80: 6565 6465 640a 2320 666f 7220 7468 6520  eeded.# for the 
+0001cb90: 6261 636b 7761 7264 2070 6173 732e 0a64  backward pass..d
+0001cba0: 6566 2062 6163 6b77 6172 645f 7061 7373  ef backward_pass
+0001cbb0: 2866 6f72 7761 7264 5f65 6e76 2c20 7472  (forward_env, tr
+0001cbc0: 6163 652c 2069 6e69 745f 636f 7461 6e67  ace, init_cotang
+0001cbd0: 656e 7473 293a 0a20 2020 2022 2222 4261  ents):.    """Ba
+0001cbe0: 636b 7761 7264 2070 6173 7320 666f 7220  ckward pass for 
+0001cbf0: 7468 6520 564a 5020 7472 616e 7366 6f72  the VJP transfor
+0001cc00: 6d2e 0a0a 2020 2020 5468 6520 6261 636b  m...    The back
+0001cc10: 7761 7264 2070 6173 7320 6973 2061 2072  ward pass is a r
+0001cc20: 6576 6572 7365 206d 6f64 6520 6175 746f  everse mode auto
+0001cc30: 6d61 7469 6320 6469 6666 6572 656e 7469  matic differenti
+0001cc40: 6174 696f 6e20 7061 7373 2074 6861 740a  ation pass that.
+0001cc50: 2020 2020 636f 6d70 7574 6573 2074 6865      computes the
+0001cc60: 2076 6563 746f 722d 4a61 636f 6269 616e   vector-Jacobian
+0001cc70: 2070 726f 6475 6374 2028 564a 5029 206f   product (VJP) o
+0001cc80: 6620 7468 6520 6675 6e63 7469 6f6e 2e0a  f the function..
+0001cc90: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0001cca0: 2020 2066 6f72 7761 7264 5f65 6e76 2028     forward_env (
+0001ccb0: 4469 6374 5b73 7472 2c20 416e 795d 293a  Dict[str, Any]):
+0001ccc0: 2045 6e76 6972 6f6e 6d65 6e74 206f 6620   Environment of 
+0001ccd0: 7468 6520 666f 7277 6172 6420 7061 7373  the forward pass
+0001cce0: 2e0a 2020 2020 2020 2020 7472 6163 6520  ..        trace 
+0001ccf0: 2854 7261 6365 293a 2054 7261 6365 206f  (Trace): Trace o
+0001cd00: 6620 7468 6520 6675 6e63 7469 6f6e 2e0a  f the function..
+0001cd10: 2020 2020 2020 2020 696e 6974 5f63 6f74          init_cot
+0001cd20: 616e 6765 6e74 7320 2854 7570 6c65 5b56  angents (Tuple[V
+0001cd30: 6172 6961 626c 655d 293a 2049 6e69 7469  ariable]): Initi
+0001cd40: 616c 2063 6f74 616e 6765 6e74 732e 0a0a  al cotangents...
+0001cd50: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001cd60: 2020 2020 2054 7570 6c65 5b50 726f 7879       Tuple[Proxy
+0001cd70: 2c20 2e2e 2e5d 3a20 5475 706c 6520 6f66  , ...]: Tuple of
+0001cd80: 2074 6865 2072 6573 756c 7473 206f 6620   the results of 
+0001cd90: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
+0001cda0: 7320 666f 7220 6561 6368 2069 6e70 7574  s for each input
+0001cdb0: 2e0a 2020 2020 2222 220a 2020 2020 656e  ..    """.    en
+0001cdc0: 7620 3d20 7b7d 0a0a 2020 2020 6465 6620  v = {}..    def 
+0001cdd0: 6765 745f 6772 6164 2878 3a20 5661 7269  get_grad(x: Vari
+0001cde0: 6162 6c65 293a 0a20 2020 2020 2020 2069  able):.        i
+0001cdf0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0001ce00: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
+0001ce10: 2020 2020 2020 2023 2052 6574 7572 6e20         # Return 
+0001ce20: 4e6f 6e65 2069 6620 7468 6520 7661 7269  None if the vari
+0001ce30: 6162 6c65 2077 6173 206e 6f74 2075 7365  able was not use
+0001ce40: 6420 696e 2074 6865 2063 6f6d 7075 7461  d in the computa
+0001ce50: 7469 6f6e 2061 6e64 0a20 2020 2020 2020  tion and.       
+0001ce60: 2020 2020 2023 2068 656e 6365 206e 6f74       # hence not
+0001ce70: 2069 6e20 7468 6520 656e 760a 2020 2020   in the env.    
+0001ce80: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+0001ce90: 6e76 2e67 6574 2878 2e6e 616d 652c 204e  nv.get(x.name, N
+0001cea0: 6f6e 6529 0a20 2020 2020 2020 2065 6c73  one).        els
+0001ceb0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001cec0: 6574 7572 6e20 780a 0a20 2020 2064 6566  eturn x..    def
+0001ced0: 2070 7574 5f67 7261 6428 763a 2056 6172   put_grad(v: Var
+0001cee0: 6961 626c 652c 2076 616c 3a20 416e 7929  iable, val: Any)
+0001cef0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001cf00: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001cf10: 762c 2056 6172 6961 626c 6529 3a0a 2020  v, Variable):.  
+0001cf20: 2020 2020 2020 2020 2020 6966 2076 2e6e            if v.n
+0001cf30: 616d 6520 696e 2065 6e76 3a0a 2020 2020  ame in env:.    
+0001cf40: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0001cf50: 616c 2069 7320 4e6f 6e65 3a0a 2020 2020  al is None:.    
+0001cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf70: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+0001cf80: 2020 2020 2020 2023 2041 6363 756d 756c         # Accumul
+0001cf90: 6174 6520 636f 7461 6e67 656e 7473 0a20  ate cotangents. 
+0001cfa0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001cfb0: 6e76 5b76 2e6e 616d 655d 203d 2063 6c61  nv[v.name] = cla
+0001cfc0: 6e67 2e61 6464 2865 6e76 5b76 2e6e 616d  ng.add(env[v.nam
+0001cfd0: 655d 2c20 7661 6c29 2069 6620 656e 765b  e], val) if env[
+0001cfe0: 762e 6e61 6d65 5d20 6973 206e 6f74 204e  v.name] is not N
+0001cff0: 6f6e 6520 656c 7365 2076 616c 0a20 2020  one else val.   
+0001d000: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001d010: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
+0001d020: 656e 765b 762e 6e61 6d65 5d20 3d20 7661  env[v.name] = va
+0001d030: 6c0a 2020 2020 2020 2020 656c 6966 2069  l.        elif i
+0001d040: 7369 6e73 7461 6e63 6528 762c 2053 6571  sinstance(v, Seq
+0001d050: 7565 6e63 6529 2061 6e64 2061 6c6c 2869  uence) and all(i
+0001d060: 7369 6e73 7461 6e63 6528 782c 2069 6e74  sinstance(x, int
+0001d070: 2920 666f 7220 7820 696e 2076 293a 0a20  ) for x in v):. 
+0001d080: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0001d090: 4f3a 2072 656d 6f76 6520 7768 656e 2077  O: remove when w
+0001d0a0: 6520 6d6f 7665 2064 696d 7320 746f 206b  e move dims to k
+0001d0b0: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+0001d0c0: 2020 7061 7373 0a20 2020 2020 2020 2065    pass.        e
+0001d0d0: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
+0001d0e0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+0001d0f0: 2020 2020 656e 765b 765d 203d 2076 616c      env[v] = val
+0001d100: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+0001d110: 696e 7374 616e 6365 2876 2c20 5365 7175  instance(v, Sequ
+0001d120: 656e 6365 2920 616e 6420 7661 6c20 6973  ence) and val is
+0001d130: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001d140: 2020 2023 2062 726f 6164 6361 7374 204e     # broadcast N
+0001d150: 6f6e 6520 746f 2074 6865 2072 6967 6874  one to the right
+0001d160: 2073 6861 7065 0a20 2020 2020 2020 2020   shape.         
+0001d170: 2020 2073 6166 655f 6d61 7028 7075 745f     safe_map(put_
+0001d180: 6772 6164 2c20 762c 205b 4e6f 6e65 5d20  grad, v, [None] 
+0001d190: 2a20 6c65 6e28 7629 290a 2020 2020 2020  * len(v)).      
+0001d1a0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0001d1b0: 6528 762c 2053 6571 7565 6e63 6529 2061  e(v, Sequence) a
+0001d1c0: 6e64 2069 7369 6e73 7461 6e63 6528 7661  nd isinstance(va
+0001d1d0: 6c2c 2053 6571 7565 6e63 6529 3a0a 2020  l, Sequence):.  
+0001d1e0: 2020 2020 2020 2020 2020 7361 6665 5f6d            safe_m
+0001d1f0: 6170 5f66 6c61 7428 7075 745f 6772 6164  ap_flat(put_grad
+0001d200: 2c20 762c 2076 616c 290a 2020 2020 2020  , v, val).      
+0001d210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001d220: 2020 2020 2320 536b 6970 2077 7269 7469      # Skip writi
+0001d230: 6e67 2074 6f20 636f 6e73 7461 6e74 730a  ng to constants.
+0001d240: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0001d250: 0a0a 2020 2020 6966 2069 7369 6e73 7461  ..    if isinsta
+0001d260: 6e63 6528 696e 6974 5f63 6f74 616e 6765  nce(init_cotange
+0001d270: 6e74 732c 2053 6571 7565 6e63 6529 2061  nts, Sequence) a
+0001d280: 6e64 206c 656e 2869 6e69 745f 636f 7461  nd len(init_cota
+0001d290: 6e67 656e 7473 2920 3d3d 2031 2061 6e64  ngents) == 1 and
+0001d2a0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0001d2b0: 7472 6163 652e 6f75 7470 7574 2c20 5365  trace.output, Se
+0001d2c0: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+0001d2d0: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
+0001d2e0: 203d 2069 6e69 745f 636f 7461 6e67 656e   = init_cotangen
+0001d2f0: 7473 5b30 5d0a 2020 2020 7361 6665 5f6d  ts[0].    safe_m
+0001d300: 6170 5f66 6c61 7428 7075 745f 6772 6164  ap_flat(put_grad
+0001d310: 2c20 7472 6163 652e 6f75 7470 7574 2c20  , trace.output, 
+0001d320: 696e 6974 5f63 6f74 616e 6765 6e74 7329  init_cotangents)
+0001d330: 0a0a 2020 2020 666f 7220 7379 6d62 6f6c  ..    for symbol
+0001d340: 2069 6e20 7265 7665 7273 6564 286c 6973   in reversed(lis
+0001d350: 7428 6974 6572 5f62 6f75 6e64 5f73 796d  t(iter_bound_sym
+0001d360: 626f 6c73 2874 7261 6365 2e62 6f75 6e64  bols(trace.bound
+0001d370: 5f73 796d 626f 6c73 2929 293a 0a20 2020  _symbols))):.   
+0001d380: 2020 2020 2073 796d 626f 6c5f 6f75 7470       symbol_outp
+0001d390: 7574 203d 2073 6571 7565 6e63 6966 7928  ut = sequencify(
+0001d3a0: 7379 6d62 6f6c 2e6f 7574 7075 7429 0a0a  symbol.output)..
+0001d3b0: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
+0001d3c0: 7473 203d 2074 7265 655f 6d61 7028 6765  ts = tree_map(ge
+0001d3d0: 745f 6772 6164 2c20 7379 6d62 6f6c 5f6f  t_grad, symbol_o
+0001d3e0: 7574 7075 7429 0a20 2020 2020 2020 2023  utput).        #
+0001d3f0: 2048 6176 696e 6720 6120 7369 6e67 6c65   Having a single
+0001d400: 2063 6f74 616e 6765 6e74 2069 7320 6120   cotangent is a 
+0001d410: 636f 6d6d 6f6e 2063 6173 652c 2073 6f20  common case, so 
+0001d420: 7765 2066 6c61 7474 656e 2069 740a 2020  we flatten it.  
+0001d430: 2020 2020 2020 2320 4f74 6865 7277 6973        # Otherwis
+0001d440: 652c 2077 6520 7769 6c6c 206e 6565 6420  e, we will need 
+0001d450: 746f 2072 6577 7269 7465 2074 6865 2070  to rewrite the p
+0001d460: 756c 6c62 6163 6b20 6675 6e63 7469 6f6e  ullback function
+0001d470: 730a 2020 2020 2020 2020 636f 7461 6e67  s.        cotang
+0001d480: 656e 7473 203d 2074 7265 655f 666c 6174  ents = tree_flat
+0001d490: 7465 6e28 636f 7461 6e67 656e 7473 295b  ten(cotangents)[
+0001d4a0: 305d 0a20 2020 2020 2020 2072 6573 6964  0].        resid
+0001d4b0: 7561 6c73 203d 2066 6f72 7761 7264 5f65  uals = forward_e
+0001d4c0: 6e76 5b73 796d 626f 6c5f 6f75 7470 7574  nv[symbol_output
+0001d4d0: 5b30 5d2e 6e61 6d65 5d2e 7265 7369 6475  [0].name].residu
+0001d4e0: 616c 730a 2020 2020 2020 2020 6966 2069  als.        if i
+0001d4f0: 735f 636f 6e73 7461 6e74 5f66 6f72 5f76  s_constant_for_v
+0001d500: 6a70 2873 796d 626f 6c29 3a0a 2020 2020  jp(symbol):.    
+0001d510: 2020 2020 2020 2020 2320 5765 2063 616e          # We can
+0001d520: 2073 6b69 7020 7468 6520 7075 6c6c 6261   skip the pullba
+0001d530: 636b 2069 6620 616c 6c20 7468 6520 6172  ck if all the ar
+0001d540: 6775 6d65 6e74 7320 6172 6520 636f 6e73  guments are cons
+0001d550: 7461 6e74 0a20 2020 2020 2020 2020 2020  tant.           
+0001d560: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001d570: 2020 2069 6620 616c 6c28 636f 7461 6e67     if all(cotang
+0001d580: 656e 7420 6973 204e 6f6e 6520 666f 7220  ent is None for 
+0001d590: 636f 7461 6e67 656e 7420 696e 2063 6f74  cotangent in cot
+0001d5a0: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
+0001d5b0: 2020 2020 2020 2320 5765 2063 616e 2073        # We can s
+0001d5c0: 6b69 7020 7468 6520 7075 6c6c 6261 636b  kip the pullback
+0001d5d0: 2069 6620 7468 6520 636f 7461 6e67 656e   if the cotangen
+0001d5e0: 7420 6973 204e 6f6e 650a 2020 2020 2020  t is None.      
+0001d5f0: 2020 2020 2020 7361 6665 5f6d 6170 2870        safe_map(p
+0001d600: 7574 5f67 7261 642c 2073 796d 626f 6c2e  ut_grad, symbol.
+0001d610: 6172 6773 2c20 284e 6f6e 652c 2920 2a20  args, (None,) * 
+0001d620: 6c65 6e28 7379 6d62 6f6c 2e61 7267 7329  len(symbol.args)
+0001d630: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+0001d640: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+0001d650: 6966 2073 796d 626f 6c2e 7379 6d2e 6964  if symbol.sym.id
+0001d660: 203d 3d20 2274 6f72 6368 2e6e 6e2e 6675   == "torch.nn.fu
+0001d670: 6e63 7469 6f6e 616c 2e64 726f 706f 7574  nctional.dropout
+0001d680: 2220 616e 6420 6e6f 7420 7379 6d62 6f6c  " and not symbol
+0001d690: 2e73 7562 7379 6d62 6f6c 733a 0a20 2020  .subsymbols:.   
+0001d6a0: 2020 2020 2020 2020 2023 2057 6520 6361           # We ca
+0001d6b0: 6e20 736b 6970 2074 6865 2070 756c 6c62  n skip the pullb
+0001d6c0: 6163 6b20 6966 2074 6865 2064 726f 706f  ack if the dropo
+0001d6d0: 7574 2070 726f 6261 6269 6c69 7479 2069  ut probability i
+0001d6e0: 7320 302e 300a 2020 2020 2020 2020 2020  s 0.0.          
+0001d6f0: 2020 2320 4173 7375 6d69 6e67 2074 6861    # Assuming tha
+0001d700: 7420 7468 6520 6472 6f70 6f75 7420 7379  t the dropout sy
+0001d710: 6d62 6f6c 2068 6173 2074 6865 2073 616d  mbol has the sam
+0001d720: 6520 6f75 7470 7574 2061 6e64 2061 7267  e output and arg
+0001d730: 756d 656e 740a 2020 2020 2020 2020 2020  ument.          
+0001d740: 2020 6173 7365 7274 2073 796d 626f 6c2e    assert symbol.
+0001d750: 6f75 7470 7574 2e6e 616d 6520 3d3d 2073  output.name == s
+0001d760: 796d 626f 6c2e 6172 6773 5b30 5d2e 6e61  ymbol.args[0].na
+0001d770: 6d65 2c20 2244 726f 706f 7574 2073 796d  me, "Dropout sym
+0001d780: 626f 6c20 6861 7320 6120 6469 6666 6572  bol has a differ
+0001d790: 656e 7420 6f75 7470 7574 2061 6e64 2061  ent output and a
+0001d7a0: 7267 756d 656e 7422 0a20 2020 2020 2020  rgument".       
+0001d7b0: 2020 2020 2069 6620 7379 6d62 6f6c 2e61       if symbol.a
+0001d7c0: 7267 735b 315d 203d 3d20 302e 3020 6f72  rgs[1] == 0.0 or
+0001d7d0: 2073 796d 626f 6c2e 6172 6773 5b32 5d20   symbol.args[2] 
+0001d7e0: 6973 2046 616c 7365 3a0a 2020 2020 2020  is False:.      
+0001d7f0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0001d800: 7565 0a0a 2020 2020 2020 2020 6261 636b  ue..        back
+0001d810: 7761 7264 203d 2062 6163 6b77 6172 645f  ward = backward_
+0001d820: 696d 706c 732e 6765 7428 7379 6d62 6f6c  impls.get(symbol
+0001d830: 2e73 796d 2e69 6429 0a20 2020 2020 2020  .sym.id).       
+0001d840: 2061 7567 5f66 6f72 7761 7264 203d 2061   aug_forward = a
+0001d850: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001d860: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
+0001d870: 6c2e 7379 6d2e 6964 290a 0a20 2020 2020  l.sym.id)..     
+0001d880: 2020 2069 6620 5f67 6574 5f67 7261 6466     if _get_gradf
+0001d890: 6e5f 616e 645f 6578 6563 7574 6f72 2873  n_and_executor(s
+0001d8a0: 796d 626f 6c29 5b30 5d20 6973 206e 6f74  ymbol)[0] is not
+0001d8b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001d8c0: 2020 2061 7567 5f66 6f72 7761 7264 2c20     aug_forward, 
+0001d8d0: 6261 636b 7761 7264 203d 206d 616b 655f  backward = make_
+0001d8e0: 6175 675f 666f 7277 6172 645f 616e 645f  aug_forward_and_
+0001d8f0: 6261 636b 7761 7264 2873 796d 626f 6c29  backward(symbol)
+0001d900: 0a0a 2020 2020 2020 2020 6966 2062 6163  ..        if bac
+0001d910: 6b77 6172 6420 6973 204e 6f6e 653a 0a20  kward is None:. 
+0001d920: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+0001d930: 6e28 7379 6d62 6f6c 2e73 7562 7379 6d62  n(symbol.subsymb
+0001d940: 6f6c 7329 203e 2030 2061 6e64 206e 6f74  ols) > 0 and not
+0001d950: 2069 7369 6e73 7461 6e63 6528 7379 6d62   isinstance(symb
+0001d960: 6f6c 2e73 796d 2e69 642c 2070 7269 6d73  ol.sym.id, prims
+0001d970: 2e50 7269 6d49 4473 293a 0a20 2020 2020  .PrimIDs):.     
+0001d980: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+0001d990: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
+0001d9a0: 2062 6163 6b77 6172 6420 666f 7220 7468   backward for th
+0001d9b0: 6973 2073 796d 626f 6c2c 2073 6f20 7765  is symbol, so we
+0001d9c0: 2074 7279 2074 6f20 6465 636f 6d70 6f73   try to decompos
+0001d9d0: 6520 6974 0a20 2020 2020 2020 2020 2020  e it.           
+0001d9e0: 2020 2020 2062 6163 6b77 6172 6420 3d20       backward = 
+0001d9f0: 7061 7274 6961 6c28 6465 636f 6d70 6f73  partial(decompos
+0001da00: 6564 5f66 6e5f 6261 636b 7761 7264 5f72  ed_fn_backward_r
+0001da10: 756c 652c 2073 796d 626f 6c2e 7379 6d29  ule, symbol.sym)
+0001da20: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001da30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001da40: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
+0001da50: 7420 6669 6e64 2061 2062 6163 6b77 6172  t find a backwar
+0001da60: 6420 666f 7220 7468 6973 2073 796d 626f  d for this symbo
+0001da70: 6c20 616e 6420 7765 2063 6f75 6c64 206e  l and we could n
+0001da80: 6f74 2064 6563 6f6d 706f 7365 2069 740a  ot decompose it.
+0001da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001daa0: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
+0001dab0: 6e74 6564 4572 726f 7228 6622 4261 636b  ntedError(f"Back
+0001dac0: 7761 7264 2066 6f72 207b 7379 6d62 6f6c  ward for {symbol
+0001dad0: 2e73 796d 2e69 647d 2069 7320 6e6f 7420  .sym.id} is not 
+0001dae0: 696d 706c 656d 656e 7465 6422 290a 0a20  implemented").. 
+0001daf0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0001db00: 6261 636b 7761 7264 282a 7265 7369 6475  backward(*residu
+0001db10: 616c 732c 202a 636f 7461 6e67 656e 7473  als, *cotangents
+0001db20: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+0001db30: 6e73 7461 6e63 6528 7265 7375 6c74 2c20  nstance(result, 
+0001db40: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+0001db50: 2020 2023 2049 6620 7468 6520 6261 636b     # If the back
+0001db60: 7761 7264 2072 6574 7572 6e73 2061 2064  ward returns a d
+0001db70: 6963 742c 2077 6520 6173 7375 6d65 2074  ict, we assume t
+0001db80: 6861 7420 6974 2069 7320 6120 6469 6374  hat it is a dict
+0001db90: 206f 660a 2020 2020 2020 2020 2020 2020   of.            
+0001dba0: 2320 666f 7277 6172 6420 6172 6775 6d65  # forward argume
+0001dbb0: 6e74 7320 746f 2074 6865 2063 6f72 7265  nts to the corre
+0001dbc0: 7370 6f6e 6469 6e67 0a20 2020 2020 2020  sponding.       
+0001dbd0: 2020 2020 2023 2067 7261 6469 656e 7473       # gradients
+0001dbe0: 2f63 6f74 616e 6765 6e74 732f 6164 6a6f  /cotangents/adjo
+0001dbf0: 696e 7473 2f73 656e 7369 7469 7669 7469  ints/sensitiviti
+0001dc00: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+0001dc10: 7573 6564 5f6e 616d 6573 203d 2073 6574  used_names = set
+0001dc20: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
+0001dc30: 6f72 2069 2c20 286b 2c20 7629 2069 6e20  or i, (k, v) in 
+0001dc40: 656e 756d 6572 6174 6528 696e 7370 6563  enumerate(inspec
+0001dc50: 742e 7369 676e 6174 7572 6528 6175 675f  t.signature(aug_
+0001dc60: 666f 7277 6172 6429 2e70 6172 616d 6574  forward).paramet
+0001dc70: 6572 732e 6974 656d 7328 2929 3a0a 2020  ers.items()):.  
+0001dc80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001dc90: 2076 2e6b 696e 6420 696e 2028 696e 7370   v.kind in (insp
+0001dca0: 6563 742e 5061 7261 6d65 7465 722e 504f  ect.Parameter.PO
+0001dcb0: 5349 5449 4f4e 414c 5f4f 4e4c 592c 2069  SITIONAL_ONLY, i
+0001dcc0: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
+0001dcd0: 2e50 4f53 4954 494f 4e41 4c5f 4f52 5f4b  .POSITIONAL_OR_K
+0001dce0: 4559 574f 5244 293a 0a20 2020 2020 2020  EYWORD):.       
+0001dcf0: 2020 2020 2020 2020 2020 2020 2070 7574               put
+0001dd00: 5f67 7261 6428 7379 6d62 6f6c 2e61 7267  _grad(symbol.arg
+0001dd10: 735b 695d 2c20 7265 7375 6c74 2e67 6574  s[i], result.get
+0001dd20: 286b 2c20 4e6f 6e65 2929 0a20 2020 2020  (k, None)).     
+0001dd30: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0001dd40: 7365 645f 6e61 6d65 732e 6164 6428 6b29  sed_names.add(k)
+0001dd50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0001dd60: 466f 7220 6465 7665 6c6f 7065 7220 636f  For developer co
+0001dd70: 6e76 656e 6965 6e63 652c 2077 6520 616c  nvenience, we al
+0001dd80: 6c6f 7720 7573 696e 6720 7468 6520 6e61  low using the na
+0001dd90: 6d65 2066 726f 6d20 7468 650a 2020 2020  me from the.    
+0001dda0: 2020 2020 2020 2020 2320 666f 7277 6172          # forwar
+0001ddb0: 6420 6d65 7461 2069 6e20 6164 6469 7469  d meta in additi
+0001ddc0: 6f6e 2074 6f20 7468 6520 6e61 6d65 2066  on to the name f
+0001ddd0: 726f 6d20 7468 6520 6175 676d 656e 7465  rom the augmente
+0001dde0: 6420 666f 7277 6172 640a 2020 2020 2020  d forward.      
+0001ddf0: 2020 2020 2020 2320 7369 676e 6174 7572        # signatur
+0001de00: 652e 0a20 2020 2020 2020 2020 2020 2023  e..            #
+0001de10: 2049 6620 626f 7468 206e 616d 6573 2061   If both names a
+0001de20: 7265 2075 7365 642c 2074 6865 206f 6e65  re used, the one
+0001de30: 2066 726f 6d20 7468 6520 666f 7277 6172   from the forwar
+0001de40: 6420 6d65 7461 2074 616b 6573 0a20 2020  d meta takes.   
+0001de50: 2020 2020 2020 2020 2023 2070 7265 6365           # prece
+0001de60: 6465 6e63 652e 0a20 2020 2020 2020 2020  dence..         
+0001de70: 2020 2066 6f72 2069 2c20 286b 2c20 7629     for i, (k, v)
+0001de80: 2069 6e20 656e 756d 6572 6174 6528 696e   in enumerate(in
+0001de90: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
+0001dea0: 7379 6d62 6f6c 2e73 796d 2e6d 6574 6129  symbol.sym.meta)
+0001deb0: 2e70 6172 616d 6574 6572 732e 6974 656d  .parameters.item
+0001dec0: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+0001ded0: 2020 2020 2020 6966 2076 2e6b 696e 6420        if v.kind 
+0001dee0: 696e 2028 696e 7370 6563 742e 5061 7261  in (inspect.Para
+0001def0: 6d65 7465 722e 504f 5349 5449 4f4e 414c  meter.POSITIONAL
+0001df00: 5f4f 4e4c 592c 2069 6e73 7065 6374 2e50  _ONLY, inspect.P
+0001df10: 6172 616d 6574 6572 2e50 4f53 4954 494f  arameter.POSITIO
+0001df20: 4e41 4c5f 4f52 5f4b 4559 574f 5244 293a  NAL_OR_KEYWORD):
+0001df30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001df40: 2020 2020 2069 6620 6b20 6e6f 7420 696e       if k not in
+0001df50: 2075 7365 645f 6e61 6d65 733a 0a20 2020   used_names:.   
+0001df60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df70: 2020 2020 2070 7574 5f67 7261 6428 7379       put_grad(sy
+0001df80: 6d62 6f6c 2e61 7267 735b 695d 2c20 7265  mbol.args[i], re
+0001df90: 7375 6c74 2e67 6574 286b 2c20 4e6f 6e65  sult.get(k, None
+0001dfa0: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
+0001dfb0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0001dfc0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+0001dfd0: 6365 2872 6573 756c 742c 2053 6571 7565  ce(result, Seque
+0001dfe0: 6e63 6529 3a0a 2020 2020 2020 2020 2020  nce):.          
+0001dff0: 2020 7265 7375 6c74 203d 2028 7265 7375    result = (resu
+0001e000: 6c74 2c29 0a0a 2020 2020 2020 2020 6465  lt,)..        de
+0001e010: 6620 6973 5f64 6966 6665 7265 6e74 6961  f is_differentia
+0001e020: 626c 6528 6172 6729 3a0a 2020 2020 2020  ble(arg):.      
+0001e030: 2020 2020 2020 6d61 7463 6820 6172 673a        match arg:
+0001e040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e050: 2063 6173 6520 5465 6e73 6f72 5072 6f78   case TensorProx
+0001e060: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+0001e070: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001e080: 6474 7970 6573 2e69 735f 696e 6578 6163  dtypes.is_inexac
+0001e090: 745f 6474 7970 6528 6172 672e 6474 7970  t_dtype(arg.dtyp
+0001e0a0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001e0b0: 2020 2063 6173 6520 5365 7175 656e 6365     case Sequence
+0001e0c0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001e0d0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0001e0e0: 7267 2061 6e64 2061 6c6c 2869 7369 6e73  rg and all(isins
+0001e0f0: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+0001e100: 726f 7879 2920 616e 6420 6474 7970 6573  roxy) and dtypes
+0001e110: 2e69 735f 696e 6578 6163 745f 6474 7970  .is_inexact_dtyp
+0001e120: 6528 782e 6474 7970 6529 2066 6f72 2078  e(x.dtype) for x
+0001e130: 2069 6e20 6172 6729 0a20 2020 2020 2020   in arg).       
+0001e140: 2020 2020 2020 2020 2063 6173 6520 5f3a           case _:
+0001e150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e160: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0001e170: 650a 0a20 2020 2020 2020 2069 6620 6c65  e..        if le
+0001e180: 6e28 7379 6d62 6f6c 2e61 7267 7329 2021  n(symbol.args) !
+0001e190: 3d20 286f 7269 675f 7265 735f 6c65 6e20  = (orig_res_len 
+0001e1a0: 3a3d 206c 656e 2872 6573 756c 7429 293a  := len(result)):
+0001e1b0: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
+0001e1c0: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+0001e1d0: 2020 2020 6f72 6967 5f72 6573 5f6c 656e      orig_res_len
+0001e1e0: 203c 3d20 6c65 6e28 7379 6d62 6f6c 2e61   <= len(symbol.a
+0001e1f0: 7267 7329 2c0a 2020 2020 2020 2020 2020  rgs),.          
+0001e200: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+0001e210: 4261 636b 7761 7264 2066 6f72 207b 7379  Backward for {sy
+0001e220: 6d62 6f6c 2e73 796d 2e69 647d 2072 6574  mbol.sym.id} ret
+0001e230: 7572 6e65 6420 7b6f 7269 675f 7265 735f  urned {orig_res_
+0001e240: 6c65 6e7d 2076 616c 7565 732c 2022 0a20  len} values, ". 
+0001e250: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0001e260: 2066 2262 7574 2065 7870 6563 7465 6420   f"but expected 
+0001e270: 6174 206d 6f73 7420 7b6c 656e 2873 796d  at most {len(sym
+0001e280: 626f 6c2e 6172 6773 297d 222c 0a20 2020  bol.args)}",.   
+0001e290: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001e2a0: 2020 2020 2020 2023 2041 7373 756d 696e         # Assumin
+0001e2b0: 6720 7468 6174 2074 6865 206e 6f6e 2d64  g that the non-d
+0001e2c0: 6966 6665 7265 6e74 6961 626c 6520 6172  ifferentiable ar
+0001e2d0: 6775 6d65 6e74 7320 7765 7265 2064 726f  guments were dro
+0001e2e0: 7070 6564 2066 726f 6d0a 2020 2020 2020  pped from.      
+0001e2f0: 2020 2020 2020 2320 7468 6520 6261 636b        # the back
+0001e300: 7761 7264 2066 756e 6374 696f 6e2c 2077  ward function, w
+0001e310: 6520 6172 6520 676f 696e 6720 746f 2061  e are going to a
+0001e320: 7070 656e 6420 4e6f 6e65 2074 6f20 7468  ppend None to th
+0001e330: 6520 7265 7375 6c74 0a20 2020 2020 2020  e result.       
+0001e340: 2020 2020 2023 2074 6f20 6d61 7463 6820       # to match 
+0001e350: 7468 6520 6e75 6d62 6572 206f 6620 6172  the number of ar
+0001e360: 6775 6d65 6e74 732e 2041 6c74 6572 6e61  guments. Alterna
+0001e370: 7469 7665 6c79 2c20 7765 2063 6f75 6c64  tively, we could
+0001e380: 206a 7573 740a 2020 2020 2020 2020 2020   just.          
+0001e390: 2020 2320 6861 7665 2061 2066 6f72 2d6c    # have a for-l
+0001e3a0: 6f6f 7020 7769 7468 2061 2063 6f6e 6469  oop with a condi
+0001e3b0: 7469 6f6e 616c 2077 6865 6e20 7772 6974  tional when writ
+0001e3c0: 696e 6720 746f 2074 6865 0a20 2020 2020  ing to the.     
+0001e3d0: 2020 2020 2020 2023 2065 6e76 6972 6f6e         # environ
+0001e3e0: 6d65 6e74 2e0a 0a20 2020 2020 2020 2020  ment...         
+0001e3f0: 2020 2069 7465 725f 7265 7375 6c74 203d     iter_result =
+0001e400: 2069 7465 7228 7265 7375 6c74 290a 2020   iter(result).  
+0001e410: 2020 2020 2020 2020 2020 6e5f 6469 6666            n_diff
+0001e420: 6572 656e 7469 6162 6c65 5f61 7267 7320  erentiable_args 
+0001e430: 3d20 7375 6d28 626f 6f6c 2869 735f 6469  = sum(bool(is_di
+0001e440: 6666 6572 656e 7469 6162 6c65 2861 7267  fferentiable(arg
+0001e450: 2929 2066 6f72 2061 7267 2069 6e20 7379  )) for arg in sy
+0001e460: 6d62 6f6c 2e61 7267 7329 0a20 2020 2020  mbol.args).     
+0001e470: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
+0001e480: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+0001e490: 6469 6666 6572 656e 7469 6162 6c65 5f61  differentiable_a
+0001e4a0: 7267 7320 3c3d 206f 7269 675f 7265 735f  rgs <= orig_res_
+0001e4b0: 6c65 6e2c 0a20 2020 2020 2020 2020 2020  len,.           
+0001e4c0: 2020 2020 206c 616d 6264 613a 2066 2242       lambda: f"B
+0001e4d0: 6163 6b77 6172 6420 666f 7220 7b73 796d  ackward for {sym
+0001e4e0: 626f 6c2e 7379 6d2e 6964 7d20 7265 7475  bol.sym.id} retu
+0001e4f0: 726e 6564 207b 6f72 6967 5f72 6573 5f6c  rned {orig_res_l
+0001e500: 656e 7d20 7661 6c75 6528 7329 2c20 220a  en} value(s), ".
+0001e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e520: 2b20 6622 6275 7420 6578 7065 6374 6564  + f"but expected
+0001e530: 207b 6e5f 6469 6666 6572 656e 7469 6162   {n_differentiab
+0001e540: 6c65 5f61 7267 737d 222c 0a20 2020 2020  le_args}",.     
+0001e550: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0001e560: 2020 2020 2020 7265 7375 6c74 203d 2074        result = t
+0001e570: 7570 6c65 286e 6578 7428 6974 6572 5f72  uple(next(iter_r
+0001e580: 6573 756c 7429 2069 6620 6973 5f64 6966  esult) if is_dif
+0001e590: 6665 7265 6e74 6961 626c 6528 6172 6729  ferentiable(arg)
+0001e5a0: 2065 6c73 6520 4e6f 6e65 2066 6f72 2061   else None for a
+0001e5b0: 7267 2069 6e20 7379 6d62 6f6c 2e61 7267  rg in symbol.arg
+0001e5c0: 7329 0a0a 2020 2020 2020 2020 2320 5365  s)..        # Se
+0001e5d0: 6520 2242 6163 6b77 6172 6420 696d 706c  e "Backward impl
+0001e5e0: 2066 6f72 206f 7073 206f 6620 7468 6520   for ops of the 
+0001e5f0: 7479 7065 2053 6571 7565 6e63 655b 5465  type Sequence[Te
+0001e600: 6e73 6f72 5072 6f78 795d 2c20 2e2e 2e20  nsorProxy], ... 
+0001e610: 2d3e 202e 2e2e 2072 6573 756c 7473 2069  -> ... results i
+0001e620: 6e20 4e6f 6e65 2067 7261 6473 2e22 0a20  n None grads.". 
+0001e630: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
+0001e640: 2061 2074 656d 706f 7261 7279 2077 6f72   a temporary wor
+0001e650: 6b61 726f 756e 642e 0a20 2020 2020 2020  karound..       
+0001e660: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
+0001e670: 6420 696e 2028 7072 696d 732e 5072 696d  d in (prims.Prim
+0001e680: 4944 732e 4341 542c 2022 746f 7263 682e  IDs.CAT, "torch.
+0001e690: 6361 7422 2c20 2274 6f72 6368 2e73 7461  cat", "torch.sta
+0001e6a0: 636b 2229 3a0a 2020 2020 2020 2020 2020  ck"):.          
+0001e6b0: 2020 7361 6665 5f6d 6170 5f66 6c61 7428    safe_map_flat(
+0001e6c0: 7075 745f 6772 6164 2c20 7379 6d62 6f6c  put_grad, symbol
+0001e6d0: 2e61 7267 732c 2072 6573 756c 7429 0a20  .args, result). 
+0001e6e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001e6f0: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
+0001e700: 7028 7075 745f 6772 6164 2c20 7379 6d62  p(put_grad, symb
+0001e710: 6f6c 2e61 7267 732c 2072 6573 756c 7429  ol.args, result)
+0001e720: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
+0001e730: 6578 6163 745f 6474 7970 655f 6f72 5f6e  exact_dtype_or_n
+0001e740: 6f6e 6528 7829 3a0a 2020 2020 2020 2020  one(x):.        
+0001e750: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001e760: 2028 5465 6e73 6f72 5072 6f78 792c 2046   (TensorProxy, F
+0001e770: 7574 7572 6554 656e 736f 7250 726f 7879  utureTensorProxy
+0001e780: 2929 2061 6e64 2064 7479 7065 732e 6973  )) and dtypes.is
+0001e790: 5f69 6e65 7861 6374 5f64 7479 7065 2878  _inexact_dtype(x
+0001e7a0: 2e64 7479 7065 293a 0a20 2020 2020 2020  .dtype):.       
+0001e7b0: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
+0001e7c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001e7d0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0001e7e0: 6f6e 650a 0a20 2020 2067 6172 6773 203d  one..    gargs =
+0001e7f0: 2074 7265 655f 6d61 7028 6765 745f 6772   tree_map(get_gr
+0001e800: 6164 2c20 7475 706c 6528 7472 6163 652e  ad, tuple(trace.
+0001e810: 6172 6773 2929 0a20 2020 2067 6b77 6172  args)).    gkwar
+0001e820: 6773 203d 2074 7265 655f 6d61 7028 6765  gs = tree_map(ge
+0001e830: 745f 6772 6164 2c20 7472 6163 652e 6b77  t_grad, trace.kw
+0001e840: 6172 6773 290a 2020 2020 676b 7761 7267  args).    gkwarg
+0001e850: 7320 3d20 7b6b 3a20 7620 666f 7220 6b2c  s = {k: v for k,
+0001e860: 2076 2069 6e20 676b 7761 7267 732e 6974   v in gkwargs.it
+0001e870: 656d 7328 2920 6966 2076 2069 7320 6e6f  ems() if v is no
+0001e880: 7420 4e6f 6e65 7d0a 2020 2020 6761 7267  t None}.    garg
+0001e890: 732c 2067 6b77 6172 6773 203d 2074 7265  s, gkwargs = tre
+0001e8a0: 655f 6d61 7028 6765 745f 696e 6578 6163  e_map(get_inexac
+0001e8b0: 745f 6474 7970 655f 6f72 5f6e 6f6e 652c  t_dtype_or_none,
+0001e8c0: 2028 6761 7267 732c 2067 6b77 6172 6773   (gargs, gkwargs
+0001e8d0: 2929 0a20 2020 2072 6574 7572 6e20 6761  )).    return ga
+0001e8e0: 7267 7320 2b20 2867 6b77 6172 6773 2c29  rgs + (gkwargs,)
+0001e8f0: 2069 6620 6c65 6e28 676b 7761 7267 7329   if len(gkwargs)
+0001e900: 2021 3d20 3020 656c 7365 2067 6172 6773   != 0 else gargs
+0001e910: 0a0a 0a64 6566 2076 6a70 5f63 616c 6c5f  ...def vjp_call_
+0001e920: 6d65 7461 6675 6e63 2864 6574 6163 6865  metafunc(detache
+0001e930: 643a 2062 6f6f 6c2c 2070 7269 6d61 6c73  d: bool, primals
+0001e940: 2c20 636f 7461 6e67 656e 7473 2c20 7472  , cotangents, tr
+0001e950: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+0001e960: 6172 6773 293a 0a20 2020 2023 2041 7373  args):.    # Ass
+0001e970: 756d 696e 6720 7072 696d 616c 7320 6973  uming primals is
+0001e980: 2066 6c61 740a 0a20 2020 2069 6620 6e6f   flat..    if no
+0001e990: 7420 6973 696e 7374 616e 6365 2870 7269  t isinstance(pri
+0001e9a0: 6d61 6c73 2c20 5365 7175 656e 6365 293a  mals, Sequence):
+0001e9b0: 0a20 2020 2020 2020 2070 7269 6d61 6c73  .        primals
+0001e9c0: 203d 2028 7072 696d 616c 732c 290a 0a20   = (primals,).. 
+0001e9d0: 2020 2063 7478 203d 2064 6574 6163 6865     ctx = detache
+0001e9e0: 645f 7472 6163 6528 2920 6966 2064 6574  d_trace() if det
+0001e9f0: 6163 6865 6420 656c 7365 206e 756c 6c63  ached else nullc
+0001ea00: 6f6e 7465 7874 2829 0a20 2020 2077 6974  ontext().    wit
+0001ea10: 6820 6374 783a 0a20 2020 2020 2020 2072  h ctx:.        r
+0001ea20: 6573 756c 742c 2065 6e76 203d 2061 7567  esult, env = aug
+0001ea30: 6d65 6e74 6564 5f66 6f72 7761 7264 5f70  mented_forward_p
+0001ea40: 6173 7328 2a70 7269 6d61 6c73 2c20 7472  ass(*primals, tr
+0001ea50: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
+0001ea60: 7267 7329 0a20 2020 2020 2020 2063 6865  rgs).        che
+0001ea70: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+0001ea80: 6c65 6e28 7265 7375 6c74 2920 3d3d 206c  len(result) == l
+0001ea90: 656e 2863 6f74 616e 6765 6e74 7329 2069  en(cotangents) i
+0001eaa0: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+0001eab0: 756c 742c 2053 6571 7565 6e63 6529 2065  ult, Sequence) e
+0001eac0: 6c73 6520 5472 7565 2c0a 2020 2020 2020  lse True,.      
+0001ead0: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+0001eae0: 4578 7065 6374 6564 2063 6f74 616e 6765  Expected cotange
+0001eaf0: 6e74 7320 746f 2062 6520 6120 7365 7175  nts to be a sequ
+0001eb00: 656e 6365 206f 6620 6c65 6e67 7468 207b  ence of length {
+0001eb10: 6c65 6e28 7265 7375 6c74 297d 2c20 676f  len(result)}, go
+0001eb20: 7420 6120 7365 7175 656e 6365 206f 6620  t a sequence of 
+0001eb30: 6c65 6e67 7468 207b 6c65 6e28 636f 7461  length {len(cota
+0001eb40: 6e67 656e 7473 297d 222c 0a20 2020 2020  ngents)}",.     
+0001eb50: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+0001eb60: 7572 6e20 7265 7375 6c74 2c20 6261 636b  urn result, back
+0001eb70: 7761 7264 5f70 6173 7328 656e 762c 2074  ward_pass(env, t
+0001eb80: 7261 6365 2c20 636f 7461 6e67 656e 7473  race, cotangents
+0001eb90: 290a 0a0a 2320 544f 444f 3a20 4361 6e27  )...# TODO: Can'
+0001eba0: 7420 7573 6520 6120 5379 6d62 6f6c 2068  t use a Symbol h
+0001ebb0: 6572 6520 6265 6361 7573 6520 6d69 7865  ere because mixe
+0001ebc0: 6420 6578 6563 7574 6f72 2073 7962 7379  d executor sybsy
+0001ebd0: 6d62 6f6c 7320 7365 656d 2074 6f20 6265  mbols seem to be
+0001ebe0: 0a23 2075 6e73 7570 706f 7274 6564 2e20  .# unsupported. 
+0001ebf0: 5365 6520 6973 7375 6520 2243 6f75 6c64  See issue "Could
+0001ec00: 206e 6f74 2066 696e 6420 616e 2065 7865   not find an exe
+0001ec10: 6375 746f 7220 666f 7220 626f 756e 6420  cutor for bound 
+0001ec20: 7379 6d62 6f6c 2077 6865 6e20 6974 7320  symbol when its 
+0001ec30: 7375 6273 796d 626f 6c73 0a23 2061 7265  subsymbols.# are
+0001ec40: 206e 6f74 2066 756c 6c79 2073 7570 706f   not fully suppo
+0001ec50: 7274 6564 2062 7920 6120 7369 6e67 6c65  rted by a single
+0001ec60: 2065 7865 6375 746f 7222 0a76 6a70 5f63   executor".vjp_c
+0001ec70: 616c 6c20 3d20 7061 7274 6961 6c28 0a20  all = partial(. 
+0001ec80: 2020 2076 6a70 5f63 616c 6c5f 6d65 7461     vjp_call_meta
+0001ec90: 6675 6e63 2c20 4661 6c73 650a 2920 2023  func, False.)  #
+0001eca0: 2053 796d 626f 6c28 6964 3d54 7261 6e73   Symbol(id=Trans
+0001ecb0: 666f 726d 732e 566a 704f 702c 206e 616d  forms.VjpOp, nam
+0001ecc0: 653d 2276 6a70 5f63 616c 6c22 2c20 6d65  e="vjp_call", me
+0001ecd0: 7461 3d70 6172 7469 616c 2876 6a70 5f63  ta=partial(vjp_c
+0001ece0: 616c 6c5f 6d65 7461 6675 6e63 2c20 4661  all_metafunc, Fa
+0001ecf0: 6c73 6529 290a 0a0a 6465 6620 766a 7028  lse))...def vjp(
+0001ed00: 6675 6e63 293a 0a20 2020 2022 2222 436f  func):.    """Co
+0001ed10: 6d70 7574 6573 2074 6865 2056 4a50 206f  mputes the VJP o
+0001ed20: 6620 6120 6675 6e63 7469 6f6e 2e0a 0a20  f a function... 
+0001ed30: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0001ed40: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
+0001ed50: 3a20 4675 6e63 7469 6f6e 2074 6f20 6265  : Function to be
+0001ed60: 2064 6966 6665 7265 6e74 6961 7465 642e   differentiated.
+0001ed70: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+0001ed80: 6620 5f76 6a70 2870 7269 6d61 6c73 2c20  f _vjp(primals, 
+0001ed90: 636f 7461 6e67 656e 7473 2c20 2a2a 6b77  cotangents, **kw
+0001eda0: 6172 6773 293a 0a20 2020 2020 2020 2066  args):.        f
+0001edb0: 6c61 745f 6675 6e63 2c20 666c 6174 5f61  lat_func, flat_a
+0001edc0: 7267 732c 2073 7065 6320 3d20 666c 6174  rgs, spec = flat
+0001edd0: 7465 6e5f 6675 6e63 2866 756e 632c 2070  ten_func(func, p
+0001ede0: 7269 6d61 6c73 2c20 6b77 6172 6773 290a  rimals, kwargs).
+0001edf0: 2020 2020 2020 2020 7472 6163 6520 3d20          trace = 
+0001ee00: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+0001ee10: 2928 666c 6174 5f66 756e 632c 202a 666c  )(flat_func, *fl
+0001ee20: 6174 5f61 7267 7329 0a20 2020 2020 2020  at_args).       
+0001ee30: 2072 6573 756c 742c 2076 6a70 5f72 6573   result, vjp_res
+0001ee40: 756c 7420 3d20 766a 705f 6361 6c6c 2866  ult = vjp_call(f
+0001ee50: 6c61 745f 6172 6773 2c20 636f 7461 6e67  lat_args, cotang
+0001ee60: 656e 7473 2c20 7472 6163 653d 7472 6163  ents, trace=trac
+0001ee70: 6529 0a20 2020 2020 2020 2067 7072 696d  e).        gprim
+0001ee80: 616c 732c 2067 6b77 6172 6773 203d 2074  als, gkwargs = t
+0001ee90: 7265 655f 756e 666c 6174 7465 6e28 766a  ree_unflatten(vj
+0001eea0: 705f 7265 7375 6c74 2c20 7370 6563 290a  p_result, spec).
+0001eeb0: 2020 2020 2020 2020 6772 6164 7320 3d20          grads = 
+0001eec0: 6770 7269 6d61 6c73 202b 2028 676b 7761  gprimals + (gkwa
+0001eed0: 7267 732c 2920 6966 206c 656e 2867 6b77  rgs,) if len(gkw
+0001eee0: 6172 6773 2920 213d 2030 2065 6c73 6520  args) != 0 else 
+0001eef0: 6770 7269 6d61 6c73 0a20 2020 2020 2020  gprimals.       
+0001ef00: 2072 6574 7572 6e20 7265 7375 6c74 2c20   return result, 
+0001ef10: 6772 6164 730a 0a20 2020 2072 6574 7572  grads..    retur
+0001ef20: 6e20 5f76 6a70 0a0a 0a64 6566 2076 616c  n _vjp...def val
+0001ef30: 7565 5f61 6e64 5f67 7261 6428 6675 6e63  ue_and_grad(func
+0001ef40: 293a 0a20 2020 2022 2222 436f 6d70 7574  ):.    """Comput
+0001ef50: 6573 2074 6865 2076 616c 7565 2061 6e64  es the value and
+0001ef60: 2067 7261 6469 656e 7420 6f66 2061 2066   gradient of a f
+0001ef70: 756e 6374 696f 6e2e 0a0a 2020 2020 5468  unction...    Th
+0001ef80: 6973 2069 7320 6120 636f 6e76 656e 6965  is is a convenie
+0001ef90: 6e63 6520 6675 6e63 7469 6f6e 2074 6861  nce function tha
+0001efa0: 7420 636f 6d62 696e 6573 2074 6865 2066  t combines the f
+0001efb0: 756e 6374 696f 6e61 6c69 7479 206f 660a  unctionality of.
+0001efc0: 2020 2020 6076 6a70 5f63 616c 6c60 2077      `vjp_call` w
+0001efd0: 6974 6820 696d 706c 6963 6974 2069 6e69  ith implicit ini
+0001efe0: 7469 616c 697a 6174 696f 6e20 6f66 2074  tialization of t
+0001eff0: 6865 2063 6f74 616e 6765 6e74 2074 6f20  he cotangent to 
+0001f000: 312e 0a0a 2020 2020 4172 6773 3a0a 2020  1...    Args:.  
+0001f010: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
+0001f020: 6162 6c65 293a 2046 756e 6374 696f 6e20  able): Function 
+0001f030: 746f 2062 6520 6469 6666 6572 656e 7469  to be differenti
+0001f040: 6174 6564 2e0a 2020 2020 2222 220a 0a20  ated..    """.. 
+0001f050: 2020 2064 6566 206f 6e65 735f 6c69 6b65     def ones_like
+0001f060: 2878 293a 0a20 2020 2020 2020 2069 6620  (x):.        if 
+0001f070: 6973 696e 7374 616e 6365 2878 2c20 5465  isinstance(x, Te
+0001f080: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
+0001f090: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001f0a0: 756c 6c5f 6c69 6b65 2878 2c20 6669 6c6c  ull_like(x, fill
+0001f0b0: 5f76 616c 7565 3d31 290a 2020 2020 2020  _value=1).      
+0001f0c0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0001f0d0: 6528 782c 204e 756d 6265 7250 726f 7879  e(x, NumberProxy
+0001f0e0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0001f0f0: 6574 7572 6e20 7479 7065 2878 2e76 616c  eturn type(x.val
+0001f100: 7565 2928 3129 0a20 2020 2020 2020 2065  ue)(1).        e
+0001f110: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001f120: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0001f130: 7228 6622 6f6e 6573 5f6c 696b 6520 696e  r(f"ones_like in
+0001f140: 7369 6465 2076 616c 7565 5f61 6e64 5f67  side value_and_g
+0001f150: 7261 6420 676f 7420 616e 2075 6e73 7570  rad got an unsup
+0001f160: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
+0001f170: 6528 7829 7d22 290a 0a20 2020 2064 6566  e(x)}")..    def
+0001f180: 205f 7661 6c75 655f 616e 645f 6772 6164   _value_and_grad
+0001f190: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0001f1a0: 293a 0a20 2020 2020 2020 2074 7261 6365  ):.        trace
+0001f1b0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0001f1c0: 6365 2829 2866 756e 632c 202a 6172 6773  ce()(func, *args
+0001f1d0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0001f1e0: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
+0001f1f0: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+0001f200: 2076 3a20 6f6e 6573 5f6c 696b 6528 7629   v: ones_like(v)
+0001f210: 2c20 7472 6163 652e 6f75 7470 7574 290a  , trace.output).
+0001f220: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+0001f230: 6a70 2866 756e 6329 2861 7267 732c 2063  jp(func)(args, c
+0001f240: 6f74 616e 6765 6e74 732c 202a 2a6b 7761  otangents, **kwa
+0001f250: 7267 7329 0a0a 2020 2020 7265 7475 726e  rgs)..    return
+0001f260: 205f 7661 6c75 655f 616e 645f 6772 6164   _value_and_grad
+0001f270: 0a0a 0a46 6f72 7761 7264 4261 636b 7761  ...ForwardBackwa
+0001f280: 7264 5472 6163 6573 203d 206e 616d 6564  rdTraces = named
+0001f290: 7475 706c 6528 2246 6f72 7761 7264 4261  tuple("ForwardBa
+0001f2a0: 636b 7761 7264 5472 6163 6573 222c 205b  ckwardTraces", [
+0001f2b0: 2266 6f72 7761 7264 5f74 7261 6365 222c  "forward_trace",
+0001f2c0: 2022 6261 636b 7761 7264 5f74 7261 6365   "backward_trace
+0001f2d0: 225d 290a 0a0a 6465 6620 5f73 706c 6974  "])...def _split
+0001f2e0: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+0001f2f0: 6172 645f 696e 746f 5f74 656e 736f 7273  ard_into_tensors
+0001f300: 5f61 6e64 5f6f 7468 6572 280a 2020 2020  _and_other(.    
+0001f310: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001f320: 7264 3a20 5365 7175 656e 6365 5b56 6172  rd: Sequence[Var
+0001f330: 6961 626c 655d 2c0a 2920 2d3e 2074 7570  iable],.) -> tup
+0001f340: 6c65 5b53 6571 7565 6e63 655b 5661 7269  le[Sequence[Vari
+0001f350: 6162 6c65 5d2c 2053 6571 7565 6e63 655b  able], Sequence[
+0001f360: 5661 7269 6162 6c65 5d5d 3a0a 2020 2020  Variable]]:.    
+0001f370: 2222 2253 706c 6974 7320 7361 7665 645f  """Splits saved_
+0001f380: 666f 725f 6261 636b 7761 7264 2069 6e74  for_backward int
+0001f390: 6f20 7465 6e73 6f72 7320 616e 6420 6f74  o tensors and ot
+0001f3a0: 6865 722e 0a0a 2020 2020 4172 6773 3a0a  her...    Args:.
+0001f3b0: 2020 2020 2020 2020 7361 7665 645f 666f          saved_fo
+0001f3c0: 725f 6261 636b 7761 7264 2028 5365 7175  r_backward (Sequ
+0001f3d0: 656e 6365 5b56 6172 6961 626c 655d 293a  ence[Variable]):
+0001f3e0: 2053 6176 6564 5f66 6f72 5f62 6163 6b77   Saved_for_backw
+0001f3f0: 6172 6420 746f 2073 706c 6974 2e0a 0a20  ard to split... 
+0001f400: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0001f410: 2020 2020 7475 706c 655b 5365 7175 656e      tuple[Sequen
+0001f420: 6365 5b56 6172 6961 626c 655d 2c20 5365  ce[Variable], Se
+0001f430: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
+0001f440: 5d3a 2054 7570 6c65 206f 6620 7465 6e73  ]: Tuple of tens
+0001f450: 6f72 7320 616e 6420 6f74 6865 722e 0a20  ors and other.. 
+0001f460: 2020 2022 2222 0a20 2020 2069 735f 7465     """.    is_te
+0001f470: 6e73 6f72 203d 206c 616d 6264 6120 783a  nsor = lambda x:
+0001f480: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
+0001f490: 656e 736f 7250 726f 7879 290a 2020 2020  ensorProxy).    
+0001f4a0: 6f74 6865 722c 2074 656e 736f 7273 203d  other, tensors =
+0001f4b0: 2075 7469 6c73 2e70 6172 7469 7469 6f6e   utils.partition
+0001f4c0: 2869 735f 7465 6e73 6f72 2c20 7361 7665  (is_tensor, save
+0001f4d0: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
+0001f4e0: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
+0001f4f0: 2874 656e 736f 7273 292c 2074 7570 6c65  (tensors), tuple
+0001f500: 286f 7468 6572 290a 0a0a 6465 6620 5f75  (other)...def _u
+0001f510: 7064 6174 655f 666f 7277 6172 645f 7769  pdate_forward_wi
+0001f520: 7468 5f6e 6577 5f73 6176 6564 5f66 6f72  th_new_saved_for
+0001f530: 5f62 6163 6b77 6172 6428 666f 7277 6172  _backward(forwar
+0001f540: 645f 7472 6163 653a 2054 7261 6365 2c20  d_trace: Trace, 
+0001f550: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001f560: 7264 3a20 5365 7175 656e 6365 5b56 6172  rd: Sequence[Var
+0001f570: 6961 626c 655d 2920 2d3e 204e 6f6e 653a  iable]) -> None:
+0001f580: 0a20 2020 2022 2222 5570 6461 7465 7320  .    """Updates 
+0001f590: 7468 6520 666f 7277 6172 6420 7472 6163  the forward trac
+0001f5a0: 6520 7769 7468 206e 6577 2073 6176 6564  e with new saved
+0001f5b0: 5f66 6f72 5f62 6163 6b77 6172 642e 0a0a  _for_backward...
+0001f5c0: 2020 2020 5468 6973 2069 7320 6e65 6365      This is nece
+0001f5d0: 7373 6172 7920 6265 6361 7573 6520 7468  ssary because th
+0001f5e0: 6520 7570 6461 7465 6420 7361 7665 645f  e updated saved_
+0001f5f0: 666f 725f 6261 636b 7761 7264 2069 7320  for_backward is 
+0001f600: 6e6f 7420 6176 6169 6c61 626c 650a 2020  not available.  
+0001f610: 2020 7768 656e 2074 6865 2066 6f72 7761    when the forwa
+0001f620: 7264 2061 6e64 2062 6163 6b77 6172 6420  rd and backward 
+0001f630: 7472 6163 6573 2061 7265 2063 6f6e 7374  traces are const
+0001f640: 7275 6374 6564 2e0a 0a20 2020 2041 7267  ructed...    Arg
+0001f650: 733a 0a20 2020 2020 2020 2066 6f72 7761  s:.        forwa
+0001f660: 7264 5f74 7261 6365 2028 5472 6163 6529  rd_trace (Trace)
+0001f670: 3a20 466f 7277 6172 6420 7472 6163 6520  : Forward trace 
+0001f680: 746f 2075 7064 6174 652e 0a20 2020 2020  to update..     
+0001f690: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+0001f6a0: 6b77 6172 6420 2853 6571 7565 6e63 655b  kward (Sequence[
+0001f6b0: 5661 7269 6162 6c65 5d29 3a20 5361 7665  Variable]): Save
+0001f6c0: 645f 666f 725f 6261 636b 7761 7264 2074  d_for_backward t
+0001f6d0: 6f20 7573 6520 746f 0a20 2020 2020 2020  o use to.       
+0001f6e0: 2020 2020 2075 7064 6174 6520 7468 6520       update the 
+0001f6f0: 666f 7277 6172 6420 7472 6163 652e 0a20  forward trace.. 
+0001f700: 2020 2022 2222 0a20 2020 2073 6176 6564     """.    saved
+0001f710: 5f66 6f72 5f62 6163 6b77 6172 6420 3d20  _for_backward = 
+0001f720: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+0001f730: 783a 2078 2e76 616c 7565 2069 6620 6973  x: x.value if is
+0001f740: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
+0001f750: 6572 5072 6f78 7929 2065 6c73 6520 782c  erProxy) else x,
+0001f760: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001f770: 6172 6429 0a20 2020 2073 6176 6564 5f74  ard).    saved_t
+0001f780: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
+0001f790: 6865 7220 3d20 5f73 706c 6974 5f73 6176  her = _split_sav
+0001f7a0: 6564 5f66 6f72 5f62 6163 6b77 6172 645f  ed_for_backward_
+0001f7b0: 696e 746f 5f74 656e 736f 7273 5f61 6e64  into_tensors_and
+0001f7c0: 5f6f 7468 6572 2873 6176 6564 5f66 6f72  _other(saved_for
+0001f7d0: 5f62 6163 6b77 6172 6429 0a20 2020 2061  _backward).    a
+0001f7e0: 7373 6572 7420 666f 7277 6172 645f 7472  ssert forward_tr
+0001f7f0: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0001f800: 735b 2d31 5d2e 7379 6d2e 6964 203d 3d20  s[-1].sym.id == 
+0001f810: 7072 696d 732e 5072 696d 4944 732e 5245  prims.PrimIDs.RE
+0001f820: 5455 524e 0a20 2020 206e 6577 5f72 6574  TURN.    new_ret
+0001f830: 7572 6e20 3d20 2866 6f72 7761 7264 5f74  urn = (forward_t
+0001f840: 7261 6365 2e6f 7574 7075 745b 305d 2c20  race.output[0], 
+0001f850: 2873 6176 6564 5f74 656e 736f 7273 2c20  (saved_tensors, 
+0001f860: 7361 7665 645f 6f74 6865 7229 290a 2020  saved_other)).  
+0001f870: 2020 666f 7277 6172 645f 7472 6163 652e    forward_trace.
+0001f880: 626f 756e 645f 7379 6d62 6f6c 735b 2d31  bound_symbols[-1
+0001f890: 5d20 3d20 7265 706c 6163 6528 666f 7277  ] = replace(forw
+0001f8a0: 6172 645f 7472 6163 652e 626f 756e 645f  ard_trace.bound_
+0001f8b0: 7379 6d62 6f6c 735b 2d31 5d2c 2061 7267  symbols[-1], arg
+0001f8c0: 733d 6e65 775f 7265 7475 726e 290a 0a0a  s=new_return)...
+0001f8d0: 6465 6620 5f75 7064 6174 655f 6261 636b  def _update_back
+0001f8e0: 7761 7264 5f77 6974 685f 6e65 775f 7361  ward_with_new_sa
+0001f8f0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f900: 2862 6163 6b77 6172 645f 7472 6163 653a  (backward_trace:
+0001f910: 2054 7261 6365 2c20 7361 7665 645f 666f   Trace, saved_fo
+0001f920: 725f 6261 636b 7761 7264 3a20 5365 7175  r_backward: Sequ
+0001f930: 656e 6365 5b56 6172 6961 626c 655d 2920  ence[Variable]) 
+0001f940: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
+0001f950: 5570 6461 7465 7320 7468 6520 6261 636b  Updates the back
+0001f960: 7761 7264 2074 7261 6365 2077 6974 6820  ward trace with 
+0001f970: 6e65 7720 7361 7665 645f 666f 725f 6261  new saved_for_ba
+0001f980: 636b 7761 7264 2e0a 0a20 2020 2054 6869  ckward...    Thi
+0001f990: 7320 6973 206e 6563 6573 7361 7279 2062  s is necessary b
+0001f9a0: 6563 6175 7365 2074 6865 2075 7064 6174  ecause the updat
+0001f9b0: 6564 2073 6176 6564 5f66 6f72 5f62 6163  ed saved_for_bac
+0001f9c0: 6b77 6172 6420 6973 0a20 2020 206e 6f74  kward is.    not
+0001f9d0: 2061 7661 696c 6162 6c65 2077 6865 6e20   available when 
+0001f9e0: 7468 6520 6261 636b 7761 7264 2074 7261  the backward tra
+0001f9f0: 6365 2069 7320 636f 6e73 7472 7563 7465  ce is constructe
+0001fa00: 642e 0a0a 2020 2020 4172 6773 3a0a 2020  d...    Args:.  
+0001fa10: 2020 2020 2020 6261 636b 7761 7264 5f74        backward_t
+0001fa20: 7261 6365 2028 5472 6163 6529 3a20 4261  race (Trace): Ba
+0001fa30: 636b 7761 7264 2074 7261 6365 2074 6f20  ckward trace to 
+0001fa40: 7570 6461 7465 2e0a 2020 2020 2020 2020  update..        
+0001fa50: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001fa60: 7264 2028 5365 7175 656e 6365 5b56 6172  rd (Sequence[Var
+0001fa70: 6961 626c 655d 293a 2053 6176 6564 5f66  iable]): Saved_f
+0001fa80: 6f72 5f62 6163 6b77 6172 6420 746f 2075  or_backward to u
+0001fa90: 7365 2074 6f0a 2020 2020 2020 2020 2020  se to.          
+0001faa0: 2020 7570 6461 7465 2074 6865 2062 6163    update the bac
+0001fab0: 6b77 6172 6420 7472 6163 652e 0a20 2020  kward trace..   
+0001fac0: 2022 2222 0a0a 2020 2020 6465 6620 756e   """..    def un
+0001fad0: 7061 636b 696e 675f 666e 2873 6176 6564  packing_fn(saved
+0001fae0: 5f66 6f72 5f62 6163 6b77 6172 642c 2063  _for_backward, c
+0001faf0: 6f74 616e 6765 6e74 7329 3a0a 2020 2020  otangents):.    
+0001fb00: 2020 2020 7061 7373 0a0a 2020 2020 636f      pass..    co
+0001fb10: 7461 6e67 656e 7473 203d 2062 6163 6b77  tangents = backw
+0001fb20: 6172 645f 7472 6163 652e 6172 6773 5b31  ard_trace.args[1
+0001fb30: 5d0a 2020 2020 7361 7665 645f 7465 6e73  ].    saved_tens
+0001fb40: 6f72 732c 2073 6176 6564 5f6f 7468 6572  ors, saved_other
+0001fb50: 203d 205f 7370 6c69 745f 7361 7665 645f   = _split_saved_
+0001fb60: 666f 725f 6261 636b 7761 7264 5f69 6e74  for_backward_int
+0001fb70: 6f5f 7465 6e73 6f72 735f 616e 645f 6f74  o_tensors_and_ot
+0001fb80: 6865 7228 7361 7665 645f 666f 725f 6261  her(saved_for_ba
+0001fb90: 636b 7761 7264 290a 2020 2020 756e 7061  ckward).    unpa
+0001fba0: 636b 696e 675f 7472 6163 6520 3d20 636f  cking_trace = co
+0001fbb0: 6e73 7472 7563 745f 7472 6163 6528 7265  nstruct_trace(re
+0001fbc0: 6e61 6d65 5f70 726f 7869 6573 3d46 616c  name_proxies=Fal
+0001fbd0: 7365 2c20 7573 655f 6463 653d 4661 6c73  se, use_dce=Fals
+0001fbe0: 6529 280a 2020 2020 2020 2020 756e 7061  e)(.        unpa
+0001fbf0: 636b 696e 675f 666e 2c20 2873 6176 6564  cking_fn, (saved
+0001fc00: 5f74 656e 736f 7273 2c20 7361 7665 645f  _tensors, saved_
+0001fc10: 6f74 6865 7229 2c20 636f 7461 6e67 656e  other), cotangen
+0001fc20: 7473 0a20 2020 2029 0a20 2020 2061 7373  ts.    ).    ass
+0001fc30: 6572 7420 756e 7061 636b 696e 675f 7472  ert unpacking_tr
+0001fc40: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0001fc50: 735b 2d31 5d2e 7379 6d2e 6964 203d 3d20  s[-1].sym.id == 
+0001fc60: 7072 696d 732e 5072 696d 4944 732e 5245  prims.PrimIDs.RE
+0001fc70: 5455 524e 0a0a 2020 2020 6261 636b 7761  TURN..    backwa
+0001fc80: 7264 5f74 7261 6365 2e61 7267 7320 3d20  rd_trace.args = 
+0001fc90: 756e 7061 636b 696e 675f 7472 6163 652e  unpacking_trace.
+0001fca0: 6172 6773 0a20 2020 2062 6163 6b77 6172  args.    backwar
+0001fcb0: 645f 7472 6163 655f 6273 796d 735f 7769  d_trace_bsyms_wi
+0001fcc0: 7468 6f75 745f 756e 7061 636b 696e 6720  thout_unpacking 
+0001fcd0: 3d20 280a 2020 2020 2020 2020 6273 796d  = (.        bsym
+0001fce0: 0a20 2020 2020 2020 2066 6f72 2062 7379  .        for bsy
+0001fcf0: 6d20 696e 2062 6163 6b77 6172 645f 7472  m in backward_tr
+0001fd00: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
+0001fd10: 730a 2020 2020 2020 2020 6966 2062 7379  s.        if bsy
+0001fd20: 6d2e 7379 6d2e 6964 0a20 2020 2020 2020  m.sym.id.       
+0001fd30: 206e 6f74 2069 6e20 280a 2020 2020 2020   not in (.      
+0001fd40: 2020 2020 2020 7072 696d 732e 5072 696d        prims.Prim
+0001fd50: 4944 732e 554e 5041 434b 5f45 4d50 5459  IDs.UNPACK_EMPTY
+0001fd60: 5f44 4943 542c 0a20 2020 2020 2020 2020  _DICT,.         
+0001fd70: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+0001fd80: 2e55 4e50 4143 4b5f 4b45 592c 0a20 2020  .UNPACK_KEY,.   
+0001fd90: 2020 2020 2020 2020 2070 7269 6d73 2e50           prims.P
+0001fda0: 7269 6d49 4473 2e55 4e50 4143 4b5f 5345  rimIDs.UNPACK_SE
+0001fdb0: 5155 454e 4345 2c0a 2020 2020 2020 2020  QUENCE,.        
+0001fdc0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+0001fdd0: 732e 554e 5041 434b 5f54 5249 5649 414c  s.UNPACK_TRIVIAL
+0001fde0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001fdf0: 290a 2020 2020 6261 636b 7761 7264 5f74  ).    backward_t
+0001fe00: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001fe10: 6c73 203d 206c 6973 7428 282a 756e 7061  ls = list((*unpa
+0001fe20: 636b 696e 675f 7472 6163 652e 626f 756e  cking_trace.boun
+0001fe30: 645f 7379 6d62 6f6c 735b 3a2d 315d 2c20  d_symbols[:-1], 
+0001fe40: 2a62 6163 6b77 6172 645f 7472 6163 655f  *backward_trace_
+0001fe50: 6273 796d 735f 7769 7468 6f75 745f 756e  bsyms_without_un
+0001fe60: 7061 636b 696e 6729 290a 0a0a 2320 4e4f  packing))...# NO
+0001fe70: 5445 3a20 5265 7475 726e 696e 6720 6e61  TE: Returning na
+0001fe80: 6d65 6474 7570 6c65 7320 6672 6f6d 2063  medtuples from c
+0001fe90: 6f6d 7069 6c65 6420 6675 6e63 7469 6f6e  ompiled function
+0001fea0: 7320 646f 6573 6e27 7420 776f 726b 2e20  s doesn't work. 
+0001feb0: 5365 653a 0a23 2022 416c 6c6f 7720 7265  See:.# "Allow re
+0001fec0: 7475 726e 696e 6720 6e61 6d65 6474 7570  turning namedtup
+0001fed0: 6c65 7320 6672 6f6d 2063 6f6d 7069 6c65  les from compile
+0001fee0: 6420 6675 6e63 7469 6f6e 7322 0a23 204e  d functions".# N
+0001fef0: 6f74 6520 5b47 7261 6420 666f 7277 6172  ote [Grad forwar
+0001ff00: 6420 6f75 7470 7574 2073 7065 635d 0a23  d output spec].#
+0001ff10: 2049 6620 6974 2064 6964 2077 6f72 6b20   If it did work 
+0001ff20: 6974 2077 6f75 6c64 2062 6520 6e69 6365  it would be nice
+0001ff30: 2074 6f20 7573 6520 7468 6973 206e 616d   to use this nam
+0001ff40: 6564 7475 706c 650a 2320 696e 7374 6561  edtuple.# instea
+0001ff50: 6420 6f66 2074 6865 2070 6c61 696e 2074  d of the plain t
+0001ff60: 7570 6c65 206f 7220 6469 6374 2074 6861  uple or dict tha
+0001ff70: 7420 7765 2772 6520 7573 696e 6720 6e6f  t we're using no
+0001ff80: 772e 0a54 6f72 6368 4175 746f 6772 6164  w..TorchAutograd
+0001ff90: 466f 7277 6172 6444 6174 6120 3d20 6e61  ForwardData = na
+0001ffa0: 6d65 6474 7570 6c65 280a 2020 2020 2254  medtuple(.    "T
+0001ffb0: 6f72 6368 4175 746f 6772 6164 466f 7277  orchAutogradForw
+0001ffc0: 6172 6444 6174 6122 2c0a 2020 2020 5b22  ardData",.    ["
+0001ffd0: 6f75 7470 7574 222c 2022 666c 6174 5f61  output", "flat_a
+0001ffe0: 7267 7322 2c20 2266 6c61 745f 6f75 7470  rgs", "flat_outp
+0001fff0: 7574 225d 2c0a 290a 0a0a 6465 6620 666f  ut"],.)...def fo
+00020000: 7277 6172 645f 616e 645f 6261 636b 7761  rward_and_backwa
+00020010: 7264 5f66 726f 6d5f 7472 6163 6528 7472  rd_from_trace(tr
+00020020: 6163 653a 2054 7261 6365 2c20 746f 7263  ace: Trace, torc
+00020030: 685f 6175 746f 6772 6164 3d46 616c 7365  h_autograd=False
+00020040: 2920 2d3e 2046 6f72 7761 7264 4261 636b  ) -> ForwardBack
+00020050: 7761 7264 5472 6163 6573 3a0a 2020 2020  wardTraces:.    
+00020060: 2222 2247 656e 6572 6174 6573 2074 6865  """Generates the
+00020070: 2066 6f72 7761 7264 2061 6e64 2062 6163   forward and bac
+00020080: 6b77 6172 6420 7061 7373 6573 2066 726f  kward passes fro
+00020090: 6d20 6120 7472 6163 652e 0a0a 2020 2020  m a trace...    
+000200a0: 5468 6973 2069 7320 6120 636f 6e76 656e  This is a conven
+000200b0: 6965 6e63 6520 6675 6e63 7469 6f6e 2074  ience function t
+000200c0: 6861 7420 636f 6d62 696e 6573 2074 6865  hat combines the
+000200d0: 2066 756e 6374 696f 6e61 6c69 7479 206f   functionality o
+000200e0: 660a 2020 2020 6061 7567 6d65 6e74 6564  f.    `augmented
+000200f0: 5f66 6f72 7761 7264 5f70 6173 7360 2061  _forward_pass` a
+00020100: 6e64 2060 6261 636b 7761 7264 5f70 6173  nd `backward_pas
+00020110: 7360 2e20 5468 6520 6d61 696e 2064 6966  s`. The main dif
+00020120: 6665 7265 6e63 6520 6973 2074 6861 740a  ference is that.
+00020130: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
+00020140: 6e20 646f 6573 206e 6f74 2072 6571 7569  n does not requi
+00020150: 7265 2074 6865 2075 7365 7220 746f 2070  re the user to p
+00020160: 726f 7669 6465 206e 6577 2069 6e70 7574  rovide new input
+00020170: 7320 666f 7220 7468 650a 2020 2020 7472  s for the.    tr
+00020180: 6163 6520 6576 616c 7561 7469 6f6e 2e20  ace evaluation. 
+00020190: 496e 7374 6561 6420 6974 2075 7365 7320  Instead it uses 
+000201a0: 7468 6520 696e 7075 7473 2074 6861 7420  the inputs that 
+000201b0: 7765 7265 2075 7365 6420 746f 2063 6f6e  were used to con
+000201c0: 7374 7275 6374 0a20 2020 2074 6865 2074  struct.    the t
+000201d0: 7261 6365 2e0a 0a20 2020 2041 7267 733a  race...    Args:
+000201e0: 0a20 2020 2020 2020 2074 7261 6365 2028  .        trace (
+000201f0: 5472 6163 6529 3a20 5472 6163 6520 746f  Trace): Trace to
+00020200: 2067 656e 6572 6174 6520 7468 6520 666f   generate the fo
+00020210: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
+00020220: 7264 2070 6173 7365 7320 6672 6f6d 2e0a  rd passes from..
+00020230: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00020240: 2020 2020 2020 466f 7277 6172 6442 6163        ForwardBac
+00020250: 6b77 6172 6454 7261 6365 733a 2041 206e  kwardTraces: A n
+00020260: 616d 6564 2074 7570 6c65 2063 6f6e 7461  amed tuple conta
+00020270: 696e 696e 6720 7468 6520 666f 7277 6172  ining the forwar
+00020280: 6420 616e 6420 6261 636b 7761 7264 0a20  d and backward. 
+00020290: 2020 2020 2020 2020 2020 2074 7261 6365             trace
+000202a0: 732e 0a0a 2020 2020 4578 616d 706c 653a  s...    Example:
+000202b0: 0a20 2020 2020 2020 203e 3e3e 2069 6d70  .        >>> imp
+000202c0: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
+000202d0: 2020 3e3e 3e20 6672 6f6d 2074 6875 6e64    >>> from thund
+000202e0: 6572 2069 6d70 6f72 7420 636f 6d70 696c  er import compil
+000202f0: 652c 206c 6173 745f 7472 6163 6573 0a20  e, last_traces. 
+00020300: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
+00020310: 7468 756e 6465 722e 636f 7265 2e74 7261  thunder.core.tra
+00020320: 6e73 666f 726d 7320 696d 706f 7274 2066  nsforms import f
+00020330: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
+00020340: 6172 645f 6672 6f6d 5f74 7261 6365 0a20  ard_from_trace. 
+00020350: 2020 2020 2020 203e 3e3e 2064 6566 2066         >>> def f
+00020360: 2878 293a 0a20 2020 2020 2020 202e 2e2e  (x):.        ...
+00020370: 2020 2020 2072 6574 7572 6e20 746f 7263       return torc
+00020380: 682e 7369 6e28 7829 0a20 2020 2020 2020  h.sin(x).       
+00020390: 203e 3e3e 2078 203d 2074 6f72 6368 2e74   >>> x = torch.t
+000203a0: 656e 736f 7228 332e 3029 0a20 2020 2020  ensor(3.0).     
+000203b0: 2020 203e 3e3e 2063 6620 3d20 636f 6d70     >>> cf = comp
+000203c0: 696c 6528 6629 0a20 2020 2020 2020 203e  ile(f).        >
+000203d0: 3e3e 206f 7574 203d 2063 6628 7829 0a20  >> out = cf(x). 
+000203e0: 2020 2020 2020 203e 3e3e 2074 7261 6365         >>> trace
+000203f0: 203d 206c 6173 745f 7472 6163 6573 2863   = last_traces(c
+00020400: 6629 5b30 5d0a 2020 2020 2020 2020 3e3e  f)[0].        >>
+00020410: 3e20 666f 7277 6172 645f 616e 645f 6261  > forward_and_ba
+00020420: 636b 7761 7264 5f66 726f 6d5f 7472 6163  ckward_from_trac
+00020430: 6528 7472 6163 6529 0a20 2020 2020 2020  e(trace).       
+00020440: 202e 2e2e 2046 6f72 7761 7264 4261 636b   ... ForwardBack
+00020450: 7761 7264 5472 6163 6573 280a 2020 2020  wardTraces(.    
+00020460: 2020 2020 2e2e 2e20 666f 7277 6172 645f      ... forward_
+00020470: 7472 6163 653d 2320 696d 706f 7274 2074  trace=# import t
+00020480: 6875 6e64 6572 2061 7320 7468 756e 6465  hunder as thunde
+00020490: 720a 2020 2020 2020 2020 2e2e 2e20 2320  r.        ... # 
+000204a0: 696d 706f 7274 2074 6875 6e64 6572 2e63  import thunder.c
+000204b0: 6f72 652e 7072 696d 7320 6173 2070 7269  ore.prims as pri
+000204c0: 6d73 0a20 2020 2020 2020 202e 2e2e 2069  ms.        ... i
+000204d0: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
+000204e0: 2020 2020 2e2e 2e0a 2020 2020 2020 2020      ....        
+000204f0: 2e2e 2e20 4074 6f72 6368 2e6e 6f5f 6772  ... @torch.no_gr
+00020500: 6164 2829 0a20 2020 2020 2020 202e 2e2e  ad().        ...
+00020510: 2064 6566 2061 7567 6d65 6e74 6564 5f66   def augmented_f
+00020520: 6f72 7761 7264 5f66 6e28 2a61 7267 7329  orward_fn(*args)
+00020530: 3a0a 2020 2020 2020 2020 2e2e 2e20 2020  :.        ...   
+00020540: 2320 6172 6773 3a20 2243 6f6c 6c65 6374  # args: "Collect
+00020550: 696f 6e22 203d 2020 2874 302c 2920 2028  ion" =  (t0,)  (
+00020560: 7472 6976 6961 6c20 756e 7061 636b 290a  trivial unpack).
+00020570: 2020 2020 2020 2020 2e2e 2e20 2020 7430          ...   t0
+00020580: 2c20 5c0a 2020 2020 2020 2020 2e2e 2e20  , \.        ... 
+00020590: 2020 3d20 6172 6773 0a20 2020 2020 2020    = args.       
+000205a0: 202e 2e2e 2020 2074 3120 3d20 7072 696d   ...   t1 = prim
+000205b0: 732e 7369 6e28 7430 2920 2023 2074 313a  s.sin(t0)  # t1:
+000205c0: 2022 6370 7520 6633 325b 5d22 0a20 2020   "cpu f32[]".   
+000205d0: 2020 2020 202e 2e2e 2020 2072 6574 7572       ...   retur
+000205e0: 6e20 7431 2c20 2874 302c 292c 0a20 2020  n t1, (t0,),.   
+000205f0: 2020 2020 202e 2e2e 2062 6163 6b77 6172       ... backwar
+00020600: 645f 7472 6163 653d 2320 696d 706f 7274  d_trace=# import
+00020610: 2074 6875 6e64 6572 2061 7320 7468 756e   thunder as thun
+00020620: 6465 720a 2020 2020 2020 2020 2e2e 2e20  der.        ... 
+00020630: 2320 696d 706f 7274 2074 6875 6e64 6572  # import thunder
+00020640: 2e63 6f72 652e 7072 696d 7320 6173 2070  .core.prims as p
+00020650: 7269 6d73 0a20 2020 2020 2020 202e 2e2e  rims.        ...
+00020660: 2069 6d70 6f72 7420 746f 7263 680a 2020   import torch.  
+00020670: 2020 2020 2020 2e2e 2e0a 2020 2020 2020        ....      
+00020680: 2020 2e2e 2e20 4074 6f72 6368 2e6e 6f5f    ... @torch.no_
+00020690: 6772 6164 2829 0a20 2020 2020 2020 202e  grad().        .
+000206a0: 2e2e 2064 6566 2062 6163 6b77 6172 645f  .. def backward_
+000206b0: 666e 2873 6176 6564 5f66 6f72 5f62 6163  fn(saved_for_bac
+000206c0: 6b77 6172 642c 2063 6f74 616e 6765 6e74  kward, cotangent
+000206d0: 7329 3a0a 2020 2020 2020 2020 2e2e 2e20  s):.        ... 
+000206e0: 2020 2320 7361 7665 645f 666f 725f 6261    # saved_for_ba
+000206f0: 636b 7761 7264 3a20 2243 6f6c 6c65 6374  ckward: "Collect
+00020700: 696f 6e22 203d 2020 2874 302c 2920 2028  ion" =  (t0,)  (
+00020710: 7472 6976 6961 6c20 756e 7061 636b 290a  trivial unpack).
+00020720: 2020 2020 2020 2020 2e2e 2e20 2020 2320          ...   # 
+00020730: 636f 7461 6e67 656e 7473 3a20 2263 7075  cotangents: "cpu
+00020740: 2066 3332 5b5d 2220 3d20 2063 6f74 616e   f32[]" =  cotan
+00020750: 6765 6e74 7320 2028 7472 6976 6961 6c20  gents  (trivial 
+00020760: 756e 7061 636b 290a 2020 2020 2020 2020  unpack).        
+00020770: 2e2e 2e20 2020 7430 2c20 5c0a 2020 2020  ...   t0, \.    
+00020780: 2020 2020 2e2e 2e20 2020 3d20 7361 7665      ...   = save
+00020790: 645f 666f 725f 6261 636b 7761 7264 0a20  d_for_backward. 
+000207a0: 2020 2020 2020 202e 2e2e 2020 2074 3120         ...   t1 
+000207b0: 3d20 7072 696d 732e 636f 7328 7430 2920  = prims.cos(t0) 
+000207c0: 2023 2074 313a 2022 6370 7520 6633 325b   # t1: "cpu f32[
+000207d0: 5d22 0a20 2020 2020 2020 202e 2e2e 2020  ]".        ...  
+000207e0: 2074 3220 3d20 7072 696d 732e 6d75 6c28   t2 = prims.mul(
+000207f0: 636f 7461 6e67 656e 7473 2c20 7431 2920  cotangents, t1) 
+00020800: 2023 2074 323a 2022 6370 7520 6633 325b   # t2: "cpu f32[
+00020810: 5d22 0a20 2020 2020 2020 202e 2e2e 2020  ]".        ...  
+00020820: 2072 6574 7572 6e20 2874 322c 2929 0a20   return (t2,)). 
+00020830: 2020 2022 2222 0a0a 2020 2020 6f75 7470     """..    outp
+00020840: 7574 5f73 7065 6320 3d20 4e6f 6e65 0a0a  ut_spec = None..
+00020850: 2020 2020 6465 6620 6175 676d 656e 7465      def augmente
+00020860: 645f 666f 7277 6172 645f 666e 282a 6172  d_forward_fn(*ar
+00020870: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00020880: 2020 2020 2020 2072 6573 756c 742c 2065         result, e
+00020890: 6e76 203d 2061 7567 6d65 6e74 6564 5f66  nv = augmented_f
+000208a0: 6f72 7761 7264 5f70 6173 7328 2a61 7267  orward_pass(*arg
+000208b0: 732c 2074 7261 6365 3d74 7261 6365 2c20  s, trace=trace, 
+000208c0: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+000208d0: 2020 7361 7665 645f 666f 725f 6261 636b    saved_for_back
+000208e0: 7761 7264 203d 2064 6563 6f6e 7374 7275  ward = deconstru
+000208f0: 6374 5f66 6f72 7761 7264 5f65 6e76 5f66  ct_forward_env_f
+00020900: 6f72 5f62 6163 6b77 6172 6428 7472 6163  or_backward(trac
+00020910: 652c 2065 6e76 290a 2020 2020 2020 2020  e, env).        
+00020920: 6966 2074 6f72 6368 5f61 7574 6f67 7261  if torch_autogra
+00020930: 643a 0a20 2020 2020 2020 2020 2020 206e  d:.            n
+00020940: 6f6e 6c6f 6361 6c20 6f75 7470 7574 5f73  onlocal output_s
+00020950: 7065 630a 2020 2020 2020 2020 2020 2020  pec.            
+00020960: 666c 6174 5f61 7267 732c 205f 203d 2074  flat_args, _ = t
+00020970: 7265 655f 666c 6174 7465 6e28 2861 7267  ree_flatten((arg
+00020980: 732c 206b 7761 7267 7329 290a 2020 2020  s, kwargs)).    
+00020990: 2020 2020 2020 2020 666c 6174 5f6f 7574          flat_out
+000209a0: 7075 742c 206f 7574 7075 745f 7370 6563  put, output_spec
+000209b0: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+000209c0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
+000209d0: 2020 2020 666c 6174 5f6f 7574 7075 7420      flat_output 
+000209e0: 3d20 7475 706c 6528 666c 6174 5f6f 7574  = tuple(flat_out
+000209f0: 7075 7429 0a20 2020 2020 2020 2020 2020  put).           
+00020a00: 2023 2053 6565 204e 6f74 6520 5b47 7261   # See Note [Gra
+00020a10: 6420 666f 7277 6172 6420 6f75 7470 7574  d forward output
+00020a20: 2073 7065 635d 0a20 2020 2020 2020 2020   spec].         
+00020a30: 2020 2066 6f72 5f61 7574 6f67 7261 6420     for_autograd 
+00020a40: 3d20 546f 7263 6841 7574 6f67 7261 6446  = TorchAutogradF
+00020a50: 6f72 7761 7264 4461 7461 280a 2020 2020  orwardData(.    
+00020a60: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00020a70: 6c74 2c0a 2020 2020 2020 2020 2020 2020  lt,.            
+00020a80: 2020 2020 666c 6174 5f61 7267 732c 0a20      flat_args,. 
+00020a90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020aa0: 6c61 745f 6f75 7470 7574 2c0a 2020 2020  lat_output,.    
+00020ab0: 2020 2020 2020 2020 292e 5f61 7364 6963          )._asdic
+00020ac0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00020ad0: 7265 7475 726e 2028 666f 725f 6175 746f  return (for_auto
+00020ae0: 6772 6164 2c20 7361 7665 645f 666f 725f  grad, saved_for_
+00020af0: 6261 636b 7761 7264 290a 2020 2020 2020  backward).      
+00020b00: 2020 7265 7475 726e 2072 6573 756c 742c    return result,
+00020b10: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+00020b20: 6172 640a 0a20 2020 2023 2043 6f70 7920  ard..    # Copy 
+00020b30: 7468 6520 7369 676e 6174 7572 6520 6f66  the signature of
+00020b40: 2074 6865 206f 7269 6769 6e61 6c20 6675   the original fu
+00020b50: 6e63 7469 6f6e 2073 6f20 7468 6174 2074  nction so that t
+00020b60: 6865 2061 7267 756d 656e 7473 2061 7265  he arguments are
+00020b70: 0a20 2020 2023 206e 616d 6564 2063 6f72  .    # named cor
+00020b80: 7265 6374 6c79 2069 6e20 7468 6520 6175  rectly in the au
+00020b90: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
+00020ba0: 7061 7373 2069 6e73 7465 6164 206f 6620  pass instead of 
+00020bb0: 6265 696e 6720 6e61 6d65 640a 2020 2020  being named.    
+00020bc0: 2320 2261 7267 7322 2061 6e64 2022 6b77  # "args" and "kw
+00020bd0: 6172 6773 222e 0a20 2020 2061 7567 6d65  args"..    augme
+00020be0: 6e74 6564 5f66 6f72 7761 7264 5f66 6e2e  nted_forward_fn.
+00020bf0: 5f5f 7369 676e 6174 7572 655f 5f20 3d20  __signature__ = 
+00020c00: 696e 7370 6563 742e 7369 676e 6174 7572  inspect.signatur
+00020c10: 6528 7472 6163 652e 666e 206f 7220 7472  e(trace.fn or tr
+00020c20: 6163 652e 7079 7468 6f6e 5f63 616c 6c61  ace.python_calla
+00020c30: 626c 6528 2929 0a0a 2020 2020 6465 6620  ble())..    def 
+00020c40: 6f6e 6573 5f6c 696b 6528 7829 3a0a 2020  ones_like(x):.  
+00020c50: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00020c60: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
+00020c70: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
+00020c80: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
+00020c90: 6528 782c 2066 696c 6c5f 7661 6c75 653d  e(x, fill_value=
+00020ca0: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
+00020cb0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
+00020cc0: 6d62 6572 5072 6f78 7929 3a0a 2020 2020  mberProxy):.    
+00020cd0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+00020ce0: 7970 6528 782e 7661 6c75 6529 2831 290a  ype(x.value)(1).
+00020cf0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00020d00: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00020d10: 204e 6f6e 650a 0a20 2020 2066 6f72 7761   None..    forwa
+00020d20: 7264 5f74 7261 6365 203d 2063 6f6e 7374  rd_trace = const
+00020d30: 7275 6374 5f74 7261 6365 2829 2861 7567  ruct_trace()(aug
+00020d40: 6d65 6e74 6564 5f66 6f72 7761 7264 5f66  mented_forward_f
+00020d50: 6e2c 202a 7472 6163 652e 6172 6773 2c20  n, *trace.args, 
+00020d60: 2a2a 7472 6163 652e 6b77 6172 6773 290a  **trace.kwargs).
+00020d70: 2020 2020 2320 5765 2073 6574 2066 6f72      # We set for
+00020d80: 7761 7264 2074 7261 6365 2074 6f20 636f  ward trace to co
+00020d90: 6e73 7472 7563 7420 7072 6f78 6965 7320  nstruct proxies 
+00020da0: 6265 6361 7573 6520 7765 206e 6565 6420  because we need 
+00020db0: 7468 6573 6520 7072 6f78 6965 7320 746f  these proxies to
+00020dc0: 0a20 2020 2023 2068 6176 6520 6469 6666  .    # have diff
+00020dd0: 6572 656e 7420 6e61 6d65 7320 7468 616e  erent names than
+00020de0: 2074 6865 206f 6e65 7320 696e 2074 6865   the ones in the
+00020df0: 2066 6f72 7761 7264 2074 7261 6365 2e0a   forward trace..
+00020e00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00020e10: 2074 7261 6365 6374 785f 746f 6b65 6e20   tracectx_token 
+00020e20: 3d20 7365 745f 7472 6163 6563 7478 2866  = set_tracectx(f
+00020e30: 6f72 7761 7264 5f74 7261 6365 290a 2020  orward_trace).  
+00020e40: 2020 2020 2020 2320 5765 2064 6f6e 2774        # We don't
+00020e50: 2077 616e 7420 746f 2072 6563 6f72 6420   want to record 
+00020e60: 7468 6f73 6520 6f6e 6573 5f6c 696b 6520  those ones_like 
+00020e70: 6361 6c6c 7320 696e 2074 6865 2066 6f72  calls in the for
+00020e80: 7761 7264 2074 7261 6365 2e0a 2020 2020  ward trace..    
+00020e90: 2020 2020 7769 7468 2064 6574 6163 6865      with detache
+00020ea0: 645f 7472 6163 6528 293a 0a20 2020 2020  d_trace():.     
+00020eb0: 2020 2020 2020 2069 6620 746f 7263 685f         if torch_
+00020ec0: 6175 746f 6772 6164 3a0a 2020 2020 2020  autograd:.      
+00020ed0: 2020 2020 2020 2020 2020 2320 4974 2773            # It's
+00020ee0: 2061 7373 756d 6564 2074 6861 7420 666f   assumed that fo
+00020ef0: 7277 6172 645f 7472 6163 652e 6f75 7470  rward_trace.outp
+00020f00: 7574 5b30 5d20 6973 2061 2064 6963 7420  ut[0] is a dict 
+00020f10: 6672 6f6d 2054 6f72 6368 4175 746f 6772  from TorchAutogr
+00020f20: 6164 466f 7277 6172 6444 6174 610a 2020  adForwardData.  
+00020f30: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+00020f40: 6174 5f6f 7574 7075 7420 3d20 666f 7277  at_output = forw
+00020f50: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
+00020f60: 5b30 5d5b 2266 6c61 745f 6f75 7470 7574  [0]["flat_output
+00020f70: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00020f80: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
+00020f90: 7574 696c 732e 7365 7175 656e 6369 6679  utils.sequencify
+00020fa0: 2874 7265 655f 6d61 7028 6c61 6d62 6461  (tree_map(lambda
+00020fb0: 2076 3a20 6f6e 6573 5f6c 696b 6528 7629   v: ones_like(v)
+00020fc0: 2c20 666c 6174 5f6f 7574 7075 7429 290a  , flat_output)).
+00020fd0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00020fe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020ff0: 2020 636f 7461 6e67 656e 7473 203d 2075    cotangents = u
+00021000: 7469 6c73 2e73 6571 7565 6e63 6966 7928  tils.sequencify(
+00021010: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+00021020: 763a 206f 6e65 735f 6c69 6b65 2876 292c  v: ones_like(v),
+00021030: 2074 7261 6365 2e6f 7574 7075 7429 290a   trace.output)).
+00021040: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+00021050: 2020 2020 2072 6573 6574 5f74 7261 6365       reset_trace
+00021060: 6374 7828 7472 6163 6563 7478 5f74 6f6b  ctx(tracectx_tok
+00021070: 656e 290a 0a20 2020 2064 6566 2062 6163  en)..    def bac
+00021080: 6b77 6172 645f 666e 2873 6176 6564 5f66  kward_fn(saved_f
+00021090: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
+000210a0: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
+000210b0: 2020 656e 7620 3d20 7265 636f 6e73 7472    env = reconstr
+000210c0: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
+000210d0: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
+000210e0: 6365 2c20 7361 7665 645f 666f 725f 6261  ce, saved_for_ba
+000210f0: 636b 7761 7264 290a 2020 2020 2020 2020  ckward).        
+00021100: 6966 2074 6f72 6368 5f61 7574 6f67 7261  if torch_autogra
+00021110: 643a 0a20 2020 2020 2020 2020 2020 2063  d:.            c
+00021120: 6f74 616e 6765 6e74 7320 3d20 7472 6565  otangents = tree
+00021130: 5f75 6e66 6c61 7474 656e 2863 6f74 616e  _unflatten(cotan
+00021140: 6765 6e74 732c 206f 7574 7075 745f 7370  gents, output_sp
+00021150: 6563 290a 2020 2020 2020 2020 6f75 7420  ec).        out 
+00021160: 3d20 6261 636b 7761 7264 5f70 6173 7328  = backward_pass(
+00021170: 656e 762c 2074 7261 6365 2c20 636f 7461  env, trace, cota
+00021180: 6e67 656e 7473 290a 2020 2020 2020 2020  ngents).        
+00021190: 6966 2074 6f72 6368 5f61 7574 6f67 7261  if torch_autogra
+000211a0: 643a 0a20 2020 2020 2020 2020 2020 2067  d:.            g
+000211b0: 6b77 6172 6773 203d 206f 7574 5b2d 315d  kwargs = out[-1]
+000211c0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+000211d0: 7574 5b2d 315d 2c20 6469 6374 2920 656c  ut[-1], dict) el
+000211e0: 7365 207b 7d0a 2020 2020 2020 2020 2020  se {}.          
+000211f0: 2020 6761 7267 7320 3d20 6f75 745b 3a2d    gargs = out[:-
+00021200: 315d 2069 6620 6973 696e 7374 616e 6365  1] if isinstance
+00021210: 286f 7574 5b2d 315d 2c20 6469 6374 2920  (out[-1], dict) 
+00021220: 656c 7365 206f 7574 0a20 2020 2020 2020  else out.       
+00021230: 2020 2020 2067 6b77 6172 6773 203d 207b       gkwargs = {
+00021240: 6b3a 2067 6b77 6172 6773 2e67 6574 286b  k: gkwargs.get(k
+00021250: 2c20 4e6f 6e65 2920 666f 7220 6b20 696e  , None) for k in
+00021260: 2074 7261 6365 2e6b 7761 7267 737d 0a20   trace.kwargs}. 
+00021270: 2020 2020 2020 2020 2020 206f 7574 203d             out =
+00021280: 2028 2a67 6172 6773 2c20 676b 7761 7267   (*gargs, gkwarg
+00021290: 7329 0a20 2020 2020 2020 2020 2020 206f  s).            o
+000212a0: 7574 203d 2074 7265 655f 666c 6174 7465  ut = tree_flatte
+000212b0: 6e28 6f75 7429 5b30 5d0a 2020 2020 2020  n(out)[0].      
+000212c0: 2020 7265 7475 726e 206f 7574 0a0a 2020    return out..  
+000212d0: 2020 7361 7665 645f 666f 725f 6261 636b    saved_for_back
+000212e0: 7761 7264 203d 2066 6f72 7761 7264 5f74  ward = forward_t
+000212f0: 7261 6365 2e6f 7574 7075 745b 315d 0a20  race.output[1]. 
+00021300: 2020 2062 6163 6b77 6172 645f 7472 6163     backward_trac
+00021310: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
+00021320: 6163 6528 7265 6e61 6d65 5f70 726f 7869  ace(rename_proxi
+00021330: 6573 3d46 616c 7365 2928 6261 636b 7761  es=False)(backwa
+00021340: 7264 5f66 6e2c 2073 6176 6564 5f66 6f72  rd_fn, saved_for
+00021350: 5f62 6163 6b77 6172 642c 2063 6f74 616e  _backward, cotan
+00021360: 6765 6e74 7329 0a0a 2020 2020 2320 5765  gents)..    # We
+00021370: 2061 7265 2064 6f6e 6520 7769 7468 2063   are done with c
+00021380: 6f6e 7374 7275 6374 696e 6720 7468 6520  onstructing the 
+00021390: 666f 7277 6172 6420 616e 6420 6261 636b  forward and back
+000213a0: 7761 7264 2070 6173 7365 7320 6174 2074  ward passes at t
+000213b0: 6869 730a 2020 2020 2320 7374 6167 652e  his.    # stage.
+000213c0: 2054 6865 2066 6f6c 6c6f 7769 6e67 2069   The following i
+000213d0: 7320 6e6f 7420 7374 7269 6374 6c79 206e  s not strictly n
+000213e0: 6563 6573 7361 7279 2c20 6275 7420 6974  ecessary, but it
+000213f0: 2773 2067 6f6f 6420 746f 2066 696c 7465  's good to filte
+00021400: 720a 2020 2020 2320 6f75 7420 7468 6520  r.    # out the 
+00021410: 756e 7573 6564 2065 6c65 6d65 6e74 7320  unused elements 
+00021420: 6f66 2074 6865 2073 6176 6564 5f66 6f72  of the saved_for
+00021430: 5f62 6163 6b77 6172 6420 616e 6420 666c  _backward and fl
+00021440: 6174 7465 6e20 6974 2066 6f72 206d 6f72  atten it for mor
+00021450: 650a 2020 2020 2320 636f 6d70 6163 7420  e.    # compact 
+00021460: 6261 636b 7761 7264 2074 7261 6365 2e0a  backward trace..
+00021470: 0a20 2020 2023 204e 6f77 2077 6520 6361  .    # Now we ca
+00021480: 6e20 6465 7465 726d 696e 6520 6578 6163  n determine exac
+00021490: 746c 7920 7768 6174 2773 2075 7365 6420  tly what's used 
+000214a0: 696e 2074 6865 2062 6163 6b77 6172 6420  in the backward 
+000214b0: 7061 7373 2066 726f 6d20 7468 650a 2020  pass from the.  
+000214c0: 2020 2320 7361 7665 645f 666f 725f 6261    # saved_for_ba
+000214d0: 636b 7761 7264 2e20 5765 2063 616e 2066  ckward. We can f
+000214e0: 6c61 7474 656e 2061 6e64 2066 696c 7465  latten and filte
+000214f0: 7220 7468 6520 7361 7665 645f 666f 725f  r the saved_for_
+00021500: 6261 636b 7761 7264 0a20 2020 2063 6f6e  backward.    con
+00021510: 7375 6d65 7273 203d 2075 7469 6c73 2e63  sumers = utils.c
+00021520: 6f6e 7375 6d65 7273 2862 6163 6b77 6172  onsumers(backwar
+00021530: 645f 7472 6163 6529 0a0a 2020 2020 2320  d_trace)..    # 
+00021540: 466f 7277 6172 6427 7320 616e 6420 6261  Forward's and ba
+00021550: 636b 7761 7264 2773 2022 7361 7665 645f  ckward's "saved_
+00021560: 666f 725f 6261 636b 7761 7264 2220 6172  for_backward" ar
+00021570: 6520 6e6f 7420 6e65 6365 7373 6172 696c  e not necessaril
+00021580: 7920 7468 6520 7361 6d65 0a20 2020 2023  y the same.    #
+00021590: 2061 7320 7468 6520 7361 7665 645f 666f   as the saved_fo
+000215a0: 725f 6261 636b 7761 7264 2c20 6265 6361  r_backward, beca
+000215b0: 7573 6520 736f 6d65 206f 7220 616c 6c20  use some or all 
+000215c0: 656c 656d 656e 7473 206f 6620 7468 650a  elements of the.
+000215d0: 2020 2020 2320 7361 7665 645f 666f 725f      # saved_for_
+000215e0: 6261 636b 7761 7264 2072 6573 756c 7473  backward results
+000215f0: 206d 6967 6874 2062 6520 7265 2d70 726f   might be re-pro
+00021600: 7869 6669 6564 2e0a 2020 2020 6277 5f66  xified..    bw_f
+00021610: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
+00021620: 636b 7761 7264 2c20 7370 6563 203d 2074  ckward, spec = t
+00021630: 7265 655f 666c 6174 7465 6e28 6261 636b  ree_flatten(back
+00021640: 7761 7264 5f74 7261 6365 2e61 7267 735b  ward_trace.args[
+00021650: 305d 290a 2020 2020 6677 5f66 6c61 745f  0]).    fw_flat_
+00021660: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00021670: 7264 2c20 5f20 3d20 7472 6565 5f66 6c61  rd, _ = tree_fla
+00021680: 7474 656e 2866 6f72 7761 7264 5f74 7261  tten(forward_tra
+00021690: 6365 2e6f 7574 7075 745b 315d 290a 2020  ce.output[1]).  
+000216a0: 2020 7573 6564 5f6d 6173 6b20 3d20 6c69    used_mask = li
+000216b0: 7374 286c 656e 2863 6f6e 7375 6d65 7273  st(len(consumers
+000216c0: 2e67 6574 2878 2c20 2829 2929 203e 2030  .get(x, ())) > 0
+000216d0: 2066 6f72 2078 2069 6e20 6277 5f66 6c61   for x in bw_fla
+000216e0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
+000216f0: 7761 7264 290a 0a20 2020 2023 2044 6f6e  ward)..    # Don
+00021700: 2774 2075 7365 2074 6865 2073 616d 6520  't use the same 
+00021710: 7661 7269 6162 6c65 2074 7769 6365 2069  variable twice i
+00021720: 6e20 7468 6520 6261 636b 7761 7264 2070  n the backward p
+00021730: 6173 730a 2020 2020 7365 656e 203d 2073  ass.    seen = s
+00021740: 6574 2829 0a20 2020 2066 726f 6d20 7468  et().    from th
+00021750: 756e 6465 722e 636f 7265 2e70 726f 7869  under.core.proxi
+00021760: 6573 2069 6d70 6f72 7420 5661 7269 6162  es import Variab
+00021770: 6c65 0a0a 2020 2020 666f 7220 692c 2078  le..    for i, x
+00021780: 2069 6e20 656e 756d 6572 6174 6528 6677   in enumerate(fw
+00021790: 5f66 6c61 745f 7361 7665 645f 666f 725f  _flat_saved_for_
+000217a0: 6261 636b 7761 7264 293a 0a20 2020 2020  backward):.     
+000217b0: 2020 2078 203d 2076 6172 6961 626c 6569     x = variablei
+000217c0: 6679 2878 290a 2020 2020 2020 2020 6966  fy(x).        if
+000217d0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+000217e0: 782c 2056 6172 6961 626c 6529 3a0a 2020  x, Variable):.  
+000217f0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00021800: 7565 0a20 2020 2020 2020 2069 6620 7820  ue.        if x 
+00021810: 696e 2073 6565 6e3a 0a20 2020 2020 2020  in seen:.       
+00021820: 2020 2020 2075 7365 645f 6d61 736b 5b69       used_mask[i
+00021830: 5d20 3d20 4661 6c73 650a 2020 2020 2020  ] = False.      
+00021840: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00021850: 2020 2020 7365 656e 2e61 6464 2878 290a      seen.add(x).
+00021860: 0a20 2020 206f 6e6c 795f 7573 6564 5f66  .    only_used_f
+00021870: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
+00021880: 7761 7264 203d 2074 7570 6c65 2863 6f6d  ward = tuple(com
+00021890: 7072 6573 7328 6677 5f66 6c61 745f 7361  press(fw_flat_sa
+000218a0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+000218b0: 2c20 7573 6564 5f6d 6173 6b29 290a 2020  , used_mask)).  
+000218c0: 2020 6f6e 6c79 5f75 7365 645f 6277 5f73    only_used_bw_s
+000218d0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000218e0: 6420 3d20 7475 706c 6528 636f 6d70 7265  d = tuple(compre
+000218f0: 7373 2862 775f 666c 6174 5f73 6176 6564  ss(bw_flat_saved
+00021900: 5f66 6f72 5f62 6163 6b77 6172 642c 2075  _for_backward, u
+00021910: 7365 645f 6d61 736b 2929 0a0a 2020 2020  sed_mask))..    
+00021920: 2320 5765 206e 6565 6420 746f 2075 7064  # We need to upd
+00021930: 6174 6520 7468 6520 7472 6163 6573 2077  ate the traces w
+00021940: 6974 6820 7468 6520 6e65 7720 7361 7665  ith the new save
+00021950: 645f 666f 725f 6261 636b 7761 7264 0a20  d_for_backward. 
+00021960: 2020 205f 7570 6461 7465 5f66 6f72 7761     _update_forwa
+00021970: 7264 5f77 6974 685f 6e65 775f 7361 7665  rd_with_new_save
+00021980: 645f 666f 725f 6261 636b 7761 7264 2866  d_for_backward(f
+00021990: 6f72 7761 7264 5f74 7261 6365 2c20 6f6e  orward_trace, on
+000219a0: 6c79 5f75 7365 645f 6677 5f73 6176 6564  ly_used_fw_saved
+000219b0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
+000219c0: 2020 205f 7570 6461 7465 5f62 6163 6b77     _update_backw
+000219d0: 6172 645f 7769 7468 5f6e 6577 5f73 6176  ard_with_new_sav
+000219e0: 6564 5f66 6f72 5f62 6163 6b77 6172 6428  ed_for_backward(
+000219f0: 6261 636b 7761 7264 5f74 7261 6365 2c20  backward_trace, 
+00021a00: 6f6e 6c79 5f75 7365 645f 6277 5f73 6176  only_used_bw_sav
+00021a10: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+00021a20: 0a20 2020 2066 6f72 7761 7264 5f74 7261  .    forward_tra
+00021a30: 6365 2e73 6574 5f70 726f 7665 6e61 6e63  ce.set_provenanc
+00021a40: 6528 5472 6163 6550 726f 7665 6e61 6e63  e(TraceProvenanc
+00021a50: 6528 2241 7567 6d65 6e74 6564 2066 6f72  e("Augmented for
+00021a60: 7761 7264 2070 6173 7322 2929 0a20 2020  ward pass")).   
+00021a70: 2062 6163 6b77 6172 645f 7472 6163 652e   backward_trace.
+00021a80: 7365 745f 7072 6f76 656e 616e 6365 2854  set_provenance(T
+00021a90: 7261 6365 5072 6f76 656e 616e 6365 2822  raceProvenance("
+00021aa0: 4261 636b 7761 7264 2070 6173 7322 2929  Backward pass"))
+00021ab0: 0a20 2020 2072 6574 7572 6e20 466f 7277  .    return Forw
+00021ac0: 6172 6442 6163 6b77 6172 6454 7261 6365  ardBackwardTrace
+00021ad0: 7328 666f 7277 6172 645f 7472 6163 652c  s(forward_trace,
+00021ae0: 2062 6163 6b77 6172 645f 7472 6163 6529   backward_trace)
+00021af0: 0a0a 0a23 2064 6f20 7765 2068 6170 7065  ...# do we happe
+00021b00: 6e20 746f 2077 616e 7420 746f 2072 6567  n to want to reg
+00021b10: 6973 7465 7220 606c 746f 7263 6860 206f  ister `ltorch` o
+00021b20: 7073 2073 7563 6820 6173 2060 6c74 6f72  ps such as `ltor
+00021b30: 6368 2e6c 6179 6572 5f6e 6f72 6d60 2061  ch.layer_norm` a
+00021b40: 7320 7765 6c6c 3f0a 6175 746f 6361 7374  s well?.autocast
+00021b50: 5f69 6d70 6c73 3a20 6469 6374 5b70 7269  _impls: dict[pri
+00021b60: 6d73 2e50 7269 6d49 4473 2c20 4361 6c6c  ms.PrimIDs, Call
+00021b70: 6162 6c65 5d20 3d20 7b7d 0a0a 0a64 6566  able] = {}...def
+00021b80: 2072 6567 6973 7465 725f 6175 746f 6361   register_autoca
+00021b90: 7374 5f72 756c 6528 6f70 293a 0a20 2020  st_rule(op):.   
+00021ba0: 2064 6566 2064 6563 6f72 6174 6f72 2866   def decorator(f
+00021bb0: 756e 6329 3a0a 2020 2020 2020 2020 6175  unc):.        au
+00021bc0: 746f 6361 7374 5f69 6d70 6c73 5b6f 705d  tocast_impls[op]
+00021bd0: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
+00021be0: 7265 7475 726e 2066 756e 630a 0a20 2020  return func..   
+00021bf0: 2072 6574 7572 6e20 6465 636f 7261 746f   return decorato
+00021c00: 720a 0a0a 6465 6620 6d61 7962 655f 646f  r...def maybe_do
+00021c10: 776e 6361 7374 5f74 6f28 6474 7970 652c  wncast_to(dtype,
+00021c20: 2061 7267 7329 3a0a 2020 2020 616c 6c6f   args):.    allo
+00021c30: 7765 645f 646f 776e 6361 7374 5f74 7970  wed_downcast_typ
+00021c40: 6573 203d 2028 6474 7970 6573 2e66 6c6f  es = (dtypes.flo
+00021c50: 6174 3136 2c20 6474 7970 6573 2e62 666c  at16, dtypes.bfl
+00021c60: 6f61 7431 362c 2064 7479 7065 732e 666c  oat16, dtypes.fl
+00021c70: 6f61 7433 3229 0a0a 2020 2020 6465 6620  oat32)..    def 
+00021c80: 6d61 705f 666e 2861 293a 0a20 2020 2020  map_fn(a):.     
+00021c90: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00021ca0: 2861 2c20 5465 6e73 6f72 5072 6f78 7929  (a, TensorProxy)
+00021cb0: 2061 6e64 2061 2e64 7479 7065 2069 6e20   and a.dtype in 
+00021cc0: 616c 6c6f 7765 645f 646f 776e 6361 7374  allowed_downcast
+00021cd0: 5f74 7970 6573 3a0a 2020 2020 2020 2020  _types:.        
+00021ce0: 2020 2020 7265 7475 726e 206d 6179 6265      return maybe
+00021cf0: 5f63 6f6e 7665 7274 5f74 6f5f 6474 7970  _convert_to_dtyp
+00021d00: 6528 612c 2064 7479 7065 290a 2020 2020  e(a, dtype).    
+00021d10: 2020 2020 7265 7475 726e 2061 0a0a 2020      return a..  
+00021d20: 2020 7265 7475 726e 2074 7265 655f 6d61    return tree_ma
+00021d30: 7028 6d61 705f 666e 2c20 6172 6773 290a  p(map_fn, args).
+00021d40: 0a0a 4072 6567 6973 7465 725f 6175 746f  ..@register_auto
+00021d50: 6361 7374 5f72 756c 6528 2274 6f72 6368  cast_rule("torch
+00021d60: 2e6d 6174 6d75 6c22 290a 4072 6567 6973  .matmul").@regis
+00021d70: 7465 725f 6175 746f 6361 7374 5f72 756c  ter_autocast_rul
+00021d80: 6528 7072 696d 732e 5072 696d 4944 732e  e(prims.PrimIDs.
+00021d90: 4d41 544d 554c 290a 6465 6620 6175 746f  MATMUL).def auto
+00021da0: 6361 7374 5f6d 6174 6d75 6c5f 7275 6c65  cast_matmul_rule
+00021db0: 2861 2c20 622c 2064 7479 7065 293a 0a20  (a, b, dtype):. 
+00021dc0: 2020 2022 2222 4175 746f 6361 7374 2072     """Autocast r
+00021dd0: 756c 6520 666f 7220 6d61 746d 756c 2222  ule for matmul""
+00021de0: 220a 2020 2020 7265 7475 726e 2070 7269  ".    return pri
+00021df0: 6d73 2e6d 6174 6d75 6c28 2a28 6d61 7962  ms.matmul(*(mayb
+00021e00: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
+00021e10: 7970 652c 2028 612c 2062 2929 2929 0a0a  ype, (a, b))))..
+00021e20: 0a40 7265 6769 7374 6572 5f61 7574 6f63  .@register_autoc
+00021e30: 6173 745f 7275 6c65 2822 746f 7263 682e  ast_rule("torch.
+00021e40: 6e6e 2e66 756e 6374 696f 6e61 6c2e 6c69  nn.functional.li
+00021e50: 6e65 6172 2229 0a40 7265 6769 7374 6572  near").@register
+00021e60: 5f61 7574 6f63 6173 745f 7275 6c65 2870  _autocast_rule(p
+00021e70: 7269 6d73 2e50 7269 6d49 4473 2e4c 494e  rims.PrimIDs.LIN
+00021e80: 4541 5229 0a64 6566 2061 7574 6f63 6173  EAR).def autocas
+00021e90: 745f 6c69 6e65 6172 5f72 756c 6528 612c  t_linear_rule(a,
+00021ea0: 2077 2c20 6269 6173 2c20 6474 7970 6529   w, bias, dtype)
+00021eb0: 3a0a 2020 2020 6966 2062 6961 7320 6973  :.    if bias is
+00021ec0: 204e 6f6e 653a 0a20 2020 2020 2020 2023   None:.        #
+00021ed0: 2044 6f6e 2774 2070 6173 7320 6062 6961   Don't pass `bia
+00021ee0: 7360 2074 6f20 6d61 7962 655f 646f 776e  s` to maybe_down
+00021ef0: 6361 7374 5f74 6f2e 0a20 2020 2020 2020  cast_to..       
+00021f00: 2064 6f77 6e63 6173 745f 6172 6773 203d   downcast_args =
+00021f10: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
+00021f20: 746f 2864 7479 7065 2c20 2861 2c20 7729  to(dtype, (a, w)
+00021f30: 2920 2b20 2862 6961 732c 290a 2020 2020  ) + (bias,).    
+00021f40: 656c 7365 3a0a 2020 2020 2020 2020 646f  else:.        do
+00021f50: 776e 6361 7374 5f61 7267 7320 3d20 6d61  wncast_args = ma
+00021f60: 7962 655f 646f 776e 6361 7374 5f74 6f28  ybe_downcast_to(
+00021f70: 6474 7970 652c 2028 612c 2077 2c20 6269  dtype, (a, w, bi
+00021f80: 6173 2929 0a0a 2020 2020 7265 7475 726e  as))..    return
+00021f90: 2070 7269 6d73 2e6c 696e 6561 7228 2a64   prims.linear(*d
+00021fa0: 6f77 6e63 6173 745f 6172 6773 290a 0a0a  owncast_args)...
+00021fb0: 4072 6567 6973 7465 725f 6175 746f 6361  @register_autoca
+00021fc0: 7374 5f72 756c 6528 2274 6f72 6368 2e6e  st_rule("torch.n
+00021fd0: 6e2e 6675 6e63 7469 6f6e 616c 2e73 6361  n.functional.sca
+00021fe0: 6c65 645f 646f 745f 7072 6f64 7563 745f  led_dot_product_
+00021ff0: 6174 7465 6e74 696f 6e22 290a 6465 6620  attention").def 
+00022000: 6175 746f 6361 7374 5f73 6361 6c65 645f  autocast_scaled_
+00022010: 646f 745f 7072 6f64 7563 745f 6174 7465  dot_product_atte
+00022020: 6e74 696f 6e28 0a20 2020 2071 7565 7279  ntion(.    query
+00022030: 2c0a 2020 2020 6b65 792c 0a20 2020 2076  ,.    key,.    v
+00022040: 616c 7565 2c0a 2020 2020 6174 746e 5f6d  alue,.    attn_m
+00022050: 6173 6b2c 0a20 2020 2064 726f 706f 7574  ask,.    dropout
+00022060: 5f70 2c0a 2020 2020 6973 5f63 6175 7361  _p,.    is_causa
+00022070: 6c2c 0a20 2020 202a 2c0a 2020 2020 6474  l,.    *,.    dt
+00022080: 7970 652c 0a20 2020 2073 6361 6c65 2c0a  ype,.    scale,.
+00022090: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
+000220a0: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
+000220b0: 2073 6361 6c65 645f 646f 745f 7072 6f64   scaled_dot_prod
+000220c0: 7563 745f 6174 7465 6e74 696f 6e0a 0a20  uct_attention.. 
+000220d0: 2020 2071 2c20 6b2c 2076 203d 206d 6179     q, k, v = may
+000220e0: 6265 5f64 6f77 6e63 6173 745f 746f 2864  be_downcast_to(d
+000220f0: 7479 7065 2c20 2871 7565 7279 2c20 6b65  type, (query, ke
+00022100: 792c 2076 616c 7565 2929 0a20 2020 2072  y, value)).    r
+00022110: 6574 7572 6e20 7363 616c 6564 5f64 6f74  eturn scaled_dot
+00022120: 5f70 726f 6475 6374 5f61 7474 656e 7469  _product_attenti
+00022130: 6f6e 2871 2c20 6b2c 2076 2c20 6174 746e  on(q, k, v, attn
+00022140: 5f6d 6173 6b2c 2064 726f 706f 7574 5f70  _mask, dropout_p
+00022150: 2c20 6973 5f63 6175 7361 6c2c 2073 6361  , is_causal, sca
+00022160: 6c65 3d73 6361 6c65 290a 0a0a 6465 6620  le=scale)...def 
+00022170: 6175 746f 6361 7374 5f73 796d 626f 6c5f  autocast_symbol_
+00022180: 6d61 7070 6572 2862 6f75 6e64 5f73 796d  mapper(bound_sym
+00022190: 626f 6c3a 2042 6f75 6e64 5379 6d62 6f6c  bol: BoundSymbol
+000221a0: 496e 7465 7266 6163 652c 2064 7479 7065  Interface, dtype
+000221b0: 3a20 6474 7970 6573 2e64 7479 7065 293a  : dtypes.dtype):
+000221c0: 0a20 2020 2022 2222 5265 7475 726e 2074  .    """Return t
+000221d0: 6865 2063 616c 6c61 626c 6520 696d 706c  he callable impl
+000221e0: 656d 656e 7469 6e67 2074 6865 2061 7574  ementing the aut
+000221f0: 6f63 6173 7420 7275 6c65 2066 6f72 2074  ocast rule for t
+00022200: 6865 2073 796d 626f 6c2e 0a0a 2020 2020  he symbol...    
+00022210: 4172 6773 3a0a 2020 2020 2020 2020 626f  Args:.        bo
+00022220: 756e 645f 7379 6d62 6f6c 3a20 4d61 7070  und_symbol: Mapp
+00022230: 6564 2074 6f20 6974 7320 6175 746f 6361  ed to its autoca
+00022240: 7374 2072 756c 652e 0a0a 2020 2020 5265  st rule...    Re
+00022250: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
+00022260: 616c 6c61 626c 653a 2054 6865 2063 616c  allable: The cal
+00022270: 6c61 626c 6520 696d 706c 656d 656e 7469  lable implementi
+00022280: 6e67 2074 6865 2061 7574 6f63 6173 7420  ng the autocast 
+00022290: 7275 6c65 2066 6f72 2074 6865 2073 796d  rule for the sym
+000222a0: 626f 6c2e 0a20 2020 2022 2222 0a20 2020  bol..    """.   
+000222b0: 2061 7574 6f63 6173 745f 696d 706c 3a20   autocast_impl: 
+000222c0: 4361 6c6c 6162 6c65 207c 204e 6f6e 6520  Callable | None 
+000222d0: 3d20 6175 746f 6361 7374 5f69 6d70 6c73  = autocast_impls
+000222e0: 2e67 6574 2862 6f75 6e64 5f73 796d 626f  .get(bound_symbo
+000222f0: 6c2e 7379 6d2e 6964 290a 2020 2020 7265  l.sym.id).    re
+00022300: 7475 726e 2062 6f75 6e64 5f73 796d 626f  turn bound_symbo
+00022310: 6c2e 7379 6d20 6966 2061 7574 6f63 6173  l.sym if autocas
+00022320: 745f 696d 706c 2069 7320 4e6f 6e65 2065  t_impl is None e
+00022330: 6c73 6520 7061 7274 6961 6c28 6175 746f  lse partial(auto
+00022340: 6361 7374 5f69 6d70 6c2c 2064 7479 7065  cast_impl, dtype
+00022350: 3d64 7479 7065 290a 0a0a 6465 6620 6175  =dtype)...def au
+00022360: 746f 6361 7374 2866 756e 633a 2043 616c  tocast(func: Cal
+00022370: 6c61 626c 652c 2064 7479 7065 3a20 6474  lable, dtype: dt
+00022380: 7970 6573 2e64 7479 7065 293a 0a20 2020  ypes.dtype):.   
+00022390: 2022 2222 5472 616e 7366 6f72 6d73 2061   """Transforms a
+000223a0: 2066 756e 6374 696f 6e20 746f 2061 7574   function to aut
+000223b0: 6f63 6173 7420 6365 7274 6169 6e20 6f70  ocast certain op
+000223c0: 6572 6174 696f 6e73 2e0a 0a20 2020 2041  erations...    A
+000223d0: 7267 733a 0a20 2020 2020 2020 2066 756e  rgs:.        fun
+000223e0: 633a 2054 6865 2066 756e 6374 696f 6e20  c: The function 
+000223f0: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
+00022400: 642e 0a20 2020 2020 2020 2064 7479 7065  d..        dtype
+00022410: 3a20 5468 6520 6461 7461 2074 7970 6520  : The data type 
+00022420: 746f 2077 6869 6368 2061 7267 756d 656e  to which argumen
+00022430: 7473 206f 6620 7468 6520 6675 6e63 7469  ts of the functi
+00022440: 6f6e 206f 7220 7375 6220 6675 6e63 7469  on or sub functi
+00022450: 6f6e 7320 636f 756c 6420 6765 7420 6361  ons could get ca
+00022460: 7374 2069 660a 2020 2020 2020 2020 2020  st if.          
+00022470: 2020 7468 6579 2061 7265 2060 6474 7970    they are `dtyp
+00022480: 6573 2e66 6c6f 6174 3332 602e 0a0a 2020  es.float32`...  
+00022490: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+000224a0: 2020 2043 616c 6c61 626c 653a 2054 6865     Callable: The
+000224b0: 2074 7261 6e73 666f 726d 6564 2066 756e   transformed fun
+000224c0: 6374 696f 6e0a 2020 2020 2222 220a 0a20  ction.    """.. 
+000224d0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+000224e0: 616e 6365 2864 7479 7065 2c20 6474 7970  ance(dtype, dtyp
+000224f0: 6573 2e64 7479 7065 293a 0a20 2020 2020  es.dtype):.     
+00022500: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00022510: 726f 7228 6622 6064 7479 7065 6020 6973  ror(f"`dtype` is
+00022520: 2065 7870 6563 7465 6420 746f 2062 6520   expected to be 
+00022530: 6074 6875 6e64 6572 2e64 7479 7065 2e64  `thunder.dtype.d
+00022540: 7479 7065 6020 6275 7420 7b74 7970 6528  type` but {type(
+00022550: 6474 7970 6529 7d22 290a 2020 2020 6966  dtype)}").    if
+00022560: 2064 7479 7065 206e 6f74 2069 6e20 7b64   dtype not in {d
+00022570: 7479 7065 732e 666c 6f61 7431 362c 2064  types.float16, d
+00022580: 7479 7065 732e 6266 6c6f 6174 3136 7d3a  types.bfloat16}:
+00022590: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+000225a0: 616c 7565 4572 726f 7228 6622 6064 7479  alueError(f"`dty
+000225b0: 7065 6020 6973 2065 7870 6563 7465 6420  pe` is expected 
+000225c0: 746f 2062 6520 6569 7468 6572 2060 7468  to be either `th
+000225d0: 756e 6465 722e 666c 6f61 7431 3660 206f  under.float16` o
+000225e0: 7220 6074 6875 6e64 6572 2e62 666c 6f61  r `thunder.bfloa
+000225f0: 7431 3660 2c20 6275 7420 7b64 7479 7065  t16`, but {dtype
+00022600: 7d22 290a 0a20 2020 2040 7772 6170 7328  }")..    @wraps(
+00022610: 6675 6e63 290a 2020 2020 6465 6620 7772  func).    def wr
+00022620: 6170 7065 7228 2a61 7267 732c 202a 2a6b  apper(*args, **k
+00022630: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00022640: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
+00022650: 745f 7472 6163 6528 2928 6675 6e63 2c20  t_trace()(func, 
+00022660: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00022670: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00022680: 6576 616c 5f74 7261 6365 2874 7261 6365  eval_trace(trace
+00022690: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+000226a0: 732c 2073 796d 626f 6c5f 6d61 7070 6572  s, symbol_mapper
+000226b0: 3d70 6172 7469 616c 2861 7574 6f63 6173  =partial(autocas
+000226c0: 745f 7379 6d62 6f6c 5f6d 6170 7065 722c  t_symbol_mapper,
+000226d0: 2064 7479 7065 3d64 7479 7065 2929 0a0a   dtype=dtype))..
+000226e0: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
+000226f0: 6572 0a                                  er.
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240513/thunder/core/vjp_utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240513/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240513/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/distributed/prims.py` & `lightning_thunder-0.2.0.dev20240513/thunder/distributed/prims.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240513/thunder/distributed/transforms/ddp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240513/thunder/distributed/transforms/fsdp.py`

 * *Files 1% similar despite different names*

```diff
@@ -496,23 +496,14 @@
                     index_to_fqn[index] = rev_fqn_to_proxy_name[proxy_name]
                 elif proxy_name.startswith("t_"):
                     tmp_name = proxy_name[2:]
                     if tmp_name in rev_fqn_to_proxy_name:
                         index_to_fqn[index] = rev_fqn_to_proxy_name[tmp_name]
             self.index_to_fqn = index_to_fqn
 
-    def update_name_set(self, backward_trace: TraceCtx) -> TraceCtx:
-        if not self.apply_bucketing:
-            return
-        utils.check(
-            hasattr(self, "fsdp_fwd_trace"),
-            lambda: "This method must be called after :func:`FSDPCommsOptimizer.apply_bucketing_to_forward_trace`",
-        )
-        backward_trace.names.update(self.fsdp_fwd_trace.names)
-
     def _collect_sharded_parameters(self, fwd_trace: TraceCtx) -> list[TensorProxy]:
         fwd_trace_flat_args, _ = tree_flatten((fwd_trace.args, fwd_trace.kwargs))
         return fwd_trace_flat_args
 
     def apply_bucketing_to_forward_trace(self, fwd_trace: TraceCtx, bwd_trace_names: set[str]) -> TraceCtx:
         """Optimize collective comms in fsdp with bucketing.
 
@@ -535,15 +526,14 @@
             - :class:`TraceCtx`
             - dict[int, tuple[:class:`TensorProxy`, :class:`Bucket`]]: This is for the bucketing in backward.
         """
         if not self.apply_bucketing:
             return fwd_trace
         fsdp_fwd_trace = from_trace(fwd_trace)
         fsdp_fwd_trace.bound_symbols = fwd_trace.bound_symbols
-        fsdp_fwd_trace.names.update(bwd_trace_names)
         trace_flat_args = self._collect_sharded_parameters(fsdp_fwd_trace)
         arg_to_index_in_flat_args = utils.ProxyDict()
         index_in_flat_args_to_param_and_bucket: dict[int, tuple[TensorProxy, Bucket]] = {}
         for i, a in enumerate(trace_flat_args):
             if isinstance(a, TensorProxy):
                 arg_to_index_in_flat_args[a] = i
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240513/thunder/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240513/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/cudnnex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/nvfuserex_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/pythonex.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 from typing import List, Any, Dict, Tuple, Union, Type
 from collections.abc import Callable
 from collections.abc import Hashable
-from collections.abc import Sequence
+from collections.abc import Sequence, Collection, MutableSet, MutableMapping, MutableSequence
 from numbers import Number
 import math
 import operator
 import builtins
 import cmath
 from types import ModuleType
 import platform
@@ -221,16 +221,16 @@
 
 def _clear_collection_meta(coll: CollectionProxy) -> None:
     baseutils.check_type(coll, CollectionProxy)
     baseutils.check_type(coll.coll, Sequence)
     return None
 
 
-def _clear_collection_prim_impl(a: Sequence) -> None:
-    if isinstance(a, list):
+def _clear_collection_prim_impl(a: Collection) -> None:
+    if isinstance(a, (MutableSequence, MutableMapping, MutableSet)):
         a.clear()
 
 
 acos = ex.register_operator("acos", like=prims.acos, module=math)
 acosh = ex.register_operator("acosh", like=prims.acosh, module=math)
 asin = ex.register_operator("asin", like=prims.asin, module=math)
 asinh = ex.register_operator("asinh", like=prims.asinh, module=math)
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/torch_autograd.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,26 +1,67 @@
-from dataclasses import dataclass, replace
-from functools import partial, wraps
-from inspect import signature
-from typing import Any, TYPE_CHECKING
+from dataclasses import replace
+from typing import TYPE_CHECKING
 
 import torch
 
-import thunder
 import thunder.core.utils as utils
-import thunder.distributed.prims as dist_prims
-import thunder.torch as ltorch
 from thunder.core.prims import PrimIDs
-
-from thunder.core.proxies import FutureTensorProxy, TensorProxy, variableify
-from thunder.core.pytree import tree_flatten, tree_unflatten
-from thunder.core.symbol import BoundSymbol, BoundSymbolRHS, Symbol
-from thunder.core.trace import TraceCtx
+from thunder.core.proxies import TensorProxy, variableify
+from thunder.core.pytree import tree_flatten
+from thunder.core.symbol import BoundSymbol
+from thunder.core.trace import TraceCtx, from_trace, set_tracectx, reset_tracectx
 from thunder.core.transform_common import replace_redundant_inputs
 
+if TYPE_CHECKING:
+    from thunder.core.trace import VariableInterface
+
+
+def rename_bwd_trace_outputs(bwd_trace: TraceCtx, fwd_trace: TraceCtx) -> TraceCtx:
+    """Have backward trace output tensor proxy names follow `grad_for_<param>` format.
+
+    Since ``i``-th tensor proxy of backward trace's outputs is grad of ``i``-th tensor proxy of forward trace's inputs,
+    this method looks up to forward trace's inputs to get the param name for each grad.
+
+    Args:
+        bwd_trace:
+        fwd_trace:
+
+    Returns:
+        :class:`thunder.core.trace.TraceCtx`
+    """
+
+    # [note: why setting trace ctx?]
+    # [`TensorProxy.replace_name`](https://github.com/Lightning-AI/lightning-thunder/blob/561b699/thunder/core/proxies.py#L1221-L1223) calls
+    # [`tensorproxy`](https://github.com/Lightning-AI/lightning-thunder/blob/561b699/thunder/core/proxies.py#L1506-L1520)
+    # which then calls `TensorProxy.__init__`. `TensorProxy.__init__` of course calls
+    # [` Proxy.__init__`](https://github.com/Lightning-AI/lightning-thunder/blob/561b699/thunder/core/proxies.py#L81-L86).
+    # `Proxy`'s dunder init calls [`make_proxy_name`](https://github.com/Lightning-AI/lightning-thunder/blob/561b699/thunder/core/proxies.py#L81-L86)
+    # which depends on a tracectx.
+    trace_tok = set_tracectx(bwd_trace)
+
+    swap_map: dict[VariableInterface, TensorProxy] = {}
+    bwd_outputs, _ = tree_flatten(bwd_trace.output)
+    fwd_inputs, _ = tree_flatten((fwd_trace.args, fwd_trace.kwargs))
+
+    utils.check(len(bwd_outputs) == len(fwd_inputs), lambda: f"{len(bwd_outputs)=}, {len(fwd_inputs)=}")
+
+    for fwd_arg, bwd_out in zip(fwd_inputs, bwd_outputs):
+        if isinstance(bwd_out, TensorProxy):
+            swap_map[variableify(bwd_out)] = bwd_out.replace_name(f"grad_for_{fwd_arg.name}")
+    reset_tracectx(trace_tok)
+
+    renamed_bwd_trace = from_trace(bwd_trace)
+    renamed_bwd_trace.bound_symbols = []
+
+    bsym: BoundSymbol
+    for bsym in bwd_trace.bound_symbols:
+        renamed_bwd_trace.bound_symbols.append(bsym.from_bsym_swap_proxies(swap_map=swap_map))
+
+    return renamed_bwd_trace
+
 
 class ThunderFunction(torch.autograd.Function):
     @staticmethod
     def forward(
         ctx, return_none_instead_of_grads, compiled_backward, saved_tensors, saved_other, flat_output, *flat_args
     ):
         # Here we just propagate the tensors through the autograd graph
@@ -114,15 +155,14 @@
     # autograd.Function.backward expects a flat tuple of gradients
     bw_trace.bound_symbols[-1] = replace(bw_trace.bound_symbols[-1], args=(filtered_grads,))
 
     _fsdp_comm_bucketing: FSDPCommBucketing | None = None
     if getattr(compile_data.fn, "use_fsdp", False):
         _fsdp_comm_bucketing = FSDPCommBucketing(compile_data, computation_trc)
         fw_trace = _fsdp_comm_bucketing.apply_bucketing_to_forward_trace(fw_trace, bw_trace.names)
-        _fsdp_comm_bucketing.update_name_set(bw_trace)
 
     # Now we can run the optimization passes on the forward trace
     # TODO Restore request for no rematerialization
     fw_extrace = transform_for_execution(
         fw_trace,
         executors_list=compile_data.executors_list,
     )
@@ -198,26 +238,28 @@
         if getattr(compile_data.fn, "sharding_strategy") == FSDPType.ZERO2:
             fw_extrace = sort_waits(fw_extrace)
             bw_extrace = sort_waits(bw_extrace)
     if getattr(compile_data.fn, "use_ddp", False):
         bw_extrace = sort_waits(bw_extrace)
 
     # Importing here to avoid cyclical dependencies in future.
-    from thunder.executors.transformer_engineex import _rearrange_transformer_engine_linear, transformer_engine_ex
+    from thunder.executors.transformer_engineex import _transformer_engine_bwd_fp8_meta_sync, transformer_engine_ex
 
     if transformer_engine_ex in compile_data.executors_list:
-        # NOTE: `_rearrange_transformer_engine_linear` mutates `fw_extrace`.
-        _rearrange_transformer_engine_linear(fw_extrace, bw_extrace)
+        # NOTE: `_transformer_engine_bwd_fp8_meta_sync` may mutate `fw_extrace` or `bw_extrace`.
+        _transformer_engine_bwd_fp8_meta_sync(fw_extrace, bw_extrace)
 
     fw_extrace = del_last_used(fw_extrace)
     fw_traces.append(fw_extrace)
 
     bw_extrace = del_last_used(bw_extrace, clear_collections=True)
     bw_traces.append(bw_extrace)
 
+    bw_trace = rename_bwd_trace_outputs(bw_extrace, fw_extrace)
+
     if compile_stats is not None:
         compile_stats.last_traces += fw_traces
         compile_stats.last_backward_traces += bw_traces
 
     # Enable wrapping with `te.fp8_autocast`.
     fw_extrace._include_te_fp8_autocast = True
     # We only want the forward function to be called with `te.fp8_autocast` manager.
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/torch_compile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/torchex.py`

 * *Files 0% similar despite different names*

```diff
@@ -469,14 +469,15 @@
 squeeze = _register_torch_operation("squeeze")
 tensor_split = _register_torch_operation("tensor_split")
 transpose = _register_torch_operation("transpose")
 unbind = _register_torch_operation("unbind")
 unfold = _register_torch_operation("unfold", module=torch.Tensor)
 unsqueeze = _register_torch_operation("unsqueeze")
 view = _register_torch_operation("view", module=torch.Tensor)
+view_as = _register_torch_operation("view_as", module=torch.Tensor)
 
 
 def _broadcast_in_dim_prim_transform(
     a: TensorProxy, /, shape: Sequence[int], broadcast_dimensions: Sequence[int]
 ) -> TensorProxy:
     s = list(shape)
 
@@ -561,14 +562,15 @@
 _register_implementation(ltorch.squeeze, checker=_always_executable, execution_transform=_squeeze_transform)
 _register_implementation(ltorch.tensor_split, tensor_split, checker=_always_executable)
 _register_implementation(ltorch.transpose, transpose, checker=_always_executable)
 _register_implementation(ltorch.unbind, unbind, checker=_always_executable)
 _register_implementation(ltorch.unfold, unfold, checker=_always_executable)
 _register_implementation(ltorch.unsqueeze, unsqueeze, checker=_always_executable)
 _register_implementation(ltorch.view, view, checker=_always_executable)
+_register_implementation(ltorch.view_as, view_as, checker=_always_executable)
 
 #
 # Memory format operations
 #
 contiguous = _register_torch_operation("contiguous", module=torch.Tensor)
 
 
@@ -1325,15 +1327,15 @@
     meta=max_pool_with_indices_backward_meta,
     fn=torch.ops.aten.max_pool3d_with_indices_backward,
 )
 
 nll_loss = _register_torch_operation("nll_loss", module=torch.nn.functional)
 pad = _register_torch_operation("pad", module=torch.nn.functional)
 scaled_dot_product_attention = _register_torch_operation("scaled_dot_product_attention", module=torch.nn.functional)
-softmax = _register_torch_operation("softmax")
+softmax = _register_torch_operation("softmax", like=ltorch._softmax)
 
 
 # NOTE This transform translates number proxies to boolean values
 def _convolution_transform(
     a: TensorProxy,
     weight: TensorProxy,
     bias: None | TensorProxy,
@@ -1628,15 +1630,15 @@
 nll_loss_backward = ex.register_operator(
     "torch_nll_loss_backward_impl", meta=ltorch.nll_loss_backward, fn=_nll_loss_backward_impl
 )
 _register_implementation(ltorch.nll_loss_backward, nll_loss_backward, checker=_always_executable)
 _register_implementation(ltorch.pad, pad, checker=_always_executable)
 pad_prim_impl = ex.register_operator("torch_pad_prim_impl", meta=prims.pad.meta, fn=_pad_prim_impl)
 _register_implementation(prims.pad, pad_prim_impl, checker=_always_executable)
-_register_implementation(ltorch.softmax, checker=_always_executable, execution_transform=_softmax_transform)
+_register_implementation(ltorch._softmax, checker=_always_executable, execution_transform=_softmax_transform)
 _register_implementation(ltorch.scaled_dot_product_attention, scaled_dot_product_attention, checker=_always_executable)
 
 
 # Probability Distribution ops
 def _multinomial_transform(
     input: TensorLike,
     num_samples: int,
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/transformer_engineex.py`

 * *Files 8% similar despite different names*

```diff
@@ -116,76 +116,21 @@
     def __init__(self):
         self.saved_tensors = ()
 
     def save_for_backward(self, *tensors):
         self.saved_tensors = tensors
 
     def to_dict(self):
-        ctx_dict = {
-            "saved_tensors": self.saved_tensors,
-            "activation_dtype": self.activation_dtype,
-            "fp8": self.fp8,
-            "fp8_meta": self.fp8_meta,
-            "fuse_wgrad_accumulation": self.fuse_wgrad_accumulation,
-            "is_first_microbatch": self.is_first_microbatch,
-            "use_bias": self.use_bias,
-            "sequence_parallel": self.sequence_parallel,
-            "tensor_parallel": self.tensor_parallel,
-            "inp_shape": self.inp_shape,
-            "parallel_mode": self.parallel_mode,
-            "tp_group": self.tp_group,
-            "ub_name": self.ub_name,
-            "tp_size": self.tp_size,
-            "requires_dgrad": self.requires_dgrad,
-        }
-
-        if TE_VERSION_1_3_PLUS:
-            ctx_dict["cpu_offloading"] = self.cpu_offloading
-        if TE_VERSION_1_6_PLUS:
-            ctx_dict["primary_weights_in_fp8"] = self.primary_weights_in_fp8
-            ctx_dict["is_input_fp8"] = self.is_input_fp8
-            ctx_dict["reduce_and_update_bwd_fp8_tensors"] = self.reduce_and_update_bwd_fp8_tensors
-            ctx_dict["ub_overlap_ag"] = self.ub_overlap_ag
-        else:
-            ctx_dict.update(
-                {
-                    "ub_split_ag": self.ub_split_ag,
-                    "ub_atomic_gemm_ag": self.ub_atomic_gemm_ag,
-                }
-            )
-        return ctx_dict
+        return self.__dict__
 
     @staticmethod
     def from_dict(d):
         ctx = Context()
-        ctx.saved_tensors = d["saved_tensors"]
-        ctx.activation_dtype = d["activation_dtype"]
-        ctx.fp8 = d["fp8"]
-        ctx.fp8_meta = d["fp8_meta"]
-        ctx.fuse_wgrad_accumulation = d["fuse_wgrad_accumulation"]
-        ctx.is_first_microbatch = d["is_first_microbatch"]
-        ctx.use_bias = d["use_bias"]
-        ctx.sequence_parallel = d["sequence_parallel"]
-        ctx.tensor_parallel = d["tensor_parallel"]
-        ctx.inp_shape = d["inp_shape"]
-        ctx.parallel_mode = d["parallel_mode"]
-        ctx.tp_group = d["tp_group"]
-        ctx.ub_name = d["ub_name"]
-        ctx.tp_size = d["tp_size"]
-        ctx.requires_dgrad = d["requires_dgrad"]
-        if TE_VERSION_1_3_PLUS:
-            ctx.cpu_offloading = d["cpu_offloading"]
-        if TE_VERSION_1_6_PLUS:
-            ctx.primary_weights_in_fp8 = d["primary_weights_in_fp8"]
-            ctx.is_input_fp8 = d["is_input_fp8"]
-            ctx.reduce_and_update_bwd_fp8_tensors = d["reduce_and_update_bwd_fp8_tensors"]
-            ctx.ub_overlap_ag = d["ub_overlap_ag"]
-        else:
-            ctx.ub_split_ag = d["ub_split_ag"]
-            ctx.ub_atomic_gemm_ag = d["ub_atomic_gemm_ag"]
+        for key, value in d.items():
+            setattr(ctx, key, value)
         return ctx
 
 
 # Eagerly apply map without
 # storing the output.
 def eager_map(*args):
     return deque(map(*args), maxlen=0)
@@ -215,14 +160,24 @@
 
         if FP8GlobalStateManager.with_fp8_parameters():
             raise RuntimeError("Primary weights in FP8 is not supported under `thunder.jit`.")
 
         # Required by `get_fp8_weights_scratchpad`
         self.fp8_weight_shapes.append(torch.Size((self.out_features, self.in_features)))
 
+        if TE_VERSION_1_6_PLUS:
+            # NOTE: Backward FP8 metadata sync
+            # TransformerEngine v1.6 onwards, we control the sync and update of FP8 metadata for FP8 tensors
+            # tied to backward pass (i.e. the gradient tensors)
+            # Also, note that the forward tensor metadata sync occurs at the exit of `fp8_autocast` context manager
+            # which is not controlled by us.
+            #
+            # We consume the `is_first_fp8_module` so that the automatic sync for FP8 metadata is disabled.
+            FP8GlobalStateManager.is_first_fp8_module()  # Consume first module token.
+
     def forward(self, inp, weight, bias, is_first_microbatch: bool | None = None, is_grad_enabled: bool = False):
         tensor_inputs = tuple(filter(lambda t: isinstance(t, torch.Tensor), (inp, weight, bias)))
         # See [NOTE] Enable grad within context
         # TE backward depends on `requires_grad` to compute grads.
         # so under grad mode we enable grad for input tensors
         # Ref: https://github.com/NVIDIA/TransformerEngine/blob/b957aa475bcbcf22405381d18bd7fefe4fb6b171/transformer_engine/pytorch/module/linear.py#L264
         grad_ctx = enable_grad(*tensor_inputs) if is_grad_enabled else nullcontext()
@@ -509,14 +464,44 @@
 TE_CTX_STR = f"@{IMPORT_CTX_TE_KEY}.fp8_autocast(fp8_recipe={FP8_RECIPE_KEY})"
 
 
 def _get_te_wrapper_string():
     return TE_CTX_STR
 
 
+def te_sync_fp8_meta_bwd_meta():
+    pass
+
+
+def te_sync_fp8_meta_bwd_impl():
+    FP8GlobalStateManager.reduce_and_update_fp8_tensors(forward=False)
+
+
+te_sync_fp8_meta_bwd = transformer_engine_ex.register_operator(
+    "te_sync_fp8_meta_bwd", meta=te_sync_fp8_meta_bwd_meta, fn=te_sync_fp8_meta_bwd_impl
+)
+
+
+def _transformer_engine_bwd_fp8_meta_sync(fw_extrace, bw_extrace):
+    if TE_VERSION_1_6_PLUS:
+        # See doc of `_insert_bwd_fp8_meta_sync` for more details.
+        _insert_bwd_fp8_meta_sync(bw_extrace)
+    else:
+        # See doc of `_rearrange_transformer_engine_linear` for more details.
+        _rearrange_transformer_engine_linear(fw_extrace, bw_extrace)
+
+
+def _insert_bwd_fp8_meta_sync(bw_extrace):
+    # This functions insert the symbol `te_sync_fp8_meta_bwd` to the end of the backward
+    # trace which takes care of syncing and updating the FP8 metadata for backward tensors.
+    # See NOTE: Backward FP8 metadata sync
+    bwd_idx = len(bw_extrace.bound_symbols) - 1
+    bw_extrace.bound_symbols.insert(bwd_idx + 1, te_sync_fp8_meta_bwd.bind(output=None))
+
+
 def _rearrange_transformer_engine_linear(fw_extrace, bw_extrace):
     """
     Rearrange the TransformerEngine linear symbols `te_linear_*` in forward trace
     so that we match the constraint that first FP8 module being called
     in forward is the last FP8 module whose gradient is computed in backward pass.
 
     Implementation:
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240513/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/extend/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/extend/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240513/thunder/functional.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240513/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240513/thunder/torch/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -13,15 +13,15 @@
 import opt_einsum
 
 # Initializes the language context
 from thunder.torch.langctx import register_method, register_property
 
 import thunder.clang as clang
 import thunder.core.devices as devices
-from thunder.core.devices import to_device
+from thunder.core.devices import to_device, device_from_string
 import thunder.core.dtypes as dtypes
 from thunder.core.dtypes import to_torch_dtype, to_dtype, _thunder_to_torch_dtype_map, _torch_to_thunder_dtype_map
 import thunder.core.prims as prims
 import thunder.core.utils as utils
 import thunder.distributed.prims as dist_prims
 from thunder.core.langctxs import langctx, Languages
 from thunder.core.proxies import TensorProxy, FutureTensorProxy
@@ -110,14 +110,16 @@
             else:
                 utils.check(
                     False,
                     lambda: f"The torchsymbol decorator failed to infer an id for {name}, specify one explicitly (with id=<your id>)",
                     exception_type=AssertionError,
                 )
         else:
+            if not self.id.startswith("torch"):
+                warnings.warn(f"{self.id=} does not start with the namespace of `torch`")
             id = self.id
 
         if self.is_prim:
             sym = Symbol(
                 name=fn.__name__, meta=langctx(Languages.PRIMS)(_fn), id=id, is_prim=self.is_prim, tags=self.tags
             )
         else:
@@ -166,30 +168,122 @@
 
 @torchsymbol(torch.is_floating_point, is_method=True)
 def is_floating_point(a: TensorLike, /) -> bool:
     return dtypes.is_float_dtype(a.dtype)
 
 
 # Handles the size method
-def size(a):
-    def fn_(idx: int | None = None):
-        if idx is None:
-            return a.shape
-        return a.shape[idx]
+def size(a: TensorLike, /, dim: None | int = None) -> int | Sequence[int]:
+    if dim:
+        return a.shape[dim]
+    return a.shape
 
-    return fn_
+
+register_method("size", size)
+
+
+@torchsymbol(torch.numel, torch.Tensor.numel, is_method=True)
+def numel(a: TensorLike, /) -> int:
+    return a._numel
+
+
+register_method("numel", numel)
 
 
 @torchsymbol(torch.Tensor.is_cuda, is_property=True, id="torch.is_cuda")
 def is_cuda(a: TensorLike, /) -> bool:
     return a.device.devicetype is devices.DeviceType.CUDA
 
 
-register_method("size", size)
+_torch_dtype_to_old_torch_typestring_map = {
+    torch.float32: "FloatTensor",
+    torch.float64: "DoubleTensor",
+    torch.float16: "HalfTensor",
+    torch.bfloat16: "BFloat16Tensor",
+    torch.uint8: "ByteTensor",
+    torch.int8: "CharTensor",
+    torch.int16: "ShortTensor",
+    torch.int32: "IntTensor",
+    torch.long: "LongTensor",
+    torch.bool: "BoolTensor",
+}
+
+_old_torch_typestring_to_torch_dtype_map = {v: k for k, v in _torch_dtype_to_old_torch_typestring_map.items()}
+
+
+def _device_and_dtype_to_old_torch_typestring(device: DeviceLike, dtype: dtypeLike) -> str:
+    torch_dtype = to_torch_dtype(dtype)
+    dtype_str = _torch_dtype_to_old_torch_typestring_map.get(torch_dtype)
+    devicetype_str: str = ""
+    if device.devicetype is not devices.DeviceType.CPU:
+        devicetype_str = f"{devices.devicetype_string(device.devicetype)}."
+    return f"torch.{devicetype_str}{dtype_str}"
+
+
+def _old_torch_typestring_to_devicetype_and_dtype(typestring: str) -> tuple[DeviceLike, dtypeLike]:
+
+    # Two cases:
+    #    - torch.DtypeTensor
+    #    - torch.device.DtypeTensor
+
+    _, *dev_and_dtype = typestring.split(".")
+    devicetype_str = "cpu"
+    dtype_str = ""
+
+    if len(dev_and_dtype) == 1:
+        # when devicetype_str is omitted, device type is CPU
+        (dtype_str,) = dev_and_dtype
+        dtype_str = _old_torch_typestring_to_torch_dtype_map[dtype_str]
+
+    if len(dev_and_dtype) == 2:
+        devicetype_str, dtype_str = dev_and_dtype
+        dtype_str = _old_torch_typestring_to_torch_dtype_map[dtype_str]
+
+    # Value error
+    # expected the string to split into one or two elements
+    # and devicetype_str should be either "cpu" or "cuda"
+    utils.check(
+        devicetype_str in ("cpu", "cuda") and 1 <= len(dev_and_dtype) <= 2,
+        lambda: f"type(): unrecognized torch typestring {typestring}",
+        exception_type=ValueError,
+    )
+
+    return devicetype_str, dtype_str
+
+
+@torchsymbol(torch.Tensor.type, is_method=True)
+def type(a: TensorLike, /, dtype: None | str | dtypeLike = None, non_blocking: bool = False) -> str | TensorLike:
+    utils.check(
+        not non_blocking,
+        lambda: f"type(): `non_blocking==True` is currently not supported.",
+        exception_type=NotImplementedError,
+    )
+
+    if dtype is None:
+        # returns the type of the input tensor in string
+        return _device_and_dtype_to_old_torch_typestring(a.device, a.dtype)
+
+    if isinstance(dtype, str):
+        devtype, dtype = _old_torch_typestring_to_devicetype_and_dtype(dtype)
+
+        if devtype == a.device.type:
+            # This handles two cases:
+            # 1. When a tensor is already on a CUDA device, and the device type string is CUDA. In this case the tensor remains on its current device.
+            # 2. When a tensor is on a CPU device and the device type string is omitted, the tensor remains on the CPU device.
+            dev = a.device
+        else:
+            dev = device_from_string(devtype)
+    else:
+        # dtype is assumed to be torch.dtype (e.g. torch.int32)
+        dev = a.device
+
+    return to(a, dev, dtype)
+
 
+register_method("type", type)
 
 #
 # Data movement and transformation operations
 #
 
 
 # NOTE This handles a.float()
@@ -474,20 +568,14 @@
 
     # See issue "randomness: enable PyTorch generators for operations like
     # multinomial"
     utils.check(
         generator is None, lambda: f"multinomial does not yet support specifying a generator", NotImplementedError
     )
 
-    utils.check(
-        generator is None,
-        lambda: "Non-None generator is not supported",
-        NotImplementedError,
-    )
-
     seed = None
     samples = prims.multinomial(a, num_samples, replacement, seed)
     return samples
 
 
 # TODO Maybe update this to return an offset of how far to advance the seed to acquire new values
 # See issue "Maybe return offset from thunder.torch.uniform_philox"
@@ -568,14 +656,27 @@
         dtype = a.dtype
 
     if device is None:
         device = a.device
     return randn(a.shape, dtype=dtype, device=device)
 
 
+@torchsymbol(torch.bernoulli, is_method=True)
+def bernoulli(a: TensorLike, *, generator=None, out=None):
+    # NOTE: Currently, we don't model randomness
+    utils.check(
+        generator is None,
+        lambda: "bernoulli: generator is not None which is currently unsupported",
+        NotImplementedError,
+    )
+    utils.check(out is None, lambda: "bernoulli: out is not None which is currently unsupported", NotImplementedError)
+    utils.check(dtypes.is_float_dtype(a.dtype), lambda: f"bernoulli only supports floating point dtypes, got {a.dtype}")
+    return (uniform_like(a) < a).to(a.dtype)
+
+
 # NOTE zeros, like ones, and unlike full, can accept an integer shape
 @torchsymbol(torch.zeros)
 def zeros(*shape: int, device: None | DeviceLike = None, dtype: None | dtypeLike = None) -> TensorLike:
     shape = utils.extract_shape_from_varargs(shape)
     return full(shape, 0, device=device, dtype=dtype)
 
 
@@ -666,14 +767,19 @@
 
 
 @torchsymbol(torch.Tensor.expand, is_method=True)
 def expand(a: TensorLike, /, *shape: int) -> TensorLike:
     return clang.expand(a, *shape)
 
 
+@torchsymbol(torch.Tensor.expand_as, is_method=True)
+def expand_as(a: TensorLike, b: TensorLike, /) -> TensorLike:
+    return expand(a, b.size())
+
+
 @torchsymbol(torch.flatten, is_method=True)
 def flatten(a: TensorLike, /, start_dim: int = 0, end_dim: int = -1) -> TensorLike:
     return clang.flatten(a, start_dim, end_dim)
 
 
 @torchsymbol(torch.flip, is_method=True)
 def flip(a: TensorLike, /, *dims: int) -> TensorLike:
@@ -778,14 +884,25 @@
 @torchsymbol(torch.reshape, is_method=True)
 def reshape(a: TensorLike, /, *shape: int) -> TensorLike:
     shape = utils.extract_shape_from_varargs(shape)
 
     return clang.reshape(a, shape)
 
 
+@torchsymbol(torch.unflatten, is_method=True)
+def unflatten(a: TensorLike, /, dim: int, sizes=Sequence[int]) -> TensorLike:
+    utils.check(
+        len(sizes) > 0,
+        lambda: f"unflatten() sizes must be non-empty",
+        RuntimeError,
+    )
+    dim = utils.canonicalize_dim(a.ndim, dim)
+    return a.view(a.shape[:dim] + tuple(sizes) + a.shape[dim + 1 :])
+
+
 @torchsymbol(torch.select, is_method=True)
 def select(a: TensorLike, /, dim: int, index: int):
     # dim check
     utils.check(
         a.ndim != 0,
         lambda: f"select() cannot be applied to a 0-dim tensor.",
     )
@@ -1027,14 +1144,19 @@
 # TODO Add type annotations
 @torchsymbol(torch.Tensor.view, is_method=True)
 def view(a: TensorLike, /, *shape) -> TensorLike:
     shape = utils.extract_shape_from_varargs(shape)
     return reshape(a, shape)
 
 
+@torchsymbol(torch.Tensor.view_as, is_method=True)
+def view_as(a: TensorLike, b: TensorLike, /) -> TensorLike:
+    return view(a, b.size())
+
+
 #
 # Elementwise unary operaitons
 #
 # TODO Add type annotations
 
 
 @torchsymbol(torch.abs, is_method=True)
@@ -1368,14 +1490,19 @@
 
 
 @torchsymbol(torch.logical_and, is_method=True)
 def logical_and(a, b, /):
     return clang.logical_and(a, b)
 
 
+@torchsymbol(torch.logical_not, is_method=True)
+def logical_not(a: TensorLike, /) -> TensorLike:
+    return clang.logical_not(a)
+
+
 @torchsymbol(torch.le, is_method=True)
 def le(a, b, /):
     return clang.le(a, b)
 
 
 @torchsymbol(torch.lt, is_method=True)
 def lt(a, b, /):
@@ -1961,21 +2088,21 @@
 
 
 @torchsymbol(torch.index_select, is_method=True)
 def index_select(a: TensorLike, /, dim: int, index: TensorLike) -> TensorLike:
     return clang.take(a, index, dim)
 
 
-@torchsymbol(torch.gather)
+@torchsymbol(torch.gather, is_method=True)
 def gather(a: TensorLike, /, dim: int, index: TensorLike) -> TensorLike:
     return clang.gather(a, indices=index, dim=dim)
 
 
 # NOTE PyTorch's scatter_add has a parameter named 'src', not 'source'
-@torchsymbol(torch.scatter_add)
+@torchsymbol(torch.scatter_add, is_method=True)
 def scatter_add(a: TensorLike, /, dim: int, index: TensorLike, src: TensorLike) -> TensorLike:
     return clang.scatter_add(a, indices=index, value=src, dim=dim)
 
 
 @torchsymbol(torch.take_along_dim)
 def take_along_dim(a: TensorLike, /, indices: TensorLike, dim: int) -> TensorLike:
     return clang.take_along_axis(a, indices, dim)
@@ -2656,15 +2783,15 @@
 
         if running_mean is not None:
             new_running_mean = (1 - momentum) * running_mean + momentum * mean
             if not utils.are_same_dtypes(new_running_mean, running_mean):
                 new_running_mean = to(new_running_mean, running_mean.dtype)
             prims.copy_(new_running_mean, running_mean)
         if running_var is not None:
-            n = a.numel / a.shape[1]
+            n = a.numel() / a.shape[1]
             unbiased_var = biased_var * (n / (n - 1))
             new_running_var = (1 - momentum) * running_var + momentum * unbiased_var
             if not utils.are_same_dtypes(new_running_var, running_var):
                 new_running_var = to(new_running_var, running_var.dtype)
             prims.copy_(new_running_var, running_var)
     else:
         running_var_acc = to(running_var, computation_dtype)
@@ -3263,18 +3390,18 @@
         lambda: f"Cross entropy's {label_smoothing=} must be less than or equal to 1.0",
     )
 
     # extract shape information
     C_dim = 1 if a.ndim >= 2 else 0
     N = a.shape[0] if a.ndim >= 2 else 1
     C = a.shape[C_dim]
-    feature_size = int(a.numel / N / C)
+    feature_size = int(a.numel() / N / C)
 
     # Short-circuits if a is empty
-    if a.numel == 0:
+    if a.numel() == 0:
         if reduction == "none":
             output_shape = list(a.shape)
             output_shape.pop(C_dim)
             return zeros(output_shape, device=a.device, dtype=a.dtype)
         elif reduction == "mean":
             fill_value = float("nan")
         elif reduction == "sum":
@@ -3282,15 +3409,15 @@
         else:
             raise ValueError(f"Reduction argument {reduction} to cross_entropy is not supported")
 
         return full([], fill_value, device=a.device, dtype=a.dtype)
 
     if weight is not None:
         utils.check(
-            weight.ndim == 1 and weight.numel == C,
+            weight.ndim == 1 and weight.numel() == C,
             lambda: f"Expected {weight.shape=} to have one dimension and {C} elements",
         )
         bcast_weight = reshape(weight, [C] + [1 for i in range(2, a.ndim)])
 
     log_softmax_a = log_softmax(a, C_dim)
     out = -log_softmax_a
 
@@ -3448,26 +3575,26 @@
                 mask_sum = _reduction(
                     mask,
                     prims.sum,
                     dtype=to_dtype(torch.float),
                     output_dtype_kind=REDUCTION_OUTPUT_TYPE_KIND.SAME,
                 )
                 # NOTE: does the call numel here work with dynamic shape?!
-                out = reduced_sum / (target.numel - mask_sum)
+                out = reduced_sum / (target.numel() - mask_sum)
                 if label_smoothing > 0:
-                    ret = ret / (target.numel - mask_sum)
+                    ret = ret / (target.numel() - mask_sum)
                 elif target.ndim == 0:
                     # NOTE: this is pytorch implementation details.
                     # overwrite output to 0 when target hits ignore_index AND label_smoothing is missing.
                     # https://github.com/pytorch/pytorch/pull/64572
                     out = where((target == ignore_index), 0, out)
             else:
-                out = reduced_sum / target.numel
+                out = reduced_sum / target.numel()
                 if label_smoothing > 0:
-                    ret = ret / target.numel
+                    ret = ret / target.numel()
         else:
             raise ValueError(f"Reduction argument: {reduction} to cross_entropy is not supported")
 
         # TODO FIXME This is probably incorrect -- but somewhere above the dtype of out can disagree with PyTorch
         out = out.to(a.dtype)
 
         if label_smoothing > 0:
@@ -3550,15 +3677,15 @@
 
     # padding_idx / sparse not used by forward
 
     if a.ndim == 1:
         return clang.take(weight, a, 0)
 
     output_shape = list(a.shape) + list(weight.shape[1:])
-    flatten_indices = reshape(a, [a.numel])
+    flatten_indices = reshape(a, [a.numel()])
     flatten_output = clang.take(weight, flatten_indices, 0)
     return reshape(flatten_output, output_shape)
 
 
 @torchsymbol(torch.ops.aten.embedding_backward)
 def embedding_backward(grad, indices, num_weights, padding_idx, scale_grad_by_freq, sparse):
     result = prims.embedding_backward(grad, indices, num_weights, padding_idx, scale_grad_by_freq, sparse)
@@ -3598,19 +3725,19 @@
 
     # To avoid division by zero in the check below.
     utils.check(num_groups > 0, lambda: f"group_norm: {num_groups=} should be greater than 0")
     utils.check(
         num_channels % num_groups == 0, lambda: f"group_norm: {num_channels=} should be divisible by {num_groups=}"
     )
     utils.check(
-        weight is None or (weight.ndim == 1 and weight.numel == num_channels),
+        weight is None or (weight.ndim == 1 and weight.numel() == num_channels),
         lambda: f"group_norm: {weight.ndim=} should be equal to 1 and {weight.numel=} to {num_channels=}",
     )
     utils.check(
-        bias is None or (bias.ndim == 1 and bias.numel == num_channels),
+        bias is None or (bias.ndim == 1 and bias.numel() == num_channels),
         lambda: f"group_norm: {bias.ndim=} should be equal to 1 and {bias.numel=} to {num_channels=}",
     )
 
     # Empty `a` implies empty result.
     if any(d == 0 for d in a.shape):
         return zeros_like(a)
 
@@ -3750,15 +3877,15 @@
     utils.check(
         mode == "nearest",
         lambda: f"only mode='nearest' is supported at the moment, but got {mode=}",
         exception_type=NotImplementedError,
     )
 
     utils.check(a.ndim >= 3, lambda: f"Expected {a.ndim=} >= 3")
-    utils.check(a.numel > 0, lambda: f"Expected {a.numel=} to be greater than 0")
+    utils.check(a.numel() > 0, lambda: f"Expected {a.numel=} to be greater than 0")
 
     utils.check(
         (size is not None) ^ (scale_factor is not None),
         lambda: "Only one of `size` or `scale_factor` has to be specified, but " f"got {size=} and {scale_factor=}",
     )
 
     if size is not None:
@@ -3833,15 +3960,15 @@
 
     # NOTE This short-circuit is subject to change and is placed ahead of other input checks to match PyTorch behavior.
     # The expected behavior when the target and input have zero elements:
     #   reduction = 'none' --- tensor([], shape) or tensor(0.)
     #   reduction = 'sum'  --- tensor(0.)
     #   reduction = 'mean' --- tensor(nan)
     # Mean reduction on empty tensors produces NaN.
-    if a.numel == 0 and target.numel == 0:
+    if a.numel() == 0 and target.numel() == 0:
         if reduction == "none":
             # Keep target shape if it is non-trivial
             result_shape = target.shape if target.shape != (0,) else []
             return full(result_shape, fill_value := 0.0, device=a.device, dtype=a.dtype), None
         elif reduction == "sum":
             return full(result_shape := [], fill_value := 0.0, device=a.device, dtype=a.dtype), None
         elif reduction == "mean":
@@ -4065,16 +4192,22 @@
 
 @torchsymbol(torch.sigmoid, torch.nn.functional.sigmoid, torch.special.expit, is_method=True)
 def sigmoid(a: TensorLike, /) -> TensorLike:
     return clang.sigmoid(a)
 
 
 # CompositeImplicitAutograd - don't register decomp
-@torchsymbol(torch.softmax, torch.nn.functional.softmax, is_method=True)
-def softmax(a: TensorLike, /, dim: int, *, dtype: None | dtypeLike = None) -> TensorLike:
+@torchsymbol(torch.softmax, torch.nn.functional.softmax, is_method=True, id="torch.softmax")
+def _softmax(
+    a: TensorLike,
+    /,
+    dim: int,
+    *,
+    dtype: None | dtypeLike = None,
+) -> TensorLike:
     result_dtype: dtypeLike = dtype or a.dtype
     result_dtype: dtypes.dtype = to_dtype(result_dtype)
     computation_dtype = utils.get_computation_dtype(result_dtype)
     a_ = a.to(computation_dtype)
 
     if a.numel == 0:
         a_exp = exp(a_)
@@ -4083,14 +4216,23 @@
         a_exp = exp(a_ - a_max)
 
     result = a_exp / sum(a_exp, dim, keepdim=True)
     converted = result.to(result_dtype)
     return converted
 
 
+register_method("softmax", _softmax)
+
+
+# A wrapper to support `torch.nn.Softmax` whose `forward` passes the kwarg of `_stacklevel=5` to `torch.nn.functional.softmax`.
+# ref: https://github.com/pytorch/pytorch/blob/8d12ba9acfa20ed7df438a8892c9bf8e6bef5775/torch/nn/modules/activation.py#L1545
+def softmax(a: TensorLike, dim: int, dtype: None | dtypeLike = None, _stacklevel: int = 3) -> TensorLike:
+    return _softmax(a, dim=dim, dtype=dtype)
+
+
 #
 # Distributed operations
 #
 # NOTE DISTRIBUTED AVAILABILITY
 # PyTorch is often built without distributed support, which can be queried for using
 #   torch.distributed.is_available(). When PyTorch is built without distributed then we
 #   want to avoid accessing any parts of the torch.distributed module except
```

### Comparing `lightning_thunder-0.2.0.dev20240505/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240513/thunder/torch/langctx.py`

 * *Files identical despite different names*


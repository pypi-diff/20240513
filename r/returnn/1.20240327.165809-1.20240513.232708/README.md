# Comparing `tmp/returnn-1.20240327.165809.tar.gz` & `tmp/returnn-1.20240513.232708.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist/returnn-1.20240327.165809.tar", last modified: Wed Mar 27 16:14:27 2024, max compression
+gzip compressed data, was "dist/returnn-1.20240513.232708.tar", last modified: Mon May 13 21:38:21 2024, max compression
```

## Comparing `returnn-1.20240327.165809.tar` & `returnn-1.20240513.232708.tar`

### file list

```diff
@@ -1,493 +1,493 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/
--rw-r--r--   0 runner    (1001) docker     (127)      198 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/.editorconfig
--rw-r--r--   0 runner    (1001) docker     (127)      526 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/.gitignore
--rw-r--r--   0 runner    (1001) docker     (127)      828 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/.gitmodules
--rw-r--r--   0 runner    (1001) docker     (127)       79 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/.kateconfig
--rw-r--r--   0 runner    (1001) docker     (127)     8556 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/CHANGELOG.md
--rw-r--r--   0 runner    (1001) docker     (127)      704 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/CODEOWNERS
--rw-r--r--   0 runner    (1001) docker     (127)     4880 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/CONTRIBUTING.md
--rw-r--r--   0 runner    (1001) docker     (127)    10751 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)     4718 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     3573 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/README.rst
--rw-r--r--   0 runner    (1001) docker     (127)     1171 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)       77 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/_setup_info_generated.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/
--rw-r--r--   0 runner    (1001) docker     (127)    36006 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/12AX.cluster_map
--rw-r--r--   0 runner    (1001) docker     (127)      476 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/_setup_returnn_env.py
--rw-r--r--   0 runner    (1001) docker     (127)     1174 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-fwd.config
--rw-r--r--   0 runner    (1001) docker     (127)     2703 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-horovod-mpi.py
--rw-r--r--   0 runner    (1001) docker     (127)      520 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-horovod-mpi.py.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      264 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-horovod-mpi.sh
--rw-r--r--   0 runner    (1001) docker     (127)     1756 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-hyper-param-tuning.config
--rwxr-xr-x   0 runner    (1001) docker     (127)     2396 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-iter-dataset.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3635 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-list-devices.py
--rw-r--r--   0 runner    (1001) docker     (127)     2848 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-lua-torch-layer.config
--rw-r--r--   0 runner    (1001) docker     (127)      487 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-pretrain.config
--rwxr-xr-x   0 runner    (1001) docker     (127)     2331 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-record-and-push-to-webserver.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     1950 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-returnn-as-framework.py
--rw-r--r--   0 runner    (1001) docker     (127)    24864 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-rf-pt-benchmark.py
--rw-r--r--   0 runner    (1001) docker     (127)     3216 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-rf.config
--rw-r--r--   0 runner    (1001) docker     (127)     2331 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-rhn-enwik8.config
--rwxr-xr-x   0 runner    (1001) docker     (127)     1378 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-sprint-interface.py
--rw-r--r--   0 runner    (1001) docker     (127)     3147 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-att-copy.config
--rw-r--r--   0 runner    (1001) docker     (127)     2428 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-attention.config
--rw-r--r--   0 runner    (1001) docker     (127)     1481 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-chunking-blstm.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     1416 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-contribrnn-lstm.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     3073 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-enc-dec.config
--rwxr-xr-x   0 runner    (1001) docker     (127)    11615 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-hard-att-copy.config
--rwxr-xr-x   0 runner    (1001) docker     (127)     7287 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-lstm-benchmark.py
--rw-r--r--   0 runner    (1001) docker     (127)     1527 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-maxgradnorm-lstm.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     1413 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-native-lstm-lowmem.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     1576 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-native-lstm.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     1768 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-native-lstm2.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     1075 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-native-lstm2.12ax.tuned.config
--rw-r--r--   0 runner    (1001) docker     (127)     1794 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-neural-transducer.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     1825 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-rec-explicit-lstm.config
--rw-r--r--   0 runner    (1001) docker     (127)     1202 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-rec-explicit-rnn.config
--rw-r--r--   0 runner    (1001) docker     (127)     2018 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-rec-self-att.config
--rw-r--r--   0 runner    (1001) docker     (127)     5188 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-search-compiled-graph.py
--rw-r--r--   0 runner    (1001) docker     (127)     1430 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-tf-vanilla-lstm.12ax.config
--rw-r--r--   0 runner    (1001) docker     (127)     4818 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-timit-lstm-ctc.config
--rw-r--r--   0 runner    (1001) docker     (127)     3174 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-torch.config
--rw-r--r--   0 runner    (1001) docker     (127)      766 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo-upd-mult-model.lstm.12ax.config
--rwxr-xr-x   0 runner    (1001) docker     (127)      651 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/demo.sh
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/
--rwxr-xr-x   0 runner    (1001) docker     (127)    43239 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/a01-000u-00.png
--rwxr-xr-x   0 runner    (1001) docker     (127)    43552 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/a01-007-04.png
--rwxr-xr-x   0 runner    (1001) docker     (127)    45111 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/a01-007-06.png
--rw-r--r--   0 runner    (1001) docker     (127)     1709 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/README.txt
--rw-r--r--   0 runner    (1001) docker     (127)      158 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/chars.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1896 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/config_demo
--rw-r--r--   0 runner    (1001) docker     (127)     1981 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/config_fwd
--rw-r--r--   0 runner    (1001) docker     (127)     1983 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/config_real
--rwxr-xr-x   0 runner    (1001) docker     (127)    10194 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/create_IAM_dataset.py
--rwxr-xr-x   0 runner    (1001) docker     (127)      749 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/decode.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/features/
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/features/raw/
--rw-r--r--   0 runner    (1001) docker     (127)   248580 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/features/raw/demo.h5
--rwxr-xr-x   0 runner    (1001) docker     (127)       86 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/go.sh
--rw-r--r--   0 runner    (1001) docker     (127)      235 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/lines.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/split/
--rw-r--r--   0 runner    (1001) docker     (127)     2712 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/split/eval.txt
--rw-r--r--   0 runner    (1001) docker     (127)    69536 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/split/train.txt
--rw-r--r--   0 runner    (1001) docker     (127)      934 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/IAM/split/valid.txt
--rw-r--r--   0 runner    (1001) docker     (127)      230 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/artificial/
--rwxr-xr-x   0 runner    (1001) docker     (127)     2804 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial/create_test_h5.py
--rw-r--r--   0 runner    (1001) docker     (127)     1055 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial/forwardconfig
--rwxr-xr-x   0 runner    (1001) docker     (127)      105 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial/go.sh
--rw-r--r--   0 runner    (1001) docker     (127)      970 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial/trainconfig
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/
--rwxr-xr-x   0 runner    (1001) docker     (127)     2966 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/create_test_h5.py
--rw-r--r--   0 runner    (1001) docker     (127)     1055 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/forwardconfig
--rwxr-xr-x   0 runner    (1001) docker     (127)      105 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/go.sh
--rw-r--r--   0 runner    (1001) docker     (127)      970 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/trainconfig
--rw-r--r--   0 runner    (1001) docker     (127)      463 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)      110 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/requirements.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/
--rw-r--r--   0 runner    (1001) docker     (127)     1012 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30829 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/__main__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7654 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/__old_mod_loader__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4659 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/__setup__.py
--rw-r--r--   0 runner    (1001) docker     (127)    27474 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/config.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/datasets/
--rw-r--r--   0 runner    (1001) docker     (127)      390 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    19376 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/audio.py
--rw-r--r--   0 runner    (1001) docker     (127)    64342 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/basic.py
--rw-r--r--   0 runner    (1001) docker     (127)     2388 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/bundle_file.py
--rw-r--r--   0 runner    (1001) docker     (127)    25090 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/cached.py
--rw-r--r--   0 runner    (1001) docker     (127)    11722 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/cached2.py
--rw-r--r--   0 runner    (1001) docker     (127)    99033 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/generating.py
--rw-r--r--   0 runner    (1001) docker     (127)    65175 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/hdf.py
--rw-r--r--   0 runner    (1001) docker     (127)    85507 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/lm.py
--rw-r--r--   0 runner    (1001) docker     (127)    10892 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/map.py
--rw-r--r--   0 runner    (1001) docker     (127)    77105 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/meta.py
--rw-r--r--   0 runner    (1001) docker     (127)    15551 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/multi_proc.py
--rw-r--r--   0 runner    (1001) docker     (127)    14596 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/normalization_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     5291 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/numpy_dump.py
--rw-r--r--   0 runner    (1001) docker     (127)     9127 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/raw_wav.py
--rw-r--r--   0 runner    (1001) docker     (127)    55916 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/sprint.py
--rw-r--r--   0 runner    (1001) docker     (127)    17608 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/stereo.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/datasets/util/
--rw-r--r--   0 runner    (1001) docker     (127)       52 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    23915 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/util/feature_extraction.py
--rw-r--r--   0 runner    (1001) docker     (127)      413 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/util/strings.py
--rw-r--r--   0 runner    (1001) docker     (127)    20501 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/datasets/util/vocabulary.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/engine/
--rw-r--r--   0 runner    (1001) docker     (127)      228 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/engine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17448 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/engine/base.py
--rw-r--r--   0 runner    (1001) docker     (127)     9912 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/engine/batch.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/
--rw-r--r--   0 runner    (1001) docker     (127)     4005 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4024 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/__main__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/
--rw-r--r--   0 runner    (1001) docker     (127)       65 2024-03-27 16:14:08.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/.git
--rw-r--r--   0 runner    (1001) docker     (127)        6 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/.gitignore
--rw-r--r--   0 runner    (1001) docker     (127)     1069 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)     1448 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/README.md
--rw-r--r--   0 runner    (1001) docker     (127)    13770 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/aligner.gif
--rw-r--r--   0 runner    (1001) docker     (127)    51077 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/check.png
--rw-r--r--   0 runner    (1001) docker     (127)    11544 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/core.cu
--rw-r--r--   0 runner    (1001) docker     (127)      975 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/core.h
--rw-r--r--   0 runner    (1001) docker     (127)     2512 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/core_cpu.cpp
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/
--rw-r--r--   0 runner    (1001) docker     (127)     1069 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)       70 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)     2089 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/README.md
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/binding.cpp
--rw-r--r--   0 runner    (1001) docker     (127)    11544 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.cu
--rw-r--r--   0 runner    (1001) docker     (127)      975 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.h
--rw-r--r--   0 runner    (1001) docker     (127)       28 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/requirements.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2079 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/
--rw-r--r--   0 runner    (1001) docker     (127)     2885 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6961 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/test.py
--rw-r--r--   0 runner    (1001) docker     (127)     4141 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/ref_rna.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/
--rw-r--r--   0 runner    (1001) docker     (127)     6150 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/
--rw-r--r--   0 runner    (1001) docker     (127)     1689 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op.cc
--rw-r--r--   0 runner    (1001) docker     (127)     6030 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op_kernel_tmpl.h
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/warp_rna/
--rw-r--r--   0 runner    (1001) docker     (127)     2076 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/warp_rna/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4252 2024-03-27 16:14:11.000000 returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/test.cpp
--rw-r--r--   0 runner    (1001) docker     (127)      135 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/
--rw-r--r--   0 runner    (1001) docker     (127)      257 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/README.md
--rw-r--r--   0 runner    (1001) docker     (127)     1239 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8479 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/edit.py
--rw-r--r--   0 runner    (1001) docker     (127)    19826 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/reroute.py
--rw-r--r--   0 runner    (1001) docker     (127)    29792 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/select.py
--rw-r--r--   0 runner    (1001) docker     (127)    26578 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/subgraph.py
--rw-r--r--   0 runner    (1001) docker     (127)    29372 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/transform.py
--rw-r--r--   0 runner    (1001) docker     (127)    18723 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/extern/graph_editor/util.py
--rw-r--r--   0 runner    (1001) docker     (127)      911 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/forward_iface.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/frontend/
--rw-r--r--   0 runner    (1001) docker     (127)     1295 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    47536 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/frontend/_native/
--rw-r--r--   0 runner    (1001) docker     (127)     6407 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4768 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/backend.cpp
--rw-r--r--   0 runner    (1001) docker     (127)      791 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/backend.hpp
--rw-r--r--   0 runner    (1001) docker     (127)    15521 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/module.cpp
--rw-r--r--   0 runner    (1001) docker     (127)     6670 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/module.hpp
--rw-r--r--   0 runner    (1001) docker     (127)     3139 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/py_utils.hpp
--rw-r--r--   0 runner    (1001) docker     (127)    70068 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/tensor_ops.cpp
--rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_native/tensor_ops.hpp
--rw-r--r--   0 runner    (1001) docker     (127)     6173 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_numpy_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     5445 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_random_journal.py
--rw-r--r--   0 runner    (1001) docker     (127)    12068 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    27482 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/array_.py
--rw-r--r--   0 runner    (1001) docker     (127)    40728 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/attention.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/frontend/audio/
--rw-r--r--   0 runner    (1001) docker     (127)       67 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/audio/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7645 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/audio/mel.py
--rw-r--r--   0 runner    (1001) docker     (127)     5604 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/audio/specaugment.py
--rw-r--r--   0 runner    (1001) docker     (127)      883 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     1023 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/cond.py
--rw-r--r--   0 runner    (1001) docker     (127)     3945 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/const.py
--rw-r--r--   0 runner    (1001) docker     (127)     7606 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/container.py
--rw-r--r--   0 runner    (1001) docker     (127)      699 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/control_flow_ctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    22353 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/conv.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/frontend/decoder/
--rw-r--r--   0 runner    (1001) docker     (127)       41 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/decoder/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14378 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/decoder/transformer.py
--rw-r--r--   0 runner    (1001) docker     (127)     1438 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/device.py
--rw-r--r--   0 runner    (1001) docker     (127)     4954 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/dims.py
--rw-r--r--   0 runner    (1001) docker     (127)     5006 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/dropout.py
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/dtype.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/frontend/encoder/
--rw-r--r--   0 runner    (1001) docker     (127)       17 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/encoder/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2109 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/encoder/base.py
--rw-r--r--   0 runner    (1001) docker     (127)    15776 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/encoder/conformer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2372 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/gradient.py
--rw-r--r--   0 runner    (1001) docker     (127)     1818 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/graph.py
--rw-r--r--   0 runner    (1001) docker     (127)     5507 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/hooks.py
--rw-r--r--   0 runner    (1001) docker     (127)     7494 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/init.py
--rw-r--r--   0 runner    (1001) docker     (127)     4409 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/label_smoothing.py
--rw-r--r--   0 runner    (1001) docker     (127)     2244 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/linear.py
--rw-r--r--   0 runner    (1001) docker     (127)    15498 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/loop.py
--rw-r--r--   0 runner    (1001) docker     (127)     3040 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/loss.py
--rw-r--r--   0 runner    (1001) docker     (127)    14956 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/math_.py
--rw-r--r--   0 runner    (1001) docker     (127)     1945 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/matmul.py
--rw-r--r--   0 runner    (1001) docker     (127)    10700 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/module.py
--rw-r--r--   0 runner    (1001) docker     (127)    10198 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/normalization.py
--rw-r--r--   0 runner    (1001) docker     (127)     8531 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/parameter.py
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/rand.py
--rw-r--r--   0 runner    (1001) docker     (127)     7847 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/rec.py
--rw-r--r--   0 runner    (1001) docker     (127)     7225 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/reduce.py
--rw-r--r--   0 runner    (1001) docker     (127)    20105 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/run_ctx.py
--rw-r--r--   0 runner    (1001) docker     (127)     4078 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/signal.py
--rw-r--r--   0 runner    (1001) docker     (127)     2935 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/state.py
--rw-r--r--   0 runner    (1001) docker     (127)     4328 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/tensor_array.py
--rw-r--r--   0 runner    (1001) docker     (127)     1270 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/frontend/types.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/import_/
--rw-r--r--   0 runner    (1001) docker     (127)      243 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/import_/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8148 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/import_/common.py
--rw-r--r--   0 runner    (1001) docker     (127)    13961 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/import_/git.py
--rw-r--r--   0 runner    (1001) docker     (127)      798 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/import_/import_.py
--rw-r--r--   0 runner    (1001) docker     (127)    34623 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/learning_rate_control.py
--rw-r--r--   0 runner    (1001) docker     (127)    12351 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/log.py
--rw-r--r--   0 runner    (1001) docker     (127)    35760 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/native_op.cpp
--rw-r--r--   0 runner    (1001) docker     (127)   244419 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/native_op.py
--rw-r--r--   0 runner    (1001) docker     (127)    23542 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/pretrain.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/sprint/
--rw-r--r--   0 runner    (1001) docker     (127)       64 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/sprint/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    35134 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/sprint/cache.py
--rw-r--r--   0 runner    (1001) docker     (127)    31142 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/sprint/control.py
--rw-r--r--   0 runner    (1001) docker     (127)    23348 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/sprint/error_signals.py
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/sprint/extern_interface.py
--rw-r--r--   0 runner    (1001) docker     (127)    36521 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/sprint/interface.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/tensor/
--rw-r--r--   0 runner    (1001) docker     (127)      501 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      154 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   116423 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/_dim_extra.py
--rw-r--r--   0 runner    (1001) docker     (127)   164824 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/_tensor_extra.py
--rw-r--r--   0 runner    (1001) docker     (127)      643 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/_tensor_mixin_base.py
--rw-r--r--   0 runner    (1001) docker     (127)     5018 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/_tensor_op_overloads.py
--rw-r--r--   0 runner    (1001) docker     (127)     5252 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/control_flow_ctx.py
--rw-r--r--   0 runner    (1001) docker     (127)     4002 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/dim.py
--rw-r--r--   0 runner    (1001) docker     (127)     1884 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/marked_dim.py
--rw-r--r--   0 runner    (1001) docker     (127)     9087 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/tensor.py
--rw-r--r--   0 runner    (1001) docker     (127)     6965 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/tensor_dict.py
--rw-r--r--   0 runner    (1001) docker     (127)     9566 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tensor/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/tf/
--rw-r--r--   0 runner    (1001) docker     (127)       88 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1632 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/compat.py
--rw-r--r--   0 runner    (1001) docker     (127)    36646 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/data_pipeline.py
--rw-r--r--   0 runner    (1001) docker     (127)    15108 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)   147333 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/engine.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/
--rw-r--r--   0 runner    (1001) docker     (127)     1096 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      506 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    46293 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     4205 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14830 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/cond.py
--rw-r--r--   0 runner    (1001) docker     (127)     5583 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/config_entry_points.py
--rw-r--r--   0 runner    (1001) docker     (127)      888 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/debug_eager_mode.py
--rw-r--r--   0 runner    (1001) docker     (127)     5712 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/dims.py
--rw-r--r--   0 runner    (1001) docker     (127)    72976 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/layer.py
--rw-r--r--   0 runner    (1001) docker     (127)    26710 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/loop.py
--rw-r--r--   0 runner    (1001) docker     (127)    16216 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/make_layer.py
--rw-r--r--   0 runner    (1001) docker     (127)     3999 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/masked_computation.py
--rw-r--r--   0 runner    (1001) docker     (127)     5103 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/parameter_assign.py
--rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_layers/prev_tensor_ref.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/tf/frontend_low_level/
--rw-r--r--   0 runner    (1001) docker     (127)       62 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_low_level/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    23145 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/frontend_low_level/_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     5404 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/horovod.py
--rw-r--r--   0 runner    (1001) docker     (127)    31611 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/hyper_param_tuning.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/tf/layers/
--rw-r--r--   0 runner    (1001) docker     (127)       72 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   152845 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/base.py
--rw-r--r--   0 runner    (1001) docker     (127)   605858 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/basic.py
--rw-r--r--   0 runner    (1001) docker     (127)   547403 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/rec.py
--rw-r--r--   0 runner    (1001) docker     (127)    21515 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/segmental_model.py
--rw-r--r--   0 runner    (1001) docker     (127)    52693 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/signal_processing.py
--rw-r--r--   0 runner    (1001) docker     (127)    11446 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/layers/variable.py
--rw-r--r--   0 runner    (1001) docker     (127)    79729 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/native_op.py
--rw-r--r--   0 runner    (1001) docker     (127)   224930 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     5471 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/sprint.py
--rw-r--r--   0 runner    (1001) docker     (127)    71701 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/updater.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/tf/util/
--rw-r--r--   0 runner    (1001) docker     (127)       92 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   302712 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/util/basic.py
--rw-r--r--   0 runner    (1001) docker     (127)    29422 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/util/data.py
--rw-r--r--   0 runner    (1001) docker     (127)     6081 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/util/gradient_checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    17313 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/util/ken_lm.py
--rw-r--r--   0 runner    (1001) docker     (127)    11265 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/tf/util/open_fst.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/torch/
--rw-r--r--   0 runner    (1001) docker     (127)       85 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/README.md
--rw-r--r--   0 runner    (1001) docker     (127)       24 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/torch/data/
--rw-r--r--   0 runner    (1001) docker     (127)      132 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7203 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/data/extern_data.py
--rw-r--r--   0 runner    (1001) docker     (127)    16209 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/data/pipeline.py
--rw-r--r--   0 runner    (1001) docker     (127)      888 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/data/queued_data_iter.py
--rw-r--r--   0 runner    (1001) docker     (127)     5569 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/data/returnn_dataset_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     1284 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/data/tensor_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5470 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)    56309 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/engine.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/torch/frontend/
--rw-r--r--   0 runner    (1001) docker     (127)       62 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/frontend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    87976 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/frontend/_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     1830 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/frontend/_rand.py
--rw-r--r--   0 runner    (1001) docker     (127)     7239 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/frontend/bridge.py
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/frontend/raw_ops.py
--rw-r--r--   0 runner    (1001) docker     (127)    26020 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/updater.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/torch/util/
--rw-r--r--   0 runner    (1001) docker     (127)      193 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/util/README.md
--rw-r--r--   0 runner    (1001) docker     (127)       26 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5105 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/util/diagnose_gpu.py
--rw-r--r--   0 runner    (1001) docker     (127)     3192 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/torch/util/scaled_gradient.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn/util/
--rw-r--r--   0 runner    (1001) docker     (127)      336 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   138010 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/basic.py
--rw-r--r--   0 runner    (1001) docker     (127)    60303 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/better_exchook.py
--rw-r--r--   0 runner    (1001) docker     (127)    17977 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/bpe.py
--rw-r--r--   0 runner    (1001) docker     (127)    18562 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/debug.py
--rw-r--r--   0 runner    (1001) docker     (127)     2905 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/debug_helpers.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    59177 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/fsa.py
--rw-r--r--   0 runner    (1001) docker     (127)     2173 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/literal_py_to_pickle.py
--rw-r--r--   0 runner    (1001) docker     (127)      205 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/math.py
--rw-r--r--   0 runner    (1001) docker     (127)     7257 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/multi_proc_non_daemonic_spawn.py
--rw-r--r--   0 runner    (1001) docker     (127)    13180 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/native_code_compiler.py
--rw-r--r--   0 runner    (1001) docker     (127)     8131 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/pprint.py
--rw-r--r--   0 runner    (1001) docker     (127)    14844 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/py-to-pickle.cpp
--rw-r--r--   0 runner    (1001) docker     (127)      277 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/py_compat.py
--rw-r--r--   0 runner    (1001) docker     (127)     1708 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/py_ext_mod_compiler.py
--rw-r--r--   0 runner    (1001) docker     (127)      359 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/result_with_reason.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     7273 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/sig_proc.py
--rw-r--r--   0 runner    (1001) docker     (127)    26382 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/task_system.py
--rw-r--r--   0 runner    (1001) docker     (127)     3266 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/train_proc_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     4213 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/returnn/util/watch_memory.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)     4718 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/returnn.egg-info/top_level.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)      461 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/rnn.py
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)     4159 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tests/
--rwxr-xr-x   0 runner    (1001) docker     (127)     3386 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/DummySprintExec.py
--rw-r--r--   0 runner    (1001) docker     (127)     2743 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm-inspection-profile.xml
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tests/PyCharm.idea/
--rw-r--r--   0 runner    (1001) docker     (127)       47 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/.gitignore
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/.name
--rw-r--r--   0 runner    (1001) docker     (127)      512 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/codeStyleSettings.xml
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tests/PyCharm.idea/codeStyles/
--rw-r--r--   0 runner    (1001) docker     (127)      328 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/codeStyles/Project.xml
--rw-r--r--   0 runner    (1001) docker     (127)      142 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/codeStyles/codeStyleConfig.xml
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tests/PyCharm.idea/inspectionProfiles/
--rw-r--r--   0 runner    (1001) docker     (127)     2743 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/inspectionProfiles/Project_Default.xml
--rw-r--r--   0 runner    (1001) docker     (127)      181 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/inspectionProfiles/profiles_settings.xml
--rw-r--r--   0 runner    (1001) docker     (127)      318 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/misc.xml
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/modules.xml
--rw-r--r--   0 runner    (1001) docker     (127)      417 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/returnn.iml
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tests/PyCharm.idea/scopes/
--rw-r--r--   0 runner    (1001) docker     (127)      139 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/PyCharm.idea/scopes/scope_settings.xml
--rw-r--r--   0 runner    (1001) docker     (127)      871 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/_set_num_threads1.py
--rw-r--r--   0 runner    (1001) docker     (127)      476 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/_setup_returnn_env.py
--rw-r--r--   0 runner    (1001) docker     (127)     8103 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/_setup_test_env.py
--rw-r--r--   0 runner    (1001) docker     (127)      794 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/bpe-unicode-demo.codes
--rw-r--r--   0 runner    (1001) docker     (127)     2205 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/bpe-unicode-demo.vocab
--rw-r--r--   0 runner    (1001) docker     (127)      386 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/lexicon_opt.fst
--rw-r--r--   0 runner    (1001) docker     (127)      520 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/lexicon_opt.isyms
--rw-r--r--   0 runner    (1001) docker     (127)    34282 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/lexicon_opt.jpg
--rw-r--r--   0 runner    (1001) docker     (127)       41 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/lexicon_opt.osyms
--rw-r--r--   0 runner    (1001) docker     (127)     6880 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/lint_common.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    29203 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/pycharm-inspect.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     2960 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/pylint.py
--rw-r--r--   0 runner    (1001) docker     (127)     2963 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/returnn-as-framework.py
--rw-r--r--   0 runner    (1001) docker     (127)    12922 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/rf_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      617 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/spelling.dic
--rw-r--r--   0 runner    (1001) docker     (127)    13025 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_Config.py
--rw-r--r--   0 runner    (1001) docker     (127)    25868 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_Dataset.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    13634 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_Fsa.py
--rw-r--r--   0 runner    (1001) docker     (127)     8904 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_GeneratingDataset.py
--rw-r--r--   0 runner    (1001) docker     (127)    32796 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_HDFDataset.py
--rw-r--r--   0 runner    (1001) docker     (127)    10327 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_LearningRateControl.py
--rw-r--r--   0 runner    (1001) docker     (127)     7187 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_Log.py
--rw-r--r--   0 runner    (1001) docker     (127)     7420 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_MultiProcDataset.py
--rw-r--r--   0 runner    (1001) docker     (127)     2465 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_Pretrain.py
--rw-r--r--   0 runner    (1001) docker     (127)    21403 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_ResNet.py
--rw-r--r--   0 runner    (1001) docker     (127)     5014 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_SprintDataset.py
--rw-r--r--   0 runner    (1001) docker     (127)     3330 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_SprintInterface.py
--rw-r--r--   0 runner    (1001) docker     (127)   238202 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFEngine.py
--rw-r--r--   0 runner    (1001) docker     (127)   135447 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFNativeOp.py
--rw-r--r--   0 runner    (1001) docker     (127)   563530 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFNetworkLayer.py
--rw-r--r--   0 runner    (1001) docker     (127)   602155 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFNetworkRecLayer.py
--rw-r--r--   0 runner    (1001) docker     (127)    14485 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFNetworkSigProcLayer.py
--rw-r--r--   0 runner    (1001) docker     (127)    20306 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFUpdater.py
--rw-r--r--   0 runner    (1001) docker     (127)   194602 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TFUtil.py
--rw-r--r--   0 runner    (1001) docker     (127)     3082 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TF_determinism.py
--rw-r--r--   0 runner    (1001) docker     (127)     2156 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TaskSystem.py
--rw-r--r--   0 runner    (1001) docker     (127)     5088 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TaskSystem_SharedMem.py
--rw-r--r--   0 runner    (1001) docker     (127)     9402 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_TranslationDataset.py
--rw-r--r--   0 runner    (1001) docker     (127)    17065 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_Util.py
--rw-r--r--   0 runner    (1001) docker     (127)    15016 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_demos.py
--rw-r--r--   0 runner    (1001) docker     (127)     7457 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_fork_exec.py
--rw-r--r--   0 runner    (1001) docker     (127)     2893 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_hdf_dump.py
--rw-r--r--   0 runner    (1001) docker     (127)    12024 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_array.py
--rw-r--r--   0 runner    (1001) docker     (127)    10293 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_attention.py
--rw-r--r--   0 runner    (1001) docker     (127)    14009 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_base.py
--rw-r--r--   0 runner    (1001) docker     (127)     9490 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_cond.py
--rw-r--r--   0 runner    (1001) docker     (127)      765 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_const.py
--rw-r--r--   0 runner    (1001) docker     (127)     5383 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_container.py
--rw-r--r--   0 runner    (1001) docker     (127)    13403 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_conv.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_encoder_conformer.py
--rw-r--r--   0 runner    (1001) docker     (127)     1040 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_gradient.py
--rw-r--r--   0 runner    (1001) docker     (127)     1437 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_label_smoothing.py
--rw-r--r--   0 runner    (1001) docker     (127)     7832 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_loop.py
--rw-r--r--   0 runner    (1001) docker     (127)     2960 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_math.py
--rw-r--r--   0 runner    (1001) docker     (127)     1960 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_normalization.py
--rw-r--r--   0 runner    (1001) docker     (127)    15487 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_rec.py
--rw-r--r--   0 runner    (1001) docker     (127)     5020 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_reduce.py
--rw-r--r--   0 runner    (1001) docker     (127)     3267 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_rf_signal.py
--rw-r--r--   0 runner    (1001) docker     (127)     1135 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_tensor.py
--rw-r--r--   0 runner    (1001) docker     (127)     8435 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_tools.py
--rw-r--r--   0 runner    (1001) docker     (127)     6835 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_torch_dataset.py
--rw-r--r--   0 runner    (1001) docker     (127)    21080 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_torch_engine.py
--rw-r--r--   0 runner    (1001) docker     (127)    22437 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_torch_frontend.py
--rw-r--r--   0 runner    (1001) docker     (127)    26213 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tests/test_torch_internal_frontend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tools/
--rw-r--r--   0 runner    (1001) docker     (127)      476 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/_setup_returnn_env.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9650 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/analyze-dataset-batches.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3943 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/bliss-collect-seq-lens.py
--rwxr-xr-x   0 runner    (1001) docker     (127)      780 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/bliss-dump-text.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     6608 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/bliss-get-segment-names.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    18501 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/bliss-to-ogg-zip.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     5644 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/bpe-create-lexicon.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    10532 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/calculate-word-error-rate.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     1791 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/cleanup-old-models.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    10841 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/collect-orth-symbols.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     6828 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/collect-words.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     4379 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/compile_native_op.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    81620 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/compile_tf_graph.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     8500 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/debug-dump-search-scores.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    47001 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/debug-plot-search-scores.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     6048 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/dump-dataset-raw-strings.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    12518 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/dump-dataset.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     5770 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/dump-forward-stats.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     2576 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/dump-forward.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     1596 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/dump-network-json.py
--rwxr-xr-x   0 runner    (1001) docker     (127)      719 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/dump-pickle.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    16425 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/extract_state_tying_from_dataset.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    14986 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/get-attention-weights.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     2936 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/get-best-model-epoch.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3900 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/hdf_dump.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    19622 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/hdf_dump_translation_dataset.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    49563 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/import-blocks-mt-model.py
--rwxr-xr-x   0 runner    (1001) docker     (127)    31498 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/import-t2t-mt-model.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tools/lattice_rescorer/
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/.gitignore
--rw-r--r--   0 runner    (1001) docker     (127)     2254 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/Makefile
--rw-r--r--   0 runner    (1001) docker     (127)     7825 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/
--rw-r--r--   0 runner    (1001) docker     (127)     1282 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      100 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/libs_list
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-03-27 16:14:27.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/network.040/
--rw-r--r--   0 runner    (1001) docker     (127)     5775 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.config
--rw-r--r--   0 runner    (1001) docker     (127)     6110 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.keep_over_epoch.lstm2.config
--rwxr-xr-x   0 runner    (1001) docker     (127)      800 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/rescore_lattice.sh
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/state_vars_list
--rw-r--r--   0 runner    (1001) docker     (127)      155 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/example/tensor_names_list
--rw-r--r--   0 runner    (1001) docker     (127)     1687 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/file.h
--rw-r--r--   0 runner    (1001) docker     (127)    26055 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/htklatticerescorer.cc
--rw-r--r--   0 runner    (1001) docker     (127)    10856 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/htklatticerescorer.h
--rw-r--r--   0 runner    (1001) docker     (127)    12488 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/main.cc
--rw-r--r--   0 runner    (1001) docker     (127)     2184 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/rescorer.h
--rw-r--r--   0 runner    (1001) docker     (127)     5563 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/vocabulary.cc
--rw-r--r--   0 runner    (1001) docker     (127)     3023 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/lattice_rescorer/vocabulary.h
--rwxr-xr-x   0 runner    (1001) docker     (127)     5438 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/tf_avg_checkpoints.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     6269 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/tf_inspect_checkpoint.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     1288 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/tf_inspect_summary_log.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     4357 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/torch_avg_checkpoints.py
--rw-r--r--   0 runner    (1001) docker     (127)    11104 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/torch_export_to_onnx.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     8715 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/torch_inspect_checkpoint.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3090 2024-03-27 16:14:07.000000 returnn-1.20240327.165809/tools/torch_inspect_checkpoint_and_opt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/
+-rw-r--r--   0 runner    (1001) docker     (127)      198 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/.editorconfig
+-rw-r--r--   0 runner    (1001) docker     (127)      526 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/.gitignore
+-rw-r--r--   0 runner    (1001) docker     (127)      828 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/.gitmodules
+-rw-r--r--   0 runner    (1001) docker     (127)       79 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/.kateconfig
+-rw-r--r--   0 runner    (1001) docker     (127)     8556 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/CHANGELOG.md
+-rw-r--r--   0 runner    (1001) docker     (127)      704 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/CODEOWNERS
+-rw-r--r--   0 runner    (1001) docker     (127)     4880 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/CONTRIBUTING.md
+-rw-r--r--   0 runner    (1001) docker     (127)    10751 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)     4718 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     3573 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/README.rst
+-rw-r--r--   0 runner    (1001) docker     (127)     1171 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)       77 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/_setup_info_generated.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/
+-rw-r--r--   0 runner    (1001) docker     (127)    36006 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/12AX.cluster_map
+-rw-r--r--   0 runner    (1001) docker     (127)      476 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/_setup_returnn_env.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1174 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-fwd.config
+-rw-r--r--   0 runner    (1001) docker     (127)     2703 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-horovod-mpi.py
+-rw-r--r--   0 runner    (1001) docker     (127)      520 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-horovod-mpi.py.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      264 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-horovod-mpi.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     1756 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-hyper-param-tuning.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2396 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-iter-dataset.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3635 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-list-devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2848 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-lua-torch-layer.config
+-rw-r--r--   0 runner    (1001) docker     (127)      487 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-pretrain.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2331 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-record-and-push-to-webserver.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1950 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-returnn-as-framework.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24864 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-rf-pt-benchmark.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3216 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-rf.config
+-rw-r--r--   0 runner    (1001) docker     (127)     2331 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-rhn-enwik8.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1378 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-sprint-interface.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3147 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-att-copy.config
+-rw-r--r--   0 runner    (1001) docker     (127)     2428 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-attention.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1481 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-chunking-blstm.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1416 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-contribrnn-lstm.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     3073 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-enc-dec.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)    11615 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-hard-att-copy.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)     7287 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-lstm-benchmark.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1527 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-maxgradnorm-lstm.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1413 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-native-lstm-lowmem.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1576 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-native-lstm.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1768 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-native-lstm2.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1075 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-native-lstm2.12ax.tuned.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1794 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-neural-transducer.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1825 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-rec-explicit-lstm.config
+-rw-r--r--   0 runner    (1001) docker     (127)     1202 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-rec-explicit-rnn.config
+-rw-r--r--   0 runner    (1001) docker     (127)     2018 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-rec-self-att.config
+-rw-r--r--   0 runner    (1001) docker     (127)     5188 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-search-compiled-graph.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1430 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-tf-vanilla-lstm.12ax.config
+-rw-r--r--   0 runner    (1001) docker     (127)     4818 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-timit-lstm-ctc.config
+-rw-r--r--   0 runner    (1001) docker     (127)     3174 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-torch.config
+-rw-r--r--   0 runner    (1001) docker     (127)      766 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo-upd-mult-model.lstm.12ax.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)      651 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/demo.sh
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/
+-rwxr-xr-x   0 runner    (1001) docker     (127)    43239 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/a01-000u-00.png
+-rwxr-xr-x   0 runner    (1001) docker     (127)    43552 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/a01-007-04.png
+-rwxr-xr-x   0 runner    (1001) docker     (127)    45111 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/a01-007-06.png
+-rw-r--r--   0 runner    (1001) docker     (127)     1709 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/README.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      158 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/chars.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1896 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/config_demo
+-rw-r--r--   0 runner    (1001) docker     (127)     1981 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/config_fwd
+-rw-r--r--   0 runner    (1001) docker     (127)     1983 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/config_real
+-rwxr-xr-x   0 runner    (1001) docker     (127)    10194 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/create_IAM_dataset.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)      749 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/decode.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/features/
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/features/raw/
+-rw-r--r--   0 runner    (1001) docker     (127)   248580 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/features/raw/demo.h5
+-rwxr-xr-x   0 runner    (1001) docker     (127)       86 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/go.sh
+-rw-r--r--   0 runner    (1001) docker     (127)      235 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/lines.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/split/
+-rw-r--r--   0 runner    (1001) docker     (127)     2712 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/split/eval.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    69536 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/split/train.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      934 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/IAM/split/valid.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      230 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/artificial/
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2804 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial/create_test_h5.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1055 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial/forwardconfig
+-rwxr-xr-x   0 runner    (1001) docker     (127)      105 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial/go.sh
+-rw-r--r--   0 runner    (1001) docker     (127)      970 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial/trainconfig
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2966 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/create_test_h5.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1055 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/forwardconfig
+-rwxr-xr-x   0 runner    (1001) docker     (127)      105 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/go.sh
+-rw-r--r--   0 runner    (1001) docker     (127)      970 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/trainconfig
+-rw-r--r--   0 runner    (1001) docker     (127)      463 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)      110 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/requirements.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/
+-rw-r--r--   0 runner    (1001) docker     (127)     1012 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30829 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/__main__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7654 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/__old_mod_loader__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4659 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/__setup__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27474 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/config.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/datasets/
+-rw-r--r--   0 runner    (1001) docker     (127)      390 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19602 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/audio.py
+-rw-r--r--   0 runner    (1001) docker     (127)    64342 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/basic.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2388 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/bundle_file.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25090 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/cached.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11722 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/cached2.py
+-rw-r--r--   0 runner    (1001) docker     (127)    99033 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/generating.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65175 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/hdf.py
+-rw-r--r--   0 runner    (1001) docker     (127)    85507 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/lm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10892 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/map.py
+-rw-r--r--   0 runner    (1001) docker     (127)    77105 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/meta.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15551 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/multi_proc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14596 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/normalization_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5291 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/numpy_dump.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9127 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/raw_wav.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55408 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/sprint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17608 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/stereo.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/datasets/util/
+-rw-r--r--   0 runner    (1001) docker     (127)       52 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23915 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/util/feature_extraction.py
+-rw-r--r--   0 runner    (1001) docker     (127)      413 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/util/strings.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20888 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/datasets/util/vocabulary.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/engine/
+-rw-r--r--   0 runner    (1001) docker     (127)      228 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/engine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17448 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/engine/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9912 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/engine/batch.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/
+-rw-r--r--   0 runner    (1001) docker     (127)     4005 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4024 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/__main__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/
+-rw-r--r--   0 runner    (1001) docker     (127)       65 2024-05-13 21:38:03.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/.git
+-rw-r--r--   0 runner    (1001) docker     (127)        6 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/.gitignore
+-rw-r--r--   0 runner    (1001) docker     (127)     1069 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)     1448 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)    13770 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/aligner.gif
+-rw-r--r--   0 runner    (1001) docker     (127)    51077 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/check.png
+-rw-r--r--   0 runner    (1001) docker     (127)    11544 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/core.cu
+-rw-r--r--   0 runner    (1001) docker     (127)      975 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/core.h
+-rw-r--r--   0 runner    (1001) docker     (127)     2512 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/core_cpu.cpp
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/
+-rw-r--r--   0 runner    (1001) docker     (127)     1069 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)       70 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)     2089 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/binding.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)    11544 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.cu
+-rw-r--r--   0 runner    (1001) docker     (127)      975 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.h
+-rw-r--r--   0 runner    (1001) docker     (127)       28 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/requirements.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2079 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/
+-rw-r--r--   0 runner    (1001) docker     (127)     2885 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6961 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/test.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4141 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/ref_rna.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/
+-rw-r--r--   0 runner    (1001) docker     (127)     6150 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/
+-rw-r--r--   0 runner    (1001) docker     (127)     1689 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op.cc
+-rw-r--r--   0 runner    (1001) docker     (127)     6030 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op_kernel_tmpl.h
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/warp_rna/
+-rw-r--r--   0 runner    (1001) docker     (127)     2076 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/warp_rna/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4252 2024-05-13 21:38:05.000000 returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/test.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)      135 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/
+-rw-r--r--   0 runner    (1001) docker     (127)      257 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)     1239 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8479 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/edit.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19826 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/reroute.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29792 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/select.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26578 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/subgraph.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29372 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/transform.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18723 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/extern/graph_editor/util.py
+-rw-r--r--   0 runner    (1001) docker     (127)      911 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/forward_iface.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/frontend/
+-rw-r--r--   0 runner    (1001) docker     (127)     1295 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47607 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/frontend/_native/
+-rw-r--r--   0 runner    (1001) docker     (127)     6407 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4768 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/backend.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)      791 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/backend.hpp
+-rw-r--r--   0 runner    (1001) docker     (127)    15521 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/module.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)     6670 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/module.hpp
+-rw-r--r--   0 runner    (1001) docker     (127)     3139 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/py_utils.hpp
+-rw-r--r--   0 runner    (1001) docker     (127)    70068 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/tensor_ops.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_native/tensor_ops.hpp
+-rw-r--r--   0 runner    (1001) docker     (127)     6173 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_numpy_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5445 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_random_journal.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12068 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29840 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/array_.py
+-rw-r--r--   0 runner    (1001) docker     (127)    40728 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/attention.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/frontend/audio/
+-rw-r--r--   0 runner    (1001) docker     (127)       67 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/audio/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7645 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/audio/mel.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5604 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/audio/specaugment.py
+-rw-r--r--   0 runner    (1001) docker     (127)      883 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1023 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/cond.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3945 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/const.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7606 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/container.py
+-rw-r--r--   0 runner    (1001) docker     (127)      699 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/control_flow_ctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22353 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/conv.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/frontend/decoder/
+-rw-r--r--   0 runner    (1001) docker     (127)       41 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/decoder/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14378 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/decoder/transformer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1438 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/device.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4954 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/dims.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5006 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/dropout.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/dtype.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/frontend/encoder/
+-rw-r--r--   0 runner    (1001) docker     (127)       17 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/encoder/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2109 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/encoder/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15776 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/encoder/conformer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2372 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/gradient.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1818 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/graph.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5507 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/hooks.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7494 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/init.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4409 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/label_smoothing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2244 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/linear.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15498 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/loop.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3040 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/loss.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14956 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/math_.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1945 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/matmul.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10700 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/module.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10198 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/normalization.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8531 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/parameter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/rand.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7847 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/rec.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7225 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/reduce.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20105 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/run_ctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4078 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/signal.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2935 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4328 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/tensor_array.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1270 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/frontend/types.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/import_/
+-rw-r--r--   0 runner    (1001) docker     (127)      243 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/import_/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8148 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/import_/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13961 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/import_/git.py
+-rw-r--r--   0 runner    (1001) docker     (127)      798 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/import_/import_.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34623 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/learning_rate_control.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12351 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/log.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35760 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/native_op.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)   244419 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/native_op.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23542 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/pretrain.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/sprint/
+-rw-r--r--   0 runner    (1001) docker     (127)       64 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/sprint/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35134 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/sprint/cache.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31142 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/sprint/control.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23348 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/sprint/error_signals.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/sprint/extern_interface.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36521 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/sprint/interface.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/tensor/
+-rw-r--r--   0 runner    (1001) docker     (127)      501 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      154 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   116423 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/_dim_extra.py
+-rw-r--r--   0 runner    (1001) docker     (127)   164824 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/_tensor_extra.py
+-rw-r--r--   0 runner    (1001) docker     (127)      643 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/_tensor_mixin_base.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5018 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/_tensor_op_overloads.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5252 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/control_flow_ctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4002 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/dim.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1884 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/marked_dim.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9087 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/tensor.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6965 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/tensor_dict.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9566 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tensor/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/tf/
+-rw-r--r--   0 runner    (1001) docker     (127)       88 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1632 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/compat.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36646 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/data_pipeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15108 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)   147333 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/engine.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/
+-rw-r--r--   0 runner    (1001) docker     (127)     1096 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      506 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46388 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4205 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14830 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/cond.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5583 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/config_entry_points.py
+-rw-r--r--   0 runner    (1001) docker     (127)      888 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/debug_eager_mode.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5712 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/dims.py
+-rw-r--r--   0 runner    (1001) docker     (127)    72976 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/layer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26710 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/loop.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16216 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/make_layer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3999 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/masked_computation.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5103 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/parameter_assign.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_layers/prev_tensor_ref.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/tf/frontend_low_level/
+-rw-r--r--   0 runner    (1001) docker     (127)       62 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_low_level/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23145 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/frontend_low_level/_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5404 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/horovod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31611 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/hyper_param_tuning.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/tf/layers/
+-rw-r--r--   0 runner    (1001) docker     (127)       72 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   152845 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/base.py
+-rw-r--r--   0 runner    (1001) docker     (127)   609993 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/basic.py
+-rw-r--r--   0 runner    (1001) docker     (127)   547403 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/rec.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21515 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/segmental_model.py
+-rw-r--r--   0 runner    (1001) docker     (127)    52693 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/signal_processing.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11446 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/layers/variable.py
+-rw-r--r--   0 runner    (1001) docker     (127)    79729 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/native_op.py
+-rw-r--r--   0 runner    (1001) docker     (127)   224930 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5471 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/sprint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    71701 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/updater.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/tf/util/
+-rw-r--r--   0 runner    (1001) docker     (127)       92 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   302712 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/util/basic.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29422 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/util/data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6081 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/util/gradient_checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17313 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/util/ken_lm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11265 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/tf/util/open_fst.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)       85 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)       24 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/torch/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      132 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7203 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/data/extern_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16209 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/data/pipeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)      888 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/data/queued_data_iter.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5569 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/data/returnn_dataset_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1284 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/data/tensor_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6266 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)    56903 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/engine.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/torch/frontend/
+-rw-r--r--   0 runner    (1001) docker     (127)       62 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/frontend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    89269 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/frontend/_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1830 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/frontend/_rand.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7239 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/frontend/bridge.py
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/frontend/raw_ops.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26020 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/updater.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/torch/util/
+-rw-r--r--   0 runner    (1001) docker     (127)      193 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/util/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)       26 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5105 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/util/diagnose_gpu.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3192 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/torch/util/scaled_gradient.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn/util/
+-rw-r--r--   0 runner    (1001) docker     (127)      336 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   138774 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/basic.py
+-rw-r--r--   0 runner    (1001) docker     (127)    60303 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/better_exchook.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17977 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/bpe.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18562 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/debug.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2905 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/debug_helpers.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    59177 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/fsa.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2173 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/literal_py_to_pickle.py
+-rw-r--r--   0 runner    (1001) docker     (127)      205 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/math.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8739 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/multi_proc_non_daemonic_spawn.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13180 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/native_code_compiler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8131 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/pprint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14844 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/py-to-pickle.cpp
+-rw-r--r--   0 runner    (1001) docker     (127)      277 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/py_compat.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1708 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/py_ext_mod_compiler.py
+-rw-r--r--   0 runner    (1001) docker     (127)      359 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/result_with_reason.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     7273 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/sig_proc.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26003 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/task_system.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3266 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/train_proc_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4213 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/returnn/util/watch_memory.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)     4718 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/returnn.egg-info/top_level.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)      461 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/rnn.py
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)     4159 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tests/
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3386 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/DummySprintExec.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2743 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm-inspection-profile.xml
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tests/PyCharm.idea/
+-rw-r--r--   0 runner    (1001) docker     (127)       47 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/.gitignore
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/.name
+-rw-r--r--   0 runner    (1001) docker     (127)      512 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/codeStyleSettings.xml
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tests/PyCharm.idea/codeStyles/
+-rw-r--r--   0 runner    (1001) docker     (127)      328 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/codeStyles/Project.xml
+-rw-r--r--   0 runner    (1001) docker     (127)      142 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/codeStyles/codeStyleConfig.xml
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tests/PyCharm.idea/inspectionProfiles/
+-rw-r--r--   0 runner    (1001) docker     (127)     2743 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/inspectionProfiles/Project_Default.xml
+-rw-r--r--   0 runner    (1001) docker     (127)      181 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/inspectionProfiles/profiles_settings.xml
+-rw-r--r--   0 runner    (1001) docker     (127)      318 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/misc.xml
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/modules.xml
+-rw-r--r--   0 runner    (1001) docker     (127)      417 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/returnn.iml
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tests/PyCharm.idea/scopes/
+-rw-r--r--   0 runner    (1001) docker     (127)      139 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/PyCharm.idea/scopes/scope_settings.xml
+-rw-r--r--   0 runner    (1001) docker     (127)      871 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/_set_num_threads1.py
+-rw-r--r--   0 runner    (1001) docker     (127)      476 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/_setup_returnn_env.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8103 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/_setup_test_env.py
+-rw-r--r--   0 runner    (1001) docker     (127)      794 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/bpe-unicode-demo.codes
+-rw-r--r--   0 runner    (1001) docker     (127)     2205 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/bpe-unicode-demo.vocab
+-rw-r--r--   0 runner    (1001) docker     (127)      386 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/lexicon_opt.fst
+-rw-r--r--   0 runner    (1001) docker     (127)      520 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/lexicon_opt.isyms
+-rw-r--r--   0 runner    (1001) docker     (127)    34282 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/lexicon_opt.jpg
+-rw-r--r--   0 runner    (1001) docker     (127)       41 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/lexicon_opt.osyms
+-rw-r--r--   0 runner    (1001) docker     (127)     6880 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/lint_common.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    29203 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/pycharm-inspect.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2960 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/pylint.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2963 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/returnn-as-framework.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12922 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/rf_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      617 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/spelling.dic
+-rw-r--r--   0 runner    (1001) docker     (127)    13025 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_Config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25868 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_Dataset.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    13634 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_Fsa.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8904 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_GeneratingDataset.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32796 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_HDFDataset.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10327 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_LearningRateControl.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7187 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_Log.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7420 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_MultiProcDataset.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2465 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_Pretrain.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21403 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_ResNet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5014 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_SprintDataset.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3330 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_SprintInterface.py
+-rw-r--r--   0 runner    (1001) docker     (127)   238450 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFEngine.py
+-rw-r--r--   0 runner    (1001) docker     (127)   135447 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFNativeOp.py
+-rw-r--r--   0 runner    (1001) docker     (127)   564103 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFNetworkLayer.py
+-rw-r--r--   0 runner    (1001) docker     (127)   602155 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFNetworkRecLayer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14485 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFNetworkSigProcLayer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20306 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFUpdater.py
+-rw-r--r--   0 runner    (1001) docker     (127)   194602 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TFUtil.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3082 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TF_determinism.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3007 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TaskSystem.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5088 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TaskSystem_SharedMem.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9402 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_TranslationDataset.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18683 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_Util.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15016 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_demos.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7457 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_fork_exec.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2893 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_hdf_dump.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13933 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_array.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10293 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_attention.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14009 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_base.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9490 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_cond.py
+-rw-r--r--   0 runner    (1001) docker     (127)      765 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_const.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5383 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_container.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13403 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_conv.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_encoder_conformer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1040 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_gradient.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1437 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_label_smoothing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7832 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_loop.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2960 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_math.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1960 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_normalization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15487 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_rec.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5020 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_reduce.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3267 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_rf_signal.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1135 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_tensor.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8435 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_tools.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6835 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_torch_dataset.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21080 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_torch_engine.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22437 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_torch_frontend.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26213 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tests/test_torch_internal_frontend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tools/
+-rw-r--r--   0 runner    (1001) docker     (127)      476 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/_setup_returnn_env.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9650 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/analyze-dataset-batches.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3943 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/bliss-collect-seq-lens.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)      780 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/bliss-dump-text.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     6608 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/bliss-get-segment-names.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    18501 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/bliss-to-ogg-zip.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5644 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/bpe-create-lexicon.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    10532 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/calculate-word-error-rate.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1791 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/cleanup-old-models.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    10841 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/collect-orth-symbols.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     6828 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/collect-words.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     4379 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/compile_native_op.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    81620 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/compile_tf_graph.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     8500 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/debug-dump-search-scores.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    47001 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/debug-plot-search-scores.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     6048 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/dump-dataset-raw-strings.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    12596 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/dump-dataset.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5770 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/dump-forward-stats.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2576 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/dump-forward.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1596 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/dump-network-json.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)      719 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/dump-pickle.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    16425 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/extract_state_tying_from_dataset.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    14986 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/get-attention-weights.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2936 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/get-best-model-epoch.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3900 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/hdf_dump.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    19622 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/hdf_dump_translation_dataset.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    49563 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/import-blocks-mt-model.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)    31498 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/import-t2t-mt-model.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tools/lattice_rescorer/
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/.gitignore
+-rw-r--r--   0 runner    (1001) docker     (127)     2254 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/Makefile
+-rw-r--r--   0 runner    (1001) docker     (127)     7825 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/
+-rw-r--r--   0 runner    (1001) docker     (127)     1282 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      100 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/libs_list
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-13 21:38:21.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/network.040/
+-rw-r--r--   0 runner    (1001) docker     (127)     5775 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.config
+-rw-r--r--   0 runner    (1001) docker     (127)     6110 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.keep_over_epoch.lstm2.config
+-rwxr-xr-x   0 runner    (1001) docker     (127)      800 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/rescore_lattice.sh
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/state_vars_list
+-rw-r--r--   0 runner    (1001) docker     (127)      155 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/example/tensor_names_list
+-rw-r--r--   0 runner    (1001) docker     (127)     1687 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/file.h
+-rw-r--r--   0 runner    (1001) docker     (127)    26055 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/htklatticerescorer.cc
+-rw-r--r--   0 runner    (1001) docker     (127)    10856 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/htklatticerescorer.h
+-rw-r--r--   0 runner    (1001) docker     (127)    12488 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/main.cc
+-rw-r--r--   0 runner    (1001) docker     (127)     2184 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/rescorer.h
+-rw-r--r--   0 runner    (1001) docker     (127)     5563 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/vocabulary.cc
+-rw-r--r--   0 runner    (1001) docker     (127)     3023 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/lattice_rescorer/vocabulary.h
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5438 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/tf_avg_checkpoints.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     6269 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/tf_inspect_checkpoint.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1288 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/tf_inspect_summary_log.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     4357 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/torch_avg_checkpoints.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11104 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/torch_export_to_onnx.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     8715 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/torch_inspect_checkpoint.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3090 2024-05-13 21:38:02.000000 returnn-1.20240513.232708/tools/torch_inspect_checkpoint_and_opt.py
```

### Comparing `returnn-1.20240327.165809/.gitignore` & `returnn-1.20240513.232708/.gitignore`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/.gitmodules` & `returnn-1.20240513.232708/.gitmodules`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/CHANGELOG.md` & `returnn-1.20240513.232708/CHANGELOG.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/CODEOWNERS` & `returnn-1.20240513.232708/CODEOWNERS`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/CONTRIBUTING.md` & `returnn-1.20240513.232708/CONTRIBUTING.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/LICENSE` & `returnn-1.20240513.232708/LICENSE`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/MANIFEST.in` & `returnn-1.20240513.232708/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/PKG-INFO` & `returnn-1.20240513.232708/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: returnn
-Version: 1.20240327.165809
+Version: 1.20240513.232708
 Summary: The RWTH extensible training framework for universal recurrent neural networks
 Home-page: https://github.com/rwth-i6/returnn/
 Author: Albert Zeyer
 Author-email: albzey@gmail.com
 License: RETURNN license
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Environment :: Console
```

### Comparing `returnn-1.20240327.165809/README.rst` & `returnn-1.20240513.232708/README.rst`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/__init__.py` & `returnn-1.20240513.232708/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/12AX.cluster_map` & `returnn-1.20240513.232708/demos/12AX.cluster_map`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-fwd.config` & `returnn-1.20240513.232708/demos/demo-fwd.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-horovod-mpi.py` & `returnn-1.20240513.232708/demos/demo-horovod-mpi.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-horovod-mpi.py.sh` & `returnn-1.20240513.232708/demos/demo-horovod-mpi.py.sh`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-hyper-param-tuning.config` & `returnn-1.20240513.232708/demos/demo-hyper-param-tuning.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-iter-dataset.py` & `returnn-1.20240513.232708/demos/demo-iter-dataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-list-devices.py` & `returnn-1.20240513.232708/demos/demo-list-devices.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-lua-torch-layer.config` & `returnn-1.20240513.232708/demos/demo-lua-torch-layer.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-record-and-push-to-webserver.py` & `returnn-1.20240513.232708/demos/demo-record-and-push-to-webserver.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-returnn-as-framework.py` & `returnn-1.20240513.232708/demos/demo-returnn-as-framework.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-rf-pt-benchmark.py` & `returnn-1.20240513.232708/demos/demo-rf-pt-benchmark.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-rf.config` & `returnn-1.20240513.232708/demos/demo-rf.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-rhn-enwik8.config` & `returnn-1.20240513.232708/demos/demo-rhn-enwik8.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-sprint-interface.py` & `returnn-1.20240513.232708/demos/demo-sprint-interface.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-att-copy.config` & `returnn-1.20240513.232708/demos/demo-tf-att-copy.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-attention.config` & `returnn-1.20240513.232708/demos/demo-tf-attention.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-chunking-blstm.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-chunking-blstm.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-contribrnn-lstm.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-contribrnn-lstm.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-enc-dec.config` & `returnn-1.20240513.232708/demos/demo-tf-enc-dec.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-hard-att-copy.config` & `returnn-1.20240513.232708/demos/demo-tf-hard-att-copy.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-lstm-benchmark.py` & `returnn-1.20240513.232708/demos/demo-tf-lstm-benchmark.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-maxgradnorm-lstm.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-maxgradnorm-lstm.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-native-lstm-lowmem.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-native-lstm-lowmem.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-native-lstm.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-native-lstm.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-native-lstm2.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-native-lstm2.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-native-lstm2.12ax.tuned.config` & `returnn-1.20240513.232708/demos/demo-tf-native-lstm2.12ax.tuned.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-neural-transducer.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-neural-transducer.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-rec-explicit-lstm.config` & `returnn-1.20240513.232708/demos/demo-tf-rec-explicit-lstm.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-rec-explicit-rnn.config` & `returnn-1.20240513.232708/demos/demo-tf-rec-explicit-rnn.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-rec-self-att.config` & `returnn-1.20240513.232708/demos/demo-tf-rec-self-att.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-search-compiled-graph.py` & `returnn-1.20240513.232708/demos/demo-tf-search-compiled-graph.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-tf-vanilla-lstm.12ax.config` & `returnn-1.20240513.232708/demos/demo-tf-vanilla-lstm.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-timit-lstm-ctc.config` & `returnn-1.20240513.232708/demos/demo-timit-lstm-ctc.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-torch.config` & `returnn-1.20240513.232708/demos/demo-torch.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo-upd-mult-model.lstm.12ax.config` & `returnn-1.20240513.232708/demos/demo-upd-mult-model.lstm.12ax.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/demo.sh` & `returnn-1.20240513.232708/demos/demo.sh`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/a01-000u-00.png` & `returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/a01-000u-00.png`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/a01-007-04.png` & `returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/a01-007-04.png`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/IAM_lines/a01-007-06.png` & `returnn-1.20240513.232708/demos/mdlstm/IAM/IAM_lines/a01-007-06.png`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/README.txt` & `returnn-1.20240513.232708/demos/mdlstm/IAM/README.txt`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/config_demo` & `returnn-1.20240513.232708/demos/mdlstm/IAM/config_demo`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/config_fwd` & `returnn-1.20240513.232708/demos/mdlstm/IAM/config_fwd`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/config_real` & `returnn-1.20240513.232708/demos/mdlstm/IAM/config_real`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/create_IAM_dataset.py` & `returnn-1.20240513.232708/demos/mdlstm/IAM/create_IAM_dataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/decode.py` & `returnn-1.20240513.232708/demos/mdlstm/IAM/decode.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/features/raw/demo.h5` & `returnn-1.20240513.232708/demos/mdlstm/IAM/features/raw/demo.h5`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/split/eval.txt` & `returnn-1.20240513.232708/demos/mdlstm/IAM/split/eval.txt`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/split/train.txt` & `returnn-1.20240513.232708/demos/mdlstm/IAM/split/train.txt`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/IAM/split/valid.txt` & `returnn-1.20240513.232708/demos/mdlstm/IAM/split/valid.txt`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/artificial/create_test_h5.py` & `returnn-1.20240513.232708/demos/mdlstm/artificial/create_test_h5.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/artificial/forwardconfig` & `returnn-1.20240513.232708/demos/mdlstm/artificial/forwardconfig`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/artificial/trainconfig` & `returnn-1.20240513.232708/demos/mdlstm/artificial/trainconfig`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/create_test_h5.py` & `returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/create_test_h5.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/forwardconfig` & `returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/forwardconfig`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/demos/mdlstm/artificial_rgb/trainconfig` & `returnn-1.20240513.232708/demos/mdlstm/artificial_rgb/trainconfig`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/__init__.py` & `returnn-1.20240513.232708/returnn/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/__main__.py` & `returnn-1.20240513.232708/returnn/__main__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/__old_mod_loader__.py` & `returnn-1.20240513.232708/returnn/__old_mod_loader__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/__setup__.py` & `returnn-1.20240513.232708/returnn/__setup__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/config.py` & `returnn-1.20240513.232708/returnn/config.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/audio.py` & `returnn-1.20240513.232708/returnn/datasets/audio.py`

 * *Files 2% similar despite different names*

```diff
@@ -46,14 +46,15 @@
         audio,
         targets,
         targets_post_process=None,
         use_cache_manager=False,
         segment_file=None,
         zip_audio_files_have_name_as_prefix=True,
         fixed_random_subset=None,
+        fixed_random_subset_seed=42,
         epoch_wise_filter=None,
         **kwargs,
     ):
         """
         :param str|list[str] path: filename to zip
         :param dict[str]|None audio: options for :class:`ExtractAudioFeatures`.
             use {} for default. None means to disable.
@@ -64,15 +65,16 @@
         :param bool use_cache_manager: uses :func:`Util.cf`
         :param str|None segment_file: .txt or .gz text file containing sequence tags that will be used as whitelist
         :param bool zip_audio_files_have_name_as_prefix:
         :param float|int|None fixed_random_subset:
           Value in [0,1] to specify the fraction, or integer >=1 which specifies number of seqs.
           If given, will use this random subset. This will be applied initially at loading time,
           i.e. not dependent on the epoch.
-          It will use an internally hardcoded fixed random seed, i.e. it's deterministic.
+          It uses the fixed fixed_random_subset_seed as seed, i.e. it's deterministic.
+        :param int fixed_random_subset_seed: Seed for drawing the fixed random subset, default 42
         :param dict|None epoch_wise_filter: see init_seq_order
         """
         import os
         import zipfile
         import returnn.util.basic
         from .meta import EpochWiseFilter
 
@@ -149,14 +151,15 @@
             self.num_outputs["classes"] = [self.targets.num_labels, 1]
         if self.feature_extractor:
             self.num_outputs["data"] = [self.num_inputs, 2]
         else:
             self.num_outputs["data"] = [0, 2]
         self._data: Optional[List[Dict[str, Any]]] = None  # lazily loaded
         self._fixed_random_subset = fixed_random_subset
+        self._fixed_random_subset_seed = fixed_random_subset_seed
         if epoch_wise_filter is None:
             self.epoch_wise_filter = None  # type: Optional[EpochWiseFilter]
         elif isinstance(epoch_wise_filter, dict):
             self.epoch_wise_filter = EpochWiseFilter(epoch_wise_filter)
         else:
             assert isinstance(epoch_wise_filter, EpochWiseFilter)
             self.epoch_wise_filter = epoch_wise_filter
@@ -245,15 +248,15 @@
         )
 
         fixed_random_subset = self._fixed_random_subset
         if fixed_random_subset:
             if 0 < fixed_random_subset < 1:
                 fixed_random_subset = int(len(data) * fixed_random_subset)
             assert isinstance(fixed_random_subset, int) and fixed_random_subset > 0
-            rnd = numpy.random.RandomState(42)
+            rnd = numpy.random.RandomState(self._fixed_random_subset_seed)
             rnd.shuffle(data)
             data = data[:fixed_random_subset]
 
         self._data = data
 
     def finish_epoch(self, *, free_resources: bool = False):
         """finish epoch"""
```

### Comparing `returnn-1.20240327.165809/returnn/datasets/basic.py` & `returnn-1.20240513.232708/returnn/datasets/basic.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/bundle_file.py` & `returnn-1.20240513.232708/returnn/datasets/bundle_file.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/cached.py` & `returnn-1.20240513.232708/returnn/datasets/cached.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/cached2.py` & `returnn-1.20240513.232708/returnn/datasets/cached2.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/generating.py` & `returnn-1.20240513.232708/returnn/datasets/generating.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/hdf.py` & `returnn-1.20240513.232708/returnn/datasets/hdf.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/lm.py` & `returnn-1.20240513.232708/returnn/datasets/lm.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/map.py` & `returnn-1.20240513.232708/returnn/datasets/map.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/meta.py` & `returnn-1.20240513.232708/returnn/datasets/meta.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/multi_proc.py` & `returnn-1.20240513.232708/returnn/datasets/multi_proc.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/normalization_data.py` & `returnn-1.20240513.232708/returnn/datasets/normalization_data.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/numpy_dump.py` & `returnn-1.20240513.232708/returnn/datasets/numpy_dump.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/raw_wav.py` & `returnn-1.20240513.232708/returnn/datasets/raw_wav.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/sprint.py` & `returnn-1.20240513.232708/returnn/datasets/sprint.py`

 * *Files 0% similar despite different names*

```diff
@@ -398,17 +398,17 @@
             ), "Number of targets %s does not match number of features %s (reduce factor %d)" % (
                 # is in format (time,)
                 targets["classes"].shape,
                 (num_frames,),
                 self.reduce_target_factor,
             )
         if "speaker_name" in targets:
-            targets["speaker_name"] = targets["speaker_name"].decode("utf8").strip()
+            targets["speaker_name"] = targets["speaker_name"].strip()
         if "orth" in targets:
-            targets["orth"] = targets["orth"].decode("utf8").strip()
+            targets["orth"] = targets["orth"].strip()
         if "orth" in targets and self.orth_post_process:
             targets["orth"] = self.orth_post_process(targets["orth"])
         if self.bpe:
             assert "orth" in targets
             orth = targets["orth"]
             assert isinstance(orth, (str, unicode))
             assert "bpe" not in targets
@@ -811,15 +811,15 @@
         # parent
         self.pipe_c2p[1].close()
         self.pipe_p2c[0].close()
         self.child_pid = pid
 
         try:
             init_signal, (input_dim, output_dim, num_segments) = self._read_next_raw()
-            assert init_signal == b"init"
+            assert init_signal == "init"
             assert isinstance(input_dim, int) and isinstance(output_dim, int)
             # Ignore num_segments. It can be totally different than the real number of sequences.
             self.set_dimensions(input_dim, output_dim)
         except Exception:
             print("%s: Sprint child process (%r) caused an exception." % (self, args), file=log.v1)
             sys.excepthook(*sys.exc_info())
             self._exit_child(wait_thread=False)
@@ -918,17 +918,15 @@
         return args
 
     def _read_next_raw(self):
         """
         :return: (data_type, args)
         :rtype: (str, object)
         """
-        # encoding is for converting Python2 strings to Python3.
-        # Cannot use utf8 because Numpy will also encode the data as strings and there we need it as bytes.
-        data_type, args = util.read_pickled_object(self.pipe_c2p[0], encoding="bytes")
+        data_type, args = util.read_pickled_object(self.pipe_c2p[0])
         return data_type, args
 
     def _join_child(self, wait=True, expected_exit_status=None):
         """
         :param bool wait:
         :param int|None expected_exit_status:
         :return: whether the child has exited now
@@ -970,28 +968,24 @@
 
                 with self.lock:
                     if epoch != self.returnn_epoch:
                         break
                     if self.python_exit or not self.child_pid:
                         break
 
-                    if data_type == b"data":
+                    if data_type == "data":
                         seq_count += 1
                         segment_name, features, targets = args
-                        if segment_name is not None:
-                            segment_name = segment_name.decode("utf8")
                         assert isinstance(features, numpy.ndarray)
-                        if isinstance(targets, dict):
-                            targets = {key.decode("utf8"): value for (key, value) in targets.items()}
                         self.add_new_data(
                             numpy_copy_and_set_unused(features),
                             numpy_copy_and_set_unused(targets),
                             segment_name=segment_name,
                         )
-                    elif data_type == b"exit":
+                    elif data_type == "exit":
                         have_seen_the_whole = True
                         break
                     else:
                         assert False, "not handled: (%r, %r)" % (data_type, args)
 
             if self.seq_list_file:
                 try:
@@ -1144,23 +1138,23 @@
             """
             :param str name: content-filename for sprint cache
             :return: numpy array of shape (time, [num_labels])
             :rtype: numpy.ndarray
             """
             res = self.sprint_cache.read(name, typ=self.type)
             if self.type == "align":
-                for (t, a, s, w) in res:
+                for t, a, s, w in res:
                     assert w == 1, "soft alignment not supported"
                 label_seq = numpy.array(
                     [self.allophone_labeling.get_label_idx(a, s) for (t, a, s, w) in res], dtype=self.dtype
                 )
                 assert label_seq.shape == (len(res),)
                 return label_seq
             elif self.type == "align_raw":
-                for (t, a, s, w) in res:
+                for t, a, s, w in res:
                     assert w == 1, "soft alignment not supported"
                 label_seq = numpy.array(
                     [self.allophone_labeling.state_tying_by_allo_state_idx[a] for (t, a, s, w) in res], dtype=self.dtype
                 )
                 assert label_seq.shape == (len(res),)
                 return label_seq
             elif self.type == "feat":
```

### Comparing `returnn-1.20240327.165809/returnn/datasets/stereo.py` & `returnn-1.20240513.232708/returnn/datasets/stereo.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/util/feature_extraction.py` & `returnn-1.20240513.232708/returnn/datasets/util/feature_extraction.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/datasets/util/vocabulary.py` & `returnn-1.20240513.232708/returnn/datasets/util/vocabulary.py`

 * *Files 5% similar despite different names*

```diff
@@ -9,17 +9,17 @@
     "BytePairEncoding",
     "SamplingBytePairEncoding",
     "SentencePieces",
     "CharacterTargets",
     "Utf8ByteTargets",
 ]
 
-import sys
+from typing import Optional, Union, Type, List
 import typing
-
+import sys
 import numpy
 
 from returnn.log import log
 
 
 class Vocabulary(object):
     """
@@ -103,21 +103,21 @@
             parts.append("bos_label=%r" % self.id_to_label(self.bos_label_id))
         if self.eos_label_id is not None:
             parts.append("eos_label=%r" % self.id_to_label(self.eos_label_id))
         if self.pad_label_id is not None:
             parts.append("pad_label=%r" % self.id_to_label(self.pad_label_id))
         return "%s(%s)" % (self.__class__.__name__, ", ".join(parts))
 
-    def set_random_seed(self, seed):
+    def set_random_seed(self, seed: int):
         """
         This can be called for a new epoch or so.
         Usually it has no effect, as there is no randomness.
         However, some vocab class could introduce some sampling process.
 
-        :param int seed:
+        :param seed:
         """
         pass  # usually there is no randomness, so ignore
 
     def _parse_vocab(self):
         """
         Sets self.vocab, self.labels, self.num_labels.
         """
@@ -201,20 +201,24 @@
             """
             :param tensorflow.Session session:
             """
             VariableAssigner(var).assign(session=session, value=self._labels)
 
         return init_vocab_var
 
-    def to_id(self, label, default=KeyError, allow_none=False):
-        """
-        :param str|int|None label:
-        :param str|type[KeyError]|None default:
-        :param bool allow_none: whether label can be None. in this case, None is returned
-        :rtype: int|None
+    def to_id(
+        self,
+        label: Union[str, int, None],
+        default: Union[str, Type[KeyError], None] = KeyError,
+        allow_none: bool = False,
+    ) -> Optional[int]:
+        """
+        :param label:
+        :param default:
+        :param allow_none: whether label can be None. in this case, None is returned
         """
         if isinstance(label, str):
             return self.label_to_id(label, default=default)
         if isinstance(label, int):
             if label == -1 and allow_none:
                 return None
             if self.is_id_valid(label):
@@ -222,73 +226,71 @@
             if default is KeyError:
                 raise KeyError("invalid label id %i" % label)
             return None
         if label is None and allow_none:
             return None
         raise TypeError("invalid label type %r" % type(label))
 
-    def label_to_id(self, label, default=KeyError):
+    def label_to_id(self, label: str, default: Union[int, Type[KeyError], None] = KeyError) -> Optional[int]:
         """
-        :param str label:
-        :param int|type[KeyError]|None default:
-        :rtype: int|None
+        :param label:
+        :param default:
         """
         if default is KeyError:
             return self._vocab[label]
         return self._vocab.get(label, default)
 
-    def id_to_label(self, idx, default=KeyError):
+    def id_to_label(self, idx: int, default: Union[str, Type[KeyError], None] = KeyError) -> Optional[str]:
         """
-        :param int idx:
-        :param str|KeyError|None default:
-        :rtype: str|None
+        :param idx:
+        :param default:
         """
         if self.is_id_valid(idx):
             return self._labels[idx]
         if default is KeyError:
             raise KeyError("idx %i out of range" % idx)
         return default
 
-    def is_id_valid(self, idx):
+    def is_id_valid(self, idx: int) -> bool:
         """
-        :param int idx:
-        :rtype: bool
+        :param idx:
         """
         return 0 <= idx < len(self._labels)
 
     @property
-    def labels(self):
-        """
-        :rtype: list[str]
-        """
+    def labels(self) -> List[str]:
+        """list of labels"""
         return self._labels
 
-    def get_seq(self, sentence):
+    def get_seq(self, sentence: str) -> List[int]:
         """
-        :param str sentence: assumed to be seq of vocab entries separated by whitespace
-        :rtype: list[int]
+        :param sentence: assumed to be seq of vocab entries separated by whitespace
+        :return: seq of label indices
         """
         segments = sentence.split()
         return self.get_seq_indices(segments) + self.seq_postfix
 
-    def get_seq_indices(self, seq):
+    def get_seq_indices(self, seq: List[str]) -> List[int]:
         """
-        :param list[str] seq:
-        :rtype: list[int]
+        :param seq: seq of labels (entries in vocab)
+        :return: seq of label indices, returns unknown_label_id if unknown_label is set
         """
         if self.unknown_label is not None:
             return [self._vocab.get(k, self.unknown_label_id) for k in seq]
         return [self._vocab[k] for k in seq]
 
-    def get_seq_labels(self, seq):
+    def get_seq_labels(self, seq: Union[List[int], numpy.ndarray]) -> str:
         """
-        :param list[int]|numpy.ndarray seq: 1D sequence
-        :rtype: str
+        Inverse of :func:`get_seq`.
+
+        :param seq: 1D sequence of label indices
+        :return: serialized sequence string, such that ``get_seq(get_seq_labels(seq)) == seq``
         """
-        return " ".join(map(self._labels.__getitem__, seq))
+        labels = self.labels
+        return " ".join(map(labels.__getitem__, seq))
 
 
 class BytePairEncoding(Vocabulary):
     """
     Vocab based on Byte-Pair-Encoding (BPE).
     This will encode the text on-the-fly with BPE.
 
@@ -417,77 +419,71 @@
         return "%s(%r)" % (self.__class__.__name__, self._opts)
 
     def _parse_vocab(self):
         self.num_labels = self.sp.vocab_size()
         # Do not load labels/vocab here. This is not really needed.
 
     @property
-    def labels(self):
-        """
-        :rtype: list[str]
-        """
+    def labels(self) -> List[str]:
+        """list of labels"""
         if self._cache_key and self._cache_key in self._cache:
             self._vocab, self._labels = self._cache[self._cache_key]
             assert self.num_labels == len(self._vocab) == len(self._labels)
         else:
             self._labels = [self.sp.id_to_piece(i) for i in range(self.num_labels)]  # noqa
             self._vocab = {label: i for (i, label) in enumerate(self._labels)}
             if self._cache_key:
                 self._cache[self._cache_key] = (self._vocab, self._labels)
         return self._labels
 
-    def is_id_valid(self, idx):
+    def is_id_valid(self, idx: int) -> bool:
         """
-        :param int idx:
-        :rtype: bool
+        :param idx:
         """
         return not self.sp.IsUnused(idx)
 
-    def id_to_label(self, idx, default=KeyError):
+    def id_to_label(self, idx: int, default: Union[str, Type[KeyError], None] = KeyError) -> Optional[str]:
         """
-        :param int idx:
-        :param str|KeyError|None default:
-        :rtype: str|None
+        :param idx:
+        :param default:
         """
         if default is not KeyError and not self.is_id_valid(idx):
             return default
         return self.sp.IdToPiece(idx)
 
-    def label_to_id(self, label, default=KeyError):
+    def label_to_id(self, label: str, default: Union[int, Type[KeyError], None] = KeyError) -> Optional[int]:
         """
-        :param str label:
-        :param int|type[KeyError]|None default:
-        :rtype: int|None
+        :param label:
+        :param default:
         """
         res = self.sp.PieceToId(label)
         if res == self.unknown_label_id or res < 0 or res is None:
             # It could be that the label really is the unknown-label, or it could be that the label is unknown.
             if label == self.id_to_label(self.unknown_label_id):
                 return self.unknown_label_id
             if default is KeyError:
                 raise KeyError("label %r not found" % label)
             return default
         return res
 
-    def set_random_seed(self, seed):
+    def set_random_seed(self, seed: int):
         """
-        :param int seed:
+        :param seed:
         """
         # Unfortunately, there is only a global seed,
         # and also, it will only be used for new threads
         # where the random generator was not used yet...
         # https://github.com/google/sentencepiece/issues/635
         import sentencepiece as spm  # noqa
 
         spm.set_random_generator_seed(seed)
 
-    def get_seq(self, sentence):
+    def get_seq(self, sentence: str) -> List[int]:
         """
-        :param str sentence: assumed to be seq of vocab entries separated by whitespace
-        :rtype: list[int]
+        :param sentence: assumed to be seq of vocab entries separated by whitespace
         """
         return self.sp.encode(sentence, out_type=int)  # noqa
 
 
 class CharacterTargets(Vocabulary):
     """
     Uses characters as target labels.
```

### Comparing `returnn-1.20240327.165809/returnn/engine/base.py` & `returnn-1.20240513.232708/returnn/engine/base.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/engine/batch.py` & `returnn-1.20240513.232708/returnn/engine/batch.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/__init__.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/__main__.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/__main__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/LICENSE` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/LICENSE`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/README.md` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/README.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/aligner.gif` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/aligner.gif`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/check.png` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/check.png`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/core.cu` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/core.cu`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/core.h` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/core.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/core_cpu.cpp` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/core_cpu.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/LICENSE` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/LICENSE`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/README.md` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/README.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/binding.cpp` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/binding.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.cu` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.cu`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.h` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/core.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/setup.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/setup.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/__init__.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/test.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/pytorch_binding/warp_rna/test.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/ref_rna.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/ref_rna.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/setup.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/setup.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op.cc` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op.cc`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op_kernel_tmpl.h` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/src/warp_rna_op_kernel_tmpl.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/tensorflow_binding/warp_rna/__init__.py` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/tensorflow_binding/warp_rna/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/WarpRna/warp-rna/test.cpp` & `returnn-1.20240513.232708/returnn/extern/WarpRna/warp-rna/test.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/__init__.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/edit.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/edit.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/reroute.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/reroute.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/select.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/select.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/subgraph.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/subgraph.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/transform.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/transform.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/extern/graph_editor/util.py` & `returnn-1.20240513.232708/returnn/extern/graph_editor/util.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/forward_iface.py` & `returnn-1.20240513.232708/returnn/forward_iface.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/__init__.py` & `returnn-1.20240513.232708/returnn/frontend/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_backend.py` & `returnn-1.20240513.232708/returnn/frontend/_backend.py`

 * *Files 0% similar despite different names*

```diff
@@ -471,22 +471,24 @@
     @staticmethod
     def pad(
         source: Tensor,
         *,
         axes: Sequence[Dim],
         padding: Sequence[Tuple[Union[Dim, int], Union[Dim, int]]],
         out_dims: Sequence[Dim],
+        handle_dynamic_dims: bool,
         mode: str = "constant",
         value: Optional[Union[rf.RawTensorTypes, Tensor]] = None,
     ) -> Tensor:
         """
         :param source:
         :param axes:
         :param padding:
         :param out_dims:
+        :param handle_dynamic_dims:
         :param mode:
         :param value:
         :return: padded tensor
         """
         raise NotImplementedError
 
     @staticmethod
```

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/__init__.py` & `returnn-1.20240513.232708/returnn/frontend/_native/__init__.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/backend.cpp` & `returnn-1.20240513.232708/returnn/frontend/_native/backend.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/backend.hpp` & `returnn-1.20240513.232708/returnn/frontend/_native/backend.hpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/module.cpp` & `returnn-1.20240513.232708/returnn/frontend/_native/module.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/module.hpp` & `returnn-1.20240513.232708/returnn/frontend/_native/module.hpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/py_utils.hpp` & `returnn-1.20240513.232708/returnn/frontend/_native/py_utils.hpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/tensor_ops.cpp` & `returnn-1.20240513.232708/returnn/frontend/_native/tensor_ops.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_native/tensor_ops.hpp` & `returnn-1.20240513.232708/returnn/frontend/_native/tensor_ops.hpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_numpy_backend.py` & `returnn-1.20240513.232708/returnn/frontend/_numpy_backend.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_random_journal.py` & `returnn-1.20240513.232708/returnn/frontend/_random_journal.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/_utils.py` & `returnn-1.20240513.232708/returnn/frontend/_utils.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/array_.py` & `returnn-1.20240513.232708/returnn/frontend/array_.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 """
 Array (Tensor) functions
 """
 
 from __future__ import annotations
 from typing import Optional, Union, Type, TypeVar, Sequence, Tuple
+import logging
 import numpy
 from returnn.tensor import Tensor, Dim
 import returnn.frontend as rf
 from ._backend import Backend, global_backend, get_backend_by_raw_tensor_type
 from .types import RawTensorTypes
 
 T = TypeVar("T")
@@ -381,41 +382,95 @@
     source: Tensor,
     *,
     axes: Sequence[Dim],
     padding: Sequence[Tuple[Union[Dim, int], Union[Dim, int]]],
     out_dims: Optional[Sequence[Dim]] = None,
     mode: str = "constant",
     value: Optional[Union[rf.RawTensorTypes, Tensor]] = None,
+    handle_dynamic_dims: Optional[bool] = None,
 ) -> Tuple[Tensor, Sequence[Dim]]:
     """
     Pad values left/right in the specified axes.
 
     :param source:
     :param axes: which axes to add padding to
     :param padding: list of (left, right) padding for each axis
-    :param out_dims: (optional) predefined out dim tags, otherwise will automatically create
+    :param out_dims: (optional) predefined out dims for each padded dim in axes. will automatically create if not given
     :param mode: 'constant', 'reflect', 'replicate' or 'circular'
     :param value: (optional) value to pad with in "constant" mode
+    :param handle_dynamic_dims: True: when doing right padding on a dynamic dim, value will be added after the seq end,
+        not at the end of the dimension. False: value will be added at the end of the dimension.
+        By default, in behavior version >=21, this is True, in older versions, this is False.
+    :return: padded tensor, out_dims. out dims are for each dim in axes
     """
     assert len(axes) == len(padding)
     if not out_dims:
         for left, right in padding:
             if isinstance(left, Dim):
                 assert not left.need_masking(), f"padding {padding} does not support dynamic left padding"
             if isinstance(right, Dim):
                 assert not right.need_masking(), f"padding {padding} does not support dynamic right padding"
             # Note that even dynamic middle dims is not exactly correct...
         out_dims = [left + middle + right for middle, (left, right) in zip(axes, padding)]
+    if handle_dynamic_dims is None:
+        handle_dynamic_dims = _pad_handle_dynamic_dims_default(axes, padding, mode=mode)
     # noinspection PyProtectedMember
     return (
-        source._raw_backend.pad(source, axes=axes, padding=padding, out_dims=out_dims, mode=mode, value=value),
+        source._raw_backend.pad(
+            source,
+            axes=axes,
+            padding=padding,
+            out_dims=out_dims,
+            handle_dynamic_dims=handle_dynamic_dims,
+            mode=mode,
+            value=value,
+        ),
         out_dims,
     )
 
 
+_pad_handle_dynamic_dims_shown_warning = False
+
+
+def _pad_handle_dynamic_dims_default(
+    pad_axes: Sequence[Dim], padding: Sequence[Tuple[Union[Dim, int], Union[Dim, int]]], *, mode: str
+) -> bool:
+    """
+    :param pad_axes: list of axes to pad
+    :param padding: list of (left, right) padding for each axis
+    :param mode: 'constant', 'reflect', 'replicate' or 'circular'
+    :return: True if dynamic dims should be handled as specified in the default behavior
+    """
+    from returnn.util.basic import BehaviorVersion
+
+    if BehaviorVersion.get() >= 21:
+        return True
+
+    # Check whether not handling the dynamic dims is safe. Print a warning if not safe.
+    global _pad_handle_dynamic_dims_shown_warning
+    if not _pad_handle_dynamic_dims_shown_warning:
+        for middle, (left, right) in zip(pad_axes, padding):
+            middle: Dim
+            if not middle.need_masking() and (isinstance(left, int) or not left.need_masking()):
+                continue
+            if mode != "circular" and isinstance(right, int) and right == 0:
+                continue
+
+            logging.getLogger("returnn.frontend").warning(
+                f"rf.pad applied on dynamic dim {middle} but handle_dynamic_dims=False used by default"
+                f" due to behavior version {BehaviorVersion.get()} < 21."
+                " Set handle_dynamic_dims explicitly to avoid the warning,"
+                " or switch to a new behavior version >= 21."
+                " (This warning is only printed once.)"
+            )
+            _pad_handle_dynamic_dims_shown_warning = True
+            break
+    return False
+
+
 def cum_concat_step(
     source: Tensor, *, prev_accum: Tensor, axis: Dim, out_spatial_dim: Optional[Dim] = None
 ) -> Tuple[Tensor, Dim]:
     """
     Concatenates all previous frames over a time-axis.
     See RETURNN :class:`CumConcatLayer` for details.
```

### Comparing `returnn-1.20240327.165809/returnn/frontend/attention.py` & `returnn-1.20240513.232708/returnn/frontend/attention.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/audio/mel.py` & `returnn-1.20240513.232708/returnn/frontend/audio/mel.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/audio/specaugment.py` & `returnn-1.20240513.232708/returnn/frontend/audio/specaugment.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/backend.py` & `returnn-1.20240513.232708/returnn/frontend/backend.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/cond.py` & `returnn-1.20240513.232708/returnn/frontend/cond.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/const.py` & `returnn-1.20240513.232708/returnn/frontend/const.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/container.py` & `returnn-1.20240513.232708/returnn/frontend/container.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/control_flow_ctx.py` & `returnn-1.20240513.232708/returnn/frontend/control_flow_ctx.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/conv.py` & `returnn-1.20240513.232708/returnn/frontend/conv.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/decoder/transformer.py` & `returnn-1.20240513.232708/returnn/frontend/decoder/transformer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/device.py` & `returnn-1.20240513.232708/returnn/frontend/device.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/dims.py` & `returnn-1.20240513.232708/returnn/frontend/dims.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/dropout.py` & `returnn-1.20240513.232708/returnn/frontend/dropout.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/dtype.py` & `returnn-1.20240513.232708/returnn/frontend/dtype.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/encoder/base.py` & `returnn-1.20240513.232708/returnn/frontend/encoder/base.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/encoder/conformer.py` & `returnn-1.20240513.232708/returnn/frontend/encoder/conformer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/gradient.py` & `returnn-1.20240513.232708/returnn/frontend/gradient.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/graph.py` & `returnn-1.20240513.232708/returnn/frontend/graph.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/hooks.py` & `returnn-1.20240513.232708/returnn/frontend/hooks.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/init.py` & `returnn-1.20240513.232708/returnn/frontend/init.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/label_smoothing.py` & `returnn-1.20240513.232708/returnn/frontend/label_smoothing.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/linear.py` & `returnn-1.20240513.232708/returnn/frontend/linear.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/loop.py` & `returnn-1.20240513.232708/returnn/frontend/loop.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/loss.py` & `returnn-1.20240513.232708/returnn/frontend/loss.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/math_.py` & `returnn-1.20240513.232708/returnn/frontend/math_.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/matmul.py` & `returnn-1.20240513.232708/returnn/frontend/matmul.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/module.py` & `returnn-1.20240513.232708/returnn/frontend/module.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/normalization.py` & `returnn-1.20240513.232708/returnn/frontend/normalization.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/parameter.py` & `returnn-1.20240513.232708/returnn/frontend/parameter.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/rand.py` & `returnn-1.20240513.232708/returnn/frontend/rand.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/rec.py` & `returnn-1.20240513.232708/returnn/frontend/rec.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/reduce.py` & `returnn-1.20240513.232708/returnn/frontend/reduce.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/run_ctx.py` & `returnn-1.20240513.232708/returnn/frontend/run_ctx.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/signal.py` & `returnn-1.20240513.232708/returnn/frontend/signal.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/state.py` & `returnn-1.20240513.232708/returnn/frontend/state.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/tensor_array.py` & `returnn-1.20240513.232708/returnn/frontend/tensor_array.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/frontend/types.py` & `returnn-1.20240513.232708/returnn/frontend/types.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/import_/common.py` & `returnn-1.20240513.232708/returnn/import_/common.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/import_/git.py` & `returnn-1.20240513.232708/returnn/import_/git.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/import_/import_.py` & `returnn-1.20240513.232708/returnn/import_/import_.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/learning_rate_control.py` & `returnn-1.20240513.232708/returnn/learning_rate_control.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/log.py` & `returnn-1.20240513.232708/returnn/log.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/native_op.cpp` & `returnn-1.20240513.232708/returnn/native_op.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/native_op.py` & `returnn-1.20240513.232708/returnn/native_op.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/pretrain.py` & `returnn-1.20240513.232708/returnn/pretrain.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/sprint/cache.py` & `returnn-1.20240513.232708/returnn/sprint/cache.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/sprint/control.py` & `returnn-1.20240513.232708/returnn/sprint/control.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/sprint/error_signals.py` & `returnn-1.20240513.232708/returnn/sprint/error_signals.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/sprint/extern_interface.py` & `returnn-1.20240513.232708/returnn/sprint/extern_interface.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/sprint/interface.py` & `returnn-1.20240513.232708/returnn/sprint/interface.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/_dim_extra.py` & `returnn-1.20240513.232708/returnn/tensor/_dim_extra.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/_tensor_extra.py` & `returnn-1.20240513.232708/returnn/tensor/_tensor_extra.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/_tensor_mixin_base.py` & `returnn-1.20240513.232708/returnn/tensor/_tensor_mixin_base.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/_tensor_op_overloads.py` & `returnn-1.20240513.232708/returnn/tensor/_tensor_op_overloads.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/control_flow_ctx.py` & `returnn-1.20240513.232708/returnn/tensor/control_flow_ctx.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/dim.py` & `returnn-1.20240513.232708/returnn/tensor/dim.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/marked_dim.py` & `returnn-1.20240513.232708/returnn/tensor/marked_dim.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/tensor.py` & `returnn-1.20240513.232708/returnn/tensor/tensor.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/tensor_dict.py` & `returnn-1.20240513.232708/returnn/tensor/tensor_dict.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tensor/utils.py` & `returnn-1.20240513.232708/returnn/tensor/utils.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/compat.py` & `returnn-1.20240513.232708/returnn/tf/compat.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/data_pipeline.py` & `returnn-1.20240513.232708/returnn/tf/data_pipeline.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/distributed.py` & `returnn-1.20240513.232708/returnn/tf/distributed.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/engine.py` & `returnn-1.20240513.232708/returnn/tf/engine.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/README.md` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/README.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/_backend.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/_backend.py`

 * *Files 0% similar despite different names*

```diff
@@ -351,26 +351,28 @@
     @staticmethod
     def pad(
         source: Tensor,
         *,
         axes: Sequence[Dim],
         padding: Sequence[Tuple[Union[Dim, int], Union[Dim, int]]],
         out_dims: Sequence[Dim],
+        handle_dynamic_dims: bool,
         mode: str = "constant",
         value: Union[rf.RawTensorTypes, Tensor] = None,
     ) -> Tensor:
         """pad"""
         assert isinstance(value, (int, float, type(None)))  # not implemented otherwise
         return rfl.make_layer(
             {
                 "class": "pad",
                 "from": source,
                 "axes": axes,
                 "padding": padding,
                 "out_dims": out_dims,
+                "handle_dynamic_dims": handle_dynamic_dims,
                 "mode": mode,
                 "value": value,
             },
             name="pad",
         )
 
     @staticmethod
```

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/_utils.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/_utils.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/cond.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/cond.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/config_entry_points.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/config_entry_points.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/debug_eager_mode.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/debug_eager_mode.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/dims.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/dims.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/layer.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/layer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/loop.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/loop.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/make_layer.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/make_layer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/masked_computation.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/masked_computation.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/parameter_assign.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/parameter_assign.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_layers/prev_tensor_ref.py` & `returnn-1.20240513.232708/returnn/tf/frontend_layers/prev_tensor_ref.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/frontend_low_level/_backend.py` & `returnn-1.20240513.232708/returnn/tf/frontend_low_level/_backend.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/horovod.py` & `returnn-1.20240513.232708/returnn/tf/horovod.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/hyper_param_tuning.py` & `returnn-1.20240513.232708/returnn/tf/hyper_param_tuning.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/layers/base.py` & `returnn-1.20240513.232708/returnn/tf/layers/base.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/layers/basic.py` & `returnn-1.20240513.232708/returnn/tf/layers/basic.py`

 * *Files 0% similar despite different names*

```diff
@@ -1977,21 +1977,23 @@
                 input_v,
             )
             # It does not matter what dummy indices we use, as we have 0.0 updates, but it must be valid (0 is valid).
             pos_v = tf.where(mask, tf.zeros_like(pos_v), pos_v)
         # Now we need to implement a similar logic as `returnn.tf.util.basic.nd_indices`, but more generic.
         idxs = [
             (
-                tf.reshape(
-                    tf.range(pos_shape[i], dtype=pos_v.dtype), [1] * i + [pos_shape[i]] + [1] * (pos_ndim - i - 1)
+                (
+                    tf.reshape(
+                        tf.range(pos_shape[i], dtype=pos_v.dtype), [1] * i + [pos_shape[i]] + [1] * (pos_ndim - i - 1)
+                    )
+                    + tf.zeros_like(pos_v)
                 )
-                + tf.zeros_like(pos_v)
+                if i != replace_common_axis
+                else pos_v
             )
-            if i != replace_common_axis
-            else pos_v
             for i in range(pos_ndim)
         ]
         nd_idxs = tf.stack(idxs, axis=-1)
         # updates.shape == indices.shape[:-1] + output_shape[indices.shape[-1]:]
         assert pos_ndim <= input_expanded.batch_ndim == self.output.batch_ndim
         output_shape = [
             input_shape[i] if i != replace_common_axis else output_dim for i in range(input_expanded.batch_ndim)
@@ -4169,40 +4171,87 @@
     """
     Adds (e.g. zero) padding in some axis or axes.
     Also see :class:`PrefixInTimeLayer` for dynamic dims.
     """
 
     layer_class = "pad"
 
-    def __init__(self, axes, padding, out_dims=None, value=0, mode="constant", **kwargs):
+    def __init__(
+        self,
+        *,
+        axes: Union[Dim, str, Sequence[Union[Dim, str]]],
+        padding: Union[int, Tuple[int, int], Sequence[Tuple[int, int]]],
+        out_dims: Optional[Union[Dim, Sequence[Dim]]] = None,
+        handle_dynamic_dims: Optional[bool] = None,
+        value: Union[int, float] = 0,
+        mode: str = "constant",
+        **kwargs,
+    ):
         """
-        :param Dim|str|list[Dim|str] axes: e.g. "F" etc. see :func:`Data.get_axes_from_description`.
-        :param list[(int,int)]|(int,int)|int padding: how much to pad left/right in each axis
-        :param Dim|list[Dim]|None out_dims:
-        :param int|float value: what constant value to pad, with mode=="constant"
-        :param str mode: "constant", "reflect", "symmetric" and "replication"
+        :param axes: e.g. "F" etc. see :func:`Data.get_axes_from_description`.
+        :param padding: how much to pad left/right in each axis
+        :param out_dims:
+        :param handle_dynamic_dims: True: when doing right padding on a dynamic dim,
+            value will be added after the seq end,
+            not at the end of the dimension.
+            False: value will be added at the end of the dimension.
+            By default, in behavior version >=21, this is True, in older versions, this is False.
+        :param value: what constant value to pad, with mode=="constant"
+        :param mode: "constant", "reflect", "symmetric" and "replication"
         """
         out_dims  # noqa  # handled in get_out_data_from_opts
         super(PadLayer, self).__init__(**kwargs)
         axes_ = self.input_data.get_axes_from_description(axes)
         assert axes_, "%s: invalid axes %r in input %s" % (self, axes, self.input_data)
         axes = axes_
         padding = self._transform_padding(padding=padding, axes=axes)
         paddings = [(0, 0)] * len(range(self.input_data.batch_ndim))
         for i, a in enumerate(axes):
             paddings[a] = padding[i]
-        mode = mode.upper()
+        mode = mode.lower()
+        if handle_dynamic_dims is None:
+            handle_dynamic_dims = self._handle_dynamic_dims_default(
+                pad_axes=[self.input_data.dims[axis] for axis in axes_],
+                padding=padding,
+                mode=mode,
+            )
         if all(sum(p) == 0 for p in padding):
             self.output.placeholder = self.input_data.placeholder
-        elif mode == "REPLICATION":
+        elif mode == "replication":
             self.output.placeholder = tf_util.pad_replicate(self.input_data.placeholder, axes, padding)
         else:
             self.output.placeholder = tf.pad(
                 self.input_data.placeholder, paddings=paddings, mode=mode, constant_values=value
             )
+        if all(right == 0 for left, right in padding) and mode != "circular":
+            pass  # no masking needed
+        else:
+            import returnn.frontend as rf
+
+            for middle_axis, (left, right) in zip(axes, padding):
+                out_dim: Dim = self.output.dims[middle_axis]
+                middle = self.input_data.dims[middle_axis]
+                if handle_dynamic_dims and middle.need_masking() or (isinstance(left, Dim) and left.need_masking()):
+                    if mode != "constant":
+                        raise NotImplementedError(
+                            f"pad: mode {mode} not implemented with dynamic dims and handle_dynamic_dims=True"
+                        )
+                    if isinstance(right, Dim) or right > 0:
+                        mask = rf.compare_bc(
+                            rf.range_over_dim(out_dim),
+                            "<",
+                            (left + middle)
+                            .get_for_batch_ctx(self.output.batch, self.output.control_flow_ctx)
+                            .dyn_size_ext,
+                        )
+                        self.output.raw_tensor = tf_util.where_bc(
+                            mask.copy_compatible_to(self.output, check_sparse=False, check_dtype=False).raw_tensor,
+                            self.output.raw_tensor,
+                            tf.convert_to_tensor(value, dtype=self.output.dtype),
+                        )
 
     @classmethod
     def _transform_padding(cls, padding, axes):
         """
         :param list[(int,int)]|(int,int)|int padding:
         :param list[int] axes:
         :rtype: list[(int,int)]
@@ -4214,14 +4263,53 @@
             else:
                 assert len(padding) == 2
                 padding = [tuple(padding)] * len(axes)
         else:
             padding = [(padding, padding)] * len(axes)
         return padding
 
+    _handle_dynamic_dims_shown_warning = False
+
+    @classmethod
+    def _handle_dynamic_dims_default(
+        cls, pad_axes: Sequence[Dim], padding: Sequence[Tuple[Union[Dim, int], Union[Dim, int]]], *, mode: str
+    ) -> bool:
+        """
+        :param pad_axes: list of axes to pad
+        :param padding: list of (left, right) padding for each axis
+        :param mode: 'constant', 'reflect', 'replicate' or 'circular'
+        :return: True if dynamic dims should be handled as specified in the default behavior
+        """
+        from returnn.util.basic import BehaviorVersion
+
+        if BehaviorVersion.get() >= 21:
+            return True
+
+        # Check whether not handling the dynamic dims is safe. Print a warning if not safe.
+        if not cls._handle_dynamic_dims_shown_warning:
+            import logging
+
+            for middle, (left, right) in zip(pad_axes, padding):
+                middle: Dim
+                if not middle.need_masking() and (isinstance(left, int) or not left.need_masking()):
+                    continue
+                if mode != "circular" and isinstance(right, int) and right == 0:
+                    continue
+
+                logging.getLogger("returnn.tf").warning(
+                    f"PadLayer applied on dynamic dim {middle} but handle_dynamic_dims=False used by default"
+                    f" due to behavior version {BehaviorVersion.get()} < 21."
+                    " Set handle_dynamic_dims explicitly to avoid the warning,"
+                    " or switch to a new behavior version >= 21."
+                    " (This warning is only printed once.)"
+                )
+                cls._handle_dynamic_dims_shown_warning = True
+                break
+        return False
+
     @classmethod
     def get_out_data_from_opts(cls, name, sources, axes, padding, out_dims=None, **kwargs):
         """
         :param str name:
         :param list[LayerBase] sources:
         :param Dim|str|list[Dim|str] axes:
         :param list[(int,int)]|(int,int)|int padding:
@@ -4925,22 +5013,24 @@
                         assert rem_dim.dimension * n == axis_dim_tag.dimension
                     rem_dim.declare_same_as(resolved_dims[rem_dim_idx])
             else:
                 assert len(rem_dim_indices) == 0
                 rem_dim = None
             if not resolved_dims:
                 resolved_dims = tuple(
-                    Dim(
-                        kind=axis_dim_tag.kind if not axis_dim_tag.is_batch_dim() else Dim.Types.Spatial,
-                        description="%s_split_dims%i" % (name, i),
-                        dimension=shape_dim,
-                        auto_generated=True,
+                    (
+                        Dim(
+                            kind=axis_dim_tag.kind if not axis_dim_tag.is_batch_dim() else Dim.Types.Spatial,
+                            description="%s_split_dims%i" % (name, i),
+                            dimension=shape_dim,
+                            auto_generated=True,
+                        )
+                        if rem_dim is None or i != rem_dim_idx
+                        else rem_dim
                     )
-                    if rem_dim is None or i != rem_dim_idx
-                    else rem_dim
                     for i, shape_dim in enumerate(resolved_shape_dims)
                 )
         out_batch = data.batch
         if axis_dim_tag.is_batch_dim():
             assert len([d for d in resolved_dims if d.is_batch_dim()]) == 1
             from returnn.tf.util.data import BatchInfo
```

### Comparing `returnn-1.20240327.165809/returnn/tf/layers/rec.py` & `returnn-1.20240513.232708/returnn/tf/layers/rec.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/layers/segmental_model.py` & `returnn-1.20240513.232708/returnn/tf/layers/segmental_model.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/layers/signal_processing.py` & `returnn-1.20240513.232708/returnn/tf/layers/signal_processing.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/layers/variable.py` & `returnn-1.20240513.232708/returnn/tf/layers/variable.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/native_op.py` & `returnn-1.20240513.232708/returnn/tf/native_op.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/network.py` & `returnn-1.20240513.232708/returnn/tf/network.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/sprint.py` & `returnn-1.20240513.232708/returnn/tf/sprint.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/updater.py` & `returnn-1.20240513.232708/returnn/tf/updater.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/util/basic.py` & `returnn-1.20240513.232708/returnn/tf/util/basic.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/util/data.py` & `returnn-1.20240513.232708/returnn/tf/util/data.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/util/gradient_checkpoint.py` & `returnn-1.20240513.232708/returnn/tf/util/gradient_checkpoint.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/util/ken_lm.py` & `returnn-1.20240513.232708/returnn/tf/util/ken_lm.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/tf/util/open_fst.py` & `returnn-1.20240513.232708/returnn/tf/util/open_fst.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/data/extern_data.py` & `returnn-1.20240513.232708/returnn/torch/data/extern_data.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/data/pipeline.py` & `returnn-1.20240513.232708/returnn/torch/data/pipeline.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/data/queued_data_iter.py` & `returnn-1.20240513.232708/returnn/torch/data/queued_data_iter.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/data/returnn_dataset_wrapper.py` & `returnn-1.20240513.232708/returnn/torch/data/returnn_dataset_wrapper.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/data/tensor_utils.py` & `returnn-1.20240513.232708/returnn/torch/data/tensor_utils.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/distributed.py` & `returnn-1.20240513.232708/returnn/torch/distributed.py`

 * *Files 19% similar despite different names*

```diff
@@ -8,27 +8,28 @@
 import socket
 import logging
 
 import torch
 from torch.nn.parallel import DistributedDataParallel
 
 from returnn.config import Config
+from returnn.util.basic import CollectionReadCheckCovered
 
 _logger = logging.getLogger("returnn.torch.distributed")
 
 
 class DistributedContext:
     """
     This class setups some helper functions for torch distributed training
     """
 
     def __init__(self, options: Dict[str, Any]):
         import torch.distributed as dist
 
-        self._opts = options
+        self._opts = CollectionReadCheckCovered(options)
 
         # when no backend is specified, both gloo and nccl backends will be created
         # the gloo backend will be used for collectives with CPU tensors and
         # the nccl backend will be used for collectives with CUDA tensors
         dist.init_process_group(backend=self._opts.get("backend", None))
 
         self._local_rank = int(os.environ["LOCAL_RANK"])
@@ -50,14 +51,32 @@
             )
             _logger.info(f"reduce_type param: param_sync_step {self._param_sync_step}")
         elif self._reduce_type == "grad":
             _logger.info("reduce_type grad")
         else:
             raise ValueError(f"invalid reduce_type {self._reduce_type!r}")
 
+        self._check_no_unknown_opts()
+
+    def __repr__(self):
+        return f"<{self.__class__.__name__} size={self._size} reduce_type={self._reduce_type}>"
+
+    def _check_no_unknown_opts(self):
+        # We check that all opts in self._opts have been used.
+        # This function here is called at the end in __init__,
+        # and not all opts are used yet, so read them now,
+        # such that the check in the end works.
+        if self._reduce_type == "grad":
+            self._opts.get("class")
+            self._opts.get("options")
+        if self._reduce_type == "param":
+            self._opts.get("sync_on_cpu")
+
+        self._opts.assert_all_read()
+
     def local_rank(self) -> int:
         """local rank"""
         return self._local_rank
 
     def local_size(self) -> int:
         """local size"""
         return self._local_size
@@ -79,14 +98,15 @@
         Maybe make a wrapped distributed module.
 
         :param module: original module
         :return: potentially wrapped module
         """
         if self._reduce_type == "param":
             return None
+        assert self._reduce_type == "grad"
         cls = self._opts.get("class", DistributedDataParallel)
         if cls is not DistributedDataParallel:
             _logger.warning(f"Using custom class {cls} instead of DistributedDataParallel, might be unsupported.")
         kwargs = self._opts.get("options", {})
         return cls(
             module=module,
             device_ids=[self.local_rank()],
```

### Comparing `returnn-1.20240327.165809/returnn/torch/engine.py` & `returnn-1.20240513.232708/returnn/torch/engine.py`

 * *Files 1% similar despite different names*

```diff
@@ -5,14 +5,15 @@
 from __future__ import annotations
 from typing import Optional, Any, Union, Callable, Dict
 from contextlib import nullcontext
 
 import gc
 import os
 import time
+import socket
 
 import torch
 import torch.distributed
 from torch.nn.parallel import DistributedDataParallel
 from torch.utils.data import DataLoader
 from torch import autocast
 from torch.cuda import amp
@@ -279,14 +280,21 @@
         self._updater.set_learning_rate(self.learning_rate)
         self._updater.set_current_train_step(global_train_step=self.global_train_step, epoch=self.epoch)
 
         self.learning_rate_control.epoch_data[self.epoch].meta.update(
             {
                 "global_train_step": self.global_train_step,
                 "effective_learning_rate": self._updater.get_effective_learning_rate(),
+                "returnn": util.describe_returnn_version(),
+                "torch": util.describe_torch_version(),
+                "time": time.strftime("%Y-%m-%d-%H-%M-%S (UTC%z)"),
+                "hostname": socket.gethostname(),
+                "device": torch.cuda.get_device_name() if torch.device(self._device).type == "cuda" else self._device,
+                "cpu": util.get_cpu_model_name(),
+                "distributed": self._torch_distributed_ctx.__repr__() if self._torch_distributed_ctx else None,
             }
         )
 
     def _maybe_reset_dev_memory_caches(self, *, force: bool = False):
         if not force and not self._reset_dev_memory_caches:
             return
         gc.collect()
@@ -446,14 +454,15 @@
             file=log.v3,
         )
 
         self.learning_rate_control.epoch_data[self.epoch].meta.update(
             {
                 "epoch_num_train_steps": step_idx,
                 "epoch_train_time_secs": round(elapsed),
+                "global_train_step_end": self.global_train_step,
             }
         )
 
         accumulated_losses_dict = accumulated_losses_dict / accumulated_inv_norm_factors_dict
         self.learning_rate_control.set_epoch_error(
             self.epoch, {f"train_loss_{k}": v for k, v in accumulated_losses_dict.items()}
         )
```

### Comparing `returnn-1.20240327.165809/returnn/torch/frontend/_backend.py` & `returnn-1.20240513.232708/returnn/torch/frontend/_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -975,4525 +975,4606 @@
 00003ce0: 2053 6571 7565 6e63 655b 4469 6d5d 2c0a   Sequence[Dim],.
 00003cf0: 2020 2020 2020 2020 7061 6464 696e 673a          padding:
 00003d00: 2053 6571 7565 6e63 655b 5475 706c 655b   Sequence[Tuple[
 00003d10: 556e 696f 6e5b 4469 6d2c 2069 6e74 5d2c  Union[Dim, int],
 00003d20: 2055 6e69 6f6e 5b44 696d 2c20 696e 745d   Union[Dim, int]
 00003d30: 5d5d 2c0a 2020 2020 2020 2020 6f75 745f  ]],.        out_
 00003d40: 6469 6d73 3a20 5365 7175 656e 6365 5b44  dims: Sequence[D
-00003d50: 696d 5d2c 0a20 2020 2020 2020 206d 6f64  im],.        mod
-00003d60: 653a 2073 7472 203d 2022 636f 6e73 7461  e: str = "consta
-00003d70: 6e74 222c 0a20 2020 2020 2020 2076 616c  nt",.        val
-00003d80: 7565 3a20 4f70 7469 6f6e 616c 5b55 6e69  ue: Optional[Uni
-00003d90: 6f6e 5b72 662e 5261 7754 656e 736f 7254  on[rf.RawTensorT
-00003da0: 7970 6573 2c20 5465 6e73 6f72 5d5d 203d  ypes, Tensor]] =
-00003db0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-00003dc0: 5465 6e73 6f72 3a0a 2020 2020 2020 2020  Tensor:.        
-00003dd0: 2222 2270 6164 2222 220a 2020 2020 2020  """pad""".      
-00003de0: 2020 6173 7365 7274 206c 656e 286f 7574    assert len(out
-00003df0: 5f64 696d 7329 203d 3d20 6c65 6e28 6178  _dims) == len(ax
-00003e00: 6573 2920 3d3d 206c 656e 2870 6164 6469  es) == len(paddi
-00003e10: 6e67 290a 2020 2020 2020 2020 6f75 7420  ng).        out 
-00003e20: 3d20 736f 7572 6365 2e63 6f70 795f 7465  = source.copy_te
-00003e30: 6d70 6c61 7465 5f6e 6577 5f64 696d 5f74  mplate_new_dim_t
-00003e40: 6167 7328 0a20 2020 2020 2020 2020 2020  ags(.           
-00003e50: 205b 6f75 745f 6469 6d73 5b61 7865 732e   [out_dims[axes.
-00003e60: 696e 6465 7828 6469 6d29 5d20 6966 2064  index(dim)] if d
-00003e70: 696d 2069 6e20 6178 6573 2065 6c73 6520  im in axes else 
-00003e80: 6469 6d20 666f 7220 6469 6d20 696e 2073  dim for dim in s
-00003e90: 6f75 7263 652e 6469 6d5f 7461 6773 5d2c  ource.dim_tags],
-00003ea0: 206b 6565 705f 7370 6563 6961 6c5f 6178   keep_special_ax
-00003eb0: 6573 3d54 7275 650a 2020 2020 2020 2020  es=True.        
-00003ec0: 290a 2020 2020 2020 2020 7265 6d61 696e  ).        remain
-00003ed0: 696e 675f 6469 6d73 203d 2073 6574 2861  ing_dims = set(a
-00003ee0: 7865 7329 0a20 2020 2020 2020 2072 6177  xes).        raw
-00003ef0: 5f70 6164 203d 205b 5d0a 2020 2020 2020  _pad = [].      
-00003f00: 2020 666f 7220 6469 6d20 696e 2072 6576    for dim in rev
-00003f10: 6572 7365 6428 736f 7572 6365 2e64 696d  ersed(source.dim
-00003f20: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00003f30: 6966 2064 696d 206e 6f74 2069 6e20 7265  if dim not in re
-00003f40: 6d61 696e 696e 675f 6469 6d73 3a0a 2020  maining_dims:.  
-00003f50: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00003f60: 775f 7061 6420 2b3d 205b 302c 2030 5d0a  w_pad += [0, 0].
-00003f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f80: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00003f90: 2020 2020 2072 656d 6169 6e69 6e67 5f64       remaining_d
-00003fa0: 696d 732e 7265 6d6f 7665 2864 696d 290a  ims.remove(dim).
-00003fb0: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
-00003fc0: 203d 2070 6164 6469 6e67 5b61 7865 732e   = padding[axes.
-00003fd0: 696e 6465 7828 6469 6d29 5d0a 2020 2020  index(dim)].    
-00003fe0: 2020 2020 2020 2020 7261 775f 7061 6420          raw_pad 
-00003ff0: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
-00004000: 2020 2020 2070 6164 5f5b 305d 2e67 6574       pad_[0].get
-00004010: 5f64 696d 5f76 616c 7565 2829 2069 6620  _dim_value() if 
-00004020: 6973 696e 7374 616e 6365 2870 6164 5f5b  isinstance(pad_[
-00004030: 305d 2c20 4469 6d29 2065 6c73 6520 7061  0], Dim) else pa
-00004040: 645f 5b30 5d2c 0a20 2020 2020 2020 2020  d_[0],.         
-00004050: 2020 2020 2020 2070 6164 5f5b 315d 2e67         pad_[1].g
-00004060: 6574 5f64 696d 5f76 616c 7565 2829 2069  et_dim_value() i
-00004070: 6620 6973 696e 7374 616e 6365 2870 6164  f isinstance(pad
-00004080: 5f5b 315d 2c20 4469 6d29 2065 6c73 6520  _[1], Dim) else 
-00004090: 7061 645f 5b31 5d2c 0a20 2020 2020 2020  pad_[1],.       
-000040a0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-000040b0: 2020 2069 6620 6e6f 7420 7265 6d61 696e     if not remain
-000040c0: 696e 675f 6469 6d73 3a0a 2020 2020 2020  ing_dims:.      
-000040d0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-000040e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-000040f0: 7461 6e63 6528 7661 6c75 652c 2054 656e  tance(value, Ten
-00004100: 736f 7229 3a0a 2020 2020 2020 2020 2020  sor):.          
-00004110: 2020 6173 7365 7274 2076 616c 7565 2e64    assert value.d
-00004120: 696d 7320 3d3d 2028 292c 2066 2276 616c  ims == (), f"val
-00004130: 7565 207b 7661 6c75 657d 206d 7573 7420  ue {value} must 
-00004140: 6265 2061 2073 6361 6c61 7222 0a20 2020  be a scalar".   
-00004150: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-00004160: 2076 616c 7565 2e72 6177 5f74 656e 736f   value.raw_tenso
-00004170: 720a 2020 2020 2020 2020 6f75 742e 7261  r.        out.ra
-00004180: 775f 7465 6e73 6f72 203d 2074 6f72 6368  w_tensor = torch
-00004190: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e70  .nn.functional.p
-000041a0: 6164 2873 6f75 7263 652e 7261 775f 7465  ad(source.raw_te
-000041b0: 6e73 6f72 2c20 7061 643d 7261 775f 7061  nsor, pad=raw_pa
-000041c0: 642c 206d 6f64 653d 6d6f 6465 2c20 7661  d, mode=mode, va
-000041d0: 6c75 653d 7661 6c75 6529 0a20 2020 2020  lue=value).     
-000041e0: 2020 2072 6574 7572 6e20 6f75 740a 0a20     return out.. 
-000041f0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-00004200: 0a20 2020 2064 6566 2063 756d 5f63 6f6e  .    def cum_con
-00004210: 6361 745f 7374 6570 2873 6f75 7263 653a  cat_step(source:
-00004220: 2054 656e 736f 722c 202a 2c20 7072 6576   Tensor, *, prev
-00004230: 5f61 6363 756d 3a20 5465 6e73 6f72 2c20  _accum: Tensor, 
-00004240: 6178 6973 3a20 4469 6d2c 206f 7574 5f73  axis: Dim, out_s
-00004250: 7061 7469 616c 5f64 696d 3a20 4469 6d29  patial_dim: Dim)
-00004260: 202d 3e20 5465 6e73 6f72 3a0a 2020 2020   -> Tensor:.    
-00004270: 2020 2020 2222 2263 756d 2063 6f6e 6361      """cum conca
-00004280: 7420 7374 6570 2222 220a 2020 2020 2020  t step""".      
-00004290: 2020 6f75 7420 3d20 7072 6576 5f61 6363    out = prev_acc
-000042a0: 756d 2e63 6f70 795f 7465 6d70 6c61 7465  um.copy_template
-000042b0: 5f72 6570 6c61 6365 5f64 696d 5f74 6167  _replace_dim_tag
-000042c0: 280a 2020 2020 2020 2020 2020 2020 6178  (.            ax
-000042d0: 6973 3d70 7265 765f 6163 6375 6d2e 6765  is=prev_accum.ge
-000042e0: 745f 6178 6973 5f66 726f 6d5f 6465 7363  t_axis_from_desc
-000042f0: 7269 7074 696f 6e28 6178 6973 292c 0a20  ription(axis),. 
-00004300: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
-00004310: 696d 5f74 6167 3d6f 7574 5f73 7061 7469  im_tag=out_spati
-00004320: 616c 5f64 696d 2c0a 2020 2020 2020 2020  al_dim,.        
-00004330: 2020 2020 6e61 6d65 3d66 227b 736f 7572      name=f"{sour
-00004340: 6365 2e6e 616d 657d 2f63 756d 5f63 6f6e  ce.name}/cum_con
-00004350: 6361 745f 7374 6570 222c 0a20 2020 2020  cat_step",.     
-00004360: 2020 2029 0a20 2020 2020 2020 2073 6f75     ).        sou
-00004370: 7263 655f 7261 7720 3d20 736f 7572 6365  rce_raw = source
-00004380: 2e63 6f70 795f 636f 6d70 6174 6962 6c65  .copy_compatible
-00004390: 5f74 6f5f 6469 6d73 5f72 6177 2870 7265  _to_dims_raw(pre
-000043a0: 765f 6163 6375 6d2e 6469 6d73 290a 2020  v_accum.dims).  
-000043b0: 2020 2020 2020 6f75 742e 7261 775f 7465        out.raw_te
-000043c0: 6e73 6f72 203d 2074 6f72 6368 2e63 6174  nsor = torch.cat
-000043d0: 2828 7072 6576 5f61 6363 756d 2e72 6177  ((prev_accum.raw
-000043e0: 5f74 656e 736f 722c 2073 6f75 7263 655f  _tensor, source_
-000043f0: 7261 7729 2c20 6469 6d3d 7072 6576 5f61  raw), dim=prev_a
-00004400: 6363 756d 2e67 6574 5f61 7869 735f 6672  ccum.get_axis_fr
-00004410: 6f6d 5f64 6573 6372 6970 7469 6f6e 2861  om_description(a
-00004420: 7869 7329 290a 2020 2020 2020 2020 7265  xis)).        re
-00004430: 7475 726e 206f 7574 0a0a 2020 2020 4073  turn out..    @s
-00004440: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-00004450: 6465 6620 6163 7469 7661 7469 6f6e 5f72  def activation_r
-00004460: 6177 2872 6177 5f74 656e 736f 723a 2074  aw(raw_tensor: t
-00004470: 6f72 6368 2e54 656e 736f 722c 2066 756e  orch.Tensor, fun
-00004480: 633a 2073 7472 2920 2d3e 2074 6f72 6368  c: str) -> torch
-00004490: 2e54 656e 736f 723a 0a20 2020 2020 2020  .Tensor:.       
-000044a0: 2022 2222 0a20 2020 2020 2020 203a 7061   """.        :pa
-000044b0: 7261 6d20 7261 775f 7465 6e73 6f72 3a0a  ram raw_tensor:.
-000044c0: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-000044d0: 756e 633a 2065 2e67 2e20 2274 616e 6822  unc: e.g. "tanh"
-000044e0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000044f0: 3a20 7261 7720 7465 6e73 6f72 2061 6674  : raw tensor aft
-00004500: 6572 2061 6374 6976 6174 696f 6e0a 2020  er activation.  
-00004510: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004520: 2020 6173 7365 7274 2066 756e 6320 696e    assert func in
-00004530: 2042 6163 6b65 6e64 2e5f 416c 6c6f 7765   Backend._Allowe
-00004540: 6441 6374 6976 6174 696f 6e46 756e 6373  dActivationFuncs
-00004550: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
-00004560: 7474 7228 746f 7263 682c 2066 756e 6329  ttr(torch, func)
-00004570: 3a0a 2020 2020 2020 2020 2020 2020 6620  :.            f 
-00004580: 3d20 6765 7461 7474 7228 746f 7263 682c  = getattr(torch,
-00004590: 2066 756e 6329 0a20 2020 2020 2020 2065   func).        e
-000045a0: 6c69 6620 6861 7361 7474 7228 746f 7263  lif hasattr(torc
-000045b0: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2c  h.nn.functional,
-000045c0: 2066 756e 6329 3a0a 2020 2020 2020 2020   func):.        
-000045d0: 2020 2020 6620 3d20 6765 7461 7474 7228      f = getattr(
-000045e0: 746f 7263 682e 6e6e 2e66 756e 6374 696f  torch.nn.functio
-000045f0: 6e61 6c2c 2066 756e 6329 0a20 2020 2020  nal, func).     
-00004600: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004610: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00004620: 4572 726f 7228 6622 756e 6b6e 6f77 6e20  Error(f"unknown 
-00004630: 6163 7469 7661 7469 6f6e 2066 756e 6374  activation funct
-00004640: 696f 6e20 7b66 756e 6321 727d 2229 0a20  ion {func!r}"). 
-00004650: 2020 2020 2020 2072 6574 7572 6e20 6628         return f(
-00004660: 7261 775f 7465 6e73 6f72 290a 0a20 2020  raw_tensor)..   
-00004670: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-00004680: 2020 2064 6566 2073 6f66 746d 6178 2874     def softmax(t
-00004690: 656e 736f 723a 2054 656e 736f 722c 202a  ensor: Tensor, *
-000046a0: 2c20 6178 6973 3a20 4469 6d2c 2075 7365  , axis: Dim, use
-000046b0: 5f6d 6173 6b3a 2062 6f6f 6c20 3d20 5472  _mask: bool = Tr
-000046c0: 7565 2920 2d3e 2054 656e 736f 723a 0a20  ue) -> Tensor:. 
-000046d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000046e0: 2020 203a 7061 7261 6d20 7465 6e73 6f72     :param tensor
-000046f0: 3a0a 2020 2020 2020 2020 3a70 6172 616d  :.        :param
-00004700: 2061 7869 733a 0a20 2020 2020 2020 203a   axis:.        :
-00004710: 7061 7261 6d20 7573 655f 6d61 736b 3a0a  param use_mask:.
-00004720: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00004730: 2073 6f66 746d 6178 206f 7665 7220 6178   softmax over ax
-00004740: 6973 0a20 2020 2020 2020 2022 2222 0a20  is.        """. 
-00004750: 2020 2020 2020 206f 7574 203d 2074 656e         out = ten
-00004760: 736f 722e 636f 7079 5f74 656d 706c 6174  sor.copy_templat
-00004770: 6528 2273 6f66 746d 6178 2229 0a20 2020  e("softmax").   
-00004780: 2020 2020 2069 6620 7573 655f 6d61 736b       if use_mask
-00004790: 2061 6e64 2061 7869 732e 6e65 6564 5f6d   and axis.need_m
-000047a0: 6173 6b69 6e67 2829 3a0a 2020 2020 2020  asking():.      
-000047b0: 2020 2020 2020 7465 6e73 6f72 203d 2074        tensor = t
-000047c0: 656e 736f 722e 636f 7079 2829 0a20 2020  ensor.copy().   
-000047d0: 2020 2020 2020 2020 206d 6173 6b20 3d20           mask = 
-000047e0: 7465 6e73 6f72 2e67 6574 5f73 6571 7565  tensor.get_seque
-000047f0: 6e63 655f 6d61 736b 5f62 726f 6164 6361  nce_mask_broadca
-00004800: 7374 2861 7869 733d 6178 6973 290a 2020  st(axis=axis).  
-00004810: 2020 2020 2020 2020 2020 696e 665f 7661            inf_va
-00004820: 6c75 6520 3d20 6765 745f 676c 6f62 616c  lue = get_global
-00004830: 5f69 6e66 5f76 616c 7565 2829 0a20 2020  _inf_value().   
-00004840: 2020 2020 2020 2020 2074 656e 736f 722e           tensor.
-00004850: 7261 775f 7465 6e73 6f72 203d 2074 6f72  raw_tensor = tor
-00004860: 6368 2e77 6865 7265 286d 6173 6b2c 2074  ch.where(mask, t
-00004870: 656e 736f 722e 7261 775f 7465 6e73 6f72  ensor.raw_tensor
-00004880: 2c20 2d69 6e66 5f76 616c 7565 290a 2020  , -inf_value).  
-00004890: 2020 2020 2020 6f75 745f 7261 7720 3d20        out_raw = 
-000048a0: 746f 7263 682e 736f 6674 6d61 7828 7465  torch.softmax(te
-000048b0: 6e73 6f72 2e72 6177 5f74 656e 736f 722c  nsor.raw_tensor,
-000048c0: 2064 696d 3d74 656e 736f 722e 6469 6d73   dim=tensor.dims
-000048d0: 2e69 6e64 6578 2861 7869 7329 290a 2020  .index(axis)).  
-000048e0: 2020 2020 2020 6f75 742e 6474 7970 6520        out.dtype 
-000048f0: 3d20 546f 7263 6842 6163 6b65 6e64 2e67  = TorchBackend.g
-00004900: 6574 5f64 7479 7065 5f6e 616d 655f 7261  et_dtype_name_ra
-00004910: 7728 6f75 745f 7261 7729 0a20 2020 2020  w(out_raw).     
-00004920: 2020 206f 7574 2e72 6177 5f74 656e 736f     out.raw_tenso
-00004930: 7220 3d20 6f75 745f 7261 770a 2020 2020  r = out_raw.    
-00004940: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
-00004950: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00004960: 640a 2020 2020 6465 6620 6c6f 675f 736f  d.    def log_so
-00004970: 6674 6d61 7828 7465 6e73 6f72 3a20 5465  ftmax(tensor: Te
-00004980: 6e73 6f72 2c20 2a2c 2061 7869 733a 2044  nsor, *, axis: D
-00004990: 696d 2c20 7573 655f 6d61 736b 3a20 626f  im, use_mask: bo
-000049a0: 6f6c 203d 2054 7275 6529 202d 3e20 5465  ol = True) -> Te
-000049b0: 6e73 6f72 3a0a 2020 2020 2020 2020 2222  nsor:.        ""
-000049c0: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
-000049d0: 2074 656e 736f 723a 0a20 2020 2020 2020   tensor:.       
-000049e0: 203a 7061 7261 6d20 6178 6973 3a0a 2020   :param axis:.  
-000049f0: 2020 2020 2020 3a70 6172 616d 2075 7365        :param use
-00004a00: 5f6d 6173 6b3a 0a20 2020 2020 2020 203a  _mask:.        :
-00004a10: 7265 7475 726e 3a20 6c6f 675f 736f 6674  return: log_soft
-00004a20: 6d61 7820 6f76 6572 2061 7869 730a 2020  max over axis.  
-00004a30: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004a40: 2020 6f75 7420 3d20 7465 6e73 6f72 2e63    out = tensor.c
-00004a50: 6f70 795f 7465 6d70 6c61 7465 2822 6c6f  opy_template("lo
-00004a60: 675f 736f 6674 6d61 7822 290a 2020 2020  g_softmax").    
-00004a70: 2020 2020 6966 2075 7365 5f6d 6173 6b20      if use_mask 
-00004a80: 616e 6420 6178 6973 2e6e 6565 645f 6d61  and axis.need_ma
-00004a90: 736b 696e 6728 293a 0a20 2020 2020 2020  sking():.       
-00004aa0: 2020 2020 2074 656e 736f 7220 3d20 7465       tensor = te
-00004ab0: 6e73 6f72 2e63 6f70 7928 290a 2020 2020  nsor.copy().    
-00004ac0: 2020 2020 2020 2020 6d61 736b 203d 2074          mask = t
-00004ad0: 656e 736f 722e 6765 745f 7365 7175 656e  ensor.get_sequen
-00004ae0: 6365 5f6d 6173 6b5f 6272 6f61 6463 6173  ce_mask_broadcas
-00004af0: 7428 6178 6973 3d61 7869 7329 0a20 2020  t(axis=axis).   
-00004b00: 2020 2020 2020 2020 2069 6e66 5f76 616c           inf_val
-00004b10: 7565 203d 2067 6574 5f67 6c6f 6261 6c5f  ue = get_global_
-00004b20: 696e 665f 7661 6c75 6528 290a 2020 2020  inf_value().    
-00004b30: 2020 2020 2020 2020 7465 6e73 6f72 2e72          tensor.r
-00004b40: 6177 5f74 656e 736f 7220 3d20 746f 7263  aw_tensor = torc
-00004b50: 682e 7768 6572 6528 6d61 736b 2c20 7465  h.where(mask, te
-00004b60: 6e73 6f72 2e72 6177 5f74 656e 736f 722c  nsor.raw_tensor,
-00004b70: 202d 696e 665f 7661 6c75 6529 0a20 2020   -inf_value).   
-00004b80: 2020 2020 206f 7574 5f72 6177 203d 2074       out_raw = t
-00004b90: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
-00004ba0: 2874 656e 736f 722e 7261 775f 7465 6e73  (tensor.raw_tens
-00004bb0: 6f72 2c20 6469 6d3d 7465 6e73 6f72 2e64  or, dim=tensor.d
-00004bc0: 696d 732e 696e 6465 7828 6178 6973 2929  ims.index(axis))
-00004bd0: 0a20 2020 2020 2020 206f 7574 2e64 7479  .        out.dty
-00004be0: 7065 203d 2054 6f72 6368 4261 636b 656e  pe = TorchBacken
-00004bf0: 642e 6765 745f 6474 7970 655f 6e61 6d65  d.get_dtype_name
-00004c00: 5f72 6177 286f 7574 5f72 6177 290a 2020  _raw(out_raw).  
-00004c10: 2020 2020 2020 6f75 742e 7261 775f 7465        out.raw_te
-00004c20: 6e73 6f72 203d 206f 7574 5f72 6177 0a20  nsor = out_raw. 
-00004c30: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-00004c40: 740a 0a20 2020 2040 7374 6174 6963 6d65  t..    @staticme
-00004c50: 7468 6f64 0a20 2020 2064 6566 2073 6f66  thod.    def sof
-00004c60: 746d 6178 5f63 726f 7373 5f65 6e74 726f  tmax_cross_entro
-00004c70: 7079 5f77 6974 685f 6c6f 6769 7473 282a  py_with_logits(*
-00004c80: 2c20 6c6f 6769 7473 3a20 5465 6e73 6f72  , logits: Tensor
-00004c90: 2c20 7461 7267 6574 733a 2054 656e 736f  , targets: Tenso
-00004ca0: 722c 2061 7869 733a 2044 696d 293a 0a20  r, axis: Dim):. 
-00004cb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00004cc0: 2020 2045 6666 6963 6965 6e74 2063 726f     Efficient cro
-00004cd0: 7373 2065 6e74 726f 7079 2e20 466f 7220  ss entropy. For 
-00004ce0: 5079 546f 7263 6820 7468 6973 2069 7320  PyTorch this is 
-00004cf0: 6163 7475 616c 6c79 2074 6865 2064 6566  actually the def
-00004d00: 6175 6c74 2063 726f 7373 2065 6e74 726f  ault cross entro
-00004d10: 7079 2066 756e 6374 696f 6e2e 0a20 2020  py function..   
-00004d20: 2020 2020 2028 746f 7263 682e 6e6e 2e66       (torch.nn.f
-00004d30: 756e 6374 696f 6e61 6c2e 6372 6f73 735f  unctional.cross_
-00004d40: 656e 7472 6f70 7929 0a0a 2020 2020 2020  entropy)..      
-00004d50: 2020 3a70 6172 616d 206c 6f67 6974 733a    :param logits:
-00004d60: 2074 6172 6765 7420 6573 7469 6d61 7465   target estimate
-00004d70: 7320 6769 7665 6e20 6173 2069 6e70 7574  s given as input
-00004d80: 7320 746f 2073 6f66 746d 6178 2028 692e  s to softmax (i.
-00004d90: 652e 2075 6e6e 6f72 6d61 6c69 7a65 6429  e. unnormalized)
-00004da0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00004db0: 7461 7267 6574 733a 2070 726f 6261 6269  targets: probabi
-00004dc0: 6c69 7469 6573 2c20 692e 652e 206e 6f72  lities, i.e. nor
-00004dd0: 6d61 6c69 7a65 642c 2063 616e 2061 6c73  malized, can als
-00004de0: 6f20 6265 2073 7061 7273 650a 2020 2020  o be sparse.    
-00004df0: 2020 2020 3a70 6172 616d 2061 7869 733a      :param axis:
-00004e00: 2063 6c61 7373 206c 6162 656c 7320 6469   class labels di
-00004e10: 6d20 6f76 6572 2077 6869 6368 2073 6f66  m over which sof
-00004e20: 746d 6178 2069 7320 636f 6d70 7574 6564  tmax is computed
-00004e30: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00004e40: 3a20 6372 6f73 7320 656e 7472 6f70 7920  : cross entropy 
-00004e50: 2873 616d 6520 4469 6d73 2061 7320 276c  (same Dims as 'l
-00004e60: 6f67 6974 7327 2062 7574 2077 6974 686f  ogits' but witho
-00004e70: 7574 2027 6178 6973 2729 0a20 2020 2020  ut 'axis').     
-00004e80: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
-00004e90: 7373 6572 7420 6178 6973 2069 6e20 6c6f  ssert axis in lo
-00004ea0: 6769 7473 2e64 696d 732c 2022 5370 6563  gits.dims, "Spec
-00004eb0: 6966 6965 6420 6178 6973 206e 6f74 2070  ified axis not p
-00004ec0: 7265 7365 6e74 2069 6e20 6c6f 6769 7473  resent in logits
-00004ed0: 2e22 0a0a 2020 2020 2020 2020 6966 2061  ."..        if a
-00004ee0: 7869 7320 3d3d 2074 6172 6765 7473 2e73  xis == targets.s
-00004ef0: 7061 7273 655f 6469 6d3a 0a20 2020 2020  parse_dim:.     
-00004f00: 2020 2020 2020 2061 7373 6572 7420 280a         assert (.
-00004f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f20: 6c6f 6769 7473 2e64 696d 735f 7365 7420  logits.dims_set 
-00004f30: 2d20 7b61 7869 737d 203d 3d20 7461 7267  - {axis} == targ
-00004f40: 6574 732e 6469 6d73 5f73 6574 0a20 2020  ets.dims_set.   
-00004f50: 2020 2020 2020 2020 2029 2c20 226c 6f67           ), "log
-00004f60: 6974 7320 4469 6d73 2061 6e64 2074 6172  its Dims and tar
-00004f70: 6765 7420 4469 6d73 2068 6176 6520 746f  get Dims have to
-00004f80: 206d 6174 6368 2028 6578 6365 7074 2066   match (except f
-00004f90: 6f72 2069 6d70 6c69 6369 7420 7370 6172  or implicit spar
-00004fa0: 7365 5f64 696d 292e 220a 0a20 2020 2020  se_dim)."..     
-00004fb0: 2020 2020 2020 206c 6f67 6974 735f 6469         logits_di
-00004fc0: 6d5f 6f72 6465 7220 3d20 6c69 7374 2874  m_order = list(t
-00004fd0: 6172 6765 7473 2e64 696d 7329 0a20 2020  argets.dims).   
-00004fe0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00004ff0: 6c6f 6769 7473 5f64 696d 5f6f 7264 6572  logits_dim_order
-00005000: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00005010: 2020 2020 2020 2023 2050 7954 6f72 6368         # PyTorch
-00005020: 2773 2063 726f 7373 5f65 6e74 726f 7079  's cross_entropy
-00005030: 2065 7870 6563 7473 2063 6c61 7373 2070   expects class p
-00005040: 726f 6261 6269 6c69 7469 6573 206f 7665  robabilities ove
-00005050: 7220 7365 636f 6e64 2061 7869 732e 0a20  r second axis.. 
-00005060: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00005070: 6f67 6974 735f 6469 6d5f 6f72 6465 722e  ogits_dim_order.
-00005080: 696e 7365 7274 2831 2c20 6178 6973 290a  insert(1, axis).
-00005090: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000050a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000050b0: 2020 6c6f 6769 7473 5f64 696d 5f6f 7264    logits_dim_ord
-000050c0: 6572 203d 205b 6178 6973 5d0a 0a20 2020  er = [axis]..   
-000050d0: 2020 2020 2020 2020 2069 6620 7461 7267           if targ
-000050e0: 6574 732e 6474 7970 6520 213d 2022 696e  ets.dtype != "in
-000050f0: 7436 3422 3a0a 2020 2020 2020 2020 2020  t64":.          
-00005100: 2020 2020 2020 7461 7267 6574 7320 3d20        targets = 
-00005110: 7461 7267 6574 732e 636f 7079 2829 0a20  targets.copy(). 
-00005120: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00005130: 6172 6765 7473 2e64 7479 7065 203d 2022  argets.dtype = "
-00005140: 696e 7436 3422 0a20 2020 2020 2020 2020  int64".         
-00005150: 2020 2020 2020 2074 6172 6765 7473 2e72         targets.r
-00005160: 6177 5f74 656e 736f 7220 3d20 7461 7267  aw_tensor = targ
-00005170: 6574 732e 7261 775f 7465 6e73 6f72 2e6c  ets.raw_tensor.l
-00005180: 6f6e 6728 290a 0a20 2020 2020 2020 2065  ong()..        e
-00005190: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000051a0: 2061 7373 6572 7420 280a 2020 2020 2020   assert (.      
-000051b0: 2020 2020 2020 2020 2020 6e6f 7420 7461            not ta
-000051c0: 7267 6574 732e 7370 6172 7365 5f64 696d  rgets.sparse_dim
-000051d0: 0a20 2020 2020 2020 2020 2020 2029 2c20  .            ), 
-000051e0: 2257 6520 6578 7065 6374 2074 6861 7420  "We expect that 
-000051f0: 6372 6f73 7320 656e 7472 6f70 7920 776f  cross entropy wo
-00005200: 756c 6420 616c 7761 7973 2062 6520 6361  uld always be ca
-00005210: 6c63 756c 6174 6564 2061 6c6f 6e67 2074  lculated along t
-00005220: 6865 2073 7061 7273 6520 6469 6d2c 2069  he sparse dim, i
-00005230: 6620 7468 6572 6520 6973 206f 6e65 2e22  f there is one."
-00005240: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00005250: 6572 7420 6c6f 6769 7473 2e64 696d 735f  ert logits.dims_
-00005260: 7365 7420 3d3d 2074 6172 6765 7473 2e64  set == targets.d
-00005270: 696d 735f 7365 742c 2022 6c6f 6769 7473  ims_set, "logits
-00005280: 2044 696d 7320 616e 6420 7461 7267 6574   Dims and target
-00005290: 2044 696d 7320 6861 7665 2074 6f20 6d61   Dims have to ma
-000052a0: 7463 682e 220a 2020 2020 2020 2020 2020  tch.".          
-000052b0: 2020 6173 7365 7274 2061 7869 7320 696e    assert axis in
-000052c0: 2074 6172 6765 7473 2e64 696d 732c 2022   targets.dims, "
-000052d0: 5370 6563 6966 6965 6420 6178 6973 206e  Specified axis n
-000052e0: 6f74 2070 7265 7365 6e74 2069 6e20 7461  ot present in ta
-000052f0: 7267 6574 732e 220a 0a20 2020 2020 2020  rgets."..       
-00005300: 2020 2020 2069 6620 6c65 6e28 7461 7267       if len(targ
-00005310: 6574 732e 6469 6d73 2920 3e20 313a 0a20  ets.dims) > 1:. 
-00005320: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005330: 2050 7954 6f72 6368 2773 2063 726f 7373   PyTorch's cross
-00005340: 5f65 6e74 726f 7079 2065 7870 6563 7473  _entropy expects
-00005350: 2063 6c61 7373 2070 726f 6261 6269 6c69   class probabili
-00005360: 7469 6573 206f 7665 7220 7365 636f 6e64  ties over second
-00005370: 2061 7869 732e 0a20 2020 2020 2020 2020   axis..         
-00005380: 2020 2020 2020 2074 6172 6765 7473 203d         targets =
-00005390: 2074 6172 6765 7473 2e63 6f70 795f 6d6f   targets.copy_mo
-000053a0: 7665 5f61 7869 7328 7461 7267 6574 732e  ve_axis(targets.
-000053b0: 6469 6d73 2e69 6e64 6578 2861 7869 7329  dims.index(axis)
-000053c0: 2c20 3129 0a0a 2020 2020 2020 2020 2020  , 1)..          
-000053d0: 2020 6c6f 6769 7473 5f64 696d 5f6f 7264    logits_dim_ord
-000053e0: 6572 203d 2074 6172 6765 7473 2e64 696d  er = targets.dim
-000053f0: 730a 0a20 2020 2020 2020 2023 2057 6520  s..        # We 
-00005400: 6e65 6564 2073 616d 6520 6f72 6465 7220  need same order 
-00005410: 6f66 2061 7865 7320 6173 2069 6e20 7461  of axes as in ta
-00005420: 7267 6574 2e0a 2020 2020 2020 2020 6c6f  rget..        lo
-00005430: 6769 7473 5f61 7865 735f 7065 726d 7574  gits_axes_permut
-00005440: 6174 696f 6e20 3d20 5b6c 6f67 6974 735f  ation = [logits_
-00005450: 6469 6d5f 6f72 6465 722e 696e 6465 7828  dim_order.index(
-00005460: 6469 6d29 2066 6f72 2064 696d 2069 6e20  dim) for dim in 
-00005470: 6c6f 6769 7473 2e64 696d 735d 0a20 2020  logits.dims].   
-00005480: 2020 2020 206c 6f67 6974 7320 3d20 6c6f       logits = lo
-00005490: 6769 7473 2e63 6f70 795f 7472 616e 7370  gits.copy_transp
-000054a0: 6f73 6528 6c6f 6769 7473 5f61 7865 735f  ose(logits_axes_
-000054b0: 7065 726d 7574 6174 696f 6e29 0a0a 2020  permutation)..  
-000054c0: 2020 2020 2020 7261 775f 6372 6f73 735f        raw_cross_
-000054d0: 656e 7472 6f70 7920 3d20 746f 7263 682e  entropy = torch.
-000054e0: 6e6e 2e66 756e 6374 696f 6e61 6c2e 6372  nn.functional.cr
-000054f0: 6f73 735f 656e 7472 6f70 7928 0a20 2020  oss_entropy(.   
-00005500: 2020 2020 2020 2020 2069 6e70 7574 3d6c           input=l
-00005510: 6f67 6974 732e 7261 775f 7465 6e73 6f72  ogits.raw_tensor
-00005520: 2c20 7461 7267 6574 3d74 6172 6765 7473  , target=targets
-00005530: 2e72 6177 5f74 656e 736f 722c 2072 6564  .raw_tensor, red
-00005540: 7563 7469 6f6e 3d22 6e6f 6e65 220a 2020  uction="none".  
-00005550: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00005560: 206f 7574 5f64 696d 7320 3d20 6c69 7374   out_dims = list
-00005570: 286c 6f67 6974 732e 6469 6d73 290a 2020  (logits.dims).  
-00005580: 2020 2020 2020 6f75 745f 6469 6d73 2e72        out_dims.r
-00005590: 656d 6f76 6528 6178 6973 290a 0a20 2020  emove(axis)..   
-000055a0: 2020 2020 2063 726f 7373 5f65 6e74 726f       cross_entro
-000055b0: 7079 203d 2054 656e 736f 7228 6e61 6d65  py = Tensor(name
-000055c0: 3d22 6372 6f73 735f 656e 7472 6f70 7922  ="cross_entropy"
-000055d0: 2c20 6469 6d73 3d6f 7574 5f64 696d 732c  , dims=out_dims,
-000055e0: 2072 6177 5f74 656e 736f 723d 7261 775f   raw_tensor=raw_
-000055f0: 6372 6f73 735f 656e 7472 6f70 792c 2064  cross_entropy, d
-00005600: 7479 7065 3d6c 6f67 6974 732e 6474 7970  type=logits.dtyp
-00005610: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
-00005620: 726e 2063 726f 7373 5f65 6e74 726f 7079  rn cross_entropy
-00005630: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
-00005640: 686f 640a 2020 2020 6465 6620 6374 635f  hod.    def ctc_
-00005650: 6c6f 7373 280a 2020 2020 2020 2020 2a2c  loss(.        *,
-00005660: 0a20 2020 2020 2020 206c 6f67 6974 733a  .        logits:
-00005670: 2054 656e 736f 722c 0a20 2020 2020 2020   Tensor,.       
-00005680: 2074 6172 6765 7473 3a20 5465 6e73 6f72   targets: Tensor
-00005690: 2c0a 2020 2020 2020 2020 696e 7075 745f  ,.        input_
-000056a0: 7370 6174 6961 6c5f 6469 6d3a 2044 696d  spatial_dim: Dim
-000056b0: 2c0a 2020 2020 2020 2020 7461 7267 6574  ,.        target
-000056c0: 735f 7370 6174 6961 6c5f 6469 6d3a 2044  s_spatial_dim: D
-000056d0: 696d 2c0a 2020 2020 2020 2020 626c 616e  im,.        blan
-000056e0: 6b5f 696e 6465 783a 2069 6e74 2c0a 2020  k_index: int,.  
-000056f0: 2020 2020 2020 6d61 785f 6170 7072 6f78        max_approx
-00005700: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00005710: 2020 2020 2920 2d3e 2054 656e 736f 723a      ) -> Tensor:
-00005720: 0a20 2020 2020 2020 2022 2222 4354 4322  .        """CTC"
-00005730: 2222 0a20 2020 2020 2020 2069 6620 6d61  "".        if ma
-00005740: 785f 6170 7072 6f78 3a0a 2020 2020 2020  x_approx:.      
-00005750: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-00005760: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-00005770: 2263 7463 5f6c 6f73 733a 206d 6178 5f61  "ctc_loss: max_a
-00005780: 7070 726f 7820 6e6f 7420 696d 706c 656d  pprox not implem
-00005790: 656e 7465 6420 666f 7220 5079 546f 7263  ented for PyTorc
-000057a0: 6822 290a 2020 2020 2020 2020 6173 7365  h").        asse
-000057b0: 7274 2074 6172 6765 7473 2e73 7061 7273  rt targets.spars
-000057c0: 655f 6469 6d20 616e 6420 7461 7267 6574  e_dim and target
-000057d0: 732e 7370 6172 7365 5f64 696d 2e64 696d  s.sparse_dim.dim
-000057e0: 656e 7369 6f6e 203c 3d20 6c6f 6769 7473  ension <= logits
-000057f0: 2e66 6561 7475 7265 5f64 696d 2e64 696d  .feature_dim.dim
-00005800: 656e 7369 6f6e 0a20 2020 2020 2020 2023  ension.        #
-00005810: 2050 7954 6f72 6368 2065 7870 6563 7473   PyTorch expects
-00005820: 2074 6865 206c 6f67 6974 7320 746f 2062   the logits to b
-00005830: 6520 6f66 2073 6861 7065 2028 542c 2042  e of shape (T, B
-00005840: 2c20 4329 2077 6865 7265 2054 2069 7320  , C) where T is 
-00005850: 7468 6520 696e 7075 7420 7370 6174 6961  the input spatia
-00005860: 6c20 6469 6d2e 0a20 2020 2020 2020 2062  l dim..        b
-00005870: 6174 6368 5f64 696d 7320 3d20 6c6f 6769  atch_dims = logi
-00005880: 7473 2e72 656d 6169 6e69 6e67 5f64 696d  ts.remaining_dim
-00005890: 7328 2869 6e70 7574 5f73 7061 7469 616c  s((input_spatial
-000058a0: 5f64 696d 2c20 6c6f 6769 7473 2e66 6561  _dim, logits.fea
-000058b0: 7475 7265 5f64 696d 2929 0a20 2020 2020  ture_dim)).     
-000058c0: 2020 206c 6f67 6974 7320 3d20 6c6f 6769     logits = logi
-000058d0: 7473 2e63 6f70 795f 7472 616e 7370 6f73  ts.copy_transpos
-000058e0: 6528 5b69 6e70 7574 5f73 7061 7469 616c  e([input_spatial
-000058f0: 5f64 696d 5d20 2b20 6261 7463 685f 6469  _dim] + batch_di
-00005900: 6d73 202b 205b 6c6f 6769 7473 2e66 6561  ms + [logits.fea
-00005910: 7475 7265 5f64 696d 5d29 0a20 2020 2020  ture_dim]).     
-00005920: 2020 206c 6f67 6974 735f 7261 773a 2074     logits_raw: t
-00005930: 6f72 6368 2e54 656e 736f 7220 3d20 6c6f  orch.Tensor = lo
-00005940: 6769 7473 2e72 6177 5f74 656e 736f 720a  gits.raw_tensor.
-00005950: 2020 2020 2020 2020 696e 7075 745f 6c65          input_le
-00005960: 6e67 7468 7320 3d20 696e 7075 745f 7370  ngths = input_sp
-00005970: 6174 6961 6c5f 6469 6d2e 6479 6e5f 7369  atial_dim.dyn_si
-00005980: 7a65 5f65 7874 2e63 6f70 795f 7472 616e  ze_ext.copy_tran
-00005990: 7370 6f73 6528 6261 7463 685f 6469 6d73  spose(batch_dims
-000059a0: 292e 7261 775f 7465 6e73 6f72 0a20 2020  ).raw_tensor.   
-000059b0: 2020 2020 206c 6f67 6974 735f 7261 775f       logits_raw_
-000059c0: 7368 6170 6520 3d20 6c6f 6769 7473 5f72  shape = logits_r
-000059d0: 6177 2e73 6861 7065 2020 2320 5b54 2c20  aw.shape  # [T, 
-000059e0: 422e 2e2e 2c20 435d 0a20 2020 2020 2020  B..., C].       
-000059f0: 2069 6620 6c65 6e28 6261 7463 685f 6469   if len(batch_di
-00005a00: 6d73 2920 213d 2031 3a0a 2020 2020 2020  ms) != 1:.      
-00005a10: 2020 2020 2020 6c6f 6769 7473 5f72 6177        logits_raw
-00005a20: 203d 2074 6f72 6368 2e72 6573 6861 7065   = torch.reshape
-00005a30: 286c 6f67 6974 735f 7261 772c 206c 6f67  (logits_raw, log
-00005a40: 6974 735f 7261 772e 7368 6170 655b 3a31  its_raw.shape[:1
-00005a50: 5d20 2b20 282d 312c 2920 2b20 6c6f 6769  ] + (-1,) + logi
-00005a60: 7473 5f72 6177 2e73 6861 7065 5b2d 313a  ts_raw.shape[-1:
-00005a70: 5d29 2020 2320 5b54 2c20 4227 2c20 435d  ])  # [T, B', C]
-00005a80: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
-00005a90: 7574 5f6c 656e 6774 6873 203d 2074 6f72  ut_lengths = tor
-00005aa0: 6368 2e72 6573 6861 7065 2869 6e70 7574  ch.reshape(input
-00005ab0: 5f6c 656e 6774 6873 2c20 282d 312c 2929  _lengths, (-1,))
-00005ac0: 2020 2320 5b42 275d 0a20 2020 2020 2020    # [B'].       
-00005ad0: 206c 6f67 5f70 726f 6273 203d 2074 6f72   log_probs = tor
-00005ae0: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
-00005af0: 2e6c 6f67 5f73 6f66 746d 6178 286c 6f67  .log_softmax(log
-00005b00: 6974 735f 7261 772c 2064 696d 3d2d 3129  its_raw, dim=-1)
-00005b10: 0a20 2020 2020 2020 2023 2050 7954 6f72  .        # PyTor
-00005b20: 6368 2065 7870 6563 7473 2074 6865 2074  ch expects the t
-00005b30: 6172 6765 7473 2074 6f20 6265 206f 6620  argets to be of 
-00005b40: 7368 6170 6520 2842 2c20 5329 2077 6865  shape (B, S) whe
-00005b50: 7265 2053 2069 7320 7468 6520 7461 7267  re S is the targ
-00005b60: 6574 7320 7370 6174 6961 6c20 6469 6d2e  ets spatial dim.
-00005b70: 0a20 2020 2020 2020 2074 6172 6765 7473  .        targets
-00005b80: 203d 2074 6172 6765 7473 2e63 6f70 795f   = targets.copy_
-00005b90: 7472 616e 7370 6f73 6528 6261 7463 685f  transpose(batch_
-00005ba0: 6469 6d73 202b 205b 7461 7267 6574 735f  dims + [targets_
-00005bb0: 7370 6174 6961 6c5f 6469 6d5d 290a 2020  spatial_dim]).  
-00005bc0: 2020 2020 2020 7461 7267 6574 735f 7261        targets_ra
-00005bd0: 7720 3d20 7461 7267 6574 732e 7261 775f  w = targets.raw_
-00005be0: 7465 6e73 6f72 2020 2320 5b42 2e2e 2e2c  tensor  # [B...,
-00005bf0: 2053 5d0a 2020 2020 2020 2020 7461 7267   S].        targ
-00005c00: 6574 735f 6c65 6e67 7468 7320 3d20 7461  ets_lengths = ta
-00005c10: 7267 6574 735f 7370 6174 6961 6c5f 6469  rgets_spatial_di
-00005c20: 6d2e 6479 6e5f 7369 7a65 5f65 7874 2e63  m.dyn_size_ext.c
-00005c30: 6f70 795f 7472 616e 7370 6f73 6528 6261  opy_transpose(ba
-00005c40: 7463 685f 6469 6d73 292e 7261 775f 7465  tch_dims).raw_te
-00005c50: 6e73 6f72 0a20 2020 2020 2020 2069 6620  nsor.        if 
-00005c60: 6c65 6e28 6261 7463 685f 6469 6d73 2920  len(batch_dims) 
-00005c70: 213d 2031 3a0a 2020 2020 2020 2020 2020  != 1:.          
-00005c80: 2020 7461 7267 6574 735f 7261 7720 3d20    targets_raw = 
-00005c90: 746f 7263 682e 7265 7368 6170 6528 7461  torch.reshape(ta
-00005ca0: 7267 6574 735f 7261 772c 2028 2d31 2c20  rgets_raw, (-1, 
-00005cb0: 7461 7267 6574 735f 7261 772e 7368 6170  targets_raw.shap
-00005cc0: 655b 2d31 5d29 2920 2023 205b 4227 2c20  e[-1]))  # [B', 
-00005cd0: 535d 0a20 2020 2020 2020 2020 2020 2074  S].            t
-00005ce0: 6172 6765 7473 5f6c 656e 6774 6873 203d  argets_lengths =
-00005cf0: 2074 6f72 6368 2e72 6573 6861 7065 2874   torch.reshape(t
-00005d00: 6172 6765 7473 5f6c 656e 6774 6873 2c20  argets_lengths, 
-00005d10: 282d 312c 2929 2020 2320 5b42 275d 0a20  (-1,))  # [B']. 
-00005d20: 2020 2020 2020 206c 6f73 735f 7261 7720         loss_raw 
-00005d30: 3d20 746f 7263 682e 6e6e 2e66 756e 6374  = torch.nn.funct
-00005d40: 696f 6e61 6c2e 6374 635f 6c6f 7373 280a  ional.ctc_loss(.
-00005d50: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-00005d60: 7072 6f62 733d 6c6f 675f 7072 6f62 732c  probs=log_probs,
-00005d70: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
-00005d80: 6765 7473 3d74 6172 6765 7473 5f72 6177  gets=targets_raw
-00005d90: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-00005da0: 7075 745f 6c65 6e67 7468 733d 696e 7075  put_lengths=inpu
-00005db0: 745f 6c65 6e67 7468 732c 0a20 2020 2020  t_lengths,.     
-00005dc0: 2020 2020 2020 2074 6172 6765 745f 6c65         target_le
-00005dd0: 6e67 7468 733d 7461 7267 6574 735f 6c65  ngths=targets_le
-00005de0: 6e67 7468 732c 0a20 2020 2020 2020 2020  ngths,.         
-00005df0: 2020 2062 6c61 6e6b 3d62 6c61 6e6b 5f69     blank=blank_i
-00005e00: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
-00005e10: 2020 7a65 726f 5f69 6e66 696e 6974 793d    zero_infinity=
-00005e20: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-00005e30: 2020 7265 6475 6374 696f 6e3d 226e 6f6e    reduction="non
-00005e40: 6522 2c0a 2020 2020 2020 2020 290a 2020  e",.        ).  
-00005e50: 2020 2020 2020 6966 206c 656e 2862 6174        if len(bat
-00005e60: 6368 5f64 696d 7329 2021 3d20 313a 0a20  ch_dims) != 1:. 
-00005e70: 2020 2020 2020 2020 2020 206c 6f73 735f             loss_
-00005e80: 7261 7720 3d20 746f 7263 682e 7265 7368  raw = torch.resh
-00005e90: 6170 6528 6c6f 7373 5f72 6177 2c20 6c6f  ape(loss_raw, lo
-00005ea0: 6769 7473 5f72 6177 5f73 6861 7065 5b31  gits_raw_shape[1
-00005eb0: 3a2d 315d 290a 2020 2020 2020 2020 6c6f  :-1]).        lo
-00005ec0: 7373 203d 2054 656e 736f 7228 0a20 2020  ss = Tensor(.   
-00005ed0: 2020 2020 2020 2020 206e 616d 653d 2263           name="c
-00005ee0: 7463 5f6c 6f73 7322 2c0a 2020 2020 2020  tc_loss",.      
-00005ef0: 2020 2020 2020 6469 6d73 3d62 6174 6368        dims=batch
-00005f00: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
-00005f10: 2020 2072 6177 5f74 656e 736f 723d 6c6f     raw_tensor=lo
-00005f20: 7373 5f72 6177 2c0a 2020 2020 2020 2020  ss_raw,.        
-00005f30: 2020 2020 6474 7970 653d 6c6f 6769 7473      dtype=logits
-00005f40: 2e64 7479 7065 2c0a 2020 2020 2020 2020  .dtype,.        
-00005f50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00005f60: 206c 6f73 730a 0a20 2020 2040 7374 6174   loss..    @stat
-00005f70: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00005f80: 2063 7265 6174 655f 7061 7261 6d65 7465   create_paramete
-00005f90: 725f 7261 7728 7465 6e73 6f72 3a20 7266  r_raw(tensor: rf
-00005fa0: 2e50 6172 616d 6574 6572 2c20 2a2c 2064  .Parameter, *, d
-00005fb0: 6576 6963 653a 204f 7074 696f 6e61 6c5b  evice: Optional[
-00005fc0: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
-00005fd0: 746f 7263 682e 6e6e 2e50 6172 616d 6574  torch.nn.Paramet
-00005fe0: 6572 3a0a 2020 2020 2020 2020 2222 220a  er:.        """.
-00005ff0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00006000: 2070 6172 616d 6574 6572 0a20 2020 2020   parameter.     
-00006010: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
-00006020: 7373 6572 7420 616c 6c28 642e 6973 5f73  ssert all(d.is_s
-00006030: 7461 7469 6328 2920 666f 7220 6420 696e  tatic() for d in
-00006040: 2074 656e 736f 722e 6469 6d73 290a 2020   tensor.dims).  
-00006050: 2020 2020 2020 6461 7461 203d 2074 6f72        data = tor
-00006060: 6368 2e7a 6572 6f73 280a 2020 2020 2020  ch.zeros(.      
-00006070: 2020 2020 2020 5b64 2e64 696d 656e 7369        [d.dimensi
-00006080: 6f6e 2066 6f72 2064 2069 6e20 7465 6e73  on for d in tens
-00006090: 6f72 2e64 696d 735d 2c0a 2020 2020 2020  or.dims],.      
-000060a0: 2020 2020 2020 6474 7970 653d 546f 7263        dtype=Torc
-000060b0: 6842 6163 6b65 6e64 2e61 735f 6474 7970  hBackend.as_dtyp
-000060c0: 655f 7261 7728 7465 6e73 6f72 2e64 7479  e_raw(tensor.dty
-000060d0: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
-000060e0: 2064 6576 6963 653d 6465 7669 6365 206f   device=device o
-000060f0: 7220 7266 2e67 6574 5f64 6566 6175 6c74  r rf.get_default
-00006100: 5f64 6576 6963 6528 292c 0a20 2020 2020  _device(),.     
-00006110: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-00006120: 7465 6e73 6f72 2e64 7479 7065 2e73 7461  tensor.dtype.sta
-00006130: 7274 7377 6974 6828 2269 6e74 2229 206f  rtswith("int") o
-00006140: 7220 7465 6e73 6f72 2e64 7479 7065 203d  r tensor.dtype =
-00006150: 3d20 2262 6f6f 6c22 3a0a 2020 2020 2020  = "bool":.      
-00006160: 2020 2020 2020 7265 7175 6972 6573 5f67        requires_g
-00006170: 7261 6420 3d20 4661 6c73 650a 2020 2020  rad = False.    
-00006180: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00006190: 2020 2020 2020 7265 7175 6972 6573 5f67        requires_g
-000061a0: 7261 6420 3d20 5472 7565 0a20 2020 2020  rad = True.     
-000061b0: 2020 2072 6574 7572 6e20 746f 7263 682e     return torch.
-000061c0: 6e6e 2e50 6172 616d 6574 6572 2864 6174  nn.Parameter(dat
-000061d0: 612c 2072 6571 7569 7265 735f 6772 6164  a, requires_grad
-000061e0: 3d72 6571 7569 7265 735f 6772 6164 290a  =requires_grad).
-000061f0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-00006200: 6f64 0a20 2020 2064 6566 2073 6574 5f70  od.    def set_p
-00006210: 6172 616d 6574 6572 5f69 6e69 7469 616c  arameter_initial
-00006220: 5f76 616c 7565 2870 6172 616d 3a20 7266  _value(param: rf
-00006230: 2e50 6172 616d 6574 6572 2c20 7661 6c75  .Parameter, valu
-00006240: 653a 2055 6e69 6f6e 5b4e 6f6e 652c 2054  e: Union[None, T
-00006250: 656e 736f 722c 2072 662e 5261 7754 656e  ensor, rf.RawTen
-00006260: 736f 7254 7970 6573 5d29 202d 3e20 4e6f  sorTypes]) -> No
-00006270: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-00006280: 2020 2020 2020 2020 3a70 6172 616d 2070          :param p
-00006290: 6172 616d 3a20 7061 7261 6d65 7465 720a  aram: parameter.
-000062a0: 2020 2020 2020 2020 3a70 6172 616d 2076          :param v
-000062b0: 616c 7565 3a20 696e 6974 6961 6c20 7661  alue: initial va
-000062c0: 6c75 650a 2020 2020 2020 2020 2222 220a  lue.        """.
-000062d0: 2020 2020 2020 2020 6966 2076 616c 7565          if value
-000062e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000062f0: 2020 2020 2020 7661 6c75 6520 3d20 300a        value = 0.
-00006300: 2020 2020 2020 2020 7261 775f 7061 7261          raw_para
-00006310: 6d20 3d20 7061 7261 6d2e 7261 775f 7465  m = param.raw_te
-00006320: 6e73 6f72 0a20 2020 2020 2020 2061 7373  nsor.        ass
-00006330: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
-00006340: 6177 5f70 6172 616d 2c20 746f 7263 682e  aw_param, torch.
-00006350: 6e6e 2e50 6172 616d 6574 6572 290a 2020  nn.Parameter).  
-00006360: 2020 2020 2020 7769 7468 2074 6f72 6368        with torch
-00006370: 2e6e 6f5f 6772 6164 2829 3a0a 2020 2020  .no_grad():.    
-00006380: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00006390: 7461 6e63 6528 7661 6c75 652c 2054 656e  tance(value, Ten
-000063a0: 736f 7229 3a0a 2020 2020 2020 2020 2020  sor):.          
-000063b0: 2020 2020 2020 7661 6c75 655f 7261 7720        value_raw 
-000063c0: 3d20 7661 6c75 652e 636f 7079 5f63 6f6d  = value.copy_com
-000063d0: 7061 7469 626c 655f 746f 5f64 696d 735f  patible_to_dims_
-000063e0: 7261 7728 7061 7261 6d2e 6469 6d73 290a  raw(param.dims).
-000063f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006400: 7261 775f 7061 7261 6d2e 636f 7079 5f28  raw_param.copy_(
-00006410: 7661 6c75 655f 7261 7729 0a20 2020 2020  value_raw).     
-00006420: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-00006430: 7374 616e 6365 2876 616c 7565 2c20 6e75  stance(value, nu
-00006440: 6d70 792e 6e64 6172 7261 7929 3a0a 2020  mpy.ndarray):.  
-00006450: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00006460: 775f 7061 7261 6d2e 636f 7079 5f28 746f  w_param.copy_(to
-00006470: 7263 682e 6672 6f6d 5f6e 756d 7079 2876  rch.from_numpy(v
-00006480: 616c 7565 2929 0a20 2020 2020 2020 2020  alue)).         
-00006490: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000064a0: 2020 2020 2020 2020 2072 6177 5f70 6172           raw_par
-000064b0: 616d 2e63 6f70 795f 2876 616c 7565 290a  am.copy_(value).
-000064c0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-000064d0: 6f64 0a20 2020 2064 6566 2073 6574 5f70  od.    def set_p
-000064e0: 6172 616d 6574 6572 5f74 7261 696e 6162  arameter_trainab
-000064f0: 6c65 2870 6172 616d 3a20 7266 2e50 6172  le(param: rf.Par
-00006500: 616d 6574 6572 2c20 7472 6169 6e61 626c  ameter, trainabl
-00006510: 653a 2062 6f6f 6c29 202d 3e20 4e6f 6e65  e: bool) -> None
-00006520: 3a0a 2020 2020 2020 2020 2222 2273 6574  :.        """set
-00006530: 2074 7261 696e 6162 6c65 2222 220a 2020   trainable""".  
-00006540: 2020 2020 2020 7261 775f 7061 7261 6d20        raw_param 
-00006550: 3d20 7061 7261 6d2e 7261 775f 7465 6e73  = param.raw_tens
-00006560: 6f72 0a20 2020 2020 2020 2061 7373 6572  or.        asser
-00006570: 7420 6973 696e 7374 616e 6365 2872 6177  t isinstance(raw
-00006580: 5f70 6172 616d 2c20 746f 7263 682e 6e6e  _param, torch.nn
-00006590: 2e50 6172 616d 6574 6572 290a 2020 2020  .Parameter).    
-000065a0: 2020 2020 7261 775f 7061 7261 6d2e 7265      raw_param.re
-000065b0: 7175 6972 6573 5f67 7261 6420 3d20 7472  quires_grad = tr
-000065c0: 6169 6e61 626c 650a 0a20 2020 2040 7374  ainable..    @st
-000065d0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-000065e0: 6566 2070 6172 616d 6574 6572 5f61 7373  ef parameter_ass
-000065f0: 6967 6e28 7061 7261 6d3a 2072 662e 5061  ign(param: rf.Pa
-00006600: 7261 6d65 7465 722c 2076 616c 7565 3a20  rameter, value: 
-00006610: 5465 6e73 6f72 2c20 2a2c 206f 703a 2073  Tensor, *, op: s
-00006620: 7472 203d 2022 6173 7369 676e 2229 202d  tr = "assign") -
-00006630: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00006640: 2222 2270 6172 616d 2061 7373 6967 6e22  """param assign"
-00006650: 2222 0a20 2020 2020 2020 2072 6177 5f70  "".        raw_p
-00006660: 6172 616d 203d 2070 6172 616d 2e72 6177  aram = param.raw
-00006670: 5f74 656e 736f 720a 2020 2020 2020 2020  _tensor.        
-00006680: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00006690: 6528 7261 775f 7061 7261 6d2c 2074 6f72  e(raw_param, tor
-000066a0: 6368 2e6e 6e2e 5061 7261 6d65 7465 7229  ch.nn.Parameter)
-000066b0: 0a20 2020 2020 2020 2076 616c 7565 5f72  .        value_r
-000066c0: 6177 203d 2076 616c 7565 2e63 6f70 795f  aw = value.copy_
-000066d0: 636f 6d70 6174 6962 6c65 5f74 6f5f 6469  compatible_to_di
-000066e0: 6d73 5f72 6177 2870 6172 616d 2e64 696d  ms_raw(param.dim
-000066f0: 7329 0a20 2020 2020 2020 2077 6974 6820  s).        with 
-00006700: 746f 7263 682e 6e6f 5f67 7261 6428 293a  torch.no_grad():
-00006710: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00006720: 6f70 203d 3d20 2261 7373 6967 6e22 3a0a  op == "assign":.
-00006730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006740: 7261 775f 7061 7261 6d2e 636f 7079 5f28  raw_param.copy_(
-00006750: 7661 6c75 655f 7261 7729 0a20 2020 2020  value_raw).     
-00006760: 2020 2020 2020 2065 6c69 6620 6f70 203d         elif op =
-00006770: 3d20 2261 6464 223a 0a20 2020 2020 2020  = "add":.       
-00006780: 2020 2020 2020 2020 2072 6177 5f70 6172           raw_par
-00006790: 616d 2e61 6464 5f28 7661 6c75 655f 7261  am.add_(value_ra
-000067a0: 7729 0a20 2020 2020 2020 2020 2020 2065  w).            e
-000067b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000067c0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000067d0: 4572 726f 7228 6622 5061 7261 6d65 7465  Error(f"Paramete
-000067e0: 7220 7b70 6172 616d 7d20 6173 7369 676e  r {param} assign
-000067f0: 3a20 556e 7375 7070 6f72 7465 6420 6f70  : Unsupported op
-00006800: 3a20 7b6f 707d 2229 0a0a 2020 2020 4073  : {op}")..    @s
-00006810: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-00006820: 6465 6620 7061 7261 6d65 7465 725f 6173  def parameter_as
-00006830: 7369 676e 5f6b 6579 280a 2020 2020 2020  sign_key(.      
-00006840: 2020 7061 7261 6d3a 2072 662e 5061 7261    param: rf.Para
-00006850: 6d65 7465 722c 0a20 2020 2020 2020 206b  meter,.        k
-00006860: 6579 3a20 7266 2e49 7465 6d4b 6579 5479  ey: rf.ItemKeyTy
-00006870: 7065 2c0a 2020 2020 2020 2020 7661 6c75  pe,.        valu
-00006880: 653a 2054 656e 736f 722c 0a20 2020 2020  e: Tensor,.     
-00006890: 2020 202a 2c0a 2020 2020 2020 2020 6f70     *,.        op
-000068a0: 3a20 7374 7220 3d20 2261 7373 6967 6e22  : str = "assign"
-000068b0: 2c0a 2020 2020 2020 2020 6178 6973 3a20  ,.        axis: 
-000068c0: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b44  Optional[Union[D
-000068d0: 696d 2c20 5365 7175 656e 6365 5b44 696d  im, Sequence[Dim
-000068e0: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
-000068f0: 2020 2020 6b65 795f 6469 6d3a 204f 7074      key_dim: Opt
-00006900: 696f 6e61 6c5b 556e 696f 6e5b 4469 6d2c  ional[Union[Dim,
-00006910: 2053 6571 7565 6e63 655b 4469 6d5d 5d5d   Sequence[Dim]]]
-00006920: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
-00006930: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00006940: 2222 2270 6172 616d 2061 7373 6967 6e22  """param assign"
-00006950: 2222 0a20 2020 2020 2020 2072 6177 5f70  "".        raw_p
-00006960: 6172 616d 203d 2070 6172 616d 2e72 6177  aram = param.raw
-00006970: 5f74 656e 736f 720a 2020 2020 2020 2020  _tensor.        
-00006980: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00006990: 6528 7261 775f 7061 7261 6d2c 2074 6f72  e(raw_param, tor
-000069a0: 6368 2e6e 6e2e 5061 7261 6d65 7465 7229  ch.nn.Parameter)
-000069b0: 0a20 2020 2020 2020 206b 6579 5f72 6177  .        key_raw
-000069c0: 2c20 7265 735f 6469 6d73 203d 205f 7574  , res_dims = _ut
-000069d0: 696c 732e 7374 7269 6465 645f 736c 6963  ils.strided_slic
-000069e0: 655f 7261 775f 6b65 7928 7061 7261 6d2c  e_raw_key(param,
-000069f0: 2061 7869 732c 206b 6579 2c20 6b65 795f   axis, key, key_
-00006a00: 6469 6d29 0a20 2020 2020 2020 2076 616c  dim).        val
-00006a10: 7565 5f72 6177 203d 2076 616c 7565 2e63  ue_raw = value.c
-00006a20: 6f70 795f 636f 6d70 6174 6962 6c65 5f74  opy_compatible_t
-00006a30: 6f5f 6469 6d73 5f72 6177 2872 6573 5f64  o_dims_raw(res_d
-00006a40: 696d 7329 0a20 2020 2020 2020 2077 6974  ims).        wit
-00006a50: 6820 746f 7263 682e 6e6f 5f67 7261 6428  h torch.no_grad(
-00006a60: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00006a70: 6620 6f70 203d 3d20 2261 7373 6967 6e22  f op == "assign"
-00006a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006a90: 2020 7261 775f 7061 7261 6d5b 6b65 795f    raw_param[key_
-00006aa0: 7261 775d 203d 2076 616c 7565 5f72 6177  raw] = value_raw
-00006ab0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00006ac0: 6620 6f70 203d 3d20 2261 6464 223a 0a20  f op == "add":. 
-00006ad0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006ae0: 6177 5f70 6172 616d 5b6b 6579 5f72 6177  aw_param[key_raw
-00006af0: 5d20 2b3d 2076 616c 7565 5f72 6177 0a20  ] += value_raw. 
-00006b00: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00006b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b20: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00006b30: 7228 6622 5061 7261 6d65 7465 7220 7b70  r(f"Parameter {p
-00006b40: 6172 616d 7d20 6173 7369 676e 3a20 556e  aram} assign: Un
-00006b50: 7375 7070 6f72 7465 6420 6f70 3a20 7b6f  supported op: {o
-00006b60: 707d 2229 0a0a 2020 2020 4073 7461 7469  p}")..    @stati
-00006b70: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-00006b80: 7061 7261 6d65 7465 725f 6d6f 7665 5f74  parameter_move_t
-00006b90: 6f28 7061 7261 6d3a 2072 662e 5061 7261  o(param: rf.Para
-00006ba0: 6d65 7465 722c 202a 2c20 6465 7669 6365  meter, *, device
-00006bb0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00006bc0: 3d20 4e6f 6e65 2c20 6474 7970 653a 204f  = None, dtype: O
-00006bd0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
-00006be0: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
-00006bf0: 2274 6f22 2222 0a20 2020 2020 2020 2070  "to""".        p
-00006c00: 745f 7061 7261 6d3a 2074 6f72 6368 2e6e  t_param: torch.n
-00006c10: 6e2e 5061 7261 6d65 7465 7220 3d20 7061  n.Parameter = pa
-00006c20: 7261 6d2e 7261 775f 7465 6e73 6f72 0a20  ram.raw_tensor. 
-00006c30: 2020 2020 2020 2064 6576 6963 6520 3d20         device = 
-00006c40: 746f 7263 682e 6465 7669 6365 2864 6576  torch.device(dev
-00006c50: 6963 6529 2069 6620 6465 7669 6365 2065  ice) if device e
-00006c60: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-00006c70: 2064 7479 7065 203d 2054 6f72 6368 4261   dtype = TorchBa
-00006c80: 636b 656e 642e 6173 5f64 7479 7065 5f72  ckend.as_dtype_r
-00006c90: 6177 2864 7479 7065 2920 6966 2064 7479  aw(dtype) if dty
-00006ca0: 7065 2065 6c73 6520 4e6f 6e65 0a20 2020  pe else None.   
-00006cb0: 2020 2020 2070 745f 7061 7261 6d20 3d20       pt_param = 
-00006cc0: 7074 5f70 6172 616d 2e74 6f28 6465 7669  pt_param.to(devi
-00006cd0: 6365 2c20 6474 7970 6529 0a20 2020 2020  ce, dtype).     
-00006ce0: 2020 2023 2053 6565 2073 696d 696c 6172     # See similar
-00006cf0: 206c 6f67 6963 2069 6e20 746f 7263 682e   logic in torch.
-00006d00: 6e6e 2e4d 6f64 756c 652e 5f61 7070 6c79  nn.Module._apply
-00006d10: 2e0a 2020 2020 2020 2020 7074 5f70 6172  ..        pt_par
-00006d20: 616d 203d 2074 6f72 6368 2e6e 6e2e 5061  am = torch.nn.Pa
-00006d30: 7261 6d65 7465 7228 7074 5f70 6172 616d  rameter(pt_param
-00006d40: 2c20 7074 5f70 6172 616d 2e72 6571 7569  , pt_param.requi
-00006d50: 7265 735f 6772 6164 290a 2020 2020 2020  res_grad).      
-00006d60: 2020 7061 7261 6d2e 7261 775f 7465 6e73    param.raw_tens
-00006d70: 6f72 203d 2070 745f 7061 7261 6d0a 0a20  or = pt_param.. 
-00006d80: 2020 2023 206b 6565 7020 696e 2073 796e     # keep in syn
-00006d90: 6320 7769 7468 206e 6174 6976 6520 696d  c with native im
-00006da0: 706c 656d 656e 7461 7469 6f6e 0a20 2020  plementation.   
-00006db0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-00006dc0: 2020 2064 6566 2063 6f6d 7061 7265 5f72     def compare_r
-00006dd0: 6177 2861 3a20 746f 7263 682e 5465 6e73  aw(a: torch.Tens
-00006de0: 6f72 2c20 6b69 6e64 3a20 7374 722c 2062  or, kind: str, b
-00006df0: 3a20 746f 7263 682e 5465 6e73 6f72 2920  : torch.Tensor) 
-00006e00: 2d3e 2074 6f72 6368 2e54 656e 736f 723a  -> torch.Tensor:
-00006e10: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006e20: 2020 2020 203a 7061 7261 6d20 613a 0a20       :param a:. 
-00006e30: 2020 2020 2020 203a 7061 7261 6d20 6b69         :param ki
-00006e40: 6e64 3a20 2265 7175 616c 222c 2022 6c65  nd: "equal", "le
-00006e50: 7373 222c 2022 6c65 7373 5f65 7175 616c  ss", "less_equal
-00006e60: 222c 2022 6772 6561 7465 7222 2c20 2267  ", "greater", "g
-00006e70: 7265 6174 6572 5f65 7175 616c 222c 2022  reater_equal", "
-00006e80: 6e6f 745f 6571 7561 6c22 0a20 2020 2020  not_equal".     
-00006e90: 2020 203a 7061 7261 6d20 623a 0a20 2020     :param b:.   
-00006ea0: 2020 2020 203a 7265 7475 726e 3a20 6120       :return: a 
-00006eb0: 606b 696e 6460 2062 0a20 2020 2020 2020  `kind` b.       
-00006ec0: 2022 2222 0a20 2020 2020 2020 2061 7373   """.        ass
-00006ed0: 6572 7420 612e 6469 6d28 2920 3d3d 2062  ert a.dim() == b
-00006ee0: 2e64 696d 2829 206f 7220 612e 6469 6d28  .dim() or a.dim(
-00006ef0: 2920 3d3d 2030 206f 7220 622e 6469 6d28  ) == 0 or b.dim(
-00006f00: 2920 3d3d 2030 0a20 2020 2020 2020 2069  ) == 0.        i
-00006f10: 6620 6b69 6e64 203d 3d20 2265 7175 616c  f kind == "equal
-00006f20: 223a 0a20 2020 2020 2020 2020 2020 206b  ":.            k
-00006f30: 696e 6420 3d20 2265 7122 2020 2320 6571  ind = "eq"  # eq
-00006f40: 2069 7320 6469 6666 6572 656e 7420 746f   is different to
-00006f50: 2065 7175 616c 3b20 6571 2072 6574 7572   equal; eq retur
-00006f60: 6e73 2061 2074 6f72 6368 2054 656e 736f  ns a torch Tenso
-00006f70: 720a 2020 2020 2020 2020 6f70 203d 2067  r.        op = g
-00006f80: 6574 6174 7472 2874 6f72 6368 2c20 6b69  etattr(torch, ki
-00006f90: 6e64 2920 2023 2065 2e67 2e20 746f 7263  nd)  # e.g. torc
-00006fa0: 682e 6571 7561 6c0a 2020 2020 2020 2020  h.equal.        
-00006fb0: 7265 7475 726e 206f 7028 612c 2062 290a  return op(a, b).
-00006fc0: 0a20 2020 2023 206b 6565 7020 696e 2073  .    # keep in s
-00006fd0: 796e 6320 7769 7468 206e 6174 6976 6520  ync with native 
-00006fe0: 696d 706c 656d 656e 7461 7469 6f6e 0a20  implementation. 
-00006ff0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-00007000: 0a20 2020 2064 6566 2063 6f6d 6269 6e65  .    def combine
-00007010: 5f72 6177 2861 3a20 746f 7263 682e 5465  _raw(a: torch.Te
-00007020: 6e73 6f72 2c20 6b69 6e64 3a20 7374 722c  nsor, kind: str,
-00007030: 2062 3a20 746f 7263 682e 5465 6e73 6f72   b: torch.Tensor
-00007040: 2920 2d3e 2074 6f72 6368 2e54 656e 736f  ) -> torch.Tenso
-00007050: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
-00007060: 2020 2020 2020 203a 7061 7261 6d20 613a         :param a:
-00007070: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00007080: 6b69 6e64 3a20 2261 6464 222c 2022 7375  kind: "add", "su
-00007090: 6222 2c20 226d 756c 222c 2022 7472 7565  b", "mul", "true
-000070a0: 6469 7622 2c20 2266 6c6f 6f72 6469 7622  div", "floordiv"
-000070b0: 2c20 226d 6f64 222c 2022 706f 7722 2c0a  , "mod", "pow",.
-000070c0: 2020 2020 2020 2020 2020 2020 226d 6178              "max
-000070d0: 696d 756d 222c 2022 6d69 6e69 6d75 6d22  imum", "minimum"
-000070e0: 2c20 226c 6f67 6963 616c 5f61 6e64 222c  , "logical_and",
-000070f0: 2022 6c6f 6769 6361 6c5f 6f72 222c 2022   "logical_or", "
-00007100: 7371 7561 7265 645f 6469 6666 6572 656e  squared_differen
-00007110: 6365 220a 2020 2020 2020 2020 3a70 6172  ce".        :par
-00007120: 616d 2062 3a0a 2020 2020 2020 2020 3a72  am b:.        :r
-00007130: 6574 7572 6e3a 2061 2060 6b69 6e64 6020  eturn: a `kind` 
-00007140: 620a 2020 2020 2020 2020 2222 220a 2020  b.        """.  
-00007150: 2020 2020 2020 6173 7365 7274 2061 2e64        assert a.d
-00007160: 696d 2829 203d 3d20 622e 6469 6d28 2920  im() == b.dim() 
-00007170: 6f72 2061 2e64 696d 2829 203d 3d20 3020  or a.dim() == 0 
-00007180: 6f72 2062 2e64 696d 2829 203d 3d20 300a  or b.dim() == 0.
-00007190: 2020 2020 2020 2020 6966 206b 696e 6420          if kind 
-000071a0: 3d3d 2022 7371 7561 7265 645f 6469 6666  == "squared_diff
-000071b0: 6572 656e 6365 223a 0a20 2020 2020 2020  erence":.       
-000071c0: 2020 2020 2072 6574 7572 6e20 7261 775f       return raw_
-000071d0: 6f70 732e 7371 7561 7265 645f 6469 6666  ops.squared_diff
-000071e0: 6572 656e 6365 2861 2c20 6229 0a20 2020  erence(a, b).   
-000071f0: 2020 2020 206b 696e 6420 3d20 7b0a 2020       kind = {.  
-00007200: 2020 2020 2020 2020 2020 2274 7275 6564            "trued
-00007210: 6976 223a 2022 7472 7565 5f64 6976 6964  iv": "true_divid
-00007220: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00007230: 2266 6c6f 6f72 6469 7622 3a20 2266 6c6f  "floordiv": "flo
-00007240: 6f72 5f64 6976 6964 6522 2c0a 2020 2020  or_divide",.    
-00007250: 2020 2020 2020 2020 226d 6f64 223a 2022          "mod": "
-00007260: 7265 6d61 696e 6465 7222 2c0a 2020 2020  remainder",.    
-00007270: 2020 2020 7d2e 6765 7428 6b69 6e64 2c20      }.get(kind, 
-00007280: 6b69 6e64 290a 2020 2020 2020 2020 6f70  kind).        op
-00007290: 203d 2067 6574 6174 7472 2874 6f72 6368   = getattr(torch
-000072a0: 2c20 6b69 6e64 2920 2023 2065 2e67 2e20  , kind)  # e.g. 
-000072b0: 746f 7263 682e 6164 640a 2020 2020 2020  torch.add.      
-000072c0: 2020 7265 7475 726e 206f 7028 612c 2062    return op(a, b
-000072d0: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-000072e0: 7468 6f64 0a20 2020 2064 6566 2072 6573  thod.    def res
-000072f0: 6861 7065 5f72 6177 280a 2020 2020 2020  hape_raw(.      
-00007300: 2020 7261 775f 7465 6e73 6f72 3a20 746f    raw_tensor: to
-00007310: 7263 682e 5465 6e73 6f72 2c20 7368 6170  rch.Tensor, shap
-00007320: 653a 2055 6e69 6f6e 5b53 6571 7565 6e63  e: Union[Sequenc
-00007330: 655b 556e 696f 6e5b 696e 742c 2074 6f72  e[Union[int, tor
-00007340: 6368 2e54 656e 736f 725d 5d2c 2074 6f72  ch.Tensor]], tor
-00007350: 6368 2e54 656e 736f 725d 0a20 2020 2029  ch.Tensor].    )
-00007360: 202d 3e20 746f 7263 682e 5465 6e73 6f72   -> torch.Tensor
-00007370: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00007380: 2020 2020 2020 3a70 6172 616d 2072 6177        :param raw
-00007390: 5f74 656e 736f 723a 0a20 2020 2020 2020  _tensor:.       
-000073a0: 203a 7061 7261 6d20 7368 6170 653a 0a20   :param shape:. 
-000073b0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-000073c0: 7265 7368 6170 6564 2072 6177 2074 656e  reshaped raw ten
-000073d0: 736f 723b 2077 7261 7073 2074 6f72 6368  sor; wraps torch
-000073e0: 2e72 6573 6861 7065 0a20 2020 2020 2020  .reshape.       
-000073f0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00007400: 7572 6e20 746f 7263 682e 7265 7368 6170  urn torch.reshap
-00007410: 6528 7261 775f 7465 6e73 6f72 2c20 7368  e(raw_tensor, sh
-00007420: 6170 6529 0a0a 2020 2020 4063 6c61 7373  ape)..    @class
-00007430: 6d65 7468 6f64 0a20 2020 2064 6566 2073  method.    def s
-00007440: 7175 6565 7a65 5f72 6177 2863 6c73 2c20  queeze_raw(cls, 
-00007450: 7261 775f 7465 6e73 6f72 3a20 746f 7263  raw_tensor: torc
-00007460: 682e 5465 6e73 6f72 2c20 6178 6573 3a20  h.Tensor, axes: 
-00007470: 5365 7175 656e 6365 5b69 6e74 5d29 202d  Sequence[int]) -
-00007480: 3e20 746f 7263 682e 5465 6e73 6f72 3a0a  > torch.Tensor:.
-00007490: 2020 2020 2020 2020 2222 2273 7175 6565          """squee
-000074a0: 7a65 2222 220a 2020 2020 2020 2020 6966  ze""".        if
-000074b0: 206c 656e 2861 7865 7329 203d 3d20 313a   len(axes) == 1:
-000074c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000074d0: 7572 6e20 7261 775f 7465 6e73 6f72 2e73  urn raw_tensor.s
-000074e0: 7175 6565 7a65 2864 696d 3d61 7865 735b  queeze(dim=axes[
-000074f0: 305d 290a 2020 2020 2020 2020 656c 6966  0]).        elif
-00007500: 206c 656e 2861 7865 7329 203d 3d20 303a   len(axes) == 0:
-00007510: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00007520: 7572 6e20 7261 775f 7465 6e73 6f72 0a20  urn raw_tensor. 
-00007530: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007540: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00007550: 7375 7065 7228 292e 7371 7565 657a 655f  super().squeeze_
-00007560: 7261 7728 7261 775f 7465 6e73 6f72 2c20  raw(raw_tensor, 
-00007570: 6178 6573 3d61 7865 7329 0a0a 2020 2020  axes=axes)..    
-00007580: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00007590: 2020 6465 6620 7472 616e 7370 6f73 655f    def transpose_
-000075a0: 7261 7728 7261 775f 7465 6e73 6f72 3a20  raw(raw_tensor: 
-000075b0: 746f 7263 682e 5465 6e73 6f72 2c20 7065  torch.Tensor, pe
-000075c0: 726d 3a20 5365 7175 656e 6365 5b69 6e74  rm: Sequence[int
-000075d0: 5d29 202d 3e20 746f 7263 682e 5465 6e73  ]) -> torch.Tens
-000075e0: 6f72 3a0a 2020 2020 2020 2020 2222 220a  or:.        """.
-000075f0: 2020 2020 2020 2020 3a70 6172 616d 2072          :param r
-00007600: 6177 5f74 656e 736f 723a 0a20 2020 2020  aw_tensor:.     
-00007610: 2020 203a 7061 7261 6d20 7065 726d 3a20     :param perm: 
-00007620: 652e 672e 205b 302c 2032 2c20 315d 0a20  e.g. [0, 2, 1]. 
-00007630: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00007640: 7065 726d 7574 6564 2028 7472 616e 7370  permuted (transp
-00007650: 6f73 6564 2920 7261 7720 7465 6e73 6f72  osed) raw tensor
-00007660: 3b20 7772 6170 7320 746f 7263 682e 7065  ; wraps torch.pe
-00007670: 726d 7574 650a 2020 2020 2020 2020 2222  rmute.        ""
-00007680: 220a 2020 2020 2020 2020 6966 2061 6c6c  ".        if all
-00007690: 2870 203d 3d20 6920 666f 7220 692c 2070  (p == i for i, p
-000076a0: 2069 6e20 656e 756d 6572 6174 6528 7065   in enumerate(pe
-000076b0: 726d 2929 3a0a 2020 2020 2020 2020 2020  rm)):.          
-000076c0: 2020 7265 7475 726e 2072 6177 5f74 656e    return raw_ten
-000076d0: 736f 720a 2020 2020 2020 2020 7265 7475  sor.        retu
-000076e0: 726e 2074 6f72 6368 2e70 6572 6d75 7465  rn torch.permute
-000076f0: 2872 6177 5f74 656e 736f 722c 2074 7570  (raw_tensor, tup
-00007700: 6c65 2870 6572 6d29 290a 0a20 2020 2040  le(perm))..    @
-00007710: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-00007720: 2064 6566 2063 6f6e 7665 7274 5f74 6f5f   def convert_to_
-00007730: 7465 6e73 6f72 280a 2020 2020 2020 2020  tensor(.        
-00007740: 7661 6c75 653a 2055 6e69 6f6e 5b54 656e  value: Union[Ten
-00007750: 736f 722c 2074 6f72 6368 2e54 656e 736f  sor, torch.Tenso
-00007760: 722c 2052 6177 5465 6e73 6f72 5479 7065  r, RawTensorType
-00007770: 735d 2c0a 2020 2020 2020 2020 2a2c 0a20  s],.        *,. 
-00007780: 2020 2020 2020 2064 696d 733a 2053 6571         dims: Seq
-00007790: 7565 6e63 655b 4469 6d5d 2c0a 2020 2020  uence[Dim],.    
-000077a0: 2020 2020 6474 7970 653a 2073 7472 2c0a      dtype: str,.
-000077b0: 2020 2020 2020 2020 7370 6172 7365 5f64          sparse_d
-000077c0: 696d 3a20 4f70 7469 6f6e 616c 5b44 696d  im: Optional[Dim
-000077d0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000077e0: 2020 6465 7669 6365 3a20 4f70 7469 6f6e    device: Option
-000077f0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00007800: 2020 2020 2020 2020 6e61 6d65 3a20 4f70          name: Op
-00007810: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00007820: 6e65 2c0a 2020 2020 2920 2d3e 2054 656e  ne,.    ) -> Ten
-00007830: 736f 725b 746f 7263 682e 5465 6e73 6f72  sor[torch.Tensor
-00007840: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00007850: 2020 2020 2020 203a 7061 7261 6d20 7661         :param va
-00007860: 6c75 653a 0a20 2020 2020 2020 203a 7061  lue:.        :pa
-00007870: 7261 6d20 6469 6d73 3a0a 2020 2020 2020  ram dims:.      
-00007880: 2020 3a70 6172 616d 2064 7479 7065 3a0a    :param dtype:.
-00007890: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-000078a0: 7061 7273 655f 6469 6d3a 0a20 2020 2020  parse_dim:.     
-000078b0: 2020 203a 7061 7261 6d20 6465 7669 6365     :param device
-000078c0: 3a0a 2020 2020 2020 2020 3a70 6172 616d  :.        :param
-000078d0: 206e 616d 653a 0a20 2020 2020 2020 203a   name:.        :
-000078e0: 7265 7475 726e 3a20 7465 6e73 6f72 0a20  return: tensor. 
-000078f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007900: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00007910: 2876 616c 7565 2c20 5465 6e73 6f72 293a  (value, Tensor):
-00007920: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00007930: 7572 6e20 7661 6c75 650a 2020 2020 2020  urn value.      
-00007940: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00007950: 7661 6c75 652c 2074 6f72 6368 2e54 656e  value, torch.Ten
-00007960: 736f 7229 3a0a 2020 2020 2020 2020 2020  sor):.          
-00007970: 2020 6e61 6d65 203d 206e 616d 6520 6f72    name = name or
-00007980: 2022 7261 775f 7465 6e73 6f72 220a 2020   "raw_tensor".  
-00007990: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000079a0: 2020 2020 2020 2020 6e61 6d65 203d 206e          name = n
-000079b0: 616d 6520 6f72 2022 636f 6e73 7422 0a20  ame or "const". 
-000079c0: 2020 2020 2020 2020 2020 2076 616c 7565             value
-000079d0: 203d 2074 6f72 6368 2e74 656e 736f 7228   = torch.tensor(
-000079e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000079f0: 2076 616c 7565 2c0a 2020 2020 2020 2020   value,.        
-00007a00: 2020 2020 2020 2020 6474 7970 653d 546f          dtype=To
-00007a10: 7263 6842 6163 6b65 6e64 2e61 735f 6474  rchBackend.as_dt
-00007a20: 7970 655f 7261 7728 6474 7970 6529 2c0a  ype_raw(dtype),.
-00007a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a40: 6465 7669 6365 3d64 6576 6963 6520 6f72  device=device or
-00007a50: 2072 662e 6765 745f 6465 6661 756c 745f   rf.get_default_
-00007a60: 6465 7669 6365 2829 2c0a 2020 2020 2020  device(),.      
-00007a70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00007a80: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00007a90: 6528 7661 6c75 652c 2074 6f72 6368 2e54  e(value, torch.T
-00007aa0: 656e 736f 7229 0a20 2020 2020 2020 2072  ensor).        r
-00007ab0: 6574 7572 6e20 5465 6e73 6f72 286e 616d  eturn Tensor(nam
-00007ac0: 652c 2064 696d 733d 6469 6d73 2c20 6474  e, dims=dims, dt
-00007ad0: 7970 653d 6474 7970 652c 2073 7061 7273  ype=dtype, spars
-00007ae0: 655f 6469 6d3d 7370 6172 7365 5f64 696d  e_dim=sparse_dim
-00007af0: 2c20 7261 775f 7465 6e73 6f72 3d76 616c  , raw_tensor=val
-00007b00: 7565 290a 0a20 2020 2040 7374 6174 6963  ue)..    @static
-00007b10: 6d65 7468 6f64 0a20 2020 2064 6566 2066  method.    def f
-00007b20: 756c 6c28 0a20 2020 2020 2020 2064 696d  ull(.        dim
-00007b30: 733a 2053 6571 7565 6e63 655b 4469 6d5d  s: Sequence[Dim]
-00007b40: 2c0a 2020 2020 2020 2020 6669 6c6c 5f76  ,.        fill_v
-00007b50: 616c 7565 3a20 556e 696f 6e5b 5261 7754  alue: Union[RawT
-00007b60: 656e 736f 7254 7970 6573 2c20 5465 6e73  ensorTypes, Tens
-00007b70: 6f72 5d2c 0a20 2020 2020 2020 202a 2c0a  or],.        *,.
-00007b80: 2020 2020 2020 2020 6474 7970 653a 2073          dtype: s
-00007b90: 7472 2c0a 2020 2020 2020 2020 6465 7669  tr,.        devi
-00007ba0: 6365 3a20 4f70 7469 6f6e 616c 5b73 7472  ce: Optional[str
-00007bb0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00007bc0: 2020 7370 6172 7365 5f64 696d 3a20 4f70    sparse_dim: Op
-00007bd0: 7469 6f6e 616c 5b44 696d 5d20 3d20 4e6f  tional[Dim] = No
-00007be0: 6e65 2c0a 2020 2020 2020 2020 6665 6174  ne,.        feat
-00007bf0: 7572 655f 6469 6d3a 204f 7074 696f 6e61  ure_dim: Optiona
-00007c00: 6c5b 4469 6d5d 203d 204e 6f6e 652c 0a20  l[Dim] = None,. 
-00007c10: 2020 2029 202d 3e20 5465 6e73 6f72 3a0a     ) -> Tensor:.
-00007c20: 2020 2020 2020 2020 2222 2266 756c 6c22          """full"
-00007c30: 2222 0a20 2020 2020 2020 2073 6861 7065  "".        shape
-00007c40: 203d 205b 6469 6d2e 6765 745f 6469 6d5f   = [dim.get_dim_
-00007c50: 7661 6c75 6528 2920 666f 7220 6469 6d20  value() for dim 
-00007c60: 696e 2064 696d 735d 0a20 2020 2020 2020  in dims].       
-00007c70: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
-00007c80: 696c 6c5f 7661 6c75 652c 2054 656e 736f  ill_value, Tenso
-00007c90: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00007ca0: 6669 6c6c 5f76 616c 7565 203d 2066 696c  fill_value = fil
-00007cb0: 6c5f 7661 6c75 652e 7261 775f 7465 6e73  l_value.raw_tens
-00007cc0: 6f72 0a20 2020 2020 2020 2069 6620 746f  or.        if to
-00007cd0: 7263 682e 6f6e 6e78 2e69 735f 696e 5f6f  rch.onnx.is_in_o
-00007ce0: 6e6e 785f 6578 706f 7274 2829 3a0a 2020  nnx_export():.  
-00007cf0: 2020 2020 2020 2020 2020 2320 6f6e 6e78            # onnx
-00007d00: 3a3a 436f 6e73 7461 6e74 4f66 5368 6170  ::ConstantOfShap
-00007d10: 6520 2876 6961 2074 6f72 6368 2e66 756c  e (via torch.ful
-00007d20: 6c29 206d 7573 7420 6765 7420 7368 6170  l) must get shap
-00007d30: 6520 6173 2069 6e74 3634 2e0a 2020 2020  e as int64..    
-00007d40: 2020 2020 2020 2020 2320 6874 7470 733a          # https:
-00007d50: 2f2f 6769 7468 7562 2e63 6f6d 2f72 7774  //github.com/rwt
-00007d60: 682d 6936 2f72 6574 7572 6e6e 2f69 7373  h-i6/returnn/iss
-00007d70: 7565 732f 3133 3333 2369 7373 7565 636f  ues/1333#issueco
-00007d80: 6d6d 656e 742d 3136 3037 3233 3637 3833  mment-1607236783
-00007d90: 0a20 2020 2020 2020 2020 2020 2073 6861  .            sha
-00007da0: 7065 203d 205b 6469 6d2e 6c6f 6e67 2829  pe = [dim.long()
-00007db0: 2069 6620 6973 696e 7374 616e 6365 2864   if isinstance(d
-00007dc0: 696d 2c20 746f 7263 682e 5465 6e73 6f72  im, torch.Tensor
-00007dd0: 2920 656c 7365 2064 696d 2066 6f72 2064  ) else dim for d
-00007de0: 696d 2069 6e20 7368 6170 655d 0a20 2020  im in shape].   
-00007df0: 2020 2020 2072 6177 5f74 656e 736f 7220       raw_tensor 
-00007e00: 3d20 746f 7263 682e 6675 6c6c 280a 2020  = torch.full(.  
-00007e10: 2020 2020 2020 2020 2020 7368 6170 652c            shape,
-00007e20: 2066 696c 6c5f 7661 6c75 652c 2064 7479   fill_value, dty
-00007e30: 7065 3d54 6f72 6368 4261 636b 656e 642e  pe=TorchBackend.
-00007e40: 6173 5f64 7479 7065 5f72 6177 2864 7479  as_dtype_raw(dty
-00007e50: 7065 292c 2064 6576 6963 653d 6465 7669  pe), device=devi
-00007e60: 6365 206f 7220 7266 2e67 6574 5f64 6566  ce or rf.get_def
-00007e70: 6175 6c74 5f64 6576 6963 6528 290a 2020  ault_device().  
-00007e80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00007e90: 7265 7475 726e 2054 656e 736f 7228 0a20  return Tensor(. 
-00007ea0: 2020 2020 2020 2020 2020 2022 6675 6c6c             "full
-00007eb0: 222c 2064 696d 733d 6469 6d73 2c20 7370  ", dims=dims, sp
-00007ec0: 6172 7365 5f64 696d 3d73 7061 7273 655f  arse_dim=sparse_
-00007ed0: 6469 6d2c 2066 6561 7475 7265 5f64 696d  dim, feature_dim
-00007ee0: 3d66 6561 7475 7265 5f64 696d 2c20 6474  =feature_dim, dt
-00007ef0: 7970 653d 6474 7970 652c 2072 6177 5f74  ype=dtype, raw_t
-00007f00: 656e 736f 723d 7261 775f 7465 6e73 6f72  ensor=raw_tensor
-00007f10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00007f20: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00007f30: 2020 6465 6620 6761 7468 6572 280a 2020    def gather(.  
-00007f40: 2020 2020 2020 736f 7572 6365 3a20 5465        source: Te
-00007f50: 6e73 6f72 2c0a 2020 2020 2020 2020 2a2c  nsor,.        *,
-00007f60: 0a20 2020 2020 2020 2069 6e64 6963 6573  .        indices
-00007f70: 3a20 556e 696f 6e5b 5465 6e73 6f72 2c20  : Union[Tensor, 
-00007f80: 696e 745d 2c0a 2020 2020 2020 2020 6178  int],.        ax
-00007f90: 6973 3a20 4469 6d2c 0a20 2020 2020 2020  is: Dim,.       
-00007fa0: 2063 6c69 705f 746f 5f76 616c 6964 3a20   clip_to_valid: 
-00007fb0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00007fc0: 2020 2920 2d3e 2054 656e 736f 723a 0a20    ) -> Tensor:. 
-00007fd0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007fe0: 2020 2047 6174 6865 722e 0a0a 2020 2020     Gather...    
-00007ff0: 2020 2020 5468 6572 6520 6172 6520 6120      There are a 
-00008000: 6665 7720 6f70 7469 6f6e 7320 696e 2050  few options in P
-00008010: 7954 6f72 6368 2c20 616c 6c20 6861 7669  yTorch, all havi
-00008020: 6e67 2073 6f6d 6577 6861 7420 6469 6666  ng somewhat diff
-00008030: 6572 656e 7420 7365 6d61 6e74 6963 730a  erent semantics.
-00008040: 2020 2020 2020 2020 616e 6420 6469 6666          and diff
-00008050: 6572 656e 7420 6164 7661 6e74 6167 6573  erent advantages
-00008060: 206f 7220 6469 7361 6476 616e 7461 6765   or disadvantage
-00008070: 7320 616e 6420 6469 6666 6572 656e 7420  s and different 
-00008080: 6c69 6d69 7461 7469 6f6e 732e 0a0a 2020  limitations...  
-00008090: 2020 2020 2020 2d20 746f 7263 682e 6761        - torch.ga
-000080a0: 7468 6572 2c20 6d6f 7374 2067 656e 6572  ther, most gener
-000080b0: 6963 0a20 2020 2020 2020 202d 2074 6f72  ic.        - tor
-000080c0: 6368 2e69 6e64 6578 5f73 656c 6563 742c  ch.index_select,
-000080d0: 2073 696d 696c 6172 2061 7320 7466 2e67   similar as tf.g
-000080e0: 6174 6865 722c 2062 7574 2064 6f65 7320  ather, but does 
-000080f0: 6e6f 7420 7375 7070 6f72 7420 6261 7463  not support batc
-00008100: 6820 6178 6573 0a20 2020 2020 2020 202d  h axes.        -
-00008110: 2054 656e 736f 722e 5f5f 6765 7469 7465   Tensor.__getite
-00008120: 6d5f 5f0a 2020 2020 2020 2020 2d20 746f  m__.        - to
-00008130: 7263 682e 656d 6265 6464 696e 670a 2020  rch.embedding.  
-00008140: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00008150: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00008160: 696e 6469 6365 732c 2054 656e 736f 7229  indices, Tensor)
-00008170: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-00008180: 6469 6365 733a 2054 656e 736f 725b 746f  dices: Tensor[to
-00008190: 7263 682e 5465 6e73 6f72 5d0a 2020 2020  rch.Tensor].    
-000081a0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-000081b0: 6e63 6528 696e 6469 6365 732c 2069 6e74  nce(indices, int
-000081c0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-000081d0: 6e64 6963 6573 203d 2054 656e 736f 7228  ndices = Tensor(
-000081e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000081f0: 2022 696e 6469 6365 735f 696e 7422 2c0a   "indices_int",.
-00008200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008210: 6469 6d73 3d28 292c 0a20 2020 2020 2020  dims=(),.       
-00008220: 2020 2020 2020 2020 2064 7479 7065 3d72           dtype=r
-00008230: 662e 6765 745f 6465 6661 756c 745f 6172  f.get_default_ar
-00008240: 7261 795f 696e 6465 785f 6474 7970 6528  ray_index_dtype(
-00008250: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00008260: 2020 2072 6177 5f74 656e 736f 723d 746f     raw_tensor=to
-00008270: 7263 682e 7465 6e73 6f72 2869 6e64 6963  rch.tensor(indic
-00008280: 6573 2c20 6474 7970 653d 546f 7263 6842  es, dtype=TorchB
-00008290: 6163 6b65 6e64 2e61 735f 6474 7970 655f  ackend.as_dtype_
-000082a0: 7261 7728 7266 2e67 6574 5f64 6566 6175  raw(rf.get_defau
-000082b0: 6c74 5f61 7272 6179 5f69 6e64 6578 5f64  lt_array_index_d
-000082c0: 7479 7065 2829 2929 2c0a 2020 2020 2020  type())),.      
-000082d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000082e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000082f0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
-00008300: 7228 6622 556e 7375 7070 6f72 7465 6420  r(f"Unsupported 
-00008310: 7479 7065 2066 6f72 2069 6e64 6963 6573  type for indices
-00008320: 3a20 7b74 7970 6528 696e 6469 6365 7329  : {type(indices)
-00008330: 7d22 290a 2020 2020 2020 2020 6178 6973  }").        axis
-00008340: 5f69 6e74 203d 2073 6f75 7263 652e 6765  _int = source.ge
-00008350: 745f 6178 6973 5f66 726f 6d5f 6465 7363  t_axis_from_desc
-00008360: 7269 7074 696f 6e28 6178 6973 2c20 616c  ription(axis, al
-00008370: 6c6f 775f 696e 743d 4661 6c73 6529 0a20  low_int=False). 
-00008380: 2020 2020 2020 2069 6620 636c 6970 5f74         if clip_t
-00008390: 6f5f 7661 6c69 643a 0a20 2020 2020 2020  o_valid:.       
-000083a0: 2020 2020 2069 6e64 6963 6573 203d 2069       indices = i
-000083b0: 6e64 6963 6573 2e63 6f70 7928 290a 2020  ndices.copy().  
-000083c0: 2020 2020 2020 2020 2020 6469 6d3a 2044            dim: D
-000083d0: 696d 203d 2073 6f75 7263 652e 6469 6d73  im = source.dims
-000083e0: 5b61 7869 735f 696e 745d 0a20 2020 2020  [axis_int].     
-000083f0: 2020 2020 2020 2069 6620 6469 6d2e 6479         if dim.dy
-00008400: 6e5f 7369 7a65 5f65 7874 3a0a 2020 2020  n_size_ext:.    
-00008410: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00008420: 7274 2064 696d 2e64 796e 5f73 697a 655f  rt dim.dyn_size_
-00008430: 6578 742e 6469 6d73 5f73 6574 2e69 7373  ext.dims_set.iss
-00008440: 7562 7365 7428 0a20 2020 2020 2020 2020  ubset(.         
-00008450: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
-00008460: 6573 2e64 696d 735f 7365 740a 2020 2020  es.dims_set.    
-00008470: 2020 2020 2020 2020 2020 2020 292c 2066              ), f
-00008480: 2267 6174 6865 7220 7769 7468 2063 6c69  "gather with cli
-00008490: 705f 746f 5f76 616c 6964 3a20 696e 6469  p_to_valid: indi
-000084a0: 6365 7320 287b 696e 6469 6365 737d 2920  ces ({indices}) 
-000084b0: 6469 6d73 206d 7573 7420 6265 2061 2073  dims must be a s
-000084c0: 7570 6572 7365 7420 6f66 207b 6469 6d7d  uperset of {dim}
-000084d0: 2064 796e 2d73 697a 6522 0a20 2020 2020   dyn-size".     
-000084e0: 2020 2020 2020 2020 2020 2073 697a 6520             size 
-000084f0: 3d20 6469 6d2e 6479 6e5f 7369 7a65 5f65  = dim.dyn_size_e
-00008500: 7874 2e63 6f70 795f 636f 6d70 6174 6962  xt.copy_compatib
-00008510: 6c65 5f74 6f28 696e 6469 6365 732c 2063  le_to(indices, c
-00008520: 6865 636b 5f73 7061 7273 653d 4661 6c73  heck_sparse=Fals
-00008530: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00008540: 2020 2069 6e64 6963 6573 2e72 6177 5f74     indices.raw_t
-00008550: 656e 736f 7220 3d20 746f 7263 682e 636c  ensor = torch.cl
-00008560: 616d 7028 0a20 2020 2020 2020 2020 2020  amp(.           
-00008570: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-00008580: 2e72 6177 5f74 656e 736f 722c 0a20 2020  .raw_tensor,.   
-00008590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000085a0: 2074 6f72 6368 2e74 656e 736f 7228 302c   torch.tensor(0,
-000085b0: 2064 6576 6963 653d 696e 6469 6365 732e   device=indices.
-000085c0: 7261 775f 7465 6e73 6f72 2e64 6576 6963  raw_tensor.devic
-000085d0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-000085e0: 2020 2020 2020 2020 2873 697a 652e 7261          (size.ra
-000085f0: 775f 7465 6e73 6f72 202d 2031 292e 746f  w_tensor - 1).to
-00008600: 2869 6e64 6963 6573 2e72 6177 5f74 656e  (indices.raw_ten
-00008610: 736f 722e 6465 7669 6365 292c 0a20 2020  sor.device),.   
-00008620: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00008630: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00008640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008650: 2069 6e64 6963 6573 2e72 6177 5f74 656e   indices.raw_ten
-00008660: 736f 7220 3d20 746f 7263 682e 636c 616d  sor = torch.clam
-00008670: 7028 696e 6469 6365 732e 7261 775f 7465  p(indices.raw_te
-00008680: 6e73 6f72 2c20 302c 2073 6f75 7263 652e  nsor, 0, source.
-00008690: 7261 775f 7465 6e73 6f72 2e73 6861 7065  raw_tensor.shape
-000086a0: 5b61 7869 735f 696e 745d 202d 2031 290a  [axis_int] - 1).
-000086b0: 2020 2020 2020 2020 696e 6465 785f 6f77          index_ow
-000086c0: 6e5f 6469 6d73 203d 205b 6469 6d20 666f  n_dims = [dim fo
-000086d0: 7220 6469 6d20 696e 2069 6e64 6963 6573  r dim in indices
-000086e0: 2e64 696d 7320 6966 2064 696d 206e 6f74  .dims if dim not
-000086f0: 2069 6e20 736f 7572 6365 2e64 696d 7320   in source.dims 
-00008700: 6f72 2064 696d 203d 3d20 6178 6973 5d0a  or dim == axis].
-00008710: 2020 2020 2020 2020 6f75 7420 3d20 5465          out = Te
-00008720: 6e73 6f72 280a 2020 2020 2020 2020 2020  nsor(.          
-00008730: 2020 2267 6174 6865 7222 2c0a 2020 2020    "gather",.    
-00008740: 2020 2020 2020 2020 6469 6d73 3d6c 6973          dims=lis
-00008750: 7428 736f 7572 6365 2e64 696d 735b 3a61  t(source.dims[:a
-00008760: 7869 735f 696e 745d 2920 2b20 696e 6465  xis_int]) + inde
-00008770: 785f 6f77 6e5f 6469 6d73 202b 206c 6973  x_own_dims + lis
-00008780: 7428 736f 7572 6365 2e64 696d 735b 6178  t(source.dims[ax
-00008790: 6973 5f69 6e74 202b 2031 203a 5d29 2c0a  is_int + 1 :]),.
-000087a0: 2020 2020 2020 2020 2020 2020 6474 7970              dtyp
-000087b0: 653d 736f 7572 6365 2e64 7479 7065 2c0a  e=source.dtype,.
-000087c0: 2020 2020 2020 2020 2020 2020 7370 6172              spar
-000087d0: 7365 5f64 696d 3d73 6f75 7263 652e 7370  se_dim=source.sp
-000087e0: 6172 7365 5f64 696d 2c0a 2020 2020 2020  arse_dim,.      
-000087f0: 2020 290a 2020 2020 2020 2020 6966 2073    ).        if s
-00008800: 6f75 7263 652e 6665 6174 7572 655f 6469  ource.feature_di
-00008810: 6d20 616e 6420 736f 7572 6365 2e66 6561  m and source.fea
-00008820: 7475 7265 5f64 696d 2069 6e20 6f75 742e  ture_dim in out.
-00008830: 6469 6d73 3a0a 2020 2020 2020 2020 2020  dims:.          
-00008840: 2020 6f75 742e 6665 6174 7572 655f 6469    out.feature_di
-00008850: 6d20 3d20 736f 7572 6365 2e66 6561 7475  m = source.featu
-00008860: 7265 5f64 696d 0a20 2020 2020 2020 2069  re_dim.        i
-00008870: 6620 696e 6469 6365 732e 6469 6d73 5f73  f indices.dims_s
-00008880: 6574 2e69 6e74 6572 7365 6374 696f 6e28  et.intersection(
-00008890: 736f 7572 6365 2e64 696d 735f 7365 7420  source.dims_set 
-000088a0: 2d20 7b61 7869 737d 293a 0a20 2020 2020  - {axis}):.     
-000088b0: 2020 2020 2020 2023 2057 6520 6361 6e6e         # We cann
-000088c0: 6f74 2075 7365 2069 6e64 6578 5f73 656c  ot use index_sel
-000088d0: 6563 7420 696e 2074 6869 7320 6361 7365  ect in this case
-000088e0: 2e20 4e65 6564 2074 6f20 6661 6c6c 6261  . Need to fallba
-000088f0: 636b 2074 6f20 6761 7468 6572 2e0a 2020  ck to gather..  
-00008900: 2020 2020 2020 2020 2020 696e 6469 6365            indice
-00008910: 7320 3d20 696e 6469 6365 732e 636f 7079  s = indices.copy
-00008920: 5f63 6f6d 7061 7469 626c 655f 746f 286f  _compatible_to(o
-00008930: 7574 2c20 6368 6563 6b5f 6474 7970 653d  ut, check_dtype=
-00008940: 4661 6c73 652c 2063 6865 636b 5f73 7061  False, check_spa
-00008950: 7273 653d 4661 6c73 652c 2075 6e62 726f  rse=False, unbro
-00008960: 6164 6361 7374 3d54 7275 6529 0a20 2020  adcast=True).   
-00008970: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00008980: 696e 6465 785f 6f77 6e5f 6469 6d73 2920  index_own_dims) 
-00008990: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-000089a0: 2020 2020 2020 696e 6465 785f 6f77 6e5f        index_own_
-000089b0: 6469 6d73 5f66 6c61 7420 3d20 696e 6465  dims_flat = inde
-000089c0: 785f 6f77 6e5f 6469 6d73 5b30 5d20 2023  x_own_dims[0]  #
-000089d0: 2067 6f6f 640a 2020 2020 2020 2020 2020   good.          
-000089e0: 2020 656c 6966 206c 656e 2869 6e64 6578    elif len(index
-000089f0: 5f6f 776e 5f64 696d 7329 203d 3d20 303a  _own_dims) == 0:
-00008a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008a10: 2069 6e64 6578 5f6f 776e 5f64 696d 735f   index_own_dims_
-00008a20: 666c 6174 203d 2044 696d 2831 2c20 6e61  flat = Dim(1, na
-00008a30: 6d65 3d22 6475 6d6d 7922 290a 2020 2020  me="dummy").    
-00008a40: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-00008a50: 6365 7320 3d20 696e 6469 6365 732e 636f  ces = indices.co
-00008a60: 7079 5f61 6464 5f64 696d 5f62 795f 7461  py_add_dim_by_ta
-00008a70: 6728 696e 6465 785f 6f77 6e5f 6469 6d73  g(index_own_dims
-00008a80: 5f66 6c61 742c 2075 6e62 726f 6164 6361  _flat, unbroadca
-00008a90: 7374 3d54 7275 652c 2061 7869 733d 6178  st=True, axis=ax
-00008aa0: 6973 5f69 6e74 290a 2020 2020 2020 2020  is_int).        
-00008ab0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00008ac0: 2020 2020 2020 2020 2020 696e 6469 6365            indice
-00008ad0: 732c 2069 6e64 6578 5f6f 776e 5f64 696d  s, index_own_dim
-00008ae0: 735f 666c 6174 203d 2072 662e 6d65 7267  s_flat = rf.merg
-00008af0: 655f 6469 6d73 2869 6e64 6963 6573 2c20  e_dims(indices, 
-00008b00: 6469 6d73 3d69 6e64 6578 5f6f 776e 5f64  dims=index_own_d
-00008b10: 696d 7329 0a20 2020 2020 2020 2020 2020  ims).           
-00008b20: 2069 6e64 6578 5f65 7874 5f64 696d 7320   index_ext_dims 
-00008b30: 3d20 6c69 7374 2873 6f75 7263 652e 6469  = list(source.di
-00008b40: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
-00008b50: 696e 6465 785f 6578 745f 6469 6d73 5b61  index_ext_dims[a
-00008b60: 7869 735f 696e 745d 203d 2069 6e64 6578  xis_int] = index
-00008b70: 5f6f 776e 5f64 696d 735f 666c 6174 0a20  _own_dims_flat. 
-00008b80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00008b90: 7420 696e 6469 6365 732e 6469 6d73 203d  t indices.dims =
-00008ba0: 3d20 7475 706c 6528 696e 6465 785f 6578  = tuple(index_ex
-00008bb0: 745f 6469 6d73 290a 2020 2020 2020 2020  t_dims).        
-00008bc0: 2020 2020 6f75 745f 7261 7720 3d20 746f      out_raw = to
-00008bd0: 7263 682e 6761 7468 6572 2873 6f75 7263  rch.gather(sourc
-00008be0: 652e 7261 775f 7465 6e73 6f72 2c20 6469  e.raw_tensor, di
-00008bf0: 6d3d 6178 6973 5f69 6e74 2c20 696e 6465  m=axis_int, inde
-00008c00: 783d 696e 6469 6365 732e 7261 775f 7465  x=indices.raw_te
-00008c10: 6e73 6f72 2e74 7970 6528 746f 7263 682e  nsor.type(torch.
-00008c20: 696e 7436 3429 290a 2020 2020 2020 2020  int64)).        
-00008c30: 2020 2020 6966 206c 656e 2869 6e64 6578      if len(index
-00008c40: 5f6f 776e 5f64 696d 7329 203d 3d20 313a  _own_dims) == 1:
-00008c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008c60: 2070 6173 7320 2023 206e 6f74 6869 6e67   pass  # nothing
-00008c70: 2074 6f20 646f 0a20 2020 2020 2020 2020   to do.         
-00008c80: 2020 2065 6c69 6620 6c65 6e28 696e 6465     elif len(inde
-00008c90: 785f 6f77 6e5f 6469 6d73 2920 3d3d 2030  x_own_dims) == 0
-00008ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008cb0: 2020 6f75 745f 7261 7720 3d20 6f75 745f    out_raw = out_
-00008cc0: 7261 772e 7371 7565 657a 6528 6178 6973  raw.squeeze(axis
-00008cd0: 5f69 6e74 290a 2020 2020 2020 2020 2020  _int).          
-00008ce0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00008cf0: 2020 2020 2020 2020 6f75 745f 7261 7720          out_raw 
-00008d00: 3d20 6f75 745f 7261 772e 7265 7368 6170  = out_raw.reshap
-00008d10: 6528 5b64 2e67 6574 5f64 696d 5f76 616c  e([d.get_dim_val
-00008d20: 7565 2829 2066 6f72 2064 2069 6e20 6f75  ue() for d in ou
-00008d30: 742e 6469 6d73 5d29 0a20 2020 2020 2020  t.dims]).       
-00008d40: 2020 2020 206f 7574 2e72 6177 5f74 656e       out.raw_ten
-00008d50: 736f 7220 3d20 6f75 745f 7261 770a 2020  sor = out_raw.  
-00008d60: 2020 2020 2020 656c 6966 2061 7869 735f        elif axis_
-00008d70: 696e 7420 3d3d 2030 2061 6e64 2069 6e64  int == 0 and ind
-00008d80: 6963 6573 2e62 6174 6368 5f6e 6469 6d20  ices.batch_ndim 
-00008d90: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00008da0: 2020 6f75 742e 7261 775f 7465 6e73 6f72    out.raw_tensor
-00008db0: 203d 2073 6f75 7263 652e 7261 775f 7465   = source.raw_te
-00008dc0: 6e73 6f72 5b69 6e64 6963 6573 2e72 6177  nsor[indices.raw
-00008dd0: 5f74 656e 736f 725d 0a20 2020 2020 2020  _tensor].       
-00008de0: 2065 6c69 6620 6178 6973 5f69 6e74 203d   elif axis_int =
-00008df0: 3d20 3020 616e 6420 736f 7572 6365 2e62  = 0 and source.b
-00008e00: 6174 6368 5f6e 6469 6d20 3d3d 2032 3a0a  atch_ndim == 2:.
-00008e10: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00008e20: 6973 2069 7320 6578 6163 746c 7920 7768  is is exactly wh
-00008e30: 6174 2074 6f72 6368 2e65 6d62 6564 6469  at torch.embeddi
-00008e40: 6e67 2069 7320 696e 7465 6e64 6564 2066  ng is intended f
-00008e50: 6f72 2e20 4c65 7427 7320 7573 6520 7468  or. Let's use th
-00008e60: 6174 2e0a 2020 2020 2020 2020 2020 2020  at..            
-00008e70: 6f75 742e 7261 775f 7465 6e73 6f72 203d  out.raw_tensor =
-00008e80: 2074 6f72 6368 2e65 6d62 6564 6469 6e67   torch.embedding
-00008e90: 2873 6f75 7263 652e 7261 775f 7465 6e73  (source.raw_tens
-00008ea0: 6f72 2c20 696e 6469 6365 732e 7261 775f  or, indices.raw_
-00008eb0: 7465 6e73 6f72 290a 2020 2020 2020 2020  tensor).        
-00008ec0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00008ed0: 2020 6f75 745f 7261 7720 3d20 746f 7263    out_raw = torc
-00008ee0: 682e 696e 6465 785f 7365 6c65 6374 2873  h.index_select(s
-00008ef0: 6f75 7263 652e 7261 775f 7465 6e73 6f72  ource.raw_tensor
-00008f00: 2c20 6469 6d3d 6178 6973 5f69 6e74 2c20  , dim=axis_int, 
-00008f10: 696e 6465 783d 696e 6469 6365 732e 7261  index=indices.ra
-00008f20: 775f 7465 6e73 6f72 2e66 6c61 7474 656e  w_tensor.flatten
-00008f30: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00008f40: 6f75 745f 7368 6170 6520 3d20 280a 2020  out_shape = (.  
-00008f50: 2020 2020 2020 2020 2020 2020 2020 736f                so
-00008f60: 7572 6365 2e72 6177 5f74 656e 736f 722e  urce.raw_tensor.
-00008f70: 7368 6170 655b 3a61 7869 735f 696e 745d  shape[:axis_int]
-00008f80: 202b 2069 6e64 6963 6573 2e72 6177 5f74   + indices.raw_t
-00008f90: 656e 736f 722e 7368 6170 6520 2b20 736f  ensor.shape + so
-00008fa0: 7572 6365 2e72 6177 5f74 656e 736f 722e  urce.raw_tensor.
-00008fb0: 7368 6170 655b 6178 6973 5f69 6e74 202b  shape[axis_int +
-00008fc0: 2031 203a 5d0a 2020 2020 2020 2020 2020   1 :].          
-00008fd0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00008fe0: 6f75 742e 7261 775f 7465 6e73 6f72 203d  out.raw_tensor =
-00008ff0: 206f 7574 5f72 6177 2e72 6573 6861 7065   out_raw.reshape
-00009000: 286f 7574 5f73 6861 7065 290a 2020 2020  (out_shape).    
-00009010: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
-00009020: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00009030: 640a 2020 2020 6465 6620 7363 6174 7465  d.    def scatte
-00009040: 7228 0a20 2020 2020 2020 2073 6f75 7263  r(.        sourc
-00009050: 653a 2054 656e 736f 722c 0a20 2020 2020  e: Tensor,.     
-00009060: 2020 202a 2c0a 2020 2020 2020 2020 696e     *,.        in
-00009070: 6469 6365 733a 2054 656e 736f 722c 0a20  dices: Tensor,. 
-00009080: 2020 2020 2020 2069 6e64 6963 6573 5f64         indices_d
-00009090: 696d 3a20 556e 696f 6e5b 4469 6d2c 2053  im: Union[Dim, S
-000090a0: 6571 7565 6e63 655b 4469 6d5d 5d2c 0a20  equence[Dim]],. 
-000090b0: 2020 2020 2020 206f 7574 5f64 696d 3a20         out_dim: 
-000090c0: 556e 696f 6e5b 4469 6d2c 2053 6571 7565  Union[Dim, Seque
-000090d0: 6e63 655b 4469 6d5d 5d2c 0a20 2020 2029  nce[Dim]],.    )
-000090e0: 202d 3e20 5465 6e73 6f72 3a0a 2020 2020   -> Tensor:.    
-000090f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00009100: 5363 6174 7465 7273 2069 6e74 6f20 6e65  Scatters into ne
-00009110: 7720 7a65 726f 2d74 656e 736f 722e 0a20  w zero-tensor.. 
-00009120: 2020 2020 2020 2049 6620 656e 7472 6965         If entrie
-00009130: 7320 696e 2069 6e64 6963 6573 2061 7265  s in indices are
-00009140: 2064 7570 6c69 6361 7465 642c 2074 6865   duplicated, the
-00009150: 2063 6f72 7265 7370 6f6e 6469 6e67 2076   corresponding v
-00009160: 616c 7565 7320 696e 2073 6f75 7263 6520  alues in source 
-00009170: 7769 6c6c 2062 6520 6164 6465 6420 746f  will be added to
-00009180: 6765 7468 6572 0a20 2020 2020 2020 2028  gether.        (
-00009190: 7363 6174 7465 725f 6164 6420 696e 2050  scatter_add in P
-000091a0: 7954 6f72 6368 292e 0a20 2020 2020 2020  yTorch)..       
-000091b0: 2028 5446 2073 6567 6d65 6e74 5f73 756d   (TF segment_sum
-000091c0: 2063 616e 2062 6520 696d 706c 656d 656e   can be implemen
-000091d0: 7465 6420 7669 6120 7468 6973 2e29 0a0a  ted via this.)..
-000091e0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-000091f0: 6f75 7263 653a 205b 6261 7463 685f 6469  ource: [batch_di
-00009200: 6d73 2e2e 2e2c 2069 6e64 6963 6573 5f64  ms..., indices_d
-00009210: 696d 2873 292e 2e2e 2c20 6665 6174 7572  im(s)..., featur
-00009220: 655f 6469 6d73 2e2e 2e5d 0a20 2020 2020  e_dims...].     
-00009230: 2020 203a 7061 7261 6d20 696e 6469 6365     :param indice
-00009240: 733a 205b 6261 7463 685f 6469 6d73 2e2e  s: [batch_dims..
-00009250: 2e2c 2069 6e64 6963 6573 5f64 696d 2873  ., indices_dim(s
-00009260: 292e 2e2e 5d20 2d3e 206f 7574 5f64 696d  )...] -> out_dim
-00009270: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00009280: 696e 6469 6365 735f 6469 6d3a 0a20 2020  indices_dim:.   
-00009290: 2020 2020 203a 7061 7261 6d20 6f75 745f       :param out_
-000092a0: 6469 6d3a 0a20 2020 2020 2020 203a 7265  dim:.        :re
-000092b0: 7475 726e 3a20 5b62 6174 6368 5f64 696d  turn: [batch_dim
-000092c0: 732e 2e2e 2c20 6f75 745f 6469 6d2c 2066  s..., out_dim, f
-000092d0: 6561 7475 7265 5f64 696d 732e 2e2e 5d0a  eature_dims...].
-000092e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000092f0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00009300: 6528 696e 6469 6365 735f 6469 6d2c 2044  e(indices_dim, D
-00009310: 696d 293a 0a20 2020 2020 2020 2020 2020  im):.           
-00009320: 2069 6e64 6963 6573 5f64 696d 203d 205b   indices_dim = [
-00009330: 696e 6469 6365 735f 6469 6d5d 0a20 2020  indices_dim].   
-00009340: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00009350: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00009360: 6e28 696e 6469 6365 735f 6469 6d29 203e  n(indices_dim) >
-00009370: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00009380: 696e 6469 6365 735f 6469 6d20 3d20 6c69  indices_dim = li
-00009390: 7374 2869 6e64 6963 6573 5f64 696d 290a  st(indices_dim).
-000093a0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-000093b0: 6e64 6963 6573 2e64 7479 7065 2e73 7461  ndices.dtype.sta
-000093c0: 7274 7377 6974 6828 2269 6e74 2229 0a20  rtswith("int"). 
-000093d0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000093e0: 616e 6365 286f 7574 5f64 696d 2c20 4469  ance(out_dim, Di
-000093f0: 6d29 3a0a 2020 2020 2020 2020 2020 2020  m):.            
-00009400: 6f75 745f 666c 6174 5f64 696d 203d 206f  out_flat_dim = o
-00009410: 7574 5f64 696d 0a20 2020 2020 2020 2020  ut_dim.         
-00009420: 2020 206f 7574 5f64 696d 203d 205b 6f75     out_dim = [ou
-00009430: 745f 6469 6d5d 0a20 2020 2020 2020 2065  t_dim].        e
-00009440: 6c69 6620 6c65 6e28 6f75 745f 6469 6d29  lif len(out_dim)
-00009450: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-00009460: 2020 206f 7574 5f66 6c61 745f 6469 6d20     out_flat_dim 
-00009470: 3d20 6f75 745f 6469 6d5b 305d 0a20 2020  = out_dim[0].   
-00009480: 2020 2020 2020 2020 206f 7574 5f64 696d           out_dim
-00009490: 203d 205b 6f75 745f 666c 6174 5f64 696d   = [out_flat_dim
-000094a0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-000094b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000094c0: 7274 206c 656e 286f 7574 5f64 696d 2920  rt len(out_dim) 
-000094d0: 3e20 310a 2020 2020 2020 2020 2020 2020  > 1.            
-000094e0: 6f75 745f 666c 6174 5f64 696d 203d 206f  out_flat_dim = o
-000094f0: 7574 5f64 696d 5b30 5d0a 2020 2020 2020  ut_dim[0].      
-00009500: 2020 2020 2020 666f 7220 6469 6d20 696e        for dim in
-00009510: 206f 7574 5f64 696d 5b31 3a5d 3a0a 2020   out_dim[1:]:.  
-00009520: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-00009530: 745f 666c 6174 5f64 696d 203d 206f 7574  t_flat_dim = out
-00009540: 5f66 6c61 745f 6469 6d20 2a20 6469 6d0a  _flat_dim * dim.
-00009550: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
-00009560: 6469 6d20 3d20 6c69 7374 286f 7574 5f64  dim = list(out_d
-00009570: 696d 290a 2020 2020 2020 2020 6261 7463  im).        batc
-00009580: 685f 6469 6d73 203d 2069 6e64 6963 6573  h_dims = indices
-00009590: 2e72 656d 6169 6e69 6e67 5f64 696d 7328  .remaining_dims(
-000095a0: 696e 6469 6365 735f 6469 6d29 0a20 2020  indices_dim).   
-000095b0: 2020 2020 2066 6561 7475 7265 5f64 696d       feature_dim
-000095c0: 7320 3d20 736f 7572 6365 2e72 656d 6169  s = source.remai
-000095d0: 6e69 6e67 5f64 696d 7328 6261 7463 685f  ning_dims(batch_
-000095e0: 6469 6d73 202b 2069 6e64 6963 6573 5f64  dims + indices_d
-000095f0: 696d 290a 2020 2020 2020 2020 6966 206c  im).        if l
-00009600: 656e 2869 6e64 6963 6573 5f64 696d 2920  en(indices_dim) 
-00009610: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00009620: 2069 6e64 6963 6573 2c20 696e 6469 6365   indices, indice
-00009630: 735f 666c 6174 5f64 696d 203d 2072 662e  s_flat_dim = rf.
-00009640: 6d65 7267 655f 6469 6d73 2869 6e64 6963  merge_dims(indic
-00009650: 6573 2c20 6469 6d73 3d69 6e64 6963 6573  es, dims=indices
-00009660: 5f64 696d 290a 2020 2020 2020 2020 2020  _dim).          
-00009670: 2020 736f 7572 6365 2c20 5f20 3d20 7266    source, _ = rf
-00009680: 2e6d 6572 6765 5f64 696d 7328 736f 7572  .merge_dims(sour
-00009690: 6365 2c20 6469 6d73 3d69 6e64 6963 6573  ce, dims=indices
-000096a0: 5f64 696d 2c20 6f75 745f 6469 6d3d 696e  _dim, out_dim=in
-000096b0: 6469 6365 735f 666c 6174 5f64 696d 290a  dices_flat_dim).
-000096c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000096d0: 2020 2020 2020 2020 2020 696e 6469 6365            indice
-000096e0: 735f 666c 6174 5f64 696d 203d 2069 6e64  s_flat_dim = ind
-000096f0: 6963 6573 5f64 696d 5b30 5d0a 2020 2020  ices_dim[0].    
-00009700: 2020 2020 736f 7572 6365 203d 2073 6f75      source = sou
-00009710: 7263 652e 636f 7079 5f74 7261 6e73 706f  rce.copy_transpo
-00009720: 7365 2862 6174 6368 5f64 696d 7320 2b20  se(batch_dims + 
-00009730: 5b69 6e64 6963 6573 5f66 6c61 745f 6469  [indices_flat_di
-00009740: 6d5d 202b 2066 6561 7475 7265 5f64 696d  m] + feature_dim
-00009750: 7329 0a20 2020 2020 2020 2069 6e64 6963  s).        indic
-00009760: 6573 203d 2069 6e64 6963 6573 2e63 6f70  es = indices.cop
-00009770: 795f 636f 6d70 6174 6962 6c65 5f74 6f28  y_compatible_to(
-00009780: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-00009790: 6361 7474 6572 5f61 6464 5f20 646f 6573  catter_add_ does
-000097a0: 206e 6f74 2073 7570 706f 7274 2062 726f   not support bro
-000097b0: 6164 6361 7374 696e 672c 2061 6e64 2065  adcasting, and e
-000097c0: 7870 6563 7473 2069 6e64 6963 6573 2061  xpects indices a
-000097d0: 6e64 2073 6f75 7263 6520 746f 2068 6176  nd source to hav
-000097e0: 6520 7468 6520 7361 6d65 206e 756d 6265  e the same numbe
-000097f0: 7220 6f66 2064 696d 730a 2020 2020 2020  r of dims.      
-00009800: 2020 2020 2020 736f 7572 6365 2c0a 2020        source,.  
-00009810: 2020 2020 2020 2020 2020 756e 6272 6f61            unbroa
-00009820: 6463 6173 743d 5472 7565 2c0a 2020 2020  dcast=True,.    
-00009830: 2020 2020 2020 2020 6164 645f 6469 6d73          add_dims
-00009840: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00009850: 2020 2063 6865 636b 5f73 7061 7273 653d     check_sparse=
-00009860: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-00009870: 2020 2063 6865 636b 5f64 7479 7065 3d46     check_dtype=F
-00009880: 616c 7365 2c0a 2020 2020 2020 2020 290a  alse,.        ).
-00009890: 2020 2020 2020 2020 6f75 745f 6469 6d73          out_dims
-000098a0: 203d 2062 6174 6368 5f64 696d 7320 2b20   = batch_dims + 
-000098b0: 5b6f 7574 5f66 6c61 745f 6469 6d5d 202b  [out_flat_dim] +
-000098c0: 2066 6561 7475 7265 5f64 696d 730a 2020   feature_dims.  
-000098d0: 2020 2020 2020 6f75 745f 7368 6170 6520        out_shape 
-000098e0: 3d20 5b64 2e67 6574 5f64 696d 5f76 616c  = [d.get_dim_val
-000098f0: 7565 2829 2066 6f72 2064 2069 6e20 6f75  ue() for d in ou
-00009900: 745f 6469 6d73 5d0a 2020 2020 2020 2020  t_dims].        
-00009910: 6f75 745f 7261 7720 3d20 746f 7263 682e  out_raw = torch.
-00009920: 7a65 726f 7328 6f75 745f 7368 6170 652c  zeros(out_shape,
-00009930: 2064 7479 7065 3d73 6f75 7263 652e 7261   dtype=source.ra
-00009940: 775f 7465 6e73 6f72 2e64 7479 7065 2c20  w_tensor.dtype, 
-00009950: 6465 7669 6365 3d73 6f75 7263 652e 7261  device=source.ra
-00009960: 775f 7465 6e73 6f72 2e64 6576 6963 6529  w_tensor.device)
-00009970: 0a20 2020 2020 2020 206f 7574 5f72 6177  .        out_raw
-00009980: 2e73 6361 7474 6572 5f61 6464 5f28 6469  .scatter_add_(di
-00009990: 6d3d 6c65 6e28 6261 7463 685f 6469 6d73  m=len(batch_dims
-000099a0: 292c 2069 6e64 6578 3d69 6e64 6963 6573  ), index=indices
-000099b0: 2e72 6177 5f74 656e 736f 722e 746f 2874  .raw_tensor.to(t
-000099c0: 6f72 6368 2e69 6e74 3634 292c 2073 7263  orch.int64), src
-000099d0: 3d73 6f75 7263 652e 7261 775f 7465 6e73  =source.raw_tens
-000099e0: 6f72 290a 2020 2020 2020 2020 7265 7320  or).        res 
-000099f0: 3d20 5465 6e73 6f72 280a 2020 2020 2020  = Tensor(.      
-00009a00: 2020 2020 2020 2273 6361 7474 6572 222c        "scatter",
-00009a10: 0a20 2020 2020 2020 2020 2020 2064 696d  .            dim
-00009a20: 733d 6f75 745f 6469 6d73 2c0a 2020 2020  s=out_dims,.    
-00009a30: 2020 2020 2020 2020 6474 7970 653d 736f          dtype=so
-00009a40: 7572 6365 2e64 7479 7065 2c0a 2020 2020  urce.dtype,.    
-00009a50: 2020 2020 2020 2020 7370 6172 7365 5f64          sparse_d
-00009a60: 696d 3d73 6f75 7263 652e 7370 6172 7365  im=source.sparse
-00009a70: 5f64 696d 2c0a 2020 2020 2020 2020 2020  _dim,.          
-00009a80: 2020 7261 775f 7465 6e73 6f72 3d6f 7574    raw_tensor=out
-00009a90: 5f72 6177 2c0a 2020 2020 2020 2020 290a  _raw,.        ).
-00009aa0: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
-00009ab0: 7574 5f64 696d 2920 3e20 313a 0a20 2020  ut_dim) > 1:.   
-00009ac0: 2020 2020 2020 2020 2072 6573 203d 2072           res = r
-00009ad0: 662e 7370 6c69 745f 6469 6d73 2872 6573  f.split_dims(res
-00009ae0: 2c20 6178 6973 3d6f 7574 5f66 6c61 745f  , axis=out_flat_
-00009af0: 6469 6d2c 2064 696d 733d 6f75 745f 6469  dim, dims=out_di
-00009b00: 6d29 0a20 2020 2020 2020 2072 6574 7572  m).        retur
-00009b10: 6e20 7265 730a 0a20 2020 2040 7374 6174  n res..    @stat
-00009b20: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00009b30: 2073 6c69 6365 280a 2020 2020 2020 2020   slice(.        
-00009b40: 736f 7572 6365 3a20 5465 6e73 6f72 2c0a  source: Tensor,.
-00009b50: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00009b60: 2020 2061 7869 733a 2044 696d 2c0a 2020     axis: Dim,.  
-00009b70: 2020 2020 2020 7374 6172 743a 204f 7074        start: Opt
-00009b80: 696f 6e61 6c5b 556e 696f 6e5b 696e 742c  ional[Union[int,
-00009b90: 2054 656e 736f 725d 5d20 3d20 4e6f 6e65   Tensor]] = None
-00009ba0: 2c0a 2020 2020 2020 2020 656e 643a 204f  ,.        end: O
-00009bb0: 7074 696f 6e61 6c5b 556e 696f 6e5b 696e  ptional[Union[in
-00009bc0: 742c 2054 656e 736f 725d 5d20 3d20 4e6f  t, Tensor]] = No
-00009bd0: 6e65 2c0a 2020 2020 2020 2020 7374 6570  ne,.        step
-00009be0: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
-00009bf0: 5b69 6e74 2c20 5465 6e73 6f72 5d5d 203d  [int, Tensor]] =
-00009c00: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-00009c10: 697a 653a 204f 7074 696f 6e61 6c5b 556e  ize: Optional[Un
-00009c20: 696f 6e5b 696e 742c 2054 656e 736f 722c  ion[int, Tensor,
-00009c30: 2044 696d 5d5d 203d 204e 6f6e 652c 0a20   Dim]] = None,. 
-00009c40: 2020 2020 2020 206f 7574 5f64 696d 3a20         out_dim: 
-00009c50: 4469 6d2c 0a20 2020 2029 202d 3e20 5465  Dim,.    ) -> Te
-00009c60: 6e73 6f72 3a0a 2020 2020 2020 2020 2222  nsor:.        ""
-00009c70: 2273 6c69 6365 2222 220a 2020 2020 2020  "slice""".      
-00009c80: 2020 6178 6973 5f69 6e74 203d 2073 6f75    axis_int = sou
-00009c90: 7263 652e 6765 745f 6178 6973 5f66 726f  rce.get_axis_fro
-00009ca0: 6d5f 6465 7363 7269 7074 696f 6e28 6178  m_description(ax
-00009cb0: 6973 2c20 616c 6c6f 775f 696e 743d 4661  is, allow_int=Fa
-00009cc0: 6c73 6529 0a20 2020 2020 2020 206f 7574  lse).        out
-00009cd0: 203d 2073 6f75 7263 652e 636f 7079 5f74   = source.copy_t
-00009ce0: 656d 706c 6174 655f 7265 706c 6163 655f  emplate_replace_
-00009cf0: 6469 6d5f 7461 6728 6178 6973 3d61 7869  dim_tag(axis=axi
-00009d00: 735f 696e 742c 206e 6577 5f64 696d 5f74  s_int, new_dim_t
-00009d10: 6167 3d6f 7574 5f64 696d 290a 2020 2020  ag=out_dim).    
-00009d20: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00009d30: 6528 7374 6172 742c 2054 656e 736f 7229  e(start, Tensor)
-00009d40: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00009d50: 7365 7274 2073 7461 7274 2e64 696d 7320  sert start.dims 
-00009d60: 3d3d 2028 290a 2020 2020 2020 2020 2020  == ().          
-00009d70: 2020 7374 6172 7420 3d20 7374 6172 742e    start = start.
-00009d80: 7261 775f 7465 6e73 6f72 0a20 2020 2020  raw_tensor.     
-00009d90: 2020 2069 6620 7374 6172 7420 6973 204e     if start is N
-00009da0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00009db0: 2073 7461 7274 203d 2030 0a20 2020 2020   start = 0.     
-00009dc0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00009dd0: 2873 697a 652c 2044 696d 293a 0a20 2020  (size, Dim):.   
-00009de0: 2020 2020 2020 2020 2073 697a 6520 3d20           size = 
-00009df0: 7369 7a65 2e67 6574 5f64 696d 5f76 616c  size.get_dim_val
-00009e00: 7565 2829 0a20 2020 2020 2020 2069 6620  ue().        if 
-00009e10: 7369 7a65 2069 7320 6e6f 7420 4e6f 6e65  size is not None
-00009e20: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00009e30: 7365 7274 2065 6e64 2069 7320 4e6f 6e65  sert end is None
-00009e40: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00009e50: 2e72 6177 5f74 656e 736f 7220 3d20 746f  .raw_tensor = to
-00009e60: 7263 682e 6e61 7272 6f77 2873 6f75 7263  rch.narrow(sourc
-00009e70: 652e 7261 775f 7465 6e73 6f72 2c20 6469  e.raw_tensor, di
-00009e80: 6d3d 6178 6973 5f69 6e74 2c20 7374 6172  m=axis_int, star
-00009e90: 743d 7374 6172 742c 206c 656e 6774 683d  t=start, length=
-00009ea0: 7369 7a65 290a 2020 2020 2020 2020 656c  size).        el
-00009eb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009ec0: 6966 2069 7369 6e73 7461 6e63 6528 656e  if isinstance(en
-00009ed0: 642c 2054 656e 736f 7229 3a0a 2020 2020  d, Tensor):.    
-00009ee0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00009ef0: 7274 2065 6e64 2e64 696d 7320 3d3d 2028  rt end.dims == (
-00009f00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009f10: 2020 656e 6420 3d20 656e 642e 7261 775f    end = end.raw_
-00009f20: 7465 6e73 6f72 0a20 2020 2020 2020 2020  tensor.         
-00009f30: 2020 2069 6620 656e 6420 6973 204e 6f6e     if end is Non
-00009f40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00009f50: 2020 2065 6e64 203d 2061 7869 732e 6765     end = axis.ge
-00009f60: 745f 6469 6d5f 7661 6c75 6528 290a 2020  t_dim_value().  
-00009f70: 2020 2020 2020 2020 2020 6f75 742e 7261            out.ra
-00009f80: 775f 7465 6e73 6f72 203d 2074 6f72 6368  w_tensor = torch
-00009f90: 2e6e 6172 726f 7728 736f 7572 6365 2e72  .narrow(source.r
-00009fa0: 6177 5f74 656e 736f 722c 2064 696d 3d61  aw_tensor, dim=a
-00009fb0: 7869 735f 696e 742c 2073 7461 7274 3d73  xis_int, start=s
-00009fc0: 7461 7274 2c20 6c65 6e67 7468 3d65 6e64  tart, length=end
-00009fd0: 202d 2073 7461 7274 290a 2020 2020 2020   - start).      
-00009fe0: 2020 7265 7475 726e 206f 7574 0a0a 2020    return out..  
-00009ff0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-0000a000: 2020 2020 6465 6620 7768 6572 6528 0a20      def where(. 
-0000a010: 2020 2020 2020 2063 6f6e 643a 2054 656e         cond: Ten
-0000a020: 736f 722c 0a20 2020 2020 2020 2074 7275  sor,.        tru
-0000a030: 655f 3a20 556e 696f 6e5b 5465 6e73 6f72  e_: Union[Tensor
-0000a040: 2c20 7266 2e52 6177 5465 6e73 6f72 5479  , rf.RawTensorTy
-0000a050: 7065 735d 2c0a 2020 2020 2020 2020 6661  pes],.        fa
-0000a060: 6c73 655f 3a20 556e 696f 6e5b 5465 6e73  lse_: Union[Tens
-0000a070: 6f72 2c20 7266 2e52 6177 5465 6e73 6f72  or, rf.RawTensor
-0000a080: 5479 7065 735d 2c0a 2020 2020 2020 2020  Types],.        
-0000a090: 2a2c 0a20 2020 2020 2020 2061 6c6c 6f77  *,.        allow
-0000a0a0: 5f62 726f 6164 6361 7374 5f61 6c6c 5f73  _broadcast_all_s
-0000a0b0: 6f75 7263 6573 3a20 626f 6f6c 203d 2046  ources: bool = F
-0000a0c0: 616c 7365 2c0a 2020 2020 2920 2d3e 2054  alse,.    ) -> T
-0000a0d0: 656e 736f 723a 0a20 2020 2020 2020 2022  ensor:.        "
-0000a0e0: 2222 7768 6572 6522 2222 0a20 2020 2020  ""where""".     
-0000a0f0: 2020 2074 7275 655f 203d 2072 662e 636f     true_ = rf.co
-0000a100: 6e76 6572 745f 746f 5f74 656e 736f 7228  nvert_to_tensor(
-0000a110: 7472 7565 5f2c 205f 6261 636b 656e 643d  true_, _backend=
-0000a120: 546f 7263 6842 6163 6b65 6e64 2c20 6465  TorchBackend, de
-0000a130: 7669 6365 3d63 6f6e 642e 6465 7669 6365  vice=cond.device
-0000a140: 290a 2020 2020 2020 2020 6661 6c73 655f  ).        false_
-0000a150: 203d 2072 662e 636f 6e76 6572 745f 746f   = rf.convert_to
-0000a160: 5f74 656e 736f 7228 6661 6c73 655f 2c20  _tensor(false_, 
-0000a170: 5f62 6163 6b65 6e64 3d54 6f72 6368 4261  _backend=TorchBa
-0000a180: 636b 656e 642c 2064 6576 6963 653d 636f  ckend, device=co
-0000a190: 6e64 2e64 6576 6963 6529 0a20 2020 2020  nd.device).     
-0000a1a0: 2020 206f 7574 203d 2054 656e 736f 722e     out = Tensor.
-0000a1b0: 6765 745f 636f 6d6d 6f6e 5f64 6174 6128  get_common_data(
-0000a1c0: 0a20 2020 2020 2020 2020 2020 205b 7472  .            [tr
-0000a1d0: 7565 5f2c 2066 616c 7365 5f2c 2063 6f6e  ue_, false_, con
-0000a1e0: 645d 2c20 616c 6c6f 775f 6272 6f61 6463  d], allow_broadc
-0000a1f0: 6173 745f 616c 6c5f 736f 7572 6365 733d  ast_all_sources=
-0000a200: 616c 6c6f 775f 6272 6f61 6463 6173 745f  allow_broadcast_
-0000a210: 616c 6c5f 736f 7572 6365 732c 206e 616d  all_sources, nam
-0000a220: 653d 2277 6865 7265 220a 2020 2020 2020  e="where".      
-0000a230: 2020 290a 2020 2020 2020 2020 6f75 742e    ).        out.
-0000a240: 6474 7970 6520 3d20 7472 7565 5f2e 6474  dtype = true_.dt
-0000a250: 7970 650a 2020 2020 2020 2020 6f75 742e  ype.        out.
-0000a260: 7370 6172 7365 5f64 696d 203d 2074 7275  sparse_dim = tru
-0000a270: 655f 2e73 7061 7273 655f 6469 6d20 6f72  e_.sparse_dim or
-0000a280: 2066 616c 7365 5f2e 7370 6172 7365 5f64   false_.sparse_d
-0000a290: 696d 0a20 2020 2020 2020 206f 7574 2e66  im.        out.f
-0000a2a0: 6561 7475 7265 5f64 696d 203d 2074 7275  eature_dim = tru
-0000a2b0: 655f 2e66 6561 7475 7265 5f64 696d 206f  e_.feature_dim o
-0000a2c0: 7220 6661 6c73 655f 2e66 6561 7475 7265  r false_.feature
-0000a2d0: 5f64 696d 0a20 2020 2020 2020 2063 6f6e  _dim.        con
-0000a2e0: 645f 6263 5f72 6177 203d 2063 6f6e 642e  d_bc_raw = cond.
-0000a2f0: 636f 7079 5f63 6f6d 7061 7469 626c 655f  copy_compatible_
-0000a300: 746f 5f64 696d 735f 7261 7728 6f75 742e  to_dims_raw(out.
-0000a310: 6469 6d73 290a 2020 2020 2020 2020 7472  dims).        tr
-0000a320: 7565 5f62 635f 7261 7720 3d20 7472 7565  ue_bc_raw = true
-0000a330: 5f2e 636f 7079 5f63 6f6d 7061 7469 626c  _.copy_compatibl
-0000a340: 655f 746f 5f64 696d 735f 7261 7728 6f75  e_to_dims_raw(ou
-0000a350: 742e 6469 6d73 290a 2020 2020 2020 2020  t.dims).        
-0000a360: 6661 6c73 655f 6263 5f72 6177 203d 2066  false_bc_raw = f
-0000a370: 616c 7365 5f2e 636f 7079 5f63 6f6d 7061  alse_.copy_compa
-0000a380: 7469 626c 655f 746f 5f64 696d 735f 7261  tible_to_dims_ra
-0000a390: 7728 6f75 742e 6469 6d73 290a 2020 2020  w(out.dims).    
-0000a3a0: 2020 2020 6f75 742e 7261 775f 7465 6e73      out.raw_tens
-0000a3b0: 6f72 203d 2074 6f72 6368 2e77 6865 7265  or = torch.where
-0000a3c0: 2863 6f6e 645f 6263 5f72 6177 2c20 7472  (cond_bc_raw, tr
-0000a3d0: 7565 5f62 635f 7261 772c 2066 616c 7365  ue_bc_raw, false
-0000a3e0: 5f62 635f 7261 7729 0a20 2020 2020 2020  _bc_raw).       
-0000a3f0: 2072 6574 7572 6e20 6f75 740a 0a20 2020   return out..   
-0000a400: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-0000a410: 2020 2064 6566 2063 6c69 705f 6279 5f76     def clip_by_v
-0000a420: 616c 7565 280a 2020 2020 2020 2020 783a  alue(.        x:
-0000a430: 2054 656e 736f 722c 0a20 2020 2020 2020   Tensor,.       
-0000a440: 2063 6c69 705f 7661 6c75 655f 6d69 6e3a   clip_value_min:
-0000a450: 2055 6e69 6f6e 5b54 656e 736f 722c 2072   Union[Tensor, r
-0000a460: 662e 5261 7754 656e 736f 7254 7970 6573  f.RawTensorTypes
-0000a470: 5d2c 0a20 2020 2020 2020 2063 6c69 705f  ],.        clip_
-0000a480: 7661 6c75 655f 6d61 783a 2055 6e69 6f6e  value_max: Union
-0000a490: 5b54 656e 736f 722c 2072 662e 5261 7754  [Tensor, rf.RawT
-0000a4a0: 656e 736f 7254 7970 6573 5d2c 0a20 2020  ensorTypes],.   
-0000a4b0: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
-0000a4c0: 616c 6c6f 775f 6272 6f61 6463 6173 745f  allow_broadcast_
-0000a4d0: 616c 6c5f 736f 7572 6365 733a 2062 6f6f  all_sources: boo
-0000a4e0: 6c20 3d20 4661 6c73 652c 0a20 2020 2029  l = False,.    )
-0000a4f0: 202d 3e20 5465 6e73 6f72 3a0a 2020 2020   -> Tensor:.    
-0000a500: 2020 2020 2222 2263 6c69 7020 6279 2076      """clip by v
-0000a510: 616c 7565 2222 220a 2020 2020 2020 2020  alue""".        
-0000a520: 636c 6970 5f76 616c 7565 5f6d 696e 203d  clip_value_min =
-0000a530: 2072 662e 636f 6e76 6572 745f 746f 5f74   rf.convert_to_t
-0000a540: 656e 736f 7228 636c 6970 5f76 616c 7565  ensor(clip_value
-0000a550: 5f6d 696e 2c20 5f62 6163 6b65 6e64 3d54  _min, _backend=T
-0000a560: 6f72 6368 4261 636b 656e 642c 2064 6576  orchBackend, dev
-0000a570: 6963 653d 782e 6465 7669 6365 290a 2020  ice=x.device).  
-0000a580: 2020 2020 2020 636c 6970 5f76 616c 7565        clip_value
-0000a590: 5f6d 6178 203d 2072 662e 636f 6e76 6572  _max = rf.conver
-0000a5a0: 745f 746f 5f74 656e 736f 7228 636c 6970  t_to_tensor(clip
-0000a5b0: 5f76 616c 7565 5f6d 6178 2c20 5f62 6163  _value_max, _bac
-0000a5c0: 6b65 6e64 3d54 6f72 6368 4261 636b 656e  kend=TorchBacken
-0000a5d0: 642c 2064 6576 6963 653d 782e 6465 7669  d, device=x.devi
-0000a5e0: 6365 290a 2020 2020 2020 2020 6f75 7420  ce).        out 
-0000a5f0: 3d20 5465 6e73 6f72 2e67 6574 5f63 6f6d  = Tensor.get_com
-0000a600: 6d6f 6e5f 6461 7461 280a 2020 2020 2020  mon_data(.      
-0000a610: 2020 2020 2020 5b78 2c20 636c 6970 5f76        [x, clip_v
-0000a620: 616c 7565 5f6d 696e 2c20 636c 6970 5f76  alue_min, clip_v
-0000a630: 616c 7565 5f6d 6178 5d2c 0a20 2020 2020  alue_max],.     
-0000a640: 2020 2020 2020 2061 6c6c 6f77 5f62 726f         allow_bro
-0000a650: 6164 6361 7374 5f61 6c6c 5f73 6f75 7263  adcast_all_sourc
-0000a660: 6573 3d61 6c6c 6f77 5f62 726f 6164 6361  es=allow_broadca
-0000a670: 7374 5f61 6c6c 5f73 6f75 7263 6573 2c0a  st_all_sources,.
-0000a680: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000a690: 3d22 636c 6970 5f62 795f 7661 6c75 6522  ="clip_by_value"
-0000a6a0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000a6b0: 2020 2020 6f75 742e 6474 7970 6520 3d20      out.dtype = 
-0000a6c0: 782e 6474 7970 650a 2020 2020 2020 2020  x.dtype.        
-0000a6d0: 6f75 742e 7370 6172 7365 5f64 696d 203d  out.sparse_dim =
-0000a6e0: 2078 2e73 7061 7273 655f 6469 6d0a 2020   x.sparse_dim.  
-0000a6f0: 2020 2020 2020 6f75 742e 6665 6174 7572        out.featur
-0000a700: 655f 6469 6d20 3d20 782e 6665 6174 7572  e_dim = x.featur
-0000a710: 655f 6469 6d0a 2020 2020 2020 2020 785f  e_dim.        x_
-0000a720: 6263 5f72 6177 203d 2078 2e63 6f70 795f  bc_raw = x.copy_
-0000a730: 636f 6d70 6174 6962 6c65 5f74 6f5f 6469  compatible_to_di
-0000a740: 6d73 5f72 6177 286f 7574 2e64 696d 7329  ms_raw(out.dims)
-0000a750: 0a20 2020 2020 2020 206d 696e 5f62 635f  .        min_bc_
-0000a760: 7261 7720 3d20 636c 6970 5f76 616c 7565  raw = clip_value
-0000a770: 5f6d 696e 2e63 6f70 795f 636f 6d70 6174  _min.copy_compat
-0000a780: 6962 6c65 5f74 6f5f 6469 6d73 5f72 6177  ible_to_dims_raw
-0000a790: 286f 7574 2e64 696d 7329 0a20 2020 2020  (out.dims).     
-0000a7a0: 2020 206d 6178 5f62 635f 7261 7720 3d20     max_bc_raw = 
-0000a7b0: 636c 6970 5f76 616c 7565 5f6d 6178 2e63  clip_value_max.c
-0000a7c0: 6f70 795f 636f 6d70 6174 6962 6c65 5f74  opy_compatible_t
-0000a7d0: 6f5f 6469 6d73 5f72 6177 286f 7574 2e64  o_dims_raw(out.d
-0000a7e0: 696d 7329 0a20 2020 2020 2020 206f 7574  ims).        out
-0000a7f0: 2e72 6177 5f74 656e 736f 7220 3d20 746f  .raw_tensor = to
-0000a800: 7263 682e 636c 616d 7028 785f 6263 5f72  rch.clamp(x_bc_r
-0000a810: 6177 2c20 6d69 6e5f 6263 5f72 6177 2c20  aw, min_bc_raw, 
-0000a820: 6d61 785f 6263 5f72 6177 290a 2020 2020  max_bc_raw).    
-0000a830: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
-0000a840: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-0000a850: 640a 2020 2020 6465 6620 6d61 746d 756c  d.    def matmul
-0000a860: 2861 3a20 5f54 542c 2062 3a20 5f54 542c  (a: _TT, b: _TT,
-0000a870: 202a 2c20 7265 6475 6365 3a20 556e 696f   *, reduce: Unio
-0000a880: 6e5b 4469 6d2c 2053 6571 7565 6e63 655b  n[Dim, Sequence[
-0000a890: 4469 6d5d 5d2c 2075 7365 5f6d 6173 6b3a  Dim]], use_mask:
-0000a8a0: 2062 6f6f 6c20 3d20 5472 7565 2920 2d3e   bool = True) ->
-0000a8b0: 205f 5454 3a0a 2020 2020 2020 2020 2222   _TT:.        ""
-0000a8c0: 220a 2020 2020 2020 2020 6261 7463 6865  ".        batche
-0000a8d0: 6420 6d61 746d 756c 206f 6620 6120 616e  d matmul of a an
-0000a8e0: 6420 622c 2073 6565 2062 6173 6520 636c  d b, see base cl
-0000a8f0: 6173 7320 646f 6320 7374 7269 6e67 0a20  ass doc string. 
-0000a900: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000a910: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000a920: 2872 6564 7563 652c 2044 696d 293a 0a20  (reduce, Dim):. 
-0000a930: 2020 2020 2020 2020 2020 2072 6564 7563             reduc
-0000a940: 6520 3d20 5b72 6564 7563 655d 0a0a 2020  e = [reduce]..  
-0000a950: 2020 2020 2020 6966 2075 7365 5f6d 6173        if use_mas
-0000a960: 6b20 616e 6420 616e 7928 6469 6d2e 6479  k and any(dim.dy
-0000a970: 6e5f 7369 7a65 5f65 7874 2066 6f72 2064  n_size_ext for d
-0000a980: 696d 2069 6e20 7265 6475 6365 293a 0a20  im in reduce):. 
-0000a990: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000a9a0: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-0000a9b0: 7272 6f72 2822 6d61 736b 696e 6720 696e  rror("masking in
-0000a9c0: 206d 6174 6d75 6c20 7265 6475 6365 206e   matmul reduce n
-0000a9d0: 6f74 2079 6574 2069 6d70 6c65 6d65 6e74  ot yet implement
-0000a9e0: 6564 2229 0a0a 2020 2020 2020 2020 615f  ed")..        a_
-0000a9f0: 6469 6d73 203d 2061 2e64 696d 730a 2020  dims = a.dims.  
-0000aa00: 2020 2020 2020 625f 6469 6d73 203d 2062        b_dims = b
-0000aa10: 2e64 696d 730a 0a20 2020 2020 2020 2061  .dims..        a
-0000aa20: 7373 6572 7420 616c 6c28 0a20 2020 2020  ssert all(.     
-0000aa30: 2020 2020 2020 2064 696d 2069 6e20 615f         dim in a_
-0000aa40: 6469 6d73 2066 6f72 2064 696d 2069 6e20  dims for dim in 
-0000aa50: 7265 6475 6365 0a20 2020 2020 2020 2029  reduce.        )
-0000aa60: 2c20 6622 2761 2720 646f 6573 206e 6f74  , f"'a' does not
-0000aa70: 2068 6176 6520 7468 6520 7370 6563 6966   have the specif
-0000aa80: 6965 6420 7265 6475 6365 2064 696d 2873  ied reduce dim(s
-0000aa90: 2920 7b72 6564 7563 657d 2028 6120 6469  ) {reduce} (a di
-0000aaa0: 6d73 3a20 7b61 5f64 696d 737d 2922 0a20  ms: {a_dims})". 
-0000aab0: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
-0000aac0: 6c28 0a20 2020 2020 2020 2020 2020 2064  l(.            d
-0000aad0: 696d 2069 6e20 625f 6469 6d73 2066 6f72  im in b_dims for
-0000aae0: 2064 696d 2069 6e20 7265 6475 6365 0a20   dim in reduce. 
-0000aaf0: 2020 2020 2020 2029 2c20 6622 2762 2720         ), f"'b' 
-0000ab00: 646f 6573 206e 6f74 2068 6176 6520 7468  does not have th
-0000ab10: 6520 7370 6563 6966 6965 6420 7265 6475  e specified redu
-0000ab20: 6365 2064 696d 2873 2920 7b72 6564 7563  ce dim(s) {reduc
-0000ab30: 657d 2028 6220 6469 6d73 3a20 7b62 5f64  e} (b dims: {b_d
-0000ab40: 696d 737d 2922 0a0a 2020 2020 2020 2020  ims})"..        
-0000ab50: 6966 206c 656e 2872 6564 7563 6529 203e  if len(reduce) >
-0000ab60: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000ab70: 7265 6475 6365 203d 206c 6973 7428 7265  reduce = list(re
-0000ab80: 6475 6365 290a 2020 2020 2020 2020 2020  duce).          
-0000ab90: 2020 7265 6475 6365 2e73 6f72 7428 6b65    reduce.sort(ke
-0000aba0: 793d 6c61 6d62 6461 2064 696d 3a20 615f  y=lambda dim: a_
-0000abb0: 6469 6d73 2e69 6e64 6578 2864 696d 2929  dims.index(dim))
-0000abc0: 0a0a 2020 2020 2020 2020 2320 6d61 746d  ..        # matm
-0000abd0: 756c 206d 6967 6874 2067 6574 2073 7175  ul might get squ
-0000abe0: 6172 6520 6d61 7472 6963 6573 2061 7320  are matrices as 
-0000abf0: 6172 6775 6d65 6e74 732c 2077 6865 7265  arguments, where
-0000ac00: 2061 2064 696d 2063 6f75 6c64 206f 6363   a dim could occ
-0000ac10: 7572 206d 756c 7469 706c 6520 7469 6d65  ur multiple time
-0000ac20: 732e 0a20 2020 2020 2020 2023 2054 6869  s..        # Thi
-0000ac30: 7320 636f 6d70 6c69 6361 7465 7320 7468  s complicates th
-0000ac40: 6520 6c6f 6769 6320 6865 7265 2c20 616e  e logic here, an
-0000ac50: 6420 7765 2070 726f 7065 726c 7920 6861  d we properly ha
-0000ac60: 7665 2074 6f20 6861 6e64 6c65 206d 6174  ve to handle mat
-0000ac70: 6368 5f70 7269 6f72 6974 792e 0a20 2020  ch_priority..   
-0000ac80: 2020 2020 2061 5f72 6564 7563 655f 6178       a_reduce_ax
-0000ac90: 6573 203d 205b 612e 6765 745f 6178 6973  es = [a.get_axis
-0000aca0: 5f66 726f 6d5f 6465 7363 7269 7074 696f  _from_descriptio
-0000acb0: 6e28 7265 6475 6365 5f64 696d 2920 666f  n(reduce_dim) fo
-0000acc0: 7220 7265 6475 6365 5f64 696d 2069 6e20  r reduce_dim in 
-0000acd0: 7265 6475 6365 5d0a 2020 2020 2020 2020  reduce].        
-0000ace0: 625f 7265 6475 6365 5f61 7865 7320 3d20  b_reduce_axes = 
-0000acf0: 5b62 2e67 6574 5f61 7869 735f 6672 6f6d  [b.get_axis_from
-0000ad00: 5f64 6573 6372 6970 7469 6f6e 2872 6564  _description(red
-0000ad10: 7563 655f 6469 6d29 2066 6f72 2072 6564  uce_dim) for red
-0000ad20: 7563 655f 6469 6d20 696e 2072 6564 7563  uce_dim in reduc
-0000ad30: 655d 0a0a 2020 2020 2020 2020 2320 5765  e]..        # We
-0000ad40: 2061 7373 756d 6520 7468 6174 2064 696d   assume that dim
-0000ad50: 2074 6167 7320 696e 2072 656d 6169 6e69   tags in remaini
-0000ad60: 6e67 2064 696d 7320 6172 6520 756e 6971  ng dims are uniq
-0000ad70: 7565 2e0a 2020 2020 2020 2020 636f 6d6d  ue..        comm
-0000ad80: 6f6e 5f64 696d 7320 3d20 5b64 696d 2066  on_dims = [dim f
-0000ad90: 6f72 2069 2c20 6469 6d20 696e 2065 6e75  or i, dim in enu
-0000ada0: 6d65 7261 7465 2861 5f64 696d 7329 2069  merate(a_dims) i
-0000adb0: 6620 6469 6d20 696e 2062 5f64 696d 7320  f dim in b_dims 
-0000adc0: 616e 6420 6920 6e6f 7420 696e 2061 5f72  and i not in a_r
-0000add0: 6564 7563 655f 6178 6573 5d0a 2020 2020  educe_axes].    
-0000ade0: 2020 2020 615f 636f 6d6d 6f6e 5f61 7865      a_common_axe
-0000adf0: 7320 3d20 5b61 5f64 696d 732e 696e 6465  s = [a_dims.inde
-0000ae00: 7828 636f 6d6d 6f6e 5f64 696d 2920 666f  x(common_dim) fo
-0000ae10: 7220 636f 6d6d 6f6e 5f64 696d 2069 6e20  r common_dim in 
-0000ae20: 636f 6d6d 6f6e 5f64 696d 735d 0a20 2020  common_dims].   
-0000ae30: 2020 2020 2062 5f63 6f6d 6d6f 6e5f 6178       b_common_ax
-0000ae40: 6573 203d 205b 625f 6469 6d73 2e69 6e64  es = [b_dims.ind
-0000ae50: 6578 2863 6f6d 6d6f 6e5f 6469 6d29 2066  ex(common_dim) f
-0000ae60: 6f72 2063 6f6d 6d6f 6e5f 6469 6d20 696e  or common_dim in
-0000ae70: 2063 6f6d 6d6f 6e5f 6469 6d73 5d0a 0a20   common_dims].. 
-0000ae80: 2020 2020 2020 2061 5f75 6e69 7175 655f         a_unique_
-0000ae90: 6178 6573 203d 205b 6920 666f 7220 6920  axes = [i for i 
-0000aea0: 696e 2072 616e 6765 286c 656e 2861 5f64  in range(len(a_d
-0000aeb0: 696d 7329 2920 6966 2069 206e 6f74 2069  ims)) if i not i
-0000aec0: 6e20 615f 7265 6475 6365 5f61 7865 7320  n a_reduce_axes 
-0000aed0: 616e 6420 6920 6e6f 7420 696e 2061 5f63  and i not in a_c
-0000aee0: 6f6d 6d6f 6e5f 6178 6573 5d0a 2020 2020  ommon_axes].    
-0000aef0: 2020 2020 625f 756e 6971 7565 5f61 7865      b_unique_axe
-0000af00: 7320 3d20 5b69 2066 6f72 2069 2069 6e20  s = [i for i in 
-0000af10: 7261 6e67 6528 6c65 6e28 625f 6469 6d73  range(len(b_dims
-0000af20: 2929 2069 6620 6920 6e6f 7420 696e 2062  )) if i not in b
-0000af30: 5f72 6564 7563 655f 6178 6573 2061 6e64  _reduce_axes and
-0000af40: 2069 206e 6f74 2069 6e20 625f 636f 6d6d   i not in b_comm
-0000af50: 6f6e 5f61 7865 735d 0a0a 2020 2020 2020  on_axes]..      
-0000af60: 2020 615f 7261 7720 3d20 612e 7261 775f    a_raw = a.raw_
-0000af70: 7465 6e73 6f72 0a20 2020 2020 2020 2062  tensor.        b
-0000af80: 5f72 6177 203d 2062 2e72 6177 5f74 656e  _raw = b.raw_ten
-0000af90: 736f 720a 0a20 2020 2020 2020 2061 5f73  sor..        a_s
-0000afa0: 6861 7065 203d 2061 5f72 6177 2e73 6861  hape = a_raw.sha
-0000afb0: 7065 0a20 2020 2020 2020 2062 5f73 6861  pe.        b_sha
-0000afc0: 7065 203d 2062 5f72 6177 2e73 6861 7065  pe = b_raw.shape
-0000afd0: 0a0a 2020 2020 2020 2020 636f 6d6d 6f6e  ..        common
-0000afe0: 5f61 7865 735f 7368 6170 6520 3d20 7475  _axes_shape = tu
-0000aff0: 706c 6528 615f 7368 6170 655b 695d 2066  ple(a_shape[i] f
-0000b000: 6f72 2069 2069 6e20 615f 636f 6d6d 6f6e  or i in a_common
-0000b010: 5f61 7865 7329 0a20 2020 2020 2020 2062  _axes).        b
-0000b020: 5f63 6f6d 6d6f 6e5f 6178 6573 5f73 6861  _common_axes_sha
-0000b030: 7065 203d 2074 7570 6c65 2862 5f73 6861  pe = tuple(b_sha
-0000b040: 7065 5b69 5d20 666f 7220 6920 696e 2062  pe[i] for i in b
-0000b050: 5f63 6f6d 6d6f 6e5f 6178 6573 290a 2020  _common_axes).  
-0000b060: 2020 2020 2020 6173 7365 7274 2063 6f6d        assert com
-0000b070: 6d6f 6e5f 6178 6573 5f73 6861 7065 203d  mon_axes_shape =
-0000b080: 3d20 625f 636f 6d6d 6f6e 5f61 7865 735f  = b_common_axes_
-0000b090: 7368 6170 652c 2022 5465 6e73 6f72 2073  shape, "Tensor s
-0000b0a0: 6861 7065 2066 6f72 2063 6f6d 6d6f 6e20  hape for common 
-0000b0b0: 4469 6d73 206f 6620 6120 616e 6420 6220  Dims of a and b 
-0000b0c0: 646f 6573 206e 6f74 206d 6174 6368 2e22  does not match."
-0000b0d0: 0a0a 2020 2020 2020 2020 636f 6d6d 6f6e  ..        common
-0000b0e0: 5f61 7865 735f 746f 7461 6c5f 6469 6d65  _axes_total_dime
-0000b0f0: 6e73 696f 6e20 3d20 7072 6f64 2863 6f6d  nsion = prod(com
-0000b100: 6d6f 6e5f 6178 6573 5f73 6861 7065 290a  mon_axes_shape).
-0000b110: 0a20 2020 2020 2020 2061 5f75 6e69 7175  .        a_uniqu
-0000b120: 655f 6178 6573 5f73 6861 7065 203d 2074  e_axes_shape = t
-0000b130: 7570 6c65 2861 5f73 6861 7065 5b69 5d20  uple(a_shape[i] 
-0000b140: 666f 7220 6920 696e 2061 5f75 6e69 7175  for i in a_uniqu
-0000b150: 655f 6178 6573 290a 2020 2020 2020 2020  e_axes).        
-0000b160: 625f 756e 6971 7565 5f61 7865 735f 7368  b_unique_axes_sh
-0000b170: 6170 6520 3d20 7475 706c 6528 625f 7368  ape = tuple(b_sh
-0000b180: 6170 655b 695d 2066 6f72 2069 2069 6e20  ape[i] for i in 
-0000b190: 625f 756e 6971 7565 5f61 7865 7329 0a0a  b_unique_axes)..
-0000b1a0: 2020 2020 2020 2020 615f 756e 6971 7565          a_unique
-0000b1b0: 5f61 7865 735f 746f 7461 6c5f 6469 6d65  _axes_total_dime
-0000b1c0: 6e73 696f 6e20 3d20 7072 6f64 2861 5f75  nsion = prod(a_u
-0000b1d0: 6e69 7175 655f 6178 6573 5f73 6861 7065  nique_axes_shape
-0000b1e0: 290a 2020 2020 2020 2020 625f 756e 6971  ).        b_uniq
-0000b1f0: 7565 5f61 7865 735f 746f 7461 6c5f 6469  ue_axes_total_di
-0000b200: 6d65 6e73 696f 6e20 3d20 7072 6f64 2862  mension = prod(b
-0000b210: 5f75 6e69 7175 655f 6178 6573 5f73 6861  _unique_axes_sha
-0000b220: 7065 290a 0a20 2020 2020 2020 2072 6564  pe)..        red
-0000b230: 7563 655f 6178 6573 5f73 6861 7065 203d  uce_axes_shape =
-0000b240: 2074 7570 6c65 2861 5f73 6861 7065 5b69   tuple(a_shape[i
-0000b250: 5d20 666f 7220 6920 696e 2061 5f72 6564  ] for i in a_red
-0000b260: 7563 655f 6178 6573 290a 2020 2020 2020  uce_axes).      
-0000b270: 2020 625f 7265 6475 6365 5f61 7865 735f    b_reduce_axes_
-0000b280: 7368 6170 6520 3d20 7475 706c 6528 625f  shape = tuple(b_
-0000b290: 7368 6170 655b 695d 2066 6f72 2069 2069  shape[i] for i i
-0000b2a0: 6e20 625f 7265 6475 6365 5f61 7865 7329  n b_reduce_axes)
-0000b2b0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0000b2c0: 7265 6475 6365 5f61 7865 735f 7368 6170  reduce_axes_shap
-0000b2d0: 6520 3d3d 2062 5f72 6564 7563 655f 6178  e == b_reduce_ax
-0000b2e0: 6573 5f73 6861 7065 2c20 2254 656e 736f  es_shape, "Tenso
-0000b2f0: 7220 7368 6170 6520 666f 7220 7265 6475  r shape for redu
-0000b300: 6365 2044 696d 7320 646f 6573 206e 6f74  ce Dims does not
-0000b310: 206d 6174 6368 2062 6574 7765 656e 2061   match between a
-0000b320: 2061 6e64 2062 2e22 0a0a 2020 2020 2020   and b."..      
-0000b330: 2020 7265 6475 6365 5f61 7865 735f 746f    reduce_axes_to
-0000b340: 7461 6c5f 6469 6d65 6e73 696f 6e20 3d20  tal_dimension = 
-0000b350: 7072 6f64 2872 6564 7563 655f 6178 6573  prod(reduce_axes
-0000b360: 5f73 6861 7065 290a 0a20 2020 2020 2020  _shape)..       
-0000b370: 2023 2046 6972 7374 2063 6865 636b 2077   # First check w
-0000b380: 6865 7468 6572 2077 6520 6361 6e20 7573  hether we can us
-0000b390: 6520 746f 7263 682e 6e6e 2e66 756e 6374  e torch.nn.funct
-0000b3a0: 696f 6e61 6c2e 6c69 6e65 6172 2e0a 2020  ional.linear..  
-0000b3b0: 2020 2020 2020 6966 206c 656e 2862 5f63        if len(b_c
-0000b3c0: 6f6d 6d6f 6e5f 6178 6573 2920 3d3d 2030  ommon_axes) == 0
-0000b3d0: 2061 6e64 206c 656e 2862 5f72 6564 7563   and len(b_reduc
-0000b3e0: 655f 6178 6573 2920 3d3d 2031 2061 6e64  e_axes) == 1 and
-0000b3f0: 206c 656e 2862 5f75 6e69 7175 655f 6178   len(b_unique_ax
-0000b400: 6573 2920 3d3d 2031 3a0a 2020 2020 2020  es) == 1:.      
-0000b410: 2020 2020 2020 615f 7261 7720 3d20 746f        a_raw = to
-0000b420: 7263 682e 7065 726d 7574 6528 615f 7261  rch.permute(a_ra
-0000b430: 772c 2061 5f75 6e69 7175 655f 6178 6573  w, a_unique_axes
-0000b440: 202b 2061 5f72 6564 7563 655f 6178 6573   + a_reduce_axes
-0000b450: 290a 2020 2020 2020 2020 2020 2020 625f  ).            b_
-0000b460: 7261 7720 3d20 746f 7263 682e 7065 726d  raw = torch.perm
-0000b470: 7574 6528 625f 7261 772c 2062 5f75 6e69  ute(b_raw, b_uni
-0000b480: 7175 655f 6178 6573 202b 2062 5f72 6564  que_axes + b_red
-0000b490: 7563 655f 6178 6573 290a 0a20 2020 2020  uce_axes)..     
-0000b4a0: 2020 2020 2020 2072 6177 5f72 6573 756c         raw_resul
-0000b4b0: 7420 3d20 746f 7263 682e 6e6e 2e66 756e  t = torch.nn.fun
-0000b4c0: 6374 696f 6e61 6c2e 6c69 6e65 6172 2861  ctional.linear(a
-0000b4d0: 5f72 6177 2c20 625f 7261 7729 0a0a 2020  _raw, b_raw)..  
-0000b4e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000b4f0: 2020 2020 2020 2020 615f 7261 7720 3d20          a_raw = 
-0000b500: 746f 7263 682e 7065 726d 7574 6528 615f  torch.permute(a_
-0000b510: 7261 772c 2061 5f63 6f6d 6d6f 6e5f 6178  raw, a_common_ax
-0000b520: 6573 202b 2061 5f75 6e69 7175 655f 6178  es + a_unique_ax
-0000b530: 6573 202b 2061 5f72 6564 7563 655f 6178  es + a_reduce_ax
-0000b540: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-0000b550: 625f 7261 7720 3d20 746f 7263 682e 7065  b_raw = torch.pe
-0000b560: 726d 7574 6528 625f 7261 772c 2062 5f63  rmute(b_raw, b_c
-0000b570: 6f6d 6d6f 6e5f 6178 6573 202b 2062 5f72  ommon_axes + b_r
-0000b580: 6564 7563 655f 6178 6573 202b 2062 5f75  educe_axes + b_u
-0000b590: 6e69 7175 655f 6178 6573 290a 0a20 2020  nique_axes)..   
-0000b5a0: 2020 2020 2020 2020 2069 6620 636f 6d6d           if comm
-0000b5b0: 6f6e 5f61 7865 735f 746f 7461 6c5f 6469  on_axes_total_di
-0000b5c0: 6d65 6e73 696f 6e20 3d3d 2031 3a20 2023  mension == 1:  #
-0000b5d0: 2073 7461 6e64 6172 6420 6d61 7472 6978   standard matrix
-0000b5e0: 206d 756c 7469 706c 6963 6174 696f 6e0a   multiplication.
-0000b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b600: 615f 7261 7720 3d20 746f 7263 682e 7265  a_raw = torch.re
-0000b610: 7368 6170 6528 615f 7261 772c 2028 615f  shape(a_raw, (a_
-0000b620: 756e 6971 7565 5f61 7865 735f 746f 7461  unique_axes_tota
-0000b630: 6c5f 6469 6d65 6e73 696f 6e2c 2072 6564  l_dimension, red
-0000b640: 7563 655f 6178 6573 5f74 6f74 616c 5f64  uce_axes_total_d
-0000b650: 696d 656e 7369 6f6e 2929 0a20 2020 2020  imension)).     
-0000b660: 2020 2020 2020 2020 2020 2062 5f72 6177             b_raw
-0000b670: 203d 2074 6f72 6368 2e72 6573 6861 7065   = torch.reshape
-0000b680: 2862 5f72 6177 2c20 2872 6564 7563 655f  (b_raw, (reduce_
-0000b690: 6178 6573 5f74 6f74 616c 5f64 696d 656e  axes_total_dimen
-0000b6a0: 7369 6f6e 2c20 625f 756e 6971 7565 5f61  sion, b_unique_a
-0000b6b0: 7865 735f 746f 7461 6c5f 6469 6d65 6e73  xes_total_dimens
-0000b6c0: 696f 6e29 290a 0a20 2020 2020 2020 2020  ion))..         
-0000b6d0: 2020 2020 2020 2072 6177 5f72 6573 756c         raw_resul
-0000b6e0: 7420 3d20 746f 7263 682e 6d6d 2861 5f72  t = torch.mm(a_r
-0000b6f0: 6177 2c20 625f 7261 7729 0a0a 2020 2020  aw, b_raw)..    
-0000b700: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
-0000b710: 2062 6174 6368 6564 206d 6174 7269 7820   batched matrix 
-0000b720: 6d75 6c74 6970 6c69 6361 7469 6f6e 0a20  multiplication. 
-0000b730: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000b740: 5f72 6177 203d 2074 6f72 6368 2e72 6573  _raw = torch.res
-0000b750: 6861 7065 280a 2020 2020 2020 2020 2020  hape(.          
-0000b760: 2020 2020 2020 2020 2020 615f 7261 772c            a_raw,
-0000b770: 2028 636f 6d6d 6f6e 5f61 7865 735f 746f   (common_axes_to
-0000b780: 7461 6c5f 6469 6d65 6e73 696f 6e2c 2061  tal_dimension, a
-0000b790: 5f75 6e69 7175 655f 6178 6573 5f74 6f74  _unique_axes_tot
-0000b7a0: 616c 5f64 696d 656e 7369 6f6e 2c20 7265  al_dimension, re
-0000b7b0: 6475 6365 5f61 7865 735f 746f 7461 6c5f  duce_axes_total_
-0000b7c0: 6469 6d65 6e73 696f 6e29 0a20 2020 2020  dimension).     
-0000b7d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000b7e0: 2020 2020 2020 2020 2020 2020 2062 5f72               b_r
-0000b7f0: 6177 203d 2074 6f72 6368 2e72 6573 6861  aw = torch.resha
-0000b800: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
-0000b810: 2020 2020 2020 2020 625f 7261 772c 2028          b_raw, (
-0000b820: 636f 6d6d 6f6e 5f61 7865 735f 746f 7461  common_axes_tota
-0000b830: 6c5f 6469 6d65 6e73 696f 6e2c 2072 6564  l_dimension, red
-0000b840: 7563 655f 6178 6573 5f74 6f74 616c 5f64  uce_axes_total_d
-0000b850: 696d 656e 7369 6f6e 2c20 625f 756e 6971  imension, b_uniq
-0000b860: 7565 5f61 7865 735f 746f 7461 6c5f 6469  ue_axes_total_di
-0000b870: 6d65 6e73 696f 6e29 0a20 2020 2020 2020  mension).       
-0000b880: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000b890: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
-0000b8a0: 7265 7375 6c74 203d 2074 6f72 6368 2e62  result = torch.b
-0000b8b0: 6d6d 2861 5f72 6177 2c20 625f 7261 7729  mm(a_raw, b_raw)
-0000b8c0: 0a0a 2020 2020 2020 2020 2020 2020 7261  ..            ra
-0000b8d0: 775f 7265 7375 6c74 203d 2074 6f72 6368  w_result = torch
-0000b8e0: 2e72 6573 6861 7065 2872 6177 5f72 6573  .reshape(raw_res
-0000b8f0: 756c 742c 2063 6f6d 6d6f 6e5f 6178 6573  ult, common_axes
-0000b900: 5f73 6861 7065 202b 2061 5f75 6e69 7175  _shape + a_uniqu
-0000b910: 655f 6178 6573 5f73 6861 7065 202b 2062  e_axes_shape + b
-0000b920: 5f75 6e69 7175 655f 6178 6573 5f73 6861  _unique_axes_sha
-0000b930: 7065 290a 0a20 2020 2020 2020 2061 5f75  pe)..        a_u
-0000b940: 6e69 7175 655f 6469 6d73 203d 205b 615f  nique_dims = [a_
-0000b950: 6469 6d73 5b69 5d20 666f 7220 6920 696e  dims[i] for i in
-0000b960: 2061 5f75 6e69 7175 655f 6178 6573 5d0a   a_unique_axes].
-0000b970: 2020 2020 2020 2020 625f 756e 6971 7565          b_unique
-0000b980: 5f64 696d 7320 3d20 5b62 5f64 696d 735b  _dims = [b_dims[
-0000b990: 695d 2066 6f72 2069 2069 6e20 625f 756e  i] for i in b_un
-0000b9a0: 6971 7565 5f61 7865 735d 0a20 2020 2020  ique_axes].     
-0000b9b0: 2020 2072 6573 756c 745f 6469 6d73 203d     result_dims =
-0000b9c0: 2063 6f6d 6d6f 6e5f 6469 6d73 202b 2061   common_dims + a
-0000b9d0: 5f75 6e69 7175 655f 6469 6d73 202b 2062  _unique_dims + b
-0000b9e0: 5f75 6e69 7175 655f 6469 6d73 0a0a 2020  _unique_dims..  
-0000b9f0: 2020 2020 2020 7265 7375 6c74 5f74 656e        result_ten
-0000ba00: 736f 7220 3d20 5465 6e73 6f72 280a 2020  sor = Tensor(.  
-0000ba10: 2020 2020 2020 2020 2020 6e61 6d65 3d22            name="
-0000ba20: 646f 7422 2c20 6469 6d73 3d72 6573 756c  dot", dims=resul
-0000ba30: 745f 6469 6d73 2c20 7261 775f 7465 6e73  t_dims, raw_tens
-0000ba40: 6f72 3d72 6177 5f72 6573 756c 742c 2064  or=raw_result, d
-0000ba50: 7479 7065 3d54 6f72 6368 4261 636b 656e  type=TorchBacken
-0000ba60: 642e 6765 745f 6474 7970 655f 6e61 6d65  d.get_dtype_name
-0000ba70: 5f72 6177 2872 6177 5f72 6573 756c 7429  _raw(raw_result)
-0000ba80: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000ba90: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0000baa0: 745f 7465 6e73 6f72 0a0a 2020 2020 4073  t_tensor..    @s
-0000bab0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-0000bac0: 6465 6620 7261 6e67 655f 6f76 6572 5f64  def range_over_d
-0000bad0: 696d 2864 696d 3a20 4469 6d2c 202a 2c20  im(dim: Dim, *, 
-0000bae0: 6474 7970 653a 204f 7074 696f 6e61 6c5b  dtype: Optional[
-0000baf0: 7374 725d 203d 204e 6f6e 652c 2064 6576  str] = None, dev
-0000bb00: 6963 653a 204f 7074 696f 6e61 6c5b 7374  ice: Optional[st
-0000bb10: 725d 203d 204e 6f6e 6529 202d 3e20 5465  r] = None) -> Te
-0000bb20: 6e73 6f72 5b74 6f72 6368 2e54 656e 736f  nsor[torch.Tenso
-0000bb30: 725d 3a0a 2020 2020 2020 2020 2222 220a  r]:.        """.
-0000bb40: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-0000bb50: 696d 3a0a 2020 2020 2020 2020 3a70 6172  im:.        :par
-0000bb60: 616d 2064 7479 7065 3a0a 2020 2020 2020  am dtype:.      
-0000bb70: 2020 3a70 6172 616d 2064 6576 6963 653a    :param device:
-0000bb80: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000bb90: 3a20 7465 6e73 6f72 2077 6974 6820 7368  : tensor with sh
-0000bba0: 6170 6520 5b64 696d 5d0a 2020 2020 2020  ape [dim].      
-0000bbb0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0000bbc0: 206e 6f74 2064 7479 7065 2061 6e64 2064   not dtype and d
-0000bbd0: 696d 2e64 796e 5f73 697a 655f 6578 743a  im.dyn_size_ext:
-0000bbe0: 0a20 2020 2020 2020 2020 2020 2064 7479  .            dty
-0000bbf0: 7065 203d 2064 696d 2e64 796e 5f73 697a  pe = dim.dyn_siz
-0000bc00: 655f 6578 742e 6474 7970 650a 2020 2020  e_ext.dtype.    
-0000bc10: 2020 2020 6966 206e 6f74 2064 7479 7065      if not dtype
-0000bc20: 3a0a 2020 2020 2020 2020 2020 2020 6474  :.            dt
-0000bc30: 7970 6520 3d20 7266 2e67 6574 5f64 6566  ype = rf.get_def
-0000bc40: 6175 6c74 5f61 7272 6179 5f69 6e64 6578  ault_array_index
-0000bc50: 5f64 7479 7065 2829 0a20 2020 2020 2020  _dtype().       
-0000bc60: 206f 7574 203d 2054 656e 736f 7228 0a20   out = Tensor(. 
-0000bc70: 2020 2020 2020 2020 2020 2022 7261 6e67             "rang
-0000bc80: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0000bc90: 6469 6d73 3d5b 6469 6d5d 2c0a 2020 2020  dims=[dim],.    
-0000bca0: 2020 2020 2020 2020 7370 6172 7365 5f64          sparse_d
-0000bcb0: 696d 3d64 696d 2069 6620 6474 7970 652e  im=dim if dtype.
-0000bcc0: 7374 6172 7473 7769 7468 2822 696e 7422  startswith("int"
-0000bcd0: 2920 6f72 2064 7479 7065 2e73 7461 7274  ) or dtype.start
-0000bce0: 7377 6974 6828 2275 696e 7422 2920 656c  swith("uint") el
-0000bcf0: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
-0000bd00: 2020 2020 2064 7479 7065 3d64 7479 7065       dtype=dtype
-0000bd10: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000bd20: 2020 2020 6f75 742e 7261 775f 7465 6e73      out.raw_tens
-0000bd30: 6f72 203d 2074 6f72 6368 2e61 7261 6e67  or = torch.arang
-0000bd40: 6528 0a20 2020 2020 2020 2020 2020 2064  e(.            d
-0000bd50: 696d 2e67 6574 5f64 696d 5f76 616c 7565  im.get_dim_value
-0000bd60: 2829 2c20 6474 7970 653d 546f 7263 6842  (), dtype=TorchB
-0000bd70: 6163 6b65 6e64 2e61 735f 6474 7970 655f  ackend.as_dtype_
-0000bd80: 7261 7728 6f75 742e 6474 7970 6529 2c20  raw(out.dtype), 
-0000bd90: 6465 7669 6365 3d64 6576 6963 6520 6f72  device=device or
-0000bda0: 2072 662e 6765 745f 6465 6661 756c 745f   rf.get_default_
-0000bdb0: 6465 7669 6365 2829 0a20 2020 2020 2020  device().       
-0000bdc0: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-0000bdd0: 6e20 6f75 740a 0a20 2020 2040 7374 6174  n out..    @stat
-0000bde0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-0000bdf0: 2072 6564 7563 6528 0a20 2020 2020 2020   reduce(.       
-0000be00: 2073 6f75 7263 653a 2054 656e 736f 725b   source: Tensor[
-0000be10: 746f 7263 682e 5465 6e73 6f72 5d2c 0a20  torch.Tensor],. 
-0000be20: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-0000be30: 2020 6d6f 6465 3a20 7374 722c 0a20 2020    mode: str,.   
-0000be40: 2020 2020 2061 7869 733a 2055 6e69 6f6e       axis: Union
-0000be50: 5b44 696d 2c20 5365 7175 656e 6365 5b44  [Dim, Sequence[D
-0000be60: 696d 5d5d 2c0a 2020 2020 2020 2020 7573  im]],.        us
-0000be70: 655f 6d61 736b 3a20 626f 6f6c 203d 2054  e_mask: bool = T
-0000be80: 7275 652c 0a20 2020 2029 202d 3e20 5465  rue,.    ) -> Te
-0000be90: 6e73 6f72 5b74 6f72 6368 2e54 656e 736f  nsor[torch.Tenso
-0000bea0: 725d 3a0a 2020 2020 2020 2020 2222 2272  r]:.        """r
-0000beb0: 6564 7563 6522 2222 0a20 2020 2020 2020  educe""".       
-0000bec0: 2061 7373 6572 7420 6d6f 6465 2069 6e20   assert mode in 
-0000bed0: 4261 636b 656e 642e 5f41 6c6c 6f77 6564  Backend._Allowed
-0000bee0: 5265 6475 6365 4d6f 6465 730a 2020 2020  ReduceModes.    
-0000bef0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000bf00: 6528 6178 6973 2c20 4469 6d29 3a0a 2020  e(axis, Dim):.  
-0000bf10: 2020 2020 2020 2020 2020 6178 6973 203d            axis =
-0000bf20: 205b 6178 6973 5d0a 2020 2020 2020 2020   [axis].        
-0000bf30: 6173 7365 7274 2061 6c6c 2869 7369 6e73  assert all(isins
-0000bf40: 7461 6e63 6528 6469 6d2c 2044 696d 2920  tance(dim, Dim) 
-0000bf50: 666f 7220 6469 6d20 696e 2061 7869 7329  for dim in axis)
-0000bf60: 0a20 2020 2020 2020 2072 6177 5f64 696d  .        raw_dim
-0000bf70: 7320 3d20 5b73 6f75 7263 652e 6765 745f  s = [source.get_
-0000bf80: 6178 6973 5f66 726f 6d5f 6465 7363 7269  axis_from_descri
-0000bf90: 7074 696f 6e28 6469 6d29 2066 6f72 2064  ption(dim) for d
-0000bfa0: 696d 2069 6e20 6178 6973 5d0a 2020 2020  im in axis].    
-0000bfb0: 2020 2020 7265 735f 6469 6d73 203d 205b      res_dims = [
-0000bfc0: 6469 6d20 666f 7220 692c 2064 696d 2069  dim for i, dim i
-0000bfd0: 6e20 656e 756d 6572 6174 6528 736f 7572  n enumerate(sour
-0000bfe0: 6365 2e64 696d 7329 2069 6620 6920 6e6f  ce.dims) if i no
-0000bff0: 7420 696e 2072 6177 5f64 696d 735d 0a20  t in raw_dims]. 
-0000c000: 2020 2020 2020 2063 6f72 7265 6374 696f         correctio
-0000c010: 6e5f 6661 6374 6f72 3a20 4f70 7469 6f6e  n_factor: Option
-0000c020: 616c 5b74 6f72 6368 2e54 656e 736f 725d  al[torch.Tensor]
-0000c030: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000c040: 6966 2075 7365 5f6d 6173 6b20 616e 6420  if use_mask and 
-0000c050: 616e 7928 6469 6d2e 6e65 6564 5f6d 6173  any(dim.need_mas
-0000c060: 6b69 6e67 2829 2066 6f72 2064 696d 2069  king() for dim i
-0000c070: 6e20 6178 6973 293a 0a20 2020 2020 2020  n axis):.       
-0000c080: 2020 2020 2073 6f75 7263 6520 3d20 736f       source = so
-0000c090: 7572 6365 2e63 6f70 7928 290a 2020 2020  urce.copy().    
-0000c0a0: 2020 2020 2020 2020 6474 7970 6520 3d20          dtype = 
-0000c0b0: 736f 7572 6365 2e72 6177 5f74 656e 736f  source.raw_tenso
-0000c0c0: 722e 6474 7970 650a 2020 2020 2020 2020  r.dtype.        
-0000c0d0: 2020 2020 6966 206d 6f64 6520 3d3d 2022      if mode == "
-0000c0e0: 6d61 7822 3a0a 2020 2020 2020 2020 2020  max":.          
-0000c0f0: 2020 2020 2020 6d61 736b 5f76 616c 7565        mask_value
-0000c100: 203d 2074 6f72 6368 2e66 696e 666f 2864   = torch.finfo(d
-0000c110: 7479 7065 292e 6d69 6e20 6966 2064 7479  type).min if dty
-0000c120: 7065 2e69 735f 666c 6f61 7469 6e67 5f70  pe.is_floating_p
-0000c130: 6f69 6e74 2065 6c73 6520 746f 7263 682e  oint else torch.
-0000c140: 6969 6e66 6f28 6474 7970 6529 2e6d 696e  iinfo(dtype).min
-0000c150: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0000c160: 6620 6d6f 6465 203d 3d20 226d 696e 223a  f mode == "min":
-0000c170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c180: 206d 6173 6b5f 7661 6c75 6520 3d20 746f   mask_value = to
-0000c190: 7263 682e 6669 6e66 6f28 6474 7970 6529  rch.finfo(dtype)
-0000c1a0: 2e6d 6178 2069 6620 6474 7970 652e 6973  .max if dtype.is
-0000c1b0: 5f66 6c6f 6174 696e 675f 706f 696e 7420  _floating_point 
-0000c1c0: 656c 7365 2074 6f72 6368 2e69 696e 666f  else torch.iinfo
-0000c1d0: 2864 7479 7065 292e 6d61 780a 2020 2020  (dtype).max.    
-0000c1e0: 2020 2020 2020 2020 656c 6966 206d 6f64          elif mod
-0000c1f0: 6520 3d3d 2022 7375 6d22 3a0a 2020 2020  e == "sum":.    
-0000c200: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-0000c210: 5f76 616c 7565 203d 2030 0a20 2020 2020  _value = 0.     
-0000c220: 2020 2020 2020 2065 6c69 6620 6d6f 6465         elif mode
-0000c230: 203d 3d20 226d 6561 6e22 3a0a 2020 2020   == "mean":.    
-0000c240: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-0000c250: 5f76 616c 7565 203d 2030 0a20 2020 2020  _value = 0.     
-0000c260: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-0000c270: 696d 2069 6e20 6178 6973 3a0a 2020 2020  im in axis:.    
-0000c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c290: 6966 2064 696d 2e6e 6565 645f 6d61 736b  if dim.need_mask
-0000c2a0: 696e 6728 293a 0a20 2020 2020 2020 2020  ing():.         
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000c2c0: 6f74 616c 5f6e 756d 5f65 6c20 3d20 6469  otal_num_el = di
-0000c2d0: 6d2e 6765 745f 6469 6d5f 7661 6c75 655f  m.get_dim_value_
-0000c2e0: 7465 6e73 6f72 2829 0a20 2020 2020 2020  tensor().       
-0000c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c300: 2061 6374 7561 6c5f 6e75 6d5f 656c 203d   actual_num_el =
-0000c310: 2064 696d 2e67 6574 5f73 697a 655f 7465   dim.get_size_te
-0000c320: 6e73 6f72 2829 0a20 2020 2020 2020 2020  nsor().         
-0000c330: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000c340: 756d 5f65 6c5f 7265 6475 6365 5f64 696d  um_el_reduce_dim
-0000c350: 7320 3d20 5b64 696d 5f20 666f 7220 6469  s = [dim_ for di
-0000c360: 6d5f 2069 6e20 6178 6973 2069 6620 6469  m_ in axis if di
-0000c370: 6d5f 2069 6e20 6163 7475 616c 5f6e 756d  m_ in actual_num
-0000c380: 5f65 6c2e 6469 6d73 5d0a 2020 2020 2020  _el.dims].      
-0000c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3a0: 2020 6966 206e 756d 5f65 6c5f 7265 6475    if num_el_redu
-0000c3b0: 6365 5f64 696d 733a 0a20 2020 2020 2020  ce_dims:.       
-0000c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3d0: 2020 2020 2061 6374 7561 6c5f 6e75 6d5f       actual_num_
-0000c3e0: 656c 203d 2072 662e 7265 6475 6365 5f73  el = rf.reduce_s
-0000c3f0: 756d 2861 6374 7561 6c5f 6e75 6d5f 656c  um(actual_num_el
-0000c400: 2c20 6178 6973 3d6e 756d 5f65 6c5f 7265  , axis=num_el_re
-0000c410: 6475 6365 5f64 696d 7329 0a20 2020 2020  duce_dims).     
-0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c430: 2020 2020 2020 2066 6f72 2064 696d 5f20         for dim_ 
-0000c440: 696e 206e 756d 5f65 6c5f 7265 6475 6365  in num_el_reduce
-0000c450: 5f64 696d 733a 0a20 2020 2020 2020 2020  _dims:.         
-0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c470: 2020 2020 2020 2074 6f74 616c 5f6e 756d         total_num
-0000c480: 5f65 6c20 2a3d 2064 696d 5f2e 6765 745f  _el *= dim_.get_
-0000c490: 6469 6d5f 7661 6c75 655f 7465 6e73 6f72  dim_value_tensor
-0000c4a0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0000c4b0: 2020 2020 2020 2020 2020 2063 6f72 7265             corre
-0000c4c0: 6374 696f 6e5f 6661 6374 6f72 5f20 3d20  ction_factor_ = 
-0000c4d0: 7266 2e63 6173 7428 746f 7461 6c5f 6e75  rf.cast(total_nu
-0000c4e0: 6d5f 656c 2c20 736f 7572 6365 2e64 7479  m_el, source.dty
-0000c4f0: 7065 2920 2f20 7266 2e63 6173 7428 6163  pe) / rf.cast(ac
-0000c500: 7475 616c 5f6e 756d 5f65 6c2c 2073 6f75  tual_num_el, sou
-0000c510: 7263 652e 6474 7970 6529 0a20 2020 2020  rce.dtype).     
-0000c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c530: 2020 2063 6f72 7265 6374 696f 6e5f 6661     correction_fa
-0000c540: 6374 6f72 5f5f 203d 2063 6f72 7265 6374  ctor__ = correct
-0000c550: 696f 6e5f 6661 6374 6f72 5f2e 636f 7079  ion_factor_.copy
-0000c560: 5f63 6f6d 7061 7469 626c 655f 746f 5f64  _compatible_to_d
-0000c570: 696d 735f 7261 7728 7265 735f 6469 6d73  ims_raw(res_dims
-0000c580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c590: 2020 2020 2020 2020 2020 6966 2063 6f72            if cor
-0000c5a0: 7265 6374 696f 6e5f 6661 6374 6f72 2069  rection_factor i
-0000c5b0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5d0: 2020 2020 636f 7272 6563 7469 6f6e 5f66      correction_f
-0000c5e0: 6163 746f 7220 3d20 636f 7272 6563 7469  actor = correcti
-0000c5f0: 6f6e 5f66 6163 746f 725f 5f0a 2020 2020  on_factor__.    
-0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c610: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c630: 2020 2020 2020 636f 7272 6563 7469 6f6e        correction
-0000c640: 5f66 6163 746f 7220 2a3d 2063 6f72 7265  _factor *= corre
-0000c650: 6374 696f 6e5f 6661 6374 6f72 5f5f 0a20  ction_factor__. 
-0000c660: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000c670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c680: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-0000c690: 656e 7465 6445 7272 6f72 2866 2272 6564  entedError(f"red
-0000c6a0: 7563 655f 7b6d 6f64 657d 206e 6f74 2069  uce_{mode} not i
-0000c6b0: 6d70 6c65 6d65 6e74 6564 2077 6974 6820  mplemented with 
-0000c6c0: 6d61 736b 696e 6720 6f6e 2074 656e 736f  masking on tenso
-0000c6d0: 7220 7b73 6f75 7263 6521 727d 2e22 290a  r {source!r}.").
-0000c6e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c6f0: 6469 6d20 696e 2061 7869 733a 0a20 2020  dim in axis:.   
-0000c700: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000c710: 6469 6d2e 6e65 6564 5f6d 6173 6b69 6e67  dim.need_masking
-0000c720: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000c730: 2020 2020 2020 2020 6d61 736b 203d 2073          mask = s
-0000c740: 6f75 7263 652e 6765 745f 7365 7175 656e  ource.get_sequen
-0000c750: 6365 5f6d 6173 6b5f 6272 6f61 6463 6173  ce_mask_broadcas
-0000c760: 7428 6469 6d29 0a20 2020 2020 2020 2020  t(dim).         
-0000c770: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0000c780: 652e 7261 775f 7465 6e73 6f72 203d 2074  e.raw_tensor = t
-0000c790: 6f72 6368 2e77 6865 7265 286d 6173 6b2c  orch.where(mask,
-0000c7a0: 2073 6f75 7263 652e 7261 775f 7465 6e73   source.raw_tens
-0000c7b0: 6f72 2c20 6d61 736b 5f76 616c 7565 290a  or, mask_value).
-0000c7c0: 2020 2020 2020 2020 6675 6e63 203d 2067          func = g
-0000c7d0: 6574 6174 7472 2874 6f72 6368 2c20 6d6f  etattr(torch, mo
-0000c7e0: 6465 290a 2020 2020 2020 2020 6966 206e  de).        if n
-0000c7f0: 6f74 2072 6573 5f64 696d 733a 0a20 2020  ot res_dims:.   
-0000c800: 2020 2020 2020 2020 2072 6177 5f72 6573           raw_res
-0000c810: 756c 7420 3d20 6675 6e63 2873 6f75 7263  ult = func(sourc
-0000c820: 652e 7261 775f 7465 6e73 6f72 290a 2020  e.raw_tensor).  
-0000c830: 2020 2020 2020 656c 6966 206c 656e 2872        elif len(r
-0000c840: 6177 5f64 696d 7329 203d 3d20 313a 0a20  aw_dims) == 1:. 
-0000c850: 2020 2020 2020 2020 2020 2072 6177 5f72             raw_r
-0000c860: 6573 756c 7420 3d20 6675 6e63 2873 6f75  esult = func(sou
-0000c870: 7263 652e 7261 775f 7465 6e73 6f72 2c20  rce.raw_tensor, 
-0000c880: 6469 6d3d 7261 775f 6469 6d73 5b30 5d29  dim=raw_dims[0])
-0000c890: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c8a0: 6d6f 6465 2069 6e20 5b22 6d61 7822 2c20  mode in ["max", 
-0000c8b0: 226d 696e 225d 3a0a 2020 2020 2020 2020  "min"]:.        
-0000c8c0: 2020 2020 2020 2020 2320 7265 7375 6c74          # result
-0000c8d0: 2069 7320 6120 7475 706c 6520 2876 616c   is a tuple (val
-0000c8e0: 7565 732c 2069 6e64 6963 6573 292e 2068  ues, indices). h
-0000c8f0: 7474 7073 3a2f 2f70 7974 6f72 6368 2e6f  ttps://pytorch.o
-0000c900: 7267 2f64 6f63 732f 7374 6162 6c65 2f67  rg/docs/stable/g
-0000c910: 656e 6572 6174 6564 2f74 6f72 6368 2e6d  enerated/torch.m
-0000c920: 6178 2e68 746d 6c0a 2020 2020 2020 2020  ax.html.        
-0000c930: 2020 2020 2020 2020 7261 775f 7265 7375          raw_resu
-0000c940: 6c74 2c20 5f20 3d20 7261 775f 7265 7375  lt, _ = raw_resu
-0000c950: 6c74 0a20 2020 2020 2020 2065 6c73 653a  lt.        else:
-0000c960: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
-0000c970: 5f72 6573 756c 7420 3d20 6675 6e63 2873  _result = func(s
-0000c980: 6f75 7263 652e 7261 775f 7465 6e73 6f72  ource.raw_tensor
-0000c990: 2c20 6469 6d3d 7261 775f 6469 6d73 290a  , dim=raw_dims).
-0000c9a0: 2020 2020 2020 2020 6966 2063 6f72 7265          if corre
-0000c9b0: 6374 696f 6e5f 6661 6374 6f72 2069 7320  ction_factor is 
-0000c9c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000c9d0: 2020 2020 2020 7261 775f 7265 7375 6c74        raw_result
-0000c9e0: 202a 3d20 636f 7272 6563 7469 6f6e 5f66   *= correction_f
-0000c9f0: 6163 746f 722e 746f 2872 6177 5f72 6573  actor.to(raw_res
-0000ca00: 756c 742e 6465 7669 6365 290a 2020 2020  ult.device).    
-0000ca10: 2020 2020 7265 7320 3d20 5465 6e73 6f72      res = Tensor
-0000ca20: 280a 2020 2020 2020 2020 2020 2020 6e61  (.            na
-0000ca30: 6d65 3d66 2272 6564 7563 655f 7b6d 6f64  me=f"reduce_{mod
-0000ca40: 657d 222c 0a20 2020 2020 2020 2020 2020  e}",.           
-0000ca50: 2072 6177 5f74 656e 736f 723d 7261 775f   raw_tensor=raw_
-0000ca60: 7265 7375 6c74 2c0a 2020 2020 2020 2020  result,.        
-0000ca70: 2020 2020 6469 6d73 3d72 6573 5f64 696d      dims=res_dim
-0000ca80: 732c 0a20 2020 2020 2020 2020 2020 2064  s,.            d
-0000ca90: 7479 7065 3d54 6f72 6368 4261 636b 656e  type=TorchBacken
-0000caa0: 642e 6765 745f 6474 7970 655f 6e61 6d65  d.get_dtype_name
-0000cab0: 5f72 6177 2872 6177 5f72 6573 756c 7429  _raw(raw_result)
-0000cac0: 2c0a 2020 2020 2020 2020 2020 2020 7370  ,.            sp
-0000cad0: 6172 7365 5f64 696d 3d61 7869 735b 305d  arse_dim=axis[0]
-0000cae0: 2069 6620 6d6f 6465 2e73 7461 7274 7377   if mode.startsw
-0000caf0: 6974 6828 2261 7267 2229 2065 6c73 6520  ith("arg") else 
-0000cb00: 736f 7572 6365 2e73 7061 7273 655f 6469  source.sparse_di
-0000cb10: 6d2c 0a20 2020 2020 2020 2029 0a20 2020  m,.        ).   
-0000cb20: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
-0000cb30: 0a20 2020 2023 206e 6f69 6e73 7065 6374  .    # noinspect
-0000cb40: 696f 6e20 5079 5368 6164 6f77 696e 6742  ion PyShadowingB
-0000cb50: 7569 6c74 696e 730a 2020 2020 4073 7461  uiltins.    @sta
-0000cb60: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-0000cb70: 6620 746f 705f 6b28 0a20 2020 2020 2020  f top_k(.       
-0000cb80: 2073 6f75 7263 653a 2054 656e 736f 725b   source: Tensor[
-0000cb90: 746f 7263 682e 5465 6e73 6f72 5d2c 0a20  torch.Tensor],. 
-0000cba0: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-0000cbb0: 2020 6178 6973 3a20 556e 696f 6e5b 4469    axis: Union[Di
-0000cbc0: 6d2c 2053 6571 7565 6e63 655b 4469 6d5d  m, Sequence[Dim]
-0000cbd0: 5d2c 0a20 2020 2020 2020 206b 3a20 556e  ],.        k: Un
-0000cbe0: 696f 6e5b 696e 742c 2054 656e 736f 725d  ion[int, Tensor]
-0000cbf0: 2c0a 2020 2020 2020 2020 6b5f 6469 6d3a  ,.        k_dim:
-0000cc00: 204f 7074 696f 6e61 6c5b 4469 6d5d 203d   Optional[Dim] =
-0000cc10: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-0000cc20: 6f72 7465 643a 2062 6f6f 6c20 3d20 5472  orted: bool = Tr
-0000cc30: 7565 2c0a 2020 2020 2920 2d3e 2054 7570  ue,.    ) -> Tup
-0000cc40: 6c65 5b54 656e 736f 722c 2055 6e69 6f6e  le[Tensor, Union
-0000cc50: 5b54 656e 736f 722c 2053 6571 7565 6e63  [Tensor, Sequenc
-0000cc60: 655b 5465 6e73 6f72 5d5d 2c20 4469 6d5d  e[Tensor]], Dim]
-0000cc70: 3a0a 2020 2020 2020 2020 2222 2274 6f70  :.        """top
-0000cc80: 5f6b 2222 220a 2020 2020 2020 2020 6966  _k""".        if
-0000cc90: 206e 6f74 206b 5f64 696d 3a0a 2020 2020   not k_dim:.    
-0000cca0: 2020 2020 2020 2020 6b5f 6469 6d20 3d20          k_dim = 
-0000ccb0: 4469 6d28 6b2c 206e 616d 653d 2274 6f70  Dim(k, name="top
-0000ccc0: 2d6b 2d64 696d 2229 0a20 2020 2020 2020  -k-dim").       
-0000ccd0: 2061 7865 7320 3d20 5b61 7869 735d 2069   axes = [axis] i
-0000cce0: 6620 6973 696e 7374 616e 6365 2861 7869  f isinstance(axi
-0000ccf0: 732c 2044 696d 2920 656c 7365 2061 7869  s, Dim) else axi
-0000cd00: 730a 2020 2020 2020 2020 6966 2061 6e79  s.        if any
-0000cd10: 2861 2e6e 6565 645f 6d61 736b 696e 6728  (a.need_masking(
-0000cd20: 2920 666f 7220 6120 696e 2061 7865 7329  ) for a in axes)
-0000cd30: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
-0000cd40: 736b 5f76 616c 7565 203d 2028 0a20 2020  sk_value = (.   
-0000cd50: 2020 2020 2020 2020 2020 2020 2074 6f72               tor
-0000cd60: 6368 2e66 696e 666f 2873 6f75 7263 652e  ch.finfo(source.
-0000cd70: 7261 775f 7465 6e73 6f72 2e64 7479 7065  raw_tensor.dtype
-0000cd80: 292e 6d69 6e0a 2020 2020 2020 2020 2020  ).min.          
-0000cd90: 2020 2020 2020 6966 2073 6f75 7263 652e        if source.
-0000cda0: 7261 775f 7465 6e73 6f72 2e64 7479 7065  raw_tensor.dtype
-0000cdb0: 2e69 735f 666c 6f61 7469 6e67 5f70 6f69  .is_floating_poi
-0000cdc0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
-0000cdd0: 2020 2065 6c73 6520 746f 7263 682e 6969     else torch.ii
-0000cde0: 6e66 6f28 736f 7572 6365 2e72 6177 5f74  nfo(source.raw_t
-0000cdf0: 656e 736f 722e 6474 7970 6529 2e6d 696e  ensor.dtype).min
-0000ce00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000ce10: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0000ce20: 6520 3d20 736f 7572 6365 2e63 6f70 7928  e = source.copy(
-0000ce30: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-0000ce40: 7220 6120 696e 2061 7865 733a 0a20 2020  r a in axes:.   
-0000ce50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000ce60: 612e 6e65 6564 5f6d 6173 6b69 6e67 2829  a.need_masking()
-0000ce70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ce80: 2020 2020 2020 736f 7572 6365 203d 2072        source = r
-0000ce90: 662e 7768 6572 6528 0a20 2020 2020 2020  f.where(.       
-0000cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ceb0: 2061 2e67 6574 5f6d 6173 6b28 6469 6d5f   a.get_mask(dim_
-0000cec0: 6f72 6465 723d 736f 7572 6365 2e64 696d  order=source.dim
-0000ced0: 732c 2064 6576 6963 653d 736f 7572 6365  s, device=source
-0000cee0: 2e64 6576 6963 6529 2c0a 2020 2020 2020  .device),.      
-0000cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf00: 2020 736f 7572 6365 2c0a 2020 2020 2020    source,.      
-0000cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf20: 2020 6d61 736b 5f76 616c 7565 2c0a 2020    mask_value,.  
-0000cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf40: 2020 290a 2020 2020 2020 2020 6966 2069    ).        if i
-0000cf50: 7369 6e73 7461 6e63 6528 6178 6973 2c20  sinstance(axis, 
-0000cf60: 286c 6973 742c 2074 7570 6c65 2929 3a0a  (list, tuple)):.
-0000cf70: 2020 2020 2020 2020 2020 2020 2320 4d6f              # Mo
-0000cf80: 7665 2061 7869 7320 746f 2074 6865 2065  ve axis to the e
-0000cf90: 6e64 2c20 696e 2074 6865 2072 6967 6874  nd, in the right
-0000cfa0: 206f 7264 6572 2e0a 2020 2020 2020 2020   order..        
-0000cfb0: 2020 2020 736f 7572 6365 203d 2073 6f75      source = sou
-0000cfc0: 7263 652e 636f 7079 5f74 7261 6e73 706f  rce.copy_transpo
-0000cfd0: 7365 285b 6420 666f 7220 6420 696e 2073  se([d for d in s
-0000cfe0: 6f75 7263 652e 6469 6d73 2069 6620 6420  ource.dims if d 
-0000cff0: 6e6f 7420 696e 2061 7869 735d 202b 206c  not in axis] + l
-0000d000: 6973 7428 6178 6973 2929 0a20 2020 2020  ist(axis)).     
-0000d010: 2020 2020 2020 2073 6f75 7263 655f 7261         source_ra
-0000d020: 775f 666c 6174 203d 2073 6f75 7263 652e  w_flat = source.
-0000d030: 7261 775f 7465 6e73 6f72 2e66 6c61 7474  raw_tensor.flatt
-0000d040: 656e 2873 7461 7274 5f64 696d 3d73 6f75  en(start_dim=sou
-0000d050: 7263 652e 6261 7463 685f 6e64 696d 202d  rce.batch_ndim -
-0000d060: 206c 656e 2861 7869 7329 290a 2020 2020   len(axis)).    
-0000d070: 2020 2020 2020 2020 7661 6c75 6573 5f72          values_r
-0000d080: 6177 2c20 696e 6469 6365 735f 7261 7720  aw, indices_raw 
-0000d090: 3d20 746f 7263 682e 746f 706b 280a 2020  = torch.topk(.  
-0000d0a0: 2020 2020 2020 2020 2020 2020 2020 736f                so
-0000d0b0: 7572 6365 5f72 6177 5f66 6c61 742c 206b  urce_raw_flat, k
-0000d0c0: 3d6b 5f64 696d 2e67 6574 5f64 696d 5f76  =k_dim.get_dim_v
-0000d0d0: 616c 7565 2829 2c20 6469 6d3d 2d31 2c20  alue(), dim=-1, 
-0000d0e0: 6c61 7267 6573 743d 5472 7565 2c20 736f  largest=True, so
-0000d0f0: 7274 6564 3d73 6f72 7465 640a 2020 2020  rted=sorted.    
-0000d100: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000d110: 2020 2020 2020 7661 6c75 6573 203d 2073        values = s
-0000d120: 6f75 7263 652e 636f 7079 5f74 656d 706c  ource.copy_templ
-0000d130: 6174 655f 6e65 775f 6469 6d5f 7461 6773  ate_new_dim_tags
-0000d140: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d150: 2020 6e65 775f 6469 6d5f 7461 6773 3d73    new_dim_tags=s
-0000d160: 6f75 7263 652e 6469 6d73 5b3a 202d 6c65  ource.dims[: -le
-0000d170: 6e28 6178 6973 295d 202b 2028 6b5f 6469  n(axis)] + (k_di
-0000d180: 6d2c 292c 206e 616d 653d 2274 6f70 5f6b  m,), name="top_k
-0000d190: 5f76 616c 7565 7322 0a20 2020 2020 2020  _values".       
-0000d1a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000d1b0: 2020 2069 6620 736f 7572 6365 2e66 6561     if source.fea
-0000d1c0: 7475 7265 5f64 696d 2061 6e64 2073 6f75  ture_dim and sou
-0000d1d0: 7263 652e 6665 6174 7572 655f 6469 6d20  rce.feature_dim 
-0000d1e0: 696e 2076 616c 7565 732e 6469 6d73 3a0a  in values.dims:.
-0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d200: 7661 6c75 6573 2e66 6561 7475 7265 5f64  values.feature_d
-0000d210: 696d 203d 2073 6f75 7263 652e 6665 6174  im = source.feat
-0000d220: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
-0000d230: 2020 2020 7661 6c75 6573 2e72 6177 5f74      values.raw_t
-0000d240: 656e 736f 7220 3d20 7661 6c75 6573 5f72  ensor = values_r
-0000d250: 6177 0a20 2020 2020 2020 2020 2020 2069  aw.            i
-0000d260: 6e64 6963 6573 5f6f 7574 203d 205b 5d0a  ndices_out = [].
-0000d270: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000d280: 692c 2061 2069 6e20 7265 7665 7273 6564  i, a in reversed
-0000d290: 286c 6973 7428 656e 756d 6572 6174 6528  (list(enumerate(
-0000d2a0: 6178 6973 2929 293a 0a20 2020 2020 2020  axis))):.       
-0000d2b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000d2c0: 6973 696e 7374 616e 6365 2861 2c20 4469  isinstance(a, Di
-0000d2d0: 6d29 0a20 2020 2020 2020 2020 2020 2020  m).             
-0000d2e0: 2020 2069 6e64 6963 6573 5f6f 7574 5f72     indices_out_r
-0000d2f0: 6177 203d 2069 6e64 6963 6573 5f72 6177  aw = indices_raw
-0000d300: 2025 2061 2e64 696d 656e 7369 6f6e 0a20   % a.dimension. 
-0000d310: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000d320: 6e64 6963 6573 5f72 6177 203d 2069 6e64  ndices_raw = ind
-0000d330: 6963 6573 5f72 6177 202f 2f20 612e 6469  ices_raw // a.di
-0000d340: 6d65 6e73 696f 6e0a 2020 2020 2020 2020  mension.        
-0000d350: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
-0000d360: 3d20 7661 6c75 6573 2e63 6f70 795f 7465  = values.copy_te
-0000d370: 6d70 6c61 7465 286e 616d 653d 6622 746f  mplate(name=f"to
-0000d380: 705f 6b5f 696e 6469 6365 735f 7b61 2e6e  p_k_indices_{a.n
-0000d390: 616d 6520 6f72 2069 7d22 290a 2020 2020  ame or i}").    
-0000d3a0: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-0000d3b0: 6365 732e 6474 7970 6520 3d20 546f 7263  ces.dtype = Torc
-0000d3c0: 6842 6163 6b65 6e64 2e67 6574 5f64 7479  hBackend.get_dty
-0000d3d0: 7065 5f6e 616d 655f 7261 7728 696e 6469  pe_name_raw(indi
-0000d3e0: 6365 735f 6f75 745f 7261 7729 0a20 2020  ces_out_raw).   
-0000d3f0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-0000d400: 6963 6573 2e73 7061 7273 655f 6469 6d20  ices.sparse_dim 
-0000d410: 3d20 610a 2020 2020 2020 2020 2020 2020  = a.            
-0000d420: 2020 2020 696e 6469 6365 732e 7261 775f      indices.raw_
-0000d430: 7465 6e73 6f72 203d 2069 6e64 6963 6573  tensor = indices
-0000d440: 5f6f 7574 5f72 6177 0a20 2020 2020 2020  _out_raw.       
-0000d450: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-0000d460: 5f6f 7574 2e69 6e73 6572 7428 302c 2069  _out.insert(0, i
-0000d470: 6e64 6963 6573 290a 2020 2020 2020 2020  ndices).        
-0000d480: 2020 2020 7265 7475 726e 2076 616c 7565      return value
-0000d490: 732c 2069 6e64 6963 6573 5f6f 7574 2c20  s, indices_out, 
-0000d4a0: 6b5f 6469 6d0a 2020 2020 2020 2020 6173  k_dim.        as
-0000d4b0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0000d4c0: 6178 6973 2c20 4469 6d29 0a20 2020 2020  axis, Dim).     
-0000d4d0: 2020 2061 7869 735f 696e 7420 3d20 736f     axis_int = so
-0000d4e0: 7572 6365 2e67 6574 5f61 7869 735f 6672  urce.get_axis_fr
-0000d4f0: 6f6d 5f64 6573 6372 6970 7469 6f6e 2861  om_description(a
-0000d500: 7869 732c 2061 6c6c 6f77 5f69 6e74 3d46  xis, allow_int=F
-0000d510: 616c 7365 290a 2020 2020 2020 2020 7661  alse).        va
-0000d520: 6c75 6573 5f72 6177 2c20 696e 6469 6365  lues_raw, indice
-0000d530: 735f 7261 7720 3d20 746f 7263 682e 746f  s_raw = torch.to
-0000d540: 706b 280a 2020 2020 2020 2020 2020 2020  pk(.            
-0000d550: 736f 7572 6365 2e72 6177 5f74 656e 736f  source.raw_tenso
-0000d560: 722c 206b 3d6b 5f64 696d 2e67 6574 5f64  r, k=k_dim.get_d
-0000d570: 696d 5f76 616c 7565 2829 2c20 6469 6d3d  im_value(), dim=
-0000d580: 6178 6973 5f69 6e74 2c20 6c61 7267 6573  axis_int, larges
-0000d590: 743d 5472 7565 2c20 736f 7274 6564 3d73  t=True, sorted=s
-0000d5a0: 6f72 7465 640a 2020 2020 2020 2020 290a  orted.        ).
-0000d5b0: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
-0000d5c0: 2073 6f75 7263 652e 636f 7079 5f74 656d   source.copy_tem
-0000d5d0: 706c 6174 655f 7265 706c 6163 655f 6469  plate_replace_di
-0000d5e0: 6d5f 7461 6728 6178 6973 3d61 7869 735f  m_tag(axis=axis_
-0000d5f0: 696e 742c 206e 6577 5f64 696d 5f74 6167  int, new_dim_tag
-0000d600: 3d6b 5f64 696d 2c20 6e61 6d65 3d22 746f  =k_dim, name="to
-0000d610: 705f 6b5f 7661 6c75 6573 2229 0a20 2020  p_k_values").   
-0000d620: 2020 2020 2076 616c 7565 732e 7261 775f       values.raw_
-0000d630: 7465 6e73 6f72 203d 2076 616c 7565 735f  tensor = values_
-0000d640: 7261 770a 2020 2020 2020 2020 696e 6469  raw.        indi
-0000d650: 6365 7320 3d20 736f 7572 6365 2e63 6f70  ces = source.cop
-0000d660: 795f 7465 6d70 6c61 7465 5f72 6570 6c61  y_template_repla
-0000d670: 6365 5f64 696d 5f74 6167 2861 7869 733d  ce_dim_tag(axis=
-0000d680: 6178 6973 5f69 6e74 2c20 6e65 775f 6469  axis_int, new_di
-0000d690: 6d5f 7461 673d 6b5f 6469 6d2c 206e 616d  m_tag=k_dim, nam
-0000d6a0: 653d 2274 6f70 5f6b 5f69 6e64 6963 6573  e="top_k_indices
-0000d6b0: 2229 0a20 2020 2020 2020 2069 6e64 6963  ").        indic
-0000d6c0: 6573 2e64 7479 7065 203d 2054 6f72 6368  es.dtype = Torch
-0000d6d0: 4261 636b 656e 642e 6765 745f 6474 7970  Backend.get_dtyp
-0000d6e0: 655f 6e61 6d65 5f72 6177 2869 6e64 6963  e_name_raw(indic
-0000d6f0: 6573 5f72 6177 290a 2020 2020 2020 2020  es_raw).        
-0000d700: 696e 6469 6365 732e 7370 6172 7365 5f64  indices.sparse_d
-0000d710: 696d 203d 2061 7869 730a 2020 2020 2020  im = axis.      
-0000d720: 2020 696e 6469 6365 732e 7261 775f 7465    indices.raw_te
-0000d730: 6e73 6f72 203d 2069 6e64 6963 6573 5f72  nsor = indices_r
-0000d740: 6177 0a20 2020 2020 2020 2072 6574 7572  aw.        retur
-0000d750: 6e20 7661 6c75 6573 2c20 696e 6469 6365  n values, indice
-0000d760: 732c 206b 5f64 696d 0a0a 2020 2020 4073  s, k_dim..    @s
-0000d770: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-0000d780: 4063 6f6e 7465 7874 6c69 622e 636f 6e74  @contextlib.cont
-0000d790: 6578 746d 616e 6167 6572 0a20 2020 2064  extmanager.    d
-0000d7a0: 6566 2072 616e 646f 6d5f 6a6f 7572 6e61  ef random_journa
-0000d7b0: 6c5f 7265 636f 7264 2829 202d 3e20 4765  l_record() -> Ge
-0000d7c0: 6e65 7261 746f 725b 5f72 616e 646f 6d5f  nerator[_random_
-0000d7d0: 6a6f 7572 6e61 6c2e 5261 6e64 6f6d 4a6f  journal.RandomJo
-0000d7e0: 7572 6e61 6c5d 3a0a 2020 2020 2020 2020  urnal]:.        
-0000d7f0: 2222 220a 2020 2020 2020 2020 3a72 6574  """.        :ret
-0000d800: 7572 6e3a 2074 6865 206a 6f75 726e 616c  urn: the journal
-0000d810: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000d820: 2020 2020 2070 7265 765f 6a6f 7572 6e61       prev_journa
-0000d830: 6c20 3d20 546f 7263 6842 6163 6b65 6e64  l = TorchBackend
-0000d840: 2e5f 7261 6e64 6f6d 5f6a 6f75 726e 616c  ._random_journal
-0000d850: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000d860: 2020 2020 2020 2020 2020 546f 7263 6842            TorchB
-0000d870: 6163 6b65 6e64 2e5f 7261 6e64 6f6d 5f6a  ackend._random_j
-0000d880: 6f75 726e 616c 203d 205f 7261 6e64 6f6d  ournal = _random
-0000d890: 5f6a 6f75 726e 616c 2e52 616e 646f 6d4a  _journal.RandomJ
-0000d8a0: 6f75 726e 616c 2829 0a20 2020 2020 2020  ournal().       
-0000d8b0: 2020 2020 2079 6965 6c64 2054 6f72 6368       yield Torch
-0000d8c0: 4261 636b 656e 642e 5f72 616e 646f 6d5f  Backend._random_
-0000d8d0: 6a6f 7572 6e61 6c0a 2020 2020 2020 2020  journal.        
-0000d8e0: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
-0000d8f0: 2020 2020 2054 6f72 6368 4261 636b 656e       TorchBacken
-0000d900: 642e 5f72 616e 646f 6d5f 6a6f 7572 6e61  d._random_journa
-0000d910: 6c20 3d20 7072 6576 5f6a 6f75 726e 616c  l = prev_journal
-0000d920: 0a0a 2020 2020 5f72 616e 646f 6d5f 6a6f  ..    _random_jo
-0000d930: 7572 6e61 6c20 3d20 4e6f 6e65 2020 2320  urnal = None  # 
-0000d940: 7479 7065 3a20 4f70 7469 6f6e 616c 5b5f  type: Optional[_
-0000d950: 7261 6e64 6f6d 5f6a 6f75 726e 616c 2e52  random_journal.R
-0000d960: 616e 646f 6d4a 6f75 726e 616c 5d0a 0a20  andomJournal].. 
-0000d970: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-0000d980: 0a20 2020 2064 6566 2072 616e 646f 6d28  .    def random(
-0000d990: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-0000d9a0: 2020 2020 6469 6d73 3a20 5365 7175 656e      dims: Sequen
-0000d9b0: 6365 5b44 696d 5d2c 0a20 2020 2020 2020  ce[Dim],.       
-0000d9c0: 2064 7479 7065 3a20 7374 722c 0a20 2020   dtype: str,.   
-0000d9d0: 2020 2020 2064 6576 6963 653a 204f 7074       device: Opt
-0000d9e0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-0000d9f0: 652c 0a20 2020 2020 2020 2073 7061 7273  e,.        spars
-0000da00: 655f 6469 6d3a 204f 7074 696f 6e61 6c5b  e_dim: Optional[
-0000da10: 4469 6d5d 203d 204e 6f6e 652c 0a20 2020  Dim] = None,.   
-0000da20: 2020 2020 2066 6561 7475 7265 5f64 696d       feature_dim
-0000da30: 3a20 4f70 7469 6f6e 616c 5b44 696d 5d20  : Optional[Dim] 
-0000da40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0000da50: 6469 7374 7269 6275 7469 6f6e 3a20 7374  distribution: st
-0000da60: 722c 0a20 2020 2020 2020 206d 6561 6e3a  r,.        mean:
-0000da70: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
-0000da80: 696e 742c 2066 6c6f 6174 2c20 5465 6e73  int, float, Tens
-0000da90: 6f72 5d5d 203d 204e 6f6e 652c 0a20 2020  or]] = None,.   
-0000daa0: 2020 2020 2073 7464 6465 763a 204f 7074       stddev: Opt
-0000dab0: 696f 6e61 6c5b 556e 696f 6e5b 696e 742c  ional[Union[int,
-0000dac0: 2066 6c6f 6174 2c20 5465 6e73 6f72 5d5d   float, Tensor]]
-0000dad0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0000dae0: 2062 6f75 6e64 3a20 4f70 7469 6f6e 616c   bound: Optional
-0000daf0: 5b55 6e69 6f6e 5b69 6e74 2c20 666c 6f61  [Union[int, floa
-0000db00: 742c 2054 656e 736f 725d 5d20 3d20 4e6f  t, Tensor]] = No
-0000db10: 6e65 2c0a 2020 2020 2020 2020 6d69 6e76  ne,.        minv
-0000db20: 616c 3a20 4f70 7469 6f6e 616c 5b55 6e69  al: Optional[Uni
-0000db30: 6f6e 5b69 6e74 2c20 666c 6f61 742c 2054  on[int, float, T
-0000db40: 656e 736f 725d 5d20 3d20 4e6f 6e65 2c0a  ensor]] = None,.
-0000db50: 2020 2020 2020 2020 6d61 7876 616c 3a20          maxval: 
-0000db60: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b69  Optional[Union[i
-0000db70: 6e74 2c20 666c 6f61 742c 2054 656e 736f  nt, float, Tenso
-0000db80: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
-0000db90: 2020 2020 7365 6564 3a20 4f70 7469 6f6e      seed: Option
-0000dba0: 616c 5b55 6e69 6f6e 5b69 6e74 2c20 5365  al[Union[int, Se
-0000dbb0: 7175 656e 6365 5b69 6e74 5d2c 206e 756d  quence[int], num
-0000dbc0: 7079 2e6e 6461 7272 6179 5d5d 203d 204e  py.ndarray]] = N
-0000dbd0: 6f6e 652c 0a20 2020 2020 2020 2061 6c67  one,.        alg
-0000dbe0: 6f72 6974 686d 3a20 4f70 7469 6f6e 616c  orithm: Optional
-0000dbf0: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-0000dc00: 2020 2020 2020 6578 706c 6963 6974 5f73        explicit_s
-0000dc10: 7461 7465 3a20 4f70 7469 6f6e 616c 5b54  tate: Optional[T
-0000dc20: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
-0000dc30: 2020 2020 2020 2061 7574 6f5f 7570 6461         auto_upda
-0000dc40: 7465 5f73 7461 7465 3a20 4f70 7469 6f6e  te_state: Option
-0000dc50: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
-0000dc60: 0a20 2020 2020 2020 2073 7461 7469 633a  .        static:
-0000dc70: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-0000dc80: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0000dc90: 6f75 743a 204f 7074 696f 6e61 6c5b 5465  out: Optional[Te
-0000dca0: 6e73 6f72 5b74 6f72 6368 2e54 656e 736f  nsor[torch.Tenso
-0000dcb0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
-0000dcc0: 2920 2d3e 2054 656e 736f 723a 0a20 2020  ) -> Tensor:.   
-0000dcd0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000dce0: 2072 616e 646f 6d2e 2053 6565 2060 7266   random. See `rf
-0000dcf0: 2e72 616e 646f 6d60 2066 6f72 2064 6574  .random` for det
-0000dd00: 6169 6c73 2e0a 2020 2020 2020 2020 2222  ails..        ""
-0000dd10: 220a 2020 2020 2020 2020 7368 6170 6520  ".        shape 
-0000dd20: 3d20 5b64 2e67 6574 5f64 696d 5f76 616c  = [d.get_dim_val
-0000dd30: 7565 2829 2066 6f72 2064 2069 6e20 6469  ue() for d in di
-0000dd40: 6d73 5d0a 2020 2020 2020 2020 6474 7970  ms].        dtyp
-0000dd50: 655f 203d 2054 6f72 6368 4261 636b 656e  e_ = TorchBacken
-0000dd60: 642e 6173 5f64 7479 7065 5f72 6177 2864  d.as_dtype_raw(d
-0000dd70: 7479 7065 290a 2020 2020 2020 2020 6966  type).        if
-0000dd80: 206f 7574 2069 7320 4e6f 6e65 3a0a 2020   out is None:.  
-0000dd90: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-0000dda0: 5465 6e73 6f72 280a 2020 2020 2020 2020  Tensor(.        
-0000ddb0: 2020 2020 2020 2020 6e61 6d65 3d66 2272          name=f"r
-0000ddc0: 616e 646f 6d5f 7b64 6973 7472 6962 7574  andom_{distribut
-0000ddd0: 696f 6e7d 222c 2064 696d 733d 6469 6d73  ion}", dims=dims
-0000dde0: 2c20 6474 7970 653d 6474 7970 652c 2073  , dtype=dtype, s
-0000ddf0: 7061 7273 655f 6469 6d3d 7370 6172 7365  parse_dim=sparse
-0000de00: 5f64 696d 2c20 6665 6174 7572 655f 6469  _dim, feature_di
-0000de10: 6d3d 6665 6174 7572 655f 6469 6d0a 2020  m=feature_dim.  
-0000de20: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000de30: 2020 2020 2020 2020 6f75 742e 7261 775f          out.raw_
-0000de40: 7465 6e73 6f72 203d 2074 6f72 6368 2e65  tensor = torch.e
-0000de50: 6d70 7479 2873 6861 7065 2c20 6474 7970  mpty(shape, dtyp
-0000de60: 653d 6474 7970 655f 2c20 6465 7669 6365  e=dtype_, device
-0000de70: 3d64 6576 6963 6520 6f72 2072 662e 6765  =device or rf.ge
-0000de80: 745f 6465 6661 756c 745f 6465 7669 6365  t_default_device
-0000de90: 2829 290a 2020 2020 2020 2020 6173 7365  ()).        asse
-0000dea0: 7274 2065 7870 6c69 6369 745f 7374 6174  rt explicit_stat
-0000deb0: 6520 6973 204e 6f6e 6520 2023 206e 6f74  e is None  # not
-0000dec0: 2069 6d70 6c65 6d65 6e74 6564 206f 7468   implemented oth
-0000ded0: 6572 7769 7365 0a20 2020 2020 2020 2067  erwise.        g
-0000dee0: 656e 6572 6174 6f72 203d 204e 6f6e 6520  enerator = None 
-0000def0: 2023 2075 7369 6e67 2074 6865 2067 6c6f   # using the glo
-0000df00: 6261 6c20 6465 6661 756c 7420 6672 6f6d  bal default from
-0000df10: 2050 540a 2020 2020 2020 2020 6173 7365   PT.        asse
-0000df20: 7274 2069 7369 6e73 7461 6e63 6528 7374  rt isinstance(st
-0000df30: 6174 6963 2c20 626f 6f6c 290a 2020 2020  atic, bool).    
-0000df40: 2020 2020 6966 2073 7461 7469 633a 0a20      if static:. 
-0000df50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000df60: 7420 7365 6564 2069 7320 6e6f 7420 4e6f  t seed is not No
-0000df70: 6e65 0a20 2020 2020 2020 2020 2020 2067  ne.            g
-0000df80: 656e 6572 6174 6f72 203d 2074 6f72 6368  enerator = torch
-0000df90: 2e47 656e 6572 6174 6f72 2829 0a20 2020  .Generator().   
-0000dfa0: 2020 2020 2020 2020 2067 656e 6572 6174           generat
-0000dfb0: 6f72 2e6d 616e 7561 6c5f 7365 6564 2873  or.manual_seed(s
-0000dfc0: 6565 6429 0a20 2020 2020 2020 2065 6c73  eed).        els
-0000dfd0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-0000dfe0: 7373 6572 7420 7365 6564 2069 7320 4e6f  ssert seed is No
-0000dff0: 6e65 0a20 2020 2020 2020 2061 7373 6572  ne.        asser
-0000e000: 7420 6175 746f 5f75 7064 6174 655f 7374  t auto_update_st
-0000e010: 6174 6520 6973 204e 6f6e 6520 2023 206e  ate is None  # n
-0000e020: 6f74 2069 6d70 6c65 6d65 6e74 6564 206f  ot implemented o
-0000e030: 7468 6572 7769 7365 0a20 2020 2020 2020  therwise.       
-0000e040: 2069 6620 6469 7374 7269 6275 7469 6f6e   if distribution
-0000e050: 203d 3d20 2275 6e69 666f 726d 223a 0a20   == "uniform":. 
-0000e060: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000e070: 7420 6d65 616e 2069 7320 4e6f 6e65 2061  t mean is None a
-0000e080: 6e64 2073 7464 6465 7620 6973 204e 6f6e  nd stddev is Non
-0000e090: 6520 2023 206e 6f74 2069 6d70 6c65 6d65  e  # not impleme
-0000e0a0: 6e74 6564 206f 7468 6572 7769 7365 0a20  nted otherwise. 
-0000e0b0: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-0000e0c0: 7970 655f 2e69 735f 666c 6f61 7469 6e67  ype_.is_floating
-0000e0d0: 5f70 6f69 6e74 3a0a 2020 2020 2020 2020  _point:.        
-0000e0e0: 2020 2020 2020 2020 6966 206d 696e 7661          if minva
-0000e0f0: 6c20 6973 204e 6f6e 653a 0a20 2020 2020  l is None:.     
-0000e100: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000e110: 696e 7661 6c20 3d20 300a 2020 2020 2020  inval = 0.      
-0000e120: 2020 2020 2020 2020 2020 6966 206d 6178            if max
-0000e130: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
-0000e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e150: 206d 6178 7661 6c20 3d20 310a 2020 2020   maxval = 1.    
-0000e160: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000e170: 7369 6e73 7461 6e63 6528 6d69 6e76 616c  sinstance(minval
-0000e180: 2c20 5465 6e73 6f72 293a 0a20 2020 2020  , Tensor):.     
-0000e190: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000e1a0: 7373 6572 7420 6d69 6e76 616c 2e64 696d  ssert minval.dim
-0000e1b0: 7320 3d3d 2028 292c 2066 226f 6e6c 7920  s == (), f"only 
-0000e1c0: 7363 616c 6172 206d 696e 7661 6c20 7375  scalar minval su
-0000e1d0: 7070 6f72 7465 642c 2067 6f74 207b 6d69  pported, got {mi
-0000e1e0: 6e76 616c 7d22 0a20 2020 2020 2020 2020  nval}".         
-0000e1f0: 2020 2020 2020 2020 2020 206d 696e 7661             minva
-0000e200: 6c20 3d20 6d69 6e76 616c 2e72 6177 5f74  l = minval.raw_t
-0000e210: 656e 736f 720a 2020 2020 2020 2020 2020  ensor.          
-0000e220: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000e230: 6e63 6528 6d61 7876 616c 2c20 5465 6e73  nce(maxval, Tens
-0000e240: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0000e250: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000e260: 6d61 7876 616c 2e64 696d 7320 3d3d 2028  maxval.dims == (
-0000e270: 292c 2066 226f 6e6c 7920 7363 616c 6172  ), f"only scalar
-0000e280: 206d 6178 7661 6c20 7375 7070 6f72 7465   maxval supporte
-0000e290: 642c 2067 6f74 207b 6d61 7876 616c 7d22  d, got {maxval}"
-0000e2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e2b0: 2020 2020 206d 6178 7661 6c20 3d20 6d61       maxval = ma
-0000e2c0: 7876 616c 2e72 6177 5f74 656e 736f 720a  xval.raw_tensor.
-0000e2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2e0: 7769 7468 2074 6f72 6368 2e6e 6f5f 6772  with torch.no_gr
-0000e2f0: 6164 2829 3a0a 2020 2020 2020 2020 2020  ad():.          
-0000e300: 2020 2020 2020 2020 2020 6f75 742e 7261            out.ra
-0000e310: 775f 7465 6e73 6f72 2e75 6e69 666f 726d  w_tensor.uniform
-0000e320: 5f28 6d69 6e76 616c 2c20 6d61 7876 616c  _(minval, maxval
-0000e330: 2c20 6765 6e65 7261 746f 723d 6765 6e65  , generator=gene
-0000e340: 7261 746f 7229 2020 2320 6e6f 7161 0a20  rator)  # noqa. 
-0000e350: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000e360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e370: 2069 6620 6d69 6e76 616c 2069 7320 4e6f   if minval is No
-0000e380: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000e390: 2020 2020 2020 2020 6d69 6e76 616c 203d          minval =
-0000e3a0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-0000e3b0: 2020 2061 7373 6572 7420 6d61 7876 616c     assert maxval
-0000e3c0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 226d   is not None, "m
-0000e3d0: 6178 7661 6c20 6d75 7374 2062 6520 7370  axval must be sp
-0000e3e0: 6563 6966 6965 6420 666f 7220 696e 7465  ecified for inte
-0000e3f0: 6765 7220 7261 6e64 6f6d 2075 6e69 666f  ger random unifo
-0000e400: 726d 220a 2020 2020 2020 2020 2020 2020  rm".            
-0000e410: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000e420: 6528 6d69 6e76 616c 2c20 5465 6e73 6f72  e(minval, Tensor
-0000e430: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000e440: 2020 2020 2020 2061 7373 6572 7420 6d69         assert mi
-0000e450: 6e76 616c 2e64 696d 7320 3d3d 2028 292c  nval.dims == (),
-0000e460: 2066 226f 6e6c 7920 7363 616c 6172 206d   f"only scalar m
-0000e470: 696e 7661 6c20 7375 7070 6f72 7465 642c  inval supported,
-0000e480: 2067 6f74 207b 6d69 6e76 616c 7d22 0a20   got {minval}". 
-0000e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4a0: 2020 206d 696e 7661 6c20 3d20 6d69 6e76     minval = minv
-0000e4b0: 616c 2e72 6177 5f74 656e 736f 720a 2020  al.raw_tensor.  
-0000e4c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e4d0: 2069 7369 6e73 7461 6e63 6528 6d61 7876   isinstance(maxv
-0000e4e0: 616c 2c20 5465 6e73 6f72 293a 0a20 2020  al, Tensor):.   
-0000e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e500: 2061 7373 6572 7420 6d61 7876 616c 2e64   assert maxval.d
-0000e510: 696d 7320 3d3d 2028 292c 2066 226f 6e6c  ims == (), f"onl
-0000e520: 7920 7363 616c 6172 206d 6178 7661 6c20  y scalar maxval 
-0000e530: 7375 7070 6f72 7465 642c 2067 6f74 207b  supported, got {
-0000e540: 6d61 7876 616c 7d22 0a20 2020 2020 2020  maxval}".       
-0000e550: 2020 2020 2020 2020 2020 2020 206d 6178               max
-0000e560: 7661 6c20 3d20 6d61 7876 616c 2e72 6177  val = maxval.raw
-0000e570: 5f74 656e 736f 720a 2020 2020 2020 2020  _tensor.        
-0000e580: 2020 2020 2020 2020 7769 7468 2074 6f72          with tor
-0000e590: 6368 2e6e 6f5f 6772 6164 2829 3a0a 2020  ch.no_grad():.  
-0000e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5b0: 2020 6f75 742e 7261 775f 7465 6e73 6f72    out.raw_tensor
-0000e5c0: 2e72 616e 646f 6d5f 286d 696e 7661 6c2c  .random_(minval,
-0000e5d0: 206d 6178 7661 6c2c 2067 656e 6572 6174   maxval, generat
-0000e5e0: 6f72 3d67 656e 6572 6174 6f72 290a 2020  or=generator).  
-0000e5f0: 2020 2020 2020 656c 6966 2064 6973 7472        elif distr
-0000e600: 6962 7574 696f 6e20 3d3d 2022 6e6f 726d  ibution == "norm
-0000e610: 616c 223a 0a20 2020 2020 2020 2020 2020  al":.           
-0000e620: 2061 7373 6572 7420 6d69 6e76 616c 2069   assert minval i
-0000e630: 7320 4e6f 6e65 2061 6e64 206d 6178 7661  s None and maxva
-0000e640: 6c20 6973 204e 6f6e 650a 2020 2020 2020  l is None.      
-0000e650: 2020 2020 2020 6966 206d 6561 6e20 6973        if mean is
-0000e660: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000e670: 2020 2020 2020 206d 6561 6e20 3d20 300a         mean = 0.
-0000e680: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000e690: 7464 6465 7620 6973 204e 6f6e 653a 0a20  tddev is None:. 
-0000e6a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000e6b0: 7464 6465 7620 3d20 310a 2020 2020 2020  tddev = 1.      
-0000e6c0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000e6d0: 6e63 6528 6d65 616e 2c20 5465 6e73 6f72  nce(mean, Tensor
-0000e6e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000e6f0: 2020 2061 7373 6572 7420 6d65 616e 2e64     assert mean.d
-0000e700: 696d 7320 3d3d 2028 292c 2066 226f 6e6c  ims == (), f"onl
-0000e710: 7920 7363 616c 6172 206d 6561 6e20 7375  y scalar mean su
-0000e720: 7070 6f72 7465 642c 2067 6f74 207b 6d65  pported, got {me
-0000e730: 616e 7d22 0a20 2020 2020 2020 2020 2020  an}".           
-0000e740: 2020 2020 206d 6561 6e20 3d20 6d65 616e       mean = mean
-0000e750: 2e72 6177 5f74 656e 736f 720a 2020 2020  .raw_tensor.    
-0000e760: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000e770: 7461 6e63 6528 7374 6464 6576 2c20 5465  tance(stddev, Te
-0000e780: 6e73 6f72 293a 0a20 2020 2020 2020 2020  nsor):.         
-0000e790: 2020 2020 2020 2061 7373 6572 7420 7374         assert st
-0000e7a0: 6464 6576 2e64 696d 7320 3d3d 2028 292c  ddev.dims == (),
-0000e7b0: 2066 226f 6e6c 7920 7363 616c 6172 2073   f"only scalar s
-0000e7c0: 7464 6465 7620 7375 7070 6f72 7465 642c  tddev supported,
-0000e7d0: 2067 6f74 207b 7374 6464 6576 7d22 0a20   got {stddev}". 
-0000e7e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000e7f0: 7464 6465 7620 3d20 7374 6464 6576 2e72  tddev = stddev.r
-0000e800: 6177 5f74 656e 736f 720a 2020 2020 2020  aw_tensor.      
-0000e810: 2020 2020 2020 7769 7468 2074 6f72 6368        with torch
-0000e820: 2e6e 6f5f 6772 6164 2829 3a0a 2020 2020  .no_grad():.    
-0000e830: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
-0000e840: 7261 775f 7465 6e73 6f72 2e6e 6f72 6d61  raw_tensor.norma
-0000e850: 6c5f 286d 6561 6e2c 2073 7464 6465 762c  l_(mean, stddev,
-0000e860: 2067 656e 6572 6174 6f72 3d67 656e 6572   generator=gener
-0000e870: 6174 6f72 290a 2020 2020 2020 2020 656c  ator).        el
-0000e880: 6966 2064 6973 7472 6962 7574 696f 6e20  if distribution 
-0000e890: 3d3d 2022 7472 756e 6361 7465 645f 6e6f  == "truncated_no
-0000e8a0: 726d 616c 223a 0a20 2020 2020 2020 2020  rmal":.         
-0000e8b0: 2020 2069 6620 6d65 616e 2069 7320 4e6f     if mean is No
-0000e8c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000e8d0: 2020 2020 6d65 616e 203d 2030 0a20 2020      mean = 0.   
-0000e8e0: 2020 2020 2020 2020 2069 6620 7374 6464           if stdd
-0000e8f0: 6576 2069 7320 4e6f 6e65 3a0a 2020 2020  ev is None:.    
-0000e900: 2020 2020 2020 2020 2020 2020 7374 6464              stdd
-0000e910: 6576 203d 2031 0a20 2020 2020 2020 2020  ev = 1.         
-0000e920: 2020 2069 6620 6d69 6e76 616c 2069 7320     if minval is 
-0000e930: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000e940: 2020 2020 2020 6d69 6e76 616c 203d 206d        minval = m
-0000e950: 6561 6e20 2d20 3220 2a20 7374 6464 6576  ean - 2 * stddev
-0000e960: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000e970: 6d61 7876 616c 2069 7320 4e6f 6e65 3a0a  maxval is None:.
-0000e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e990: 6d61 7876 616c 203d 206d 6561 6e20 2b20  maxval = mean + 
-0000e9a0: 3220 2a20 7374 6464 6576 0a0a 2020 2020  2 * stddev..    
-0000e9b0: 2020 2020 2020 2020 6672 6f6d 202e 2069          from . i
-0000e9c0: 6d70 6f72 7420 5f72 616e 640a 0a20 2020  mport _rand..   
-0000e9d0: 2020 2020 2020 2020 205f 7261 6e64 2e6e           _rand.n
-0000e9e0: 6f5f 6772 6164 5f74 7275 6e63 5f6e 6f72  o_grad_trunc_nor
-0000e9f0: 6d61 6c5f 286f 7574 2e72 6177 5f74 656e  mal_(out.raw_ten
-0000ea00: 736f 722c 206d 6561 6e3d 6d65 616e 2c20  sor, mean=mean, 
-0000ea10: 7374 643d 7374 6464 6576 2c20 613d 6d69  std=stddev, a=mi
-0000ea20: 6e76 616c 2c20 623d 6d61 7876 616c 2c20  nval, b=maxval, 
-0000ea30: 6765 6e65 7261 746f 723d 6765 6e65 7261  generator=genera
-0000ea40: 746f 7229 0a20 2020 2020 2020 2065 6c73  tor).        els
-0000ea50: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000ea60: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-0000ea70: 7465 6445 7272 6f72 2866 2272 616e 646f  tedError(f"rando
-0000ea80: 6d20 6469 7374 7269 6275 7469 6f6e 207b  m distribution {
-0000ea90: 6469 7374 7269 6275 7469 6f6e 7d20 6e6f  distribution} no
-0000eaa0: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
-0000eab0: 2020 2020 2020 2020 6966 2054 6f72 6368          if Torch
-0000eac0: 4261 636b 656e 642e 5f72 616e 646f 6d5f  Backend._random_
-0000ead0: 6a6f 7572 6e61 6c3a 0a20 2020 2020 2020  journal:.       
-0000eae0: 2020 2020 206f 7574 5f20 3d20 6f75 742e       out_ = out.
-0000eaf0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-0000eb00: 2020 206f 7574 5f2e 7261 775f 7465 6e73     out_.raw_tens
-0000eb10: 6f72 203d 206f 7574 5f2e 7261 775f 7465  or = out_.raw_te
-0000eb20: 6e73 6f72 2e64 6574 6163 6828 292e 6370  nsor.detach().cp
-0000eb30: 7528 292e 6e75 6d70 7928 290a 2020 2020  u().numpy().    
-0000eb40: 2020 2020 2020 2020 546f 7263 6842 6163          TorchBac
-0000eb50: 6b65 6e64 2e5f 7261 6e64 6f6d 5f6a 6f75  kend._random_jou
-0000eb60: 726e 616c 2e61 7070 656e 6428 0a20 2020  rnal.append(.   
-0000eb70: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-0000eb80: 7472 6962 7574 696f 6e3d 6469 7374 7269  tribution=distri
-0000eb90: 6275 7469 6f6e 2c0a 2020 2020 2020 2020  bution,.        
-0000eba0: 2020 2020 2020 2020 6d65 616e 3d6d 6561          mean=mea
-0000ebb0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0000ebc0: 2020 2073 7464 6465 763d 7374 6464 6576     stddev=stddev
-0000ebd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ebe0: 2020 626f 756e 643d 626f 756e 642c 0a20    bound=bound,. 
-0000ebf0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000ec00: 696e 7661 6c3d 6d69 6e76 616c 2c0a 2020  inval=minval,.  
-0000ec10: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0000ec20: 7876 616c 3d6d 6178 7661 6c2c 0a20 2020  xval=maxval,.   
-0000ec30: 2020 2020 2020 2020 2020 2020 2073 6565               see
-0000ec40: 643d 7365 6564 2c0a 2020 2020 2020 2020  d=seed,.        
-0000ec50: 2020 2020 2020 2020 7374 6174 6963 3d73          static=s
-0000ec60: 7461 7469 632c 0a20 2020 2020 2020 2020  tatic,.         
-0000ec70: 2020 2020 2020 206f 7574 3d6f 7574 5f2c         out=out_,
-0000ec80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000ec90: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-0000eca0: 740a 0a20 2020 2040 7374 6174 6963 6d65  t..    @staticme
-0000ecb0: 7468 6f64 0a20 2020 2064 6566 206d 6173  thod.    def mas
-0000ecc0: 6b65 645f 7365 6c65 6374 280a 2020 2020  ked_select(.    
-0000ecd0: 2020 2020 7465 6e73 6f72 3a20 5465 6e73      tensor: Tens
-0000ece0: 6f72 2c20 2a2c 206d 6173 6b3a 2054 656e  or, *, mask: Ten
-0000ecf0: 736f 722c 2064 696d 733a 2053 6571 7565  sor, dims: Seque
-0000ed00: 6e63 655b 4469 6d5d 2c20 6f75 745f 6469  nce[Dim], out_di
-0000ed10: 6d3a 204f 7074 696f 6e61 6c5b 4469 6d5d  m: Optional[Dim]
-0000ed20: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-0000ed30: 2054 7570 6c65 5b54 656e 736f 722c 2044   Tuple[Tensor, D
-0000ed40: 696d 5d3a 0a20 2020 2020 2020 2022 2222  im]:.        """
-0000ed50: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000ed60: 7465 6e73 6f72 3a0a 2020 2020 2020 2020  tensor:.        
-0000ed70: 3a70 6172 616d 206d 6173 6b3a 0a20 2020  :param mask:.   
-0000ed80: 2020 2020 203a 7061 7261 6d20 6469 6d73       :param dims
-0000ed90: 3a20 7468 6520 6f72 6465 7220 6f66 2074  : the order of t
-0000eda0: 6865 2064 696d 7320 6465 6669 6e65 7320  he dims defines 
-0000edb0: 7468 6520 666f 726d 6174 2e20 7468 6f73  the format. thos
-0000edc0: 6520 6469 6d73 2073 686f 756c 6420 6265  e dims should be
-0000edd0: 2065 7861 6374 6c79 2074 6865 2064 696d   exactly the dim
-0000ede0: 7320 6f66 2074 6865 206d 6173 6b2e 0a20  s of the mask.. 
-0000edf0: 2020 2020 2020 203a 7061 7261 6d20 6f75         :param ou
-0000ee00: 745f 6469 6d3a 0a20 2020 2020 2020 203a  t_dim:.        :
-0000ee10: 7265 7475 726e 3a20 7465 6e73 6f72 2077  return: tensor w
-0000ee20: 6865 7265 2061 6c6c 2064 696d 7320 696e  here all dims in
-0000ee30: 206d 6173 6b2f 6469 6d73 2061 7265 2072   mask/dims are r
-0000ee40: 656d 6f76 6564 2061 6e64 2072 6570 6c61  emoved and repla
-0000ee50: 6365 6420 6279 2061 206e 6577 2064 696d  ced by a new dim
-0000ee60: 2e0a 2020 2020 2020 2020 2020 2020 7468  ..            th
-0000ee70: 6520 6e65 7720 6469 6d20 6973 2061 6c73  e new dim is als
-0000ee80: 6f20 7265 7475 726e 6564 2e0a 2020 2020  o returned..    
-0000ee90: 2020 2020 2020 2020 6966 206d 6173 6b3d          if mask=
-0000eea0: 3d54 7275 6520 666f 7220 616c 6c20 656c  =True for all el
-0000eeb0: 656d 656e 7473 2c20 7468 6520 7265 7475  ements, the retu
-0000eec0: 726e 6564 2074 656e 736f 7220 776f 756c  rned tensor woul
-0000eed0: 6420 6265 2073 696d 706c 7920 7468 6520  d be simply the 
-0000eee0: 666c 6174 7465 6e65 6420 696e 7075 7420  flattened input 
-0000eef0: 7465 6e73 6f72 2e0a 2020 2020 2020 2020  tensor..        
-0000ef00: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
-0000ef10: 7274 206d 6173 6b2e 6474 7970 6520 3d3d  rt mask.dtype ==
-0000ef20: 2022 626f 6f6c 220a 2020 2020 2020 2020   "bool".        
-0000ef30: 6173 7365 7274 2073 6574 286d 6173 6b2e  assert set(mask.
-0000ef40: 6469 6d73 2920 3d3d 2073 6574 2864 696d  dims) == set(dim
-0000ef50: 7329 0a20 2020 2020 2020 2072 656d 6169  s).        remai
-0000ef60: 6e69 6e67 5f64 696d 7320 3d20 5b64 2066  ning_dims = [d f
-0000ef70: 6f72 2064 2069 6e20 7465 6e73 6f72 2e64  or d in tensor.d
-0000ef80: 696d 7320 6966 2064 206e 6f74 2069 6e20  ims if d not in 
-0000ef90: 6d61 736b 2e64 696d 735d 0a20 2020 2020  mask.dims].     
-0000efa0: 2020 2074 656e 736f 725f 7465 6d70 6c5f     tensor_templ_
-0000efb0: 6469 6d73 203d 2074 7570 6c65 2864 696d  dims = tuple(dim
-0000efc0: 7329 202b 2074 7570 6c65 2872 656d 6169  s) + tuple(remai
-0000efd0: 6e69 6e67 5f64 696d 7329 0a20 2020 2020  ning_dims).     
-0000efe0: 2020 2069 6e5f 7261 7720 3d20 7465 6e73     in_raw = tens
-0000eff0: 6f72 2e63 6f70 795f 636f 6d70 6174 6962  or.copy_compatib
-0000f000: 6c65 5f74 6f5f 6469 6d73 5f72 6177 2874  le_to_dims_raw(t
-0000f010: 656e 736f 725f 7465 6d70 6c5f 6469 6d73  ensor_templ_dims
-0000f020: 290a 2020 2020 2020 2020 6d61 736b 5f72  ).        mask_r
-0000f030: 6177 203d 206d 6173 6b2e 636f 7079 5f63  aw = mask.copy_c
-0000f040: 6f6d 7061 7469 626c 655f 746f 5f64 696d  ompatible_to_dim
-0000f050: 735f 7261 7728 7465 6e73 6f72 5f74 656d  s_raw(tensor_tem
-0000f060: 706c 5f64 696d 7329 0a20 2020 2020 2020  pl_dims).       
-0000f070: 2023 2057 6520 6861 7665 2061 2076 6572   # We have a ver
-0000f080: 7920 7374 7261 6e67 6520 7072 6f62 6c65  y strange proble
-0000f090: 6d20 7769 7468 2074 6865 2067 7261 6469  m with the gradi
-0000f0a0: 656e 7420 6f66 206d 6173 6b65 645f 7365  ent of masked_se
-0000f0b0: 6c65 6374 2c0a 2020 2020 2020 2020 2320  lect,.        # 
-0000f0c0: 7768 656e 2075 7365 6420 746f 6765 7468  when used togeth
-0000f0d0: 6572 2077 6974 6820 736f 6d65 2073 7065  er with some spe
-0000f0e0: 6369 6669 6320 6f74 6865 7220 6f70 6572  cific other oper
-0000f0f0: 6174 696f 6e73 2062 6566 6f72 6520 7468  ations before th
-0000f100: 6174 2c0a 2020 2020 2020 2020 2320 6c69  at,.        # li
-0000f110: 6b65 2063 6f6e 766f 6c75 7469 6f6e 2e0a  ke convolution..
-0000f120: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
-0000f130: 6c6f 6e65 2829 2077 6974 6820 636f 6e74  lone() with cont
-0000f140: 6967 756f 7573 5f66 6f72 6d61 7420 7365  iguous_format se
-0000f150: 656d 7320 746f 2066 6978 2074 6865 2070  ems to fix the p
-0000f160: 726f 626c 656d 2e0a 2020 2020 2020 2020  roblem..        
-0000f170: 2320 6874 7470 733a 2f2f 6769 7468 7562  # https://github
-0000f180: 2e63 6f6d 2f70 7974 6f72 6368 2f70 7974  .com/pytorch/pyt
-0000f190: 6f72 6368 2f69 7373 7565 732f 3939 3633  orch/issues/9963
-0000f1a0: 380a 2020 2020 2020 2020 696e 5f72 6177  8.        in_raw
-0000f1b0: 203d 2069 6e5f 7261 772e 636c 6f6e 6528   = in_raw.clone(
-0000f1c0: 6d65 6d6f 7279 5f66 6f72 6d61 743d 746f  memory_format=to
-0000f1d0: 7263 682e 636f 6e74 6967 756f 7573 5f66  rch.contiguous_f
-0000f1e0: 6f72 6d61 7429 0a20 2020 2020 2020 2069  ormat).        i
-0000f1f0: 6620 6d61 736b 5f72 6177 2e64 6576 6963  f mask_raw.devic
-0000f200: 652e 7479 7065 203d 3d20 226d 6574 6122  e.type == "meta"
-0000f210: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000f220: 5468 6973 2069 7320 6e6f 7420 7375 7070  This is not supp
-0000f230: 6f72 7465 642c 2062 7574 2061 6c73 6f2c  orted, but also,
-0000f240: 2077 6520 776f 756c 6420 616e 7977 6179   we would anyway
-0000f250: 206e 6f74 206b 6e6f 7720 7468 6520 6f75   not know the ou
-0000f260: 7420 7368 6170 652e 0a20 2020 2020 2020  t shape..       
-0000f270: 2020 2020 2023 2048 6f77 6576 6572 2c20       # However, 
-0000f280: 696e 7374 6561 6420 6f66 2065 7272 6f72  instead of error
-0000f290: 696e 672c 206a 7573 7420 6173 7375 6d65  ing, just assume
-0000f2a0: 2073 6f6d 6520 6475 6d6d 7920 6d61 736b   some dummy mask
-0000f2b0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000f2c0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-0000f2d0: 6f6d 2f70 7974 6f72 6368 2f70 7974 6f72  om/pytorch/pytor
-0000f2e0: 6368 2f69 7373 7565 732f 3130 3938 3731  ch/issues/109871
-0000f2f0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0000f300: 5f72 6177 203d 2069 6e5f 7261 772e 666c  _raw = in_raw.fl
-0000f310: 6174 7465 6e28 290a 2020 2020 2020 2020  atten().        
-0000f320: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f330: 2020 6f75 745f 7261 7720 3d20 746f 7263    out_raw = torc
-0000f340: 682e 6d61 736b 6564 5f73 656c 6563 7428  h.masked_select(
-0000f350: 696e 5f72 6177 2c20 6d61 736b 5f72 6177  in_raw, mask_raw
-0000f360: 290a 2020 2020 2020 2020 7265 6d61 696e  ).        remain
-0000f370: 696e 675f 7368 6170 6520 3d20 5b64 2e67  ing_shape = [d.g
-0000f380: 6574 5f64 696d 5f76 616c 7565 2829 2066  et_dim_value() f
-0000f390: 6f72 2064 2069 6e20 7265 6d61 696e 696e  or d in remainin
-0000f3a0: 675f 6469 6d73 5d0a 2020 2020 2020 2020  g_dims].        
-0000f3b0: 7265 6d61 696e 696e 675f 6e75 6d5f 656c  remaining_num_el
-0000f3c0: 656d 656e 7473 203d 206e 756d 7079 2e70  ements = numpy.p
-0000f3d0: 726f 6428 7265 6d61 696e 696e 675f 7368  rod(remaining_sh
-0000f3e0: 6170 6529 2069 6620 7265 6d61 696e 696e  ape) if remainin
-0000f3f0: 675f 7368 6170 6520 656c 7365 2031 0a20  g_shape else 1. 
-0000f400: 2020 2020 2020 2061 7373 6572 7420 6f75         assert ou
-0000f410: 745f 7261 772e 6e75 6d65 6c28 2920 2520  t_raw.numel() % 
-0000f420: 7265 6d61 696e 696e 675f 6e75 6d5f 656c  remaining_num_el
-0000f430: 656d 656e 7473 203d 3d20 300a 2020 2020  ements == 0.    
-0000f440: 2020 2020 666c 6174 7465 6e65 645f 6e75      flattened_nu
-0000f450: 6d5f 656c 656d 656e 7473 203d 206f 7574  m_elements = out
-0000f460: 5f72 6177 2e6e 756d 656c 2829 202f 2f20  _raw.numel() // 
-0000f470: 7265 6d61 696e 696e 675f 6e75 6d5f 656c  remaining_num_el
-0000f480: 656d 656e 7473 0a20 2020 2020 2020 206f  ements.        o
-0000f490: 7574 5f72 6177 203d 2074 6f72 6368 2e72  ut_raw = torch.r
-0000f4a0: 6573 6861 7065 286f 7574 5f72 6177 2c20  eshape(out_raw, 
-0000f4b0: 5b66 6c61 7474 656e 6564 5f6e 756d 5f65  [flattened_num_e
-0000f4c0: 6c65 6d65 6e74 735d 202b 2072 656d 6169  lements] + remai
-0000f4d0: 6e69 6e67 5f73 6861 7065 290a 2020 2020  ning_shape).    
-0000f4e0: 2020 2020 6966 206e 6f74 206f 7574 5f64      if not out_d
-0000f4f0: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-0000f500: 6f75 745f 6469 6d20 3d20 4469 6d28 4e6f  out_dim = Dim(No
-0000f510: 6e65 2c20 6e61 6d65 3d22 6d61 736b 6564  ne, name="masked
-0000f520: 5f73 656c 6563 7422 290a 2020 2020 2020  _select").      
-0000f530: 2020 6966 206e 6f74 206f 7574 5f64 696d    if not out_dim
-0000f540: 2e64 796e 5f73 697a 655f 6578 743a 0a20  .dyn_size_ext:. 
-0000f550: 2020 2020 2020 2020 2020 206f 7574 5f64             out_d
-0000f560: 696d 2e64 796e 5f73 697a 655f 6578 7420  im.dyn_size_ext 
-0000f570: 3d20 5465 6e73 6f72 2822 6d61 736b 6564  = Tensor("masked
-0000f580: 5f73 656c 6563 745f 7369 7a65 222c 2064  _select_size", d
-0000f590: 696d 733d 2829 2c20 6474 7970 653d 2269  ims=(), dtype="i
-0000f5a0: 6e74 3634 2229 0a20 2020 2020 2020 2069  nt64").        i
-0000f5b0: 6620 6f75 745f 6469 6d2e 6479 6e5f 7369  f out_dim.dyn_si
-0000f5c0: 7a65 5f65 7874 2e72 6177 5f74 656e 736f  ze_ext.raw_tenso
-0000f5d0: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-0000f5e0: 2020 2020 2020 206f 7574 5f64 696d 2e64         out_dim.d
-0000f5f0: 796e 5f73 697a 655f 6578 742e 7261 775f  yn_size_ext.raw_
-0000f600: 7465 6e73 6f72 203d 2074 6f72 6368 2e74  tensor = torch.t
-0000f610: 656e 736f 7228 666c 6174 7465 6e65 645f  ensor(flattened_
-0000f620: 6e75 6d5f 656c 656d 656e 7473 2c20 6474  num_elements, dt
-0000f630: 7970 653d 746f 7263 682e 696e 7436 3429  ype=torch.int64)
-0000f640: 0a20 2020 2020 2020 206f 7574 203d 2054  .        out = T
-0000f650: 656e 736f 7228 0a20 2020 2020 2020 2020  ensor(.         
-0000f660: 2020 2022 6d61 736b 6564 5f73 656c 6563     "masked_selec
-0000f670: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0000f680: 6469 6d73 3d28 6f75 745f 6469 6d2c 2920  dims=(out_dim,) 
-0000f690: 2b20 7475 706c 6528 7265 6d61 696e 696e  + tuple(remainin
-0000f6a0: 675f 6469 6d73 292c 0a20 2020 2020 2020  g_dims),.       
-0000f6b0: 2020 2020 2064 7479 7065 3d74 656e 736f       dtype=tenso
-0000f6c0: 722e 6474 7970 652c 0a20 2020 2020 2020  r.dtype,.       
-0000f6d0: 2020 2020 2073 7061 7273 655f 6469 6d3d       sparse_dim=
-0000f6e0: 7465 6e73 6f72 2e73 7061 7273 655f 6469  tensor.sparse_di
-0000f6f0: 6d2c 0a20 2020 2020 2020 2020 2020 2072  m,.            r
-0000f700: 6177 5f74 656e 736f 723d 6f75 745f 7261  aw_tensor=out_ra
-0000f710: 772c 0a20 2020 2020 2020 2029 0a20 2020  w,.        ).   
-0000f720: 2020 2020 2072 6574 7572 6e20 6f75 742c       return out,
-0000f730: 206f 7574 5f64 696d 0a0a 2020 2020 4073   out_dim..    @s
-0000f740: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-0000f750: 6465 6620 6d61 736b 6564 5f73 6361 7474  def masked_scatt
-0000f760: 6572 2873 6f75 7263 653a 2054 656e 736f  er(source: Tenso
-0000f770: 722c 202a 2c20 6d61 736b 3a20 5465 6e73  r, *, mask: Tens
-0000f780: 6f72 2c20 6469 6d73 3a20 5365 7175 656e  or, dims: Sequen
-0000f790: 6365 5b44 696d 5d2c 2069 6e5f 6469 6d3a  ce[Dim], in_dim:
-0000f7a0: 2044 696d 2920 2d3e 2054 656e 736f 723a   Dim) -> Tensor:
-0000f7b0: 0a20 2020 2020 2020 2022 2222 6d61 736b  .        """mask
-0000f7c0: 6564 2073 6361 7474 6572 2222 220a 2020  ed scatter""".  
-0000f7d0: 2020 2020 2020 6173 7365 7274 206d 6173        assert mas
-0000f7e0: 6b2e 6474 7970 6520 3d3d 2022 626f 6f6c  k.dtype == "bool
-0000f7f0: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-0000f800: 2073 6574 286d 6173 6b2e 6469 6d73 2920   set(mask.dims) 
-0000f810: 3d3d 2073 6574 2864 696d 7329 0a20 2020  == set(dims).   
-0000f820: 2020 2020 2061 7373 6572 7420 696e 5f64       assert in_d
-0000f830: 696d 2069 6e20 736f 7572 6365 2e64 696d  im in source.dim
-0000f840: 730a 2020 2020 2020 2020 7265 6d61 696e  s.        remain
-0000f850: 696e 675f 6469 6d73 203d 205b 6420 666f  ing_dims = [d fo
-0000f860: 7220 6420 696e 2073 6f75 7263 652e 6469  r d in source.di
-0000f870: 6d73 2069 6620 6420 6e6f 7420 696e 206d  ms if d not in m
-0000f880: 6173 6b2e 6469 6d73 2061 6e64 2064 2021  ask.dims and d !
-0000f890: 3d20 696e 5f64 696d 5d0a 2020 2020 2020  = in_dim].      
-0000f8a0: 2020 736f 7572 6365 5f74 656d 706c 5f64    source_templ_d
-0000f8b0: 696d 7320 3d20 2869 6e5f 6469 6d2c 2920  ims = (in_dim,) 
-0000f8c0: 2b20 7475 706c 6528 7265 6d61 696e 696e  + tuple(remainin
-0000f8d0: 675f 6469 6d73 290a 2020 2020 2020 2020  g_dims).        
-0000f8e0: 7465 6e73 6f72 5f74 656d 706c 5f64 696d  tensor_templ_dim
-0000f8f0: 7320 3d20 7475 706c 6528 6469 6d73 2920  s = tuple(dims) 
-0000f900: 2b20 7475 706c 6528 7265 6d61 696e 696e  + tuple(remainin
-0000f910: 675f 6469 6d73 290a 2020 2020 2020 2020  g_dims).        
-0000f920: 736f 7572 6365 5f72 6177 203d 2073 6f75  source_raw = sou
-0000f930: 7263 652e 636f 7079 5f63 6f6d 7061 7469  rce.copy_compati
-0000f940: 626c 655f 746f 5f64 696d 735f 7261 7728  ble_to_dims_raw(
-0000f950: 736f 7572 6365 5f74 656d 706c 5f64 696d  source_templ_dim
-0000f960: 7329 0a20 2020 2020 2020 206d 6173 6b5f  s).        mask_
-0000f970: 7261 7720 3d20 6d61 736b 2e63 6f70 795f  raw = mask.copy_
-0000f980: 636f 6d70 6174 6962 6c65 5f74 6f5f 6469  compatible_to_di
-0000f990: 6d73 5f72 6177 2874 656e 736f 725f 7465  ms_raw(tensor_te
-0000f9a0: 6d70 6c5f 6469 6d73 290a 2020 2020 2020  mpl_dims).      
-0000f9b0: 2020 6f75 745f 7368 6170 6520 3d20 5b64    out_shape = [d
-0000f9c0: 2e67 6574 5f64 696d 5f76 616c 7565 2829  .get_dim_value()
-0000f9d0: 2066 6f72 2064 2069 6e20 7465 6e73 6f72   for d in tensor
-0000f9e0: 5f74 656d 706c 5f64 696d 735d 0a20 2020  _templ_dims].   
-0000f9f0: 2020 2020 206f 7574 5f72 6177 203d 2074       out_raw = t
-0000fa00: 6f72 6368 2e7a 6572 6f73 286f 7574 5f73  orch.zeros(out_s
-0000fa10: 6861 7065 2c20 6474 7970 653d 736f 7572  hape, dtype=sour
-0000fa20: 6365 5f72 6177 2e64 7479 7065 2c20 6465  ce_raw.dtype, de
-0000fa30: 7669 6365 3d73 6f75 7263 655f 7261 772e  vice=source_raw.
-0000fa40: 6465 7669 6365 290a 2020 2020 2020 2020  device).        
-0000fa50: 6f75 745f 7261 772e 6d61 736b 6564 5f73  out_raw.masked_s
-0000fa60: 6361 7474 6572 5f28 6d61 736b 5f72 6177  catter_(mask_raw
-0000fa70: 2c20 736f 7572 6365 5f72 6177 290a 2020  , source_raw).  
-0000fa80: 2020 2020 2020 7265 7475 726e 2054 656e        return Ten
-0000fa90: 736f 7228 0a20 2020 2020 2020 2020 2020  sor(.           
-0000faa0: 2022 6d61 736b 6564 5f73 6361 7474 6572   "masked_scatter
-0000fab0: 222c 0a20 2020 2020 2020 2020 2020 2064  ",.            d
-0000fac0: 696d 733d 7465 6e73 6f72 5f74 656d 706c  ims=tensor_templ
-0000fad0: 5f64 696d 732c 0a20 2020 2020 2020 2020  _dims,.         
-0000fae0: 2020 2064 7479 7065 3d73 6f75 7263 652e     dtype=source.
-0000faf0: 6474 7970 652c 0a20 2020 2020 2020 2020  dtype,.         
-0000fb00: 2020 2073 7061 7273 655f 6469 6d3d 736f     sparse_dim=so
-0000fb10: 7572 6365 2e73 7061 7273 655f 6469 6d2c  urce.sparse_dim,
-0000fb20: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
-0000fb30: 5f74 656e 736f 723d 6f75 745f 7261 772c  _tensor=out_raw,
-0000fb40: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000fb50: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0000fb60: 2020 6465 6620 6261 7463 685f 6e6f 726d    def batch_norm
-0000fb70: 280a 2020 2020 2020 2020 736f 7572 6365  (.        source
-0000fb80: 3a20 5465 6e73 6f72 5b74 6f72 6368 2e54  : Tensor[torch.T
-0000fb90: 656e 736f 725d 2c0a 2020 2020 2020 2020  ensor],.        
-0000fba0: 2a2c 0a20 2020 2020 2020 2069 6e5f 6469  *,.        in_di
-0000fbb0: 6d3a 2055 6e69 6f6e 5b44 696d 2c20 5365  m: Union[Dim, Se
-0000fbc0: 7175 656e 6365 5b44 696d 5d5d 2c0a 2020  quence[Dim]],.  
-0000fbd0: 2020 2020 2020 7275 6e6e 696e 675f 6d65        running_me
-0000fbe0: 616e 3a20 4f70 7469 6f6e 616c 5b54 656e  an: Optional[Ten
-0000fbf0: 736f 725d 2c0a 2020 2020 2020 2020 7275  sor],.        ru
-0000fc00: 6e6e 696e 675f 7661 7269 616e 6365 3a20  nning_variance: 
-0000fc10: 4f70 7469 6f6e 616c 5b54 656e 736f 725d  Optional[Tensor]
-0000fc20: 2c0a 2020 2020 2020 2020 6761 6d6d 613a  ,.        gamma:
-0000fc30: 204f 7074 696f 6e61 6c5b 5465 6e73 6f72   Optional[Tensor
-0000fc40: 5d2c 0a20 2020 2020 2020 2062 6574 613a  ],.        beta:
-0000fc50: 204f 7074 696f 6e61 6c5b 5465 6e73 6f72   Optional[Tensor
-0000fc60: 5d2c 0a20 2020 2020 2020 2065 7073 696c  ],.        epsil
-0000fc70: 6f6e 3a20 666c 6f61 742c 0a20 2020 2020  on: float,.     
-0000fc80: 2020 206d 6f6d 656e 7475 6d3a 2066 6c6f     momentum: flo
-0000fc90: 6174 2c0a 2020 2020 2020 2020 6166 6669  at,.        affi
-0000fca0: 6e65 3a20 626f 6f6c 2c0a 2020 2020 2020  ne: bool,.      
-0000fcb0: 2020 7573 655f 6d61 736b 3a20 626f 6f6c    use_mask: bool
-0000fcc0: 2c0a 2020 2020 2920 2d3e 2054 656e 736f  ,.    ) -> Tenso
-0000fcd0: 723a 0a20 2020 2020 2020 2022 2222 6261  r:.        """ba
-0000fce0: 7463 6820 6e6f 726d 2222 220a 2020 2020  tch norm""".    
-0000fcf0: 2020 2020 6966 2075 7365 5f6d 6173 6b3a      if use_mask:
-0000fd00: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000fd10: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
-0000fd20: 6445 7272 6f72 2822 6261 7463 685f 6e6f  dError("batch_no
-0000fd30: 726d 2077 6974 6820 6d61 736b 696e 6720  rm with masking 
-0000fd40: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-0000fd50: 290a 2020 2020 2020 2020 6966 2028 7275  ).        if (ru
-0000fd60: 6e6e 696e 675f 6d65 616e 2069 7320 4e6f  nning_mean is No
-0000fd70: 6e65 2920 213d 2028 7275 6e6e 696e 675f  ne) != (running_
-0000fd80: 7661 7269 616e 6365 2069 7320 4e6f 6e65  variance is None
-0000fd90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000fda0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0000fdb0: 2272 756e 6e69 6e67 5f6d 6561 6e20 616e  "running_mean an
-0000fdc0: 6420 7275 6e6e 696e 675f 7661 7269 616e  d running_varian
-0000fdd0: 6365 206d 7573 7420 6265 2062 6f74 6820  ce must be both 
-0000fde0: 4e6f 6e65 206f 7220 626f 7468 206e 6f74  None or both not
-0000fdf0: 204e 6f6e 6522 290a 2020 2020 2020 2020   None").        
-0000fe00: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0000fe10: 6528 696e 5f64 696d 2c20 4469 6d29 2020  e(in_dim, Dim)  
-0000fe20: 2320 6d75 6c74 6970 6c65 2064 696d 7320  # multiple dims 
-0000fe30: 6e6f 7420 7375 7070 6f72 7465 6420 7965  not supported ye
-0000fe40: 740a 2020 2020 2020 2020 6966 2061 6666  t.        if aff
-0000fe50: 696e 653a 0a20 2020 2020 2020 2020 2020  ine:.           
-0000fe60: 2069 6620 6761 6d6d 6120 6973 204e 6f6e   if gamma is Non
-0000fe70: 6520 6f72 2062 6574 6120 6973 204e 6f6e  e or beta is Non
-0000fe80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000fe90: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000fea0: 726f 7228 2267 616d 6d61 2061 6e64 2062  ror("gamma and b
-0000feb0: 6574 6120 6d75 7374 2062 6520 6769 7665  eta must be give
-0000fec0: 6e20 6966 2061 6666 696e 653d 5472 7565  n if affine=True
-0000fed0: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-0000fee0: 6620 6e6f 7420 6761 6d6d 612e 6469 6d73  f not gamma.dims
-0000fef0: 203d 3d20 6265 7461 2e64 696d 7320 3d3d   == beta.dims ==
-0000ff00: 2028 696e 5f64 696d 2c29 3a0a 2020 2020   (in_dim,):.    
-0000ff10: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000ff20: 6520 5661 6c75 6545 7272 6f72 2866 2267  e ValueError(f"g
-0000ff30: 616d 6d61 2061 6e64 2062 6574 6120 6d75  amma and beta mu
-0000ff40: 7374 2068 6176 6520 7368 6170 6520 5b7b  st have shape [{
-0000ff50: 696e 5f64 696d 7d5d 2c20 676f 7420 6761  in_dim}], got ga
-0000ff60: 6d6d 6120 7b67 616d 6d61 7d20 616e 6420  mma {gamma} and 
-0000ff70: 6265 7461 207b 6265 7461 7d22 290a 2020  beta {beta}").  
-0000ff80: 2020 2020 2020 6966 2072 756e 6e69 6e67        if running
-0000ff90: 5f6d 6561 6e20 6973 206e 6f74 204e 6f6e  _mean is not Non
-0000ffa0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0000ffb0: 6620 6e6f 7420 7275 6e6e 696e 675f 6d65  f not running_me
-0000ffc0: 616e 2e64 696d 7320 3d3d 2072 756e 6e69  an.dims == runni
-0000ffd0: 6e67 5f76 6172 6961 6e63 652e 6469 6d73  ng_variance.dims
-0000ffe0: 203d 3d20 2869 6e5f 6469 6d2c 293a 0a20   == (in_dim,):. 
-0000fff0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010000: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00010010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010020: 2020 2020 2066 2272 756e 6e69 6e67 5f6d       f"running_m
-00010030: 6561 6e20 616e 6420 7275 6e6e 696e 675f  ean and running_
-00010040: 7661 7269 616e 6365 206d 7573 7420 6861  variance must ha
-00010050: 7665 2073 6861 7065 205b 7b69 6e5f 6469  ve shape [{in_di
-00010060: 6d7d 5d2c 2067 6f74 2022 0a20 2020 2020  m}], got ".     
-00010070: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010080: 2272 756e 6e69 6e67 5f6d 6561 6e20 7b72  "running_mean {r
-00010090: 756e 6e69 6e67 5f6d 6561 6e7d 2061 6e64  unning_mean} and
-000100a0: 2072 756e 6e69 6e67 5f76 6172 6961 6e63   running_varianc
-000100b0: 6520 7b72 756e 6e69 6e67 5f76 6172 6961  e {running_varia
-000100c0: 6e63 657d 220a 2020 2020 2020 2020 2020  nce}".          
-000100d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000100e0: 6665 6174 5f61 7869 7320 3d20 736f 7572  feat_axis = sour
-000100f0: 6365 2e67 6574 5f61 7869 735f 6672 6f6d  ce.get_axis_from
-00010100: 5f64 6573 6372 6970 7469 6f6e 2869 6e5f  _description(in_
-00010110: 6469 6d29 0a20 2020 2020 2020 2069 6620  dim).        if 
-00010120: 6665 6174 5f61 7869 7320 3d3d 2030 3a0a  feat_axis == 0:.
-00010130: 2020 2020 2020 2020 2020 2020 7072 655f              pre_
-00010140: 6469 6d73 203d 2031 0a20 2020 2020 2020  dims = 1.       
-00010150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00010160: 2020 2070 7265 5f64 696d 7320 3d20 6e75     pre_dims = nu
-00010170: 6d70 792e 7072 6f64 2873 6f75 7263 652e  mpy.prod(source.
-00010180: 7261 775f 7465 6e73 6f72 2e73 6861 7065  raw_tensor.shape
-00010190: 5b3a 6665 6174 5f61 7869 735d 290a 2020  [:feat_axis]).  
-000101a0: 2020 2020 2020 2320 546f 7263 6820 6261        # Torch ba
-000101b0: 7463 685f 6e6f 726d 2065 7870 6563 7473  tch_norm expects
-000101c0: 2028 4e2c 432c 2b29 2061 7320 7368 6170   (N,C,+) as shap
-000101d0: 652e 0a20 2020 2020 2020 2073 7263 5f72  e..        src_r
-000101e0: 6177 203d 2074 6f72 6368 2e72 6573 6861  aw = torch.resha
-000101f0: 7065 2873 6f75 7263 652e 7261 775f 7465  pe(source.raw_te
-00010200: 6e73 6f72 2c20 5b70 7265 5f64 696d 732c  nsor, [pre_dims,
-00010210: 2069 6e5f 6469 6d2e 6765 745f 6469 6d5f   in_dim.get_dim_
-00010220: 7661 6c75 6528 292c 202d 315d 290a 2020  value(), -1]).  
-00010230: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
-00010240: 6769 7468 7562 2e63 6f6d 2f70 7974 6f72  github.com/pytor
-00010250: 6368 2f70 7974 6f72 6368 2f62 6c6f 622f  ch/pytorch/blob/
-00010260: 3539 3630 3538 3131 3438 3865 6230 3762  59605811488eb07b
-00010270: 3362 3862 6637 3061 3566 3062 3462 3536  3b8bf70a5f0b4b56
-00010280: 6233 3462 3461 3631 2f61 7465 6e2f 7372  b34b4a61/aten/sr
-00010290: 632f 4154 656e 2f6e 6174 6976 652f 4e6f  c/ATen/native/No
-000102a0: 726d 616c 697a 6174 696f 6e2e 6370 7023  rmalization.cpp#
-000102b0: 4c35 3436 0a20 2020 2020 2020 206f 7574  L546.        out
-000102c0: 5f72 6177 203d 2074 6f72 6368 2e6e 6e2e  _raw = torch.nn.
-000102d0: 6675 6e63 7469 6f6e 616c 2e62 6174 6368  functional.batch
-000102e0: 5f6e 6f72 6d28 0a20 2020 2020 2020 2020  _norm(.         
-000102f0: 2020 2073 7263 5f72 6177 2c0a 2020 2020     src_raw,.    
-00010300: 2020 2020 2020 2020 7275 6e6e 696e 675f          running_
-00010310: 6d65 616e 3d72 756e 6e69 6e67 5f6d 6561  mean=running_mea
-00010320: 6e2e 7261 775f 7465 6e73 6f72 2069 6620  n.raw_tensor if 
-00010330: 7275 6e6e 696e 675f 6d65 616e 2069 7320  running_mean is 
-00010340: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
-00010350: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00010360: 7275 6e6e 696e 675f 7661 723d 7275 6e6e  running_var=runn
-00010370: 696e 675f 7661 7269 616e 6365 2e72 6177  ing_variance.raw
-00010380: 5f74 656e 736f 7220 6966 2072 756e 6e69  _tensor if runni
-00010390: 6e67 5f76 6172 6961 6e63 6520 6973 206e  ng_variance is n
-000103a0: 6f74 204e 6f6e 6520 656c 7365 204e 6f6e  ot None else Non
-000103b0: 652c 0a20 2020 2020 2020 2020 2020 2077  e,.            w
-000103c0: 6569 6768 743d 6761 6d6d 612e 7261 775f  eight=gamma.raw_
-000103d0: 7465 6e73 6f72 2069 6620 6166 6669 6e65  tensor if affine
-000103e0: 2065 6c73 6520 4e6f 6e65 2c0a 2020 2020   else None,.    
-000103f0: 2020 2020 2020 2020 6269 6173 3d62 6574          bias=bet
-00010400: 612e 7261 775f 7465 6e73 6f72 2069 6620  a.raw_tensor if 
-00010410: 6166 6669 6e65 2065 6c73 6520 4e6f 6e65  affine else None
-00010420: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00010430: 7472 6169 6e69 6e67 3a20 6d65 616e 7320  training: means 
-00010440: 7768 6574 6865 7220 7765 2073 686f 756c  whether we shoul
-00010450: 6420 7573 6520 7468 6520 6375 7272 656e  d use the curren
-00010460: 7420 6261 7463 6820 7374 6174 6973 7469  t batch statisti
-00010470: 6373 0a20 2020 2020 2020 2020 2020 2023  cs.            #
-00010480: 2020 202b 2075 7064 6174 6520 7468 6520     + update the 
-00010490: 7275 6e6e 696e 6720 7374 6174 6973 7469  running statisti
-000104a0: 6373 2028 6966 2067 6976 656e 290a 2020  cs (if given).  
-000104b0: 2020 2020 2020 2020 2020 7472 6169 6e69            traini
-000104c0: 6e67 3d72 662e 6765 745f 7275 6e5f 6374  ng=rf.get_run_ct
-000104d0: 7828 292e 7472 6169 6e5f 666c 6167 206f  x().train_flag o
-000104e0: 7220 2872 756e 6e69 6e67 5f6d 6561 6e20  r (running_mean 
-000104f0: 6973 204e 6f6e 6529 2c0a 2020 2020 2020  is None),.      
-00010500: 2020 2020 2020 6d6f 6d65 6e74 756d 3d6d        momentum=m
-00010510: 6f6d 656e 7475 6d2c 0a20 2020 2020 2020  omentum,.       
-00010520: 2020 2020 2065 7073 3d65 7073 696c 6f6e       eps=epsilon
-00010530: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00010540: 2020 2020 6f75 7420 3d20 736f 7572 6365      out = source
-00010550: 2e63 6f70 795f 7465 6d70 6c61 7465 2829  .copy_template()
-00010560: 0a20 2020 2020 2020 206f 7574 2e72 6177  .        out.raw
-00010570: 5f74 656e 736f 7220 3d20 746f 7263 682e  _tensor = torch.
-00010580: 7265 7368 6170 6528 6f75 745f 7261 772c  reshape(out_raw,
-00010590: 2073 6f75 7263 652e 7261 775f 7465 6e73   source.raw_tens
-000105a0: 6f72 2e73 6861 7065 290a 2020 2020 2020  or.shape).      
-000105b0: 2020 6f75 742e 6665 6174 7572 655f 6469    out.feature_di
-000105c0: 6d20 3d20 696e 5f64 696d 0a20 2020 2020  m = in_dim.     
-000105d0: 2020 2072 6574 7572 6e20 6f75 740a 0a20     return out.. 
-000105e0: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
-000105f0: 6e20 5079 5368 6164 6f77 696e 6742 7569  n PyShadowingBui
-00010600: 6c74 696e 730a 2020 2020 4073 7461 7469  ltins.    @stati
-00010610: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-00010620: 636f 6e76 280a 2020 2020 2020 2020 736f  conv(.        so
-00010630: 7572 6365 3a20 5465 6e73 6f72 2c0a 2020  urce: Tensor,.  
-00010640: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00010650: 2069 6e5f 6469 6d3a 2044 696d 2c0a 2020   in_dim: Dim,.  
-00010660: 2020 2020 2020 6f75 745f 6469 6d3a 2044        out_dim: D
-00010670: 696d 2c0a 2020 2020 2020 2020 696e 5f73  im,.        in_s
-00010680: 7061 7469 616c 5f64 696d 733a 2053 6571  patial_dims: Seq
-00010690: 7565 6e63 655b 4469 6d5d 2c0a 2020 2020  uence[Dim],.    
-000106a0: 2020 2020 6f75 745f 7370 6174 6961 6c5f      out_spatial_
-000106b0: 6469 6d73 3a20 4f70 7469 6f6e 616c 5b53  dims: Optional[S
-000106c0: 6571 7565 6e63 655b 4469 6d5d 5d20 3d20  equence[Dim]] = 
-000106d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6669  None,.        fi
-000106e0: 6c74 6572 3a20 5465 6e73 6f72 2c0a 2020  lter: Tensor,.  
-000106f0: 2020 2020 2020 6669 6c74 6572 5f73 697a        filter_siz
-00010700: 653a 2053 6571 7565 6e63 655b 4469 6d5d  e: Sequence[Dim]
-00010710: 2c20 2023 2074 6f20 6861 7665 2074 6865  ,  # to have the
-00010720: 206f 7264 6572 2077 656c 6c2d 6465 6669   order well-defi
-00010730: 6e65 640a 2020 2020 2020 2020 7061 6464  ned.        padd
-00010740: 696e 673a 2073 7472 2c0a 2020 2020 2020  ing: str,.      
-00010750: 2020 7374 7269 6465 733a 204f 7074 696f    strides: Optio
-00010760: 6e61 6c5b 556e 696f 6e5b 696e 742c 2053  nal[Union[int, S
-00010770: 6571 7565 6e63 655b 696e 745d 5d5d 203d  equence[int]]] =
-00010780: 204e 6f6e 652c 0a20 2020 2020 2020 2064   None,.        d
-00010790: 696c 6174 696f 6e5f 7261 7465 3a20 4f70  ilation_rate: Op
-000107a0: 7469 6f6e 616c 5b55 6e69 6f6e 5b69 6e74  tional[Union[int
-000107b0: 2c20 5365 7175 656e 6365 5b69 6e74 5d5d  , Sequence[int]]
-000107c0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000107d0: 2020 6772 6f75 7073 3a20 4f70 7469 6f6e    groups: Option
-000107e0: 616c 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a  al[int] = None,.
-000107f0: 2020 2020 2020 2020 6269 6173 3a20 4f70          bias: Op
-00010800: 7469 6f6e 616c 5b54 656e 736f 725d 203d  tional[Tensor] =
-00010810: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-00010820: 5475 706c 655b 5465 6e73 6f72 2c20 5365  Tuple[Tensor, Se
-00010830: 7175 656e 6365 5b44 696d 5d5d 3a0a 2020  quence[Dim]]:.  
-00010840: 2020 2020 2020 2222 2263 6f6e 7622 2222        """conv"""
-00010850: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00010860: 6f75 745f 7370 6174 6961 6c5f 6469 6d73  out_spatial_dims
-00010870: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
-00010880: 745f 7370 6174 6961 6c5f 6469 6d73 203d  t_spatial_dims =
-00010890: 2072 662e 6d61 6b65 5f63 6f6e 765f 6f75   rf.make_conv_ou
-000108a0: 745f 7370 6174 6961 6c5f 6469 6d73 280a  t_spatial_dims(.
-000108b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108c0: 696e 5f73 7061 7469 616c 5f64 696d 733d  in_spatial_dims=
-000108d0: 696e 5f73 7061 7469 616c 5f64 696d 732c  in_spatial_dims,
-000108e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000108f0: 2066 696c 7465 725f 7369 7a65 3d5b 642e   filter_size=[d.
-00010900: 6469 6d65 6e73 696f 6e20 666f 7220 6420  dimension for d 
-00010910: 696e 2066 696c 7465 725f 7369 7a65 5d2c  in filter_size],
-00010920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010930: 2073 7472 6964 6573 3d73 7472 6964 6573   strides=strides
-00010940: 206f 7220 312c 0a20 2020 2020 2020 2020   or 1,.         
-00010950: 2020 2020 2020 2064 696c 6174 696f 6e5f         dilation_
-00010960: 7261 7465 3d64 696c 6174 696f 6e5f 7261  rate=dilation_ra
-00010970: 7465 206f 7220 312c 0a20 2020 2020 2020  te or 1,.       
-00010980: 2020 2020 2020 2020 2070 6164 6469 6e67           padding
-00010990: 3d70 6164 6469 6e67 2c0a 2020 2020 2020  =padding,.      
-000109a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000109b0: 6669 6c74 6572 5f69 6e5f 6469 6d20 3d20  filter_in_dim = 
-000109c0: 696e 5f64 696d 2069 6620 6e6f 7420 6772  in_dim if not gr
-000109d0: 6f75 7073 206f 7220 6772 6f75 7073 203d  oups or groups =
-000109e0: 3d20 3120 656c 7365 2069 6e5f 6469 6d20  = 1 else in_dim 
-000109f0: 2f2f 2067 726f 7570 730a 2020 2020 2020  // groups.      
-00010a00: 2020 6669 6c74 6572 5f64 696d 7320 3d20    filter_dims = 
-00010a10: 286f 7574 5f64 696d 2c20 6669 6c74 6572  (out_dim, filter
-00010a20: 5f69 6e5f 6469 6d29 202b 2074 7570 6c65  _in_dim) + tuple
-00010a30: 2866 696c 7465 725f 7369 7a65 290a 2020  (filter_size).  
-00010a40: 2020 2020 2020 6669 6c74 6572 203d 2066        filter = f
-00010a50: 696c 7465 722e 636f 7079 5f74 7261 6e73  ilter.copy_trans
-00010a60: 706f 7365 2866 696c 7465 725f 6469 6d73  pose(filter_dims
-00010a70: 290a 2020 2020 2020 2020 6261 7463 685f  ).        batch_
-00010a80: 6469 6d73 203d 205b 6420 666f 7220 6420  dims = [d for d 
-00010a90: 696e 2073 6f75 7263 652e 6469 6d73 2069  in source.dims i
-00010aa0: 6620 6420 6e6f 7420 696e 2028 696e 5f64  f d not in (in_d
-00010ab0: 696d 2c29 202b 2074 7570 6c65 2869 6e5f  im,) + tuple(in_
-00010ac0: 7370 6174 6961 6c5f 6469 6d73 295d 0a20  spatial_dims)]. 
-00010ad0: 2020 2020 2020 2023 2054 6f72 6368 2063         # Torch c
-00010ae0: 6f6e 7620 6578 7065 6374 7320 284e 2c43  onv expects (N,C
-00010af0: 2c3c 7370 6174 6961 6c20 6469 6d73 3e29  ,<spatial dims>)
-00010b00: 2061 7320 7368 6170 652e 0a20 2020 2020   as shape..     
-00010b10: 2020 2073 6f75 7263 6520 3d20 736f 7572     source = sour
-00010b20: 6365 2e63 6f70 795f 7472 616e 7370 6f73  ce.copy_transpos
-00010b30: 6528 6261 7463 685f 6469 6d73 202b 205b  e(batch_dims + [
-00010b40: 696e 5f64 696d 5d20 2b20 6c69 7374 2869  in_dim] + list(i
-00010b50: 6e5f 7370 6174 6961 6c5f 6469 6d73 2929  n_spatial_dims))
-00010b60: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00010b70: 6261 7463 685f 6469 6d73 2920 3d3d 2031  batch_dims) == 1
-00010b80: 3a0a 2020 2020 2020 2020 2020 2020 7372  :.            sr
-00010b90: 635f 7261 7720 3d20 736f 7572 6365 2e72  c_raw = source.r
-00010ba0: 6177 5f74 656e 736f 720a 2020 2020 2020  aw_tensor.      
-00010bb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010bc0: 2020 2020 7372 635f 7261 7720 3d20 746f      src_raw = to
-00010bd0: 7263 682e 7265 7368 6170 6528 0a20 2020  rch.reshape(.   
-00010be0: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
-00010bf0: 7263 652e 7261 775f 7465 6e73 6f72 2c0a  rce.raw_tensor,.
-00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c10: 2320 706f 7465 6e74 6961 6c6c 7920 6d65  # potentially me
-00010c20: 7267 6520 6261 7463 6820 6469 6d73 2061  rge batch dims a
-00010c30: 6c6c 2074 6f67 6574 6865 720a 2020 2020  ll together.    
-00010c40: 2020 2020 2020 2020 2020 2020 5b2d 312c              [-1,
-00010c50: 2069 6e5f 6469 6d2e 6765 745f 6469 6d5f   in_dim.get_dim_
-00010c60: 7661 6c75 6528 295d 202b 205b 642e 6765  value()] + [d.ge
-00010c70: 745f 6469 6d5f 7661 6c75 6528 2920 666f  t_dim_value() fo
-00010c80: 7220 6420 696e 2069 6e5f 7370 6174 6961  r d in in_spatia
-00010c90: 6c5f 6469 6d73 5d2c 0a20 2020 2020 2020  l_dims],.       
-00010ca0: 2020 2020 2029 0a20 2020 2020 2020 2075       ).        u
-00010cb0: 7365 5f73 7472 6964 696e 6720 3d20 7374  se_striding = st
-00010cc0: 7269 6465 7320 616e 6420 2873 7472 6964  rides and (strid
-00010cd0: 6573 203e 2031 2069 6620 6973 696e 7374  es > 1 if isinst
-00010ce0: 616e 6365 2873 7472 6964 6573 2c20 696e  ance(strides, in
-00010cf0: 7429 2065 6c73 6520 616e 7928 7320 3e20  t) else any(s > 
-00010d00: 3120 666f 7220 7320 696e 2073 7472 6964  1 for s in strid
-00010d10: 6573 2929 0a20 2020 2020 2020 2069 6620  es)).        if 
-00010d20: 7061 6464 696e 6720 3d3d 2022 7361 6d65  padding == "same
-00010d30: 2220 616e 6420 6e6f 7420 7573 655f 7374  " and not use_st
-00010d40: 7269 6469 6e67 2061 6e64 2061 6c6c 2864  riding and all(d
-00010d50: 2e64 696d 656e 7369 6f6e 2025 2032 203d  .dimension % 2 =
-00010d60: 3d20 3120 666f 7220 6420 696e 2066 696c  = 1 for d in fil
-00010d70: 7465 725f 7369 7a65 293a 0a20 2020 2020  ter_size):.     
-00010d80: 2020 2020 2020 2069 6620 616c 6c28 6669         if all(fi
-00010d90: 6c74 6572 5f73 697a 655b 305d 2e64 696d  lter_size[0].dim
-00010da0: 656e 7369 6f6e 203d 3d20 642e 6469 6d65  ension == d.dime
-00010db0: 6e73 696f 6e20 666f 7220 6420 696e 2066  nsion for d in f
-00010dc0: 696c 7465 725f 7369 7a65 293a 2020 2320  ilter_size):  # 
-00010dd0: 616c 6c20 7361 6d65 0a20 2020 2020 2020  all same.       
-00010de0: 2020 2020 2020 2020 2070 6164 6469 6e67           padding
-00010df0: 203d 2028 6669 6c74 6572 5f73 697a 655b   = (filter_size[
-00010e00: 305d 2e64 696d 656e 7369 6f6e 202d 2031  0].dimension - 1
-00010e10: 2920 2f2f 2032 0a20 2020 2020 2020 2020  ) // 2.         
-00010e20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00010e30: 2020 2020 2020 2020 2070 6164 6469 6e67           padding
-00010e40: 203d 2074 7570 6c65 2864 2e64 696d 656e   = tuple(d.dimen
-00010e50: 7369 6f6e 202f 2f20 3220 666f 7220 6420  sion // 2 for d 
-00010e60: 696e 2066 696c 7465 725f 7369 7a65 290a  in filter_size).
-00010e70: 2020 2020 2020 2020 6966 2070 6164 6469          if paddi
-00010e80: 6e67 203d 3d20 2273 616d 6522 2061 6e64  ng == "same" and
-00010e90: 2028 7573 655f 7374 7269 6469 6e67 206f   (use_striding o
-00010ea0: 7220 746f 7263 682e 6f6e 6e78 2e69 735f  r torch.onnx.is_
-00010eb0: 696e 5f6f 6e6e 785f 6578 706f 7274 2829  in_onnx_export()
-00010ec0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-00010ed0: 2070 6164 6469 6e67 3d27 7361 6d65 2720   padding='same' 
-00010ee0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
-00010ef0: 2066 6f72 2073 7472 6964 6564 2063 6f6e   for strided con
-00010f00: 766f 6c75 7469 6f6e 732e 0a20 2020 2020  volutions..     
-00010f10: 2020 2020 2020 2023 204d 6f72 656f 7665         # Moreove
-00010f20: 722c 2070 6164 6469 6e67 2073 7065 6369  r, padding speci
-00010f30: 6669 6564 2061 7320 6120 7374 7269 6e67  fied as a string
-00010f40: 2069 736e 2774 2073 7570 706f 7274 6564   isn't supported
-00010f50: 2066 6f72 204f 4e4e 5820 6578 706f 7274   for ONNX export
-00010f60: 696e 6720 6173 206f 6620 3230 3233 2f30  ing as of 2023/0
-00010f70: 352f 3139 2e0a 2020 2020 2020 2020 2020  5/19..          
-00010f80: 2020 2320 4d61 6e75 616c 2061 6464 2074    # Manual add t
-00010f90: 6865 2070 6164 6469 6e67 2c20 616e 6420  he padding, and 
-00010fa0: 7468 656e 2064 6f20 6e6f 7420 7573 6520  then do not use 
-00010fb0: 616e 7920 7061 6464 696e 6720 696e 2074  any padding in t
-00010fc0: 6865 2063 6f6e 762e 0a20 2020 2020 2020  he conv..       
-00010fd0: 2020 2020 2070 6164 6469 6e67 203d 2030       padding = 0
-00010fe0: 0a20 2020 2020 2020 2020 2020 2070 6164  .            pad
-00010ff0: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
-00011000: 2020 2066 6f72 2069 2c20 7320 696e 2072     for i, s in r
-00011010: 6576 6572 7365 6428 6c69 7374 2865 6e75  eversed(list(enu
-00011020: 6d65 7261 7465 2866 696c 7465 725f 7369  merate(filter_si
-00011030: 7a65 2929 293a 0a20 2020 2020 2020 2020  ze))):.         
-00011040: 2020 2020 2020 2069 6620 7573 655f 7374         if use_st
-00011050: 7269 6469 6e67 3a0a 2020 2020 2020 2020  riding:.        
-00011060: 2020 2020 2020 2020 2020 2020 7374 7269              stri
-00011070: 6465 5f20 3d20 7374 7269 6465 735b 695d  de_ = strides[i]
-00011080: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-00011090: 7472 6964 6573 2c20 286c 6973 742c 2074  trides, (list, t
-000110a0: 7570 6c65 2929 2065 6c73 6520 7374 7269  uple)) else stri
-000110b0: 6465 730a 2020 2020 2020 2020 2020 2020  des.            
-000110c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000110d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000110e0: 7269 6465 5f20 3d20 310a 2020 2020 2020  ride_ = 1.      
-000110f0: 2020 2020 2020 2020 2020 2320 5768 6174            # What
-00011100: 2069 7320 7468 6520 6c6f 6769 6320 6865   is the logic he
-00011110: 7265 3f20 596f 7520 6d69 6768 7420 6265  re? You might be
-00011120: 2061 7761 7265 2c20 696e 2063 6173 6520   aware, in case 
-00011130: 7769 7468 6f75 7420 7374 7269 6469 6e67  without striding
-00011140: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011150: 2020 2320 7765 2073 696d 706c 7920 6861    # we simply ha
-00011160: 7665 2070 6164 5f6c 6566 7420 3d20 2873  ve pad_left = (s
-00011170: 2e64 696d 656e 7369 6f6e 202d 2031 2920  .dimension - 1) 
-00011180: 2f2f 2032 2c0a 2020 2020 2020 2020 2020  // 2,.          
-00011190: 2020 2020 2020 2320 6f72 2074 6865 2074        # or the t
-000111a0: 6f74 616c 2061 6d6f 756e 7420 6f66 2070  otal amount of p
-000111b0: 6164 6469 6e67 2069 7320 732e 6469 6d65  adding is s.dime
-000111c0: 6e73 696f 6e20 2d20 312e 0a20 2020 2020  nsion - 1..     
-000111d0: 2020 2020 2020 2020 2020 2023 2053 6f20             # So 
-000111e0: 7765 2061 6464 2074 6865 2073 616d 6520  we add the same 
-000111f0: 616d 6f75 6e74 206f 6620 7061 6464 696e  amount of paddin
-00011200: 6720 6f6e 2062 6f74 6820 7369 6465 7320  g on both sides 
-00011210: 286f 7220 6f6e 6520 6c65 7373 206f 6e20  (or one less on 
-00011220: 7468 6520 6c65 6674 2073 6964 6520 6966  the left side if
-00011230: 206f 6464 292e 0a20 2020 2020 2020 2020   odd)..         
-00011240: 2020 2020 2020 2023 2054 6865 206f 7574         # The out
-00011250: 7075 7420 7365 7120 6c65 6e67 7468 2069  put seq length i
-00011260: 6e20 6361 7365 206f 6620 2276 616c 6964  n case of "valid
-00011270: 2220 7061 6464 696e 6720 6973 20e2 8c88  " padding is ...
-00011280: 2869 6e5f 6c65 6e20 2d20 732e 6469 6d65  (in_len - s.dime
-00011290: 6e73 696f 6e20 2b20 3129 202f 2073 7472  nsion + 1) / str
-000112a0: 6964 65e2 8c89 2e0a 2020 2020 2020 2020  ide.....        
-000112b0: 2020 2020 2020 2020 2320 5468 6520 6f75          # The ou
-000112c0: 7470 7574 2073 6571 206c 656e 6774 6820  tput seq length 
-000112d0: 696e 2063 6173 6520 6f66 2022 7361 6d65  in case of "same
-000112e0: 2220 7061 6464 696e 6720 7769 7468 206e  " padding with n
-000112f0: 6f20 7374 7269 6469 6e67 2028 7374 7269  o striding (stri
-00011300: 6465 203d 2031 290a 2020 2020 2020 2020  de = 1).        
-00011310: 2020 2020 2020 2020 2320 6973 2073 696d          # is sim
-00011320: 706c 7920 7468 6520 7361 6d65 2061 7320  ply the same as 
-00011330: 7468 6520 696e 7075 7420 6c65 6e67 7468  the input length
-00011340: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00011350: 2020 2320 5768 6174 2069 7320 7468 6520    # What is the 
-00011360: 6f75 7470 7574 2073 6571 206c 656e 6774  output seq lengt
-00011370: 6820 696e 2063 6173 6520 6f66 2022 7361  h in case of "sa
-00011380: 6d65 2220 7061 6464 696e 6720 7769 7468  me" padding with
-00011390: 2073 7472 6964 696e 673f 0a20 2020 2020   striding?.     
-000113a0: 2020 2020 2020 2020 2020 2023 2049 7420             # It 
-000113b0: 7368 6f75 6c64 2062 6520 e28c 8869 6e5f  should be ...in_
-000113c0: 6c65 6e20 2f20 7374 7269 6465 e28c 892e  len / stride....
-000113d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000113e0: 2023 2053 6f2c 2074 6865 6e20 7765 206e   # So, then we n
-000113f0: 6565 6420 746f 2061 6464 2061 2074 6f74  eed to add a tot
-00011400: 616c 2061 6d6f 756e 7420 6f66 2070 6164  al amount of pad
-00011410: 6469 6e67 206f 6620 732e 6469 6d65 6e73  ding of s.dimens
-00011420: 696f 6e20 2d20 312e 0a20 2020 2020 2020  ion - 1..       
-00011430: 2020 2020 2020 2020 2023 2048 6f77 6576           # Howev
-00011440: 6572 2c20 646f 696e 6720 6974 2074 6865  er, doing it the
-00011450: 2073 616d 6520 7761 7920 6173 2077 6974   same way as wit
-00011460: 686f 7574 2073 7472 6964 696e 6720 6973  hout striding is
-00011470: 2069 6e63 6f72 7265 6374 2e0a 2020 2020   incorrect..    
-00011480: 2020 2020 2020 2020 2020 2020 2320 5768              # Wh
-00011490: 793f 2042 6563 6175 7365 2074 6865 6e20  y? Because then 
-000114a0: 7468 6520 6669 7273 7420 7769 6e64 6f77  the first window
-000114b0: 206d 6967 6874 2068 6176 6520 6d6f 7265   might have more
-000114c0: 2070 6164 6469 6e67 2074 6861 6e20 7468   padding than th
-000114d0: 6520 6669 6e61 6c20 7769 6e64 6f77 2e0a  e final window..
-000114e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114f0: 2320 4275 7420 7765 2077 616e 7420 746f  # But we want to
-00011500: 2068 6176 6520 616e 2065 7665 6e20 616d   have an even am
-00011510: 6f75 6e74 206f 6620 7061 6464 696e 6720  ount of padding 
-00011520: 6f6e 2074 6865 2066 6972 7374 2061 6e64  on the first and
-00011530: 206c 6173 7420 7769 6e64 6f77 2c0a 2020   last window,.  
-00011540: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00011550: 6f72 206d 6179 6265 206f 6e65 206c 6573  or maybe one les
-00011560: 7320 6f6e 2074 6865 2066 6972 7374 2077  s on the first w
-00011570: 696e 646f 7720 6966 206f 6464 2e0a 2020  indow if odd..  
-00011580: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00011590: 486f 7720 6d61 6e79 2066 7261 6d65 7320  How many frames 
-000115a0: 646f 2074 6865 2077 696e 646f 7773 2063  do the windows c
-000115b0: 6f76 6572 3f0a 2020 2020 2020 2020 2020  over?.          
-000115c0: 2020 2020 2020 2320 696e 5f6c 656e 5f63        # in_len_c
-000115d0: 6f76 6572 6564 203d 206f 7574 5f6c 656e  overed = out_len
-000115e0: 202a 2073 7472 6964 6520 2b20 2873 2e64   * stride + (s.d
-000115f0: 696d 656e 7369 6f6e 202d 2073 7472 6964  imension - strid
-00011600: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00011610: 2020 2023 2057 6520 6361 6e20 7265 7772     # We can rewr
-00011620: 6974 6520 6f75 745f 6c65 6e20 6173 3a0a  ite out_len as:.
-00011630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011640: 2320 6f75 745f 6c65 6e20 3d20 e28c 8a28  # out_len = ...(
-00011650: 696e 5f6c 656e 202b 2073 7472 6964 6520  in_len + stride 
-00011660: 2d20 3129 202f 2073 7472 6964 65e2 8c8b  - 1) / stride...
-00011670: 203d 2028 696e 5f6c 656e 202b 2073 7472   = (in_len + str
-00011680: 6964 6520 2d20 3120 2d20 2869 6e5f 6c65  ide - 1 - (in_le
-00011690: 6e20 2d20 3129 2025 2073 7472 6964 6529  n - 1) % stride)
-000116a0: 202f 2073 7472 6964 650a 2020 2020 2020   / stride.      
-000116b0: 2020 2020 2020 2020 2020 2320 536f 2077            # So w
-000116c0: 6520 6861 7665 3a0a 2020 2020 2020 2020  e have:.        
-000116d0: 2020 2020 2020 2020 2320 696e 5f6c 656e          # in_len
-000116e0: 5f63 6f76 6572 6564 203d 2028 696e 5f6c  _covered = (in_l
-000116f0: 656e 202b 2073 7472 6964 6520 2d20 3120  en + stride - 1 
-00011700: 2d20 2869 6e5f 6c65 6e20 2d20 3129 2025  - (in_len - 1) %
-00011710: 2073 7472 6964 6529 202b 2028 732e 6469   stride) + (s.di
-00011720: 6d65 6e73 696f 6e20 2d20 7374 7269 6465  mension - stride
-00011730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011740: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-00011750: 2020 203d 2069 6e5f 6c65 6e20 2b20 732e     = in_len + s.
-00011760: 6469 6d65 6e73 696f 6e20 2d20 3120 2d20  dimension - 1 - 
-00011770: 2869 6e5f 6c65 6e20 2d20 3129 2025 2073  (in_len - 1) % s
-00011780: 7472 6964 650a 2020 2020 2020 2020 2020  tride.          
-00011790: 2020 2020 2020 2320 4e6f 772c 2074 6865        # Now, the
-000117a0: 2061 6d6f 756e 7420 6f66 2070 6164 6469   amount of paddi
-000117b0: 6e67 2077 6869 6368 2061 6374 7561 6c6c  ng which actuall
-000117c0: 7920 6d61 7474 6572 7320 6973 3a0a 2020  y matters is:.  
-000117d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000117e0: 7061 6420 3d20 696e 5f6c 656e 5f63 6f76  pad = in_len_cov
-000117f0: 6572 6564 202d 2069 6e5f 6c65 6e20 3d20  ered - in_len = 
-00011800: 732e 6469 6d65 6e73 696f 6e20 2d20 3120  s.dimension - 1 
-00011810: 2d20 2869 6e5f 6c65 6e20 2d20 3129 2025  - (in_len - 1) %
-00011820: 2073 7472 6964 652e 0a20 2020 2020 2020   stride..       
-00011830: 2020 2020 2020 2020 2070 6164 203d 2073           pad = s
-00011840: 2e64 696d 656e 7369 6f6e 202d 2031 202d  .dimension - 1 -
-00011850: 2028 7372 635f 7261 772e 7368 6170 655b   (src_raw.shape[
-00011860: 3220 2b20 695d 202d 2031 2920 2520 7374  2 + i] - 1) % st
-00011870: 7269 6465 5f0a 2020 2020 2020 2020 2020  ride_.          
-00011880: 2020 2020 2020 7061 645f 6c65 6674 203d        pad_left =
-00011890: 2070 6164 202f 2f20 320a 2020 2020 2020   pad // 2.      
-000118a0: 2020 2020 2020 2020 2020 7061 645f 7269            pad_ri
-000118b0: 6768 7420 3d20 7061 6420 2d20 7061 645f  ght = pad - pad_
-000118c0: 6c65 6674 0a20 2020 2020 2020 2020 2020  left.           
-000118d0: 2020 2020 2070 6164 732e 6578 7465 6e64       pads.extend
-000118e0: 285b 7061 645f 6c65 6674 2c20 7061 645f  ([pad_left, pad_
-000118f0: 7269 6768 745d 290a 2020 2020 2020 2020  right]).        
-00011900: 2020 2020 7372 635f 7261 7720 3d20 746f      src_raw = to
-00011910: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-00011920: 6c2e 7061 6428 7372 635f 7261 772c 2070  l.pad(src_raw, p
-00011930: 6164 7329 0a20 2020 2020 2020 2069 6620  ads).        if 
-00011940: 7061 6464 696e 6720 3d3d 2022 7661 6c69  padding == "vali
-00011950: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-00011960: 2320 7061 6464 696e 6720 6173 2073 7472  # padding as str
-00011970: 696e 6720 6973 206e 6f74 2073 7570 706f  ing is not suppo
-00011980: 7274 6564 2065 2e67 2e20 696e 204f 4e4e  rted e.g. in ONN
-00011990: 582e 0a20 2020 2020 2020 2020 2020 2070  X..            p
-000119a0: 6164 6469 6e67 203d 2030 0a20 2020 2020  adding = 0.     
-000119b0: 2020 2069 6620 6c65 6e28 6669 6c74 6572     if len(filter
-000119c0: 5f73 697a 6529 203d 3d20 313a 0a20 2020  _size) == 1:.   
-000119d0: 2020 2020 2020 2020 2023 2054 6865 7265           # There
-000119e0: 2069 7320 616c 736f 2063 6f6e 765f 7462   is also conv_tb
-000119f0: 632c 2062 7574 2069 7427 7320 6120 6269  c, but it's a bi
-00011a00: 7420 6c69 6d69 7465 6420 286e 6f20 6469  t limited (no di
-00011a10: 6c61 7469 6f6e 290a 2020 2020 2020 2020  lation).        
-00011a20: 2020 2020 2320 616e 6420 616c 736f 2075      # and also u
-00011a30: 6e63 6c65 6172 2077 6865 6e20 6578 6163  nclear when exac
-00011a40: 746c 7920 6974 2069 7320 6661 7374 6572  tly it is faster
-00011a50: 2e0a 2020 2020 2020 2020 2020 2020 6f75  ..            ou
-00011a60: 745f 7261 7720 3d20 746f 7263 682e 6e6e  t_raw = torch.nn
-00011a70: 2e66 756e 6374 696f 6e61 6c2e 636f 6e76  .functional.conv
-00011a80: 3164 280a 2020 2020 2020 2020 2020 2020  1d(.            
-00011a90: 2020 2020 7372 635f 7261 772c 0a20 2020      src_raw,.   
-00011aa0: 2020 2020 2020 2020 2020 2020 2077 6569               wei
-00011ab0: 6768 743d 6669 6c74 6572 2e72 6177 5f74  ght=filter.raw_t
-00011ac0: 656e 736f 722c 0a20 2020 2020 2020 2020  ensor,.         
-00011ad0: 2020 2020 2020 2062 6961 733d 6269 6173         bias=bias
-00011ae0: 2e72 6177 5f74 656e 736f 7220 6966 2062  .raw_tensor if b
-00011af0: 6961 7320 6973 206e 6f74 204e 6f6e 6520  ias is not None 
-00011b00: 656c 7365 204e 6f6e 652c 0a20 2020 2020  else None,.     
-00011b10: 2020 2020 2020 2020 2020 2073 7472 6964             strid
-00011b20: 653d 7374 7269 6465 7320 6f72 2031 2c0a  e=strides or 1,.
-00011b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b40: 7061 6464 696e 673d 7061 6464 696e 672c  padding=padding,
-00011b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011b60: 2064 696c 6174 696f 6e3d 6469 6c61 7469   dilation=dilati
-00011b70: 6f6e 5f72 6174 6520 6f72 2031 2c0a 2020  on_rate or 1,.  
-00011b80: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00011b90: 6f75 7073 3d67 726f 7570 7320 6f72 2031  oups=groups or 1
-00011ba0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00011bb0: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-00011bc0: 2866 696c 7465 725f 7369 7a65 2920 3d3d  (filter_size) ==
-00011bd0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-00011be0: 6f75 745f 7261 7720 3d20 746f 7263 682e  out_raw = torch.
-00011bf0: 6e6e 2e66 756e 6374 696f 6e61 6c2e 636f  nn.functional.co
-00011c00: 6e76 3264 280a 2020 2020 2020 2020 2020  nv2d(.          
-00011c10: 2020 2020 2020 7372 635f 7261 772c 0a20        src_raw,. 
-00011c20: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00011c30: 6569 6768 743d 6669 6c74 6572 2e72 6177  eight=filter.raw
-00011c40: 5f74 656e 736f 722c 0a20 2020 2020 2020  _tensor,.       
-00011c50: 2020 2020 2020 2020 2062 6961 733d 6269           bias=bi
-00011c60: 6173 2e72 6177 5f74 656e 736f 7220 6966  as.raw_tensor if
-00011c70: 2062 6961 7320 6973 206e 6f74 204e 6f6e   bias is not Non
-00011c80: 6520 656c 7365 204e 6f6e 652c 0a20 2020  e else None,.   
-00011c90: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00011ca0: 6964 653d 7374 7269 6465 7320 6f72 2031  ide=strides or 1
-00011cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011cc0: 2020 7061 6464 696e 673d 7061 6464 696e    padding=paddin
-00011cd0: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-00011ce0: 2020 2064 696c 6174 696f 6e3d 6469 6c61     dilation=dila
-00011cf0: 7469 6f6e 5f72 6174 6520 6f72 2031 2c0a  tion_rate or 1,.
-00011d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d10: 6772 6f75 7073 3d67 726f 7570 7320 6f72  groups=groups or
-00011d20: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-00011d30: 290a 2020 2020 2020 2020 656c 6966 206c  ).        elif l
-00011d40: 656e 2866 696c 7465 725f 7369 7a65 2920  en(filter_size) 
-00011d50: 3d3d 2033 3a0a 2020 2020 2020 2020 2020  == 3:.          
-00011d60: 2020 6f75 745f 7261 7720 3d20 746f 7263    out_raw = torc
-00011d70: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
-00011d80: 636f 6e76 3364 280a 2020 2020 2020 2020  conv3d(.        
-00011d90: 2020 2020 2020 2020 7372 635f 7261 772c          src_raw,
-00011da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011db0: 2077 6569 6768 743d 6669 6c74 6572 2e72   weight=filter.r
-00011dc0: 6177 5f74 656e 736f 722c 0a20 2020 2020  aw_tensor,.     
-00011dd0: 2020 2020 2020 2020 2020 2062 6961 733d             bias=
-00011de0: 6269 6173 2e72 6177 5f74 656e 736f 7220  bias.raw_tensor 
-00011df0: 6966 2062 6961 7320 6973 206e 6f74 204e  if bias is not N
-00011e00: 6f6e 6520 656c 7365 204e 6f6e 652c 0a20  one else None,. 
-00011e10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00011e20: 7472 6964 653d 7374 7269 6465 7320 6f72  tride=strides or
-00011e30: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-00011e40: 2020 2020 7061 6464 696e 673d 7061 6464      padding=padd
-00011e50: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-00011e60: 2020 2020 2064 696c 6174 696f 6e3d 6469       dilation=di
-00011e70: 6c61 7469 6f6e 5f72 6174 6520 6f72 2031  lation_rate or 1
-00011e80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011e90: 2020 6772 6f75 7073 3d67 726f 7570 7320    groups=groups 
-00011ea0: 6f72 2031 2c0a 2020 2020 2020 2020 2020  or 1,.          
-00011eb0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-00011ec0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00011ed0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00011ee0: 2269 6e76 616c 6964 206e 756d 6265 7220  "invalid number 
-00011ef0: 6f66 2066 696c 7465 7220 6469 6d73 207b  of filter dims {
-00011f00: 6669 6c74 6572 5f73 697a 657d 2c20 6578  filter_size}, ex
-00011f10: 7065 6374 6564 2031 2c20 322c 206f 7220  pected 1, 2, or 
-00011f20: 3322 290a 2020 2020 2020 2020 6f75 7420  3").        out 
-00011f30: 3d20 5465 6e73 6f72 280a 2020 2020 2020  = Tensor(.      
-00011f40: 2020 2020 2020 2263 6f6e 7622 2c20 6469        "conv", di
-00011f50: 6d73 3d62 6174 6368 5f64 696d 7320 2b20  ms=batch_dims + 
-00011f60: 5b6f 7574 5f64 696d 5d20 2b20 6c69 7374  [out_dim] + list
-00011f70: 286f 7574 5f73 7061 7469 616c 5f64 696d  (out_spatial_dim
-00011f80: 7329 2c20 6474 7970 653d 546f 7263 6842  s), dtype=TorchB
-00011f90: 6163 6b65 6e64 2e67 6574 5f64 7479 7065  ackend.get_dtype
-00011fa0: 5f6e 616d 655f 7261 7728 6f75 745f 7261  _name_raw(out_ra
-00011fb0: 7729 0a20 2020 2020 2020 2029 0a20 2020  w).        ).   
-00011fc0: 2020 2020 2069 6620 6c65 6e28 6261 7463       if len(batc
-00011fd0: 685f 6469 6d73 2920 3d3d 2031 3a0a 2020  h_dims) == 1:.  
-00011fe0: 2020 2020 2020 2020 2020 6f75 742e 7261            out.ra
-00011ff0: 775f 7465 6e73 6f72 203d 206f 7574 5f72  w_tensor = out_r
-00012000: 6177 0a20 2020 2020 2020 2065 6c73 653a  aw.        else:
-00012010: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00012020: 2e72 6177 5f74 656e 736f 7220 3d20 746f  .raw_tensor = to
-00012030: 7263 682e 7265 7368 6170 6528 6f75 745f  rch.reshape(out_
-00012040: 7261 772c 205b 642e 6765 745f 6469 6d5f  raw, [d.get_dim_
-00012050: 7661 6c75 6528 2920 666f 7220 6420 696e  value() for d in
-00012060: 206f 7574 2e64 696d 735d 290a 2020 2020   out.dims]).    
-00012070: 2020 2020 6f75 742e 6665 6174 7572 655f      out.feature_
-00012080: 6469 6d20 3d20 6f75 745f 6469 6d0a 2020  dim = out_dim.  
-00012090: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-000120a0: 2c20 6f75 745f 7370 6174 6961 6c5f 6469  , out_spatial_di
-000120b0: 6d73 0a0a 2020 2020 4073 7461 7469 636d  ms..    @staticm
-000120c0: 6574 686f 640a 2020 2020 6465 6620 706f  ethod.    def po
-000120d0: 6f6c 280a 2020 2020 2020 2020 736f 7572  ol(.        sour
-000120e0: 6365 3a20 5465 6e73 6f72 2c0a 2020 2020  ce: Tensor,.    
-000120f0: 2020 2020 2a2c 0a20 2020 2020 2020 206d      *,.        m
-00012100: 6f64 653a 2073 7472 2c0a 2020 2020 2020  ode: str,.      
-00012110: 2020 706f 6f6c 5f73 697a 653a 2053 6571    pool_size: Seq
-00012120: 7565 6e63 655b 696e 745d 2c0a 2020 2020  uence[int],.    
-00012130: 2020 2020 7061 6464 696e 673a 2073 7472      padding: str
-00012140: 203d 2022 7661 6c69 6422 2c0a 2020 2020   = "valid",.    
-00012150: 2020 2020 6469 6c61 7469 6f6e 5f72 6174      dilation_rat
-00012160: 653a 2055 6e69 6f6e 5b53 6571 7565 6e63  e: Union[Sequenc
-00012170: 655b 696e 745d 2c20 696e 745d 203d 2031  e[int], int] = 1
-00012180: 2c0a 2020 2020 2020 2020 7374 7269 6465  ,.        stride
-00012190: 733a 2053 6571 7565 6e63 655b 696e 745d  s: Sequence[int]
-000121a0: 2c0a 2020 2020 2020 2020 696e 5f73 7061  ,.        in_spa
-000121b0: 7469 616c 5f64 696d 733a 2053 6571 7565  tial_dims: Seque
-000121c0: 6e63 655b 4469 6d5d 2c0a 2020 2020 2020  nce[Dim],.      
-000121d0: 2020 6f75 745f 7370 6174 6961 6c5f 6469    out_spatial_di
-000121e0: 6d73 3a20 4f70 7469 6f6e 616c 5b53 6571  ms: Optional[Seq
-000121f0: 7565 6e63 655b 4469 6d5d 5d20 3d20 4e6f  uence[Dim]] = No
-00012200: 6e65 2c0a 2020 2020 2920 2d3e 2054 7570  ne,.    ) -> Tup
-00012210: 6c65 5b54 656e 736f 722c 2053 6571 7565  le[Tensor, Seque
-00012220: 6e63 655b 4469 6d5d 5d3a 0a20 2020 2020  nce[Dim]]:.     
-00012230: 2020 2022 2222 706f 6f6c 2222 220a 2020     """pool""".  
-00012240: 2020 2020 2020 6966 206f 7574 5f73 7061        if out_spa
-00012250: 7469 616c 5f64 696d 7320 6973 204e 6f6e  tial_dims is Non
-00012260: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
-00012270: 7574 5f73 7061 7469 616c 5f64 696d 7320  ut_spatial_dims 
-00012280: 3d20 7266 2e6d 616b 655f 636f 6e76 5f6f  = rf.make_conv_o
-00012290: 7574 5f73 7061 7469 616c 5f64 696d 7328  ut_spatial_dims(
-000122a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000122b0: 2069 6e5f 7370 6174 6961 6c5f 6469 6d73   in_spatial_dims
-000122c0: 3d69 6e5f 7370 6174 6961 6c5f 6469 6d73  =in_spatial_dims
-000122d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000122e0: 2020 6669 6c74 6572 5f73 697a 653d 706f    filter_size=po
-000122f0: 6f6c 5f73 697a 652c 0a20 2020 2020 2020  ol_size,.       
-00012300: 2020 2020 2020 2020 2073 7472 6964 6573           strides
-00012310: 3d73 7472 6964 6573 2c0a 2020 2020 2020  =strides,.      
-00012320: 2020 2020 2020 2020 2020 6469 6c61 7469            dilati
-00012330: 6f6e 5f72 6174 653d 6469 6c61 7469 6f6e  on_rate=dilation
-00012340: 5f72 6174 652c 0a20 2020 2020 2020 2020  _rate,.         
-00012350: 2020 2020 2020 2070 6164 6469 6e67 3d70         padding=p
-00012360: 6164 6469 6e67 2c0a 2020 2020 2020 2020  adding,.        
-00012370: 2020 2020 290a 2020 2020 2020 2020 6261      ).        ba
-00012380: 7463 685f 6469 6d73 203d 205b 6420 666f  tch_dims = [d fo
-00012390: 7220 6420 696e 2073 6f75 7263 652e 6469  r d in source.di
-000123a0: 6d73 2069 6620 6420 6e6f 7420 696e 2074  ms if d not in t
-000123b0: 7570 6c65 2869 6e5f 7370 6174 6961 6c5f  uple(in_spatial_
-000123c0: 6469 6d73 295d 0a20 2020 2020 2020 2023  dims)].        #
-000123d0: 2054 6f72 6368 2063 6f6e 7620 6578 7065   Torch conv expe
-000123e0: 6374 7320 284e 2c43 2c3c 7370 6174 6961  cts (N,C,<spatia
-000123f0: 6c20 6469 6d73 3e29 2061 7320 7368 6170  l dims>) as shap
-00012400: 652e 0a20 2020 2020 2020 2023 2062 6174  e..        # bat
-00012410: 6368 5f64 696d 7320 776f 756c 6420 6163  ch_dims would ac
-00012420: 7475 616c 6c79 2063 6f76 6572 2074 6865  tually cover the
-00012430: 2063 6861 6e6e 656c 2d64 696d 2028 4329   channel-dim (C)
-00012440: 2061 7320 7765 6c6c 2c0a 2020 2020 2020   as well,.      
-00012450: 2020 2320 6173 2069 7420 646f 6573 206e    # as it does n
-00012460: 6f74 2072 6561 6c6c 7920 6d61 7474 6572  ot really matter
-00012470: 2074 6f20 6469 6666 6572 656e 7469 6174   to differentiat
-00012480: 6520 6974 2066 726f 6d20 6f74 6865 7220  e it from other 
-00012490: 6261 7463 6820 6469 6d73 2e0a 2020 2020  batch dims..    
-000124a0: 2020 2020 736f 7572 6365 203d 2073 6f75      source = sou
-000124b0: 7263 652e 636f 7079 5f74 7261 6e73 706f  rce.copy_transpo
-000124c0: 7365 2862 6174 6368 5f64 696d 7320 2b20  se(batch_dims + 
-000124d0: 6c69 7374 2869 6e5f 7370 6174 6961 6c5f  list(in_spatial_
-000124e0: 6469 6d73 2929 0a20 2020 2020 2020 2073  dims)).        s
-000124f0: 7263 5f72 6177 203d 2074 6f72 6368 2e72  rc_raw = torch.r
-00012500: 6573 6861 7065 280a 2020 2020 2020 2020  eshape(.        
-00012510: 2020 2020 736f 7572 6365 2e72 6177 5f74      source.raw_t
-00012520: 656e 736f 722c 0a20 2020 2020 2020 2020  ensor,.         
-00012530: 2020 2023 2050 6f74 656e 7469 616c 6c79     # Potentially
-00012540: 206d 6572 6765 2062 6174 6368 2064 696d   merge batch dim
-00012550: 7320 616c 6c20 746f 6765 7468 6572 2e0a  s all together..
-00012560: 2020 2020 2020 2020 2020 2020 2320 4b65              # Ke
-00012570: 6570 2074 6865 206c 6173 7420 6173 2074  ep the last as t
-00012580: 6865 2063 6861 6e6e 656c 2d64 696d 2c20  he channel-dim, 
-00012590: 6275 7420 6e6f 7420 7375 7265 2069 6620  but not sure if 
-000125a0: 7468 6973 2069 7320 7265 616c 6c79 2072  this is really r
-000125b0: 656c 6576 616e 742e 0a20 2020 2020 2020  elevant..       
-000125c0: 2020 2020 205b 2d31 2c20 6261 7463 685f       [-1, batch_
-000125d0: 6469 6d73 5b2d 315d 2e67 6574 5f64 696d  dims[-1].get_dim
-000125e0: 5f76 616c 7565 2829 2069 6620 6261 7463  _value() if batc
-000125f0: 685f 6469 6d73 2065 6c73 6520 315d 202b  h_dims else 1] +
-00012600: 205b 642e 6765 745f 6469 6d5f 7661 6c75   [d.get_dim_valu
-00012610: 6528 2920 666f 7220 6420 696e 2069 6e5f  e() for d in in_
-00012620: 7370 6174 6961 6c5f 6469 6d73 5d2c 0a20  spatial_dims],. 
-00012630: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00012640: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00012650: 6365 2873 7472 6964 6573 2c20 286c 6973  ce(strides, (lis
-00012660: 742c 2074 7570 6c65 2929 2061 6e64 206c  t, tuple)) and l
-00012670: 656e 2873 7472 6964 6573 2920 3d3d 206c  en(strides) == l
-00012680: 656e 2869 6e5f 7370 6174 6961 6c5f 6469  en(in_spatial_di
-00012690: 6d73 2920 3d3d 206c 656e 2870 6f6f 6c5f  ms) == len(pool_
-000126a0: 7369 7a65 290a 2020 2020 2020 2020 6966  size).        if
-000126b0: 2070 6164 6469 6e67 2e6c 6f77 6572 2829   padding.lower()
-000126c0: 203d 3d20 2273 616d 6522 3a0a 2020 2020   == "same":.    
-000126d0: 2020 2020 2020 2020 2320 7061 6464 696e          # paddin
-000126e0: 673d 2773 616d 6527 2069 7320 6e6f 7420  g='same' is not 
-000126f0: 7175 6974 6520 7468 6520 7361 6d65 2061  quite the same a
-00012700: 7320 6365 696c 5f6d 6f64 653d 5472 7565  s ceil_mode=True
-00012710: 2c20 736f 2077 6520 6578 706c 6963 6974  , so we explicit
-00012720: 6c79 2070 6164 2068 6572 652e 0a20 2020  ly pad here..   
-00012730: 2020 2020 2020 2020 2070 6164 6469 6e67           padding
-00012740: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00012750: 2020 666f 7220 692c 2073 2069 6e20 656e    for i, s in en
-00012760: 756d 6572 6174 6528 706f 6f6c 5f73 697a  umerate(pool_siz
-00012770: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00012780: 2020 2020 2320 5365 6520 636f 6d6d 656e      # See commen
-00012790: 7420 696e 2063 6f6e 762e 0a20 2020 2020  t in conv..     
-000127a0: 2020 2020 2020 2020 2020 2070 6164 203d             pad =
-000127b0: 2073 202d 2031 202d 2028 7372 635f 7261   s - 1 - (src_ra
-000127c0: 772e 7368 6170 655b 3220 2b20 695d 202d  w.shape[2 + i] -
-000127d0: 2031 2920 2520 7374 7269 6465 735b 695d   1) % strides[i]
-000127e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000127f0: 2070 6164 6469 6e67 2e61 7070 656e 6428   padding.append(
-00012800: 7061 6420 2f2f 2032 290a 2020 2020 2020  pad // 2).      
-00012810: 2020 2020 2020 6365 696c 5f6d 6f64 6520        ceil_mode 
-00012820: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
-00012830: 6c69 6620 7061 6464 696e 672e 6c6f 7765  lif padding.lowe
-00012840: 7228 2920 3d3d 2022 7661 6c69 6422 3a0a  r() == "valid":.
-00012850: 2020 2020 2020 2020 2020 2020 7061 6464              padd
-00012860: 696e 6720 3d20 300a 2020 2020 2020 2020  ing = 0.        
-00012870: 2020 2020 6365 696c 5f6d 6f64 6520 3d20      ceil_mode = 
-00012880: 4661 6c73 650a 2020 2020 2020 2020 656c  False.        el
-00012890: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000128a0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000128b0: 2866 2269 6e76 616c 6964 2070 6164 6469  (f"invalid paddi
-000128c0: 6e67 207b 7061 6464 696e 6721 727d 2229  ng {padding!r}")
-000128d0: 0a20 2020 2020 2020 2066 756e 635f 6e61  .        func_na
-000128e0: 6d65 203d 2066 227b 6d6f 6465 7d5f 706f  me = f"{mode}_po
-000128f0: 6f6c 7b6c 656e 2869 6e5f 7370 6174 6961  ol{len(in_spatia
-00012900: 6c5f 6469 6d73 297d 6422 0a20 2020 2020  l_dims)}d".     
-00012910: 2020 2066 756e 6320 3d20 6765 7461 7474     func = getatt
-00012920: 7228 746f 7263 682e 6e6e 2e66 756e 6374  r(torch.nn.funct
-00012930: 696f 6e61 6c2c 2066 756e 635f 6e61 6d65  ional, func_name
-00012940: 2920 2023 2065 2e67 2e20 746f 7263 682e  )  # e.g. torch.
-00012950: 6e6e 2e66 756e 6374 696f 6e61 6c2e 6d61  nn.functional.ma
-00012960: 785f 706f 6f6c 3164 0a20 2020 2020 2020  x_pool1d.       
-00012970: 206b 7761 7267 7320 3d20 7b7d 0a20 2020   kwargs = {}.   
-00012980: 2020 2020 2069 6620 6469 6c61 7469 6f6e       if dilation
-00012990: 5f72 6174 6520 616e 6420 616e 7928 0a20  _rate and any(. 
-000129a0: 2020 2020 2020 2020 2020 2064 2021 3d20             d != 
-000129b0: 3120 666f 7220 6420 696e 2028 5b64 696c  1 for d in ([dil
-000129c0: 6174 696f 6e5f 7261 7465 5d20 6966 2069  ation_rate] if i
-000129d0: 7369 6e73 7461 6e63 6528 6469 6c61 7469  sinstance(dilati
-000129e0: 6f6e 5f72 6174 652c 2069 6e74 2920 656c  on_rate, int) el
-000129f0: 7365 2064 696c 6174 696f 6e5f 7261 7465  se dilation_rate
-00012a00: 290a 2020 2020 2020 2020 293a 0a20 2020  ).        ):.   
-00012a10: 2020 2020 2020 2020 2023 204f 6e6c 7920           # Only 
-00012a20: 6f70 7469 6f6e 616c 6c79 2061 6464 2069  optionally add i
-00012a30: 7420 746f 206b 7761 7267 732e 204d 6967  t to kwargs. Mig
-00012a40: 6874 206e 6f74 2062 6520 7375 7070 6f72  ht not be suppor
-00012a50: 7465 6420 6279 2061 6c6c 2070 6f6f 6c20  ted by all pool 
-00012a60: 6d6f 6465 732c 2065 2e67 2e20 6176 675f  modes, e.g. avg_
-00012a70: 706f 6f6c 2e0a 2020 2020 2020 2020 2020  pool..          
-00012a80: 2020 6173 7365 7274 206d 6f64 6520 3d3d    assert mode ==
-00012a90: 2022 6d61 7822 2c20 2264 696c 6174 696f   "max", "dilatio
-00012aa0: 6e5f 7261 7465 206f 6e6c 7920 7375 7070  n_rate only supp
-00012ab0: 6f72 7465 6420 666f 7220 6d61 785f 706f  orted for max_po
-00012ac0: 6f6c 220a 2020 2020 2020 2020 2020 2020  ol".            
-00012ad0: 6b77 6172 6773 5b22 6469 6c61 7469 6f6e  kwargs["dilation
-00012ae0: 225d 203d 2064 696c 6174 696f 6e5f 7261  "] = dilation_ra
-00012af0: 7465 0a20 2020 2020 2020 2069 6620 6d6f  te.        if mo
-00012b00: 6465 203d 3d20 2261 7667 223a 0a20 2020  de == "avg":.   
-00012b10: 2020 2020 2020 2020 206b 7761 7267 735b           kwargs[
-00012b20: 2263 6f75 6e74 5f69 6e63 6c75 6465 5f70  "count_include_p
-00012b30: 6164 225d 203d 2046 616c 7365 0a20 2020  ad"] = False.   
-00012b40: 2020 2020 206f 7574 5f72 6177 203d 2066       out_raw = f
-00012b50: 756e 6328 7372 635f 7261 772c 206b 6572  unc(src_raw, ker
-00012b60: 6e65 6c5f 7369 7a65 3d70 6f6f 6c5f 7369  nel_size=pool_si
-00012b70: 7a65 2c20 7374 7269 6465 3d73 7472 6964  ze, stride=strid
-00012b80: 6573 2c20 6365 696c 5f6d 6f64 653d 6365  es, ceil_mode=ce
-00012b90: 696c 5f6d 6f64 652c 2070 6164 6469 6e67  il_mode, padding
-00012ba0: 3d70 6164 6469 6e67 2c20 2a2a 6b77 6172  =padding, **kwar
-00012bb0: 6773 290a 2020 2020 2020 2020 6f75 7420  gs).        out 
-00012bc0: 3d20 5465 6e73 6f72 2822 706f 6f6c 222c  = Tensor("pool",
-00012bd0: 2064 696d 733d 6261 7463 685f 6469 6d73   dims=batch_dims
-00012be0: 202b 206c 6973 7428 6f75 745f 7370 6174   + list(out_spat
-00012bf0: 6961 6c5f 6469 6d73 292c 2064 7479 7065  ial_dims), dtype
-00012c00: 3d73 6f75 7263 652e 6474 7970 6529 0a20  =source.dtype). 
-00012c10: 2020 2020 2020 206f 7574 2e72 6177 5f74         out.raw_t
-00012c20: 656e 736f 7220 3d20 746f 7263 682e 7265  ensor = torch.re
-00012c30: 7368 6170 6528 6f75 745f 7261 772c 205b  shape(out_raw, [
-00012c40: 642e 6765 745f 6469 6d5f 7661 6c75 6528  d.get_dim_value(
-00012c50: 2920 666f 7220 6420 696e 206f 7574 2e64  ) for d in out.d
-00012c60: 696d 735d 290a 2020 2020 2020 2020 6966  ims]).        if
-00012c70: 2073 6f75 7263 652e 6665 6174 7572 655f   source.feature_
-00012c80: 6469 6d20 616e 6420 736f 7572 6365 2e66  dim and source.f
-00012c90: 6561 7475 7265 5f64 696d 2069 6e20 6f75  eature_dim in ou
-00012ca0: 742e 6469 6d73 3a0a 2020 2020 2020 2020  t.dims:.        
-00012cb0: 2020 2020 6f75 742e 6665 6174 7572 655f      out.feature_
-00012cc0: 6469 6d20 3d20 736f 7572 6365 2e66 6561  dim = source.fea
-00012cd0: 7475 7265 5f64 696d 0a20 2020 2020 2020  ture_dim.       
-00012ce0: 2072 6574 7572 6e20 6f75 742c 206f 7574   return out, out
-00012cf0: 5f73 7061 7469 616c 5f64 696d 730a 0a20  _spatial_dims.. 
-00012d00: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-00012d10: 0a20 2020 2064 6566 2073 7466 7428 0a20  .    def stft(. 
-00012d20: 2020 2020 2020 2078 3a20 5465 6e73 6f72         x: Tensor
-00012d30: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00012d40: 2020 2020 2069 6e5f 7370 6174 6961 6c5f       in_spatial_
-00012d50: 6469 6d3a 2044 696d 2c0a 2020 2020 2020  dim: Dim,.      
-00012d60: 2020 6672 616d 655f 7374 6570 3a20 696e    frame_step: in
-00012d70: 742c 0a20 2020 2020 2020 2066 7261 6d65  t,.        frame
-00012d80: 5f6c 656e 6774 683a 2069 6e74 2c0a 2020  _length: int,.  
-00012d90: 2020 2020 2020 6666 745f 6c65 6e67 7468        fft_length
-00012da0: 3a20 696e 742c 0a20 2020 2020 2020 2077  : int,.        w
-00012db0: 696e 646f 775f 7573 655f 6672 616d 655f  indow_use_frame_
-00012dc0: 6c65 6e67 7468 3a20 626f 6f6c 203d 2054  length: bool = T
-00012dd0: 7275 652c 0a20 2020 2020 2020 2061 6c69  rue,.        ali
-00012de0: 676e 5f77 696e 646f 775f 6c65 6674 3a20  gn_window_left: 
-00012df0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00012e00: 2020 2020 2077 696e 646f 775f 656e 666f       window_enfo
-00012e10: 7263 655f 6576 656e 3a20 626f 6f6c 203d  rce_even: bool =
-00012e20: 2054 7275 652c 0a20 2020 2020 2020 206f   True,.        o
-00012e30: 7574 5f73 7061 7469 616c 5f64 696d 3a20  ut_spatial_dim: 
-00012e40: 4469 6d2c 0a20 2020 2020 2020 206f 7574  Dim,.        out
-00012e50: 5f64 696d 3a20 4469 6d2c 0a20 2020 2029  _dim: Dim,.    )
-00012e60: 202d 3e20 5465 6e73 6f72 3a0a 2020 2020   -> Tensor:.    
-00012e70: 2020 2020 2222 2273 7466 7422 2222 0a20      """stft""". 
-00012e80: 2020 2020 2020 2062 6174 6368 5f64 696d         batch_dim
-00012e90: 7320 3d20 5b64 2066 6f72 2064 2069 6e20  s = [d for d in 
-00012ea0: 782e 6469 6d73 2069 6620 6420 213d 2069  x.dims if d != i
-00012eb0: 6e5f 7370 6174 6961 6c5f 6469 6d5d 0a20  n_spatial_dim]. 
-00012ec0: 2020 2020 2020 2078 203d 2078 2e63 6f70         x = x.cop
-00012ed0: 795f 7472 616e 7370 6f73 6528 6261 7463  y_transpose(batc
-00012ee0: 685f 6469 6d73 202b 205b 696e 5f73 7061  h_dims + [in_spa
-00012ef0: 7469 616c 5f64 696d 5d29 0a20 2020 2020  tial_dim]).     
-00012f00: 2020 2078 5f72 6177 203d 2074 6f72 6368     x_raw = torch
-00012f10: 2e72 6573 6861 7065 2878 2e72 6177 5f74  .reshape(x.raw_t
-00012f20: 656e 736f 722c 205b 2d31 2c20 696e 5f73  ensor, [-1, in_s
-00012f30: 7061 7469 616c 5f64 696d 2e67 6574 5f64  patial_dim.get_d
-00012f40: 696d 5f76 616c 7565 2829 5d29 0a0a 2020  im_value()])..  
-00012f50: 2020 2020 2020 2320 5446 2063 6f64 653a        # TF code:
-00012f60: 2079 203d 2074 662e 7369 676e 616c 2e73   y = tf.signal.s
-00012f70: 7466 7428 782c 2066 7261 6d65 5f6c 656e  tft(x, frame_len
-00012f80: 6774 683d 6672 616d 655f 7369 7a65 2c20  gth=frame_size, 
-00012f90: 6672 616d 655f 7374 6570 3d66 7261 6d65  frame_step=frame
-00012fa0: 5f73 6869 6674 2c20 6666 745f 6c65 6e67  _shift, fft_leng
-00012fb0: 7468 3d66 6674 5f73 697a 6529 0a20 2020  th=fft_size).   
-00012fc0: 2020 2020 2023 2054 6869 7320 6973 2073       # This is s
-00012fd0: 696d 696c 6172 2074 6f20 7768 6174 2053  imilar to what S
-00012fe0: 6369 5079 2077 696c 6c20 616c 736f 2072  ciPy will also r
-00012ff0: 6574 7572 6e2e 0a20 2020 2020 2020 2023  eturn..        #
-00013000: 2049 7420 6973 2073 6f6d 6577 6861 7420   It is somewhat 
-00013010: 6e6f 6e74 7269 7669 616c 2074 6f20 6765  nontrivial to ge
-00013020: 7420 7468 6520 7361 6d65 2072 6573 756c  t the same resul
-00013030: 7420 696e 2050 7954 6f72 6368 2c20 6573  t in PyTorch, es
-00013040: 7020 666f 7220 7468 6520 6361 7365 2066  p for the case f
-00013050: 7261 6d65 5f6c 656e 6774 6820 3c20 6666  rame_length < ff
-00013060: 745f 6c65 6e67 7468 2c0a 2020 2020 2020  t_length,.      
-00013070: 2020 2320 616e 6420 6576 656e 206d 6f72    # and even mor
-00013080: 6520 7768 656e 2066 7261 6d65 5f6c 656e  e when frame_len
-00013090: 6774 6820 2520 3220 213d 2030 2e0a 2020  gth % 2 != 0..  
-000130a0: 2020 2020 2020 2320 5079 546f 7263 6820        # PyTorch 
-000130b0: 6265 6861 7665 7320 6c69 6b65 206c 6962  behaves like lib
-000130c0: 726f 7361 2e0a 2020 2020 2020 2020 2320  rosa..        # 
-000130d0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-000130e0: 6f6d 2f70 7974 6f72 6368 2f70 7974 6f72  om/pytorch/pytor
-000130f0: 6368 2f69 7373 7565 732f 3130 3031 3737  ch/issues/100177
-00013100: 0a20 2020 2020 2020 2023 2068 7474 7073  .        # https
-00013110: 3a2f 2f67 6974 6875 622e 636f 6d2f 616c  ://github.com/al
-00013120: 6265 7274 7a2f 706c 6179 6772 6f75 6e64  bertz/playground
-00013130: 2f62 6c6f 622f 6d61 7374 6572 2f74 665f  /blob/master/tf_
-00013140: 7074 5f73 7466 742e 7079 0a0a 2020 2020  pt_stft.py..    
-00013150: 2020 2020 6966 2066 7261 6d65 5f6c 656e      if frame_len
-00013160: 6774 6820 3c20 6666 745f 6c65 6e67 7468  gth < fft_length
-00013170: 2061 6e64 2077 696e 646f 775f 7573 655f   and window_use_
-00013180: 6672 616d 655f 6c65 6e67 7468 3a0a 2020  frame_length:.  
-00013190: 2020 2020 2020 2020 2020 2320 5079 546f            # PyTo
-000131a0: 7263 6820 7573 6573 2077 696e 646f 7773  rch uses windows
-000131b0: 2061 6c77 6179 7320 6f66 2074 6865 2066   always of the f
-000131c0: 6674 5f6c 656e 6774 682c 0a20 2020 2020  ft_length,.     
-000131d0: 2020 2020 2020 2023 2073 6f20 7468 6520         # so the 
-000131e0: 6f75 7470 7574 2073 6571 206c 656e 2069  output seq len i
-000131f0: 7320 e28c 8828 5420 2d20 6666 745f 6c65  s ...(T - fft_le
-00013200: 6e67 7468 202b 2031 2920 2f20 6672 616d  ngth + 1) / fram
-00013210: 655f 7374 6570 e28c 892e 0a20 2020 2020  e_step.....     
-00013220: 2020 2020 2020 2023 2054 462f 5363 6950         # TF/SciP
-00013230: 7920 7573 6520 7769 6e64 6f77 7320 6f66  y use windows of
-00013240: 2066 7261 6d65 5f6c 656e 6774 682c 0a20   frame_length,. 
-00013250: 2020 2020 2020 2020 2020 2023 2073 6f20             # so 
-00013260: 7468 6520 6f75 7470 7574 2073 6571 206c  the output seq l
-00013270: 656e 2069 7320 e28c 8828 5420 2d20 6672  en is ...(T - fr
-00013280: 616d 655f 6c65 6e67 7468 202b 2031 2920  ame_length + 1) 
-00013290: 2f20 6672 616d 655f 7374 6570 e28c 892e  / frame_step....
-000132a0: 0a20 2020 2020 2020 2020 2020 2023 2042  .            # B
-000132b0: 7920 7061 6464 696e 6720 7468 6520 6469  y padding the di
-000132c0: 6666 6572 656e 6365 2028 6666 745f 6c65  fference (fft_le
-000132d0: 6e67 7468 202d 2066 7261 6d65 5f6c 656e  ngth - frame_len
-000132e0: 6774 6829 2074 6f20 7468 6520 7269 6768  gth) to the righ
-000132f0: 742c 0a20 2020 2020 2020 2020 2020 2023  t,.            #
-00013300: 2077 6520 6765 7420 7468 6520 7361 6d65   we get the same
-00013310: 206f 7574 7075 7420 7365 7120 6c65 6e67   output seq leng
-00013320: 7468 2069 6e20 626f 7468 2063 6173 6573  th in both cases
-00013330: 2e0a 2020 2020 2020 2020 2020 2020 785f  ..            x_
-00013340: 7261 7720 3d20 746f 7263 682e 6e6e 2e66  raw = torch.nn.f
-00013350: 756e 6374 696f 6e61 6c2e 7061 6428 785f  unctional.pad(x_
-00013360: 7261 772c 2028 302c 2028 6666 745f 6c65  raw, (0, (fft_le
-00013370: 6e67 7468 202d 2066 7261 6d65 5f6c 656e  ngth - frame_len
-00013380: 6774 6829 2929 0a0a 2020 2020 2020 2020  gth)))..        
-00013390: 6966 2066 7261 6d65 5f6c 656e 6774 6820  if frame_length 
-000133a0: 3e20 785f 7261 772e 7368 6170 655b 315d  > x_raw.shape[1]
-000133b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000133c0: 546f 7263 6820 646f 6573 206e 6f74 2072  Torch does not r
-000133d0: 6561 6c6c 7920 7375 7070 6f72 7420 7468  eally support th
-000133e0: 6520 656d 7074 7920 6361 7365 2e0a 2020  e empty case..  
-000133f0: 2020 2020 2020 2020 2020 7920 3d20 5465            y = Te
-00013400: 6e73 6f72 2822 7374 6674 222c 2064 696d  nsor("stft", dim
-00013410: 733d 6261 7463 685f 6469 6d73 202b 205b  s=batch_dims + [
-00013420: 6f75 745f 6469 6d2c 206f 7574 5f73 7061  out_dim, out_spa
-00013430: 7469 616c 5f64 696d 5d2c 2066 6561 7475  tial_dim], featu
-00013440: 7265 5f64 696d 3d6f 7574 5f64 696d 2c20  re_dim=out_dim, 
-00013450: 6474 7970 653d 2263 6f6d 706c 6578 3634  dtype="complex64
-00013460: 2229 0a20 2020 2020 2020 2020 2020 2079  ").            y
-00013470: 2e72 6177 5f74 656e 736f 7220 3d20 746f  .raw_tensor = to
-00013480: 7263 682e 7a65 726f 7328 5b64 2e67 6574  rch.zeros([d.get
-00013490: 5f64 696d 5f76 616c 7565 2829 2066 6f72  _dim_value() for
-000134a0: 2064 2069 6e20 792e 6469 6d73 5d2c 2064   d in y.dims], d
-000134b0: 7479 7065 3d74 6f72 6368 2e63 6f6d 706c  type=torch.compl
-000134c0: 6578 3634 290a 2020 2020 2020 2020 2020  ex64).          
-000134d0: 2020 7265 7475 726e 2079 0a0a 2020 2020    return y..    
-000134e0: 2020 2020 6966 2077 696e 646f 775f 656e      if window_en
-000134f0: 666f 7263 655f 6576 656e 3a0a 2020 2020  force_even:.    
-00013500: 2020 2020 2020 2020 6672 616d 655f 6c65          frame_le
-00013510: 6e67 7468 202d 3d20 6672 616d 655f 6c65  ngth -= frame_le
-00013520: 6e67 7468 2025 2032 0a0a 2020 2020 2020  ngth % 2..      
-00013530: 2020 7769 6e64 6f77 5f70 7420 3d20 746f    window_pt = to
-00013540: 7263 682e 6861 6e6e 5f77 696e 646f 7728  rch.hann_window(
-00013550: 6672 616d 655f 6c65 6e67 7468 2c20 6465  frame_length, de
-00013560: 7669 6365 3d78 5f72 6177 2e64 6576 6963  vice=x_raw.devic
-00013570: 6529 0a20 2020 2020 2020 2069 6620 6672  e).        if fr
-00013580: 616d 655f 6c65 6e67 7468 203c 2066 6674  ame_length < fft
-00013590: 5f6c 656e 6774 683a 0a20 2020 2020 2020  _length:.       
-000135a0: 2020 2020 2069 6620 616c 6967 6e5f 7769       if align_wi
-000135b0: 6e64 6f77 5f6c 6566 743a 2020 2320 7468  ndow_left:  # th
-000135c0: 6973 2069 7320 686f 7720 5446 2f53 6369  is is how TF/Sci
-000135d0: 5079 2064 6f20 6974 0a20 2020 2020 2020  Py do it.       
-000135e0: 2020 2020 2020 2020 2077 696e 646f 775f           window_
-000135f0: 7074 203d 2074 6f72 6368 2e6e 6e2e 6675  pt = torch.nn.fu
-00013600: 6e63 7469 6f6e 616c 2e70 6164 2877 696e  nctional.pad(win
-00013610: 646f 775f 7074 2c20 2830 2c20 2866 6674  dow_pt, (0, (fft
-00013620: 5f6c 656e 6774 6820 2d20 6672 616d 655f  _length - frame_
-00013630: 6c65 6e67 7468 2929 290a 2020 2020 2020  length))).      
-00013640: 2020 2020 2020 656c 7365 3a20 2023 2074        else:  # t
-00013650: 6869 7320 6973 2068 6f77 2050 7954 6f72  his is how PyTor
-00013660: 6368 2f6c 6962 726f 7361 2064 6f20 6974  ch/librosa do it
-00013670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013680: 2070 6164 5f6c 6566 7420 3d20 2866 6674   pad_left = (fft
-00013690: 5f6c 656e 6774 6820 2d20 6672 616d 655f  _length - frame_
-000136a0: 6c65 6e67 7468 2920 2f2f 2032 0a20 2020  length) // 2.   
-000136b0: 2020 2020 2020 2020 2020 2020 2070 6164               pad
-000136c0: 5f72 6967 6874 203d 2066 6674 5f6c 656e  _right = fft_len
-000136d0: 6774 6820 2d20 6672 616d 655f 6c65 6e67  gth - frame_leng
-000136e0: 7468 202d 2070 6164 5f6c 6566 740a 2020  th - pad_left.  
-000136f0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-00013700: 6e64 6f77 5f70 7420 3d20 746f 7263 682e  ndow_pt = torch.
-00013710: 6e6e 2e66 756e 6374 696f 6e61 6c2e 7061  nn.functional.pa
-00013720: 6428 7769 6e64 6f77 5f70 742c 2028 7061  d(window_pt, (pa
-00013730: 645f 6c65 6674 2c20 7061 645f 7269 6768  d_left, pad_righ
-00013740: 7429 290a 0a20 2020 2020 2020 2079 5f72  t))..        y_r
-00013750: 6177 203d 2074 6f72 6368 2e73 7466 7428  aw = torch.stft(
-00013760: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-00013770: 6177 2c0a 2020 2020 2020 2020 2020 2020  aw,.            
-00013780: 6e5f 6666 743d 6666 745f 6c65 6e67 7468  n_fft=fft_length
-00013790: 2c0a 2020 2020 2020 2020 2020 2020 686f  ,.            ho
-000137a0: 705f 6c65 6e67 7468 3d66 7261 6d65 5f73  p_length=frame_s
-000137b0: 7465 702c 0a20 2020 2020 2020 2020 2020  tep,.           
-000137c0: 2023 2050 7954 6f72 6368 2061 6e79 7761   # PyTorch anywa
-000137d0: 7920 7573 6573 2061 2077 696e 646f 7720  y uses a window 
-000137e0: 7769 7468 2073 697a 6520 3d20 6e5f 6666  with size = n_ff
-000137f0: 7420 696e 7465 726e 616c 6c79 2e0a 2020  t internally..  
-00013800: 2020 2020 2020 2020 2020 2320 536f 2077            # So w
-00013810: 6520 6a75 7374 2065 7870 6c69 6369 746c  e just explicitl
-00013820: 7920 6861 6e64 6c65 2074 6865 2077 696e  y handle the win
-00013830: 646f 7720 6c6f 6769 632e 0a20 2020 2020  dow logic..     
-00013840: 2020 2020 2020 2077 696e 5f6c 656e 6774         win_lengt
-00013850: 683d 6666 745f 6c65 6e67 7468 2c0a 2020  h=fft_length,.  
-00013860: 2020 2020 2020 2020 2020 7769 6e64 6f77            window
-00013870: 3d77 696e 646f 775f 7074 2c0a 2020 2020  =window_pt,.    
-00013880: 2020 2020 2020 2020 6365 6e74 6572 3d46          center=F
-00013890: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-000138a0: 2020 7265 7475 726e 5f63 6f6d 706c 6578    return_complex
-000138b0: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
-000138c0: 0a20 2020 2020 2020 2079 203d 2054 656e  .        y = Ten
-000138d0: 736f 7228 2273 7466 7422 2c20 6469 6d73  sor("stft", dims
-000138e0: 3d62 6174 6368 5f64 696d 7320 2b20 5b6f  =batch_dims + [o
-000138f0: 7574 5f64 696d 2c20 6f75 745f 7370 6174  ut_dim, out_spat
-00013900: 6961 6c5f 6469 6d5d 2c20 6474 7970 653d  ial_dim], dtype=
-00013910: 546f 7263 6842 6163 6b65 6e64 2e67 6574  TorchBackend.get
-00013920: 5f64 7479 7065 5f6e 616d 655f 7261 7728  _dtype_name_raw(
-00013930: 795f 7261 7729 290a 2020 2020 2020 2020  y_raw)).        
-00013940: 792e 6665 6174 7572 655f 6469 6d20 3d20  y.feature_dim = 
-00013950: 6f75 745f 6469 6d0a 2020 2020 2020 2020  out_dim.        
-00013960: 792e 7261 775f 7465 6e73 6f72 203d 2074  y.raw_tensor = t
-00013970: 6f72 6368 2e72 6573 6861 7065 2879 5f72  orch.reshape(y_r
-00013980: 6177 2c20 5b64 2e67 6574 5f64 696d 5f76  aw, [d.get_dim_v
-00013990: 616c 7565 2829 2066 6f72 2064 2069 6e20  alue() for d in 
-000139a0: 792e 6469 6d73 5d29 0a20 2020 2020 2020  y.dims]).       
-000139b0: 2072 6574 7572 6e20 790a 0a20 2020 2040   return y..    @
-000139c0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-000139d0: 2064 6566 206c 7374 6d28 0a20 2020 2020   def lstm(.     
-000139e0: 2020 2073 6f75 7263 653a 205f 5454 2c0a     source: _TT,.
-000139f0: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00013a00: 2020 2073 7461 7465 5f68 3a20 5f54 542c     state_h: _TT,
-00013a10: 0a20 2020 2020 2020 2073 7461 7465 5f63  .        state_c
-00013a20: 3a20 5f54 542c 0a20 2020 2020 2020 2066  : _TT,.        f
-00013a30: 665f 7765 6967 6874 3a20 5f54 542c 0a20  f_weight: _TT,. 
-00013a40: 2020 2020 2020 2072 6563 5f77 6569 6768         rec_weigh
-00013a50: 743a 205f 5454 2c0a 2020 2020 2020 2020  t: _TT,.        
-00013a60: 6269 6173 3a20 4f70 7469 6f6e 616c 5b5f  bias: Optional[_
-00013a70: 5454 5d2c 0a20 2020 2020 2020 2073 7061  TT],.        spa
-00013a80: 7469 616c 5f64 696d 3a20 4469 6d2c 0a20  tial_dim: Dim,. 
-00013a90: 2020 2020 2020 2069 6e5f 6469 6d3a 2044         in_dim: D
-00013aa0: 696d 2c0a 2020 2020 2020 2020 6f75 745f  im,.        out_
-00013ab0: 6469 6d3a 2044 696d 2c0a 2020 2020 2920  dim: Dim,.    ) 
-00013ac0: 2d3e 2054 7570 6c65 5b5f 5454 2c20 5475  -> Tuple[_TT, Tu
-00013ad0: 706c 655b 5f54 542c 205f 5454 5d5d 3a0a  ple[_TT, _TT]]:.
-00013ae0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00013af0: 2020 2020 5772 6170 7320 7468 6520 6675      Wraps the fu
-00013b00: 6e63 7469 6f6e 616c 204c 5354 4d20 6672  nctional LSTM fr
-00013b10: 6f6d 2050 7954 6f72 6368 2e0a 0a20 2020  om PyTorch...   
-00013b20: 2020 2020 203a 7265 7475 726e 3a20 5475       :return: Tu
-00013b30: 706c 6520 636f 6e73 6973 7469 6e67 206f  ple consisting o
-00013b40: 6620 7477 6f20 656c 656d 656e 7473 3a20  f two elements: 
-00013b50: 7468 6520 7265 7375 6c74 2061 7320 6120  the result as a 
-00013b60: 3a63 6c61 7373 3a60 5465 6e73 6f72 600a  :class:`Tensor`.
-00013b70: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00013b80: 7468 6520 6e65 7720 7374 6174 6520 6173  the new state as
-00013b90: 2061 203a 636c 6173 733a 6053 7461 7465   a :class:`State
-00013ba0: 6020 2864 6966 6665 7265 6e74 2066 726f  ` (different fro
-00013bb0: 6d20 7468 6520 7072 6576 696f 7573 206f  m the previous o
-00013bc0: 6e65 292e 0a20 2020 2020 2020 2022 2222  ne)..        """
-00013bd0: 0a20 2020 2020 2020 2073 7175 6565 7a65  .        squeeze
-00013be0: 5f73 7061 7469 616c 5f64 696d 203d 2046  _spatial_dim = F
-00013bf0: 616c 7365 0a20 2020 2020 2020 2069 6620  alse.        if 
-00013c00: 7370 6174 6961 6c5f 6469 6d20 3d3d 2073  spatial_dim == s
-00013c10: 696e 676c 655f 7374 6570 5f64 696d 3a0a  ingle_step_dim:.
-00013c20: 2020 2020 2020 2020 2020 2020 7370 6174              spat
-00013c30: 6961 6c5f 6469 6d20 3d20 4469 6d28 312c  ial_dim = Dim(1,
-00013c40: 206e 616d 653d 2264 756d 6d79 2d73 7061   name="dummy-spa
-00013c50: 7469 616c 2d64 696d 2d73 696e 676c 652d  tial-dim-single-
-00013c60: 7374 6570 2229 0a20 2020 2020 2020 2020  step").         
-00013c70: 2020 2073 6f75 7263 6520 3d20 736f 7572     source = sour
-00013c80: 6365 2e63 6f70 795f 6164 645f 6469 6d5f  ce.copy_add_dim_
-00013c90: 6279 5f74 6167 2873 7061 7469 616c 5f64  by_tag(spatial_d
-00013ca0: 696d 2c20 756e 6272 6f61 6463 6173 743d  im, unbroadcast=
-00013cb0: 5472 7565 2c20 6178 6973 3d30 290a 2020  True, axis=0).  
-00013cc0: 2020 2020 2020 2020 2020 7371 7565 657a            squeez
-00013cd0: 655f 7370 6174 6961 6c5f 6469 6d20 3d20  e_spatial_dim = 
-00013ce0: 5472 7565 0a0a 2020 2020 2020 2020 2320  True..        # 
-00013cf0: 5468 6520 6f72 6465 7220 696e 2074 6865  The order in the
-00013d00: 2070 6172 616d 6574 6572 7320 666f 7220   parameters for 
-00013d10: 6c73 746d 5f70 6172 616d 7320 6973 2073  lstm_params is s
-00013d20: 7065 6369 6669 6564 2061 7320 666f 6c6c  pecified as foll
-00013d30: 6f77 733a 0a20 2020 2020 2020 2023 2046  ows:.        # F
-00013d40: 6565 642d 666f 7277 6172 6420 6861 7320  eed-forward has 
-00013d50: 7072 696f 7269 7479 206f 7665 7220 7265  priority over re
-00013d60: 6375 7272 656e 742c 2061 6e64 2077 6569  current, and wei
-00013d70: 6768 7473 2068 6176 6520 7072 696f 7269  ghts have priori
-00013d80: 7479 206f 7665 7220 6269 6173 6573 3a20  ty over biases: 
-00013d90: 2877 5f69 682c 2077 5f68 682c 2062 5f69  (w_ih, w_hh, b_i
-00013da0: 682c 2062 5f68 6829 2e0a 2020 2020 2020  h, b_hh)..      
-00013db0: 2020 2320 5365 6520 6874 7470 733a 2f2f    # See https://
-00013dc0: 6769 7468 7562 2e63 6f6d 2f70 7974 6f72  github.com/pytor
-00013dd0: 6368 2f70 7974 6f72 6368 2f62 6c6f 622f  ch/pytorch/blob/
-00013de0: 6332 3633 6264 3433 2f74 6f72 6368 2f6e  c263bd43/torch/n
-00013df0: 6e2f 6d6f 6475 6c65 732f 726e 6e2e 7079  n/modules/rnn.py
-00013e00: 234c 3130 372e 0a20 2020 2020 2020 2023  #L107..        #
-00013e10: 2041 6c74 6572 6e61 7469 7665 6c79 2073   Alternatively s
-00013e20: 6565 2074 6865 2069 6d70 6c65 6d65 6e74  ee the implement
-00013e30: 6174 696f 6e20 6f66 204c 5354 4d43 656c  ation of LSTMCel
-00013e40: 6c3a 0a20 2020 2020 2020 2023 2068 7474  l:.        # htt
-00013e50: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00013e60: 7079 746f 7263 682f 7079 746f 7263 682f  pytorch/pytorch/
-00013e70: 626c 6f62 2f34 6265 6164 3634 2f61 7465  blob/4bead64/ate
-00013e80: 6e2f 7372 632f 4154 656e 2f6e 6174 6976  n/src/ATen/nativ
-00013e90: 652f 524e 4e2e 6370 7023 4c31 3435 382e  e/RNN.cpp#L1458.
-00013ea0: 0a20 2020 2020 2020 2069 6620 6269 6173  .        if bias
-00013eb0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00013ec0: 2020 2020 2020 6c73 746d 5f70 6172 616d        lstm_param
-00013ed0: 7320 3d20 2866 665f 7765 6967 6874 2e72  s = (ff_weight.r
-00013ee0: 6177 5f74 656e 736f 722c 2072 6563 5f77  aw_tensor, rec_w
-00013ef0: 6569 6768 742e 7261 775f 7465 6e73 6f72  eight.raw_tensor
-00013f00: 290a 2020 2020 2020 2020 2020 2020 6861  ).            ha
-00013f10: 735f 6269 6173 6573 203d 2046 616c 7365  s_biases = False
-00013f20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00013f30: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-00013f40: 6520 7468 6174 2074 6865 206d 6174 6865  e that the mathe
-00013f50: 6d61 7469 6361 6c20 6465 6669 6e69 7469  matical definiti
-00013f60: 6f6e 206f 6620 7468 6520 6d6f 6465 6c20  on of the model 
-00013f70: 646f 6573 206e 6f74 2072 6571 7569 7265  does not require
-00013f80: 2074 776f 2062 6961 7320 7465 726d 732e   two bias terms.
-00013f90: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-00013fa0: 7954 6f72 6368 206a 7573 7420 666f 6c6c  yTorch just foll
-00013fb0: 6f77 7320 7768 6174 2043 7544 4e4e 2064  ows what CuDNN d
-00013fc0: 6f65 7320 6865 7265 2e0a 2020 2020 2020  oes here..      
-00013fd0: 2020 2020 2020 2320 4920 646f 6e27 7420        # I don't 
-00013fe0: 7265 616c 6c79 2075 6e64 6572 7374 616e  really understan
-00013ff0: 6420 7768 7920 4375 444e 4e20 6861 7665  d why CuDNN have
-00014000: 2074 776f 2062 6961 7320 7465 726d 733a   two bias terms:
-00014010: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
-00014020: 7474 7073 3a2f 2f73 7461 636b 6f76 6572  ttps://stackover
-00014030: 666c 6f77 2e63 6f6d 2f71 7565 7374 696f  flow.com/questio
-00014040: 6e73 2f37 3630 3531 3830 302f 7768 792d  ns/76051800/why-
-00014050: 646f 6573 2d74 6865 2d63 7564 6e6e 2d6c  does-the-cudnn-l
-00014060: 7374 6d2d 7265 7175 6972 6573 2d74 776f  stm-requires-two
-00014070: 2d62 6961 7365 732d 622d 6968 2d61 6e64  -biases-b-ih-and
-00014080: 2d62 2d68 680a 2020 2020 2020 2020 2020  -b-hh.          
-00014090: 2020 2320 4974 206c 6f6f 6b73 206c 696b    # It looks lik
-000140a0: 6520 616e 206f 7665 7273 6967 6874 2062  e an oversight b
-000140b0: 7920 7468 6520 4375 444e 4e20 6465 7673  y the CuDNN devs
-000140c0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000140d0: 4927 6d20 6e6f 7420 7375 7265 2069 6620  I'm not sure if 
-000140e0: 7468 6520 7477 6f20 6269 6173 2074 6572  the two bias ter
-000140f0: 6d73 2067 6574 2074 6865 2073 616d 6520  ms get the same 
-00014100: 6772 6164 6965 6e74 206f 7220 6e6f 742e  gradient or not.
-00014110: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-00014120: 6620 7468 6579 2064 6f20 6e6f 742c 2074  f they do not, t
-00014130: 6861 7420 776f 756c 6420 6265 206d 6174  hat would be mat
-00014140: 6865 6d61 7469 6361 6c20 696e 636f 7272  hematical incorr
-00014150: 6563 742c 2062 7574 206d 6179 6265 2074  ect, but maybe t
-00014160: 6861 7427 7320 686f 7720 4375 444e 4e20  hat's how CuDNN 
-00014170: 776f 726b 732e 0a20 2020 2020 2020 2020  works..         
-00014180: 2020 2023 2054 6f20 7265 616c 6c79 2067     # To really g
-00014190: 6574 2062 6f74 6820 6772 6164 6965 6e74  et both gradient
-000141a0: 732c 2077 6520 646f 6e27 7420 6a75 7374  s, we don't just
-000141b0: 2073 6574 206f 6e65 2062 6961 7320 746f   set one bias to
-000141c0: 207a 6572 6f2c 2062 7574 2077 6520 7573   zero, but we us
-000141d0: 6520 302e 3520 2a20 6269 6173 2066 6f72  e 0.5 * bias for
-000141e0: 2062 6f74 682e 0a20 2020 2020 2020 2020   both..         
-000141f0: 2020 2062 6961 735f 7261 7720 3d20 6269     bias_raw = bi
-00014200: 6173 2e72 6177 5f74 656e 736f 7220 2a20  as.raw_tensor * 
-00014210: 302e 350a 2020 2020 2020 2020 2020 2020  0.5.            
-00014220: 6c73 746d 5f70 6172 616d 7320 3d20 280a  lstm_params = (.
-00014230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014240: 6666 5f77 6569 6768 742e 7261 775f 7465  ff_weight.raw_te
-00014250: 6e73 6f72 2c0a 2020 2020 2020 2020 2020  nsor,.          
-00014260: 2020 2020 2020 7265 635f 7765 6967 6874        rec_weight
-00014270: 2e72 6177 5f74 656e 736f 722c 0a20 2020  .raw_tensor,.   
-00014280: 2020 2020 2020 2020 2020 2020 2062 6961               bia
-00014290: 735f 7261 772c 0a20 2020 2020 2020 2020  s_raw,.         
-000142a0: 2020 2020 2020 2062 6961 735f 7261 772c         bias_raw,
-000142b0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000142c0: 2020 2020 2020 2020 2020 2068 6173 5f62             has_b
-000142d0: 6961 7365 7320 3d20 5472 7565 0a0a 2020  iases = True..  
-000142e0: 2020 2020 2020 6261 7463 685f 6469 6d73        batch_dims
-000142f0: 203d 205b 6420 666f 7220 6420 696e 2073   = [d for d in s
-00014300: 6f75 7263 652e 6469 6d73 2069 6620 6420  ource.dims if d 
-00014310: 213d 2073 7061 7469 616c 5f64 696d 2061  != spatial_dim a
-00014320: 6e64 2064 2021 3d20 696e 5f64 696d 5d0a  nd d != in_dim].
-00014330: 2020 2020 2020 2020 736f 7572 6365 203d          source =
-00014340: 2073 6f75 7263 652e 636f 7079 5f74 7261   source.copy_tra
-00014350: 6e73 706f 7365 285b 7370 6174 6961 6c5f  nspose([spatial_
-00014360: 6469 6d5d 202b 2062 6174 6368 5f64 696d  dim] + batch_dim
-00014370: 7320 2b20 5b69 6e5f 6469 6d5d 290a 2020  s + [in_dim]).  
-00014380: 2020 2020 2020 7374 6174 655f 6820 3d20        state_h = 
-00014390: 7374 6174 655f 682e 636f 7079 5f74 7261  state_h.copy_tra
-000143a0: 6e73 706f 7365 2862 6174 6368 5f64 696d  nspose(batch_dim
-000143b0: 7320 2b20 5b6f 7574 5f64 696d 5d29 0a20  s + [out_dim]). 
-000143c0: 2020 2020 2020 2073 7461 7465 5f63 203d         state_c =
-000143d0: 2073 7461 7465 5f63 2e63 6f70 795f 7472   state_c.copy_tr
-000143e0: 616e 7370 6f73 6528 6261 7463 685f 6469  anspose(batch_di
-000143f0: 6d73 202b 205b 6f75 745f 6469 6d5d 290a  ms + [out_dim]).
-00014400: 0a20 2020 2020 2020 2073 6f75 7263 655f  .        source_
-00014410: 7261 7720 3d20 736f 7572 6365 2e72 6177  raw = source.raw
-00014420: 5f74 656e 736f 720a 2020 2020 2020 2020  _tensor.        
-00014430: 7374 6174 655f 685f 7261 7720 3d20 7374  state_h_raw = st
-00014440: 6174 655f 682e 7261 775f 7465 6e73 6f72  ate_h.raw_tensor
-00014450: 0a20 2020 2020 2020 2073 7461 7465 5f63  .        state_c
-00014460: 5f72 6177 203d 2073 7461 7465 5f63 2e72  _raw = state_c.r
-00014470: 6177 5f74 656e 736f 720a 2020 2020 2020  aw_tensor.      
-00014480: 2020 6261 7463 685f 6469 6d20 3d20 746f    batch_dim = to
-00014490: 7263 682e 7072 6f64 2874 6f72 6368 2e74  rch.prod(torch.t
-000144a0: 656e 736f 7228 5b64 2e67 6574 5f64 696d  ensor([d.get_dim
-000144b0: 5f76 616c 7565 2829 2066 6f72 2064 2069  _value() for d i
-000144c0: 6e20 6261 7463 685f 6469 6d73 5d29 2920  n batch_dims])) 
-000144d0: 6966 2062 6174 6368 5f64 696d 7320 656c  if batch_dims el
-000144e0: 7365 2031 0a20 2020 2020 2020 2069 6620  se 1.        if 
-000144f0: 6c65 6e28 6261 7463 685f 6469 6d73 2920  len(batch_dims) 
-00014500: 213d 2031 3a0a 2020 2020 2020 2020 2020  != 1:.          
-00014510: 2020 2320 546f 7263 6820 4c53 544d 2065    # Torch LSTM e
-00014520: 7870 6563 7473 2028 7365 715f 6c65 6e2c  xpects (seq_len,
-00014530: 2062 6174 6368 2c20 696e 7075 745f 7369   batch, input_si
-00014540: 7a65 2920 6173 2073 6861 7065 2e0a 2020  ze) as shape..  
-00014550: 2020 2020 2020 2020 2020 2320 5765 206e            # We n
-00014560: 6565 6420 746f 206d 6572 6765 2061 6c6c  eed to merge all
-00014570: 2062 6174 6368 2064 696d 7320 746f 6765   batch dims toge
-00014580: 7468 6572 2e0a 2020 2020 2020 2020 2020  ther..          
-00014590: 2020 736f 7572 6365 5f72 6177 203d 2074    source_raw = t
-000145a0: 6f72 6368 2e72 6573 6861 7065 280a 2020  orch.reshape(.  
-000145b0: 2020 2020 2020 2020 2020 2020 2020 736f                so
-000145c0: 7572 6365 5f72 6177 2c20 5b73 7061 7469  urce_raw, [spati
-000145d0: 616c 5f64 696d 2e67 6574 5f64 696d 5f76  al_dim.get_dim_v
-000145e0: 616c 7565 2829 5d20 2b20 5b62 6174 6368  alue()] + [batch
-000145f0: 5f64 696d 5d20 2b20 5b69 6e5f 6469 6d2e  _dim] + [in_dim.
-00014600: 6765 745f 6469 6d5f 7661 6c75 6528 295d  get_dim_value()]
-00014610: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00014620: 2020 2020 2020 2023 2054 6f72 6368 204c         # Torch L
-00014630: 5354 4d20 6578 7065 6374 7320 286e 756d  STM expects (num
-00014640: 5f6c 6179 6572 7320 2a20 6e75 6d5f 6469  _layers * num_di
-00014650: 7265 6374 696f 6e73 2c20 6261 7463 682c  rections, batch,
-00014660: 2068 6964 6465 6e5f 7369 7a65 2920 6173   hidden_size) as
-00014670: 2073 6861 7065 2e0a 2020 2020 2020 2020   shape..        
-00014680: 7374 6174 655f 685f 7261 7720 3d20 746f  state_h_raw = to
-00014690: 7263 682e 7265 7368 6170 6528 7374 6174  rch.reshape(stat
-000146a0: 655f 685f 7261 772c 205b 312c 2062 6174  e_h_raw, [1, bat
-000146b0: 6368 5f64 696d 2c20 6f75 745f 6469 6d2e  ch_dim, out_dim.
-000146c0: 6765 745f 6469 6d5f 7661 6c75 6528 295d  get_dim_value()]
-000146d0: 290a 2020 2020 2020 2020 7374 6174 655f  ).        state_
-000146e0: 635f 7261 7720 3d20 746f 7263 682e 7265  c_raw = torch.re
-000146f0: 7368 6170 6528 7374 6174 655f 635f 7261  shape(state_c_ra
-00014700: 772c 205b 312c 2062 6174 6368 5f64 696d  w, [1, batch_dim
-00014710: 2c20 6f75 745f 6469 6d2e 6765 745f 6469  , out_dim.get_di
-00014720: 6d5f 7661 6c75 6528 295d 290a 0a20 2020  m_value()])..   
-00014730: 2020 2020 2073 697a 6573 203d 2073 7061       sizes = spa
-00014740: 7469 616c 5f64 696d 2e67 6574 5f73 697a  tial_dim.get_siz
-00014750: 655f 7465 6e73 6f72 2829 0a20 2020 2020  e_tensor().     
-00014760: 2020 2073 697a 6573 203d 2073 697a 6573     sizes = sizes
-00014770: 2e63 6f70 795f 636f 6d70 6174 6962 6c65  .copy_compatible
-00014780: 5f74 6f28 0a20 2020 2020 2020 2020 2020  _to(.           
-00014790: 2054 656e 736f 7228 2262 6174 6368 5f64   Tensor("batch_d
-000147a0: 696d 7322 2c20 6261 7463 685f 6469 6d73  ims", batch_dims
-000147b0: 2c20 6474 7970 653d 7369 7a65 732e 6474  , dtype=sizes.dt
-000147c0: 7970 6529 2c20 756e 6272 6f61 6463 6173  ype), unbroadcas
-000147d0: 743d 5472 7565 2c20 6368 6563 6b5f 7370  t=True, check_sp
-000147e0: 6172 7365 3d46 616c 7365 0a20 2020 2020  arse=False.     
-000147f0: 2020 2029 0a20 2020 2020 2020 2073 697a     ).        siz
-00014800: 6573 5f72 6177 203d 2074 6f72 6368 2e72  es_raw = torch.r
-00014810: 6573 6861 7065 2873 697a 6573 2e72 6177  eshape(sizes.raw
-00014820: 5f74 656e 736f 722c 205b 6261 7463 685f  _tensor, [batch_
-00014830: 6469 6d5d 290a 0a20 2020 2020 2020 2023  dim])..        #
-00014840: 2053 6565 2074 6865 2063 6f64 6520 6f66   See the code of
-00014850: 2074 6f72 6368 2e6e 6e2e 4c53 544d 2066   torch.nn.LSTM f
-00014860: 6f72 2073 6f72 7469 6e67 2074 6865 2062  or sorting the b
-00014870: 6174 6368 2064 696d 732e 0a20 2020 2020  atch dims..     
-00014880: 2020 2023 2057 6520 6e65 6564 2070 6163     # We need pac
-00014890: 6b5f 7061 6464 6564 5f73 6571 7565 6e63  k_padded_sequenc
-000148a0: 6520 6265 6361 7573 6520 6f74 6865 7277  e because otherw
-000148b0: 6973 6520 7468 6520 4c53 544d 2077 6f75  ise the LSTM wou
-000148c0: 6c64 2069 676e 6f72 6520 7468 6520 7061  ld ignore the pa
-000148d0: 6464 696e 672c 0a20 2020 2020 2020 2023  dding,.        #
-000148e0: 2061 6e64 2077 6520 776f 756c 6420 6765   and we would ge
-000148f0: 7420 696e 636f 7272 6563 7420 6669 6e61  t incorrect fina
-00014900: 6c20 7374 6174 6573 2e0a 2020 2020 2020  l states..      
-00014910: 2020 736f 7572 6365 5f70 6163 6b65 6420    source_packed 
-00014920: 3d20 746f 7263 682e 6e6e 2e75 7469 6c73  = torch.nn.utils
-00014930: 2e72 6e6e 2e70 6163 6b5f 7061 6464 6564  .rnn.pack_padded
-00014940: 5f73 6571 7565 6e63 6528 736f 7572 6365  _sequence(source
-00014950: 5f72 6177 2c20 7369 7a65 735f 7261 772c  _raw, sizes_raw,
-00014960: 2065 6e66 6f72 6365 5f73 6f72 7465 643d   enforce_sorted=
-00014970: 4661 6c73 6529 0a20 2020 2020 2020 2073  False).        s
-00014980: 7461 7465 5f68 5f72 6177 203d 2073 7461  tate_h_raw = sta
-00014990: 7465 5f68 5f72 6177 2e69 6e64 6578 5f73  te_h_raw.index_s
-000149a0: 656c 6563 7428 6469 6d3d 312c 2069 6e64  elect(dim=1, ind
-000149b0: 6578 3d73 6f75 7263 655f 7061 636b 6564  ex=source_packed
-000149c0: 2e73 6f72 7465 645f 696e 6469 6365 7329  .sorted_indices)
-000149d0: 0a20 2020 2020 2020 2073 7461 7465 5f63  .        state_c
-000149e0: 5f72 6177 203d 2073 7461 7465 5f63 5f72  _raw = state_c_r
-000149f0: 6177 2e69 6e64 6578 5f73 656c 6563 7428  aw.index_select(
-00014a00: 6469 6d3d 312c 2069 6e64 6578 3d73 6f75  dim=1, index=sou
-00014a10: 7263 655f 7061 636b 6564 2e73 6f72 7465  rce_packed.sorte
-00014a20: 645f 696e 6469 6365 7329 0a0a 2020 2020  d_indices)..    
-00014a30: 2020 2020 6f75 745f 7261 772c 206e 6577      out_raw, new
-00014a40: 5f73 7461 7465 5f68 5f72 6177 2c20 6e65  _state_h_raw, ne
-00014a50: 775f 7374 6174 655f 635f 7261 7720 3d20  w_state_c_raw = 
-00014a60: 746f 7263 682e 6c73 746d 280a 2020 2020  torch.lstm(.    
-00014a70: 2020 2020 2020 2020 736f 7572 6365 5f70          source_p
-00014a80: 6163 6b65 642e 6461 7461 2c0a 2020 2020  acked.data,.    
-00014a90: 2020 2020 2020 2020 736f 7572 6365 5f70          source_p
-00014aa0: 6163 6b65 642e 6261 7463 685f 7369 7a65  acked.batch_size
-00014ab0: 732c 0a20 2020 2020 2020 2020 2020 2028  s,.            (
-00014ac0: 7374 6174 655f 685f 7261 772c 2073 7461  state_h_raw, sta
-00014ad0: 7465 5f63 5f72 6177 292c 0a20 2020 2020  te_c_raw),.     
-00014ae0: 2020 2020 2020 206c 7374 6d5f 7061 7261         lstm_para
-00014af0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00014b00: 6861 735f 6269 6173 6573 3d68 6173 5f62  has_biases=has_b
-00014b10: 6961 7365 732c 0a20 2020 2020 2020 2020  iases,.         
-00014b20: 2020 206e 756d 5f6c 6179 6572 733d 312c     num_layers=1,
-00014b30: 0a20 2020 2020 2020 2020 2020 2064 726f  .            dro
-00014b40: 706f 7574 3d30 2e30 2c0a 2020 2020 2020  pout=0.0,.      
-00014b50: 2020 2020 2020 7472 6169 6e3d 7266 2e67        train=rf.g
-00014b60: 6574 5f72 756e 5f63 7478 2829 2e74 7261  et_run_ctx().tra
-00014b70: 696e 5f66 6c61 672c 0a20 2020 2020 2020  in_flag,.       
-00014b80: 2020 2020 2062 6964 6972 6563 7469 6f6e       bidirection
-00014b90: 616c 3d46 616c 7365 2c0a 2020 2020 2020  al=False,.      
-00014ba0: 2020 290a 0a20 2020 2020 2020 2023 2055    )..        # U
-00014bb0: 6e73 6f72 7420 7468 6520 6261 7463 6820  nsort the batch 
-00014bc0: 6469 6d73 2e0a 2020 2020 2020 2020 6e65  dims..        ne
-00014bd0: 775f 7374 6174 655f 685f 7261 7720 3d20  w_state_h_raw = 
-00014be0: 6e65 775f 7374 6174 655f 685f 7261 772e  new_state_h_raw.
-00014bf0: 696e 6465 785f 7365 6c65 6374 2864 696d  index_select(dim
-00014c00: 3d31 2c20 696e 6465 783d 736f 7572 6365  =1, index=source
-00014c10: 5f70 6163 6b65 642e 756e 736f 7274 6564  _packed.unsorted
-00014c20: 5f69 6e64 6963 6573 290a 2020 2020 2020  _indices).      
-00014c30: 2020 6e65 775f 7374 6174 655f 635f 7261    new_state_c_ra
-00014c40: 7720 3d20 6e65 775f 7374 6174 655f 635f  w = new_state_c_
-00014c50: 7261 772e 696e 6465 785f 7365 6c65 6374  raw.index_select
-00014c60: 2864 696d 3d31 2c20 696e 6465 783d 736f  (dim=1, index=so
-00014c70: 7572 6365 5f70 6163 6b65 642e 756e 736f  urce_packed.unso
-00014c80: 7274 6564 5f69 6e64 6963 6573 290a 2020  rted_indices).  
-00014c90: 2020 2020 2020 2320 556e 7061 636b 2074        # Unpack t
-00014ca0: 6865 2073 6571 7565 6e63 652e 0a20 2020  he sequence..   
-00014cb0: 2020 2020 206f 7574 7075 745f 7061 636b       output_pack
-00014cc0: 6564 203d 2074 6f72 6368 2e6e 6e2e 7574  ed = torch.nn.ut
-00014cd0: 696c 732e 726e 6e2e 5061 636b 6564 5365  ils.rnn.PackedSe
-00014ce0: 7175 656e 6365 280a 2020 2020 2020 2020  quence(.        
-00014cf0: 2020 2020 6f75 745f 7261 772c 0a20 2020      out_raw,.   
-00014d00: 2020 2020 2020 2020 2062 6174 6368 5f73           batch_s
-00014d10: 697a 6573 3d73 6f75 7263 655f 7061 636b  izes=source_pack
-00014d20: 6564 2e62 6174 6368 5f73 697a 6573 2c0a  ed.batch_sizes,.
-00014d30: 2020 2020 2020 2020 2020 2020 736f 7274              sort
-00014d40: 6564 5f69 6e64 6963 6573 3d73 6f75 7263  ed_indices=sourc
-00014d50: 655f 7061 636b 6564 2e73 6f72 7465 645f  e_packed.sorted_
-00014d60: 696e 6469 6365 732c 0a20 2020 2020 2020  indices,.       
-00014d70: 2020 2020 2075 6e73 6f72 7465 645f 696e       unsorted_in
-00014d80: 6469 6365 733d 736f 7572 6365 5f70 6163  dices=source_pac
-00014d90: 6b65 642e 756e 736f 7274 6564 5f69 6e64  ked.unsorted_ind
-00014da0: 6963 6573 2c0a 2020 2020 2020 2020 290a  ices,.        ).
-00014db0: 2020 2020 2020 2020 6f75 745f 7261 7720          out_raw 
-00014dc0: 3d20 746f 7263 682e 6e6e 2e75 7469 6c73  = torch.nn.utils
-00014dd0: 2e72 6e6e 2e70 6164 5f70 6163 6b65 645f  .rnn.pad_packed_
-00014de0: 7365 7175 656e 6365 286f 7574 7075 745f  sequence(output_
-00014df0: 7061 636b 6564 295b 305d 0a0a 2020 2020  packed)[0]..    
-00014e00: 2020 2020 6966 206c 656e 2862 6174 6368      if len(batch
-00014e10: 5f64 696d 7329 2021 3d20 313a 0a20 2020  _dims) != 1:.   
-00014e20: 2020 2020 2020 2020 206f 7574 5f72 6177           out_raw
-00014e30: 203d 2074 6f72 6368 2e72 6573 6861 7065   = torch.reshape
-00014e40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00014e50: 2020 6f75 745f 7261 772c 0a20 2020 2020    out_raw,.     
-00014e60: 2020 2020 2020 2020 2020 205b 7370 6174             [spat
-00014e70: 6961 6c5f 6469 6d2e 6765 745f 6469 6d5f  ial_dim.get_dim_
-00014e80: 7661 6c75 6528 295d 202b 205b 642e 6765  value()] + [d.ge
-00014e90: 745f 6469 6d5f 7661 6c75 6528 2920 666f  t_dim_value() fo
-00014ea0: 7220 6420 696e 2062 6174 6368 5f64 696d  r d in batch_dim
-00014eb0: 735d 202b 205b 6f75 745f 6469 6d2e 6765  s] + [out_dim.ge
-00014ec0: 745f 6469 6d5f 7661 6c75 6528 295d 2c0a  t_dim_value()],.
-00014ed0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00014ee0: 2020 2020 2020 6e65 775f 7374 6174 655f        new_state_
-00014ef0: 685f 7261 7720 3d20 746f 7263 682e 7265  h_raw = torch.re
-00014f00: 7368 6170 6528 6e65 775f 7374 6174 655f  shape(new_state_
-00014f10: 685f 7261 772c 205b 642e 6765 745f 6469  h_raw, [d.get_di
-00014f20: 6d5f 7661 6c75 6528 2920 666f 7220 6420  m_value() for d 
-00014f30: 696e 2073 7461 7465 5f68 2e64 696d 735d  in state_h.dims]
-00014f40: 290a 2020 2020 2020 2020 6e65 775f 7374  ).        new_st
-00014f50: 6174 655f 635f 7261 7720 3d20 746f 7263  ate_c_raw = torc
-00014f60: 682e 7265 7368 6170 6528 6e65 775f 7374  h.reshape(new_st
-00014f70: 6174 655f 635f 7261 772c 205b 642e 6765  ate_c_raw, [d.ge
-00014f80: 745f 6469 6d5f 7661 6c75 6528 2920 666f  t_dim_value() fo
-00014f90: 7220 6420 696e 2073 7461 7465 5f63 2e64  r d in state_c.d
-00014fa0: 696d 735d 290a 0a20 2020 2020 2020 206f  ims])..        o
-00014fb0: 7574 203d 2073 6f75 7263 652e 636f 7079  ut = source.copy
-00014fc0: 5f74 656d 706c 6174 655f 7265 706c 6163  _template_replac
-00014fd0: 655f 6469 6d5f 7461 6728 6178 6973 3d2d  e_dim_tag(axis=-
-00014fe0: 312c 206e 6577 5f64 696d 5f74 6167 3d6f  1, new_dim_tag=o
-00014ff0: 7574 5f64 696d 2c20 6e61 6d65 3d22 6c73  ut_dim, name="ls
-00015000: 746d 2229 0a20 2020 2020 2020 206f 7574  tm").        out
-00015010: 2e66 6561 7475 7265 5f64 696d 203d 206f  .feature_dim = o
-00015020: 7574 5f64 696d 0a20 2020 2020 2020 206f  ut_dim.        o
-00015030: 7574 2e72 6177 5f74 656e 736f 7220 3d20  ut.raw_tensor = 
-00015040: 6f75 745f 7261 770a 0a20 2020 2020 2020  out_raw..       
-00015050: 206e 6577 5f73 7461 7465 5f68 203d 2073   new_state_h = s
-00015060: 7461 7465 5f68 2e63 6f70 795f 7465 6d70  tate_h.copy_temp
-00015070: 6c61 7465 2829 0a20 2020 2020 2020 206e  late().        n
-00015080: 6577 5f73 7461 7465 5f68 2e72 6177 5f74  ew_state_h.raw_t
-00015090: 656e 736f 7220 3d20 6e65 775f 7374 6174  ensor = new_stat
-000150a0: 655f 685f 7261 770a 2020 2020 2020 2020  e_h_raw.        
-000150b0: 6e65 775f 7374 6174 655f 682e 6665 6174  new_state_h.feat
-000150c0: 7572 655f 6469 6d20 3d20 6f75 745f 6469  ure_dim = out_di
-000150d0: 6d0a 2020 2020 2020 2020 6e65 775f 7374  m.        new_st
-000150e0: 6174 655f 6320 3d20 7374 6174 655f 632e  ate_c = state_c.
-000150f0: 636f 7079 5f74 656d 706c 6174 6528 290a  copy_template().
-00015100: 2020 2020 2020 2020 6e65 775f 7374 6174          new_stat
-00015110: 655f 632e 7261 775f 7465 6e73 6f72 203d  e_c.raw_tensor =
-00015120: 206e 6577 5f73 7461 7465 5f63 5f72 6177   new_state_c_raw
-00015130: 0a20 2020 2020 2020 206e 6577 5f73 7461  .        new_sta
-00015140: 7465 5f63 2e66 6561 7475 7265 5f64 696d  te_c.feature_dim
-00015150: 203d 206f 7574 5f64 696d 0a0a 2020 2020   = out_dim..    
-00015160: 2020 2020 6966 2073 7175 6565 7a65 5f73      if squeeze_s
-00015170: 7061 7469 616c 5f64 696d 3a0a 2020 2020  patial_dim:.    
-00015180: 2020 2020 2020 2020 6f75 7420 3d20 6f75          out = ou
-00015190: 742e 636f 7079 5f73 7175 6565 7a65 5f61  t.copy_squeeze_a
-000151a0: 7865 7328 5b6f 7574 2e67 6574 5f61 7869  xes([out.get_axi
-000151b0: 735f 6672 6f6d 5f64 6573 6372 6970 7469  s_from_descripti
-000151c0: 6f6e 2873 7061 7469 616c 5f64 696d 295d  on(spatial_dim)]
-000151d0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-000151e0: 6e20 6f75 742c 2028 6e65 775f 7374 6174  n out, (new_stat
-000151f0: 655f 682c 206e 6577 5f73 7461 7465 5f63  e_h, new_state_c
-00015200: 290a 0a20 2020 2054 656e 736f 7241 7272  )..    TensorArr
-00015210: 6179 5479 7065 203d 204c 6973 745b 5465  ayType = List[Te
-00015220: 6e73 6f72 5d0a 0a20 2020 2040 7374 6174  nsor]..    @stat
-00015230: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00015240: 2074 656e 736f 725f 6172 7261 795f 756e   tensor_array_un
-00015250: 7374 6163 6b28 7465 6e73 6f72 3a20 5465  stack(tensor: Te
-00015260: 6e73 6f72 2c20 2a2c 2061 7869 733a 2044  nsor, *, axis: D
-00015270: 696d 2920 2d3e 2054 656e 736f 7241 7272  im) -> TensorArr
-00015280: 6179 5479 7065 3a0a 2020 2020 2020 2020  ayType:.        
-00015290: 2222 2275 6e73 7461 636b 2222 220a 2020  """unstack""".  
-000152a0: 2020 2020 2020 6178 6973 5f69 6e74 203d        axis_int =
-000152b0: 2074 656e 736f 722e 6765 745f 6178 6973   tensor.get_axis
-000152c0: 5f66 726f 6d5f 6465 7363 7269 7074 696f  _from_descriptio
-000152d0: 6e28 6178 6973 290a 2020 2020 2020 2020  n(axis).        
-000152e0: 6f75 745f 7465 6e73 6f72 735f 7261 7720  out_tensors_raw 
-000152f0: 3d20 746f 7263 682e 756e 6269 6e64 2874  = torch.unbind(t
-00015300: 656e 736f 722e 7261 775f 7465 6e73 6f72  ensor.raw_tensor
-00015310: 2c20 6469 6d3d 6178 6973 5f69 6e74 290a  , dim=axis_int).
-00015320: 2020 2020 2020 2020 6f75 745f 7465 6e73          out_tens
-00015330: 6f72 5f74 656d 706c 6174 6520 3d20 7465  or_template = te
-00015340: 6e73 6f72 2e63 6f70 795f 7465 6d70 6c61  nsor.copy_templa
-00015350: 7465 2829 2e63 6f70 795f 7465 6d70 6c61  te().copy_templa
-00015360: 7465 5f65 7863 6c75 6469 6e67 5f61 7869  te_excluding_axi
-00015370: 7328 6178 6973 5f69 6e74 290a 2020 2020  s(axis_int).    
-00015380: 2020 2020 6f75 745f 7465 6e73 6f72 7320      out_tensors 
-00015390: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-000153a0: 206f 7574 5f74 656e 736f 725f 7261 7720   out_tensor_raw 
-000153b0: 696e 206f 7574 5f74 656e 736f 7273 5f72  in out_tensors_r
-000153c0: 6177 3a0a 2020 2020 2020 2020 2020 2020  aw:.            
-000153d0: 6f75 745f 7465 6e73 6f72 203d 206f 7574  out_tensor = out
-000153e0: 5f74 656e 736f 725f 7465 6d70 6c61 7465  _tensor_template
-000153f0: 2e63 6f70 795f 7465 6d70 6c61 7465 2829  .copy_template()
-00015400: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00015410: 5f74 656e 736f 722e 7261 775f 7465 6e73  _tensor.raw_tens
-00015420: 6f72 203d 206f 7574 5f74 656e 736f 725f  or = out_tensor_
-00015430: 7261 770a 2020 2020 2020 2020 2020 2020  raw.            
-00015440: 6f75 745f 7465 6e73 6f72 732e 6170 7065  out_tensors.appe
-00015450: 6e64 286f 7574 5f74 656e 736f 7229 0a20  nd(out_tensor). 
-00015460: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-00015470: 745f 7465 6e73 6f72 730a 0a20 2020 2040  t_tensors..    @
-00015480: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-00015490: 2064 6566 2074 656e 736f 725f 6172 7261   def tensor_arra
-000154a0: 795f 7374 6163 6b28 7465 6e73 6f72 5f61  y_stack(tensor_a
-000154b0: 7272 6179 3a20 5465 6e73 6f72 4172 7261  rray: TensorArra
-000154c0: 7954 7970 652c 202a 2c20 6178 6973 3a20  yType, *, axis: 
-000154d0: 4469 6d2c 2074 656e 736f 725f 7465 6d70  Dim, tensor_temp
-000154e0: 6c61 7465 3a20 5465 6e73 6f72 2920 2d3e  late: Tensor) ->
-000154f0: 2054 656e 736f 723a 0a20 2020 2020 2020   Tensor:.       
-00015500: 2022 2222 7374 6163 6b22 2222 0a20 2020   """stack""".   
-00015510: 2020 2020 2069 6620 7465 6e73 6f72 5f61       if tensor_a
-00015520: 7272 6179 3a0a 2020 2020 2020 2020 2020  rray:.          
-00015530: 2020 2320 496e 2074 6865 2061 6374 7561    # In the actua
-00015540: 6c20 6172 7261 792c 2074 6865 2074 656e  l array, the ten
-00015550: 736f 7273 206d 6967 6874 2062 6520 6120  sors might be a 
-00015560: 6265 7474 6572 2074 656d 706c 6174 6520  better template 
-00015570: 2864 6966 6665 7265 6e74 2064 696d 206f  (different dim o
-00015580: 7264 6572 292e 0a20 2020 2020 2020 2020  rder)..         
-00015590: 2020 2023 2057 6520 616c 7265 6164 7920     # We already 
-000155a0: 6368 6563 6b65 6420 696e 2054 656e 736f  checked in Tenso
-000155b0: 7241 7272 6179 2074 6861 7420 7468 6579  rArray that they
-000155c0: 2061 7265 2063 6f6d 7061 7469 626c 652e   are compatible.
-000155d0: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
-000155e0: 736f 725f 7465 6d70 6c61 7465 203d 2074  sor_template = t
-000155f0: 656e 736f 725f 6172 7261 795b 305d 2e63  ensor_array[0].c
-00015600: 6f70 795f 7465 6d70 6c61 7465 2829 0a20  opy_template(). 
-00015610: 2020 2020 2020 206f 7574 5f74 656e 736f         out_tenso
-00015620: 7220 3d20 7465 6e73 6f72 5f74 656d 706c  r = tensor_templ
-00015630: 6174 652e 636f 7079 5f61 6464 5f64 696d  ate.copy_add_dim
-00015640: 5f62 795f 7461 6728 6178 6973 2c20 756e  _by_tag(axis, un
-00015650: 6272 6f61 6463 6173 743d 5472 7565 2c20  broadcast=True, 
-00015660: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00015670: 6966 206e 6f74 2074 656e 736f 725f 6172  if not tensor_ar
-00015680: 7261 793a 0a20 2020 2020 2020 2020 2020  ray:.           
-00015690: 2072 6574 7572 6e20 7266 2e7a 6572 6f73   return rf.zeros
-000156a0: 5f6c 696b 6528 6f75 745f 7465 6e73 6f72  _like(out_tensor
-000156b0: 290a 2020 2020 2020 2020 7465 6e73 6f72  ).        tensor
-000156c0: 5f61 7272 6179 5f72 6177 203d 205b 7465  _array_raw = [te
-000156d0: 6e73 6f72 2e63 6f70 795f 7472 616e 7370  nsor.copy_transp
-000156e0: 6f73 6528 7465 6e73 6f72 5f74 656d 706c  ose(tensor_templ
-000156f0: 6174 652e 6469 6d73 292e 7261 775f 7465  ate.dims).raw_te
-00015700: 6e73 6f72 2066 6f72 2074 656e 736f 7220  nsor for tensor 
-00015710: 696e 2074 656e 736f 725f 6172 7261 795d  in tensor_array]
-00015720: 0a20 2020 2020 2020 206f 7574 5f74 656e  .        out_ten
-00015730: 736f 725f 7261 7720 3d20 746f 7263 682e  sor_raw = torch.
-00015740: 7374 6163 6b28 7465 6e73 6f72 5f61 7272  stack(tensor_arr
-00015750: 6179 5f72 6177 2c20 6469 6d3d 3029 0a20  ay_raw, dim=0). 
-00015760: 2020 2020 2020 206f 7574 5f74 656e 736f         out_tenso
-00015770: 722e 7261 775f 7465 6e73 6f72 203d 206f  r.raw_tensor = o
-00015780: 7574 5f74 656e 736f 725f 7261 770a 2020  ut_tensor_raw.  
-00015790: 2020 2020 2020 7265 7475 726e 206f 7574        return out
-000157a0: 5f74 656e 736f 720a                      _tensor.
+00003d50: 696d 5d2c 0a20 2020 2020 2020 2068 616e  im],.        han
+00003d60: 646c 655f 6479 6e61 6d69 635f 6469 6d73  dle_dynamic_dims
+00003d70: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
+00003d80: 6d6f 6465 3a20 7374 7220 3d20 2263 6f6e  mode: str = "con
+00003d90: 7374 616e 7422 2c0a 2020 2020 2020 2020  stant",.        
+00003da0: 7661 6c75 653a 204f 7074 696f 6e61 6c5b  value: Optional[
+00003db0: 556e 696f 6e5b 7266 2e52 6177 5465 6e73  Union[rf.RawTens
+00003dc0: 6f72 5479 7065 732c 2054 656e 736f 725d  orTypes, Tensor]
+00003dd0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2920  ] = None,.    ) 
+00003de0: 2d3e 2054 656e 736f 723a 0a20 2020 2020  -> Tensor:.     
+00003df0: 2020 2022 2222 7061 6422 2222 0a20 2020     """pad""".   
+00003e00: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
+00003e10: 6f75 745f 6469 6d73 2920 3d3d 206c 656e  out_dims) == len
+00003e20: 2861 7865 7329 203d 3d20 6c65 6e28 7061  (axes) == len(pa
+00003e30: 6464 696e 6729 0a20 2020 2020 2020 206f  dding).        o
+00003e40: 7574 203d 2073 6f75 7263 652e 636f 7079  ut = source.copy
+00003e50: 5f74 656d 706c 6174 655f 6e65 775f 6469  _template_new_di
+00003e60: 6d5f 7461 6773 280a 2020 2020 2020 2020  m_tags(.        
+00003e70: 2020 2020 5b6f 7574 5f64 696d 735b 6178      [out_dims[ax
+00003e80: 6573 2e69 6e64 6578 2864 696d 295d 2069  es.index(dim)] i
+00003e90: 6620 6469 6d20 696e 2061 7865 7320 656c  f dim in axes el
+00003ea0: 7365 2064 696d 2066 6f72 2064 696d 2069  se dim for dim i
+00003eb0: 6e20 736f 7572 6365 2e64 696d 5f74 6167  n source.dim_tag
+00003ec0: 735d 2c20 6b65 6570 5f73 7065 6369 616c  s], keep_special
+00003ed0: 5f61 7865 733d 5472 7565 0a20 2020 2020  _axes=True.     
+00003ee0: 2020 2029 0a20 2020 2020 2020 2072 656d     ).        rem
+00003ef0: 6169 6e69 6e67 5f64 696d 7320 3d20 7365  aining_dims = se
+00003f00: 7428 6178 6573 290a 2020 2020 2020 2020  t(axes).        
+00003f10: 7261 775f 7061 6420 3d20 5b5d 0a20 2020  raw_pad = [].   
+00003f20: 2020 2020 2066 6f72 2064 696d 2069 6e20       for dim in 
+00003f30: 7265 7665 7273 6564 2873 6f75 7263 652e  reversed(source.
+00003f40: 6469 6d73 293a 0a20 2020 2020 2020 2020  dims):.         
+00003f50: 2020 2069 6620 6469 6d20 6e6f 7420 696e     if dim not in
+00003f60: 2072 656d 6169 6e69 6e67 5f64 696d 733a   remaining_dims:
+00003f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003f80: 2072 6177 5f70 6164 202b 3d20 5b30 2c20   raw_pad += [0, 
+00003f90: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00003fa0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00003fb0: 2020 2020 2020 2020 7265 6d61 696e 696e          remainin
+00003fc0: 675f 6469 6d73 2e72 656d 6f76 6528 6469  g_dims.remove(di
+00003fd0: 6d29 0a20 2020 2020 2020 2020 2020 2070  m).            p
+00003fe0: 6164 5f20 3d20 7061 6464 696e 675b 6178  ad_ = padding[ax
+00003ff0: 6573 2e69 6e64 6578 2864 696d 295d 0a20  es.index(dim)]. 
+00004000: 2020 2020 2020 2020 2020 2072 6177 5f70             raw_p
+00004010: 6164 202b 3d20 5b0a 2020 2020 2020 2020  ad += [.        
+00004020: 2020 2020 2020 2020 7061 645f 5b30 5d2e          pad_[0].
+00004030: 6765 745f 6469 6d5f 7661 6c75 6528 2920  get_dim_value() 
+00004040: 6966 2069 7369 6e73 7461 6e63 6528 7061  if isinstance(pa
+00004050: 645f 5b30 5d2c 2044 696d 2920 656c 7365  d_[0], Dim) else
+00004060: 2070 6164 5f5b 305d 2c0a 2020 2020 2020   pad_[0],.      
+00004070: 2020 2020 2020 2020 2020 7061 645f 5b31            pad_[1
+00004080: 5d2e 6765 745f 6469 6d5f 7661 6c75 6528  ].get_dim_value(
+00004090: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
+000040a0: 7061 645f 5b31 5d2c 2044 696d 2920 656c  pad_[1], Dim) el
+000040b0: 7365 2070 6164 5f5b 315d 2c0a 2020 2020  se pad_[1],.    
+000040c0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+000040d0: 2020 2020 2020 6966 206e 6f74 2072 656d        if not rem
+000040e0: 6169 6e69 6e67 5f64 696d 733a 0a20 2020  aining_dims:.   
+000040f0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00004100: 616b 0a20 2020 2020 2020 2069 6620 6973  ak.        if is
+00004110: 696e 7374 616e 6365 2876 616c 7565 2c20  instance(value, 
+00004120: 5465 6e73 6f72 293a 0a20 2020 2020 2020  Tensor):.       
+00004130: 2020 2020 2061 7373 6572 7420 7661 6c75       assert valu
+00004140: 652e 6469 6d73 203d 3d20 2829 2c20 6622  e.dims == (), f"
+00004150: 7661 6c75 6520 7b76 616c 7565 7d20 6d75  value {value} mu
+00004160: 7374 2062 6520 6120 7363 616c 6172 220a  st be a scalar".
+00004170: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+00004180: 6520 3d20 7661 6c75 652e 7261 775f 7465  e = value.raw_te
+00004190: 6e73 6f72 0a20 2020 2020 2020 206f 7574  nsor.        out
+000041a0: 2e72 6177 5f74 656e 736f 7220 3d20 746f  .raw_tensor = to
+000041b0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+000041c0: 6c2e 7061 6428 736f 7572 6365 2e72 6177  l.pad(source.raw
+000041d0: 5f74 656e 736f 722c 2070 6164 3d72 6177  _tensor, pad=raw
+000041e0: 5f70 6164 2c20 6d6f 6465 3d6d 6f64 652c  _pad, mode=mode,
+000041f0: 2076 616c 7565 3d76 616c 7565 290a 2020   value=value).  
+00004200: 2020 2020 2020 6966 2061 6e79 2864 696d        if any(dim
+00004210: 2e6e 6565 645f 6d61 736b 696e 6728 2920  .need_masking() 
+00004220: 666f 7220 6469 6d20 696e 206f 7574 5f64  for dim in out_d
+00004230: 696d 7329 2061 6e64 2068 616e 646c 655f  ims) and handle_
+00004240: 6479 6e61 6d69 635f 6469 6d73 3a0a 2020  dynamic_dims:.  
+00004250: 2020 2020 2020 2020 2020 6966 2061 6c6c            if all
+00004260: 2872 6967 6874 203d 3d20 3020 666f 7220  (right == 0 for 
+00004270: 7269 6768 7420 696e 2072 6177 5f70 6164  right in raw_pad
+00004280: 5b31 3a3a 325d 2920 616e 6420 6d6f 6465  [1::2]) and mode
+00004290: 2021 3d20 2263 6972 6375 6c61 7222 3a0a   != "circular":.
+000042a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042b0: 7061 7373 2020 2320 6e6f 206d 6173 6b69  pass  # no maski
+000042c0: 6e67 206e 6565 6465 640a 2020 2020 2020  ng needed.      
+000042d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000042e0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+000042f0: 6f64 6520 213d 2022 636f 6e73 7461 6e74  ode != "constant
+00004300: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00004310: 2020 2020 2020 2072 6169 7365 204e 6f74         raise Not
+00004320: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+00004330: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004340: 2020 2020 2020 2020 2020 6622 7061 643a            f"pad:
+00004350: 206d 6f64 6520 7b6d 6f64 657d 206e 6f74   mode {mode} not
+00004360: 2069 6d70 6c65 6d65 6e74 6564 2077 6974   implemented wit
+00004370: 6820 6479 6e61 6d69 6320 6469 6d73 2061  h dynamic dims a
+00004380: 6e64 2068 616e 646c 655f 6479 6e61 6d69  nd handle_dynami
+00004390: 635f 6469 6d73 3d54 7275 6522 0a20 2020  c_dims=True".   
+000043a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043b0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000043c0: 2020 2066 6f72 206f 7574 5f64 696d 2c20     for out_dim, 
+000043d0: 6d69 6464 6c65 2c20 286c 6566 742c 2072  middle, (left, r
+000043e0: 6967 6874 2920 696e 207a 6970 286f 7574  ight) in zip(out
+000043f0: 5f64 696d 732c 2061 7865 732c 2070 6164  _dims, axes, pad
+00004400: 6469 6e67 293a 0a20 2020 2020 2020 2020  ding):.         
+00004410: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
+00004420: 6464 6c65 2e6e 6565 645f 6d61 736b 696e  ddle.need_maskin
+00004430: 6728 2920 6f72 2028 6973 696e 7374 616e  g() or (isinstan
+00004440: 6365 286c 6566 742c 2044 696d 2920 616e  ce(left, Dim) an
+00004450: 6420 6c65 6674 2e6e 6565 645f 6d61 736b  d left.need_mask
+00004460: 696e 6728 2929 3a0a 2020 2020 2020 2020  ing()):.        
+00004470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004480: 6966 2069 7369 6e73 7461 6e63 6528 7269  if isinstance(ri
+00004490: 6768 742c 2044 696d 2920 6f72 2072 6967  ght, Dim) or rig
+000044a0: 6874 203e 2030 3a0a 2020 2020 2020 2020  ht > 0:.        
+000044b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044c0: 2020 2020 6d61 736b 203d 2072 662e 636f      mask = rf.co
+000044d0: 6d70 6172 655f 6263 280a 2020 2020 2020  mpare_bc(.      
+000044e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044f0: 2020 2020 2020 2020 2020 7266 2e72 616e            rf.ran
+00004500: 6765 5f6f 7665 725f 6469 6d28 6f75 745f  ge_over_dim(out_
+00004510: 6469 6d2c 2064 6576 6963 653d 6f75 742e  dim, device=out.
+00004520: 6465 7669 6365 292c 0a20 2020 2020 2020  device),.       
+00004530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004540: 2020 2020 2020 2020 2022 3c22 2c0a 2020           "<",.  
+00004550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004560: 2020 2020 2020 2020 2020 2020 2020 7266                rf
+00004570: 2e63 6f70 795f 746f 5f64 6576 6963 6528  .copy_to_device(
+00004580: 286c 6566 7420 2b20 6d69 6464 6c65 292e  (left + middle).
+00004590: 6479 6e5f 7369 7a65 5f65 7874 2c20 6f75  dyn_size_ext, ou
+000045a0: 742e 6465 7669 6365 292c 0a20 2020 2020  t.device),.     
+000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045e0: 2020 2020 206f 7574 2e72 6177 5f74 656e       out.raw_ten
+000045f0: 736f 7220 3d20 746f 7263 682e 7768 6572  sor = torch.wher
+00004600: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00004610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004620: 2020 206d 6173 6b2e 636f 7079 5f63 6f6d     mask.copy_com
+00004630: 7061 7469 626c 655f 746f 286f 7574 2c20  patible_to(out, 
+00004640: 6368 6563 6b5f 6474 7970 653d 4661 6c73  check_dtype=Fals
+00004650: 652c 2063 6865 636b 5f73 7061 7273 653d  e, check_sparse=
+00004660: 4661 6c73 6529 2e72 6177 5f74 656e 736f  False).raw_tenso
+00004670: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00004680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004690: 2020 206f 7574 2e72 6177 5f74 656e 736f     out.raw_tenso
+000046a0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+000046b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046c0: 2020 2076 616c 7565 2c0a 2020 2020 2020     value,.      
+000046d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000046f0: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
+00004700: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00004710: 2020 6465 6620 6375 6d5f 636f 6e63 6174    def cum_concat
+00004720: 5f73 7465 7028 736f 7572 6365 3a20 5465  _step(source: Te
+00004730: 6e73 6f72 2c20 2a2c 2070 7265 765f 6163  nsor, *, prev_ac
+00004740: 6375 6d3a 2054 656e 736f 722c 2061 7869  cum: Tensor, axi
+00004750: 733a 2044 696d 2c20 6f75 745f 7370 6174  s: Dim, out_spat
+00004760: 6961 6c5f 6469 6d3a 2044 696d 2920 2d3e  ial_dim: Dim) ->
+00004770: 2054 656e 736f 723a 0a20 2020 2020 2020   Tensor:.       
+00004780: 2022 2222 6375 6d20 636f 6e63 6174 2073   """cum concat s
+00004790: 7465 7022 2222 0a20 2020 2020 2020 206f  tep""".        o
+000047a0: 7574 203d 2070 7265 765f 6163 6375 6d2e  ut = prev_accum.
+000047b0: 636f 7079 5f74 656d 706c 6174 655f 7265  copy_template_re
+000047c0: 706c 6163 655f 6469 6d5f 7461 6728 0a20  place_dim_tag(. 
+000047d0: 2020 2020 2020 2020 2020 2061 7869 733d             axis=
+000047e0: 7072 6576 5f61 6363 756d 2e67 6574 5f61  prev_accum.get_a
+000047f0: 7869 735f 6672 6f6d 5f64 6573 6372 6970  xis_from_descrip
+00004800: 7469 6f6e 2861 7869 7329 2c0a 2020 2020  tion(axis),.    
+00004810: 2020 2020 2020 2020 6e65 775f 6469 6d5f          new_dim_
+00004820: 7461 673d 6f75 745f 7370 6174 6961 6c5f  tag=out_spatial_
+00004830: 6469 6d2c 0a20 2020 2020 2020 2020 2020  dim,.           
+00004840: 206e 616d 653d 6622 7b73 6f75 7263 652e   name=f"{source.
+00004850: 6e61 6d65 7d2f 6375 6d5f 636f 6e63 6174  name}/cum_concat
+00004860: 5f73 7465 7022 2c0a 2020 2020 2020 2020  _step",.        
+00004870: 290a 2020 2020 2020 2020 736f 7572 6365  ).        source
+00004880: 5f72 6177 203d 2073 6f75 7263 652e 636f  _raw = source.co
+00004890: 7079 5f63 6f6d 7061 7469 626c 655f 746f  py_compatible_to
+000048a0: 5f64 696d 735f 7261 7728 7072 6576 5f61  _dims_raw(prev_a
+000048b0: 6363 756d 2e64 696d 7329 0a20 2020 2020  ccum.dims).     
+000048c0: 2020 206f 7574 2e72 6177 5f74 656e 736f     out.raw_tenso
+000048d0: 7220 3d20 746f 7263 682e 6361 7428 2870  r = torch.cat((p
+000048e0: 7265 765f 6163 6375 6d2e 7261 775f 7465  rev_accum.raw_te
+000048f0: 6e73 6f72 2c20 736f 7572 6365 5f72 6177  nsor, source_raw
+00004900: 292c 2064 696d 3d70 7265 765f 6163 6375  ), dim=prev_accu
+00004910: 6d2e 6765 745f 6178 6973 5f66 726f 6d5f  m.get_axis_from_
+00004920: 6465 7363 7269 7074 696f 6e28 6178 6973  description(axis
+00004930: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+00004940: 6e20 6f75 740a 0a20 2020 2040 7374 6174  n out..    @stat
+00004950: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00004960: 2061 6374 6976 6174 696f 6e5f 7261 7728   activation_raw(
+00004970: 7261 775f 7465 6e73 6f72 3a20 746f 7263  raw_tensor: torc
+00004980: 682e 5465 6e73 6f72 2c20 6675 6e63 3a20  h.Tensor, func: 
+00004990: 7374 7229 202d 3e20 746f 7263 682e 5465  str) -> torch.Te
+000049a0: 6e73 6f72 3a0a 2020 2020 2020 2020 2222  nsor:.        ""
+000049b0: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
+000049c0: 2072 6177 5f74 656e 736f 723a 0a20 2020   raw_tensor:.   
+000049d0: 2020 2020 203a 7061 7261 6d20 6675 6e63       :param func
+000049e0: 3a20 652e 672e 2022 7461 6e68 220a 2020  : e.g. "tanh".  
+000049f0: 2020 2020 2020 3a72 6574 7572 6e3a 2072        :return: r
+00004a00: 6177 2074 656e 736f 7220 6166 7465 7220  aw tensor after 
+00004a10: 6163 7469 7661 7469 6f6e 0a20 2020 2020  activation.     
+00004a20: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
+00004a30: 7373 6572 7420 6675 6e63 2069 6e20 4261  ssert func in Ba
+00004a40: 636b 656e 642e 5f41 6c6c 6f77 6564 4163  ckend._AllowedAc
+00004a50: 7469 7661 7469 6f6e 4675 6e63 730a 2020  tivationFuncs.  
+00004a60: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
+00004a70: 2874 6f72 6368 2c20 6675 6e63 293a 0a20  (torch, func):. 
+00004a80: 2020 2020 2020 2020 2020 2066 203d 2067             f = g
+00004a90: 6574 6174 7472 2874 6f72 6368 2c20 6675  etattr(torch, fu
+00004aa0: 6e63 290a 2020 2020 2020 2020 656c 6966  nc).        elif
+00004ab0: 2068 6173 6174 7472 2874 6f72 6368 2e6e   hasattr(torch.n
+00004ac0: 6e2e 6675 6e63 7469 6f6e 616c 2c20 6675  n.functional, fu
+00004ad0: 6e63 293a 0a20 2020 2020 2020 2020 2020  nc):.           
+00004ae0: 2066 203d 2067 6574 6174 7472 2874 6f72   f = getattr(tor
+00004af0: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
+00004b00: 2c20 6675 6e63 290a 2020 2020 2020 2020  , func).        
+00004b10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00004b20: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00004b30: 6f72 2866 2275 6e6b 6e6f 776e 2061 6374  or(f"unknown act
+00004b40: 6976 6174 696f 6e20 6675 6e63 7469 6f6e  ivation function
+00004b50: 207b 6675 6e63 2172 7d22 290a 2020 2020   {func!r}").    
+00004b60: 2020 2020 7265 7475 726e 2066 2872 6177      return f(raw
+00004b70: 5f74 656e 736f 7229 0a0a 2020 2020 4073  _tensor)..    @s
+00004b80: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00004b90: 6465 6620 736f 6674 6d61 7828 7465 6e73  def softmax(tens
+00004ba0: 6f72 3a20 5465 6e73 6f72 2c20 2a2c 2061  or: Tensor, *, a
+00004bb0: 7869 733a 2044 696d 2c20 7573 655f 6d61  xis: Dim, use_ma
+00004bc0: 736b 3a20 626f 6f6c 203d 2054 7275 6529  sk: bool = True)
+00004bd0: 202d 3e20 5465 6e73 6f72 3a0a 2020 2020   -> Tensor:.    
+00004be0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00004bf0: 3a70 6172 616d 2074 656e 736f 723a 0a20  :param tensor:. 
+00004c00: 2020 2020 2020 203a 7061 7261 6d20 6178         :param ax
+00004c10: 6973 3a0a 2020 2020 2020 2020 3a70 6172  is:.        :par
+00004c20: 616d 2075 7365 5f6d 6173 6b3a 0a20 2020  am use_mask:.   
+00004c30: 2020 2020 203a 7265 7475 726e 3a20 736f       :return: so
+00004c40: 6674 6d61 7820 6f76 6572 2061 7869 730a  ftmax over axis.
+00004c50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00004c60: 2020 2020 6f75 7420 3d20 7465 6e73 6f72      out = tensor
+00004c70: 2e63 6f70 795f 7465 6d70 6c61 7465 2822  .copy_template("
+00004c80: 736f 6674 6d61 7822 290a 2020 2020 2020  softmax").      
+00004c90: 2020 6966 2075 7365 5f6d 6173 6b20 616e    if use_mask an
+00004ca0: 6420 6178 6973 2e6e 6565 645f 6d61 736b  d axis.need_mask
+00004cb0: 696e 6728 293a 0a20 2020 2020 2020 2020  ing():.         
+00004cc0: 2020 2074 656e 736f 7220 3d20 7465 6e73     tensor = tens
+00004cd0: 6f72 2e63 6f70 7928 290a 2020 2020 2020  or.copy().      
+00004ce0: 2020 2020 2020 6d61 736b 203d 2074 656e        mask = ten
+00004cf0: 736f 722e 6765 745f 7365 7175 656e 6365  sor.get_sequence
+00004d00: 5f6d 6173 6b5f 6272 6f61 6463 6173 7428  _mask_broadcast(
+00004d10: 6178 6973 3d61 7869 7329 0a20 2020 2020  axis=axis).     
+00004d20: 2020 2020 2020 2069 6e66 5f76 616c 7565         inf_value
+00004d30: 203d 2067 6574 5f67 6c6f 6261 6c5f 696e   = get_global_in
+00004d40: 665f 7661 6c75 6528 290a 2020 2020 2020  f_value().      
+00004d50: 2020 2020 2020 7465 6e73 6f72 2e72 6177        tensor.raw
+00004d60: 5f74 656e 736f 7220 3d20 746f 7263 682e  _tensor = torch.
+00004d70: 7768 6572 6528 6d61 736b 2c20 7465 6e73  where(mask, tens
+00004d80: 6f72 2e72 6177 5f74 656e 736f 722c 202d  or.raw_tensor, -
+00004d90: 696e 665f 7661 6c75 6529 0a20 2020 2020  inf_value).     
+00004da0: 2020 206f 7574 5f72 6177 203d 2074 6f72     out_raw = tor
+00004db0: 6368 2e73 6f66 746d 6178 2874 656e 736f  ch.softmax(tenso
+00004dc0: 722e 7261 775f 7465 6e73 6f72 2c20 6469  r.raw_tensor, di
+00004dd0: 6d3d 7465 6e73 6f72 2e64 696d 732e 696e  m=tensor.dims.in
+00004de0: 6465 7828 6178 6973 2929 0a20 2020 2020  dex(axis)).     
+00004df0: 2020 206f 7574 2e64 7479 7065 203d 2054     out.dtype = T
+00004e00: 6f72 6368 4261 636b 656e 642e 6765 745f  orchBackend.get_
+00004e10: 6474 7970 655f 6e61 6d65 5f72 6177 286f  dtype_name_raw(o
+00004e20: 7574 5f72 6177 290a 2020 2020 2020 2020  ut_raw).        
+00004e30: 6f75 742e 7261 775f 7465 6e73 6f72 203d  out.raw_tensor =
+00004e40: 206f 7574 5f72 6177 0a20 2020 2020 2020   out_raw.       
+00004e50: 2072 6574 7572 6e20 6f75 740a 0a20 2020   return out..   
+00004e60: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00004e70: 2020 2064 6566 206c 6f67 5f73 6f66 746d     def log_softm
+00004e80: 6178 2874 656e 736f 723a 2054 656e 736f  ax(tensor: Tenso
+00004e90: 722c 202a 2c20 6178 6973 3a20 4469 6d2c  r, *, axis: Dim,
+00004ea0: 2075 7365 5f6d 6173 6b3a 2062 6f6f 6c20   use_mask: bool 
+00004eb0: 3d20 5472 7565 2920 2d3e 2054 656e 736f  = True) -> Tenso
+00004ec0: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+00004ed0: 2020 2020 2020 203a 7061 7261 6d20 7465         :param te
+00004ee0: 6e73 6f72 3a0a 2020 2020 2020 2020 3a70  nsor:.        :p
+00004ef0: 6172 616d 2061 7869 733a 0a20 2020 2020  aram axis:.     
+00004f00: 2020 203a 7061 7261 6d20 7573 655f 6d61     :param use_ma
+00004f10: 736b 3a0a 2020 2020 2020 2020 3a72 6574  sk:.        :ret
+00004f20: 7572 6e3a 206c 6f67 5f73 6f66 746d 6178  urn: log_softmax
+00004f30: 206f 7665 7220 6178 6973 0a20 2020 2020   over axis.     
+00004f40: 2020 2022 2222 0a20 2020 2020 2020 206f     """.        o
+00004f50: 7574 203d 2074 656e 736f 722e 636f 7079  ut = tensor.copy
+00004f60: 5f74 656d 706c 6174 6528 226c 6f67 5f73  _template("log_s
+00004f70: 6f66 746d 6178 2229 0a20 2020 2020 2020  oftmax").       
+00004f80: 2069 6620 7573 655f 6d61 736b 2061 6e64   if use_mask and
+00004f90: 2061 7869 732e 6e65 6564 5f6d 6173 6b69   axis.need_maski
+00004fa0: 6e67 2829 3a0a 2020 2020 2020 2020 2020  ng():.          
+00004fb0: 2020 7465 6e73 6f72 203d 2074 656e 736f    tensor = tenso
+00004fc0: 722e 636f 7079 2829 0a20 2020 2020 2020  r.copy().       
+00004fd0: 2020 2020 206d 6173 6b20 3d20 7465 6e73       mask = tens
+00004fe0: 6f72 2e67 6574 5f73 6571 7565 6e63 655f  or.get_sequence_
+00004ff0: 6d61 736b 5f62 726f 6164 6361 7374 2861  mask_broadcast(a
+00005000: 7869 733d 6178 6973 290a 2020 2020 2020  xis=axis).      
+00005010: 2020 2020 2020 696e 665f 7661 6c75 6520        inf_value 
+00005020: 3d20 6765 745f 676c 6f62 616c 5f69 6e66  = get_global_inf
+00005030: 5f76 616c 7565 2829 0a20 2020 2020 2020  _value().       
+00005040: 2020 2020 2074 656e 736f 722e 7261 775f       tensor.raw_
+00005050: 7465 6e73 6f72 203d 2074 6f72 6368 2e77  tensor = torch.w
+00005060: 6865 7265 286d 6173 6b2c 2074 656e 736f  here(mask, tenso
+00005070: 722e 7261 775f 7465 6e73 6f72 2c20 2d69  r.raw_tensor, -i
+00005080: 6e66 5f76 616c 7565 290a 2020 2020 2020  nf_value).      
+00005090: 2020 6f75 745f 7261 7720 3d20 746f 7263    out_raw = torc
+000050a0: 682e 6c6f 675f 736f 6674 6d61 7828 7465  h.log_softmax(te
+000050b0: 6e73 6f72 2e72 6177 5f74 656e 736f 722c  nsor.raw_tensor,
+000050c0: 2064 696d 3d74 656e 736f 722e 6469 6d73   dim=tensor.dims
+000050d0: 2e69 6e64 6578 2861 7869 7329 290a 2020  .index(axis)).  
+000050e0: 2020 2020 2020 6f75 742e 6474 7970 6520        out.dtype 
+000050f0: 3d20 546f 7263 6842 6163 6b65 6e64 2e67  = TorchBackend.g
+00005100: 6574 5f64 7479 7065 5f6e 616d 655f 7261  et_dtype_name_ra
+00005110: 7728 6f75 745f 7261 7729 0a20 2020 2020  w(out_raw).     
+00005120: 2020 206f 7574 2e72 6177 5f74 656e 736f     out.raw_tenso
+00005130: 7220 3d20 6f75 745f 7261 770a 2020 2020  r = out_raw.    
+00005140: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
+00005150: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+00005160: 640a 2020 2020 6465 6620 736f 6674 6d61  d.    def softma
+00005170: 785f 6372 6f73 735f 656e 7472 6f70 795f  x_cross_entropy_
+00005180: 7769 7468 5f6c 6f67 6974 7328 2a2c 206c  with_logits(*, l
+00005190: 6f67 6974 733a 2054 656e 736f 722c 2074  ogits: Tensor, t
+000051a0: 6172 6765 7473 3a20 5465 6e73 6f72 2c20  argets: Tensor, 
+000051b0: 6178 6973 3a20 4469 6d29 3a0a 2020 2020  axis: Dim):.    
+000051c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000051d0: 4566 6669 6369 656e 7420 6372 6f73 7320  Efficient cross 
+000051e0: 656e 7472 6f70 792e 2046 6f72 2050 7954  entropy. For PyT
+000051f0: 6f72 6368 2074 6869 7320 6973 2061 6374  orch this is act
+00005200: 7561 6c6c 7920 7468 6520 6465 6661 756c  ually the defaul
+00005210: 7420 6372 6f73 7320 656e 7472 6f70 7920  t cross entropy 
+00005220: 6675 6e63 7469 6f6e 2e0a 2020 2020 2020  function..      
+00005230: 2020 2874 6f72 6368 2e6e 6e2e 6675 6e63    (torch.nn.func
+00005240: 7469 6f6e 616c 2e63 726f 7373 5f65 6e74  tional.cross_ent
+00005250: 726f 7079 290a 0a20 2020 2020 2020 203a  ropy)..        :
+00005260: 7061 7261 6d20 6c6f 6769 7473 3a20 7461  param logits: ta
+00005270: 7267 6574 2065 7374 696d 6174 6573 2067  rget estimates g
+00005280: 6976 656e 2061 7320 696e 7075 7473 2074  iven as inputs t
+00005290: 6f20 736f 6674 6d61 7820 2869 2e65 2e20  o softmax (i.e. 
+000052a0: 756e 6e6f 726d 616c 697a 6564 290a 2020  unnormalized).  
+000052b0: 2020 2020 2020 3a70 6172 616d 2074 6172        :param tar
+000052c0: 6765 7473 3a20 7072 6f62 6162 696c 6974  gets: probabilit
+000052d0: 6965 732c 2069 2e65 2e20 6e6f 726d 616c  ies, i.e. normal
+000052e0: 697a 6564 2c20 6361 6e20 616c 736f 2062  ized, can also b
+000052f0: 6520 7370 6172 7365 0a20 2020 2020 2020  e sparse.       
+00005300: 203a 7061 7261 6d20 6178 6973 3a20 636c   :param axis: cl
+00005310: 6173 7320 6c61 6265 6c73 2064 696d 206f  ass labels dim o
+00005320: 7665 7220 7768 6963 6820 736f 6674 6d61  ver which softma
+00005330: 7820 6973 2063 6f6d 7075 7465 640a 2020  x is computed.  
+00005340: 2020 2020 2020 3a72 6574 7572 6e3a 2063        :return: c
+00005350: 726f 7373 2065 6e74 726f 7079 2028 7361  ross entropy (sa
+00005360: 6d65 2044 696d 7320 6173 2027 6c6f 6769  me Dims as 'logi
+00005370: 7473 2720 6275 7420 7769 7468 6f75 7420  ts' but without 
+00005380: 2761 7869 7327 290a 2020 2020 2020 2020  'axis').        
+00005390: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
+000053a0: 7274 2061 7869 7320 696e 206c 6f67 6974  rt axis in logit
+000053b0: 732e 6469 6d73 2c20 2253 7065 6369 6669  s.dims, "Specifi
+000053c0: 6564 2061 7869 7320 6e6f 7420 7072 6573  ed axis not pres
+000053d0: 656e 7420 696e 206c 6f67 6974 732e 220a  ent in logits.".
+000053e0: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
+000053f0: 203d 3d20 7461 7267 6574 732e 7370 6172   == targets.spar
+00005400: 7365 5f64 696d 3a0a 2020 2020 2020 2020  se_dim:.        
+00005410: 2020 2020 6173 7365 7274 2028 0a20 2020      assert (.   
+00005420: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00005430: 6974 732e 6469 6d73 5f73 6574 202d 207b  its.dims_set - {
+00005440: 6178 6973 7d20 3d3d 2074 6172 6765 7473  axis} == targets
+00005450: 2e64 696d 735f 7365 740a 2020 2020 2020  .dims_set.      
+00005460: 2020 2020 2020 292c 2022 6c6f 6769 7473        ), "logits
+00005470: 2044 696d 7320 616e 6420 7461 7267 6574   Dims and target
+00005480: 2044 696d 7320 6861 7665 2074 6f20 6d61   Dims have to ma
+00005490: 7463 6820 2865 7863 6570 7420 666f 7220  tch (except for 
+000054a0: 696d 706c 6963 6974 2073 7061 7273 655f  implicit sparse_
+000054b0: 6469 6d29 2e22 0a0a 2020 2020 2020 2020  dim)."..        
+000054c0: 2020 2020 6c6f 6769 7473 5f64 696d 5f6f      logits_dim_o
+000054d0: 7264 6572 203d 206c 6973 7428 7461 7267  rder = list(targ
+000054e0: 6574 732e 6469 6d73 290a 2020 2020 2020  ets.dims).      
+000054f0: 2020 2020 2020 6966 206c 656e 286c 6f67        if len(log
+00005500: 6974 735f 6469 6d5f 6f72 6465 7229 203e  its_dim_order) >
+00005510: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00005520: 2020 2020 2320 5079 546f 7263 6827 7320      # PyTorch's 
+00005530: 6372 6f73 735f 656e 7472 6f70 7920 6578  cross_entropy ex
+00005540: 7065 6374 7320 636c 6173 7320 7072 6f62  pects class prob
+00005550: 6162 696c 6974 6965 7320 6f76 6572 2073  abilities over s
+00005560: 6563 6f6e 6420 6178 6973 2e0a 2020 2020  econd axis..    
+00005570: 2020 2020 2020 2020 2020 2020 6c6f 6769              logi
+00005580: 7473 5f64 696d 5f6f 7264 6572 2e69 6e73  ts_dim_order.ins
+00005590: 6572 7428 312c 2061 7869 7329 0a20 2020  ert(1, axis).   
+000055a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000055b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000055c0: 6f67 6974 735f 6469 6d5f 6f72 6465 7220  ogits_dim_order 
+000055d0: 3d20 5b61 7869 735d 0a0a 2020 2020 2020  = [axis]..      
+000055e0: 2020 2020 2020 6966 2074 6172 6765 7473        if targets
+000055f0: 2e64 7479 7065 2021 3d20 2269 6e74 3634  .dtype != "int64
+00005600: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00005610: 2020 2074 6172 6765 7473 203d 2074 6172     targets = tar
+00005620: 6765 7473 2e63 6f70 7928 290a 2020 2020  gets.copy().    
+00005630: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00005640: 6574 732e 6474 7970 6520 3d20 2269 6e74  ets.dtype = "int
+00005650: 3634 220a 2020 2020 2020 2020 2020 2020  64".            
+00005660: 2020 2020 7461 7267 6574 732e 7261 775f      targets.raw_
+00005670: 7465 6e73 6f72 203d 2074 6172 6765 7473  tensor = targets
+00005680: 2e72 6177 5f74 656e 736f 722e 6c6f 6e67  .raw_tensor.long
+00005690: 2829 0a0a 2020 2020 2020 2020 656c 7365  ()..        else
+000056a0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+000056b0: 7365 7274 2028 0a20 2020 2020 2020 2020  sert (.         
+000056c0: 2020 2020 2020 206e 6f74 2074 6172 6765         not targe
+000056d0: 7473 2e73 7061 7273 655f 6469 6d0a 2020  ts.sparse_dim.  
+000056e0: 2020 2020 2020 2020 2020 292c 2022 5765            ), "We
+000056f0: 2065 7870 6563 7420 7468 6174 2063 726f   expect that cro
+00005700: 7373 2065 6e74 726f 7079 2077 6f75 6c64  ss entropy would
+00005710: 2061 6c77 6179 7320 6265 2063 616c 6375   always be calcu
+00005720: 6c61 7465 6420 616c 6f6e 6720 7468 6520  lated along the 
+00005730: 7370 6172 7365 2064 696d 2c20 6966 2074  sparse dim, if t
+00005740: 6865 7265 2069 7320 6f6e 652e 220a 2020  here is one.".  
+00005750: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00005760: 206c 6f67 6974 732e 6469 6d73 5f73 6574   logits.dims_set
+00005770: 203d 3d20 7461 7267 6574 732e 6469 6d73   == targets.dims
+00005780: 5f73 6574 2c20 226c 6f67 6974 7320 4469  _set, "logits Di
+00005790: 6d73 2061 6e64 2074 6172 6765 7420 4469  ms and target Di
+000057a0: 6d73 2068 6176 6520 746f 206d 6174 6368  ms have to match
+000057b0: 2e22 0a20 2020 2020 2020 2020 2020 2061  .".            a
+000057c0: 7373 6572 7420 6178 6973 2069 6e20 7461  ssert axis in ta
+000057d0: 7267 6574 732e 6469 6d73 2c20 2253 7065  rgets.dims, "Spe
+000057e0: 6369 6669 6564 2061 7869 7320 6e6f 7420  cified axis not 
+000057f0: 7072 6573 656e 7420 696e 2074 6172 6765  present in targe
+00005800: 7473 2e22 0a0a 2020 2020 2020 2020 2020  ts."..          
+00005810: 2020 6966 206c 656e 2874 6172 6765 7473    if len(targets
+00005820: 2e64 696d 7329 203e 2031 3a0a 2020 2020  .dims) > 1:.    
+00005830: 2020 2020 2020 2020 2020 2020 2320 5079              # Py
+00005840: 546f 7263 6827 7320 6372 6f73 735f 656e  Torch's cross_en
+00005850: 7472 6f70 7920 6578 7065 6374 7320 636c  tropy expects cl
+00005860: 6173 7320 7072 6f62 6162 696c 6974 6965  ass probabilitie
+00005870: 7320 6f76 6572 2073 6563 6f6e 6420 6178  s over second ax
+00005880: 6973 2e0a 2020 2020 2020 2020 2020 2020  is..            
+00005890: 2020 2020 7461 7267 6574 7320 3d20 7461      targets = ta
+000058a0: 7267 6574 732e 636f 7079 5f6d 6f76 655f  rgets.copy_move_
+000058b0: 6178 6973 2874 6172 6765 7473 2e64 696d  axis(targets.dim
+000058c0: 732e 696e 6465 7828 6178 6973 292c 2031  s.index(axis), 1
+000058d0: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
+000058e0: 6f67 6974 735f 6469 6d5f 6f72 6465 7220  ogits_dim_order 
+000058f0: 3d20 7461 7267 6574 732e 6469 6d73 0a0a  = targets.dims..
+00005900: 2020 2020 2020 2020 2320 5765 206e 6565          # We nee
+00005910: 6420 7361 6d65 206f 7264 6572 206f 6620  d same order of 
+00005920: 6178 6573 2061 7320 696e 2074 6172 6765  axes as in targe
+00005930: 742e 0a20 2020 2020 2020 206c 6f67 6974  t..        logit
+00005940: 735f 6178 6573 5f70 6572 6d75 7461 7469  s_axes_permutati
+00005950: 6f6e 203d 205b 6c6f 6769 7473 5f64 696d  on = [logits_dim
+00005960: 5f6f 7264 6572 2e69 6e64 6578 2864 696d  _order.index(dim
+00005970: 2920 666f 7220 6469 6d20 696e 206c 6f67  ) for dim in log
+00005980: 6974 732e 6469 6d73 5d0a 2020 2020 2020  its.dims].      
+00005990: 2020 6c6f 6769 7473 203d 206c 6f67 6974    logits = logit
+000059a0: 732e 636f 7079 5f74 7261 6e73 706f 7365  s.copy_transpose
+000059b0: 286c 6f67 6974 735f 6178 6573 5f70 6572  (logits_axes_per
+000059c0: 6d75 7461 7469 6f6e 290a 0a20 2020 2020  mutation)..     
+000059d0: 2020 2072 6177 5f63 726f 7373 5f65 6e74     raw_cross_ent
+000059e0: 726f 7079 203d 2074 6f72 6368 2e6e 6e2e  ropy = torch.nn.
+000059f0: 6675 6e63 7469 6f6e 616c 2e63 726f 7373  functional.cross
+00005a00: 5f65 6e74 726f 7079 280a 2020 2020 2020  _entropy(.      
+00005a10: 2020 2020 2020 696e 7075 743d 6c6f 6769        input=logi
+00005a20: 7473 2e72 6177 5f74 656e 736f 722c 2074  ts.raw_tensor, t
+00005a30: 6172 6765 743d 7461 7267 6574 732e 7261  arget=targets.ra
+00005a40: 775f 7465 6e73 6f72 2c20 7265 6475 6374  w_tensor, reduct
+00005a50: 696f 6e3d 226e 6f6e 6522 0a20 2020 2020  ion="none".     
+00005a60: 2020 2029 0a0a 2020 2020 2020 2020 6f75     )..        ou
+00005a70: 745f 6469 6d73 203d 206c 6973 7428 6c6f  t_dims = list(lo
+00005a80: 6769 7473 2e64 696d 7329 0a20 2020 2020  gits.dims).     
+00005a90: 2020 206f 7574 5f64 696d 732e 7265 6d6f     out_dims.remo
+00005aa0: 7665 2861 7869 7329 0a0a 2020 2020 2020  ve(axis)..      
+00005ab0: 2020 6372 6f73 735f 656e 7472 6f70 7920    cross_entropy 
+00005ac0: 3d20 5465 6e73 6f72 286e 616d 653d 2263  = Tensor(name="c
+00005ad0: 726f 7373 5f65 6e74 726f 7079 222c 2064  ross_entropy", d
+00005ae0: 696d 733d 6f75 745f 6469 6d73 2c20 7261  ims=out_dims, ra
+00005af0: 775f 7465 6e73 6f72 3d72 6177 5f63 726f  w_tensor=raw_cro
+00005b00: 7373 5f65 6e74 726f 7079 2c20 6474 7970  ss_entropy, dtyp
+00005b10: 653d 6c6f 6769 7473 2e64 7479 7065 290a  e=logits.dtype).
+00005b20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00005b30: 6372 6f73 735f 656e 7472 6f70 790a 0a20  cross_entropy.. 
+00005b40: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+00005b50: 0a20 2020 2064 6566 2063 7463 5f6c 6f73  .    def ctc_los
+00005b60: 7328 0a20 2020 2020 2020 202a 2c0a 2020  s(.        *,.  
+00005b70: 2020 2020 2020 6c6f 6769 7473 3a20 5465        logits: Te
+00005b80: 6e73 6f72 2c0a 2020 2020 2020 2020 7461  nsor,.        ta
+00005b90: 7267 6574 733a 2054 656e 736f 722c 0a20  rgets: Tensor,. 
+00005ba0: 2020 2020 2020 2069 6e70 7574 5f73 7061         input_spa
+00005bb0: 7469 616c 5f64 696d 3a20 4469 6d2c 0a20  tial_dim: Dim,. 
+00005bc0: 2020 2020 2020 2074 6172 6765 7473 5f73         targets_s
+00005bd0: 7061 7469 616c 5f64 696d 3a20 4469 6d2c  patial_dim: Dim,
+00005be0: 0a20 2020 2020 2020 2062 6c61 6e6b 5f69  .        blank_i
+00005bf0: 6e64 6578 3a20 696e 742c 0a20 2020 2020  ndex: int,.     
+00005c00: 2020 206d 6178 5f61 7070 726f 783a 2062     max_approx: b
+00005c10: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00005c20: 2029 202d 3e20 5465 6e73 6f72 3a0a 2020   ) -> Tensor:.  
+00005c30: 2020 2020 2020 2222 2243 5443 2222 220a        """CTC""".
+00005c40: 2020 2020 2020 2020 6966 206d 6178 5f61          if max_a
+00005c50: 7070 726f 783a 0a20 2020 2020 2020 2020  pprox:.         
+00005c60: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+00005c70: 656d 656e 7465 6445 7272 6f72 2822 6374  ementedError("ct
+00005c80: 635f 6c6f 7373 3a20 6d61 785f 6170 7072  c_loss: max_appr
+00005c90: 6f78 206e 6f74 2069 6d70 6c65 6d65 6e74  ox not implement
+00005ca0: 6564 2066 6f72 2050 7954 6f72 6368 2229  ed for PyTorch")
+00005cb0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00005cc0: 7461 7267 6574 732e 7370 6172 7365 5f64  targets.sparse_d
+00005cd0: 696d 2061 6e64 2074 6172 6765 7473 2e73  im and targets.s
+00005ce0: 7061 7273 655f 6469 6d2e 6469 6d65 6e73  parse_dim.dimens
+00005cf0: 696f 6e20 3c3d 206c 6f67 6974 732e 6665  ion <= logits.fe
+00005d00: 6174 7572 655f 6469 6d2e 6469 6d65 6e73  ature_dim.dimens
+00005d10: 696f 6e0a 2020 2020 2020 2020 2320 5079  ion.        # Py
+00005d20: 546f 7263 6820 6578 7065 6374 7320 7468  Torch expects th
+00005d30: 6520 6c6f 6769 7473 2074 6f20 6265 206f  e logits to be o
+00005d40: 6620 7368 6170 6520 2854 2c20 422c 2043  f shape (T, B, C
+00005d50: 2920 7768 6572 6520 5420 6973 2074 6865  ) where T is the
+00005d60: 2069 6e70 7574 2073 7061 7469 616c 2064   input spatial d
+00005d70: 696d 2e0a 2020 2020 2020 2020 6261 7463  im..        batc
+00005d80: 685f 6469 6d73 203d 206c 6f67 6974 732e  h_dims = logits.
+00005d90: 7265 6d61 696e 696e 675f 6469 6d73 2828  remaining_dims((
+00005da0: 696e 7075 745f 7370 6174 6961 6c5f 6469  input_spatial_di
+00005db0: 6d2c 206c 6f67 6974 732e 6665 6174 7572  m, logits.featur
+00005dc0: 655f 6469 6d29 290a 2020 2020 2020 2020  e_dim)).        
+00005dd0: 6c6f 6769 7473 203d 206c 6f67 6974 732e  logits = logits.
+00005de0: 636f 7079 5f74 7261 6e73 706f 7365 285b  copy_transpose([
+00005df0: 696e 7075 745f 7370 6174 6961 6c5f 6469  input_spatial_di
+00005e00: 6d5d 202b 2062 6174 6368 5f64 696d 7320  m] + batch_dims 
+00005e10: 2b20 5b6c 6f67 6974 732e 6665 6174 7572  + [logits.featur
+00005e20: 655f 6469 6d5d 290a 2020 2020 2020 2020  e_dim]).        
+00005e30: 6c6f 6769 7473 5f72 6177 3a20 746f 7263  logits_raw: torc
+00005e40: 682e 5465 6e73 6f72 203d 206c 6f67 6974  h.Tensor = logit
+00005e50: 732e 7261 775f 7465 6e73 6f72 0a20 2020  s.raw_tensor.   
+00005e60: 2020 2020 2069 6e70 7574 5f6c 656e 6774       input_lengt
+00005e70: 6873 203d 2069 6e70 7574 5f73 7061 7469  hs = input_spati
+00005e80: 616c 5f64 696d 2e64 796e 5f73 697a 655f  al_dim.dyn_size_
+00005e90: 6578 742e 636f 7079 5f74 7261 6e73 706f  ext.copy_transpo
+00005ea0: 7365 2862 6174 6368 5f64 696d 7329 2e72  se(batch_dims).r
+00005eb0: 6177 5f74 656e 736f 720a 2020 2020 2020  aw_tensor.      
+00005ec0: 2020 6c6f 6769 7473 5f72 6177 5f73 6861    logits_raw_sha
+00005ed0: 7065 203d 206c 6f67 6974 735f 7261 772e  pe = logits_raw.
+00005ee0: 7368 6170 6520 2023 205b 542c 2042 2e2e  shape  # [T, B..
+00005ef0: 2e2c 2043 5d0a 2020 2020 2020 2020 6966  ., C].        if
+00005f00: 206c 656e 2862 6174 6368 5f64 696d 7329   len(batch_dims)
+00005f10: 2021 3d20 313a 0a20 2020 2020 2020 2020   != 1:.         
+00005f20: 2020 206c 6f67 6974 735f 7261 7720 3d20     logits_raw = 
+00005f30: 746f 7263 682e 7265 7368 6170 6528 6c6f  torch.reshape(lo
+00005f40: 6769 7473 5f72 6177 2c20 6c6f 6769 7473  gits_raw, logits
+00005f50: 5f72 6177 2e73 6861 7065 5b3a 315d 202b  _raw.shape[:1] +
+00005f60: 2028 2d31 2c29 202b 206c 6f67 6974 735f   (-1,) + logits_
+00005f70: 7261 772e 7368 6170 655b 2d31 3a5d 2920  raw.shape[-1:]) 
+00005f80: 2023 205b 542c 2042 272c 2043 5d0a 2020   # [T, B', C].  
+00005f90: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00005fa0: 6c65 6e67 7468 7320 3d20 746f 7263 682e  lengths = torch.
+00005fb0: 7265 7368 6170 6528 696e 7075 745f 6c65  reshape(input_le
+00005fc0: 6e67 7468 732c 2028 2d31 2c29 2920 2023  ngths, (-1,))  #
+00005fd0: 205b 4227 5d0a 2020 2020 2020 2020 6c6f   [B'].        lo
+00005fe0: 675f 7072 6f62 7320 3d20 746f 7263 682e  g_probs = torch.
+00005ff0: 6e6e 2e66 756e 6374 696f 6e61 6c2e 6c6f  nn.functional.lo
+00006000: 675f 736f 6674 6d61 7828 6c6f 6769 7473  g_softmax(logits
+00006010: 5f72 6177 2c20 6469 6d3d 2d31 290a 2020  _raw, dim=-1).  
+00006020: 2020 2020 2020 2320 5079 546f 7263 6820        # PyTorch 
+00006030: 6578 7065 6374 7320 7468 6520 7461 7267  expects the targ
+00006040: 6574 7320 746f 2062 6520 6f66 2073 6861  ets to be of sha
+00006050: 7065 2028 422c 2053 2920 7768 6572 6520  pe (B, S) where 
+00006060: 5320 6973 2074 6865 2074 6172 6765 7473  S is the targets
+00006070: 2073 7061 7469 616c 2064 696d 2e0a 2020   spatial dim..  
+00006080: 2020 2020 2020 7461 7267 6574 7320 3d20        targets = 
+00006090: 7461 7267 6574 732e 636f 7079 5f74 7261  targets.copy_tra
+000060a0: 6e73 706f 7365 2862 6174 6368 5f64 696d  nspose(batch_dim
+000060b0: 7320 2b20 5b74 6172 6765 7473 5f73 7061  s + [targets_spa
+000060c0: 7469 616c 5f64 696d 5d29 0a20 2020 2020  tial_dim]).     
+000060d0: 2020 2074 6172 6765 7473 5f72 6177 203d     targets_raw =
+000060e0: 2074 6172 6765 7473 2e72 6177 5f74 656e   targets.raw_ten
+000060f0: 736f 7220 2023 205b 422e 2e2e 2c20 535d  sor  # [B..., S]
+00006100: 0a20 2020 2020 2020 2074 6172 6765 7473  .        targets
+00006110: 5f6c 656e 6774 6873 203d 2074 6172 6765  _lengths = targe
+00006120: 7473 5f73 7061 7469 616c 5f64 696d 2e64  ts_spatial_dim.d
+00006130: 796e 5f73 697a 655f 6578 742e 636f 7079  yn_size_ext.copy
+00006140: 5f74 7261 6e73 706f 7365 2862 6174 6368  _transpose(batch
+00006150: 5f64 696d 7329 2e72 6177 5f74 656e 736f  _dims).raw_tenso
+00006160: 720a 2020 2020 2020 2020 6966 206c 656e  r.        if len
+00006170: 2862 6174 6368 5f64 696d 7329 2021 3d20  (batch_dims) != 
+00006180: 313a 0a20 2020 2020 2020 2020 2020 2074  1:.            t
+00006190: 6172 6765 7473 5f72 6177 203d 2074 6f72  argets_raw = tor
+000061a0: 6368 2e72 6573 6861 7065 2874 6172 6765  ch.reshape(targe
+000061b0: 7473 5f72 6177 2c20 282d 312c 2074 6172  ts_raw, (-1, tar
+000061c0: 6765 7473 5f72 6177 2e73 6861 7065 5b2d  gets_raw.shape[-
+000061d0: 315d 2929 2020 2320 5b42 272c 2053 5d0a  1]))  # [B', S].
+000061e0: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+000061f0: 6574 735f 6c65 6e67 7468 7320 3d20 746f  ets_lengths = to
+00006200: 7263 682e 7265 7368 6170 6528 7461 7267  rch.reshape(targ
+00006210: 6574 735f 6c65 6e67 7468 732c 2028 2d31  ets_lengths, (-1
+00006220: 2c29 2920 2023 205b 4227 5d0a 2020 2020  ,))  # [B'].    
+00006230: 2020 2020 6c6f 7373 5f72 6177 203d 2074      loss_raw = t
+00006240: 6f72 6368 2e6e 6e2e 6675 6e63 7469 6f6e  orch.nn.function
+00006250: 616c 2e63 7463 5f6c 6f73 7328 0a20 2020  al.ctc_loss(.   
+00006260: 2020 2020 2020 2020 206c 6f67 5f70 726f           log_pro
+00006270: 6273 3d6c 6f67 5f70 726f 6273 2c0a 2020  bs=log_probs,.  
+00006280: 2020 2020 2020 2020 2020 7461 7267 6574            target
+00006290: 733d 7461 7267 6574 735f 7261 772c 0a20  s=targets_raw,. 
+000062a0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+000062b0: 5f6c 656e 6774 6873 3d69 6e70 7574 5f6c  _lengths=input_l
+000062c0: 656e 6774 6873 2c0a 2020 2020 2020 2020  engths,.        
+000062d0: 2020 2020 7461 7267 6574 5f6c 656e 6774      target_lengt
+000062e0: 6873 3d74 6172 6765 7473 5f6c 656e 6774  hs=targets_lengt
+000062f0: 6873 2c0a 2020 2020 2020 2020 2020 2020  hs,.            
+00006300: 626c 616e 6b3d 626c 616e 6b5f 696e 6465  blank=blank_inde
+00006310: 782c 0a20 2020 2020 2020 2020 2020 207a  x,.            z
+00006320: 6572 6f5f 696e 6669 6e69 7479 3d54 7275  ero_infinity=Tru
+00006330: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
+00006340: 6564 7563 7469 6f6e 3d22 6e6f 6e65 222c  eduction="none",
+00006350: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00006360: 2020 2069 6620 6c65 6e28 6261 7463 685f     if len(batch_
+00006370: 6469 6d73 2920 213d 2031 3a0a 2020 2020  dims) != 1:.    
+00006380: 2020 2020 2020 2020 6c6f 7373 5f72 6177          loss_raw
+00006390: 203d 2074 6f72 6368 2e72 6573 6861 7065   = torch.reshape
+000063a0: 286c 6f73 735f 7261 772c 206c 6f67 6974  (loss_raw, logit
+000063b0: 735f 7261 775f 7368 6170 655b 313a 2d31  s_raw_shape[1:-1
+000063c0: 5d29 0a20 2020 2020 2020 206c 6f73 7320  ]).        loss 
+000063d0: 3d20 5465 6e73 6f72 280a 2020 2020 2020  = Tensor(.      
+000063e0: 2020 2020 2020 6e61 6d65 3d22 6374 635f        name="ctc_
+000063f0: 6c6f 7373 222c 0a20 2020 2020 2020 2020  loss",.         
+00006400: 2020 2064 696d 733d 6261 7463 685f 6469     dims=batch_di
+00006410: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00006420: 7261 775f 7465 6e73 6f72 3d6c 6f73 735f  raw_tensor=loss_
+00006430: 7261 772c 0a20 2020 2020 2020 2020 2020  raw,.           
+00006440: 2064 7479 7065 3d6c 6f67 6974 732e 6474   dtype=logits.dt
+00006450: 7970 652c 0a20 2020 2020 2020 2029 0a20  ype,.        ). 
+00006460: 2020 2020 2020 2072 6574 7572 6e20 6c6f         return lo
+00006470: 7373 0a0a 2020 2020 4073 7461 7469 636d  ss..    @staticm
+00006480: 6574 686f 640a 2020 2020 6465 6620 6372  ethod.    def cr
+00006490: 6561 7465 5f70 6172 616d 6574 6572 5f72  eate_parameter_r
+000064a0: 6177 2874 656e 736f 723a 2072 662e 5061  aw(tensor: rf.Pa
+000064b0: 7261 6d65 7465 722c 202a 2c20 6465 7669  rameter, *, devi
+000064c0: 6365 3a20 4f70 7469 6f6e 616c 5b73 7472  ce: Optional[str
+000064d0: 5d20 3d20 4e6f 6e65 2920 2d3e 2074 6f72  ] = None) -> tor
+000064e0: 6368 2e6e 6e2e 5061 7261 6d65 7465 723a  ch.nn.Parameter:
+000064f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00006500: 2020 2020 203a 7265 7475 726e 3a20 7061       :return: pa
+00006510: 7261 6d65 7465 720a 2020 2020 2020 2020  rameter.        
+00006520: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
+00006530: 7274 2061 6c6c 2864 2e69 735f 7374 6174  rt all(d.is_stat
+00006540: 6963 2829 2066 6f72 2064 2069 6e20 7465  ic() for d in te
+00006550: 6e73 6f72 2e64 696d 7329 0a20 2020 2020  nsor.dims).     
+00006560: 2020 2064 6174 6120 3d20 746f 7263 682e     data = torch.
+00006570: 7a65 726f 7328 0a20 2020 2020 2020 2020  zeros(.         
+00006580: 2020 205b 642e 6469 6d65 6e73 696f 6e20     [d.dimension 
+00006590: 666f 7220 6420 696e 2074 656e 736f 722e  for d in tensor.
+000065a0: 6469 6d73 5d2c 0a20 2020 2020 2020 2020  dims],.         
+000065b0: 2020 2064 7479 7065 3d54 6f72 6368 4261     dtype=TorchBa
+000065c0: 636b 656e 642e 6173 5f64 7479 7065 5f72  ckend.as_dtype_r
+000065d0: 6177 2874 656e 736f 722e 6474 7970 6529  aw(tensor.dtype)
+000065e0: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+000065f0: 7669 6365 3d64 6576 6963 6520 6f72 2072  vice=device or r
+00006600: 662e 6765 745f 6465 6661 756c 745f 6465  f.get_default_de
+00006610: 7669 6365 2829 2c0a 2020 2020 2020 2020  vice(),.        
+00006620: 290a 2020 2020 2020 2020 6966 2074 656e  ).        if ten
+00006630: 736f 722e 6474 7970 652e 7374 6172 7473  sor.dtype.starts
+00006640: 7769 7468 2822 696e 7422 2920 6f72 2074  with("int") or t
+00006650: 656e 736f 722e 6474 7970 6520 3d3d 2022  ensor.dtype == "
+00006660: 626f 6f6c 223a 0a20 2020 2020 2020 2020  bool":.         
+00006670: 2020 2072 6571 7569 7265 735f 6772 6164     requires_grad
+00006680: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00006690: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000066a0: 2020 2072 6571 7569 7265 735f 6772 6164     requires_grad
+000066b0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+000066c0: 7265 7475 726e 2074 6f72 6368 2e6e 6e2e  return torch.nn.
+000066d0: 5061 7261 6d65 7465 7228 6461 7461 2c20  Parameter(data, 
+000066e0: 7265 7175 6972 6573 5f67 7261 643d 7265  requires_grad=re
+000066f0: 7175 6972 6573 5f67 7261 6429 0a0a 2020  quires_grad)..  
+00006700: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+00006710: 2020 2020 6465 6620 7365 745f 7061 7261      def set_para
+00006720: 6d65 7465 725f 696e 6974 6961 6c5f 7661  meter_initial_va
+00006730: 6c75 6528 7061 7261 6d3a 2072 662e 5061  lue(param: rf.Pa
+00006740: 7261 6d65 7465 722c 2076 616c 7565 3a20  rameter, value: 
+00006750: 556e 696f 6e5b 4e6f 6e65 2c20 5465 6e73  Union[None, Tens
+00006760: 6f72 2c20 7266 2e52 6177 5465 6e73 6f72  or, rf.RawTensor
+00006770: 5479 7065 735d 2920 2d3e 204e 6f6e 653a  Types]) -> None:
+00006780: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00006790: 2020 2020 203a 7061 7261 6d20 7061 7261       :param para
+000067a0: 6d3a 2070 6172 616d 6574 6572 0a20 2020  m: parameter.   
+000067b0: 2020 2020 203a 7061 7261 6d20 7661 6c75       :param valu
+000067c0: 653a 2069 6e69 7469 616c 2076 616c 7565  e: initial value
+000067d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000067e0: 2020 2020 2069 6620 7661 6c75 6520 6973       if value is
+000067f0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00006800: 2020 2076 616c 7565 203d 2030 0a20 2020     value = 0.   
+00006810: 2020 2020 2072 6177 5f70 6172 616d 203d       raw_param =
+00006820: 2070 6172 616d 2e72 6177 5f74 656e 736f   param.raw_tenso
+00006830: 720a 2020 2020 2020 2020 6173 7365 7274  r.        assert
+00006840: 2069 7369 6e73 7461 6e63 6528 7261 775f   isinstance(raw_
+00006850: 7061 7261 6d2c 2074 6f72 6368 2e6e 6e2e  param, torch.nn.
+00006860: 5061 7261 6d65 7465 7229 0a20 2020 2020  Parameter).     
+00006870: 2020 2077 6974 6820 746f 7263 682e 6e6f     with torch.no
+00006880: 5f67 7261 6428 293a 0a20 2020 2020 2020  _grad():.       
+00006890: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+000068a0: 6365 2876 616c 7565 2c20 5465 6e73 6f72  ce(value, Tensor
+000068b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000068c0: 2020 2076 616c 7565 5f72 6177 203d 2076     value_raw = v
+000068d0: 616c 7565 2e63 6f70 795f 636f 6d70 6174  alue.copy_compat
+000068e0: 6962 6c65 5f74 6f5f 6469 6d73 5f72 6177  ible_to_dims_raw
+000068f0: 2870 6172 616d 2e64 696d 7329 0a20 2020  (param.dims).   
+00006900: 2020 2020 2020 2020 2020 2020 2072 6177               raw
+00006910: 5f70 6172 616d 2e63 6f70 795f 2876 616c  _param.copy_(val
+00006920: 7565 5f72 6177 290a 2020 2020 2020 2020  ue_raw).        
+00006930: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00006940: 6e63 6528 7661 6c75 652c 206e 756d 7079  nce(value, numpy
+00006950: 2e6e 6461 7272 6179 293a 0a20 2020 2020  .ndarray):.     
+00006960: 2020 2020 2020 2020 2020 2072 6177 5f70             raw_p
+00006970: 6172 616d 2e63 6f70 795f 2874 6f72 6368  aram.copy_(torch
+00006980: 2e66 726f 6d5f 6e75 6d70 7928 7661 6c75  .from_numpy(valu
+00006990: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+000069a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000069b0: 2020 2020 2020 7261 775f 7061 7261 6d2e        raw_param.
+000069c0: 636f 7079 5f28 7661 6c75 6529 0a0a 2020  copy_(value)..  
+000069d0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+000069e0: 2020 2020 6465 6620 7365 745f 7061 7261      def set_para
+000069f0: 6d65 7465 725f 7472 6169 6e61 626c 6528  meter_trainable(
+00006a00: 7061 7261 6d3a 2072 662e 5061 7261 6d65  param: rf.Parame
+00006a10: 7465 722c 2074 7261 696e 6162 6c65 3a20  ter, trainable: 
+00006a20: 626f 6f6c 2920 2d3e 204e 6f6e 653a 0a20  bool) -> None:. 
+00006a30: 2020 2020 2020 2022 2222 7365 7420 7472         """set tr
+00006a40: 6169 6e61 626c 6522 2222 0a20 2020 2020  ainable""".     
+00006a50: 2020 2072 6177 5f70 6172 616d 203d 2070     raw_param = p
+00006a60: 6172 616d 2e72 6177 5f74 656e 736f 720a  aram.raw_tensor.
+00006a70: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+00006a80: 7369 6e73 7461 6e63 6528 7261 775f 7061  sinstance(raw_pa
+00006a90: 7261 6d2c 2074 6f72 6368 2e6e 6e2e 5061  ram, torch.nn.Pa
+00006aa0: 7261 6d65 7465 7229 0a20 2020 2020 2020  rameter).       
+00006ab0: 2072 6177 5f70 6172 616d 2e72 6571 7569   raw_param.requi
+00006ac0: 7265 735f 6772 6164 203d 2074 7261 696e  res_grad = train
+00006ad0: 6162 6c65 0a0a 2020 2020 4073 7461 7469  able..    @stati
+00006ae0: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+00006af0: 7061 7261 6d65 7465 725f 6173 7369 676e  parameter_assign
+00006b00: 2870 6172 616d 3a20 7266 2e50 6172 616d  (param: rf.Param
+00006b10: 6574 6572 2c20 7661 6c75 653a 2054 656e  eter, value: Ten
+00006b20: 736f 722c 202a 2c20 6f70 3a20 7374 7220  sor, *, op: str 
+00006b30: 3d20 2261 7373 6967 6e22 2920 2d3e 204e  = "assign") -> N
+00006b40: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00006b50: 7061 7261 6d20 6173 7369 676e 2222 220a  param assign""".
+00006b60: 2020 2020 2020 2020 7261 775f 7061 7261          raw_para
+00006b70: 6d20 3d20 7061 7261 6d2e 7261 775f 7465  m = param.raw_te
+00006b80: 6e73 6f72 0a20 2020 2020 2020 2061 7373  nsor.        ass
+00006b90: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
+00006ba0: 6177 5f70 6172 616d 2c20 746f 7263 682e  aw_param, torch.
+00006bb0: 6e6e 2e50 6172 616d 6574 6572 290a 2020  nn.Parameter).  
+00006bc0: 2020 2020 2020 7661 6c75 655f 7261 7720        value_raw 
+00006bd0: 3d20 7661 6c75 652e 636f 7079 5f63 6f6d  = value.copy_com
+00006be0: 7061 7469 626c 655f 746f 5f64 696d 735f  patible_to_dims_
+00006bf0: 7261 7728 7061 7261 6d2e 6469 6d73 290a  raw(param.dims).
+00006c00: 2020 2020 2020 2020 7769 7468 2074 6f72          with tor
+00006c10: 6368 2e6e 6f5f 6772 6164 2829 3a0a 2020  ch.no_grad():.  
+00006c20: 2020 2020 2020 2020 2020 6966 206f 7020            if op 
+00006c30: 3d3d 2022 6173 7369 676e 223a 0a20 2020  == "assign":.   
+00006c40: 2020 2020 2020 2020 2020 2020 2072 6177               raw
+00006c50: 5f70 6172 616d 2e63 6f70 795f 2876 616c  _param.copy_(val
+00006c60: 7565 5f72 6177 290a 2020 2020 2020 2020  ue_raw).        
+00006c70: 2020 2020 656c 6966 206f 7020 3d3d 2022      elif op == "
+00006c80: 6164 6422 3a0a 2020 2020 2020 2020 2020  add":.          
+00006c90: 2020 2020 2020 7261 775f 7061 7261 6d2e        raw_param.
+00006ca0: 6164 645f 2876 616c 7565 5f72 6177 290a  add_(value_raw).
+00006cb0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00006cc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006cd0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00006ce0: 6f72 2866 2250 6172 616d 6574 6572 207b  or(f"Parameter {
+00006cf0: 7061 7261 6d7d 2061 7373 6967 6e3a 2055  param} assign: U
+00006d00: 6e73 7570 706f 7274 6564 206f 703a 207b  nsupported op: {
+00006d10: 6f70 7d22 290a 0a20 2020 2040 7374 6174  op}")..    @stat
+00006d20: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00006d30: 2070 6172 616d 6574 6572 5f61 7373 6967   parameter_assig
+00006d40: 6e5f 6b65 7928 0a20 2020 2020 2020 2070  n_key(.        p
+00006d50: 6172 616d 3a20 7266 2e50 6172 616d 6574  aram: rf.Paramet
+00006d60: 6572 2c0a 2020 2020 2020 2020 6b65 793a  er,.        key:
+00006d70: 2072 662e 4974 656d 4b65 7954 7970 652c   rf.ItemKeyType,
+00006d80: 0a20 2020 2020 2020 2076 616c 7565 3a20  .        value: 
+00006d90: 5465 6e73 6f72 2c0a 2020 2020 2020 2020  Tensor,.        
+00006da0: 2a2c 0a20 2020 2020 2020 206f 703a 2073  *,.        op: s
+00006db0: 7472 203d 2022 6173 7369 676e 222c 0a20  tr = "assign",. 
+00006dc0: 2020 2020 2020 2061 7869 733a 204f 7074         axis: Opt
+00006dd0: 696f 6e61 6c5b 556e 696f 6e5b 4469 6d2c  ional[Union[Dim,
+00006de0: 2053 6571 7565 6e63 655b 4469 6d5d 5d5d   Sequence[Dim]]]
+00006df0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00006e00: 206b 6579 5f64 696d 3a20 4f70 7469 6f6e   key_dim: Option
+00006e10: 616c 5b55 6e69 6f6e 5b44 696d 2c20 5365  al[Union[Dim, Se
+00006e20: 7175 656e 6365 5b44 696d 5d5d 5d20 3d20  quence[Dim]]] = 
+00006e30: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 204e  None,.    ) -> N
+00006e40: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00006e50: 7061 7261 6d20 6173 7369 676e 2222 220a  param assign""".
+00006e60: 2020 2020 2020 2020 7261 775f 7061 7261          raw_para
+00006e70: 6d20 3d20 7061 7261 6d2e 7261 775f 7465  m = param.raw_te
+00006e80: 6e73 6f72 0a20 2020 2020 2020 2061 7373  nsor.        ass
+00006e90: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
+00006ea0: 6177 5f70 6172 616d 2c20 746f 7263 682e  aw_param, torch.
+00006eb0: 6e6e 2e50 6172 616d 6574 6572 290a 2020  nn.Parameter).  
+00006ec0: 2020 2020 2020 6b65 795f 7261 772c 2072        key_raw, r
+00006ed0: 6573 5f64 696d 7320 3d20 5f75 7469 6c73  es_dims = _utils
+00006ee0: 2e73 7472 6964 6564 5f73 6c69 6365 5f72  .strided_slice_r
+00006ef0: 6177 5f6b 6579 2870 6172 616d 2c20 6178  aw_key(param, ax
+00006f00: 6973 2c20 6b65 792c 206b 6579 5f64 696d  is, key, key_dim
+00006f10: 290a 2020 2020 2020 2020 7661 6c75 655f  ).        value_
+00006f20: 7261 7720 3d20 7661 6c75 652e 636f 7079  raw = value.copy
+00006f30: 5f63 6f6d 7061 7469 626c 655f 746f 5f64  _compatible_to_d
+00006f40: 696d 735f 7261 7728 7265 735f 6469 6d73  ims_raw(res_dims
+00006f50: 290a 2020 2020 2020 2020 7769 7468 2074  ).        with t
+00006f60: 6f72 6368 2e6e 6f5f 6772 6164 2829 3a0a  orch.no_grad():.
+00006f70: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+00006f80: 7020 3d3d 2022 6173 7369 676e 223a 0a20  p == "assign":. 
+00006f90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006fa0: 6177 5f70 6172 616d 5b6b 6579 5f72 6177  aw_param[key_raw
+00006fb0: 5d20 3d20 7661 6c75 655f 7261 770a 2020  ] = value_raw.  
+00006fc0: 2020 2020 2020 2020 2020 656c 6966 206f            elif o
+00006fd0: 7020 3d3d 2022 6164 6422 3a0a 2020 2020  p == "add":.    
+00006fe0: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
+00006ff0: 7061 7261 6d5b 6b65 795f 7261 775d 202b  param[key_raw] +
+00007000: 3d20 7661 6c75 655f 7261 770a 2020 2020  = value_raw.    
+00007010: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00007020: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00007030: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00007040: 2250 6172 616d 6574 6572 207b 7061 7261  "Parameter {para
+00007050: 6d7d 2061 7373 6967 6e3a 2055 6e73 7570  m} assign: Unsup
+00007060: 706f 7274 6564 206f 703a 207b 6f70 7d22  ported op: {op}"
+00007070: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
+00007080: 7468 6f64 0a20 2020 2064 6566 2070 6172  thod.    def par
+00007090: 616d 6574 6572 5f6d 6f76 655f 746f 2870  ameter_move_to(p
+000070a0: 6172 616d 3a20 7266 2e50 6172 616d 6574  aram: rf.Paramet
+000070b0: 6572 2c20 2a2c 2064 6576 6963 653a 204f  er, *, device: O
+000070c0: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+000070d0: 6f6e 652c 2064 7479 7065 3a20 4f70 7469  one, dtype: Opti
+000070e0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+000070f0: 293a 0a20 2020 2020 2020 2022 2222 746f  ):.        """to
+00007100: 2222 220a 2020 2020 2020 2020 7074 5f70  """.        pt_p
+00007110: 6172 616d 3a20 746f 7263 682e 6e6e 2e50  aram: torch.nn.P
+00007120: 6172 616d 6574 6572 203d 2070 6172 616d  arameter = param
+00007130: 2e72 6177 5f74 656e 736f 720a 2020 2020  .raw_tensor.    
+00007140: 2020 2020 6465 7669 6365 203d 2074 6f72      device = tor
+00007150: 6368 2e64 6576 6963 6528 6465 7669 6365  ch.device(device
+00007160: 2920 6966 2064 6576 6963 6520 656c 7365  ) if device else
+00007170: 204e 6f6e 650a 2020 2020 2020 2020 6474   None.        dt
+00007180: 7970 6520 3d20 546f 7263 6842 6163 6b65  ype = TorchBacke
+00007190: 6e64 2e61 735f 6474 7970 655f 7261 7728  nd.as_dtype_raw(
+000071a0: 6474 7970 6529 2069 6620 6474 7970 6520  dtype) if dtype 
+000071b0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+000071c0: 2020 7074 5f70 6172 616d 203d 2070 745f    pt_param = pt_
+000071d0: 7061 7261 6d2e 746f 2864 6576 6963 652c  param.to(device,
+000071e0: 2064 7479 7065 290a 2020 2020 2020 2020   dtype).        
+000071f0: 2320 5365 6520 7369 6d69 6c61 7220 6c6f  # See similar lo
+00007200: 6769 6320 696e 2074 6f72 6368 2e6e 6e2e  gic in torch.nn.
+00007210: 4d6f 6475 6c65 2e5f 6170 706c 792e 0a20  Module._apply.. 
+00007220: 2020 2020 2020 2070 745f 7061 7261 6d20         pt_param 
+00007230: 3d20 746f 7263 682e 6e6e 2e50 6172 616d  = torch.nn.Param
+00007240: 6574 6572 2870 745f 7061 7261 6d2c 2070  eter(pt_param, p
+00007250: 745f 7061 7261 6d2e 7265 7175 6972 6573  t_param.requires
+00007260: 5f67 7261 6429 0a20 2020 2020 2020 2070  _grad).        p
+00007270: 6172 616d 2e72 6177 5f74 656e 736f 7220  aram.raw_tensor 
+00007280: 3d20 7074 5f70 6172 616d 0a0a 2020 2020  = pt_param..    
+00007290: 2320 6b65 6570 2069 6e20 7379 6e63 2077  # keep in sync w
+000072a0: 6974 6820 6e61 7469 7665 2069 6d70 6c65  ith native imple
+000072b0: 6d65 6e74 6174 696f 6e0a 2020 2020 4073  mentation.    @s
+000072c0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+000072d0: 6465 6620 636f 6d70 6172 655f 7261 7728  def compare_raw(
+000072e0: 613a 2074 6f72 6368 2e54 656e 736f 722c  a: torch.Tensor,
+000072f0: 206b 696e 643a 2073 7472 2c20 623a 2074   kind: str, b: t
+00007300: 6f72 6368 2e54 656e 736f 7229 202d 3e20  orch.Tensor) -> 
+00007310: 746f 7263 682e 5465 6e73 6f72 3a0a 2020  torch.Tensor:.  
+00007320: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00007330: 2020 3a70 6172 616d 2061 3a0a 2020 2020    :param a:.    
+00007340: 2020 2020 3a70 6172 616d 206b 696e 643a      :param kind:
+00007350: 2022 6571 7561 6c22 2c20 226c 6573 7322   "equal", "less"
+00007360: 2c20 226c 6573 735f 6571 7561 6c22 2c20  , "less_equal", 
+00007370: 2267 7265 6174 6572 222c 2022 6772 6561  "greater", "grea
+00007380: 7465 725f 6571 7561 6c22 2c20 226e 6f74  ter_equal", "not
+00007390: 5f65 7175 616c 220a 2020 2020 2020 2020  _equal".        
+000073a0: 3a70 6172 616d 2062 3a0a 2020 2020 2020  :param b:.      
+000073b0: 2020 3a72 6574 7572 6e3a 2061 2060 6b69    :return: a `ki
+000073c0: 6e64 6020 620a 2020 2020 2020 2020 2222  nd` b.        ""
+000073d0: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
+000073e0: 2061 2e64 696d 2829 203d 3d20 622e 6469   a.dim() == b.di
+000073f0: 6d28 2920 6f72 2061 2e64 696d 2829 203d  m() or a.dim() =
+00007400: 3d20 3020 6f72 2062 2e64 696d 2829 203d  = 0 or b.dim() =
+00007410: 3d20 300a 2020 2020 2020 2020 6966 206b  = 0.        if k
+00007420: 696e 6420 3d3d 2022 6571 7561 6c22 3a0a  ind == "equal":.
+00007430: 2020 2020 2020 2020 2020 2020 6b69 6e64              kind
+00007440: 203d 2022 6571 2220 2023 2065 7120 6973   = "eq"  # eq is
+00007450: 2064 6966 6665 7265 6e74 2074 6f20 6571   different to eq
+00007460: 7561 6c3b 2065 7120 7265 7475 726e 7320  ual; eq returns 
+00007470: 6120 746f 7263 6820 5465 6e73 6f72 0a20  a torch Tensor. 
+00007480: 2020 2020 2020 206f 7020 3d20 6765 7461         op = geta
+00007490: 7474 7228 746f 7263 682c 206b 696e 6429  ttr(torch, kind)
+000074a0: 2020 2320 652e 672e 2074 6f72 6368 2e65    # e.g. torch.e
+000074b0: 7175 616c 0a20 2020 2020 2020 2072 6574  qual.        ret
+000074c0: 7572 6e20 6f70 2861 2c20 6229 0a0a 2020  urn op(a, b)..  
+000074d0: 2020 2320 6b65 6570 2069 6e20 7379 6e63    # keep in sync
+000074e0: 2077 6974 6820 6e61 7469 7665 2069 6d70   with native imp
+000074f0: 6c65 6d65 6e74 6174 696f 6e0a 2020 2020  lementation.    
+00007500: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00007510: 2020 6465 6620 636f 6d62 696e 655f 7261    def combine_ra
+00007520: 7728 613a 2074 6f72 6368 2e54 656e 736f  w(a: torch.Tenso
+00007530: 722c 206b 696e 643a 2073 7472 2c20 623a  r, kind: str, b:
+00007540: 2074 6f72 6368 2e54 656e 736f 7229 202d   torch.Tensor) -
+00007550: 3e20 746f 7263 682e 5465 6e73 6f72 3a0a  > torch.Tensor:.
+00007560: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00007570: 2020 2020 3a70 6172 616d 2061 3a0a 2020      :param a:.  
+00007580: 2020 2020 2020 3a70 6172 616d 206b 696e        :param kin
+00007590: 643a 2022 6164 6422 2c20 2273 7562 222c  d: "add", "sub",
+000075a0: 2022 6d75 6c22 2c20 2274 7275 6564 6976   "mul", "truediv
+000075b0: 222c 2022 666c 6f6f 7264 6976 222c 2022  ", "floordiv", "
+000075c0: 6d6f 6422 2c20 2270 6f77 222c 0a20 2020  mod", "pow",.   
+000075d0: 2020 2020 2020 2020 2022 6d61 7869 6d75           "maximu
+000075e0: 6d22 2c20 226d 696e 696d 756d 222c 2022  m", "minimum", "
+000075f0: 6c6f 6769 6361 6c5f 616e 6422 2c20 226c  logical_and", "l
+00007600: 6f67 6963 616c 5f6f 7222 2c20 2273 7175  ogical_or", "squ
+00007610: 6172 6564 5f64 6966 6665 7265 6e63 6522  ared_difference"
+00007620: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00007630: 623a 0a20 2020 2020 2020 203a 7265 7475  b:.        :retu
+00007640: 726e 3a20 6120 606b 696e 6460 2062 0a20  rn: a `kind` b. 
+00007650: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00007660: 2020 2061 7373 6572 7420 612e 6469 6d28     assert a.dim(
+00007670: 2920 3d3d 2062 2e64 696d 2829 206f 7220  ) == b.dim() or 
+00007680: 612e 6469 6d28 2920 3d3d 2030 206f 7220  a.dim() == 0 or 
+00007690: 622e 6469 6d28 2920 3d3d 2030 0a20 2020  b.dim() == 0.   
+000076a0: 2020 2020 2069 6620 6b69 6e64 203d 3d20       if kind == 
+000076b0: 2273 7175 6172 6564 5f64 6966 6665 7265  "squared_differe
+000076c0: 6e63 6522 3a0a 2020 2020 2020 2020 2020  nce":.          
+000076d0: 2020 7265 7475 726e 2072 6177 5f6f 7073    return raw_ops
+000076e0: 2e73 7175 6172 6564 5f64 6966 6665 7265  .squared_differe
+000076f0: 6e63 6528 612c 2062 290a 2020 2020 2020  nce(a, b).      
+00007700: 2020 6b69 6e64 203d 207b 0a20 2020 2020    kind = {.     
+00007710: 2020 2020 2020 2022 7472 7565 6469 7622         "truediv"
+00007720: 3a20 2274 7275 655f 6469 7669 6465 222c  : "true_divide",
+00007730: 0a20 2020 2020 2020 2020 2020 2022 666c  .            "fl
+00007740: 6f6f 7264 6976 223a 2022 666c 6f6f 725f  oordiv": "floor_
+00007750: 6469 7669 6465 222c 0a20 2020 2020 2020  divide",.       
+00007760: 2020 2020 2022 6d6f 6422 3a20 2272 656d       "mod": "rem
+00007770: 6169 6e64 6572 222c 0a20 2020 2020 2020  ainder",.       
+00007780: 207d 2e67 6574 286b 696e 642c 206b 696e   }.get(kind, kin
+00007790: 6429 0a20 2020 2020 2020 206f 7020 3d20  d).        op = 
+000077a0: 6765 7461 7474 7228 746f 7263 682c 206b  getattr(torch, k
+000077b0: 696e 6429 2020 2320 652e 672e 2074 6f72  ind)  # e.g. tor
+000077c0: 6368 2e61 6464 0a20 2020 2020 2020 2072  ch.add.        r
+000077d0: 6574 7572 6e20 6f70 2861 2c20 6229 0a0a  eturn op(a, b)..
+000077e0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+000077f0: 640a 2020 2020 6465 6620 7265 7368 6170  d.    def reshap
+00007800: 655f 7261 7728 0a20 2020 2020 2020 2072  e_raw(.        r
+00007810: 6177 5f74 656e 736f 723a 2074 6f72 6368  aw_tensor: torch
+00007820: 2e54 656e 736f 722c 2073 6861 7065 3a20  .Tensor, shape: 
+00007830: 556e 696f 6e5b 5365 7175 656e 6365 5b55  Union[Sequence[U
+00007840: 6e69 6f6e 5b69 6e74 2c20 746f 7263 682e  nion[int, torch.
+00007850: 5465 6e73 6f72 5d5d 2c20 746f 7263 682e  Tensor]], torch.
+00007860: 5465 6e73 6f72 5d0a 2020 2020 2920 2d3e  Tensor].    ) ->
+00007870: 2074 6f72 6368 2e54 656e 736f 723a 0a20   torch.Tensor:. 
+00007880: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00007890: 2020 203a 7061 7261 6d20 7261 775f 7465     :param raw_te
+000078a0: 6e73 6f72 3a0a 2020 2020 2020 2020 3a70  nsor:.        :p
+000078b0: 6172 616d 2073 6861 7065 3a0a 2020 2020  aram shape:.    
+000078c0: 2020 2020 3a72 6574 7572 6e3a 2072 6573      :return: res
+000078d0: 6861 7065 6420 7261 7720 7465 6e73 6f72  haped raw tensor
+000078e0: 3b20 7772 6170 7320 746f 7263 682e 7265  ; wraps torch.re
+000078f0: 7368 6170 650a 2020 2020 2020 2020 2222  shape.        ""
+00007900: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00007910: 2074 6f72 6368 2e72 6573 6861 7065 2872   torch.reshape(r
+00007920: 6177 5f74 656e 736f 722c 2073 6861 7065  aw_tensor, shape
+00007930: 290a 0a20 2020 2040 636c 6173 736d 6574  )..    @classmet
+00007940: 686f 640a 2020 2020 6465 6620 7371 7565  hod.    def sque
+00007950: 657a 655f 7261 7728 636c 732c 2072 6177  eze_raw(cls, raw
+00007960: 5f74 656e 736f 723a 2074 6f72 6368 2e54  _tensor: torch.T
+00007970: 656e 736f 722c 2061 7865 733a 2053 6571  ensor, axes: Seq
+00007980: 7565 6e63 655b 696e 745d 2920 2d3e 2074  uence[int]) -> t
+00007990: 6f72 6368 2e54 656e 736f 723a 0a20 2020  orch.Tensor:.   
+000079a0: 2020 2020 2022 2222 7371 7565 657a 6522       """squeeze"
+000079b0: 2222 0a20 2020 2020 2020 2069 6620 6c65  "".        if le
+000079c0: 6e28 6178 6573 2920 3d3d 2031 3a0a 2020  n(axes) == 1:.  
+000079d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000079e0: 2072 6177 5f74 656e 736f 722e 7371 7565   raw_tensor.sque
+000079f0: 657a 6528 6469 6d3d 6178 6573 5b30 5d29  eze(dim=axes[0])
+00007a00: 0a20 2020 2020 2020 2065 6c69 6620 6c65  .        elif le
+00007a10: 6e28 6178 6573 2920 3d3d 2030 3a0a 2020  n(axes) == 0:.  
+00007a20: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00007a30: 2072 6177 5f74 656e 736f 720a 2020 2020   raw_tensor.    
+00007a40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007a50: 2020 2020 2020 7265 7475 726e 2073 7570        return sup
+00007a60: 6572 2829 2e73 7175 6565 7a65 5f72 6177  er().squeeze_raw
+00007a70: 2872 6177 5f74 656e 736f 722c 2061 7865  (raw_tensor, axe
+00007a80: 733d 6178 6573 290a 0a20 2020 2040 7374  s=axes)..    @st
+00007a90: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00007aa0: 6566 2074 7261 6e73 706f 7365 5f72 6177  ef transpose_raw
+00007ab0: 2872 6177 5f74 656e 736f 723a 2074 6f72  (raw_tensor: tor
+00007ac0: 6368 2e54 656e 736f 722c 2070 6572 6d3a  ch.Tensor, perm:
+00007ad0: 2053 6571 7565 6e63 655b 696e 745d 2920   Sequence[int]) 
+00007ae0: 2d3e 2074 6f72 6368 2e54 656e 736f 723a  -> torch.Tensor:
+00007af0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00007b00: 2020 2020 203a 7061 7261 6d20 7261 775f       :param raw_
+00007b10: 7465 6e73 6f72 3a0a 2020 2020 2020 2020  tensor:.        
+00007b20: 3a70 6172 616d 2070 6572 6d3a 2065 2e67  :param perm: e.g
+00007b30: 2e20 5b30 2c20 322c 2031 5d0a 2020 2020  . [0, 2, 1].    
+00007b40: 2020 2020 3a72 6574 7572 6e3a 2070 6572      :return: per
+00007b50: 6d75 7465 6420 2874 7261 6e73 706f 7365  muted (transpose
+00007b60: 6429 2072 6177 2074 656e 736f 723b 2077  d) raw tensor; w
+00007b70: 7261 7073 2074 6f72 6368 2e70 6572 6d75  raps torch.permu
+00007b80: 7465 0a20 2020 2020 2020 2022 2222 0a20  te.        """. 
+00007b90: 2020 2020 2020 2069 6620 616c 6c28 7020         if all(p 
+00007ba0: 3d3d 2069 2066 6f72 2069 2c20 7020 696e  == i for i, p in
+00007bb0: 2065 6e75 6d65 7261 7465 2870 6572 6d29   enumerate(perm)
+00007bc0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00007bd0: 6574 7572 6e20 7261 775f 7465 6e73 6f72  eturn raw_tensor
+00007be0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007bf0: 746f 7263 682e 7065 726d 7574 6528 7261  torch.permute(ra
+00007c00: 775f 7465 6e73 6f72 2c20 7475 706c 6528  w_tensor, tuple(
+00007c10: 7065 726d 2929 0a0a 2020 2020 4073 7461  perm))..    @sta
+00007c20: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00007c30: 6620 636f 6e76 6572 745f 746f 5f74 656e  f convert_to_ten
+00007c40: 736f 7228 0a20 2020 2020 2020 2076 616c  sor(.        val
+00007c50: 7565 3a20 556e 696f 6e5b 5465 6e73 6f72  ue: Union[Tensor
+00007c60: 2c20 746f 7263 682e 5465 6e73 6f72 2c20  , torch.Tensor, 
+00007c70: 5261 7754 656e 736f 7254 7970 6573 5d2c  RawTensorTypes],
+00007c80: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00007c90: 2020 2020 6469 6d73 3a20 5365 7175 656e      dims: Sequen
+00007ca0: 6365 5b44 696d 5d2c 0a20 2020 2020 2020  ce[Dim],.       
+00007cb0: 2064 7479 7065 3a20 7374 722c 0a20 2020   dtype: str,.   
+00007cc0: 2020 2020 2073 7061 7273 655f 6469 6d3a       sparse_dim:
+00007cd0: 204f 7074 696f 6e61 6c5b 4469 6d5d 203d   Optional[Dim] =
+00007ce0: 204e 6f6e 652c 0a20 2020 2020 2020 2064   None,.        d
+00007cf0: 6576 6963 653a 204f 7074 696f 6e61 6c5b  evice: Optional[
+00007d00: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
+00007d10: 2020 2020 206e 616d 653a 204f 7074 696f       name: Optio
+00007d20: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00007d30: 0a20 2020 2029 202d 3e20 5465 6e73 6f72  .    ) -> Tensor
+00007d40: 5b74 6f72 6368 2e54 656e 736f 725d 3a0a  [torch.Tensor]:.
+00007d50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00007d60: 2020 2020 3a70 6172 616d 2076 616c 7565      :param value
+00007d70: 3a0a 2020 2020 2020 2020 3a70 6172 616d  :.        :param
+00007d80: 2064 696d 733a 0a20 2020 2020 2020 203a   dims:.        :
+00007d90: 7061 7261 6d20 6474 7970 653a 0a20 2020  param dtype:.   
+00007da0: 2020 2020 203a 7061 7261 6d20 7370 6172       :param spar
+00007db0: 7365 5f64 696d 3a0a 2020 2020 2020 2020  se_dim:.        
+00007dc0: 3a70 6172 616d 2064 6576 6963 653a 0a20  :param device:. 
+00007dd0: 2020 2020 2020 203a 7061 7261 6d20 6e61         :param na
+00007de0: 6d65 3a0a 2020 2020 2020 2020 3a72 6574  me:.        :ret
+00007df0: 7572 6e3a 2074 656e 736f 720a 2020 2020  urn: tensor.    
+00007e00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00007e10: 6966 2069 7369 6e73 7461 6e63 6528 7661  if isinstance(va
+00007e20: 6c75 652c 2054 656e 736f 7229 3a0a 2020  lue, Tensor):.  
+00007e30: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00007e40: 2076 616c 7565 0a20 2020 2020 2020 2069   value.        i
+00007e50: 6620 6973 696e 7374 616e 6365 2876 616c  f isinstance(val
+00007e60: 7565 2c20 746f 7263 682e 5465 6e73 6f72  ue, torch.Tensor
+00007e70: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
+00007e80: 616d 6520 3d20 6e61 6d65 206f 7220 2272  ame = name or "r
+00007e90: 6177 5f74 656e 736f 7222 0a20 2020 2020  aw_tensor".     
+00007ea0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00007eb0: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
+00007ec0: 206f 7220 2263 6f6e 7374 220a 2020 2020   or "const".    
+00007ed0: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
+00007ee0: 746f 7263 682e 7465 6e73 6f72 280a 2020  torch.tensor(.  
+00007ef0: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00007f00: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+00007f10: 2020 2020 2064 7479 7065 3d54 6f72 6368       dtype=Torch
+00007f20: 4261 636b 656e 642e 6173 5f64 7479 7065  Backend.as_dtype
+00007f30: 5f72 6177 2864 7479 7065 292c 0a20 2020  _raw(dtype),.   
+00007f40: 2020 2020 2020 2020 2020 2020 2064 6576               dev
+00007f50: 6963 653d 6465 7669 6365 206f 7220 7266  ice=device or rf
+00007f60: 2e67 6574 5f64 6566 6175 6c74 5f64 6576  .get_default_dev
+00007f70: 6963 6528 292c 0a20 2020 2020 2020 2020  ice(),.         
+00007f80: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+00007f90: 6572 7420 6973 696e 7374 616e 6365 2876  ert isinstance(v
+00007fa0: 616c 7565 2c20 746f 7263 682e 5465 6e73  alue, torch.Tens
+00007fb0: 6f72 290a 2020 2020 2020 2020 7265 7475  or).        retu
+00007fc0: 726e 2054 656e 736f 7228 6e61 6d65 2c20  rn Tensor(name, 
+00007fd0: 6469 6d73 3d64 696d 732c 2064 7479 7065  dims=dims, dtype
+00007fe0: 3d64 7479 7065 2c20 7370 6172 7365 5f64  =dtype, sparse_d
+00007ff0: 696d 3d73 7061 7273 655f 6469 6d2c 2072  im=sparse_dim, r
+00008000: 6177 5f74 656e 736f 723d 7661 6c75 6529  aw_tensor=value)
+00008010: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00008020: 686f 640a 2020 2020 6465 6620 6675 6c6c  hod.    def full
+00008030: 280a 2020 2020 2020 2020 6469 6d73 3a20  (.        dims: 
+00008040: 5365 7175 656e 6365 5b44 696d 5d2c 0a20  Sequence[Dim],. 
+00008050: 2020 2020 2020 2066 696c 6c5f 7661 6c75         fill_valu
+00008060: 653a 2055 6e69 6f6e 5b52 6177 5465 6e73  e: Union[RawTens
+00008070: 6f72 5479 7065 732c 2054 656e 736f 725d  orTypes, Tensor]
+00008080: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00008090: 2020 2020 2064 7479 7065 3a20 7374 722c       dtype: str,
+000080a0: 0a20 2020 2020 2020 2064 6576 6963 653a  .        device:
+000080b0: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+000080c0: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
+000080d0: 7061 7273 655f 6469 6d3a 204f 7074 696f  parse_dim: Optio
+000080e0: 6e61 6c5b 4469 6d5d 203d 204e 6f6e 652c  nal[Dim] = None,
+000080f0: 0a20 2020 2020 2020 2066 6561 7475 7265  .        feature
+00008100: 5f64 696d 3a20 4f70 7469 6f6e 616c 5b44  _dim: Optional[D
+00008110: 696d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  im] = None,.    
+00008120: 2920 2d3e 2054 656e 736f 723a 0a20 2020  ) -> Tensor:.   
+00008130: 2020 2020 2022 2222 6675 6c6c 2222 220a       """full""".
+00008140: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
+00008150: 5b64 696d 2e67 6574 5f64 696d 5f76 616c  [dim.get_dim_val
+00008160: 7565 2829 2066 6f72 2064 696d 2069 6e20  ue() for dim in 
+00008170: 6469 6d73 5d0a 2020 2020 2020 2020 6966  dims].        if
+00008180: 2069 7369 6e73 7461 6e63 6528 6669 6c6c   isinstance(fill
+00008190: 5f76 616c 7565 2c20 5465 6e73 6f72 293a  _value, Tensor):
+000081a0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+000081b0: 6c5f 7661 6c75 6520 3d20 6669 6c6c 5f76  l_value = fill_v
+000081c0: 616c 7565 2e72 6177 5f74 656e 736f 720a  alue.raw_tensor.
+000081d0: 2020 2020 2020 2020 6966 2074 6f72 6368          if torch
+000081e0: 2e6f 6e6e 782e 6973 5f69 6e5f 6f6e 6e78  .onnx.is_in_onnx
+000081f0: 5f65 7870 6f72 7428 293a 0a20 2020 2020  _export():.     
+00008200: 2020 2020 2020 2023 206f 6e6e 783a 3a43         # onnx::C
+00008210: 6f6e 7374 616e 744f 6653 6861 7065 2028  onstantOfShape (
+00008220: 7669 6120 746f 7263 682e 6675 6c6c 2920  via torch.full) 
+00008230: 6d75 7374 2067 6574 2073 6861 7065 2061  must get shape a
+00008240: 7320 696e 7436 342e 0a20 2020 2020 2020  s int64..       
+00008250: 2020 2020 2023 2068 7474 7073 3a2f 2f67       # https://g
+00008260: 6974 6875 622e 636f 6d2f 7277 7468 2d69  ithub.com/rwth-i
+00008270: 362f 7265 7475 726e 6e2f 6973 7375 6573  6/returnn/issues
+00008280: 2f31 3333 3323 6973 7375 6563 6f6d 6d65  /1333#issuecomme
+00008290: 6e74 2d31 3630 3732 3336 3738 330a 2020  nt-1607236783.  
+000082a0: 2020 2020 2020 2020 2020 7368 6170 6520            shape 
+000082b0: 3d20 5b64 696d 2e6c 6f6e 6728 2920 6966  = [dim.long() if
+000082c0: 2069 7369 6e73 7461 6e63 6528 6469 6d2c   isinstance(dim,
+000082d0: 2074 6f72 6368 2e54 656e 736f 7229 2065   torch.Tensor) e
+000082e0: 6c73 6520 6469 6d20 666f 7220 6469 6d20  lse dim for dim 
+000082f0: 696e 2073 6861 7065 5d0a 2020 2020 2020  in shape].      
+00008300: 2020 7261 775f 7465 6e73 6f72 203d 2074    raw_tensor = t
+00008310: 6f72 6368 2e66 756c 6c28 0a20 2020 2020  orch.full(.     
+00008320: 2020 2020 2020 2073 6861 7065 2c20 6669         shape, fi
+00008330: 6c6c 5f76 616c 7565 2c20 6474 7970 653d  ll_value, dtype=
+00008340: 546f 7263 6842 6163 6b65 6e64 2e61 735f  TorchBackend.as_
+00008350: 6474 7970 655f 7261 7728 6474 7970 6529  dtype_raw(dtype)
+00008360: 2c20 6465 7669 6365 3d64 6576 6963 6520  , device=device 
+00008370: 6f72 2072 662e 6765 745f 6465 6661 756c  or rf.get_defaul
+00008380: 745f 6465 7669 6365 2829 0a20 2020 2020  t_device().     
+00008390: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+000083a0: 7572 6e20 5465 6e73 6f72 280a 2020 2020  urn Tensor(.    
+000083b0: 2020 2020 2020 2020 2266 756c 6c22 2c20          "full", 
+000083c0: 6469 6d73 3d64 696d 732c 2073 7061 7273  dims=dims, spars
+000083d0: 655f 6469 6d3d 7370 6172 7365 5f64 696d  e_dim=sparse_dim
+000083e0: 2c20 6665 6174 7572 655f 6469 6d3d 6665  , feature_dim=fe
+000083f0: 6174 7572 655f 6469 6d2c 2064 7479 7065  ature_dim, dtype
+00008400: 3d64 7479 7065 2c20 7261 775f 7465 6e73  =dtype, raw_tens
+00008410: 6f72 3d72 6177 5f74 656e 736f 720a 2020  or=raw_tensor.  
+00008420: 2020 2020 2020 290a 0a20 2020 2040 7374        )..    @st
+00008430: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00008440: 6566 2067 6174 6865 7228 0a20 2020 2020  ef gather(.     
+00008450: 2020 2073 6f75 7263 653a 2054 656e 736f     source: Tenso
+00008460: 722c 0a20 2020 2020 2020 202a 2c0a 2020  r,.        *,.  
+00008470: 2020 2020 2020 696e 6469 6365 733a 2055        indices: U
+00008480: 6e69 6f6e 5b54 656e 736f 722c 2069 6e74  nion[Tensor, int
+00008490: 5d2c 0a20 2020 2020 2020 2061 7869 733a  ],.        axis:
+000084a0: 2044 696d 2c0a 2020 2020 2020 2020 636c   Dim,.        cl
+000084b0: 6970 5f74 6f5f 7661 6c69 643a 2062 6f6f  ip_to_valid: boo
+000084c0: 6c20 3d20 4661 6c73 652c 0a20 2020 2029  l = False,.    )
+000084d0: 202d 3e20 5465 6e73 6f72 3a0a 2020 2020   -> Tensor:.    
+000084e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000084f0: 4761 7468 6572 2e0a 0a20 2020 2020 2020  Gather...       
+00008500: 2054 6865 7265 2061 7265 2061 2066 6577   There are a few
+00008510: 206f 7074 696f 6e73 2069 6e20 5079 546f   options in PyTo
+00008520: 7263 682c 2061 6c6c 2068 6176 696e 6720  rch, all having 
+00008530: 736f 6d65 7768 6174 2064 6966 6665 7265  somewhat differe
+00008540: 6e74 2073 656d 616e 7469 6373 0a20 2020  nt semantics.   
+00008550: 2020 2020 2061 6e64 2064 6966 6665 7265       and differe
+00008560: 6e74 2061 6476 616e 7461 6765 7320 6f72  nt advantages or
+00008570: 2064 6973 6164 7661 6e74 6167 6573 2061   disadvantages a
+00008580: 6e64 2064 6966 6665 7265 6e74 206c 696d  nd different lim
+00008590: 6974 6174 696f 6e73 2e0a 0a20 2020 2020  itations...     
+000085a0: 2020 202d 2074 6f72 6368 2e67 6174 6865     - torch.gathe
+000085b0: 722c 206d 6f73 7420 6765 6e65 7269 630a  r, most generic.
+000085c0: 2020 2020 2020 2020 2d20 746f 7263 682e          - torch.
+000085d0: 696e 6465 785f 7365 6c65 6374 2c20 7369  index_select, si
+000085e0: 6d69 6c61 7220 6173 2074 662e 6761 7468  milar as tf.gath
+000085f0: 6572 2c20 6275 7420 646f 6573 206e 6f74  er, but does not
+00008600: 2073 7570 706f 7274 2062 6174 6368 2061   support batch a
+00008610: 7865 730a 2020 2020 2020 2020 2d20 5465  xes.        - Te
+00008620: 6e73 6f72 2e5f 5f67 6574 6974 656d 5f5f  nsor.__getitem__
+00008630: 0a20 2020 2020 2020 202d 2074 6f72 6368  .        - torch
+00008640: 2e65 6d62 6564 6469 6e67 0a20 2020 2020  .embedding.     
+00008650: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+00008660: 6620 6973 696e 7374 616e 6365 2869 6e64  f isinstance(ind
+00008670: 6963 6573 2c20 5465 6e73 6f72 293a 0a20  ices, Tensor):. 
+00008680: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
+00008690: 6573 3a20 5465 6e73 6f72 5b74 6f72 6368  es: Tensor[torch
+000086a0: 2e54 656e 736f 725d 0a20 2020 2020 2020  .Tensor].       
+000086b0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+000086c0: 2869 6e64 6963 6573 2c20 696e 7429 3a0a  (indices, int):.
+000086d0: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+000086e0: 6365 7320 3d20 5465 6e73 6f72 280a 2020  ces = Tensor(.  
+000086f0: 2020 2020 2020 2020 2020 2020 2020 2269                "i
+00008700: 6e64 6963 6573 5f69 6e74 222c 0a20 2020  ndices_int",.   
+00008710: 2020 2020 2020 2020 2020 2020 2064 696d               dim
+00008720: 733d 2829 2c0a 2020 2020 2020 2020 2020  s=(),.          
+00008730: 2020 2020 2020 6474 7970 653d 7266 2e67        dtype=rf.g
+00008740: 6574 5f64 6566 6175 6c74 5f61 7272 6179  et_default_array
+00008750: 5f69 6e64 6578 5f64 7479 7065 2829 2c0a  _index_dtype(),.
+00008760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008770: 7261 775f 7465 6e73 6f72 3d74 6f72 6368  raw_tensor=torch
+00008780: 2e74 656e 736f 7228 696e 6469 6365 732c  .tensor(indices,
+00008790: 2064 7479 7065 3d54 6f72 6368 4261 636b   dtype=TorchBack
+000087a0: 656e 642e 6173 5f64 7479 7065 5f72 6177  end.as_dtype_raw
+000087b0: 2872 662e 6765 745f 6465 6661 756c 745f  (rf.get_default_
+000087c0: 6172 7261 795f 696e 6465 785f 6474 7970  array_index_dtyp
+000087d0: 6528 2929 292c 0a20 2020 2020 2020 2020  e())),.         
+000087e0: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+000087f0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00008800: 6169 7365 2054 7970 6545 7272 6f72 2866  aise TypeError(f
+00008810: 2255 6e73 7570 706f 7274 6564 2074 7970  "Unsupported typ
+00008820: 6520 666f 7220 696e 6469 6365 733a 207b  e for indices: {
+00008830: 7479 7065 2869 6e64 6963 6573 297d 2229  type(indices)}")
+00008840: 0a20 2020 2020 2020 2061 7869 735f 696e  .        axis_in
+00008850: 7420 3d20 736f 7572 6365 2e67 6574 5f61  t = source.get_a
+00008860: 7869 735f 6672 6f6d 5f64 6573 6372 6970  xis_from_descrip
+00008870: 7469 6f6e 2861 7869 732c 2061 6c6c 6f77  tion(axis, allow
+00008880: 5f69 6e74 3d46 616c 7365 290a 2020 2020  _int=False).    
+00008890: 2020 2020 6966 2063 6c69 705f 746f 5f76      if clip_to_v
+000088a0: 616c 6964 3a0a 2020 2020 2020 2020 2020  alid:.          
+000088b0: 2020 696e 6469 6365 7320 3d20 696e 6469    indices = indi
+000088c0: 6365 732e 636f 7079 2829 0a20 2020 2020  ces.copy().     
+000088d0: 2020 2020 2020 2064 696d 3a20 4469 6d20         dim: Dim 
+000088e0: 3d20 736f 7572 6365 2e64 696d 735b 6178  = source.dims[ax
+000088f0: 6973 5f69 6e74 5d0a 2020 2020 2020 2020  is_int].        
+00008900: 2020 2020 6966 2064 696d 2e64 796e 5f73      if dim.dyn_s
+00008910: 697a 655f 6578 743a 0a20 2020 2020 2020  ize_ext:.       
+00008920: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00008930: 6469 6d2e 6479 6e5f 7369 7a65 5f65 7874  dim.dyn_size_ext
+00008940: 2e64 696d 735f 7365 742e 6973 7375 6273  .dims_set.issubs
+00008950: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+00008960: 2020 2020 2020 2020 696e 6469 6365 732e          indices.
+00008970: 6469 6d73 5f73 6574 0a20 2020 2020 2020  dims_set.       
+00008980: 2020 2020 2020 2020 2029 2c20 6622 6761           ), f"ga
+00008990: 7468 6572 2077 6974 6820 636c 6970 5f74  ther with clip_t
+000089a0: 6f5f 7661 6c69 643a 2069 6e64 6963 6573  o_valid: indices
+000089b0: 2028 7b69 6e64 6963 6573 7d29 2064 696d   ({indices}) dim
+000089c0: 7320 6d75 7374 2062 6520 6120 7375 7065  s must be a supe
+000089d0: 7273 6574 206f 6620 7b64 696d 7d20 6479  rset of {dim} dy
+000089e0: 6e2d 7369 7a65 220a 2020 2020 2020 2020  n-size".        
+000089f0: 2020 2020 2020 2020 7369 7a65 203d 2064          size = d
+00008a00: 696d 2e64 796e 5f73 697a 655f 6578 742e  im.dyn_size_ext.
+00008a10: 636f 7079 5f63 6f6d 7061 7469 626c 655f  copy_compatible_
+00008a20: 746f 2869 6e64 6963 6573 2c20 6368 6563  to(indices, chec
+00008a30: 6b5f 7370 6172 7365 3d46 616c 7365 290a  k_sparse=False).
+00008a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a50: 696e 6469 6365 732e 7261 775f 7465 6e73  indices.raw_tens
+00008a60: 6f72 203d 2074 6f72 6368 2e63 6c61 6d70  or = torch.clamp
+00008a70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00008a80: 2020 2020 2020 696e 6469 6365 732e 7261        indices.ra
+00008a90: 775f 7465 6e73 6f72 2c0a 2020 2020 2020  w_tensor,.      
+00008aa0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00008ab0: 7263 682e 7465 6e73 6f72 2830 2c20 6465  rch.tensor(0, de
+00008ac0: 7669 6365 3d69 6e64 6963 6573 2e72 6177  vice=indices.raw
+00008ad0: 5f74 656e 736f 722e 6465 7669 6365 292c  _tensor.device),
+00008ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008af0: 2020 2020 2028 7369 7a65 2e72 6177 5f74       (size.raw_t
+00008b00: 656e 736f 7220 2d20 3129 2e74 6f28 696e  ensor - 1).to(in
+00008b10: 6469 6365 732e 7261 775f 7465 6e73 6f72  dices.raw_tensor
+00008b20: 2e64 6576 6963 6529 2c0a 2020 2020 2020  .device),.      
+00008b30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00008b40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00008b50: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00008b60: 6469 6365 732e 7261 775f 7465 6e73 6f72  dices.raw_tensor
+00008b70: 203d 2074 6f72 6368 2e63 6c61 6d70 2869   = torch.clamp(i
+00008b80: 6e64 6963 6573 2e72 6177 5f74 656e 736f  ndices.raw_tenso
+00008b90: 722c 2030 2c20 736f 7572 6365 2e72 6177  r, 0, source.raw
+00008ba0: 5f74 656e 736f 722e 7368 6170 655b 6178  _tensor.shape[ax
+00008bb0: 6973 5f69 6e74 5d20 2d20 3129 0a20 2020  is_int] - 1).   
+00008bc0: 2020 2020 2069 6e64 6578 5f6f 776e 5f64       index_own_d
+00008bd0: 696d 7320 3d20 5b64 696d 2066 6f72 2064  ims = [dim for d
+00008be0: 696d 2069 6e20 696e 6469 6365 732e 6469  im in indices.di
+00008bf0: 6d73 2069 6620 6469 6d20 6e6f 7420 696e  ms if dim not in
+00008c00: 2073 6f75 7263 652e 6469 6d73 206f 7220   source.dims or 
+00008c10: 6469 6d20 3d3d 2061 7869 735d 0a20 2020  dim == axis].   
+00008c20: 2020 2020 206f 7574 203d 2054 656e 736f       out = Tenso
+00008c30: 7228 0a20 2020 2020 2020 2020 2020 2022  r(.            "
+00008c40: 6761 7468 6572 222c 0a20 2020 2020 2020  gather",.       
+00008c50: 2020 2020 2064 696d 733d 6c69 7374 2873       dims=list(s
+00008c60: 6f75 7263 652e 6469 6d73 5b3a 6178 6973  ource.dims[:axis
+00008c70: 5f69 6e74 5d29 202b 2069 6e64 6578 5f6f  _int]) + index_o
+00008c80: 776e 5f64 696d 7320 2b20 6c69 7374 2873  wn_dims + list(s
+00008c90: 6f75 7263 652e 6469 6d73 5b61 7869 735f  ource.dims[axis_
+00008ca0: 696e 7420 2b20 3120 3a5d 292c 0a20 2020  int + 1 :]),.   
+00008cb0: 2020 2020 2020 2020 2064 7479 7065 3d73           dtype=s
+00008cc0: 6f75 7263 652e 6474 7970 652c 0a20 2020  ource.dtype,.   
+00008cd0: 2020 2020 2020 2020 2073 7061 7273 655f           sparse_
+00008ce0: 6469 6d3d 736f 7572 6365 2e73 7061 7273  dim=source.spars
+00008cf0: 655f 6469 6d2c 0a20 2020 2020 2020 2029  e_dim,.        )
+00008d00: 0a20 2020 2020 2020 2069 6620 736f 7572  .        if sour
+00008d10: 6365 2e66 6561 7475 7265 5f64 696d 2061  ce.feature_dim a
+00008d20: 6e64 2073 6f75 7263 652e 6665 6174 7572  nd source.featur
+00008d30: 655f 6469 6d20 696e 206f 7574 2e64 696d  e_dim in out.dim
+00008d40: 733a 0a20 2020 2020 2020 2020 2020 206f  s:.            o
+00008d50: 7574 2e66 6561 7475 7265 5f64 696d 203d  ut.feature_dim =
+00008d60: 2073 6f75 7263 652e 6665 6174 7572 655f   source.feature_
+00008d70: 6469 6d0a 2020 2020 2020 2020 6966 2069  dim.        if i
+00008d80: 6e64 6963 6573 2e64 696d 735f 7365 742e  ndices.dims_set.
+00008d90: 696e 7465 7273 6563 7469 6f6e 2873 6f75  intersection(sou
+00008da0: 7263 652e 6469 6d73 5f73 6574 202d 207b  rce.dims_set - {
+00008db0: 6178 6973 7d29 3a0a 2020 2020 2020 2020  axis}):.        
+00008dc0: 2020 2020 2320 5765 2063 616e 6e6f 7420      # We cannot 
+00008dd0: 7573 6520 696e 6465 785f 7365 6c65 6374  use index_select
+00008de0: 2069 6e20 7468 6973 2063 6173 652e 204e   in this case. N
+00008df0: 6565 6420 746f 2066 616c 6c62 6163 6b20  eed to fallback 
+00008e00: 746f 2067 6174 6865 722e 0a20 2020 2020  to gather..     
+00008e10: 2020 2020 2020 2069 6e64 6963 6573 203d         indices =
+00008e20: 2069 6e64 6963 6573 2e63 6f70 795f 636f   indices.copy_co
+00008e30: 6d70 6174 6962 6c65 5f74 6f28 6f75 742c  mpatible_to(out,
+00008e40: 2063 6865 636b 5f64 7479 7065 3d46 616c   check_dtype=Fal
+00008e50: 7365 2c20 6368 6563 6b5f 7370 6172 7365  se, check_sparse
+00008e60: 3d46 616c 7365 2c20 756e 6272 6f61 6463  =False, unbroadc
+00008e70: 6173 743d 5472 7565 290a 2020 2020 2020  ast=True).      
+00008e80: 2020 2020 2020 6966 206c 656e 2869 6e64        if len(ind
+00008e90: 6578 5f6f 776e 5f64 696d 7329 203d 3d20  ex_own_dims) == 
+00008ea0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00008eb0: 2020 2069 6e64 6578 5f6f 776e 5f64 696d     index_own_dim
+00008ec0: 735f 666c 6174 203d 2069 6e64 6578 5f6f  s_flat = index_o
+00008ed0: 776e 5f64 696d 735b 305d 2020 2320 676f  wn_dims[0]  # go
+00008ee0: 6f64 0a20 2020 2020 2020 2020 2020 2065  od.            e
+00008ef0: 6c69 6620 6c65 6e28 696e 6465 785f 6f77  lif len(index_ow
+00008f00: 6e5f 6469 6d73 2920 3d3d 2030 3a0a 2020  n_dims) == 0:.  
+00008f10: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00008f20: 6465 785f 6f77 6e5f 6469 6d73 5f66 6c61  dex_own_dims_fla
+00008f30: 7420 3d20 4469 6d28 312c 206e 616d 653d  t = Dim(1, name=
+00008f40: 2264 756d 6d79 2229 0a20 2020 2020 2020  "dummy").       
+00008f50: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
+00008f60: 203d 2069 6e64 6963 6573 2e63 6f70 795f   = indices.copy_
+00008f70: 6164 645f 6469 6d5f 6279 5f74 6167 2869  add_dim_by_tag(i
+00008f80: 6e64 6578 5f6f 776e 5f64 696d 735f 666c  ndex_own_dims_fl
+00008f90: 6174 2c20 756e 6272 6f61 6463 6173 743d  at, unbroadcast=
+00008fa0: 5472 7565 2c20 6178 6973 3d61 7869 735f  True, axis=axis_
+00008fb0: 696e 7429 0a20 2020 2020 2020 2020 2020  int).           
+00008fc0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00008fd0: 2020 2020 2020 2069 6e64 6963 6573 2c20         indices, 
+00008fe0: 696e 6465 785f 6f77 6e5f 6469 6d73 5f66  index_own_dims_f
+00008ff0: 6c61 7420 3d20 7266 2e6d 6572 6765 5f64  lat = rf.merge_d
+00009000: 696d 7328 696e 6469 6365 732c 2064 696d  ims(indices, dim
+00009010: 733d 696e 6465 785f 6f77 6e5f 6469 6d73  s=index_own_dims
+00009020: 290a 2020 2020 2020 2020 2020 2020 696e  ).            in
+00009030: 6465 785f 6578 745f 6469 6d73 203d 206c  dex_ext_dims = l
+00009040: 6973 7428 736f 7572 6365 2e64 696d 7329  ist(source.dims)
+00009050: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+00009060: 6578 5f65 7874 5f64 696d 735b 6178 6973  ex_ext_dims[axis
+00009070: 5f69 6e74 5d20 3d20 696e 6465 785f 6f77  _int] = index_ow
+00009080: 6e5f 6469 6d73 5f66 6c61 740a 2020 2020  n_dims_flat.    
+00009090: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+000090a0: 6e64 6963 6573 2e64 696d 7320 3d3d 2074  ndices.dims == t
+000090b0: 7570 6c65 2869 6e64 6578 5f65 7874 5f64  uple(index_ext_d
+000090c0: 696d 7329 0a20 2020 2020 2020 2020 2020  ims).           
+000090d0: 206f 7574 5f72 6177 203d 2074 6f72 6368   out_raw = torch
+000090e0: 2e67 6174 6865 7228 736f 7572 6365 2e72  .gather(source.r
+000090f0: 6177 5f74 656e 736f 722c 2064 696d 3d61  aw_tensor, dim=a
+00009100: 7869 735f 696e 742c 2069 6e64 6578 3d69  xis_int, index=i
+00009110: 6e64 6963 6573 2e72 6177 5f74 656e 736f  ndices.raw_tenso
+00009120: 722e 7479 7065 2874 6f72 6368 2e69 6e74  r.type(torch.int
+00009130: 3634 2929 0a20 2020 2020 2020 2020 2020  64)).           
+00009140: 2069 6620 6c65 6e28 696e 6465 785f 6f77   if len(index_ow
+00009150: 6e5f 6469 6d73 2920 3d3d 2031 3a0a 2020  n_dims) == 1:.  
+00009160: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00009170: 7373 2020 2320 6e6f 7468 696e 6720 746f  ss  # nothing to
+00009180: 2064 6f0a 2020 2020 2020 2020 2020 2020   do.            
+00009190: 656c 6966 206c 656e 2869 6e64 6578 5f6f  elif len(index_o
+000091a0: 776e 5f64 696d 7329 203d 3d20 303a 0a20  wn_dims) == 0:. 
+000091b0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000091c0: 7574 5f72 6177 203d 206f 7574 5f72 6177  ut_raw = out_raw
+000091d0: 2e73 7175 6565 7a65 2861 7869 735f 696e  .squeeze(axis_in
+000091e0: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
+000091f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00009200: 2020 2020 206f 7574 5f72 6177 203d 206f       out_raw = o
+00009210: 7574 5f72 6177 2e72 6573 6861 7065 285b  ut_raw.reshape([
+00009220: 642e 6765 745f 6469 6d5f 7661 6c75 6528  d.get_dim_value(
+00009230: 2920 666f 7220 6420 696e 206f 7574 2e64  ) for d in out.d
+00009240: 696d 735d 290a 2020 2020 2020 2020 2020  ims]).          
+00009250: 2020 6f75 742e 7261 775f 7465 6e73 6f72    out.raw_tensor
+00009260: 203d 206f 7574 5f72 6177 0a20 2020 2020   = out_raw.     
+00009270: 2020 2065 6c69 6620 6178 6973 5f69 6e74     elif axis_int
+00009280: 203d 3d20 3020 616e 6420 696e 6469 6365   == 0 and indice
+00009290: 732e 6261 7463 685f 6e64 696d 203d 3d20  s.batch_ndim == 
+000092a0: 303a 0a20 2020 2020 2020 2020 2020 206f  0:.            o
+000092b0: 7574 2e72 6177 5f74 656e 736f 7220 3d20  ut.raw_tensor = 
+000092c0: 736f 7572 6365 2e72 6177 5f74 656e 736f  source.raw_tenso
+000092d0: 725b 696e 6469 6365 732e 7261 775f 7465  r[indices.raw_te
+000092e0: 6e73 6f72 5d0a 2020 2020 2020 2020 656c  nsor].        el
+000092f0: 6966 2061 7869 735f 696e 7420 3d3d 2030  if axis_int == 0
+00009300: 2061 6e64 2073 6f75 7263 652e 6261 7463   and source.batc
+00009310: 685f 6e64 696d 203d 3d20 323a 0a20 2020  h_ndim == 2:.   
+00009320: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+00009330: 6973 2065 7861 6374 6c79 2077 6861 7420  is exactly what 
+00009340: 746f 7263 682e 656d 6265 6464 696e 6720  torch.embedding 
+00009350: 6973 2069 6e74 656e 6465 6420 666f 722e  is intended for.
+00009360: 204c 6574 2773 2075 7365 2074 6861 742e   Let's use that.
+00009370: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00009380: 2e72 6177 5f74 656e 736f 7220 3d20 746f  .raw_tensor = to
+00009390: 7263 682e 656d 6265 6464 696e 6728 736f  rch.embedding(so
+000093a0: 7572 6365 2e72 6177 5f74 656e 736f 722c  urce.raw_tensor,
+000093b0: 2069 6e64 6963 6573 2e72 6177 5f74 656e   indices.raw_ten
+000093c0: 736f 7229 0a20 2020 2020 2020 2065 6c73  sor).        els
+000093d0: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
+000093e0: 7574 5f72 6177 203d 2074 6f72 6368 2e69  ut_raw = torch.i
+000093f0: 6e64 6578 5f73 656c 6563 7428 736f 7572  ndex_select(sour
+00009400: 6365 2e72 6177 5f74 656e 736f 722c 2064  ce.raw_tensor, d
+00009410: 696d 3d61 7869 735f 696e 742c 2069 6e64  im=axis_int, ind
+00009420: 6578 3d69 6e64 6963 6573 2e72 6177 5f74  ex=indices.raw_t
+00009430: 656e 736f 722e 666c 6174 7465 6e28 2929  ensor.flatten())
+00009440: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00009450: 5f73 6861 7065 203d 2028 0a20 2020 2020  _shape = (.     
+00009460: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+00009470: 652e 7261 775f 7465 6e73 6f72 2e73 6861  e.raw_tensor.sha
+00009480: 7065 5b3a 6178 6973 5f69 6e74 5d20 2b20  pe[:axis_int] + 
+00009490: 696e 6469 6365 732e 7261 775f 7465 6e73  indices.raw_tens
+000094a0: 6f72 2e73 6861 7065 202b 2073 6f75 7263  or.shape + sourc
+000094b0: 652e 7261 775f 7465 6e73 6f72 2e73 6861  e.raw_tensor.sha
+000094c0: 7065 5b61 7869 735f 696e 7420 2b20 3120  pe[axis_int + 1 
+000094d0: 3a5d 0a20 2020 2020 2020 2020 2020 2029  :].            )
+000094e0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+000094f0: 2e72 6177 5f74 656e 736f 7220 3d20 6f75  .raw_tensor = ou
+00009500: 745f 7261 772e 7265 7368 6170 6528 6f75  t_raw.reshape(ou
+00009510: 745f 7368 6170 6529 0a20 2020 2020 2020  t_shape).       
+00009520: 2072 6574 7572 6e20 6f75 740a 0a20 2020   return out..   
+00009530: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00009540: 2020 2064 6566 2073 6361 7474 6572 280a     def scatter(.
+00009550: 2020 2020 2020 2020 736f 7572 6365 3a20          source: 
+00009560: 5465 6e73 6f72 2c0a 2020 2020 2020 2020  Tensor,.        
+00009570: 2a2c 0a20 2020 2020 2020 2069 6e64 6963  *,.        indic
+00009580: 6573 3a20 5465 6e73 6f72 2c0a 2020 2020  es: Tensor,.    
+00009590: 2020 2020 696e 6469 6365 735f 6469 6d3a      indices_dim:
+000095a0: 2055 6e69 6f6e 5b44 696d 2c20 5365 7175   Union[Dim, Sequ
+000095b0: 656e 6365 5b44 696d 5d5d 2c0a 2020 2020  ence[Dim]],.    
+000095c0: 2020 2020 6f75 745f 6469 6d3a 2055 6e69      out_dim: Uni
+000095d0: 6f6e 5b44 696d 2c20 5365 7175 656e 6365  on[Dim, Sequence
+000095e0: 5b44 696d 5d5d 2c0a 2020 2020 2920 2d3e  [Dim]],.    ) ->
+000095f0: 2054 656e 736f 723a 0a20 2020 2020 2020   Tensor:.       
+00009600: 2022 2222 0a20 2020 2020 2020 2053 6361   """.        Sca
+00009610: 7474 6572 7320 696e 746f 206e 6577 207a  tters into new z
+00009620: 6572 6f2d 7465 6e73 6f72 2e0a 2020 2020  ero-tensor..    
+00009630: 2020 2020 4966 2065 6e74 7269 6573 2069      If entries i
+00009640: 6e20 696e 6469 6365 7320 6172 6520 6475  n indices are du
+00009650: 706c 6963 6174 6564 2c20 7468 6520 636f  plicated, the co
+00009660: 7272 6573 706f 6e64 696e 6720 7661 6c75  rresponding valu
+00009670: 6573 2069 6e20 736f 7572 6365 2077 696c  es in source wil
+00009680: 6c20 6265 2061 6464 6564 2074 6f67 6574  l be added toget
+00009690: 6865 720a 2020 2020 2020 2020 2873 6361  her.        (sca
+000096a0: 7474 6572 5f61 6464 2069 6e20 5079 546f  tter_add in PyTo
+000096b0: 7263 6829 2e0a 2020 2020 2020 2020 2854  rch)..        (T
+000096c0: 4620 7365 676d 656e 745f 7375 6d20 6361  F segment_sum ca
+000096d0: 6e20 6265 2069 6d70 6c65 6d65 6e74 6564  n be implemented
+000096e0: 2076 6961 2074 6869 732e 290a 0a20 2020   via this.)..   
+000096f0: 2020 2020 203a 7061 7261 6d20 736f 7572       :param sour
+00009700: 6365 3a20 5b62 6174 6368 5f64 696d 732e  ce: [batch_dims.
+00009710: 2e2e 2c20 696e 6469 6365 735f 6469 6d28  .., indices_dim(
+00009720: 7329 2e2e 2e2c 2066 6561 7475 7265 5f64  s)..., feature_d
+00009730: 696d 732e 2e2e 5d0a 2020 2020 2020 2020  ims...].        
+00009740: 3a70 6172 616d 2069 6e64 6963 6573 3a20  :param indices: 
+00009750: 5b62 6174 6368 5f64 696d 732e 2e2e 2c20  [batch_dims..., 
+00009760: 696e 6469 6365 735f 6469 6d28 7329 2e2e  indices_dim(s)..
+00009770: 2e5d 202d 3e20 6f75 745f 6469 6d0a 2020  .] -> out_dim.  
+00009780: 2020 2020 2020 3a70 6172 616d 2069 6e64        :param ind
+00009790: 6963 6573 5f64 696d 3a0a 2020 2020 2020  ices_dim:.      
+000097a0: 2020 3a70 6172 616d 206f 7574 5f64 696d    :param out_dim
+000097b0: 3a0a 2020 2020 2020 2020 3a72 6574 7572  :.        :retur
+000097c0: 6e3a 205b 6261 7463 685f 6469 6d73 2e2e  n: [batch_dims..
+000097d0: 2e2c 206f 7574 5f64 696d 2c20 6665 6174  ., out_dim, feat
+000097e0: 7572 655f 6469 6d73 2e2e 2e5d 0a20 2020  ure_dims...].   
+000097f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00009800: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+00009810: 6e64 6963 6573 5f64 696d 2c20 4469 6d29  ndices_dim, Dim)
+00009820: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
+00009830: 6469 6365 735f 6469 6d20 3d20 5b69 6e64  dices_dim = [ind
+00009840: 6963 6573 5f64 696d 5d0a 2020 2020 2020  ices_dim].      
+00009850: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00009860: 2020 2020 6173 7365 7274 206c 656e 2869      assert len(i
+00009870: 6e64 6963 6573 5f64 696d 2920 3e3d 2031  ndices_dim) >= 1
+00009880: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+00009890: 6963 6573 5f64 696d 203d 206c 6973 7428  ices_dim = list(
+000098a0: 696e 6469 6365 735f 6469 6d29 0a20 2020  indices_dim).   
+000098b0: 2020 2020 2061 7373 6572 7420 696e 6469       assert indi
+000098c0: 6365 732e 6474 7970 652e 7374 6172 7473  ces.dtype.starts
+000098d0: 7769 7468 2822 696e 7422 290a 2020 2020  with("int").    
+000098e0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+000098f0: 6528 6f75 745f 6469 6d2c 2044 696d 293a  e(out_dim, Dim):
+00009900: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00009910: 5f66 6c61 745f 6469 6d20 3d20 6f75 745f  _flat_dim = out_
+00009920: 6469 6d0a 2020 2020 2020 2020 2020 2020  dim.            
+00009930: 6f75 745f 6469 6d20 3d20 5b6f 7574 5f64  out_dim = [out_d
+00009940: 696d 5d0a 2020 2020 2020 2020 656c 6966  im].        elif
+00009950: 206c 656e 286f 7574 5f64 696d 2920 3d3d   len(out_dim) ==
+00009960: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00009970: 6f75 745f 666c 6174 5f64 696d 203d 206f  out_flat_dim = o
+00009980: 7574 5f64 696d 5b30 5d0a 2020 2020 2020  ut_dim[0].      
+00009990: 2020 2020 2020 6f75 745f 6469 6d20 3d20        out_dim = 
+000099a0: 5b6f 7574 5f66 6c61 745f 6469 6d5d 0a20  [out_flat_dim]. 
+000099b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000099c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000099d0: 6c65 6e28 6f75 745f 6469 6d29 203e 2031  len(out_dim) > 1
+000099e0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+000099f0: 5f66 6c61 745f 6469 6d20 3d20 6f75 745f  _flat_dim = out_
+00009a00: 6469 6d5b 305d 0a20 2020 2020 2020 2020  dim[0].         
+00009a10: 2020 2066 6f72 2064 696d 2069 6e20 6f75     for dim in ou
+00009a20: 745f 6469 6d5b 313a 5d3a 0a20 2020 2020  t_dim[1:]:.     
+00009a30: 2020 2020 2020 2020 2020 206f 7574 5f66             out_f
+00009a40: 6c61 745f 6469 6d20 3d20 6f75 745f 666c  lat_dim = out_fl
+00009a50: 6174 5f64 696d 202a 2064 696d 0a20 2020  at_dim * dim.   
+00009a60: 2020 2020 2020 2020 206f 7574 5f64 696d           out_dim
+00009a70: 203d 206c 6973 7428 6f75 745f 6469 6d29   = list(out_dim)
+00009a80: 0a20 2020 2020 2020 2062 6174 6368 5f64  .        batch_d
+00009a90: 696d 7320 3d20 696e 6469 6365 732e 7265  ims = indices.re
+00009aa0: 6d61 696e 696e 675f 6469 6d73 2869 6e64  maining_dims(ind
+00009ab0: 6963 6573 5f64 696d 290a 2020 2020 2020  ices_dim).      
+00009ac0: 2020 6665 6174 7572 655f 6469 6d73 203d    feature_dims =
+00009ad0: 2073 6f75 7263 652e 7265 6d61 696e 696e   source.remainin
+00009ae0: 675f 6469 6d73 2862 6174 6368 5f64 696d  g_dims(batch_dim
+00009af0: 7320 2b20 696e 6469 6365 735f 6469 6d29  s + indices_dim)
+00009b00: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00009b10: 696e 6469 6365 735f 6469 6d29 203e 2031  indices_dim) > 1
+00009b20: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
+00009b30: 6469 6365 732c 2069 6e64 6963 6573 5f66  dices, indices_f
+00009b40: 6c61 745f 6469 6d20 3d20 7266 2e6d 6572  lat_dim = rf.mer
+00009b50: 6765 5f64 696d 7328 696e 6469 6365 732c  ge_dims(indices,
+00009b60: 2064 696d 733d 696e 6469 6365 735f 6469   dims=indices_di
+00009b70: 6d29 0a20 2020 2020 2020 2020 2020 2073  m).            s
+00009b80: 6f75 7263 652c 205f 203d 2072 662e 6d65  ource, _ = rf.me
+00009b90: 7267 655f 6469 6d73 2873 6f75 7263 652c  rge_dims(source,
+00009ba0: 2064 696d 733d 696e 6469 6365 735f 6469   dims=indices_di
+00009bb0: 6d2c 206f 7574 5f64 696d 3d69 6e64 6963  m, out_dim=indic
+00009bc0: 6573 5f66 6c61 745f 6469 6d29 0a20 2020  es_flat_dim).   
+00009bd0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00009be0: 2020 2020 2020 2069 6e64 6963 6573 5f66         indices_f
+00009bf0: 6c61 745f 6469 6d20 3d20 696e 6469 6365  lat_dim = indice
+00009c00: 735f 6469 6d5b 305d 0a20 2020 2020 2020  s_dim[0].       
+00009c10: 2073 6f75 7263 6520 3d20 736f 7572 6365   source = source
+00009c20: 2e63 6f70 795f 7472 616e 7370 6f73 6528  .copy_transpose(
+00009c30: 6261 7463 685f 6469 6d73 202b 205b 696e  batch_dims + [in
+00009c40: 6469 6365 735f 666c 6174 5f64 696d 5d20  dices_flat_dim] 
+00009c50: 2b20 6665 6174 7572 655f 6469 6d73 290a  + feature_dims).
+00009c60: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
+00009c70: 3d20 696e 6469 6365 732e 636f 7079 5f63  = indices.copy_c
+00009c80: 6f6d 7061 7469 626c 655f 746f 280a 2020  ompatible_to(.  
+00009c90: 2020 2020 2020 2020 2020 2320 7363 6174            # scat
+00009ca0: 7465 725f 6164 645f 2064 6f65 7320 6e6f  ter_add_ does no
+00009cb0: 7420 7375 7070 6f72 7420 6272 6f61 6463  t support broadc
+00009cc0: 6173 7469 6e67 2c20 616e 6420 6578 7065  asting, and expe
+00009cd0: 6374 7320 696e 6469 6365 7320 616e 6420  cts indices and 
+00009ce0: 736f 7572 6365 2074 6f20 6861 7665 2074  source to have t
+00009cf0: 6865 2073 616d 6520 6e75 6d62 6572 206f  he same number o
+00009d00: 6620 6469 6d73 0a20 2020 2020 2020 2020  f dims.         
+00009d10: 2020 2073 6f75 7263 652c 0a20 2020 2020     source,.     
+00009d20: 2020 2020 2020 2075 6e62 726f 6164 6361         unbroadca
+00009d30: 7374 3d54 7275 652c 0a20 2020 2020 2020  st=True,.       
+00009d40: 2020 2020 2061 6464 5f64 696d 733d 5472       add_dims=Tr
+00009d50: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00009d60: 6368 6563 6b5f 7370 6172 7365 3d46 616c  check_sparse=Fal
+00009d70: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00009d80: 6368 6563 6b5f 6474 7970 653d 4661 6c73  check_dtype=Fals
+00009d90: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
+00009da0: 2020 2020 206f 7574 5f64 696d 7320 3d20       out_dims = 
+00009db0: 6261 7463 685f 6469 6d73 202b 205b 6f75  batch_dims + [ou
+00009dc0: 745f 666c 6174 5f64 696d 5d20 2b20 6665  t_flat_dim] + fe
+00009dd0: 6174 7572 655f 6469 6d73 0a20 2020 2020  ature_dims.     
+00009de0: 2020 206f 7574 5f73 6861 7065 203d 205b     out_shape = [
+00009df0: 642e 6765 745f 6469 6d5f 7661 6c75 6528  d.get_dim_value(
+00009e00: 2920 666f 7220 6420 696e 206f 7574 5f64  ) for d in out_d
+00009e10: 696d 735d 0a20 2020 2020 2020 206f 7574  ims].        out
+00009e20: 5f72 6177 203d 2074 6f72 6368 2e7a 6572  _raw = torch.zer
+00009e30: 6f73 286f 7574 5f73 6861 7065 2c20 6474  os(out_shape, dt
+00009e40: 7970 653d 736f 7572 6365 2e72 6177 5f74  ype=source.raw_t
+00009e50: 656e 736f 722e 6474 7970 652c 2064 6576  ensor.dtype, dev
+00009e60: 6963 653d 736f 7572 6365 2e72 6177 5f74  ice=source.raw_t
+00009e70: 656e 736f 722e 6465 7669 6365 290a 2020  ensor.device).  
+00009e80: 2020 2020 2020 6f75 745f 7261 772e 7363        out_raw.sc
+00009e90: 6174 7465 725f 6164 645f 2864 696d 3d6c  atter_add_(dim=l
+00009ea0: 656e 2862 6174 6368 5f64 696d 7329 2c20  en(batch_dims), 
+00009eb0: 696e 6465 783d 696e 6469 6365 732e 7261  index=indices.ra
+00009ec0: 775f 7465 6e73 6f72 2e74 6f28 746f 7263  w_tensor.to(torc
+00009ed0: 682e 696e 7436 3429 2c20 7372 633d 736f  h.int64), src=so
+00009ee0: 7572 6365 2e72 6177 5f74 656e 736f 7229  urce.raw_tensor)
+00009ef0: 0a20 2020 2020 2020 2072 6573 203d 2054  .        res = T
+00009f00: 656e 736f 7228 0a20 2020 2020 2020 2020  ensor(.         
+00009f10: 2020 2022 7363 6174 7465 7222 2c0a 2020     "scatter",.  
+00009f20: 2020 2020 2020 2020 2020 6469 6d73 3d6f            dims=o
+00009f30: 7574 5f64 696d 732c 0a20 2020 2020 2020  ut_dims,.       
+00009f40: 2020 2020 2064 7479 7065 3d73 6f75 7263       dtype=sourc
+00009f50: 652e 6474 7970 652c 0a20 2020 2020 2020  e.dtype,.       
+00009f60: 2020 2020 2073 7061 7273 655f 6469 6d3d       sparse_dim=
+00009f70: 736f 7572 6365 2e73 7061 7273 655f 6469  source.sparse_di
+00009f80: 6d2c 0a20 2020 2020 2020 2020 2020 2072  m,.            r
+00009f90: 6177 5f74 656e 736f 723d 6f75 745f 7261  aw_tensor=out_ra
+00009fa0: 772c 0a20 2020 2020 2020 2029 0a20 2020  w,.        ).   
+00009fb0: 2020 2020 2069 6620 6c65 6e28 6f75 745f       if len(out_
+00009fc0: 6469 6d29 203e 2031 3a0a 2020 2020 2020  dim) > 1:.      
+00009fd0: 2020 2020 2020 7265 7320 3d20 7266 2e73        res = rf.s
+00009fe0: 706c 6974 5f64 696d 7328 7265 732c 2061  plit_dims(res, a
+00009ff0: 7869 733d 6f75 745f 666c 6174 5f64 696d  xis=out_flat_dim
+0000a000: 2c20 6469 6d73 3d6f 7574 5f64 696d 290a  , dims=out_dim).
+0000a010: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0000a020: 6573 0a0a 2020 2020 4073 7461 7469 636d  es..    @staticm
+0000a030: 6574 686f 640a 2020 2020 6465 6620 736c  ethod.    def sl
+0000a040: 6963 6528 0a20 2020 2020 2020 2073 6f75  ice(.        sou
+0000a050: 7263 653a 2054 656e 736f 722c 0a20 2020  rce: Tensor,.   
+0000a060: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
+0000a070: 6178 6973 3a20 4469 6d2c 0a20 2020 2020  axis: Dim,.     
+0000a080: 2020 2073 7461 7274 3a20 4f70 7469 6f6e     start: Option
+0000a090: 616c 5b55 6e69 6f6e 5b69 6e74 2c20 5465  al[Union[int, Te
+0000a0a0: 6e73 6f72 5d5d 203d 204e 6f6e 652c 0a20  nsor]] = None,. 
+0000a0b0: 2020 2020 2020 2065 6e64 3a20 4f70 7469         end: Opti
+0000a0c0: 6f6e 616c 5b55 6e69 6f6e 5b69 6e74 2c20  onal[Union[int, 
+0000a0d0: 5465 6e73 6f72 5d5d 203d 204e 6f6e 652c  Tensor]] = None,
+0000a0e0: 0a20 2020 2020 2020 2073 7465 703a 204f  .        step: O
+0000a0f0: 7074 696f 6e61 6c5b 556e 696f 6e5b 696e  ptional[Union[in
+0000a100: 742c 2054 656e 736f 725d 5d20 3d20 4e6f  t, Tensor]] = No
+0000a110: 6e65 2c0a 2020 2020 2020 2020 7369 7a65  ne,.        size
+0000a120: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
+0000a130: 5b69 6e74 2c20 5465 6e73 6f72 2c20 4469  [int, Tensor, Di
+0000a140: 6d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  m]] = None,.    
+0000a150: 2020 2020 6f75 745f 6469 6d3a 2044 696d      out_dim: Dim
+0000a160: 2c0a 2020 2020 2920 2d3e 2054 656e 736f  ,.    ) -> Tenso
+0000a170: 723a 0a20 2020 2020 2020 2022 2222 736c  r:.        """sl
+0000a180: 6963 6522 2222 0a20 2020 2020 2020 2061  ice""".        a
+0000a190: 7869 735f 696e 7420 3d20 736f 7572 6365  xis_int = source
+0000a1a0: 2e67 6574 5f61 7869 735f 6672 6f6d 5f64  .get_axis_from_d
+0000a1b0: 6573 6372 6970 7469 6f6e 2861 7869 732c  escription(axis,
+0000a1c0: 2061 6c6c 6f77 5f69 6e74 3d46 616c 7365   allow_int=False
+0000a1d0: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+0000a1e0: 736f 7572 6365 2e63 6f70 795f 7465 6d70  source.copy_temp
+0000a1f0: 6c61 7465 5f72 6570 6c61 6365 5f64 696d  late_replace_dim
+0000a200: 5f74 6167 2861 7869 733d 6178 6973 5f69  _tag(axis=axis_i
+0000a210: 6e74 2c20 6e65 775f 6469 6d5f 7461 673d  nt, new_dim_tag=
+0000a220: 6f75 745f 6469 6d29 0a20 2020 2020 2020  out_dim).       
+0000a230: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+0000a240: 7461 7274 2c20 5465 6e73 6f72 293a 0a20  tart, Tensor):. 
+0000a250: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000a260: 7420 7374 6172 742e 6469 6d73 203d 3d20  t start.dims == 
+0000a270: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+0000a280: 7461 7274 203d 2073 7461 7274 2e72 6177  tart = start.raw
+0000a290: 5f74 656e 736f 720a 2020 2020 2020 2020  _tensor.        
+0000a2a0: 6966 2073 7461 7274 2069 7320 4e6f 6e65  if start is None
+0000a2b0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0000a2c0: 6172 7420 3d20 300a 2020 2020 2020 2020  art = 0.        
+0000a2d0: 6966 2069 7369 6e73 7461 6e63 6528 7369  if isinstance(si
+0000a2e0: 7a65 2c20 4469 6d29 3a0a 2020 2020 2020  ze, Dim):.      
+0000a2f0: 2020 2020 2020 7369 7a65 203d 2073 697a        size = siz
+0000a300: 652e 6765 745f 6469 6d5f 7661 6c75 6528  e.get_dim_value(
+0000a310: 290a 2020 2020 2020 2020 6966 2073 697a  ).        if siz
+0000a320: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+0000a330: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000a340: 7420 656e 6420 6973 204e 6f6e 650a 2020  t end is None.  
+0000a350: 2020 2020 2020 2020 2020 6f75 742e 7261            out.ra
+0000a360: 775f 7465 6e73 6f72 203d 2074 6f72 6368  w_tensor = torch
+0000a370: 2e6e 6172 726f 7728 736f 7572 6365 2e72  .narrow(source.r
+0000a380: 6177 5f74 656e 736f 722c 2064 696d 3d61  aw_tensor, dim=a
+0000a390: 7869 735f 696e 742c 2073 7461 7274 3d73  xis_int, start=s
+0000a3a0: 7461 7274 2c20 6c65 6e67 7468 3d73 697a  tart, length=siz
+0000a3b0: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
+0000a3c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000a3d0: 6973 696e 7374 616e 6365 2865 6e64 2c20  isinstance(end, 
+0000a3e0: 5465 6e73 6f72 293a 0a20 2020 2020 2020  Tensor):.       
+0000a3f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000a400: 656e 642e 6469 6d73 203d 3d20 2829 0a20  end.dims == (). 
+0000a410: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000a420: 6e64 203d 2065 6e64 2e72 6177 5f74 656e  nd = end.raw_ten
+0000a430: 736f 720a 2020 2020 2020 2020 2020 2020  sor.            
+0000a440: 6966 2065 6e64 2069 7320 4e6f 6e65 3a0a  if end is None:.
+0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a460: 656e 6420 3d20 6178 6973 2e67 6574 5f64  end = axis.get_d
+0000a470: 696d 5f76 616c 7565 2829 0a20 2020 2020  im_value().     
+0000a480: 2020 2020 2020 206f 7574 2e72 6177 5f74         out.raw_t
+0000a490: 656e 736f 7220 3d20 746f 7263 682e 6e61  ensor = torch.na
+0000a4a0: 7272 6f77 2873 6f75 7263 652e 7261 775f  rrow(source.raw_
+0000a4b0: 7465 6e73 6f72 2c20 6469 6d3d 6178 6973  tensor, dim=axis
+0000a4c0: 5f69 6e74 2c20 7374 6172 743d 7374 6172  _int, start=star
+0000a4d0: 742c 206c 656e 6774 683d 656e 6420 2d20  t, length=end - 
+0000a4e0: 7374 6172 7429 0a20 2020 2020 2020 2072  start).        r
+0000a4f0: 6574 7572 6e20 6f75 740a 0a20 2020 2040  eturn out..    @
+0000a500: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0000a510: 2064 6566 2077 6865 7265 280a 2020 2020   def where(.    
+0000a520: 2020 2020 636f 6e64 3a20 5465 6e73 6f72      cond: Tensor
+0000a530: 2c0a 2020 2020 2020 2020 7472 7565 5f3a  ,.        true_:
+0000a540: 2055 6e69 6f6e 5b54 656e 736f 722c 2072   Union[Tensor, r
+0000a550: 662e 5261 7754 656e 736f 7254 7970 6573  f.RawTensorTypes
+0000a560: 5d2c 0a20 2020 2020 2020 2066 616c 7365  ],.        false
+0000a570: 5f3a 2055 6e69 6f6e 5b54 656e 736f 722c  _: Union[Tensor,
+0000a580: 2072 662e 5261 7754 656e 736f 7254 7970   rf.RawTensorTyp
+0000a590: 6573 5d2c 0a20 2020 2020 2020 202a 2c0a  es],.        *,.
+0000a5a0: 2020 2020 2020 2020 616c 6c6f 775f 6272          allow_br
+0000a5b0: 6f61 6463 6173 745f 616c 6c5f 736f 7572  oadcast_all_sour
+0000a5c0: 6365 733a 2062 6f6f 6c20 3d20 4661 6c73  ces: bool = Fals
+0000a5d0: 652c 0a20 2020 2029 202d 3e20 5465 6e73  e,.    ) -> Tens
+0000a5e0: 6f72 3a0a 2020 2020 2020 2020 2222 2277  or:.        """w
+0000a5f0: 6865 7265 2222 220a 2020 2020 2020 2020  here""".        
+0000a600: 7472 7565 5f20 3d20 7266 2e63 6f6e 7665  true_ = rf.conve
+0000a610: 7274 5f74 6f5f 7465 6e73 6f72 2874 7275  rt_to_tensor(tru
+0000a620: 655f 2c20 5f62 6163 6b65 6e64 3d54 6f72  e_, _backend=Tor
+0000a630: 6368 4261 636b 656e 642c 2064 6576 6963  chBackend, devic
+0000a640: 653d 636f 6e64 2e64 6576 6963 6529 0a20  e=cond.device). 
+0000a650: 2020 2020 2020 2066 616c 7365 5f20 3d20         false_ = 
+0000a660: 7266 2e63 6f6e 7665 7274 5f74 6f5f 7465  rf.convert_to_te
+0000a670: 6e73 6f72 2866 616c 7365 5f2c 205f 6261  nsor(false_, _ba
+0000a680: 636b 656e 643d 546f 7263 6842 6163 6b65  ckend=TorchBacke
+0000a690: 6e64 2c20 6465 7669 6365 3d63 6f6e 642e  nd, device=cond.
+0000a6a0: 6465 7669 6365 290a 2020 2020 2020 2020  device).        
+0000a6b0: 6f75 7420 3d20 5465 6e73 6f72 2e67 6574  out = Tensor.get
+0000a6c0: 5f63 6f6d 6d6f 6e5f 6461 7461 280a 2020  _common_data(.  
+0000a6d0: 2020 2020 2020 2020 2020 5b74 7275 655f            [true_
+0000a6e0: 2c20 6661 6c73 655f 2c20 636f 6e64 5d2c  , false_, cond],
+0000a6f0: 2061 6c6c 6f77 5f62 726f 6164 6361 7374   allow_broadcast
+0000a700: 5f61 6c6c 5f73 6f75 7263 6573 3d61 6c6c  _all_sources=all
+0000a710: 6f77 5f62 726f 6164 6361 7374 5f61 6c6c  ow_broadcast_all
+0000a720: 5f73 6f75 7263 6573 2c20 6e61 6d65 3d22  _sources, name="
+0000a730: 7768 6572 6522 0a20 2020 2020 2020 2029  where".        )
+0000a740: 0a20 2020 2020 2020 206f 7574 2e64 7479  .        out.dty
+0000a750: 7065 203d 2074 7275 655f 2e64 7479 7065  pe = true_.dtype
+0000a760: 0a20 2020 2020 2020 206f 7574 2e73 7061  .        out.spa
+0000a770: 7273 655f 6469 6d20 3d20 7472 7565 5f2e  rse_dim = true_.
+0000a780: 7370 6172 7365 5f64 696d 206f 7220 6661  sparse_dim or fa
+0000a790: 6c73 655f 2e73 7061 7273 655f 6469 6d0a  lse_.sparse_dim.
+0000a7a0: 2020 2020 2020 2020 6f75 742e 6665 6174          out.feat
+0000a7b0: 7572 655f 6469 6d20 3d20 7472 7565 5f2e  ure_dim = true_.
+0000a7c0: 6665 6174 7572 655f 6469 6d20 6f72 2066  feature_dim or f
+0000a7d0: 616c 7365 5f2e 6665 6174 7572 655f 6469  alse_.feature_di
+0000a7e0: 6d0a 2020 2020 2020 2020 636f 6e64 5f62  m.        cond_b
+0000a7f0: 635f 7261 7720 3d20 636f 6e64 2e63 6f70  c_raw = cond.cop
+0000a800: 795f 636f 6d70 6174 6962 6c65 5f74 6f5f  y_compatible_to_
+0000a810: 6469 6d73 5f72 6177 286f 7574 2e64 696d  dims_raw(out.dim
+0000a820: 7329 0a20 2020 2020 2020 2074 7275 655f  s).        true_
+0000a830: 6263 5f72 6177 203d 2074 7275 655f 2e63  bc_raw = true_.c
+0000a840: 6f70 795f 636f 6d70 6174 6962 6c65 5f74  opy_compatible_t
+0000a850: 6f5f 6469 6d73 5f72 6177 286f 7574 2e64  o_dims_raw(out.d
+0000a860: 696d 7329 0a20 2020 2020 2020 2066 616c  ims).        fal
+0000a870: 7365 5f62 635f 7261 7720 3d20 6661 6c73  se_bc_raw = fals
+0000a880: 655f 2e63 6f70 795f 636f 6d70 6174 6962  e_.copy_compatib
+0000a890: 6c65 5f74 6f5f 6469 6d73 5f72 6177 286f  le_to_dims_raw(o
+0000a8a0: 7574 2e64 696d 7329 0a20 2020 2020 2020  ut.dims).       
+0000a8b0: 206f 7574 2e72 6177 5f74 656e 736f 7220   out.raw_tensor 
+0000a8c0: 3d20 746f 7263 682e 7768 6572 6528 636f  = torch.where(co
+0000a8d0: 6e64 5f62 635f 7261 772c 2074 7275 655f  nd_bc_raw, true_
+0000a8e0: 6263 5f72 6177 2c20 6661 6c73 655f 6263  bc_raw, false_bc
+0000a8f0: 5f72 6177 290a 2020 2020 2020 2020 7265  _raw).        re
+0000a900: 7475 726e 206f 7574 0a0a 2020 2020 4073  turn out..    @s
+0000a910: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+0000a920: 6465 6620 636c 6970 5f62 795f 7661 6c75  def clip_by_valu
+0000a930: 6528 0a20 2020 2020 2020 2078 3a20 5465  e(.        x: Te
+0000a940: 6e73 6f72 2c0a 2020 2020 2020 2020 636c  nsor,.        cl
+0000a950: 6970 5f76 616c 7565 5f6d 696e 3a20 556e  ip_value_min: Un
+0000a960: 696f 6e5b 5465 6e73 6f72 2c20 7266 2e52  ion[Tensor, rf.R
+0000a970: 6177 5465 6e73 6f72 5479 7065 735d 2c0a  awTensorTypes],.
+0000a980: 2020 2020 2020 2020 636c 6970 5f76 616c          clip_val
+0000a990: 7565 5f6d 6178 3a20 556e 696f 6e5b 5465  ue_max: Union[Te
+0000a9a0: 6e73 6f72 2c20 7266 2e52 6177 5465 6e73  nsor, rf.RawTens
+0000a9b0: 6f72 5479 7065 735d 2c0a 2020 2020 2020  orTypes],.      
+0000a9c0: 2020 2a2c 0a20 2020 2020 2020 2061 6c6c    *,.        all
+0000a9d0: 6f77 5f62 726f 6164 6361 7374 5f61 6c6c  ow_broadcast_all
+0000a9e0: 5f73 6f75 7263 6573 3a20 626f 6f6c 203d  _sources: bool =
+0000a9f0: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
+0000aa00: 2054 656e 736f 723a 0a20 2020 2020 2020   Tensor:.       
+0000aa10: 2022 2222 636c 6970 2062 7920 7661 6c75   """clip by valu
+0000aa20: 6522 2222 0a20 2020 2020 2020 2063 6c69  e""".        cli
+0000aa30: 705f 7661 6c75 655f 6d69 6e20 3d20 7266  p_value_min = rf
+0000aa40: 2e63 6f6e 7665 7274 5f74 6f5f 7465 6e73  .convert_to_tens
+0000aa50: 6f72 2863 6c69 705f 7661 6c75 655f 6d69  or(clip_value_mi
+0000aa60: 6e2c 205f 6261 636b 656e 643d 546f 7263  n, _backend=Torc
+0000aa70: 6842 6163 6b65 6e64 2c20 6465 7669 6365  hBackend, device
+0000aa80: 3d78 2e64 6576 6963 6529 0a20 2020 2020  =x.device).     
+0000aa90: 2020 2063 6c69 705f 7661 6c75 655f 6d61     clip_value_ma
+0000aaa0: 7820 3d20 7266 2e63 6f6e 7665 7274 5f74  x = rf.convert_t
+0000aab0: 6f5f 7465 6e73 6f72 2863 6c69 705f 7661  o_tensor(clip_va
+0000aac0: 6c75 655f 6d61 782c 205f 6261 636b 656e  lue_max, _backen
+0000aad0: 643d 546f 7263 6842 6163 6b65 6e64 2c20  d=TorchBackend, 
+0000aae0: 6465 7669 6365 3d78 2e64 6576 6963 6529  device=x.device)
+0000aaf0: 0a20 2020 2020 2020 206f 7574 203d 2054  .        out = T
+0000ab00: 656e 736f 722e 6765 745f 636f 6d6d 6f6e  ensor.get_common
+0000ab10: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+0000ab20: 2020 205b 782c 2063 6c69 705f 7661 6c75     [x, clip_valu
+0000ab30: 655f 6d69 6e2c 2063 6c69 705f 7661 6c75  e_min, clip_valu
+0000ab40: 655f 6d61 785d 2c0a 2020 2020 2020 2020  e_max],.        
+0000ab50: 2020 2020 616c 6c6f 775f 6272 6f61 6463      allow_broadc
+0000ab60: 6173 745f 616c 6c5f 736f 7572 6365 733d  ast_all_sources=
+0000ab70: 616c 6c6f 775f 6272 6f61 6463 6173 745f  allow_broadcast_
+0000ab80: 616c 6c5f 736f 7572 6365 732c 0a20 2020  all_sources,.   
+0000ab90: 2020 2020 2020 2020 206e 616d 653d 2263           name="c
+0000aba0: 6c69 705f 6279 5f76 616c 7565 222c 0a20  lip_by_value",. 
+0000abb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000abc0: 206f 7574 2e64 7479 7065 203d 2078 2e64   out.dtype = x.d
+0000abd0: 7479 7065 0a20 2020 2020 2020 206f 7574  type.        out
+0000abe0: 2e73 7061 7273 655f 6469 6d20 3d20 782e  .sparse_dim = x.
+0000abf0: 7370 6172 7365 5f64 696d 0a20 2020 2020  sparse_dim.     
+0000ac00: 2020 206f 7574 2e66 6561 7475 7265 5f64     out.feature_d
+0000ac10: 696d 203d 2078 2e66 6561 7475 7265 5f64  im = x.feature_d
+0000ac20: 696d 0a20 2020 2020 2020 2078 5f62 635f  im.        x_bc_
+0000ac30: 7261 7720 3d20 782e 636f 7079 5f63 6f6d  raw = x.copy_com
+0000ac40: 7061 7469 626c 655f 746f 5f64 696d 735f  patible_to_dims_
+0000ac50: 7261 7728 6f75 742e 6469 6d73 290a 2020  raw(out.dims).  
+0000ac60: 2020 2020 2020 6d69 6e5f 6263 5f72 6177        min_bc_raw
+0000ac70: 203d 2063 6c69 705f 7661 6c75 655f 6d69   = clip_value_mi
+0000ac80: 6e2e 636f 7079 5f63 6f6d 7061 7469 626c  n.copy_compatibl
+0000ac90: 655f 746f 5f64 696d 735f 7261 7728 6f75  e_to_dims_raw(ou
+0000aca0: 742e 6469 6d73 290a 2020 2020 2020 2020  t.dims).        
+0000acb0: 6d61 785f 6263 5f72 6177 203d 2063 6c69  max_bc_raw = cli
+0000acc0: 705f 7661 6c75 655f 6d61 782e 636f 7079  p_value_max.copy
+0000acd0: 5f63 6f6d 7061 7469 626c 655f 746f 5f64  _compatible_to_d
+0000ace0: 696d 735f 7261 7728 6f75 742e 6469 6d73  ims_raw(out.dims
+0000acf0: 290a 2020 2020 2020 2020 6f75 742e 7261  ).        out.ra
+0000ad00: 775f 7465 6e73 6f72 203d 2074 6f72 6368  w_tensor = torch
+0000ad10: 2e63 6c61 6d70 2878 5f62 635f 7261 772c  .clamp(x_bc_raw,
+0000ad20: 206d 696e 5f62 635f 7261 772c 206d 6178   min_bc_raw, max
+0000ad30: 5f62 635f 7261 7729 0a20 2020 2020 2020  _bc_raw).       
+0000ad40: 2072 6574 7572 6e20 6f75 740a 0a20 2020   return out..   
+0000ad50: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0000ad60: 2020 2064 6566 206d 6174 6d75 6c28 613a     def matmul(a:
+0000ad70: 205f 5454 2c20 623a 205f 5454 2c20 2a2c   _TT, b: _TT, *,
+0000ad80: 2072 6564 7563 653a 2055 6e69 6f6e 5b44   reduce: Union[D
+0000ad90: 696d 2c20 5365 7175 656e 6365 5b44 696d  im, Sequence[Dim
+0000ada0: 5d5d 2c20 7573 655f 6d61 736b 3a20 626f  ]], use_mask: bo
+0000adb0: 6f6c 203d 2054 7275 6529 202d 3e20 5f54  ol = True) -> _T
+0000adc0: 543a 0a20 2020 2020 2020 2022 2222 0a20  T:.        """. 
+0000add0: 2020 2020 2020 2062 6174 6368 6564 206d         batched m
+0000ade0: 6174 6d75 6c20 6f66 2061 2061 6e64 2062  atmul of a and b
+0000adf0: 2c20 7365 6520 6261 7365 2063 6c61 7373  , see base class
+0000ae00: 2064 6f63 2073 7472 696e 670a 2020 2020   doc string.    
+0000ae10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000ae20: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+0000ae30: 6475 6365 2c20 4469 6d29 3a0a 2020 2020  duce, Dim):.    
+0000ae40: 2020 2020 2020 2020 7265 6475 6365 203d          reduce =
+0000ae50: 205b 7265 6475 6365 5d0a 0a20 2020 2020   [reduce]..     
+0000ae60: 2020 2069 6620 7573 655f 6d61 736b 2061     if use_mask a
+0000ae70: 6e64 2061 6e79 2864 696d 2e64 796e 5f73  nd any(dim.dyn_s
+0000ae80: 697a 655f 6578 7420 666f 7220 6469 6d20  ize_ext for dim 
+0000ae90: 696e 2072 6564 7563 6529 3a0a 2020 2020  in reduce):.    
+0000aea0: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
+0000aeb0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
+0000aec0: 7228 226d 6173 6b69 6e67 2069 6e20 6d61  r("masking in ma
+0000aed0: 746d 756c 2072 6564 7563 6520 6e6f 7420  tmul reduce not 
+0000aee0: 7965 7420 696d 706c 656d 656e 7465 6422  yet implemented"
+0000aef0: 290a 0a20 2020 2020 2020 2061 5f64 696d  )..        a_dim
+0000af00: 7320 3d20 612e 6469 6d73 0a20 2020 2020  s = a.dims.     
+0000af10: 2020 2062 5f64 696d 7320 3d20 622e 6469     b_dims = b.di
+0000af20: 6d73 0a0a 2020 2020 2020 2020 6173 7365  ms..        asse
+0000af30: 7274 2061 6c6c 280a 2020 2020 2020 2020  rt all(.        
+0000af40: 2020 2020 6469 6d20 696e 2061 5f64 696d      dim in a_dim
+0000af50: 7320 666f 7220 6469 6d20 696e 2072 6564  s for dim in red
+0000af60: 7563 650a 2020 2020 2020 2020 292c 2066  uce.        ), f
+0000af70: 2227 6127 2064 6f65 7320 6e6f 7420 6861  "'a' does not ha
+0000af80: 7665 2074 6865 2073 7065 6369 6669 6564  ve the specified
+0000af90: 2072 6564 7563 6520 6469 6d28 7329 207b   reduce dim(s) {
+0000afa0: 7265 6475 6365 7d20 2861 2064 696d 733a  reduce} (a dims:
+0000afb0: 207b 615f 6469 6d73 7d29 220a 2020 2020   {a_dims})".    
+0000afc0: 2020 2020 6173 7365 7274 2061 6c6c 280a      assert all(.
+0000afd0: 2020 2020 2020 2020 2020 2020 6469 6d20              dim 
+0000afe0: 696e 2062 5f64 696d 7320 666f 7220 6469  in b_dims for di
+0000aff0: 6d20 696e 2072 6564 7563 650a 2020 2020  m in reduce.    
+0000b000: 2020 2020 292c 2066 2227 6227 2064 6f65      ), f"'b' doe
+0000b010: 7320 6e6f 7420 6861 7665 2074 6865 2073  s not have the s
+0000b020: 7065 6369 6669 6564 2072 6564 7563 6520  pecified reduce 
+0000b030: 6469 6d28 7329 207b 7265 6475 6365 7d20  dim(s) {reduce} 
+0000b040: 2862 2064 696d 733a 207b 625f 6469 6d73  (b dims: {b_dims
+0000b050: 7d29 220a 0a20 2020 2020 2020 2069 6620  })"..        if 
+0000b060: 6c65 6e28 7265 6475 6365 2920 3e20 313a  len(reduce) > 1:
+0000b070: 0a20 2020 2020 2020 2020 2020 2072 6564  .            red
+0000b080: 7563 6520 3d20 6c69 7374 2872 6564 7563  uce = list(reduc
+0000b090: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+0000b0a0: 6564 7563 652e 736f 7274 286b 6579 3d6c  educe.sort(key=l
+0000b0b0: 616d 6264 6120 6469 6d3a 2061 5f64 696d  ambda dim: a_dim
+0000b0c0: 732e 696e 6465 7828 6469 6d29 290a 0a20  s.index(dim)).. 
+0000b0d0: 2020 2020 2020 2023 206d 6174 6d75 6c20         # matmul 
+0000b0e0: 6d69 6768 7420 6765 7420 7371 7561 7265  might get square
+0000b0f0: 206d 6174 7269 6365 7320 6173 2061 7267   matrices as arg
+0000b100: 756d 656e 7473 2c20 7768 6572 6520 6120  uments, where a 
+0000b110: 6469 6d20 636f 756c 6420 6f63 6375 7220  dim could occur 
+0000b120: 6d75 6c74 6970 6c65 2074 696d 6573 2e0a  multiple times..
+0000b130: 2020 2020 2020 2020 2320 5468 6973 2063          # This c
+0000b140: 6f6d 706c 6963 6174 6573 2074 6865 206c  omplicates the l
+0000b150: 6f67 6963 2068 6572 652c 2061 6e64 2077  ogic here, and w
+0000b160: 6520 7072 6f70 6572 6c79 2068 6176 6520  e properly have 
+0000b170: 746f 2068 616e 646c 6520 6d61 7463 685f  to handle match_
+0000b180: 7072 696f 7269 7479 2e0a 2020 2020 2020  priority..      
+0000b190: 2020 615f 7265 6475 6365 5f61 7865 7320    a_reduce_axes 
+0000b1a0: 3d20 5b61 2e67 6574 5f61 7869 735f 6672  = [a.get_axis_fr
+0000b1b0: 6f6d 5f64 6573 6372 6970 7469 6f6e 2872  om_description(r
+0000b1c0: 6564 7563 655f 6469 6d29 2066 6f72 2072  educe_dim) for r
+0000b1d0: 6564 7563 655f 6469 6d20 696e 2072 6564  educe_dim in red
+0000b1e0: 7563 655d 0a20 2020 2020 2020 2062 5f72  uce].        b_r
+0000b1f0: 6564 7563 655f 6178 6573 203d 205b 622e  educe_axes = [b.
+0000b200: 6765 745f 6178 6973 5f66 726f 6d5f 6465  get_axis_from_de
+0000b210: 7363 7269 7074 696f 6e28 7265 6475 6365  scription(reduce
+0000b220: 5f64 696d 2920 666f 7220 7265 6475 6365  _dim) for reduce
+0000b230: 5f64 696d 2069 6e20 7265 6475 6365 5d0a  _dim in reduce].
+0000b240: 0a20 2020 2020 2020 2023 2057 6520 6173  .        # We as
+0000b250: 7375 6d65 2074 6861 7420 6469 6d20 7461  sume that dim ta
+0000b260: 6773 2069 6e20 7265 6d61 696e 696e 6720  gs in remaining 
+0000b270: 6469 6d73 2061 7265 2075 6e69 7175 652e  dims are unique.
+0000b280: 0a20 2020 2020 2020 2063 6f6d 6d6f 6e5f  .        common_
+0000b290: 6469 6d73 203d 205b 6469 6d20 666f 7220  dims = [dim for 
+0000b2a0: 692c 2064 696d 2069 6e20 656e 756d 6572  i, dim in enumer
+0000b2b0: 6174 6528 615f 6469 6d73 2920 6966 2064  ate(a_dims) if d
+0000b2c0: 696d 2069 6e20 625f 6469 6d73 2061 6e64  im in b_dims and
+0000b2d0: 2069 206e 6f74 2069 6e20 615f 7265 6475   i not in a_redu
+0000b2e0: 6365 5f61 7865 735d 0a20 2020 2020 2020  ce_axes].       
+0000b2f0: 2061 5f63 6f6d 6d6f 6e5f 6178 6573 203d   a_common_axes =
+0000b300: 205b 615f 6469 6d73 2e69 6e64 6578 2863   [a_dims.index(c
+0000b310: 6f6d 6d6f 6e5f 6469 6d29 2066 6f72 2063  ommon_dim) for c
+0000b320: 6f6d 6d6f 6e5f 6469 6d20 696e 2063 6f6d  ommon_dim in com
+0000b330: 6d6f 6e5f 6469 6d73 5d0a 2020 2020 2020  mon_dims].      
+0000b340: 2020 625f 636f 6d6d 6f6e 5f61 7865 7320    b_common_axes 
+0000b350: 3d20 5b62 5f64 696d 732e 696e 6465 7828  = [b_dims.index(
+0000b360: 636f 6d6d 6f6e 5f64 696d 2920 666f 7220  common_dim) for 
+0000b370: 636f 6d6d 6f6e 5f64 696d 2069 6e20 636f  common_dim in co
+0000b380: 6d6d 6f6e 5f64 696d 735d 0a0a 2020 2020  mmon_dims]..    
+0000b390: 2020 2020 615f 756e 6971 7565 5f61 7865      a_unique_axe
+0000b3a0: 7320 3d20 5b69 2066 6f72 2069 2069 6e20  s = [i for i in 
+0000b3b0: 7261 6e67 6528 6c65 6e28 615f 6469 6d73  range(len(a_dims
+0000b3c0: 2929 2069 6620 6920 6e6f 7420 696e 2061  )) if i not in a
+0000b3d0: 5f72 6564 7563 655f 6178 6573 2061 6e64  _reduce_axes and
+0000b3e0: 2069 206e 6f74 2069 6e20 615f 636f 6d6d   i not in a_comm
+0000b3f0: 6f6e 5f61 7865 735d 0a20 2020 2020 2020  on_axes].       
+0000b400: 2062 5f75 6e69 7175 655f 6178 6573 203d   b_unique_axes =
+0000b410: 205b 6920 666f 7220 6920 696e 2072 616e   [i for i in ran
+0000b420: 6765 286c 656e 2862 5f64 696d 7329 2920  ge(len(b_dims)) 
+0000b430: 6966 2069 206e 6f74 2069 6e20 625f 7265  if i not in b_re
+0000b440: 6475 6365 5f61 7865 7320 616e 6420 6920  duce_axes and i 
+0000b450: 6e6f 7420 696e 2062 5f63 6f6d 6d6f 6e5f  not in b_common_
+0000b460: 6178 6573 5d0a 0a20 2020 2020 2020 2061  axes]..        a
+0000b470: 5f72 6177 203d 2061 2e72 6177 5f74 656e  _raw = a.raw_ten
+0000b480: 736f 720a 2020 2020 2020 2020 625f 7261  sor.        b_ra
+0000b490: 7720 3d20 622e 7261 775f 7465 6e73 6f72  w = b.raw_tensor
+0000b4a0: 0a0a 2020 2020 2020 2020 615f 7368 6170  ..        a_shap
+0000b4b0: 6520 3d20 615f 7261 772e 7368 6170 650a  e = a_raw.shape.
+0000b4c0: 2020 2020 2020 2020 625f 7368 6170 6520          b_shape 
+0000b4d0: 3d20 625f 7261 772e 7368 6170 650a 0a20  = b_raw.shape.. 
+0000b4e0: 2020 2020 2020 2063 6f6d 6d6f 6e5f 6178         common_ax
+0000b4f0: 6573 5f73 6861 7065 203d 2074 7570 6c65  es_shape = tuple
+0000b500: 2861 5f73 6861 7065 5b69 5d20 666f 7220  (a_shape[i] for 
+0000b510: 6920 696e 2061 5f63 6f6d 6d6f 6e5f 6178  i in a_common_ax
+0000b520: 6573 290a 2020 2020 2020 2020 625f 636f  es).        b_co
+0000b530: 6d6d 6f6e 5f61 7865 735f 7368 6170 6520  mmon_axes_shape 
+0000b540: 3d20 7475 706c 6528 625f 7368 6170 655b  = tuple(b_shape[
+0000b550: 695d 2066 6f72 2069 2069 6e20 625f 636f  i] for i in b_co
+0000b560: 6d6d 6f6e 5f61 7865 7329 0a20 2020 2020  mmon_axes).     
+0000b570: 2020 2061 7373 6572 7420 636f 6d6d 6f6e     assert common
+0000b580: 5f61 7865 735f 7368 6170 6520 3d3d 2062  _axes_shape == b
+0000b590: 5f63 6f6d 6d6f 6e5f 6178 6573 5f73 6861  _common_axes_sha
+0000b5a0: 7065 2c20 2254 656e 736f 7220 7368 6170  pe, "Tensor shap
+0000b5b0: 6520 666f 7220 636f 6d6d 6f6e 2044 696d  e for common Dim
+0000b5c0: 7320 6f66 2061 2061 6e64 2062 2064 6f65  s of a and b doe
+0000b5d0: 7320 6e6f 7420 6d61 7463 682e 220a 0a20  s not match.".. 
+0000b5e0: 2020 2020 2020 2063 6f6d 6d6f 6e5f 6178         common_ax
+0000b5f0: 6573 5f74 6f74 616c 5f64 696d 656e 7369  es_total_dimensi
+0000b600: 6f6e 203d 2070 726f 6428 636f 6d6d 6f6e  on = prod(common
+0000b610: 5f61 7865 735f 7368 6170 6529 0a0a 2020  _axes_shape)..  
+0000b620: 2020 2020 2020 615f 756e 6971 7565 5f61        a_unique_a
+0000b630: 7865 735f 7368 6170 6520 3d20 7475 706c  xes_shape = tupl
+0000b640: 6528 615f 7368 6170 655b 695d 2066 6f72  e(a_shape[i] for
+0000b650: 2069 2069 6e20 615f 756e 6971 7565 5f61   i in a_unique_a
+0000b660: 7865 7329 0a20 2020 2020 2020 2062 5f75  xes).        b_u
+0000b670: 6e69 7175 655f 6178 6573 5f73 6861 7065  nique_axes_shape
+0000b680: 203d 2074 7570 6c65 2862 5f73 6861 7065   = tuple(b_shape
+0000b690: 5b69 5d20 666f 7220 6920 696e 2062 5f75  [i] for i in b_u
+0000b6a0: 6e69 7175 655f 6178 6573 290a 0a20 2020  nique_axes)..   
+0000b6b0: 2020 2020 2061 5f75 6e69 7175 655f 6178       a_unique_ax
+0000b6c0: 6573 5f74 6f74 616c 5f64 696d 656e 7369  es_total_dimensi
+0000b6d0: 6f6e 203d 2070 726f 6428 615f 756e 6971  on = prod(a_uniq
+0000b6e0: 7565 5f61 7865 735f 7368 6170 6529 0a20  ue_axes_shape). 
+0000b6f0: 2020 2020 2020 2062 5f75 6e69 7175 655f         b_unique_
+0000b700: 6178 6573 5f74 6f74 616c 5f64 696d 656e  axes_total_dimen
+0000b710: 7369 6f6e 203d 2070 726f 6428 625f 756e  sion = prod(b_un
+0000b720: 6971 7565 5f61 7865 735f 7368 6170 6529  ique_axes_shape)
+0000b730: 0a0a 2020 2020 2020 2020 7265 6475 6365  ..        reduce
+0000b740: 5f61 7865 735f 7368 6170 6520 3d20 7475  _axes_shape = tu
+0000b750: 706c 6528 615f 7368 6170 655b 695d 2066  ple(a_shape[i] f
+0000b760: 6f72 2069 2069 6e20 615f 7265 6475 6365  or i in a_reduce
+0000b770: 5f61 7865 7329 0a20 2020 2020 2020 2062  _axes).        b
+0000b780: 5f72 6564 7563 655f 6178 6573 5f73 6861  _reduce_axes_sha
+0000b790: 7065 203d 2074 7570 6c65 2862 5f73 6861  pe = tuple(b_sha
+0000b7a0: 7065 5b69 5d20 666f 7220 6920 696e 2062  pe[i] for i in b
+0000b7b0: 5f72 6564 7563 655f 6178 6573 290a 2020  _reduce_axes).  
+0000b7c0: 2020 2020 2020 6173 7365 7274 2072 6564        assert red
+0000b7d0: 7563 655f 6178 6573 5f73 6861 7065 203d  uce_axes_shape =
+0000b7e0: 3d20 625f 7265 6475 6365 5f61 7865 735f  = b_reduce_axes_
+0000b7f0: 7368 6170 652c 2022 5465 6e73 6f72 2073  shape, "Tensor s
+0000b800: 6861 7065 2066 6f72 2072 6564 7563 6520  hape for reduce 
+0000b810: 4469 6d73 2064 6f65 7320 6e6f 7420 6d61  Dims does not ma
+0000b820: 7463 6820 6265 7477 6565 6e20 6120 616e  tch between a an
+0000b830: 6420 622e 220a 0a20 2020 2020 2020 2072  d b."..        r
+0000b840: 6564 7563 655f 6178 6573 5f74 6f74 616c  educe_axes_total
+0000b850: 5f64 696d 656e 7369 6f6e 203d 2070 726f  _dimension = pro
+0000b860: 6428 7265 6475 6365 5f61 7865 735f 7368  d(reduce_axes_sh
+0000b870: 6170 6529 0a0a 2020 2020 2020 2020 2320  ape)..        # 
+0000b880: 4669 7273 7420 6368 6563 6b20 7768 6574  First check whet
+0000b890: 6865 7220 7765 2063 616e 2075 7365 2074  her we can use t
+0000b8a0: 6f72 6368 2e6e 6e2e 6675 6e63 7469 6f6e  orch.nn.function
+0000b8b0: 616c 2e6c 696e 6561 722e 0a20 2020 2020  al.linear..     
+0000b8c0: 2020 2069 6620 6c65 6e28 625f 636f 6d6d     if len(b_comm
+0000b8d0: 6f6e 5f61 7865 7329 203d 3d20 3020 616e  on_axes) == 0 an
+0000b8e0: 6420 6c65 6e28 625f 7265 6475 6365 5f61  d len(b_reduce_a
+0000b8f0: 7865 7329 203d 3d20 3120 616e 6420 6c65  xes) == 1 and le
+0000b900: 6e28 625f 756e 6971 7565 5f61 7865 7329  n(b_unique_axes)
+0000b910: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+0000b920: 2020 2061 5f72 6177 203d 2074 6f72 6368     a_raw = torch
+0000b930: 2e70 6572 6d75 7465 2861 5f72 6177 2c20  .permute(a_raw, 
+0000b940: 615f 756e 6971 7565 5f61 7865 7320 2b20  a_unique_axes + 
+0000b950: 615f 7265 6475 6365 5f61 7865 7329 0a20  a_reduce_axes). 
+0000b960: 2020 2020 2020 2020 2020 2062 5f72 6177             b_raw
+0000b970: 203d 2074 6f72 6368 2e70 6572 6d75 7465   = torch.permute
+0000b980: 2862 5f72 6177 2c20 625f 756e 6971 7565  (b_raw, b_unique
+0000b990: 5f61 7865 7320 2b20 625f 7265 6475 6365  _axes + b_reduce
+0000b9a0: 5f61 7865 7329 0a0a 2020 2020 2020 2020  _axes)..        
+0000b9b0: 2020 2020 7261 775f 7265 7375 6c74 203d      raw_result =
+0000b9c0: 2074 6f72 6368 2e6e 6e2e 6675 6e63 7469   torch.nn.functi
+0000b9d0: 6f6e 616c 2e6c 696e 6561 7228 615f 7261  onal.linear(a_ra
+0000b9e0: 772c 2062 5f72 6177 290a 0a20 2020 2020  w, b_raw)..     
+0000b9f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000ba00: 2020 2020 2061 5f72 6177 203d 2074 6f72       a_raw = tor
+0000ba10: 6368 2e70 6572 6d75 7465 2861 5f72 6177  ch.permute(a_raw
+0000ba20: 2c20 615f 636f 6d6d 6f6e 5f61 7865 7320  , a_common_axes 
+0000ba30: 2b20 615f 756e 6971 7565 5f61 7865 7320  + a_unique_axes 
+0000ba40: 2b20 615f 7265 6475 6365 5f61 7865 7329  + a_reduce_axes)
+0000ba50: 0a20 2020 2020 2020 2020 2020 2062 5f72  .            b_r
+0000ba60: 6177 203d 2074 6f72 6368 2e70 6572 6d75  aw = torch.permu
+0000ba70: 7465 2862 5f72 6177 2c20 625f 636f 6d6d  te(b_raw, b_comm
+0000ba80: 6f6e 5f61 7865 7320 2b20 625f 7265 6475  on_axes + b_redu
+0000ba90: 6365 5f61 7865 7320 2b20 625f 756e 6971  ce_axes + b_uniq
+0000baa0: 7565 5f61 7865 7329 0a0a 2020 2020 2020  ue_axes)..      
+0000bab0: 2020 2020 2020 6966 2063 6f6d 6d6f 6e5f        if common_
+0000bac0: 6178 6573 5f74 6f74 616c 5f64 696d 656e  axes_total_dimen
+0000bad0: 7369 6f6e 203d 3d20 313a 2020 2320 7374  sion == 1:  # st
+0000bae0: 616e 6461 7264 206d 6174 7269 7820 6d75  andard matrix mu
+0000baf0: 6c74 6970 6c69 6361 7469 6f6e 0a20 2020  ltiplication.   
+0000bb00: 2020 2020 2020 2020 2020 2020 2061 5f72               a_r
+0000bb10: 6177 203d 2074 6f72 6368 2e72 6573 6861  aw = torch.resha
+0000bb20: 7065 2861 5f72 6177 2c20 2861 5f75 6e69  pe(a_raw, (a_uni
+0000bb30: 7175 655f 6178 6573 5f74 6f74 616c 5f64  que_axes_total_d
+0000bb40: 696d 656e 7369 6f6e 2c20 7265 6475 6365  imension, reduce
+0000bb50: 5f61 7865 735f 746f 7461 6c5f 6469 6d65  _axes_total_dime
+0000bb60: 6e73 696f 6e29 290a 2020 2020 2020 2020  nsion)).        
+0000bb70: 2020 2020 2020 2020 625f 7261 7720 3d20          b_raw = 
+0000bb80: 746f 7263 682e 7265 7368 6170 6528 625f  torch.reshape(b_
+0000bb90: 7261 772c 2028 7265 6475 6365 5f61 7865  raw, (reduce_axe
+0000bba0: 735f 746f 7461 6c5f 6469 6d65 6e73 696f  s_total_dimensio
+0000bbb0: 6e2c 2062 5f75 6e69 7175 655f 6178 6573  n, b_unique_axes
+0000bbc0: 5f74 6f74 616c 5f64 696d 656e 7369 6f6e  _total_dimension
+0000bbd0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+0000bbe0: 2020 2020 7261 775f 7265 7375 6c74 203d      raw_result =
+0000bbf0: 2074 6f72 6368 2e6d 6d28 615f 7261 772c   torch.mm(a_raw,
+0000bc00: 2062 5f72 6177 290a 0a20 2020 2020 2020   b_raw)..       
+0000bc10: 2020 2020 2065 6c73 653a 2020 2320 6261       else:  # ba
+0000bc20: 7463 6865 6420 6d61 7472 6978 206d 756c  tched matrix mul
+0000bc30: 7469 706c 6963 6174 696f 6e0a 2020 2020  tiplication.    
+0000bc40: 2020 2020 2020 2020 2020 2020 615f 7261              a_ra
+0000bc50: 7720 3d20 746f 7263 682e 7265 7368 6170  w = torch.reshap
+0000bc60: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000bc70: 2020 2020 2020 2061 5f72 6177 2c20 2863         a_raw, (c
+0000bc80: 6f6d 6d6f 6e5f 6178 6573 5f74 6f74 616c  ommon_axes_total
+0000bc90: 5f64 696d 656e 7369 6f6e 2c20 615f 756e  _dimension, a_un
+0000bca0: 6971 7565 5f61 7865 735f 746f 7461 6c5f  ique_axes_total_
+0000bcb0: 6469 6d65 6e73 696f 6e2c 2072 6564 7563  dimension, reduc
+0000bcc0: 655f 6178 6573 5f74 6f74 616c 5f64 696d  e_axes_total_dim
+0000bcd0: 656e 7369 6f6e 290a 2020 2020 2020 2020  ension).        
+0000bce0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000bcf0: 2020 2020 2020 2020 2020 625f 7261 7720            b_raw 
+0000bd00: 3d20 746f 7263 682e 7265 7368 6170 6528  = torch.reshape(
+0000bd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bd20: 2020 2020 2062 5f72 6177 2c20 2863 6f6d       b_raw, (com
+0000bd30: 6d6f 6e5f 6178 6573 5f74 6f74 616c 5f64  mon_axes_total_d
+0000bd40: 696d 656e 7369 6f6e 2c20 7265 6475 6365  imension, reduce
+0000bd50: 5f61 7865 735f 746f 7461 6c5f 6469 6d65  _axes_total_dime
+0000bd60: 6e73 696f 6e2c 2062 5f75 6e69 7175 655f  nsion, b_unique_
+0000bd70: 6178 6573 5f74 6f74 616c 5f64 696d 656e  axes_total_dimen
+0000bd80: 7369 6f6e 290a 2020 2020 2020 2020 2020  sion).          
+0000bd90: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000bda0: 2020 2020 2020 2020 2072 6177 5f72 6573           raw_res
+0000bdb0: 756c 7420 3d20 746f 7263 682e 626d 6d28  ult = torch.bmm(
+0000bdc0: 615f 7261 772c 2062 5f72 6177 290a 0a20  a_raw, b_raw).. 
+0000bdd0: 2020 2020 2020 2020 2020 2072 6177 5f72             raw_r
+0000bde0: 6573 756c 7420 3d20 746f 7263 682e 7265  esult = torch.re
+0000bdf0: 7368 6170 6528 7261 775f 7265 7375 6c74  shape(raw_result
+0000be00: 2c20 636f 6d6d 6f6e 5f61 7865 735f 7368  , common_axes_sh
+0000be10: 6170 6520 2b20 615f 756e 6971 7565 5f61  ape + a_unique_a
+0000be20: 7865 735f 7368 6170 6520 2b20 625f 756e  xes_shape + b_un
+0000be30: 6971 7565 5f61 7865 735f 7368 6170 6529  ique_axes_shape)
+0000be40: 0a0a 2020 2020 2020 2020 615f 756e 6971  ..        a_uniq
+0000be50: 7565 5f64 696d 7320 3d20 5b61 5f64 696d  ue_dims = [a_dim
+0000be60: 735b 695d 2066 6f72 2069 2069 6e20 615f  s[i] for i in a_
+0000be70: 756e 6971 7565 5f61 7865 735d 0a20 2020  unique_axes].   
+0000be80: 2020 2020 2062 5f75 6e69 7175 655f 6469       b_unique_di
+0000be90: 6d73 203d 205b 625f 6469 6d73 5b69 5d20  ms = [b_dims[i] 
+0000bea0: 666f 7220 6920 696e 2062 5f75 6e69 7175  for i in b_uniqu
+0000beb0: 655f 6178 6573 5d0a 2020 2020 2020 2020  e_axes].        
+0000bec0: 7265 7375 6c74 5f64 696d 7320 3d20 636f  result_dims = co
+0000bed0: 6d6d 6f6e 5f64 696d 7320 2b20 615f 756e  mmon_dims + a_un
+0000bee0: 6971 7565 5f64 696d 7320 2b20 625f 756e  ique_dims + b_un
+0000bef0: 6971 7565 5f64 696d 730a 0a20 2020 2020  ique_dims..     
+0000bf00: 2020 2072 6573 756c 745f 7465 6e73 6f72     result_tensor
+0000bf10: 203d 2054 656e 736f 7228 0a20 2020 2020   = Tensor(.     
+0000bf20: 2020 2020 2020 206e 616d 653d 2264 6f74         name="dot
+0000bf30: 222c 2064 696d 733d 7265 7375 6c74 5f64  ", dims=result_d
+0000bf40: 696d 732c 2072 6177 5f74 656e 736f 723d  ims, raw_tensor=
+0000bf50: 7261 775f 7265 7375 6c74 2c20 6474 7970  raw_result, dtyp
+0000bf60: 653d 546f 7263 6842 6163 6b65 6e64 2e67  e=TorchBackend.g
+0000bf70: 6574 5f64 7479 7065 5f6e 616d 655f 7261  et_dtype_name_ra
+0000bf80: 7728 7261 775f 7265 7375 6c74 290a 2020  w(raw_result).  
+0000bf90: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000bfa0: 2072 6574 7572 6e20 7265 7375 6c74 5f74   return result_t
+0000bfb0: 656e 736f 720a 0a20 2020 2040 7374 6174  ensor..    @stat
+0000bfc0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+0000bfd0: 2072 616e 6765 5f6f 7665 725f 6469 6d28   range_over_dim(
+0000bfe0: 6469 6d3a 2044 696d 2c20 2a2c 2064 7479  dim: Dim, *, dty
+0000bff0: 7065 3a20 4f70 7469 6f6e 616c 5b73 7472  pe: Optional[str
+0000c000: 5d20 3d20 4e6f 6e65 2c20 6465 7669 6365  ] = None, device
+0000c010: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0000c020: 3d20 4e6f 6e65 2920 2d3e 2054 656e 736f  = None) -> Tenso
+0000c030: 725b 746f 7263 682e 5465 6e73 6f72 5d3a  r[torch.Tensor]:
+0000c040: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000c050: 2020 2020 203a 7061 7261 6d20 6469 6d3a       :param dim:
+0000c060: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000c070: 6474 7970 653a 0a20 2020 2020 2020 203a  dtype:.        :
+0000c080: 7061 7261 6d20 6465 7669 6365 3a0a 2020  param device:.  
+0000c090: 2020 2020 2020 3a72 6574 7572 6e3a 2074        :return: t
+0000c0a0: 656e 736f 7220 7769 7468 2073 6861 7065  ensor with shape
+0000c0b0: 205b 6469 6d5d 0a20 2020 2020 2020 2022   [dim].        "
+0000c0c0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0000c0d0: 7420 6474 7970 6520 616e 6420 6469 6d2e  t dtype and dim.
+0000c0e0: 6479 6e5f 7369 7a65 5f65 7874 3a0a 2020  dyn_size_ext:.  
+0000c0f0: 2020 2020 2020 2020 2020 6474 7970 6520            dtype 
+0000c100: 3d20 6469 6d2e 6479 6e5f 7369 7a65 5f65  = dim.dyn_size_e
+0000c110: 7874 2e64 7479 7065 0a20 2020 2020 2020  xt.dtype.       
+0000c120: 2069 6620 6e6f 7420 6474 7970 653a 0a20   if not dtype:. 
+0000c130: 2020 2020 2020 2020 2020 2064 7479 7065             dtype
+0000c140: 203d 2072 662e 6765 745f 6465 6661 756c   = rf.get_defaul
+0000c150: 745f 6172 7261 795f 696e 6465 785f 6474  t_array_index_dt
+0000c160: 7970 6528 290a 2020 2020 2020 2020 6f75  ype().        ou
+0000c170: 7420 3d20 5465 6e73 6f72 280a 2020 2020  t = Tensor(.    
+0000c180: 2020 2020 2020 2020 2272 616e 6765 222c          "range",
+0000c190: 0a20 2020 2020 2020 2020 2020 2064 696d  .            dim
+0000c1a0: 733d 5b64 696d 5d2c 0a20 2020 2020 2020  s=[dim],.       
+0000c1b0: 2020 2020 2073 7061 7273 655f 6469 6d3d       sparse_dim=
+0000c1c0: 6469 6d20 6966 2064 7479 7065 2e73 7461  dim if dtype.sta
+0000c1d0: 7274 7377 6974 6828 2269 6e74 2229 206f  rtswith("int") o
+0000c1e0: 7220 6474 7970 652e 7374 6172 7473 7769  r dtype.startswi
+0000c1f0: 7468 2822 7569 6e74 2229 2065 6c73 6520  th("uint") else 
+0000c200: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0000c210: 2020 6474 7970 653d 6474 7970 652c 0a20    dtype=dtype,. 
+0000c220: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c230: 206f 7574 2e72 6177 5f74 656e 736f 7220   out.raw_tensor 
+0000c240: 3d20 746f 7263 682e 6172 616e 6765 280a  = torch.arange(.
+0000c250: 2020 2020 2020 2020 2020 2020 6469 6d2e              dim.
+0000c260: 6765 745f 6469 6d5f 7661 6c75 6528 292c  get_dim_value(),
+0000c270: 2064 7479 7065 3d54 6f72 6368 4261 636b   dtype=TorchBack
+0000c280: 656e 642e 6173 5f64 7479 7065 5f72 6177  end.as_dtype_raw
+0000c290: 286f 7574 2e64 7479 7065 292c 2064 6576  (out.dtype), dev
+0000c2a0: 6963 653d 6465 7669 6365 206f 7220 7266  ice=device or rf
+0000c2b0: 2e67 6574 5f64 6566 6175 6c74 5f64 6576  .get_default_dev
+0000c2c0: 6963 6528 290a 2020 2020 2020 2020 290a  ice().        ).
+0000c2d0: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+0000c2e0: 7574 0a0a 2020 2020 4073 7461 7469 636d  ut..    @staticm
+0000c2f0: 6574 686f 640a 2020 2020 6465 6620 7265  ethod.    def re
+0000c300: 6475 6365 280a 2020 2020 2020 2020 736f  duce(.        so
+0000c310: 7572 6365 3a20 5465 6e73 6f72 5b74 6f72  urce: Tensor[tor
+0000c320: 6368 2e54 656e 736f 725d 2c0a 2020 2020  ch.Tensor],.    
+0000c330: 2020 2020 2a2c 0a20 2020 2020 2020 206d      *,.        m
+0000c340: 6f64 653a 2073 7472 2c0a 2020 2020 2020  ode: str,.      
+0000c350: 2020 6178 6973 3a20 556e 696f 6e5b 4469    axis: Union[Di
+0000c360: 6d2c 2053 6571 7565 6e63 655b 4469 6d5d  m, Sequence[Dim]
+0000c370: 5d2c 0a20 2020 2020 2020 2075 7365 5f6d  ],.        use_m
+0000c380: 6173 6b3a 2062 6f6f 6c20 3d20 5472 7565  ask: bool = True
+0000c390: 2c0a 2020 2020 2920 2d3e 2054 656e 736f  ,.    ) -> Tenso
+0000c3a0: 725b 746f 7263 682e 5465 6e73 6f72 5d3a  r[torch.Tensor]:
+0000c3b0: 0a20 2020 2020 2020 2022 2222 7265 6475  .        """redu
+0000c3c0: 6365 2222 220a 2020 2020 2020 2020 6173  ce""".        as
+0000c3d0: 7365 7274 206d 6f64 6520 696e 2042 6163  sert mode in Bac
+0000c3e0: 6b65 6e64 2e5f 416c 6c6f 7765 6452 6564  kend._AllowedRed
+0000c3f0: 7563 654d 6f64 6573 0a20 2020 2020 2020  uceModes.       
+0000c400: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
+0000c410: 7869 732c 2044 696d 293a 0a20 2020 2020  xis, Dim):.     
+0000c420: 2020 2020 2020 2061 7869 7320 3d20 5b61         axis = [a
+0000c430: 7869 735d 0a20 2020 2020 2020 2061 7373  xis].        ass
+0000c440: 6572 7420 616c 6c28 6973 696e 7374 616e  ert all(isinstan
+0000c450: 6365 2864 696d 2c20 4469 6d29 2066 6f72  ce(dim, Dim) for
+0000c460: 2064 696d 2069 6e20 6178 6973 290a 2020   dim in axis).  
+0000c470: 2020 2020 2020 7261 775f 6469 6d73 203d        raw_dims =
+0000c480: 205b 736f 7572 6365 2e67 6574 5f61 7869   [source.get_axi
+0000c490: 735f 6672 6f6d 5f64 6573 6372 6970 7469  s_from_descripti
+0000c4a0: 6f6e 2864 696d 2920 666f 7220 6469 6d20  on(dim) for dim 
+0000c4b0: 696e 2061 7869 735d 0a20 2020 2020 2020  in axis].       
+0000c4c0: 2072 6573 5f64 696d 7320 3d20 5b64 696d   res_dims = [dim
+0000c4d0: 2066 6f72 2069 2c20 6469 6d20 696e 2065   for i, dim in e
+0000c4e0: 6e75 6d65 7261 7465 2873 6f75 7263 652e  numerate(source.
+0000c4f0: 6469 6d73 2920 6966 2069 206e 6f74 2069  dims) if i not i
+0000c500: 6e20 7261 775f 6469 6d73 5d0a 2020 2020  n raw_dims].    
+0000c510: 2020 2020 636f 7272 6563 7469 6f6e 5f66      correction_f
+0000c520: 6163 746f 723a 204f 7074 696f 6e61 6c5b  actor: Optional[
+0000c530: 746f 7263 682e 5465 6e73 6f72 5d20 3d20  torch.Tensor] = 
+0000c540: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
+0000c550: 7573 655f 6d61 736b 2061 6e64 2061 6e79  use_mask and any
+0000c560: 2864 696d 2e6e 6565 645f 6d61 736b 696e  (dim.need_maskin
+0000c570: 6728 2920 666f 7220 6469 6d20 696e 2061  g() for dim in a
+0000c580: 7869 7329 3a0a 2020 2020 2020 2020 2020  xis):.          
+0000c590: 2020 736f 7572 6365 203d 2073 6f75 7263    source = sourc
+0000c5a0: 652e 636f 7079 2829 0a20 2020 2020 2020  e.copy().       
+0000c5b0: 2020 2020 2064 7479 7065 203d 2073 6f75       dtype = sou
+0000c5c0: 7263 652e 7261 775f 7465 6e73 6f72 2e64  rce.raw_tensor.d
+0000c5d0: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+0000c5e0: 2069 6620 6d6f 6465 203d 3d20 226d 6178   if mode == "max
+0000c5f0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+0000c600: 2020 206d 6173 6b5f 7661 6c75 6520 3d20     mask_value = 
+0000c610: 746f 7263 682e 6669 6e66 6f28 6474 7970  torch.finfo(dtyp
+0000c620: 6529 2e6d 696e 2069 6620 6474 7970 652e  e).min if dtype.
+0000c630: 6973 5f66 6c6f 6174 696e 675f 706f 696e  is_floating_poin
+0000c640: 7420 656c 7365 2074 6f72 6368 2e69 696e  t else torch.iin
+0000c650: 666f 2864 7479 7065 292e 6d69 6e0a 2020  fo(dtype).min.  
+0000c660: 2020 2020 2020 2020 2020 656c 6966 206d            elif m
+0000c670: 6f64 6520 3d3d 2022 6d69 6e22 3a0a 2020  ode == "min":.  
+0000c680: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0000c690: 736b 5f76 616c 7565 203d 2074 6f72 6368  sk_value = torch
+0000c6a0: 2e66 696e 666f 2864 7479 7065 292e 6d61  .finfo(dtype).ma
+0000c6b0: 7820 6966 2064 7479 7065 2e69 735f 666c  x if dtype.is_fl
+0000c6c0: 6f61 7469 6e67 5f70 6f69 6e74 2065 6c73  oating_point els
+0000c6d0: 6520 746f 7263 682e 6969 6e66 6f28 6474  e torch.iinfo(dt
+0000c6e0: 7970 6529 2e6d 6178 0a20 2020 2020 2020  ype).max.       
+0000c6f0: 2020 2020 2065 6c69 6620 6d6f 6465 203d       elif mode =
+0000c700: 3d20 2273 756d 223a 0a20 2020 2020 2020  = "sum":.       
+0000c710: 2020 2020 2020 2020 206d 6173 6b5f 7661           mask_va
+0000c720: 6c75 6520 3d20 300a 2020 2020 2020 2020  lue = 0.        
+0000c730: 2020 2020 656c 6966 206d 6f64 6520 3d3d      elif mode ==
+0000c740: 2022 6d65 616e 223a 0a20 2020 2020 2020   "mean":.       
+0000c750: 2020 2020 2020 2020 206d 6173 6b5f 7661           mask_va
+0000c760: 6c75 6520 3d20 300a 2020 2020 2020 2020  lue = 0.        
+0000c770: 2020 2020 2020 2020 666f 7220 6469 6d20          for dim 
+0000c780: 696e 2061 7869 733a 0a20 2020 2020 2020  in axis:.       
+0000c790: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000c7a0: 6469 6d2e 6e65 6564 5f6d 6173 6b69 6e67  dim.need_masking
+0000c7b0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000c7c0: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+0000c7d0: 6c5f 6e75 6d5f 656c 203d 2064 696d 2e67  l_num_el = dim.g
+0000c7e0: 6574 5f64 696d 5f76 616c 7565 5f74 656e  et_dim_value_ten
+0000c7f0: 736f 7228 290a 2020 2020 2020 2020 2020  sor().          
+0000c800: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+0000c810: 7475 616c 5f6e 756d 5f65 6c20 3d20 6469  tual_num_el = di
+0000c820: 6d2e 6765 745f 7369 7a65 5f74 656e 736f  m.get_size_tenso
+0000c830: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+0000c840: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+0000c850: 656c 5f72 6564 7563 655f 6469 6d73 203d  el_reduce_dims =
+0000c860: 205b 6469 6d5f 2066 6f72 2064 696d 5f20   [dim_ for dim_ 
+0000c870: 696e 2061 7869 7320 6966 2064 696d 5f20  in axis if dim_ 
+0000c880: 696e 2061 6374 7561 6c5f 6e75 6d5f 656c  in actual_num_el
+0000c890: 2e64 696d 735d 0a20 2020 2020 2020 2020  .dims].         
+0000c8a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c8b0: 6620 6e75 6d5f 656c 5f72 6564 7563 655f  f num_el_reduce_
+0000c8c0: 6469 6d73 3a0a 2020 2020 2020 2020 2020  dims:.          
+0000c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8e0: 2020 6163 7475 616c 5f6e 756d 5f65 6c20    actual_num_el 
+0000c8f0: 3d20 7266 2e72 6564 7563 655f 7375 6d28  = rf.reduce_sum(
+0000c900: 6163 7475 616c 5f6e 756d 5f65 6c2c 2061  actual_num_el, a
+0000c910: 7869 733d 6e75 6d5f 656c 5f72 6564 7563  xis=num_el_reduc
+0000c920: 655f 6469 6d73 290a 2020 2020 2020 2020  e_dims).        
+0000c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c940: 2020 2020 666f 7220 6469 6d5f 2069 6e20      for dim_ in 
+0000c950: 6e75 6d5f 656c 5f72 6564 7563 655f 6469  num_el_reduce_di
+0000c960: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
+0000c970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c980: 2020 2020 746f 7461 6c5f 6e75 6d5f 656c      total_num_el
+0000c990: 202a 3d20 6469 6d5f 2e67 6574 5f64 696d   *= dim_.get_dim
+0000c9a0: 5f76 616c 7565 5f74 656e 736f 7228 290a  _value_tensor().
+0000c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9c0: 2020 2020 2020 2020 636f 7272 6563 7469          correcti
+0000c9d0: 6f6e 5f66 6163 746f 725f 203d 2072 662e  on_factor_ = rf.
+0000c9e0: 6361 7374 2874 6f74 616c 5f6e 756d 5f65  cast(total_num_e
+0000c9f0: 6c2c 2073 6f75 7263 652e 6474 7970 6529  l, source.dtype)
+0000ca00: 202f 2072 662e 6361 7374 2861 6374 7561   / rf.cast(actua
+0000ca10: 6c5f 6e75 6d5f 656c 2c20 736f 7572 6365  l_num_el, source
+0000ca20: 2e64 7479 7065 290a 2020 2020 2020 2020  .dtype).        
+0000ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca40: 636f 7272 6563 7469 6f6e 5f66 6163 746f  correction_facto
+0000ca50: 725f 5f20 3d20 636f 7272 6563 7469 6f6e  r__ = correction
+0000ca60: 5f66 6163 746f 725f 2e63 6f70 795f 636f  _factor_.copy_co
+0000ca70: 6d70 6174 6962 6c65 5f74 6f5f 6469 6d73  mpatible_to_dims
+0000ca80: 5f72 6177 2872 6573 5f64 696d 7329 0a20  _raw(res_dims). 
+0000ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000caa0: 2020 2020 2020 2069 6620 636f 7272 6563         if correc
+0000cab0: 7469 6f6e 5f66 6163 746f 7220 6973 204e  tion_factor is N
+0000cac0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cae0: 2063 6f72 7265 6374 696f 6e5f 6661 6374   correction_fact
+0000caf0: 6f72 203d 2063 6f72 7265 6374 696f 6e5f  or = correction_
+0000cb00: 6661 6374 6f72 5f5f 0a20 2020 2020 2020  factor__.       
+0000cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb40: 2020 2063 6f72 7265 6374 696f 6e5f 6661     correction_fa
+0000cb50: 6374 6f72 202a 3d20 636f 7272 6563 7469  ctor *= correcti
+0000cb60: 6f6e 5f66 6163 746f 725f 5f0a 2020 2020  on_factor__.    
+0000cb70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000cb80: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000cb90: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+0000cba0: 6564 4572 726f 7228 6622 7265 6475 6365  edError(f"reduce
+0000cbb0: 5f7b 6d6f 6465 7d20 6e6f 7420 696d 706c  _{mode} not impl
+0000cbc0: 656d 656e 7465 6420 7769 7468 206d 6173  emented with mas
+0000cbd0: 6b69 6e67 206f 6e20 7465 6e73 6f72 207b  king on tensor {
+0000cbe0: 736f 7572 6365 2172 7d2e 2229 0a20 2020  source!r}.").   
+0000cbf0: 2020 2020 2020 2020 2066 6f72 2064 696d           for dim
+0000cc00: 2069 6e20 6178 6973 3a0a 2020 2020 2020   in axis:.      
+0000cc10: 2020 2020 2020 2020 2020 6966 2064 696d            if dim
+0000cc20: 2e6e 6565 645f 6d61 736b 696e 6728 293a  .need_masking():
+0000cc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cc40: 2020 2020 206d 6173 6b20 3d20 736f 7572       mask = sour
+0000cc50: 6365 2e67 6574 5f73 6571 7565 6e63 655f  ce.get_sequence_
+0000cc60: 6d61 736b 5f62 726f 6164 6361 7374 2864  mask_broadcast(d
+0000cc70: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
+0000cc80: 2020 2020 2020 2020 736f 7572 6365 2e72          source.r
+0000cc90: 6177 5f74 656e 736f 7220 3d20 746f 7263  aw_tensor = torc
+0000cca0: 682e 7768 6572 6528 6d61 736b 2c20 736f  h.where(mask, so
+0000ccb0: 7572 6365 2e72 6177 5f74 656e 736f 722c  urce.raw_tensor,
+0000ccc0: 206d 6173 6b5f 7661 6c75 6529 0a20 2020   mask_value).   
+0000ccd0: 2020 2020 2066 756e 6320 3d20 6765 7461       func = geta
+0000cce0: 7474 7228 746f 7263 682c 206d 6f64 6529  ttr(torch, mode)
+0000ccf0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000cd00: 7265 735f 6469 6d73 3a0a 2020 2020 2020  res_dims:.      
+0000cd10: 2020 2020 2020 7261 775f 7265 7375 6c74        raw_result
+0000cd20: 203d 2066 756e 6328 736f 7572 6365 2e72   = func(source.r
+0000cd30: 6177 5f74 656e 736f 7229 0a20 2020 2020  aw_tensor).     
+0000cd40: 2020 2065 6c69 6620 6c65 6e28 7261 775f     elif len(raw_
+0000cd50: 6469 6d73 2920 3d3d 2031 3a0a 2020 2020  dims) == 1:.    
+0000cd60: 2020 2020 2020 2020 7261 775f 7265 7375          raw_resu
+0000cd70: 6c74 203d 2066 756e 6328 736f 7572 6365  lt = func(source
+0000cd80: 2e72 6177 5f74 656e 736f 722c 2064 696d  .raw_tensor, dim
+0000cd90: 3d72 6177 5f64 696d 735b 305d 290a 2020  =raw_dims[0]).  
+0000cda0: 2020 2020 2020 2020 2020 6966 206d 6f64            if mod
+0000cdb0: 6520 696e 205b 226d 6178 222c 2022 6d69  e in ["max", "mi
+0000cdc0: 6e22 5d3a 0a20 2020 2020 2020 2020 2020  n"]:.           
+0000cdd0: 2020 2020 2023 2072 6573 756c 7420 6973       # result is
+0000cde0: 2061 2074 7570 6c65 2028 7661 6c75 6573   a tuple (values
+0000cdf0: 2c20 696e 6469 6365 7329 2e20 6874 7470  , indices). http
+0000ce00: 733a 2f2f 7079 746f 7263 682e 6f72 672f  s://pytorch.org/
+0000ce10: 646f 6373 2f73 7461 626c 652f 6765 6e65  docs/stable/gene
+0000ce20: 7261 7465 642f 746f 7263 682e 6d61 782e  rated/torch.max.
+0000ce30: 6874 6d6c 0a20 2020 2020 2020 2020 2020  html.           
+0000ce40: 2020 2020 2072 6177 5f72 6573 756c 742c       raw_result,
+0000ce50: 205f 203d 2072 6177 5f72 6573 756c 740a   _ = raw_result.
+0000ce60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000ce70: 2020 2020 2020 2020 2020 7261 775f 7265            raw_re
+0000ce80: 7375 6c74 203d 2066 756e 6328 736f 7572  sult = func(sour
+0000ce90: 6365 2e72 6177 5f74 656e 736f 722c 2064  ce.raw_tensor, d
+0000cea0: 696d 3d72 6177 5f64 696d 7329 0a20 2020  im=raw_dims).   
+0000ceb0: 2020 2020 2069 6620 636f 7272 6563 7469       if correcti
+0000cec0: 6f6e 5f66 6163 746f 7220 6973 206e 6f74  on_factor is not
+0000ced0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000cee0: 2020 2072 6177 5f72 6573 756c 7420 2a3d     raw_result *=
+0000cef0: 2063 6f72 7265 6374 696f 6e5f 6661 6374   correction_fact
+0000cf00: 6f72 2e74 6f28 7261 775f 7265 7375 6c74  or.to(raw_result
+0000cf10: 2e64 6576 6963 6529 0a20 2020 2020 2020  .device).       
+0000cf20: 2072 6573 203d 2054 656e 736f 7228 0a20   res = Tensor(. 
+0000cf30: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+0000cf40: 6622 7265 6475 6365 5f7b 6d6f 6465 7d22  f"reduce_{mode}"
+0000cf50: 2c0a 2020 2020 2020 2020 2020 2020 7261  ,.            ra
+0000cf60: 775f 7465 6e73 6f72 3d72 6177 5f72 6573  w_tensor=raw_res
+0000cf70: 756c 742c 0a20 2020 2020 2020 2020 2020  ult,.           
+0000cf80: 2064 696d 733d 7265 735f 6469 6d73 2c0a   dims=res_dims,.
+0000cf90: 2020 2020 2020 2020 2020 2020 6474 7970              dtyp
+0000cfa0: 653d 546f 7263 6842 6163 6b65 6e64 2e67  e=TorchBackend.g
+0000cfb0: 6574 5f64 7479 7065 5f6e 616d 655f 7261  et_dtype_name_ra
+0000cfc0: 7728 7261 775f 7265 7375 6c74 292c 0a20  w(raw_result),. 
+0000cfd0: 2020 2020 2020 2020 2020 2073 7061 7273             spars
+0000cfe0: 655f 6469 6d3d 6178 6973 5b30 5d20 6966  e_dim=axis[0] if
+0000cff0: 206d 6f64 652e 7374 6172 7473 7769 7468   mode.startswith
+0000d000: 2822 6172 6722 2920 656c 7365 2073 6f75  ("arg") else sou
+0000d010: 7263 652e 7370 6172 7365 5f64 696d 2c0a  rce.sparse_dim,.
+0000d020: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000d030: 2020 7265 7475 726e 2072 6573 0a0a 2020    return res..  
+0000d040: 2020 2320 6e6f 696e 7370 6563 7469 6f6e    # noinspection
+0000d050: 2050 7953 6861 646f 7769 6e67 4275 696c   PyShadowingBuil
+0000d060: 7469 6e73 0a20 2020 2040 7374 6174 6963  tins.    @static
+0000d070: 6d65 7468 6f64 0a20 2020 2064 6566 2074  method.    def t
+0000d080: 6f70 5f6b 280a 2020 2020 2020 2020 736f  op_k(.        so
+0000d090: 7572 6365 3a20 5465 6e73 6f72 5b74 6f72  urce: Tensor[tor
+0000d0a0: 6368 2e54 656e 736f 725d 2c0a 2020 2020  ch.Tensor],.    
+0000d0b0: 2020 2020 2a2c 0a20 2020 2020 2020 2061      *,.        a
+0000d0c0: 7869 733a 2055 6e69 6f6e 5b44 696d 2c20  xis: Union[Dim, 
+0000d0d0: 5365 7175 656e 6365 5b44 696d 5d5d 2c0a  Sequence[Dim]],.
+0000d0e0: 2020 2020 2020 2020 6b3a 2055 6e69 6f6e          k: Union
+0000d0f0: 5b69 6e74 2c20 5465 6e73 6f72 5d2c 0a20  [int, Tensor],. 
+0000d100: 2020 2020 2020 206b 5f64 696d 3a20 4f70         k_dim: Op
+0000d110: 7469 6f6e 616c 5b44 696d 5d20 3d20 4e6f  tional[Dim] = No
+0000d120: 6e65 2c0a 2020 2020 2020 2020 736f 7274  ne,.        sort
+0000d130: 6564 3a20 626f 6f6c 203d 2054 7275 652c  ed: bool = True,
+0000d140: 0a20 2020 2029 202d 3e20 5475 706c 655b  .    ) -> Tuple[
+0000d150: 5465 6e73 6f72 2c20 556e 696f 6e5b 5465  Tensor, Union[Te
+0000d160: 6e73 6f72 2c20 5365 7175 656e 6365 5b54  nsor, Sequence[T
+0000d170: 656e 736f 725d 5d2c 2044 696d 5d3a 0a20  ensor]], Dim]:. 
+0000d180: 2020 2020 2020 2022 2222 746f 705f 6b22         """top_k"
+0000d190: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0000d1a0: 7420 6b5f 6469 6d3a 0a20 2020 2020 2020  t k_dim:.       
+0000d1b0: 2020 2020 206b 5f64 696d 203d 2044 696d       k_dim = Dim
+0000d1c0: 286b 2c20 6e61 6d65 3d22 746f 702d 6b2d  (k, name="top-k-
+0000d1d0: 6469 6d22 290a 2020 2020 2020 2020 6178  dim").        ax
+0000d1e0: 6573 203d 205b 6178 6973 5d20 6966 2069  es = [axis] if i
+0000d1f0: 7369 6e73 7461 6e63 6528 6178 6973 2c20  sinstance(axis, 
+0000d200: 4469 6d29 2065 6c73 6520 6178 6973 0a20  Dim) else axis. 
+0000d210: 2020 2020 2020 2069 6620 616e 7928 612e         if any(a.
+0000d220: 6e65 6564 5f6d 6173 6b69 6e67 2829 2066  need_masking() f
+0000d230: 6f72 2061 2069 6e20 6178 6573 293a 0a20  or a in axes):. 
+0000d240: 2020 2020 2020 2020 2020 206d 6173 6b5f             mask_
+0000d250: 7661 6c75 6520 3d20 280a 2020 2020 2020  value = (.      
+0000d260: 2020 2020 2020 2020 2020 746f 7263 682e            torch.
+0000d270: 6669 6e66 6f28 736f 7572 6365 2e72 6177  finfo(source.raw
+0000d280: 5f74 656e 736f 722e 6474 7970 6529 2e6d  _tensor.dtype).m
+0000d290: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
+0000d2a0: 2020 2069 6620 736f 7572 6365 2e72 6177     if source.raw
+0000d2b0: 5f74 656e 736f 722e 6474 7970 652e 6973  _tensor.dtype.is
+0000d2c0: 5f66 6c6f 6174 696e 675f 706f 696e 740a  _floating_point.
+0000d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2e0: 656c 7365 2074 6f72 6368 2e69 696e 666f  else torch.iinfo
+0000d2f0: 2873 6f75 7263 652e 7261 775f 7465 6e73  (source.raw_tens
+0000d300: 6f72 2e64 7479 7065 292e 6d69 6e0a 2020  or.dtype).min.  
+0000d310: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000d320: 2020 2020 2020 2020 736f 7572 6365 203d          source =
+0000d330: 2073 6f75 7263 652e 636f 7079 2829 0a20   source.copy(). 
+0000d340: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+0000d350: 2069 6e20 6178 6573 3a0a 2020 2020 2020   in axes:.      
+0000d360: 2020 2020 2020 2020 2020 6966 2061 2e6e            if a.n
+0000d370: 6565 645f 6d61 736b 696e 6728 293a 0a20  eed_masking():. 
+0000d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d390: 2020 2073 6f75 7263 6520 3d20 7266 2e77     source = rf.w
+0000d3a0: 6865 7265 280a 2020 2020 2020 2020 2020  here(.          
+0000d3b0: 2020 2020 2020 2020 2020 2020 2020 612e                a.
+0000d3c0: 6765 745f 6d61 736b 2864 696d 5f6f 7264  get_mask(dim_ord
+0000d3d0: 6572 3d73 6f75 7263 652e 6469 6d73 2c20  er=source.dims, 
+0000d3e0: 6465 7669 6365 3d73 6f75 7263 652e 6465  device=source.de
+0000d3f0: 7669 6365 292c 0a20 2020 2020 2020 2020  vice),.         
+0000d400: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000d410: 6f75 7263 652c 0a20 2020 2020 2020 2020  ource,.         
+0000d420: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000d430: 6173 6b5f 7661 6c75 652c 0a20 2020 2020  ask_value,.     
+0000d440: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000d450: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0000d460: 7374 616e 6365 2861 7869 732c 2028 6c69  stance(axis, (li
+0000d470: 7374 2c20 7475 706c 6529 293a 0a20 2020  st, tuple)):.   
+0000d480: 2020 2020 2020 2020 2023 204d 6f76 6520           # Move 
+0000d490: 6178 6973 2074 6f20 7468 6520 656e 642c  axis to the end,
+0000d4a0: 2069 6e20 7468 6520 7269 6768 7420 6f72   in the right or
+0000d4b0: 6465 722e 0a20 2020 2020 2020 2020 2020  der..           
+0000d4c0: 2073 6f75 7263 6520 3d20 736f 7572 6365   source = source
+0000d4d0: 2e63 6f70 795f 7472 616e 7370 6f73 6528  .copy_transpose(
+0000d4e0: 5b64 2066 6f72 2064 2069 6e20 736f 7572  [d for d in sour
+0000d4f0: 6365 2e64 696d 7320 6966 2064 206e 6f74  ce.dims if d not
+0000d500: 2069 6e20 6178 6973 5d20 2b20 6c69 7374   in axis] + list
+0000d510: 2861 7869 7329 290a 2020 2020 2020 2020  (axis)).        
+0000d520: 2020 2020 736f 7572 6365 5f72 6177 5f66      source_raw_f
+0000d530: 6c61 7420 3d20 736f 7572 6365 2e72 6177  lat = source.raw
+0000d540: 5f74 656e 736f 722e 666c 6174 7465 6e28  _tensor.flatten(
+0000d550: 7374 6172 745f 6469 6d3d 736f 7572 6365  start_dim=source
+0000d560: 2e62 6174 6368 5f6e 6469 6d20 2d20 6c65  .batch_ndim - le
+0000d570: 6e28 6178 6973 2929 0a20 2020 2020 2020  n(axis)).       
+0000d580: 2020 2020 2076 616c 7565 735f 7261 772c       values_raw,
+0000d590: 2069 6e64 6963 6573 5f72 6177 203d 2074   indices_raw = t
+0000d5a0: 6f72 6368 2e74 6f70 6b28 0a20 2020 2020  orch.topk(.     
+0000d5b0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0000d5c0: 655f 7261 775f 666c 6174 2c20 6b3d 6b5f  e_raw_flat, k=k_
+0000d5d0: 6469 6d2e 6765 745f 6469 6d5f 7661 6c75  dim.get_dim_valu
+0000d5e0: 6528 292c 2064 696d 3d2d 312c 206c 6172  e(), dim=-1, lar
+0000d5f0: 6765 7374 3d54 7275 652c 2073 6f72 7465  gest=True, sorte
+0000d600: 643d 736f 7274 6564 0a20 2020 2020 2020  d=sorted.       
+0000d610: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000d620: 2020 2076 616c 7565 7320 3d20 736f 7572     values = sour
+0000d630: 6365 2e63 6f70 795f 7465 6d70 6c61 7465  ce.copy_template
+0000d640: 5f6e 6577 5f64 696d 5f74 6167 7328 0a20  _new_dim_tags(. 
+0000d650: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000d660: 6577 5f64 696d 5f74 6167 733d 736f 7572  ew_dim_tags=sour
+0000d670: 6365 2e64 696d 735b 3a20 2d6c 656e 2861  ce.dims[: -len(a
+0000d680: 7869 7329 5d20 2b20 286b 5f64 696d 2c29  xis)] + (k_dim,)
+0000d690: 2c20 6e61 6d65 3d22 746f 705f 6b5f 7661  , name="top_k_va
+0000d6a0: 6c75 6573 220a 2020 2020 2020 2020 2020  lues".          
+0000d6b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000d6c0: 6966 2073 6f75 7263 652e 6665 6174 7572  if source.featur
+0000d6d0: 655f 6469 6d20 616e 6420 736f 7572 6365  e_dim and source
+0000d6e0: 2e66 6561 7475 7265 5f64 696d 2069 6e20  .feature_dim in 
+0000d6f0: 7661 6c75 6573 2e64 696d 733a 0a20 2020  values.dims:.   
+0000d700: 2020 2020 2020 2020 2020 2020 2076 616c               val
+0000d710: 7565 732e 6665 6174 7572 655f 6469 6d20  ues.feature_dim 
+0000d720: 3d20 736f 7572 6365 2e66 6561 7475 7265  = source.feature
+0000d730: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
+0000d740: 2076 616c 7565 732e 7261 775f 7465 6e73   values.raw_tens
+0000d750: 6f72 203d 2076 616c 7565 735f 7261 770a  or = values_raw.
+0000d760: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+0000d770: 6365 735f 6f75 7420 3d20 5b5d 0a20 2020  ces_out = [].   
+0000d780: 2020 2020 2020 2020 2066 6f72 2069 2c20           for i, 
+0000d790: 6120 696e 2072 6576 6572 7365 6428 6c69  a in reversed(li
+0000d7a0: 7374 2865 6e75 6d65 7261 7465 2861 7869  st(enumerate(axi
+0000d7b0: 7329 2929 3a0a 2020 2020 2020 2020 2020  s))):.          
+0000d7c0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000d7d0: 6e73 7461 6e63 6528 612c 2044 696d 290a  nstance(a, Dim).
+0000d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7f0: 696e 6469 6365 735f 6f75 745f 7261 7720  indices_out_raw 
+0000d800: 3d20 696e 6469 6365 735f 7261 7720 2520  = indices_raw % 
+0000d810: 612e 6469 6d65 6e73 696f 6e0a 2020 2020  a.dimension.    
+0000d820: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+0000d830: 6365 735f 7261 7720 3d20 696e 6469 6365  ces_raw = indice
+0000d840: 735f 7261 7720 2f2f 2061 2e64 696d 656e  s_raw // a.dimen
+0000d850: 7369 6f6e 0a20 2020 2020 2020 2020 2020  sion.           
+0000d860: 2020 2020 2069 6e64 6963 6573 203d 2076       indices = v
+0000d870: 616c 7565 732e 636f 7079 5f74 656d 706c  alues.copy_templ
+0000d880: 6174 6528 6e61 6d65 3d66 2274 6f70 5f6b  ate(name=f"top_k
+0000d890: 5f69 6e64 6963 6573 5f7b 612e 6e61 6d65  _indices_{a.name
+0000d8a0: 206f 7220 697d 2229 0a20 2020 2020 2020   or i}").       
+0000d8b0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
+0000d8c0: 2e64 7479 7065 203d 2054 6f72 6368 4261  .dtype = TorchBa
+0000d8d0: 636b 656e 642e 6765 745f 6474 7970 655f  ckend.get_dtype_
+0000d8e0: 6e61 6d65 5f72 6177 2869 6e64 6963 6573  name_raw(indices
+0000d8f0: 5f6f 7574 5f72 6177 290a 2020 2020 2020  _out_raw).      
+0000d900: 2020 2020 2020 2020 2020 696e 6469 6365            indice
+0000d910: 732e 7370 6172 7365 5f64 696d 203d 2061  s.sparse_dim = a
+0000d920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d930: 2069 6e64 6963 6573 2e72 6177 5f74 656e   indices.raw_ten
+0000d940: 736f 7220 3d20 696e 6469 6365 735f 6f75  sor = indices_ou
+0000d950: 745f 7261 770a 2020 2020 2020 2020 2020  t_raw.          
+0000d960: 2020 2020 2020 696e 6469 6365 735f 6f75        indices_ou
+0000d970: 742e 696e 7365 7274 2830 2c20 696e 6469  t.insert(0, indi
+0000d980: 6365 7329 0a20 2020 2020 2020 2020 2020  ces).           
+0000d990: 2072 6574 7572 6e20 7661 6c75 6573 2c20   return values, 
+0000d9a0: 696e 6469 6365 735f 6f75 742c 206b 5f64  indices_out, k_d
+0000d9b0: 696d 0a20 2020 2020 2020 2061 7373 6572  im.        asser
+0000d9c0: 7420 6973 696e 7374 616e 6365 2861 7869  t isinstance(axi
+0000d9d0: 732c 2044 696d 290a 2020 2020 2020 2020  s, Dim).        
+0000d9e0: 6178 6973 5f69 6e74 203d 2073 6f75 7263  axis_int = sourc
+0000d9f0: 652e 6765 745f 6178 6973 5f66 726f 6d5f  e.get_axis_from_
+0000da00: 6465 7363 7269 7074 696f 6e28 6178 6973  description(axis
+0000da10: 2c20 616c 6c6f 775f 696e 743d 4661 6c73  , allow_int=Fals
+0000da20: 6529 0a20 2020 2020 2020 2076 616c 7565  e).        value
+0000da30: 735f 7261 772c 2069 6e64 6963 6573 5f72  s_raw, indices_r
+0000da40: 6177 203d 2074 6f72 6368 2e74 6f70 6b28  aw = torch.topk(
+0000da50: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0000da60: 7263 652e 7261 775f 7465 6e73 6f72 2c20  rce.raw_tensor, 
+0000da70: 6b3d 6b5f 6469 6d2e 6765 745f 6469 6d5f  k=k_dim.get_dim_
+0000da80: 7661 6c75 6528 292c 2064 696d 3d61 7869  value(), dim=axi
+0000da90: 735f 696e 742c 206c 6172 6765 7374 3d54  s_int, largest=T
+0000daa0: 7275 652c 2073 6f72 7465 643d 736f 7274  rue, sorted=sort
+0000dab0: 6564 0a20 2020 2020 2020 2029 0a20 2020  ed.        ).   
+0000dac0: 2020 2020 2076 616c 7565 7320 3d20 736f       values = so
+0000dad0: 7572 6365 2e63 6f70 795f 7465 6d70 6c61  urce.copy_templa
+0000dae0: 7465 5f72 6570 6c61 6365 5f64 696d 5f74  te_replace_dim_t
+0000daf0: 6167 2861 7869 733d 6178 6973 5f69 6e74  ag(axis=axis_int
+0000db00: 2c20 6e65 775f 6469 6d5f 7461 673d 6b5f  , new_dim_tag=k_
+0000db10: 6469 6d2c 206e 616d 653d 2274 6f70 5f6b  dim, name="top_k
+0000db20: 5f76 616c 7565 7322 290a 2020 2020 2020  _values").      
+0000db30: 2020 7661 6c75 6573 2e72 6177 5f74 656e    values.raw_ten
+0000db40: 736f 7220 3d20 7661 6c75 6573 5f72 6177  sor = values_raw
+0000db50: 0a20 2020 2020 2020 2069 6e64 6963 6573  .        indices
+0000db60: 203d 2073 6f75 7263 652e 636f 7079 5f74   = source.copy_t
+0000db70: 656d 706c 6174 655f 7265 706c 6163 655f  emplate_replace_
+0000db80: 6469 6d5f 7461 6728 6178 6973 3d61 7869  dim_tag(axis=axi
+0000db90: 735f 696e 742c 206e 6577 5f64 696d 5f74  s_int, new_dim_t
+0000dba0: 6167 3d6b 5f64 696d 2c20 6e61 6d65 3d22  ag=k_dim, name="
+0000dbb0: 746f 705f 6b5f 696e 6469 6365 7322 290a  top_k_indices").
+0000dbc0: 2020 2020 2020 2020 696e 6469 6365 732e          indices.
+0000dbd0: 6474 7970 6520 3d20 546f 7263 6842 6163  dtype = TorchBac
+0000dbe0: 6b65 6e64 2e67 6574 5f64 7479 7065 5f6e  kend.get_dtype_n
+0000dbf0: 616d 655f 7261 7728 696e 6469 6365 735f  ame_raw(indices_
+0000dc00: 7261 7729 0a20 2020 2020 2020 2069 6e64  raw).        ind
+0000dc10: 6963 6573 2e73 7061 7273 655f 6469 6d20  ices.sparse_dim 
+0000dc20: 3d20 6178 6973 0a20 2020 2020 2020 2069  = axis.        i
+0000dc30: 6e64 6963 6573 2e72 6177 5f74 656e 736f  ndices.raw_tenso
+0000dc40: 7220 3d20 696e 6469 6365 735f 7261 770a  r = indices_raw.
+0000dc50: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+0000dc60: 616c 7565 732c 2069 6e64 6963 6573 2c20  alues, indices, 
+0000dc70: 6b5f 6469 6d0a 0a20 2020 2040 7374 6174  k_dim..    @stat
+0000dc80: 6963 6d65 7468 6f64 0a20 2020 2040 636f  icmethod.    @co
+0000dc90: 6e74 6578 746c 6962 2e63 6f6e 7465 7874  ntextlib.context
+0000dca0: 6d61 6e61 6765 720a 2020 2020 6465 6620  manager.    def 
+0000dcb0: 7261 6e64 6f6d 5f6a 6f75 726e 616c 5f72  random_journal_r
+0000dcc0: 6563 6f72 6428 2920 2d3e 2047 656e 6572  ecord() -> Gener
+0000dcd0: 6174 6f72 5b5f 7261 6e64 6f6d 5f6a 6f75  ator[_random_jou
+0000dce0: 726e 616c 2e52 616e 646f 6d4a 6f75 726e  rnal.RandomJourn
+0000dcf0: 616c 5d3a 0a20 2020 2020 2020 2022 2222  al]:.        """
+0000dd00: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000dd10: 3a20 7468 6520 6a6f 7572 6e61 6c0a 2020  : the journal.  
+0000dd20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000dd30: 2020 7072 6576 5f6a 6f75 726e 616c 203d    prev_journal =
+0000dd40: 2054 6f72 6368 4261 636b 656e 642e 5f72   TorchBackend._r
+0000dd50: 616e 646f 6d5f 6a6f 7572 6e61 6c0a 2020  andom_journal.  
+0000dd60: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000dd70: 2020 2020 2020 2054 6f72 6368 4261 636b         TorchBack
+0000dd80: 656e 642e 5f72 616e 646f 6d5f 6a6f 7572  end._random_jour
+0000dd90: 6e61 6c20 3d20 5f72 616e 646f 6d5f 6a6f  nal = _random_jo
+0000dda0: 7572 6e61 6c2e 5261 6e64 6f6d 4a6f 7572  urnal.RandomJour
+0000ddb0: 6e61 6c28 290a 2020 2020 2020 2020 2020  nal().          
+0000ddc0: 2020 7969 656c 6420 546f 7263 6842 6163    yield TorchBac
+0000ddd0: 6b65 6e64 2e5f 7261 6e64 6f6d 5f6a 6f75  kend._random_jou
+0000dde0: 726e 616c 0a20 2020 2020 2020 2066 696e  rnal.        fin
+0000ddf0: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
+0000de00: 2020 546f 7263 6842 6163 6b65 6e64 2e5f    TorchBackend._
+0000de10: 7261 6e64 6f6d 5f6a 6f75 726e 616c 203d  random_journal =
+0000de20: 2070 7265 765f 6a6f 7572 6e61 6c0a 0a20   prev_journal.. 
+0000de30: 2020 205f 7261 6e64 6f6d 5f6a 6f75 726e     _random_journ
+0000de40: 616c 203d 204e 6f6e 6520 2023 2074 7970  al = None  # typ
+0000de50: 653a 204f 7074 696f 6e61 6c5b 5f72 616e  e: Optional[_ran
+0000de60: 646f 6d5f 6a6f 7572 6e61 6c2e 5261 6e64  dom_journal.Rand
+0000de70: 6f6d 4a6f 7572 6e61 6c5d 0a0a 2020 2020  omJournal]..    
+0000de80: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0000de90: 2020 6465 6620 7261 6e64 6f6d 280a 2020    def random(.  
+0000dea0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+0000deb0: 2064 696d 733a 2053 6571 7565 6e63 655b   dims: Sequence[
+0000dec0: 4469 6d5d 2c0a 2020 2020 2020 2020 6474  Dim],.        dt
+0000ded0: 7970 653a 2073 7472 2c0a 2020 2020 2020  ype: str,.      
+0000dee0: 2020 6465 7669 6365 3a20 4f70 7469 6f6e    device: Option
+0000def0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+0000df00: 2020 2020 2020 2020 7370 6172 7365 5f64          sparse_d
+0000df10: 696d 3a20 4f70 7469 6f6e 616c 5b44 696d  im: Optional[Dim
+0000df20: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000df30: 2020 6665 6174 7572 655f 6469 6d3a 204f    feature_dim: O
+0000df40: 7074 696f 6e61 6c5b 4469 6d5d 203d 204e  ptional[Dim] = N
+0000df50: 6f6e 652c 0a20 2020 2020 2020 2064 6973  one,.        dis
+0000df60: 7472 6962 7574 696f 6e3a 2073 7472 2c0a  tribution: str,.
+0000df70: 2020 2020 2020 2020 6d65 616e 3a20 4f70          mean: Op
+0000df80: 7469 6f6e 616c 5b55 6e69 6f6e 5b69 6e74  tional[Union[int
+0000df90: 2c20 666c 6f61 742c 2054 656e 736f 725d  , float, Tensor]
+0000dfa0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000dfb0: 2020 7374 6464 6576 3a20 4f70 7469 6f6e    stddev: Option
+0000dfc0: 616c 5b55 6e69 6f6e 5b69 6e74 2c20 666c  al[Union[int, fl
+0000dfd0: 6f61 742c 2054 656e 736f 725d 5d20 3d20  oat, Tensor]] = 
+0000dfe0: 4e6f 6e65 2c0a 2020 2020 2020 2020 626f  None,.        bo
+0000dff0: 756e 643a 204f 7074 696f 6e61 6c5b 556e  und: Optional[Un
+0000e000: 696f 6e5b 696e 742c 2066 6c6f 6174 2c20  ion[int, float, 
+0000e010: 5465 6e73 6f72 5d5d 203d 204e 6f6e 652c  Tensor]] = None,
+0000e020: 0a20 2020 2020 2020 206d 696e 7661 6c3a  .        minval:
+0000e030: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+0000e040: 696e 742c 2066 6c6f 6174 2c20 5465 6e73  int, float, Tens
+0000e050: 6f72 5d5d 203d 204e 6f6e 652c 0a20 2020  or]] = None,.   
+0000e060: 2020 2020 206d 6178 7661 6c3a 204f 7074       maxval: Opt
+0000e070: 696f 6e61 6c5b 556e 696f 6e5b 696e 742c  ional[Union[int,
+0000e080: 2066 6c6f 6174 2c20 5465 6e73 6f72 5d5d   float, Tensor]]
+0000e090: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000e0a0: 2073 6565 643a 204f 7074 696f 6e61 6c5b   seed: Optional[
+0000e0b0: 556e 696f 6e5b 696e 742c 2053 6571 7565  Union[int, Seque
+0000e0c0: 6e63 655b 696e 745d 2c20 6e75 6d70 792e  nce[int], numpy.
+0000e0d0: 6e64 6172 7261 795d 5d20 3d20 4e6f 6e65  ndarray]] = None
+0000e0e0: 2c0a 2020 2020 2020 2020 616c 676f 7269  ,.        algori
+0000e0f0: 7468 6d3a 204f 7074 696f 6e61 6c5b 7374  thm: Optional[st
+0000e100: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+0000e110: 2020 2065 7870 6c69 6369 745f 7374 6174     explicit_stat
+0000e120: 653a 204f 7074 696f 6e61 6c5b 5465 6e73  e: Optional[Tens
+0000e130: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000e140: 2020 2020 6175 746f 5f75 7064 6174 655f      auto_update_
+0000e150: 7374 6174 653a 204f 7074 696f 6e61 6c5b  state: Optional[
+0000e160: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000e170: 2020 2020 2020 7374 6174 6963 3a20 4f70        static: Op
+0000e180: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+0000e190: 6f6e 652c 0a20 2020 2020 2020 206f 7574  one,.        out
+0000e1a0: 3a20 4f70 7469 6f6e 616c 5b54 656e 736f  : Optional[Tenso
+0000e1b0: 725b 746f 7263 682e 5465 6e73 6f72 5d5d  r[torch.Tensor]]
+0000e1c0: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+0000e1d0: 3e20 5465 6e73 6f72 3a0a 2020 2020 2020  > Tensor:.      
+0000e1e0: 2020 2222 220a 2020 2020 2020 2020 7261    """.        ra
+0000e1f0: 6e64 6f6d 2e20 5365 6520 6072 662e 7261  ndom. See `rf.ra
+0000e200: 6e64 6f6d 6020 666f 7220 6465 7461 696c  ndom` for detail
+0000e210: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+0000e220: 2020 2020 2020 2073 6861 7065 203d 205b         shape = [
+0000e230: 642e 6765 745f 6469 6d5f 7661 6c75 6528  d.get_dim_value(
+0000e240: 2920 666f 7220 6420 696e 2064 696d 735d  ) for d in dims]
+0000e250: 0a20 2020 2020 2020 2064 7479 7065 5f20  .        dtype_ 
+0000e260: 3d20 546f 7263 6842 6163 6b65 6e64 2e61  = TorchBackend.a
+0000e270: 735f 6474 7970 655f 7261 7728 6474 7970  s_dtype_raw(dtyp
+0000e280: 6529 0a20 2020 2020 2020 2069 6620 6f75  e).        if ou
+0000e290: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
+0000e2a0: 2020 2020 2020 206f 7574 203d 2054 656e         out = Ten
+0000e2b0: 736f 7228 0a20 2020 2020 2020 2020 2020  sor(.           
+0000e2c0: 2020 2020 206e 616d 653d 6622 7261 6e64       name=f"rand
+0000e2d0: 6f6d 5f7b 6469 7374 7269 6275 7469 6f6e  om_{distribution
+0000e2e0: 7d22 2c20 6469 6d73 3d64 696d 732c 2064  }", dims=dims, d
+0000e2f0: 7479 7065 3d64 7479 7065 2c20 7370 6172  type=dtype, spar
+0000e300: 7365 5f64 696d 3d73 7061 7273 655f 6469  se_dim=sparse_di
+0000e310: 6d2c 2066 6561 7475 7265 5f64 696d 3d66  m, feature_dim=f
+0000e320: 6561 7475 7265 5f64 696d 0a20 2020 2020  eature_dim.     
+0000e330: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000e340: 2020 2020 206f 7574 2e72 6177 5f74 656e       out.raw_ten
+0000e350: 736f 7220 3d20 746f 7263 682e 656d 7074  sor = torch.empt
+0000e360: 7928 7368 6170 652c 2064 7479 7065 3d64  y(shape, dtype=d
+0000e370: 7479 7065 5f2c 2064 6576 6963 653d 6465  type_, device=de
+0000e380: 7669 6365 206f 7220 7266 2e67 6574 5f64  vice or rf.get_d
+0000e390: 6566 6175 6c74 5f64 6576 6963 6528 2929  efault_device())
+0000e3a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000e3b0: 6578 706c 6963 6974 5f73 7461 7465 2069  explicit_state i
+0000e3c0: 7320 4e6f 6e65 2020 2320 6e6f 7420 696d  s None  # not im
+0000e3d0: 706c 656d 656e 7465 6420 6f74 6865 7277  plemented otherw
+0000e3e0: 6973 650a 2020 2020 2020 2020 6765 6e65  ise.        gene
+0000e3f0: 7261 746f 7220 3d20 4e6f 6e65 2020 2320  rator = None  # 
+0000e400: 7573 696e 6720 7468 6520 676c 6f62 616c  using the global
+0000e410: 2064 6566 6175 6c74 2066 726f 6d20 5054   default from PT
+0000e420: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000e430: 6973 696e 7374 616e 6365 2873 7461 7469  isinstance(stati
+0000e440: 632c 2062 6f6f 6c29 0a20 2020 2020 2020  c, bool).       
+0000e450: 2069 6620 7374 6174 6963 3a0a 2020 2020   if static:.    
+0000e460: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0000e470: 6565 6420 6973 206e 6f74 204e 6f6e 650a  eed is not None.
+0000e480: 2020 2020 2020 2020 2020 2020 6765 6e65              gene
+0000e490: 7261 746f 7220 3d20 746f 7263 682e 4765  rator = torch.Ge
+0000e4a0: 6e65 7261 746f 7228 290a 2020 2020 2020  nerator().      
+0000e4b0: 2020 2020 2020 6765 6e65 7261 746f 722e        generator.
+0000e4c0: 6d61 6e75 616c 5f73 6565 6428 7365 6564  manual_seed(seed
+0000e4d0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000e4e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000e4f0: 7274 2073 6565 6420 6973 204e 6f6e 650a  rt seed is None.
+0000e500: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+0000e510: 7574 6f5f 7570 6461 7465 5f73 7461 7465  uto_update_state
+0000e520: 2069 7320 4e6f 6e65 2020 2320 6e6f 7420   is None  # not 
+0000e530: 696d 706c 656d 656e 7465 6420 6f74 6865  implemented othe
+0000e540: 7277 6973 650a 2020 2020 2020 2020 6966  rwise.        if
+0000e550: 2064 6973 7472 6962 7574 696f 6e20 3d3d   distribution ==
+0000e560: 2022 756e 6966 6f72 6d22 3a0a 2020 2020   "uniform":.    
+0000e570: 2020 2020 2020 2020 6173 7365 7274 206d          assert m
+0000e580: 6561 6e20 6973 204e 6f6e 6520 616e 6420  ean is None and 
+0000e590: 7374 6464 6576 2069 7320 4e6f 6e65 2020  stddev is None  
+0000e5a0: 2320 6e6f 7420 696d 706c 656d 656e 7465  # not implemente
+0000e5b0: 6420 6f74 6865 7277 6973 650a 2020 2020  d otherwise.    
+0000e5c0: 2020 2020 2020 2020 6966 2064 7479 7065          if dtype
+0000e5d0: 5f2e 6973 5f66 6c6f 6174 696e 675f 706f  _.is_floating_po
+0000e5e0: 696e 743a 0a20 2020 2020 2020 2020 2020  int:.           
+0000e5f0: 2020 2020 2069 6620 6d69 6e76 616c 2069       if minval i
+0000e600: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000e610: 2020 2020 2020 2020 2020 2020 6d69 6e76              minv
+0000e620: 616c 203d 2030 0a20 2020 2020 2020 2020  al = 0.         
+0000e630: 2020 2020 2020 2069 6620 6d61 7876 616c         if maxval
+0000e640: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000e650: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0000e660: 7876 616c 203d 2031 0a20 2020 2020 2020  xval = 1.       
+0000e670: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0000e680: 7374 616e 6365 286d 696e 7661 6c2c 2054  stance(minval, T
+0000e690: 656e 736f 7229 3a0a 2020 2020 2020 2020  ensor):.        
+0000e6a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000e6b0: 7274 206d 696e 7661 6c2e 6469 6d73 203d  rt minval.dims =
+0000e6c0: 3d20 2829 2c20 6622 6f6e 6c79 2073 6361  = (), f"only sca
+0000e6d0: 6c61 7220 6d69 6e76 616c 2073 7570 706f  lar minval suppo
+0000e6e0: 7274 6564 2c20 676f 7420 7b6d 696e 7661  rted, got {minva
+0000e6f0: 6c7d 220a 2020 2020 2020 2020 2020 2020  l}".            
+0000e700: 2020 2020 2020 2020 6d69 6e76 616c 203d          minval =
+0000e710: 206d 696e 7661 6c2e 7261 775f 7465 6e73   minval.raw_tens
+0000e720: 6f72 0a20 2020 2020 2020 2020 2020 2020  or.             
+0000e730: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000e740: 286d 6178 7661 6c2c 2054 656e 736f 7229  (maxval, Tensor)
+0000e750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e760: 2020 2020 2020 6173 7365 7274 206d 6178        assert max
+0000e770: 7661 6c2e 6469 6d73 203d 3d20 2829 2c20  val.dims == (), 
+0000e780: 6622 6f6e 6c79 2073 6361 6c61 7220 6d61  f"only scalar ma
+0000e790: 7876 616c 2073 7570 706f 7274 6564 2c20  xval supported, 
+0000e7a0: 676f 7420 7b6d 6178 7661 6c7d 220a 2020  got {maxval}".  
+0000e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e7c0: 2020 6d61 7876 616c 203d 206d 6178 7661    maxval = maxva
+0000e7d0: 6c2e 7261 775f 7465 6e73 6f72 0a20 2020  l.raw_tensor.   
+0000e7e0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+0000e7f0: 6820 746f 7263 682e 6e6f 5f67 7261 6428  h torch.no_grad(
+0000e800: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000e810: 2020 2020 2020 206f 7574 2e72 6177 5f74         out.raw_t
+0000e820: 656e 736f 722e 756e 6966 6f72 6d5f 286d  ensor.uniform_(m
+0000e830: 696e 7661 6c2c 206d 6178 7661 6c2c 2067  inval, maxval, g
+0000e840: 656e 6572 6174 6f72 3d67 656e 6572 6174  enerator=generat
+0000e850: 6f72 2920 2023 206e 6f71 610a 2020 2020  or)  # noqa.    
+0000e860: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000e870: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000e880: 206d 696e 7661 6c20 6973 204e 6f6e 653a   minval is None:
+0000e890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e8a0: 2020 2020 206d 696e 7661 6c20 3d20 300a       minval = 0.
+0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8c0: 6173 7365 7274 206d 6178 7661 6c20 6973  assert maxval is
+0000e8d0: 206e 6f74 204e 6f6e 652c 2022 6d61 7876   not None, "maxv
+0000e8e0: 616c 206d 7573 7420 6265 2073 7065 6369  al must be speci
+0000e8f0: 6669 6564 2066 6f72 2069 6e74 6567 6572  fied for integer
+0000e900: 2072 616e 646f 6d20 756e 6966 6f72 6d22   random uniform"
+0000e910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e920: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+0000e930: 696e 7661 6c2c 2054 656e 736f 7229 3a0a  inval, Tensor):.
+0000e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e950: 2020 2020 6173 7365 7274 206d 696e 7661      assert minva
+0000e960: 6c2e 6469 6d73 203d 3d20 2829 2c20 6622  l.dims == (), f"
+0000e970: 6f6e 6c79 2073 6361 6c61 7220 6d69 6e76  only scalar minv
+0000e980: 616c 2073 7570 706f 7274 6564 2c20 676f  al supported, go
+0000e990: 7420 7b6d 696e 7661 6c7d 220a 2020 2020  t {minval}".    
+0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9b0: 6d69 6e76 616c 203d 206d 696e 7661 6c2e  minval = minval.
+0000e9c0: 7261 775f 7465 6e73 6f72 0a20 2020 2020  raw_tensor.     
+0000e9d0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000e9e0: 696e 7374 616e 6365 286d 6178 7661 6c2c  instance(maxval,
+0000e9f0: 2054 656e 736f 7229 3a0a 2020 2020 2020   Tensor):.      
+0000ea00: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000ea10: 7365 7274 206d 6178 7661 6c2e 6469 6d73  sert maxval.dims
+0000ea20: 203d 3d20 2829 2c20 6622 6f6e 6c79 2073   == (), f"only s
+0000ea30: 6361 6c61 7220 6d61 7876 616c 2073 7570  calar maxval sup
+0000ea40: 706f 7274 6564 2c20 676f 7420 7b6d 6178  ported, got {max
+0000ea50: 7661 6c7d 220a 2020 2020 2020 2020 2020  val}".          
+0000ea60: 2020 2020 2020 2020 2020 6d61 7876 616c            maxval
+0000ea70: 203d 206d 6178 7661 6c2e 7261 775f 7465   = maxval.raw_te
+0000ea80: 6e73 6f72 0a20 2020 2020 2020 2020 2020  nsor.           
+0000ea90: 2020 2020 2077 6974 6820 746f 7263 682e       with torch.
+0000eaa0: 6e6f 5f67 7261 6428 293a 0a20 2020 2020  no_grad():.     
+0000eab0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000eac0: 7574 2e72 6177 5f74 656e 736f 722e 7261  ut.raw_tensor.ra
+0000ead0: 6e64 6f6d 5f28 6d69 6e76 616c 2c20 6d61  ndom_(minval, ma
+0000eae0: 7876 616c 2c20 6765 6e65 7261 746f 723d  xval, generator=
+0000eaf0: 6765 6e65 7261 746f 7229 0a20 2020 2020  generator).     
+0000eb00: 2020 2065 6c69 6620 6469 7374 7269 6275     elif distribu
+0000eb10: 7469 6f6e 203d 3d20 226e 6f72 6d61 6c22  tion == "normal"
+0000eb20: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0000eb30: 7365 7274 206d 696e 7661 6c20 6973 204e  sert minval is N
+0000eb40: 6f6e 6520 616e 6420 6d61 7876 616c 2069  one and maxval i
+0000eb50: 7320 4e6f 6e65 0a20 2020 2020 2020 2020  s None.         
+0000eb60: 2020 2069 6620 6d65 616e 2069 7320 4e6f     if mean is No
+0000eb70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000eb80: 2020 2020 6d65 616e 203d 2030 0a20 2020      mean = 0.   
+0000eb90: 2020 2020 2020 2020 2069 6620 7374 6464           if stdd
+0000eba0: 6576 2069 7320 4e6f 6e65 3a0a 2020 2020  ev is None:.    
+0000ebb0: 2020 2020 2020 2020 2020 2020 7374 6464              stdd
+0000ebc0: 6576 203d 2031 0a20 2020 2020 2020 2020  ev = 1.         
+0000ebd0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000ebe0: 286d 6561 6e2c 2054 656e 736f 7229 3a0a  (mean, Tensor):.
+0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec00: 6173 7365 7274 206d 6561 6e2e 6469 6d73  assert mean.dims
+0000ec10: 203d 3d20 2829 2c20 6622 6f6e 6c79 2073   == (), f"only s
+0000ec20: 6361 6c61 7220 6d65 616e 2073 7570 706f  calar mean suppo
+0000ec30: 7274 6564 2c20 676f 7420 7b6d 6561 6e7d  rted, got {mean}
+0000ec40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000ec50: 2020 6d65 616e 203d 206d 6561 6e2e 7261    mean = mean.ra
+0000ec60: 775f 7465 6e73 6f72 0a20 2020 2020 2020  w_tensor.       
+0000ec70: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000ec80: 6365 2873 7464 6465 762c 2054 656e 736f  ce(stddev, Tenso
+0000ec90: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0000eca0: 2020 2020 6173 7365 7274 2073 7464 6465      assert stdde
+0000ecb0: 762e 6469 6d73 203d 3d20 2829 2c20 6622  v.dims == (), f"
+0000ecc0: 6f6e 6c79 2073 6361 6c61 7220 7374 6464  only scalar stdd
+0000ecd0: 6576 2073 7570 706f 7274 6564 2c20 676f  ev supported, go
+0000ece0: 7420 7b73 7464 6465 767d 220a 2020 2020  t {stddev}".    
+0000ecf0: 2020 2020 2020 2020 2020 2020 7374 6464              stdd
+0000ed00: 6576 203d 2073 7464 6465 762e 7261 775f  ev = stddev.raw_
+0000ed10: 7465 6e73 6f72 0a20 2020 2020 2020 2020  tensor.         
+0000ed20: 2020 2077 6974 6820 746f 7263 682e 6e6f     with torch.no
+0000ed30: 5f67 7261 6428 293a 0a20 2020 2020 2020  _grad():.       
+0000ed40: 2020 2020 2020 2020 206f 7574 2e72 6177           out.raw
+0000ed50: 5f74 656e 736f 722e 6e6f 726d 616c 5f28  _tensor.normal_(
+0000ed60: 6d65 616e 2c20 7374 6464 6576 2c20 6765  mean, stddev, ge
+0000ed70: 6e65 7261 746f 723d 6765 6e65 7261 746f  nerator=generato
+0000ed80: 7229 0a20 2020 2020 2020 2065 6c69 6620  r).        elif 
+0000ed90: 6469 7374 7269 6275 7469 6f6e 203d 3d20  distribution == 
+0000eda0: 2274 7275 6e63 6174 6564 5f6e 6f72 6d61  "truncated_norma
+0000edb0: 6c22 3a0a 2020 2020 2020 2020 2020 2020  l":.            
+0000edc0: 6966 206d 6561 6e20 6973 204e 6f6e 653a  if mean is None:
+0000edd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ede0: 206d 6561 6e20 3d20 300a 2020 2020 2020   mean = 0.      
+0000edf0: 2020 2020 2020 6966 2073 7464 6465 7620        if stddev 
+0000ee00: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0000ee10: 2020 2020 2020 2020 2073 7464 6465 7620           stddev 
+0000ee20: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0000ee30: 6966 206d 696e 7661 6c20 6973 204e 6f6e  if minval is Non
+0000ee40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000ee50: 2020 206d 696e 7661 6c20 3d20 6d65 616e     minval = mean
+0000ee60: 202d 2032 202a 2073 7464 6465 760a 2020   - 2 * stddev.  
+0000ee70: 2020 2020 2020 2020 2020 6966 206d 6178            if max
+0000ee80: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
+0000ee90: 2020 2020 2020 2020 2020 2020 206d 6178               max
+0000eea0: 7661 6c20 3d20 6d65 616e 202b 2032 202a  val = mean + 2 *
+0000eeb0: 2073 7464 6465 760a 0a20 2020 2020 2020   stddev..       
+0000eec0: 2020 2020 2066 726f 6d20 2e20 696d 706f       from . impo
+0000eed0: 7274 205f 7261 6e64 0a0a 2020 2020 2020  rt _rand..      
+0000eee0: 2020 2020 2020 5f72 616e 642e 6e6f 5f67        _rand.no_g
+0000eef0: 7261 645f 7472 756e 635f 6e6f 726d 616c  rad_trunc_normal
+0000ef00: 5f28 6f75 742e 7261 775f 7465 6e73 6f72  _(out.raw_tensor
+0000ef10: 2c20 6d65 616e 3d6d 6561 6e2c 2073 7464  , mean=mean, std
+0000ef20: 3d73 7464 6465 762c 2061 3d6d 696e 7661  =stddev, a=minva
+0000ef30: 6c2c 2062 3d6d 6178 7661 6c2c 2067 656e  l, b=maxval, gen
+0000ef40: 6572 6174 6f72 3d67 656e 6572 6174 6f72  erator=generator
+0000ef50: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000ef60: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000ef70: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
+0000ef80: 4572 726f 7228 6622 7261 6e64 6f6d 2064  Error(f"random d
+0000ef90: 6973 7472 6962 7574 696f 6e20 7b64 6973  istribution {dis
+0000efa0: 7472 6962 7574 696f 6e7d 206e 6f74 2069  tribution} not i
+0000efb0: 6d70 6c65 6d65 6e74 6564 2229 0a20 2020  mplemented").   
+0000efc0: 2020 2020 2069 6620 546f 7263 6842 6163       if TorchBac
+0000efd0: 6b65 6e64 2e5f 7261 6e64 6f6d 5f6a 6f75  kend._random_jou
+0000efe0: 726e 616c 3a0a 2020 2020 2020 2020 2020  rnal:.          
+0000eff0: 2020 6f75 745f 203d 206f 7574 2e63 6f70    out_ = out.cop
+0000f000: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0000f010: 6f75 745f 2e72 6177 5f74 656e 736f 7220  out_.raw_tensor 
+0000f020: 3d20 6f75 745f 2e72 6177 5f74 656e 736f  = out_.raw_tenso
+0000f030: 722e 6465 7461 6368 2829 2e63 7075 2829  r.detach().cpu()
+0000f040: 2e6e 756d 7079 2829 0a20 2020 2020 2020  .numpy().       
+0000f050: 2020 2020 2054 6f72 6368 4261 636b 656e       TorchBacken
+0000f060: 642e 5f72 616e 646f 6d5f 6a6f 7572 6e61  d._random_journa
+0000f070: 6c2e 6170 7065 6e64 280a 2020 2020 2020  l.append(.      
+0000f080: 2020 2020 2020 2020 2020 6469 7374 7269            distri
+0000f090: 6275 7469 6f6e 3d64 6973 7472 6962 7574  bution=distribut
+0000f0a0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+0000f0b0: 2020 2020 206d 6561 6e3d 6d65 616e 2c0a       mean=mean,.
+0000f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0d0: 7374 6464 6576 3d73 7464 6465 762c 0a20  stddev=stddev,. 
+0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000f0f0: 6f75 6e64 3d62 6f75 6e64 2c0a 2020 2020  ound=bound,.    
+0000f100: 2020 2020 2020 2020 2020 2020 6d69 6e76              minv
+0000f110: 616c 3d6d 696e 7661 6c2c 0a20 2020 2020  al=minval,.     
+0000f120: 2020 2020 2020 2020 2020 206d 6178 7661             maxva
+0000f130: 6c3d 6d61 7876 616c 2c0a 2020 2020 2020  l=maxval,.      
+0000f140: 2020 2020 2020 2020 2020 7365 6564 3d73            seed=s
+0000f150: 6565 642c 0a20 2020 2020 2020 2020 2020  eed,.           
+0000f160: 2020 2020 2073 7461 7469 633d 7374 6174       static=stat
+0000f170: 6963 2c0a 2020 2020 2020 2020 2020 2020  ic,.            
+0000f180: 2020 2020 6f75 743d 6f75 745f 2c0a 2020      out=out_,.  
+0000f190: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000f1a0: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
+0000f1b0: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0000f1c0: 640a 2020 2020 6465 6620 6d61 736b 6564  d.    def masked
+0000f1d0: 5f73 656c 6563 7428 0a20 2020 2020 2020  _select(.       
+0000f1e0: 2074 656e 736f 723a 2054 656e 736f 722c   tensor: Tensor,
+0000f1f0: 202a 2c20 6d61 736b 3a20 5465 6e73 6f72   *, mask: Tensor
+0000f200: 2c20 6469 6d73 3a20 5365 7175 656e 6365  , dims: Sequence
+0000f210: 5b44 696d 5d2c 206f 7574 5f64 696d 3a20  [Dim], out_dim: 
+0000f220: 4f70 7469 6f6e 616c 5b44 696d 5d20 3d20  Optional[Dim] = 
+0000f230: 4e6f 6e65 0a20 2020 2029 202d 3e20 5475  None.    ) -> Tu
+0000f240: 706c 655b 5465 6e73 6f72 2c20 4469 6d5d  ple[Tensor, Dim]
+0000f250: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000f260: 2020 2020 2020 3a70 6172 616d 2074 656e        :param ten
+0000f270: 736f 723a 0a20 2020 2020 2020 203a 7061  sor:.        :pa
+0000f280: 7261 6d20 6d61 736b 3a0a 2020 2020 2020  ram mask:.      
+0000f290: 2020 3a70 6172 616d 2064 696d 733a 2074    :param dims: t
+0000f2a0: 6865 206f 7264 6572 206f 6620 7468 6520  he order of the 
+0000f2b0: 6469 6d73 2064 6566 696e 6573 2074 6865  dims defines the
+0000f2c0: 2066 6f72 6d61 742e 2074 686f 7365 2064   format. those d
+0000f2d0: 696d 7320 7368 6f75 6c64 2062 6520 6578  ims should be ex
+0000f2e0: 6163 746c 7920 7468 6520 6469 6d73 206f  actly the dims o
+0000f2f0: 6620 7468 6520 6d61 736b 2e0a 2020 2020  f the mask..    
+0000f300: 2020 2020 3a70 6172 616d 206f 7574 5f64      :param out_d
+0000f310: 696d 3a0a 2020 2020 2020 2020 3a72 6574  im:.        :ret
+0000f320: 7572 6e3a 2074 656e 736f 7220 7768 6572  urn: tensor wher
+0000f330: 6520 616c 6c20 6469 6d73 2069 6e20 6d61  e all dims in ma
+0000f340: 736b 2f64 696d 7320 6172 6520 7265 6d6f  sk/dims are remo
+0000f350: 7665 6420 616e 6420 7265 706c 6163 6564  ved and replaced
+0000f360: 2062 7920 6120 6e65 7720 6469 6d2e 0a20   by a new dim.. 
+0000f370: 2020 2020 2020 2020 2020 2074 6865 206e             the n
+0000f380: 6577 2064 696d 2069 7320 616c 736f 2072  ew dim is also r
+0000f390: 6574 7572 6e65 642e 0a20 2020 2020 2020  eturned..       
+0000f3a0: 2020 2020 2069 6620 6d61 736b 3d3d 5472       if mask==Tr
+0000f3b0: 7565 2066 6f72 2061 6c6c 2065 6c65 6d65  ue for all eleme
+0000f3c0: 6e74 732c 2074 6865 2072 6574 7572 6e65  nts, the returne
+0000f3d0: 6420 7465 6e73 6f72 2077 6f75 6c64 2062  d tensor would b
+0000f3e0: 6520 7369 6d70 6c79 2074 6865 2066 6c61  e simply the fla
+0000f3f0: 7474 656e 6564 2069 6e70 7574 2074 656e  ttened input ten
+0000f400: 736f 722e 0a20 2020 2020 2020 2022 2222  sor..        """
+0000f410: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000f420: 6d61 736b 2e64 7479 7065 203d 3d20 2262  mask.dtype == "b
+0000f430: 6f6f 6c22 0a20 2020 2020 2020 2061 7373  ool".        ass
+0000f440: 6572 7420 7365 7428 6d61 736b 2e64 696d  ert set(mask.dim
+0000f450: 7329 203d 3d20 7365 7428 6469 6d73 290a  s) == set(dims).
+0000f460: 2020 2020 2020 2020 7265 6d61 696e 696e          remainin
+0000f470: 675f 6469 6d73 203d 205b 6420 666f 7220  g_dims = [d for 
+0000f480: 6420 696e 2074 656e 736f 722e 6469 6d73  d in tensor.dims
+0000f490: 2069 6620 6420 6e6f 7420 696e 206d 6173   if d not in mas
+0000f4a0: 6b2e 6469 6d73 5d0a 2020 2020 2020 2020  k.dims].        
+0000f4b0: 7465 6e73 6f72 5f74 656d 706c 5f64 696d  tensor_templ_dim
+0000f4c0: 7320 3d20 7475 706c 6528 6469 6d73 2920  s = tuple(dims) 
+0000f4d0: 2b20 7475 706c 6528 7265 6d61 696e 696e  + tuple(remainin
+0000f4e0: 675f 6469 6d73 290a 2020 2020 2020 2020  g_dims).        
+0000f4f0: 696e 5f72 6177 203d 2074 656e 736f 722e  in_raw = tensor.
+0000f500: 636f 7079 5f63 6f6d 7061 7469 626c 655f  copy_compatible_
+0000f510: 746f 5f64 696d 735f 7261 7728 7465 6e73  to_dims_raw(tens
+0000f520: 6f72 5f74 656d 706c 5f64 696d 7329 0a20  or_templ_dims). 
+0000f530: 2020 2020 2020 206d 6173 6b5f 7261 7720         mask_raw 
+0000f540: 3d20 6d61 736b 2e63 6f70 795f 636f 6d70  = mask.copy_comp
+0000f550: 6174 6962 6c65 5f74 6f5f 6469 6d73 5f72  atible_to_dims_r
+0000f560: 6177 2874 656e 736f 725f 7465 6d70 6c5f  aw(tensor_templ_
+0000f570: 6469 6d73 290a 2020 2020 2020 2020 2320  dims).        # 
+0000f580: 5765 2068 6176 6520 6120 7665 7279 2073  We have a very s
+0000f590: 7472 616e 6765 2070 726f 626c 656d 2077  trange problem w
+0000f5a0: 6974 6820 7468 6520 6772 6164 6965 6e74  ith the gradient
+0000f5b0: 206f 6620 6d61 736b 6564 5f73 656c 6563   of masked_selec
+0000f5c0: 742c 0a20 2020 2020 2020 2023 2077 6865  t,.        # whe
+0000f5d0: 6e20 7573 6564 2074 6f67 6574 6865 7220  n used together 
+0000f5e0: 7769 7468 2073 6f6d 6520 7370 6563 6966  with some specif
+0000f5f0: 6963 206f 7468 6572 206f 7065 7261 7469  ic other operati
+0000f600: 6f6e 7320 6265 666f 7265 2074 6861 742c  ons before that,
+0000f610: 0a20 2020 2020 2020 2023 206c 696b 6520  .        # like 
+0000f620: 636f 6e76 6f6c 7574 696f 6e2e 0a20 2020  convolution..   
+0000f630: 2020 2020 2023 2054 6869 7320 636c 6f6e       # This clon
+0000f640: 6528 2920 7769 7468 2063 6f6e 7469 6775  e() with contigu
+0000f650: 6f75 735f 666f 726d 6174 2073 6565 6d73  ous_format seems
+0000f660: 2074 6f20 6669 7820 7468 6520 7072 6f62   to fix the prob
+0000f670: 6c65 6d2e 0a20 2020 2020 2020 2023 2068  lem..        # h
+0000f680: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+0000f690: 6d2f 7079 746f 7263 682f 7079 746f 7263  m/pytorch/pytorc
+0000f6a0: 682f 6973 7375 6573 2f39 3936 3338 0a20  h/issues/99638. 
+0000f6b0: 2020 2020 2020 2069 6e5f 7261 7720 3d20         in_raw = 
+0000f6c0: 696e 5f72 6177 2e63 6c6f 6e65 286d 656d  in_raw.clone(mem
+0000f6d0: 6f72 795f 666f 726d 6174 3d74 6f72 6368  ory_format=torch
+0000f6e0: 2e63 6f6e 7469 6775 6f75 735f 666f 726d  .contiguous_form
+0000f6f0: 6174 290a 2020 2020 2020 2020 6966 206d  at).        if m
+0000f700: 6173 6b5f 7261 772e 6465 7669 6365 2e74  ask_raw.device.t
+0000f710: 7970 6520 3d3d 2022 6d65 7461 223a 0a20  ype == "meta":. 
+0000f720: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+0000f730: 7320 6973 206e 6f74 2073 7570 706f 7274  s is not support
+0000f740: 6564 2c20 6275 7420 616c 736f 2c20 7765  ed, but also, we
+0000f750: 2077 6f75 6c64 2061 6e79 7761 7920 6e6f   would anyway no
+0000f760: 7420 6b6e 6f77 2074 6865 206f 7574 2073  t know the out s
+0000f770: 6861 7065 2e0a 2020 2020 2020 2020 2020  hape..          
+0000f780: 2020 2320 486f 7765 7665 722c 2069 6e73    # However, ins
+0000f790: 7465 6164 206f 6620 6572 726f 7269 6e67  tead of erroring
+0000f7a0: 2c20 6a75 7374 2061 7373 756d 6520 736f  , just assume so
+0000f7b0: 6d65 2064 756d 6d79 206d 6173 6b2e 0a20  me dummy mask.. 
+0000f7c0: 2020 2020 2020 2020 2020 2023 2068 7474             # htt
+0000f7d0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+0000f7e0: 7079 746f 7263 682f 7079 746f 7263 682f  pytorch/pytorch/
+0000f7f0: 6973 7375 6573 2f31 3039 3837 310a 2020  issues/109871.  
+0000f800: 2020 2020 2020 2020 2020 6f75 745f 7261            out_ra
+0000f810: 7720 3d20 696e 5f72 6177 2e66 6c61 7474  w = in_raw.flatt
+0000f820: 656e 2829 0a20 2020 2020 2020 2065 6c73  en().        els
+0000f830: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
+0000f840: 7574 5f72 6177 203d 2074 6f72 6368 2e6d  ut_raw = torch.m
+0000f850: 6173 6b65 645f 7365 6c65 6374 2869 6e5f  asked_select(in_
+0000f860: 7261 772c 206d 6173 6b5f 7261 7729 0a20  raw, mask_raw). 
+0000f870: 2020 2020 2020 2072 656d 6169 6e69 6e67         remaining
+0000f880: 5f73 6861 7065 203d 205b 642e 6765 745f  _shape = [d.get_
+0000f890: 6469 6d5f 7661 6c75 6528 2920 666f 7220  dim_value() for 
+0000f8a0: 6420 696e 2072 656d 6169 6e69 6e67 5f64  d in remaining_d
+0000f8b0: 696d 735d 0a20 2020 2020 2020 2072 656d  ims].        rem
+0000f8c0: 6169 6e69 6e67 5f6e 756d 5f65 6c65 6d65  aining_num_eleme
+0000f8d0: 6e74 7320 3d20 6e75 6d70 792e 7072 6f64  nts = numpy.prod
+0000f8e0: 2872 656d 6169 6e69 6e67 5f73 6861 7065  (remaining_shape
+0000f8f0: 2920 6966 2072 656d 6169 6e69 6e67 5f73  ) if remaining_s
+0000f900: 6861 7065 2065 6c73 6520 310a 2020 2020  hape else 1.    
+0000f910: 2020 2020 6173 7365 7274 206f 7574 5f72      assert out_r
+0000f920: 6177 2e6e 756d 656c 2829 2025 2072 656d  aw.numel() % rem
+0000f930: 6169 6e69 6e67 5f6e 756d 5f65 6c65 6d65  aining_num_eleme
+0000f940: 6e74 7320 3d3d 2030 0a20 2020 2020 2020  nts == 0.       
+0000f950: 2066 6c61 7474 656e 6564 5f6e 756d 5f65   flattened_num_e
+0000f960: 6c65 6d65 6e74 7320 3d20 6f75 745f 7261  lements = out_ra
+0000f970: 772e 6e75 6d65 6c28 2920 2f2f 2072 656d  w.numel() // rem
+0000f980: 6169 6e69 6e67 5f6e 756d 5f65 6c65 6d65  aining_num_eleme
+0000f990: 6e74 730a 2020 2020 2020 2020 6f75 745f  nts.        out_
+0000f9a0: 7261 7720 3d20 746f 7263 682e 7265 7368  raw = torch.resh
+0000f9b0: 6170 6528 6f75 745f 7261 772c 205b 666c  ape(out_raw, [fl
+0000f9c0: 6174 7465 6e65 645f 6e75 6d5f 656c 656d  attened_num_elem
+0000f9d0: 656e 7473 5d20 2b20 7265 6d61 696e 696e  ents] + remainin
+0000f9e0: 675f 7368 6170 6529 0a20 2020 2020 2020  g_shape).       
+0000f9f0: 2069 6620 6e6f 7420 6f75 745f 6469 6d3a   if not out_dim:
+0000fa00: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000fa10: 5f64 696d 203d 2044 696d 284e 6f6e 652c  _dim = Dim(None,
+0000fa20: 206e 616d 653d 226d 6173 6b65 645f 7365   name="masked_se
+0000fa30: 6c65 6374 2229 0a20 2020 2020 2020 2069  lect").        i
+0000fa40: 6620 6e6f 7420 6f75 745f 6469 6d2e 6479  f not out_dim.dy
+0000fa50: 6e5f 7369 7a65 5f65 7874 3a0a 2020 2020  n_size_ext:.    
+0000fa60: 2020 2020 2020 2020 6f75 745f 6469 6d2e          out_dim.
+0000fa70: 6479 6e5f 7369 7a65 5f65 7874 203d 2054  dyn_size_ext = T
+0000fa80: 656e 736f 7228 226d 6173 6b65 645f 7365  ensor("masked_se
+0000fa90: 6c65 6374 5f73 697a 6522 2c20 6469 6d73  lect_size", dims
+0000faa0: 3d28 292c 2064 7479 7065 3d22 696e 7436  =(), dtype="int6
+0000fab0: 3422 290a 2020 2020 2020 2020 6966 206f  4").        if o
+0000fac0: 7574 5f64 696d 2e64 796e 5f73 697a 655f  ut_dim.dyn_size_
+0000fad0: 6578 742e 7261 775f 7465 6e73 6f72 2069  ext.raw_tensor i
+0000fae0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000faf0: 2020 2020 6f75 745f 6469 6d2e 6479 6e5f      out_dim.dyn_
+0000fb00: 7369 7a65 5f65 7874 2e72 6177 5f74 656e  size_ext.raw_ten
+0000fb10: 736f 7220 3d20 746f 7263 682e 7465 6e73  sor = torch.tens
+0000fb20: 6f72 2866 6c61 7474 656e 6564 5f6e 756d  or(flattened_num
+0000fb30: 5f65 6c65 6d65 6e74 732c 2064 7479 7065  _elements, dtype
+0000fb40: 3d74 6f72 6368 2e69 6e74 3634 290a 2020  =torch.int64).  
+0000fb50: 2020 2020 2020 6f75 7420 3d20 5465 6e73        out = Tens
+0000fb60: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000fb70: 226d 6173 6b65 645f 7365 6c65 6374 222c  "masked_select",
+0000fb80: 0a20 2020 2020 2020 2020 2020 2064 696d  .            dim
+0000fb90: 733d 286f 7574 5f64 696d 2c29 202b 2074  s=(out_dim,) + t
+0000fba0: 7570 6c65 2872 656d 6169 6e69 6e67 5f64  uple(remaining_d
+0000fbb0: 696d 7329 2c0a 2020 2020 2020 2020 2020  ims),.          
+0000fbc0: 2020 6474 7970 653d 7465 6e73 6f72 2e64    dtype=tensor.d
+0000fbd0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0000fbe0: 2020 7370 6172 7365 5f64 696d 3d74 656e    sparse_dim=ten
+0000fbf0: 736f 722e 7370 6172 7365 5f64 696d 2c0a  sor.sparse_dim,.
+0000fc00: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
+0000fc10: 7465 6e73 6f72 3d6f 7574 5f72 6177 2c0a  tensor=out_raw,.
+0000fc20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000fc30: 2020 7265 7475 726e 206f 7574 2c20 6f75    return out, ou
+0000fc40: 745f 6469 6d0a 0a20 2020 2040 7374 6174  t_dim..    @stat
+0000fc50: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+0000fc60: 206d 6173 6b65 645f 7363 6174 7465 7228   masked_scatter(
+0000fc70: 736f 7572 6365 3a20 5465 6e73 6f72 2c20  source: Tensor, 
+0000fc80: 2a2c 206d 6173 6b3a 2054 656e 736f 722c  *, mask: Tensor,
+0000fc90: 2064 696d 733a 2053 6571 7565 6e63 655b   dims: Sequence[
+0000fca0: 4469 6d5d 2c20 696e 5f64 696d 3a20 4469  Dim], in_dim: Di
+0000fcb0: 6d29 202d 3e20 5465 6e73 6f72 3a0a 2020  m) -> Tensor:.  
+0000fcc0: 2020 2020 2020 2222 226d 6173 6b65 6420        """masked 
+0000fcd0: 7363 6174 7465 7222 2222 0a20 2020 2020  scatter""".     
+0000fce0: 2020 2061 7373 6572 7420 6d61 736b 2e64     assert mask.d
+0000fcf0: 7479 7065 203d 3d20 2262 6f6f 6c22 0a20  type == "bool". 
+0000fd00: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+0000fd10: 7428 6d61 736b 2e64 696d 7329 203d 3d20  t(mask.dims) == 
+0000fd20: 7365 7428 6469 6d73 290a 2020 2020 2020  set(dims).      
+0000fd30: 2020 6173 7365 7274 2069 6e5f 6469 6d20    assert in_dim 
+0000fd40: 696e 2073 6f75 7263 652e 6469 6d73 0a20  in source.dims. 
+0000fd50: 2020 2020 2020 2072 656d 6169 6e69 6e67         remaining
+0000fd60: 5f64 696d 7320 3d20 5b64 2066 6f72 2064  _dims = [d for d
+0000fd70: 2069 6e20 736f 7572 6365 2e64 696d 7320   in source.dims 
+0000fd80: 6966 2064 206e 6f74 2069 6e20 6d61 736b  if d not in mask
+0000fd90: 2e64 696d 7320 616e 6420 6420 213d 2069  .dims and d != i
+0000fda0: 6e5f 6469 6d5d 0a20 2020 2020 2020 2073  n_dim].        s
+0000fdb0: 6f75 7263 655f 7465 6d70 6c5f 6469 6d73  ource_templ_dims
+0000fdc0: 203d 2028 696e 5f64 696d 2c29 202b 2074   = (in_dim,) + t
+0000fdd0: 7570 6c65 2872 656d 6169 6e69 6e67 5f64  uple(remaining_d
+0000fde0: 696d 7329 0a20 2020 2020 2020 2074 656e  ims).        ten
+0000fdf0: 736f 725f 7465 6d70 6c5f 6469 6d73 203d  sor_templ_dims =
+0000fe00: 2074 7570 6c65 2864 696d 7329 202b 2074   tuple(dims) + t
+0000fe10: 7570 6c65 2872 656d 6169 6e69 6e67 5f64  uple(remaining_d
+0000fe20: 696d 7329 0a20 2020 2020 2020 2073 6f75  ims).        sou
+0000fe30: 7263 655f 7261 7720 3d20 736f 7572 6365  rce_raw = source
+0000fe40: 2e63 6f70 795f 636f 6d70 6174 6962 6c65  .copy_compatible
+0000fe50: 5f74 6f5f 6469 6d73 5f72 6177 2873 6f75  _to_dims_raw(sou
+0000fe60: 7263 655f 7465 6d70 6c5f 6469 6d73 290a  rce_templ_dims).
+0000fe70: 2020 2020 2020 2020 6d61 736b 5f72 6177          mask_raw
+0000fe80: 203d 206d 6173 6b2e 636f 7079 5f63 6f6d   = mask.copy_com
+0000fe90: 7061 7469 626c 655f 746f 5f64 696d 735f  patible_to_dims_
+0000fea0: 7261 7728 7465 6e73 6f72 5f74 656d 706c  raw(tensor_templ
+0000feb0: 5f64 696d 7329 0a20 2020 2020 2020 206f  _dims).        o
+0000fec0: 7574 5f73 6861 7065 203d 205b 642e 6765  ut_shape = [d.ge
+0000fed0: 745f 6469 6d5f 7661 6c75 6528 2920 666f  t_dim_value() fo
+0000fee0: 7220 6420 696e 2074 656e 736f 725f 7465  r d in tensor_te
+0000fef0: 6d70 6c5f 6469 6d73 5d0a 2020 2020 2020  mpl_dims].      
+0000ff00: 2020 6f75 745f 7261 7720 3d20 746f 7263    out_raw = torc
+0000ff10: 682e 7a65 726f 7328 6f75 745f 7368 6170  h.zeros(out_shap
+0000ff20: 652c 2064 7479 7065 3d73 6f75 7263 655f  e, dtype=source_
+0000ff30: 7261 772e 6474 7970 652c 2064 6576 6963  raw.dtype, devic
+0000ff40: 653d 736f 7572 6365 5f72 6177 2e64 6576  e=source_raw.dev
+0000ff50: 6963 6529 0a20 2020 2020 2020 206f 7574  ice).        out
+0000ff60: 5f72 6177 2e6d 6173 6b65 645f 7363 6174  _raw.masked_scat
+0000ff70: 7465 725f 286d 6173 6b5f 7261 772c 2073  ter_(mask_raw, s
+0000ff80: 6f75 7263 655f 7261 7729 0a20 2020 2020  ource_raw).     
+0000ff90: 2020 2072 6574 7572 6e20 5465 6e73 6f72     return Tensor
+0000ffa0: 280a 2020 2020 2020 2020 2020 2020 226d  (.            "m
+0000ffb0: 6173 6b65 645f 7363 6174 7465 7222 2c0a  asked_scatter",.
+0000ffc0: 2020 2020 2020 2020 2020 2020 6469 6d73              dims
+0000ffd0: 3d74 656e 736f 725f 7465 6d70 6c5f 6469  =tensor_templ_di
+0000ffe0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+0000fff0: 6474 7970 653d 736f 7572 6365 2e64 7479  dtype=source.dty
+00010000: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+00010010: 7370 6172 7365 5f64 696d 3d73 6f75 7263  sparse_dim=sourc
+00010020: 652e 7370 6172 7365 5f64 696d 2c0a 2020  e.sparse_dim,.  
+00010030: 2020 2020 2020 2020 2020 7261 775f 7465            raw_te
+00010040: 6e73 6f72 3d6f 7574 5f72 6177 2c0a 2020  nsor=out_raw,.  
+00010050: 2020 2020 2020 290a 0a20 2020 2040 7374        )..    @st
+00010060: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00010070: 6566 2062 6174 6368 5f6e 6f72 6d28 0a20  ef batch_norm(. 
+00010080: 2020 2020 2020 2073 6f75 7263 653a 2054         source: T
+00010090: 656e 736f 725b 746f 7263 682e 5465 6e73  ensor[torch.Tens
+000100a0: 6f72 5d2c 0a20 2020 2020 2020 202a 2c0a  or],.        *,.
+000100b0: 2020 2020 2020 2020 696e 5f64 696d 3a20          in_dim: 
+000100c0: 556e 696f 6e5b 4469 6d2c 2053 6571 7565  Union[Dim, Seque
+000100d0: 6e63 655b 4469 6d5d 5d2c 0a20 2020 2020  nce[Dim]],.     
+000100e0: 2020 2072 756e 6e69 6e67 5f6d 6561 6e3a     running_mean:
+000100f0: 204f 7074 696f 6e61 6c5b 5465 6e73 6f72   Optional[Tensor
+00010100: 5d2c 0a20 2020 2020 2020 2072 756e 6e69  ],.        runni
+00010110: 6e67 5f76 6172 6961 6e63 653a 204f 7074  ng_variance: Opt
+00010120: 696f 6e61 6c5b 5465 6e73 6f72 5d2c 0a20  ional[Tensor],. 
+00010130: 2020 2020 2020 2067 616d 6d61 3a20 4f70         gamma: Op
+00010140: 7469 6f6e 616c 5b54 656e 736f 725d 2c0a  tional[Tensor],.
+00010150: 2020 2020 2020 2020 6265 7461 3a20 4f70          beta: Op
+00010160: 7469 6f6e 616c 5b54 656e 736f 725d 2c0a  tional[Tensor],.
+00010170: 2020 2020 2020 2020 6570 7369 6c6f 6e3a          epsilon:
+00010180: 2066 6c6f 6174 2c0a 2020 2020 2020 2020   float,.        
+00010190: 6d6f 6d65 6e74 756d 3a20 666c 6f61 742c  momentum: float,
+000101a0: 0a20 2020 2020 2020 2061 6666 696e 653a  .        affine:
+000101b0: 2062 6f6f 6c2c 0a20 2020 2020 2020 2075   bool,.        u
+000101c0: 7365 5f6d 6173 6b3a 2062 6f6f 6c2c 0a20  se_mask: bool,. 
+000101d0: 2020 2029 202d 3e20 5465 6e73 6f72 3a0a     ) -> Tensor:.
+000101e0: 2020 2020 2020 2020 2222 2262 6174 6368          """batch
+000101f0: 206e 6f72 6d22 2222 0a20 2020 2020 2020   norm""".       
+00010200: 2069 6620 7573 655f 6d61 736b 3a0a 2020   if use_mask:.  
+00010210: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00010220: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
+00010230: 726f 7228 2262 6174 6368 5f6e 6f72 6d20  ror("batch_norm 
+00010240: 7769 7468 206d 6173 6b69 6e67 206e 6f74  with masking not
+00010250: 2069 6d70 6c65 6d65 6e74 6564 2229 0a20   implemented"). 
+00010260: 2020 2020 2020 2069 6620 2872 756e 6e69         if (runni
+00010270: 6e67 5f6d 6561 6e20 6973 204e 6f6e 6529  ng_mean is None)
+00010280: 2021 3d20 2872 756e 6e69 6e67 5f76 6172   != (running_var
+00010290: 6961 6e63 6520 6973 204e 6f6e 6529 3a0a  iance is None):.
+000102a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000102b0: 6520 5661 6c75 6545 7272 6f72 2822 7275  e ValueError("ru
+000102c0: 6e6e 696e 675f 6d65 616e 2061 6e64 2072  nning_mean and r
+000102d0: 756e 6e69 6e67 5f76 6172 6961 6e63 6520  unning_variance 
+000102e0: 6d75 7374 2062 6520 626f 7468 204e 6f6e  must be both Non
+000102f0: 6520 6f72 2062 6f74 6820 6e6f 7420 4e6f  e or both not No
+00010300: 6e65 2229 0a20 2020 2020 2020 2061 7373  ne").        ass
+00010310: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
+00010320: 6e5f 6469 6d2c 2044 696d 2920 2023 206d  n_dim, Dim)  # m
+00010330: 756c 7469 706c 6520 6469 6d73 206e 6f74  ultiple dims not
+00010340: 2073 7570 706f 7274 6564 2079 6574 0a20   supported yet. 
+00010350: 2020 2020 2020 2069 6620 6166 6669 6e65         if affine
+00010360: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00010370: 2067 616d 6d61 2069 7320 4e6f 6e65 206f   gamma is None o
+00010380: 7220 6265 7461 2069 7320 4e6f 6e65 3a0a  r beta is None:.
+00010390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103a0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000103b0: 2822 6761 6d6d 6120 616e 6420 6265 7461  ("gamma and beta
+000103c0: 206d 7573 7420 6265 2067 6976 656e 2069   must be given i
+000103d0: 6620 6166 6669 6e65 3d54 7275 6522 290a  f affine=True").
+000103e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000103f0: 6f74 2067 616d 6d61 2e64 696d 7320 3d3d  ot gamma.dims ==
+00010400: 2062 6574 612e 6469 6d73 203d 3d20 2869   beta.dims == (i
+00010410: 6e5f 6469 6d2c 293a 0a20 2020 2020 2020  n_dim,):.       
+00010420: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00010430: 616c 7565 4572 726f 7228 6622 6761 6d6d  alueError(f"gamm
+00010440: 6120 616e 6420 6265 7461 206d 7573 7420  a and beta must 
+00010450: 6861 7665 2073 6861 7065 205b 7b69 6e5f  have shape [{in_
+00010460: 6469 6d7d 5d2c 2067 6f74 2067 616d 6d61  dim}], got gamma
+00010470: 207b 6761 6d6d 617d 2061 6e64 2062 6574   {gamma} and bet
+00010480: 6120 7b62 6574 617d 2229 0a20 2020 2020  a {beta}").     
+00010490: 2020 2069 6620 7275 6e6e 696e 675f 6d65     if running_me
+000104a0: 616e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  an is not None:.
+000104b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000104c0: 6f74 2072 756e 6e69 6e67 5f6d 6561 6e2e  ot running_mean.
+000104d0: 6469 6d73 203d 3d20 7275 6e6e 696e 675f  dims == running_
+000104e0: 7661 7269 616e 6365 2e64 696d 7320 3d3d  variance.dims ==
+000104f0: 2028 696e 5f64 696d 2c29 3a0a 2020 2020   (in_dim,):.    
+00010500: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00010510: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+00010520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010530: 2020 6622 7275 6e6e 696e 675f 6d65 616e    f"running_mean
+00010540: 2061 6e64 2072 756e 6e69 6e67 5f76 6172   and running_var
+00010550: 6961 6e63 6520 6d75 7374 2068 6176 6520  iance must have 
+00010560: 7368 6170 6520 5b7b 696e 5f64 696d 7d5d  shape [{in_dim}]
+00010570: 2c20 676f 7420 220a 2020 2020 2020 2020  , got ".        
+00010580: 2020 2020 2020 2020 2020 2020 6622 7275              f"ru
+00010590: 6e6e 696e 675f 6d65 616e 207b 7275 6e6e  nning_mean {runn
+000105a0: 696e 675f 6d65 616e 7d20 616e 6420 7275  ing_mean} and ru
+000105b0: 6e6e 696e 675f 7661 7269 616e 6365 207b  nning_variance {
+000105c0: 7275 6e6e 696e 675f 7661 7269 616e 6365  running_variance
+000105d0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+000105e0: 2020 2029 0a20 2020 2020 2020 2066 6561     ).        fea
+000105f0: 745f 6178 6973 203d 2073 6f75 7263 652e  t_axis = source.
+00010600: 6765 745f 6178 6973 5f66 726f 6d5f 6465  get_axis_from_de
+00010610: 7363 7269 7074 696f 6e28 696e 5f64 696d  scription(in_dim
+00010620: 290a 2020 2020 2020 2020 6966 2066 6561  ).        if fea
+00010630: 745f 6178 6973 203d 3d20 303a 0a20 2020  t_axis == 0:.   
+00010640: 2020 2020 2020 2020 2070 7265 5f64 696d           pre_dim
+00010650: 7320 3d20 310a 2020 2020 2020 2020 656c  s = 1.        el
+00010660: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00010670: 7072 655f 6469 6d73 203d 206e 756d 7079  pre_dims = numpy
+00010680: 2e70 726f 6428 736f 7572 6365 2e72 6177  .prod(source.raw
+00010690: 5f74 656e 736f 722e 7368 6170 655b 3a66  _tensor.shape[:f
+000106a0: 6561 745f 6178 6973 5d29 0a20 2020 2020  eat_axis]).     
+000106b0: 2020 2023 2054 6f72 6368 2062 6174 6368     # Torch batch
+000106c0: 5f6e 6f72 6d20 6578 7065 6374 7320 284e  _norm expects (N
+000106d0: 2c43 2c2b 2920 6173 2073 6861 7065 2e0a  ,C,+) as shape..
+000106e0: 2020 2020 2020 2020 7372 635f 7261 7720          src_raw 
+000106f0: 3d20 746f 7263 682e 7265 7368 6170 6528  = torch.reshape(
+00010700: 736f 7572 6365 2e72 6177 5f74 656e 736f  source.raw_tenso
+00010710: 722c 205b 7072 655f 6469 6d73 2c20 696e  r, [pre_dims, in
+00010720: 5f64 696d 2e67 6574 5f64 696d 5f76 616c  _dim.get_dim_val
+00010730: 7565 2829 2c20 2d31 5d29 0a20 2020 2020  ue(), -1]).     
+00010740: 2020 2023 2068 7474 7073 3a2f 2f67 6974     # https://git
+00010750: 6875 622e 636f 6d2f 7079 746f 7263 682f  hub.com/pytorch/
+00010760: 7079 746f 7263 682f 626c 6f62 2f35 3936  pytorch/blob/596
+00010770: 3035 3831 3134 3838 6562 3037 6233 6238  05811488eb07b3b8
+00010780: 6266 3730 6135 6630 6234 6235 3662 3334  bf70a5f0b4b56b34
+00010790: 6234 6136 312f 6174 656e 2f73 7263 2f41  b4a61/aten/src/A
+000107a0: 5465 6e2f 6e61 7469 7665 2f4e 6f72 6d61  Ten/native/Norma
+000107b0: 6c69 7a61 7469 6f6e 2e63 7070 234c 3534  lization.cpp#L54
+000107c0: 360a 2020 2020 2020 2020 6f75 745f 7261  6.        out_ra
+000107d0: 7720 3d20 746f 7263 682e 6e6e 2e66 756e  w = torch.nn.fun
+000107e0: 6374 696f 6e61 6c2e 6261 7463 685f 6e6f  ctional.batch_no
+000107f0: 726d 280a 2020 2020 2020 2020 2020 2020  rm(.            
+00010800: 7372 635f 7261 772c 0a20 2020 2020 2020  src_raw,.       
+00010810: 2020 2020 2072 756e 6e69 6e67 5f6d 6561       running_mea
+00010820: 6e3d 7275 6e6e 696e 675f 6d65 616e 2e72  n=running_mean.r
+00010830: 6177 5f74 656e 736f 7220 6966 2072 756e  aw_tensor if run
+00010840: 6e69 6e67 5f6d 6561 6e20 6973 206e 6f74  ning_mean is not
+00010850: 204e 6f6e 6520 656c 7365 204e 6f6e 652c   None else None,
+00010860: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+00010870: 6e69 6e67 5f76 6172 3d72 756e 6e69 6e67  ning_var=running
+00010880: 5f76 6172 6961 6e63 652e 7261 775f 7465  _variance.raw_te
+00010890: 6e73 6f72 2069 6620 7275 6e6e 696e 675f  nsor if running_
+000108a0: 7661 7269 616e 6365 2069 7320 6e6f 7420  variance is not 
+000108b0: 4e6f 6e65 2065 6c73 6520 4e6f 6e65 2c0a  None else None,.
+000108c0: 2020 2020 2020 2020 2020 2020 7765 6967              weig
+000108d0: 6874 3d67 616d 6d61 2e72 6177 5f74 656e  ht=gamma.raw_ten
+000108e0: 736f 7220 6966 2061 6666 696e 6520 656c  sor if affine el
+000108f0: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
+00010900: 2020 2020 2062 6961 733d 6265 7461 2e72       bias=beta.r
+00010910: 6177 5f74 656e 736f 7220 6966 2061 6666  aw_tensor if aff
+00010920: 696e 6520 656c 7365 204e 6f6e 652c 0a20  ine else None,. 
+00010930: 2020 2020 2020 2020 2020 2023 2074 7261             # tra
+00010940: 696e 696e 673a 206d 6561 6e73 2077 6865  ining: means whe
+00010950: 7468 6572 2077 6520 7368 6f75 6c64 2075  ther we should u
+00010960: 7365 2074 6865 2063 7572 7265 6e74 2062  se the current b
+00010970: 6174 6368 2073 7461 7469 7374 6963 730a  atch statistics.
+00010980: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00010990: 2b20 7570 6461 7465 2074 6865 2072 756e  + update the run
+000109a0: 6e69 6e67 2073 7461 7469 7374 6963 7320  ning statistics 
+000109b0: 2869 6620 6769 7665 6e29 0a20 2020 2020  (if given).     
+000109c0: 2020 2020 2020 2074 7261 696e 696e 673d         training=
+000109d0: 7266 2e67 6574 5f72 756e 5f63 7478 2829  rf.get_run_ctx()
+000109e0: 2e74 7261 696e 5f66 6c61 6720 6f72 2028  .train_flag or (
+000109f0: 7275 6e6e 696e 675f 6d65 616e 2069 7320  running_mean is 
+00010a00: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+00010a10: 2020 206d 6f6d 656e 7475 6d3d 6d6f 6d65     momentum=mome
+00010a20: 6e74 756d 2c0a 2020 2020 2020 2020 2020  ntum,.          
+00010a30: 2020 6570 733d 6570 7369 6c6f 6e2c 0a20    eps=epsilon,. 
+00010a40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010a50: 206f 7574 203d 2073 6f75 7263 652e 636f   out = source.co
+00010a60: 7079 5f74 656d 706c 6174 6528 290a 2020  py_template().  
+00010a70: 2020 2020 2020 6f75 742e 7261 775f 7465        out.raw_te
+00010a80: 6e73 6f72 203d 2074 6f72 6368 2e72 6573  nsor = torch.res
+00010a90: 6861 7065 286f 7574 5f72 6177 2c20 736f  hape(out_raw, so
+00010aa0: 7572 6365 2e72 6177 5f74 656e 736f 722e  urce.raw_tensor.
+00010ab0: 7368 6170 6529 0a20 2020 2020 2020 206f  shape).        o
+00010ac0: 7574 2e66 6561 7475 7265 5f64 696d 203d  ut.feature_dim =
+00010ad0: 2069 6e5f 6469 6d0a 2020 2020 2020 2020   in_dim.        
+00010ae0: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
+00010af0: 2320 6e6f 696e 7370 6563 7469 6f6e 2050  # noinspection P
+00010b00: 7953 6861 646f 7769 6e67 4275 696c 7469  yShadowingBuilti
+00010b10: 6e73 0a20 2020 2040 7374 6174 6963 6d65  ns.    @staticme
+00010b20: 7468 6f64 0a20 2020 2064 6566 2063 6f6e  thod.    def con
+00010b30: 7628 0a20 2020 2020 2020 2073 6f75 7263  v(.        sourc
+00010b40: 653a 2054 656e 736f 722c 0a20 2020 2020  e: Tensor,.     
+00010b50: 2020 202a 2c0a 2020 2020 2020 2020 696e     *,.        in
+00010b60: 5f64 696d 3a20 4469 6d2c 0a20 2020 2020  _dim: Dim,.     
+00010b70: 2020 206f 7574 5f64 696d 3a20 4469 6d2c     out_dim: Dim,
+00010b80: 0a20 2020 2020 2020 2069 6e5f 7370 6174  .        in_spat
+00010b90: 6961 6c5f 6469 6d73 3a20 5365 7175 656e  ial_dims: Sequen
+00010ba0: 6365 5b44 696d 5d2c 0a20 2020 2020 2020  ce[Dim],.       
+00010bb0: 206f 7574 5f73 7061 7469 616c 5f64 696d   out_spatial_dim
+00010bc0: 733a 204f 7074 696f 6e61 6c5b 5365 7175  s: Optional[Sequ
+00010bd0: 656e 6365 5b44 696d 5d5d 203d 204e 6f6e  ence[Dim]] = Non
+00010be0: 652c 0a20 2020 2020 2020 2066 696c 7465  e,.        filte
+00010bf0: 723a 2054 656e 736f 722c 0a20 2020 2020  r: Tensor,.     
+00010c00: 2020 2066 696c 7465 725f 7369 7a65 3a20     filter_size: 
+00010c10: 5365 7175 656e 6365 5b44 696d 5d2c 2020  Sequence[Dim],  
+00010c20: 2320 746f 2068 6176 6520 7468 6520 6f72  # to have the or
+00010c30: 6465 7220 7765 6c6c 2d64 6566 696e 6564  der well-defined
+00010c40: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
+00010c50: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
+00010c60: 7472 6964 6573 3a20 4f70 7469 6f6e 616c  trides: Optional
+00010c70: 5b55 6e69 6f6e 5b69 6e74 2c20 5365 7175  [Union[int, Sequ
+00010c80: 656e 6365 5b69 6e74 5d5d 5d20 3d20 4e6f  ence[int]]] = No
+00010c90: 6e65 2c0a 2020 2020 2020 2020 6469 6c61  ne,.        dila
+00010ca0: 7469 6f6e 5f72 6174 653a 204f 7074 696f  tion_rate: Optio
+00010cb0: 6e61 6c5b 556e 696f 6e5b 696e 742c 2053  nal[Union[int, S
+00010cc0: 6571 7565 6e63 655b 696e 745d 5d5d 203d  equence[int]]] =
+00010cd0: 204e 6f6e 652c 0a20 2020 2020 2020 2067   None,.        g
+00010ce0: 726f 7570 733a 204f 7074 696f 6e61 6c5b  roups: Optional[
+00010cf0: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
+00010d00: 2020 2020 2062 6961 733a 204f 7074 696f       bias: Optio
+00010d10: 6e61 6c5b 5465 6e73 6f72 5d20 3d20 4e6f  nal[Tensor] = No
+00010d20: 6e65 2c0a 2020 2020 2920 2d3e 2054 7570  ne,.    ) -> Tup
+00010d30: 6c65 5b54 656e 736f 722c 2053 6571 7565  le[Tensor, Seque
+00010d40: 6e63 655b 4469 6d5d 5d3a 0a20 2020 2020  nce[Dim]]:.     
+00010d50: 2020 2022 2222 636f 6e76 2222 220a 2020     """conv""".  
+00010d60: 2020 2020 2020 6966 206e 6f74 206f 7574        if not out
+00010d70: 5f73 7061 7469 616c 5f64 696d 733a 0a20  _spatial_dims:. 
+00010d80: 2020 2020 2020 2020 2020 206f 7574 5f73             out_s
+00010d90: 7061 7469 616c 5f64 696d 7320 3d20 7266  patial_dims = rf
+00010da0: 2e6d 616b 655f 636f 6e76 5f6f 7574 5f73  .make_conv_out_s
+00010db0: 7061 7469 616c 5f64 696d 7328 0a20 2020  patial_dims(.   
+00010dc0: 2020 2020 2020 2020 2020 2020 2069 6e5f               in_
+00010dd0: 7370 6174 6961 6c5f 6469 6d73 3d69 6e5f  spatial_dims=in_
+00010de0: 7370 6174 6961 6c5f 6469 6d73 2c0a 2020  spatial_dims,.  
+00010df0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00010e00: 6c74 6572 5f73 697a 653d 5b64 2e64 696d  lter_size=[d.dim
+00010e10: 656e 7369 6f6e 2066 6f72 2064 2069 6e20  ension for d in 
+00010e20: 6669 6c74 6572 5f73 697a 655d 2c0a 2020  filter_size],.  
+00010e30: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00010e40: 7269 6465 733d 7374 7269 6465 7320 6f72  rides=strides or
+00010e50: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+00010e60: 2020 2020 6469 6c61 7469 6f6e 5f72 6174      dilation_rat
+00010e70: 653d 6469 6c61 7469 6f6e 5f72 6174 6520  e=dilation_rate 
+00010e80: 6f72 2031 2c0a 2020 2020 2020 2020 2020  or 1,.          
+00010e90: 2020 2020 2020 7061 6464 696e 673d 7061        padding=pa
+00010ea0: 6464 696e 672c 0a20 2020 2020 2020 2020  dding,.         
+00010eb0: 2020 2029 0a20 2020 2020 2020 2066 696c     ).        fil
+00010ec0: 7465 725f 696e 5f64 696d 203d 2069 6e5f  ter_in_dim = in_
+00010ed0: 6469 6d20 6966 206e 6f74 2067 726f 7570  dim if not group
+00010ee0: 7320 6f72 2067 726f 7570 7320 3d3d 2031  s or groups == 1
+00010ef0: 2065 6c73 6520 696e 5f64 696d 202f 2f20   else in_dim // 
+00010f00: 6772 6f75 7073 0a20 2020 2020 2020 2066  groups.        f
+00010f10: 696c 7465 725f 6469 6d73 203d 2028 6f75  ilter_dims = (ou
+00010f20: 745f 6469 6d2c 2066 696c 7465 725f 696e  t_dim, filter_in
+00010f30: 5f64 696d 2920 2b20 7475 706c 6528 6669  _dim) + tuple(fi
+00010f40: 6c74 6572 5f73 697a 6529 0a20 2020 2020  lter_size).     
+00010f50: 2020 2066 696c 7465 7220 3d20 6669 6c74     filter = filt
+00010f60: 6572 2e63 6f70 795f 7472 616e 7370 6f73  er.copy_transpos
+00010f70: 6528 6669 6c74 6572 5f64 696d 7329 0a20  e(filter_dims). 
+00010f80: 2020 2020 2020 2062 6174 6368 5f64 696d         batch_dim
+00010f90: 7320 3d20 5b64 2066 6f72 2064 2069 6e20  s = [d for d in 
+00010fa0: 736f 7572 6365 2e64 696d 7320 6966 2064  source.dims if d
+00010fb0: 206e 6f74 2069 6e20 2869 6e5f 6469 6d2c   not in (in_dim,
+00010fc0: 2920 2b20 7475 706c 6528 696e 5f73 7061  ) + tuple(in_spa
+00010fd0: 7469 616c 5f64 696d 7329 5d0a 2020 2020  tial_dims)].    
+00010fe0: 2020 2020 2320 546f 7263 6820 636f 6e76      # Torch conv
+00010ff0: 2065 7870 6563 7473 2028 4e2c 432c 3c73   expects (N,C,<s
+00011000: 7061 7469 616c 2064 696d 733e 2920 6173  patial dims>) as
+00011010: 2073 6861 7065 2e0a 2020 2020 2020 2020   shape..        
+00011020: 736f 7572 6365 203d 2073 6f75 7263 652e  source = source.
+00011030: 636f 7079 5f74 7261 6e73 706f 7365 2862  copy_transpose(b
+00011040: 6174 6368 5f64 696d 7320 2b20 5b69 6e5f  atch_dims + [in_
+00011050: 6469 6d5d 202b 206c 6973 7428 696e 5f73  dim] + list(in_s
+00011060: 7061 7469 616c 5f64 696d 7329 290a 2020  patial_dims)).  
+00011070: 2020 2020 2020 6966 206c 656e 2862 6174        if len(bat
+00011080: 6368 5f64 696d 7329 203d 3d20 313a 0a20  ch_dims) == 1:. 
+00011090: 2020 2020 2020 2020 2020 2073 7263 5f72             src_r
+000110a0: 6177 203d 2073 6f75 7263 652e 7261 775f  aw = source.raw_
+000110b0: 7465 6e73 6f72 0a20 2020 2020 2020 2065  tensor.        e
+000110c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000110d0: 2073 7263 5f72 6177 203d 2074 6f72 6368   src_raw = torch
+000110e0: 2e72 6573 6861 7065 280a 2020 2020 2020  .reshape(.      
+000110f0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00011100: 2e72 6177 5f74 656e 736f 722c 0a20 2020  .raw_tensor,.   
+00011110: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+00011120: 6f74 656e 7469 616c 6c79 206d 6572 6765  otentially merge
+00011130: 2062 6174 6368 2064 696d 7320 616c 6c20   batch dims all 
+00011140: 746f 6765 7468 6572 0a20 2020 2020 2020  together.       
+00011150: 2020 2020 2020 2020 205b 2d31 2c20 696e           [-1, in
+00011160: 5f64 696d 2e67 6574 5f64 696d 5f76 616c  _dim.get_dim_val
+00011170: 7565 2829 5d20 2b20 5b64 2e67 6574 5f64  ue()] + [d.get_d
+00011180: 696d 5f76 616c 7565 2829 2066 6f72 2064  im_value() for d
+00011190: 2069 6e20 696e 5f73 7061 7469 616c 5f64   in in_spatial_d
+000111a0: 696d 735d 2c0a 2020 2020 2020 2020 2020  ims],.          
+000111b0: 2020 290a 2020 2020 2020 2020 7573 655f    ).        use_
+000111c0: 7374 7269 6469 6e67 203d 2073 7472 6964  striding = strid
+000111d0: 6573 2061 6e64 2028 7374 7269 6465 7320  es and (strides 
+000111e0: 3e20 3120 6966 2069 7369 6e73 7461 6e63  > 1 if isinstanc
+000111f0: 6528 7374 7269 6465 732c 2069 6e74 2920  e(strides, int) 
+00011200: 656c 7365 2061 6e79 2873 203e 2031 2066  else any(s > 1 f
+00011210: 6f72 2073 2069 6e20 7374 7269 6465 7329  or s in strides)
+00011220: 290a 2020 2020 2020 2020 6966 2070 6164  ).        if pad
+00011230: 6469 6e67 203d 3d20 2273 616d 6522 2061  ding == "same" a
+00011240: 6e64 206e 6f74 2075 7365 5f73 7472 6964  nd not use_strid
+00011250: 696e 6720 616e 6420 616c 6c28 642e 6469  ing and all(d.di
+00011260: 6d65 6e73 696f 6e20 2520 3220 3d3d 2031  mension % 2 == 1
+00011270: 2066 6f72 2064 2069 6e20 6669 6c74 6572   for d in filter
+00011280: 5f73 697a 6529 3a0a 2020 2020 2020 2020  _size):.        
+00011290: 2020 2020 6966 2061 6c6c 2866 696c 7465      if all(filte
+000112a0: 725f 7369 7a65 5b30 5d2e 6469 6d65 6e73  r_size[0].dimens
+000112b0: 696f 6e20 3d3d 2064 2e64 696d 656e 7369  ion == d.dimensi
+000112c0: 6f6e 2066 6f72 2064 2069 6e20 6669 6c74  on for d in filt
+000112d0: 6572 5f73 697a 6529 3a20 2023 2061 6c6c  er_size):  # all
+000112e0: 2073 616d 650a 2020 2020 2020 2020 2020   same.          
+000112f0: 2020 2020 2020 7061 6464 696e 6720 3d20        padding = 
+00011300: 2866 696c 7465 725f 7369 7a65 5b30 5d2e  (filter_size[0].
+00011310: 6469 6d65 6e73 696f 6e20 2d20 3129 202f  dimension - 1) /
+00011320: 2f20 320a 2020 2020 2020 2020 2020 2020  / 2.            
+00011330: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00011340: 2020 2020 2020 7061 6464 696e 6720 3d20        padding = 
+00011350: 7475 706c 6528 642e 6469 6d65 6e73 696f  tuple(d.dimensio
+00011360: 6e20 2f2f 2032 2066 6f72 2064 2069 6e20  n // 2 for d in 
+00011370: 6669 6c74 6572 5f73 697a 6529 0a20 2020  filter_size).   
+00011380: 2020 2020 2069 6620 7061 6464 696e 6720       if padding 
+00011390: 3d3d 2022 7361 6d65 2220 616e 6420 2875  == "same" and (u
+000113a0: 7365 5f73 7472 6964 696e 6720 6f72 2074  se_striding or t
+000113b0: 6f72 6368 2e6f 6e6e 782e 6973 5f69 6e5f  orch.onnx.is_in_
+000113c0: 6f6e 6e78 5f65 7870 6f72 7428 2929 3a0a  onnx_export()):.
+000113d0: 2020 2020 2020 2020 2020 2020 2320 7061              # pa
+000113e0: 6464 696e 673d 2773 616d 6527 2069 7320  dding='same' is 
+000113f0: 6e6f 7420 7375 7070 6f72 7465 6420 666f  not supported fo
+00011400: 7220 7374 7269 6465 6420 636f 6e76 6f6c  r strided convol
+00011410: 7574 696f 6e73 2e0a 2020 2020 2020 2020  utions..        
+00011420: 2020 2020 2320 4d6f 7265 6f76 6572 2c20      # Moreover, 
+00011430: 7061 6464 696e 6720 7370 6563 6966 6965  padding specifie
+00011440: 6420 6173 2061 2073 7472 696e 6720 6973  d as a string is
+00011450: 6e27 7420 7375 7070 6f72 7465 6420 666f  n't supported fo
+00011460: 7220 4f4e 4e58 2065 7870 6f72 7469 6e67  r ONNX exporting
+00011470: 2061 7320 6f66 2032 3032 332f 3035 2f31   as of 2023/05/1
+00011480: 392e 0a20 2020 2020 2020 2020 2020 2023  9..            #
+00011490: 204d 616e 7561 6c20 6164 6420 7468 6520   Manual add the 
+000114a0: 7061 6464 696e 672c 2061 6e64 2074 6865  padding, and the
+000114b0: 6e20 646f 206e 6f74 2075 7365 2061 6e79  n do not use any
+000114c0: 2070 6164 6469 6e67 2069 6e20 7468 6520   padding in the 
+000114d0: 636f 6e76 2e0a 2020 2020 2020 2020 2020  conv..          
+000114e0: 2020 7061 6464 696e 6720 3d20 300a 2020    padding = 0.  
+000114f0: 2020 2020 2020 2020 2020 7061 6473 203d            pads =
+00011500: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00011510: 666f 7220 692c 2073 2069 6e20 7265 7665  for i, s in reve
+00011520: 7273 6564 286c 6973 7428 656e 756d 6572  rsed(list(enumer
+00011530: 6174 6528 6669 6c74 6572 5f73 697a 6529  ate(filter_size)
+00011540: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00011550: 2020 2020 6966 2075 7365 5f73 7472 6964      if use_strid
+00011560: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00011570: 2020 2020 2020 2020 2073 7472 6964 655f           stride_
+00011580: 203d 2073 7472 6964 6573 5b69 5d20 6966   = strides[i] if
+00011590: 2069 7369 6e73 7461 6e63 6528 7374 7269   isinstance(stri
+000115a0: 6465 732c 2028 6c69 7374 2c20 7475 706c  des, (list, tupl
+000115b0: 6529 2920 656c 7365 2073 7472 6964 6573  e)) else strides
+000115c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000115d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000115e0: 2020 2020 2020 2020 2020 2073 7472 6964             strid
+000115f0: 655f 203d 2031 0a20 2020 2020 2020 2020  e_ = 1.         
+00011600: 2020 2020 2020 2023 2057 6861 7420 6973         # What is
+00011610: 2074 6865 206c 6f67 6963 2068 6572 653f   the logic here?
+00011620: 2059 6f75 206d 6967 6874 2062 6520 6177   You might be aw
+00011630: 6172 652c 2069 6e20 6361 7365 2077 6974  are, in case wit
+00011640: 686f 7574 2073 7472 6964 696e 672c 0a20  hout striding,. 
+00011650: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00011660: 2077 6520 7369 6d70 6c79 2068 6176 6520   we simply have 
+00011670: 7061 645f 6c65 6674 203d 2028 732e 6469  pad_left = (s.di
+00011680: 6d65 6e73 696f 6e20 2d20 3129 202f 2f20  mension - 1) // 
+00011690: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+000116a0: 2020 2023 206f 7220 7468 6520 746f 7461     # or the tota
+000116b0: 6c20 616d 6f75 6e74 206f 6620 7061 6464  l amount of padd
+000116c0: 696e 6720 6973 2073 2e64 696d 656e 7369  ing is s.dimensi
+000116d0: 6f6e 202d 2031 2e0a 2020 2020 2020 2020  on - 1..        
+000116e0: 2020 2020 2020 2020 2320 536f 2077 6520          # So we 
+000116f0: 6164 6420 7468 6520 7361 6d65 2061 6d6f  add the same amo
+00011700: 756e 7420 6f66 2070 6164 6469 6e67 206f  unt of padding o
+00011710: 6e20 626f 7468 2073 6964 6573 2028 6f72  n both sides (or
+00011720: 206f 6e65 206c 6573 7320 6f6e 2074 6865   one less on the
+00011730: 206c 6566 7420 7369 6465 2069 6620 6f64   left side if od
+00011740: 6429 2e0a 2020 2020 2020 2020 2020 2020  d)..            
+00011750: 2020 2020 2320 5468 6520 6f75 7470 7574      # The output
+00011760: 2073 6571 206c 656e 6774 6820 696e 2063   seq length in c
+00011770: 6173 6520 6f66 2022 7661 6c69 6422 2070  ase of "valid" p
+00011780: 6164 6469 6e67 2069 7320 e28c 8828 696e  adding is ...(in
+00011790: 5f6c 656e 202d 2073 2e64 696d 656e 7369  _len - s.dimensi
+000117a0: 6f6e 202b 2031 2920 2f20 7374 7269 6465  on + 1) / stride
+000117b0: e28c 892e 0a20 2020 2020 2020 2020 2020  .....           
+000117c0: 2020 2020 2023 2054 6865 206f 7574 7075       # The outpu
+000117d0: 7420 7365 7120 6c65 6e67 7468 2069 6e20  t seq length in 
+000117e0: 6361 7365 206f 6620 2273 616d 6522 2070  case of "same" p
+000117f0: 6164 6469 6e67 2077 6974 6820 6e6f 2073  adding with no s
+00011800: 7472 6964 696e 6720 2873 7472 6964 6520  triding (stride 
+00011810: 3d20 3129 0a20 2020 2020 2020 2020 2020  = 1).           
+00011820: 2020 2020 2023 2069 7320 7369 6d70 6c79       # is simply
+00011830: 2074 6865 2073 616d 6520 6173 2074 6865   the same as the
+00011840: 2069 6e70 7574 206c 656e 6774 682e 0a20   input length.. 
+00011850: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00011860: 2057 6861 7420 6973 2074 6865 206f 7574   What is the out
+00011870: 7075 7420 7365 7120 6c65 6e67 7468 2069  put seq length i
+00011880: 6e20 6361 7365 206f 6620 2273 616d 6522  n case of "same"
+00011890: 2070 6164 6469 6e67 2077 6974 6820 7374   padding with st
+000118a0: 7269 6469 6e67 3f0a 2020 2020 2020 2020  riding?.        
+000118b0: 2020 2020 2020 2020 2320 4974 2073 686f          # It sho
+000118c0: 756c 6420 6265 20e2 8c88 696e 5f6c 656e  uld be ...in_len
+000118d0: 202f 2073 7472 6964 65e2 8c89 2e0a 2020   / stride.....  
+000118e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000118f0: 536f 2c20 7468 656e 2077 6520 6e65 6564  So, then we need
+00011900: 2074 6f20 6164 6420 6120 746f 7461 6c20   to add a total 
+00011910: 616d 6f75 6e74 206f 6620 7061 6464 696e  amount of paddin
+00011920: 6720 6f66 2073 2e64 696d 656e 7369 6f6e  g of s.dimension
+00011930: 202d 2031 2e0a 2020 2020 2020 2020 2020   - 1..          
+00011940: 2020 2020 2020 2320 486f 7765 7665 722c        # However,
+00011950: 2064 6f69 6e67 2069 7420 7468 6520 7361   doing it the sa
+00011960: 6d65 2077 6179 2061 7320 7769 7468 6f75  me way as withou
+00011970: 7420 7374 7269 6469 6e67 2069 7320 696e  t striding is in
+00011980: 636f 7272 6563 742e 0a20 2020 2020 2020  correct..       
+00011990: 2020 2020 2020 2020 2023 2057 6879 3f20           # Why? 
+000119a0: 4265 6361 7573 6520 7468 656e 2074 6865  Because then the
+000119b0: 2066 6972 7374 2077 696e 646f 7720 6d69   first window mi
+000119c0: 6768 7420 6861 7665 206d 6f72 6520 7061  ght have more pa
+000119d0: 6464 696e 6720 7468 616e 2074 6865 2066  dding than the f
+000119e0: 696e 616c 2077 696e 646f 772e 0a20 2020  inal window..   
+000119f0: 2020 2020 2020 2020 2020 2020 2023 2042               # B
+00011a00: 7574 2077 6520 7761 6e74 2074 6f20 6861  ut we want to ha
+00011a10: 7665 2061 6e20 6576 656e 2061 6d6f 756e  ve an even amoun
+00011a20: 7420 6f66 2070 6164 6469 6e67 206f 6e20  t of padding on 
+00011a30: 7468 6520 6669 7273 7420 616e 6420 6c61  the first and la
+00011a40: 7374 2077 696e 646f 772c 0a20 2020 2020  st window,.     
+00011a50: 2020 2020 2020 2020 2020 2023 206f 7220             # or 
+00011a60: 6d61 7962 6520 6f6e 6520 6c65 7373 206f  maybe one less o
+00011a70: 6e20 7468 6520 6669 7273 7420 7769 6e64  n the first wind
+00011a80: 6f77 2069 6620 6f64 642e 0a20 2020 2020  ow if odd..     
+00011a90: 2020 2020 2020 2020 2020 2023 2048 6f77             # How
+00011aa0: 206d 616e 7920 6672 616d 6573 2064 6f20   many frames do 
+00011ab0: 7468 6520 7769 6e64 6f77 7320 636f 7665  the windows cove
+00011ac0: 723f 0a20 2020 2020 2020 2020 2020 2020  r?.             
+00011ad0: 2020 2023 2069 6e5f 6c65 6e5f 636f 7665     # in_len_cove
+00011ae0: 7265 6420 3d20 6f75 745f 6c65 6e20 2a20  red = out_len * 
+00011af0: 7374 7269 6465 202b 2028 732e 6469 6d65  stride + (s.dime
+00011b00: 6e73 696f 6e20 2d20 7374 7269 6465 290a  nsion - stride).
+00011b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b20: 2320 5765 2063 616e 2072 6577 7269 7465  # We can rewrite
+00011b30: 206f 7574 5f6c 656e 2061 733a 0a20 2020   out_len as:.   
+00011b40: 2020 2020 2020 2020 2020 2020 2023 206f               # o
+00011b50: 7574 5f6c 656e 203d 20e2 8c8a 2869 6e5f  ut_len = ...(in_
+00011b60: 6c65 6e20 2b20 7374 7269 6465 202d 2031  len + stride - 1
+00011b70: 2920 2f20 7374 7269 6465 e28c 8b20 3d20  ) / stride... = 
+00011b80: 2869 6e5f 6c65 6e20 2b20 7374 7269 6465  (in_len + stride
+00011b90: 202d 2031 202d 2028 696e 5f6c 656e 202d   - 1 - (in_len -
+00011ba0: 2031 2920 2520 7374 7269 6465 2920 2f20   1) % stride) / 
+00011bb0: 7374 7269 6465 0a20 2020 2020 2020 2020  stride.         
+00011bc0: 2020 2020 2020 2023 2053 6f20 7765 2068         # So we h
+00011bd0: 6176 653a 0a20 2020 2020 2020 2020 2020  ave:.           
+00011be0: 2020 2020 2023 2069 6e5f 6c65 6e5f 636f       # in_len_co
+00011bf0: 7665 7265 6420 3d20 2869 6e5f 6c65 6e20  vered = (in_len 
+00011c00: 2b20 7374 7269 6465 202d 2031 202d 2028  + stride - 1 - (
+00011c10: 696e 5f6c 656e 202d 2031 2920 2520 7374  in_len - 1) % st
+00011c20: 7269 6465 2920 2b20 2873 2e64 696d 656e  ride) + (s.dimen
+00011c30: 7369 6f6e 202d 2073 7472 6964 6529 0a20  sion - stride). 
+00011c40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00011c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c60: 3d20 696e 5f6c 656e 202b 2073 2e64 696d  = in_len + s.dim
+00011c70: 656e 7369 6f6e 202d 2031 202d 2028 696e  ension - 1 - (in
+00011c80: 5f6c 656e 202d 2031 2920 2520 7374 7269  _len - 1) % stri
+00011c90: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
+00011ca0: 2020 2023 204e 6f77 2c20 7468 6520 616d     # Now, the am
+00011cb0: 6f75 6e74 206f 6620 7061 6464 696e 6720  ount of padding 
+00011cc0: 7768 6963 6820 6163 7475 616c 6c79 206d  which actually m
+00011cd0: 6174 7465 7273 2069 733a 0a20 2020 2020  atters is:.     
+00011ce0: 2020 2020 2020 2020 2020 2023 2070 6164             # pad
+00011cf0: 203d 2069 6e5f 6c65 6e5f 636f 7665 7265   = in_len_covere
+00011d00: 6420 2d20 696e 5f6c 656e 203d 2073 2e64  d - in_len = s.d
+00011d10: 696d 656e 7369 6f6e 202d 2031 202d 2028  imension - 1 - (
+00011d20: 696e 5f6c 656e 202d 2031 2920 2520 7374  in_len - 1) % st
+00011d30: 7269 6465 2e0a 2020 2020 2020 2020 2020  ride..          
+00011d40: 2020 2020 2020 7061 6420 3d20 732e 6469        pad = s.di
+00011d50: 6d65 6e73 696f 6e20 2d20 3120 2d20 2873  mension - 1 - (s
+00011d60: 7263 5f72 6177 2e73 6861 7065 5b32 202b  rc_raw.shape[2 +
+00011d70: 2069 5d20 2d20 3129 2025 2073 7472 6964   i] - 1) % strid
+00011d80: 655f 0a20 2020 2020 2020 2020 2020 2020  e_.             
+00011d90: 2020 2070 6164 5f6c 6566 7420 3d20 7061     pad_left = pa
+00011da0: 6420 2f2f 2032 0a20 2020 2020 2020 2020  d // 2.         
+00011db0: 2020 2020 2020 2070 6164 5f72 6967 6874         pad_right
+00011dc0: 203d 2070 6164 202d 2070 6164 5f6c 6566   = pad - pad_lef
+00011dd0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00011de0: 2020 7061 6473 2e65 7874 656e 6428 5b70    pads.extend([p
+00011df0: 6164 5f6c 6566 742c 2070 6164 5f72 6967  ad_left, pad_rig
+00011e00: 6874 5d29 0a20 2020 2020 2020 2020 2020  ht]).           
+00011e10: 2073 7263 5f72 6177 203d 2074 6f72 6368   src_raw = torch
+00011e20: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e70  .nn.functional.p
+00011e30: 6164 2873 7263 5f72 6177 2c20 7061 6473  ad(src_raw, pads
+00011e40: 290a 2020 2020 2020 2020 6966 2070 6164  ).        if pad
+00011e50: 6469 6e67 203d 3d20 2276 616c 6964 223a  ding == "valid":
+00011e60: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
+00011e70: 6164 6469 6e67 2061 7320 7374 7269 6e67  adding as string
+00011e80: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+00011e90: 6420 652e 672e 2069 6e20 4f4e 4e58 2e0a  d e.g. in ONNX..
+00011ea0: 2020 2020 2020 2020 2020 2020 7061 6464              padd
+00011eb0: 696e 6720 3d20 300a 2020 2020 2020 2020  ing = 0.        
+00011ec0: 6966 206c 656e 2866 696c 7465 725f 7369  if len(filter_si
+00011ed0: 7a65 2920 3d3d 2031 3a0a 2020 2020 2020  ze) == 1:.      
+00011ee0: 2020 2020 2020 2320 5468 6572 6520 6973        # There is
+00011ef0: 2061 6c73 6f20 636f 6e76 5f74 6263 2c20   also conv_tbc, 
+00011f00: 6275 7420 6974 2773 2061 2062 6974 206c  but it's a bit l
+00011f10: 696d 6974 6564 2028 6e6f 2064 696c 6174  imited (no dilat
+00011f20: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+00011f30: 2023 2061 6e64 2061 6c73 6f20 756e 636c   # and also uncl
+00011f40: 6561 7220 7768 656e 2065 7861 6374 6c79  ear when exactly
+00011f50: 2069 7420 6973 2066 6173 7465 722e 0a20   it is faster.. 
+00011f60: 2020 2020 2020 2020 2020 206f 7574 5f72             out_r
+00011f70: 6177 203d 2074 6f72 6368 2e6e 6e2e 6675  aw = torch.nn.fu
+00011f80: 6e63 7469 6f6e 616c 2e63 6f6e 7631 6428  nctional.conv1d(
+00011f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011fa0: 2073 7263 5f72 6177 2c0a 2020 2020 2020   src_raw,.      
+00011fb0: 2020 2020 2020 2020 2020 7765 6967 6874            weight
+00011fc0: 3d66 696c 7465 722e 7261 775f 7465 6e73  =filter.raw_tens
+00011fd0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00011fe0: 2020 2020 6269 6173 3d62 6961 732e 7261      bias=bias.ra
+00011ff0: 775f 7465 6e73 6f72 2069 6620 6269 6173  w_tensor if bias
+00012000: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00012010: 6520 4e6f 6e65 2c0a 2020 2020 2020 2020  e None,.        
+00012020: 2020 2020 2020 2020 7374 7269 6465 3d73          stride=s
+00012030: 7472 6964 6573 206f 7220 312c 0a20 2020  trides or 1,.   
+00012040: 2020 2020 2020 2020 2020 2020 2070 6164               pad
+00012050: 6469 6e67 3d70 6164 6469 6e67 2c0a 2020  ding=padding,.  
+00012060: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00012070: 6c61 7469 6f6e 3d64 696c 6174 696f 6e5f  lation=dilation_
+00012080: 7261 7465 206f 7220 312c 0a20 2020 2020  rate or 1,.     
+00012090: 2020 2020 2020 2020 2020 2067 726f 7570             group
+000120a0: 733d 6772 6f75 7073 206f 7220 312c 0a20  s=groups or 1,. 
+000120b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000120c0: 2020 2020 2065 6c69 6620 6c65 6e28 6669       elif len(fi
+000120d0: 6c74 6572 5f73 697a 6529 203d 3d20 323a  lter_size) == 2:
+000120e0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+000120f0: 5f72 6177 203d 2074 6f72 6368 2e6e 6e2e  _raw = torch.nn.
+00012100: 6675 6e63 7469 6f6e 616c 2e63 6f6e 7632  functional.conv2
+00012110: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00012120: 2020 2073 7263 5f72 6177 2c0a 2020 2020     src_raw,.    
+00012130: 2020 2020 2020 2020 2020 2020 7765 6967              weig
+00012140: 6874 3d66 696c 7465 722e 7261 775f 7465  ht=filter.raw_te
+00012150: 6e73 6f72 2c0a 2020 2020 2020 2020 2020  nsor,.          
+00012160: 2020 2020 2020 6269 6173 3d62 6961 732e        bias=bias.
+00012170: 7261 775f 7465 6e73 6f72 2069 6620 6269  raw_tensor if bi
+00012180: 6173 2069 7320 6e6f 7420 4e6f 6e65 2065  as is not None e
+00012190: 6c73 6520 4e6f 6e65 2c0a 2020 2020 2020  lse None,.      
+000121a0: 2020 2020 2020 2020 2020 7374 7269 6465            stride
+000121b0: 3d73 7472 6964 6573 206f 7220 312c 0a20  =strides or 1,. 
+000121c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000121d0: 6164 6469 6e67 3d70 6164 6469 6e67 2c0a  adding=padding,.
+000121e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121f0: 6469 6c61 7469 6f6e 3d64 696c 6174 696f  dilation=dilatio
+00012200: 6e5f 7261 7465 206f 7220 312c 0a20 2020  n_rate or 1,.   
+00012210: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00012220: 7570 733d 6772 6f75 7073 206f 7220 312c  ups=groups or 1,
+00012230: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00012240: 2020 2020 2020 2065 6c69 6620 6c65 6e28         elif len(
+00012250: 6669 6c74 6572 5f73 697a 6529 203d 3d20  filter_size) == 
+00012260: 333a 0a20 2020 2020 2020 2020 2020 206f  3:.            o
+00012270: 7574 5f72 6177 203d 2074 6f72 6368 2e6e  ut_raw = torch.n
+00012280: 6e2e 6675 6e63 7469 6f6e 616c 2e63 6f6e  n.functional.con
+00012290: 7633 6428 0a20 2020 2020 2020 2020 2020  v3d(.           
+000122a0: 2020 2020 2073 7263 5f72 6177 2c0a 2020       src_raw,.  
+000122b0: 2020 2020 2020 2020 2020 2020 2020 7765                we
+000122c0: 6967 6874 3d66 696c 7465 722e 7261 775f  ight=filter.raw_
+000122d0: 7465 6e73 6f72 2c0a 2020 2020 2020 2020  tensor,.        
+000122e0: 2020 2020 2020 2020 6269 6173 3d62 6961          bias=bia
+000122f0: 732e 7261 775f 7465 6e73 6f72 2069 6620  s.raw_tensor if 
+00012300: 6269 6173 2069 7320 6e6f 7420 4e6f 6e65  bias is not None
+00012310: 2065 6c73 6520 4e6f 6e65 2c0a 2020 2020   else None,.    
+00012320: 2020 2020 2020 2020 2020 2020 7374 7269              stri
+00012330: 6465 3d73 7472 6964 6573 206f 7220 312c  de=strides or 1,
+00012340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012350: 2070 6164 6469 6e67 3d70 6164 6469 6e67   padding=padding
+00012360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012370: 2020 6469 6c61 7469 6f6e 3d64 696c 6174    dilation=dilat
+00012380: 696f 6e5f 7261 7465 206f 7220 312c 0a20  ion_rate or 1,. 
+00012390: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000123a0: 726f 7570 733d 6772 6f75 7073 206f 7220  roups=groups or 
+000123b0: 312c 0a20 2020 2020 2020 2020 2020 2029  1,.            )
+000123c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000123d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000123e0: 2056 616c 7565 4572 726f 7228 6622 696e   ValueError(f"in
+000123f0: 7661 6c69 6420 6e75 6d62 6572 206f 6620  valid number of 
+00012400: 6669 6c74 6572 2064 696d 7320 7b66 696c  filter dims {fil
+00012410: 7465 725f 7369 7a65 7d2c 2065 7870 6563  ter_size}, expec
+00012420: 7465 6420 312c 2032 2c20 6f72 2033 2229  ted 1, 2, or 3")
+00012430: 0a20 2020 2020 2020 206f 7574 203d 2054  .        out = T
+00012440: 656e 736f 7228 0a20 2020 2020 2020 2020  ensor(.         
+00012450: 2020 2022 636f 6e76 222c 2064 696d 733d     "conv", dims=
+00012460: 6261 7463 685f 6469 6d73 202b 205b 6f75  batch_dims + [ou
+00012470: 745f 6469 6d5d 202b 206c 6973 7428 6f75  t_dim] + list(ou
+00012480: 745f 7370 6174 6961 6c5f 6469 6d73 292c  t_spatial_dims),
+00012490: 2064 7479 7065 3d54 6f72 6368 4261 636b   dtype=TorchBack
+000124a0: 656e 642e 6765 745f 6474 7970 655f 6e61  end.get_dtype_na
+000124b0: 6d65 5f72 6177 286f 7574 5f72 6177 290a  me_raw(out_raw).
+000124c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000124d0: 2020 6966 206c 656e 2862 6174 6368 5f64    if len(batch_d
+000124e0: 696d 7329 203d 3d20 313a 0a20 2020 2020  ims) == 1:.     
+000124f0: 2020 2020 2020 206f 7574 2e72 6177 5f74         out.raw_t
+00012500: 656e 736f 7220 3d20 6f75 745f 7261 770a  ensor = out_raw.
+00012510: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00012520: 2020 2020 2020 2020 2020 6f75 742e 7261            out.ra
+00012530: 775f 7465 6e73 6f72 203d 2074 6f72 6368  w_tensor = torch
+00012540: 2e72 6573 6861 7065 286f 7574 5f72 6177  .reshape(out_raw
+00012550: 2c20 5b64 2e67 6574 5f64 696d 5f76 616c  , [d.get_dim_val
+00012560: 7565 2829 2066 6f72 2064 2069 6e20 6f75  ue() for d in ou
+00012570: 742e 6469 6d73 5d29 0a20 2020 2020 2020  t.dims]).       
+00012580: 206f 7574 2e66 6561 7475 7265 5f64 696d   out.feature_dim
+00012590: 203d 206f 7574 5f64 696d 0a20 2020 2020   = out_dim.     
+000125a0: 2020 2072 6574 7572 6e20 6f75 742c 206f     return out, o
+000125b0: 7574 5f73 7061 7469 616c 5f64 696d 730a  ut_spatial_dims.
+000125c0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+000125d0: 6f64 0a20 2020 2064 6566 2070 6f6f 6c28  od.    def pool(
+000125e0: 0a20 2020 2020 2020 2073 6f75 7263 653a  .        source:
+000125f0: 2054 656e 736f 722c 0a20 2020 2020 2020   Tensor,.       
+00012600: 202a 2c0a 2020 2020 2020 2020 6d6f 6465   *,.        mode
+00012610: 3a20 7374 722c 0a20 2020 2020 2020 2070  : str,.        p
+00012620: 6f6f 6c5f 7369 7a65 3a20 5365 7175 656e  ool_size: Sequen
+00012630: 6365 5b69 6e74 5d2c 0a20 2020 2020 2020  ce[int],.       
+00012640: 2070 6164 6469 6e67 3a20 7374 7220 3d20   padding: str = 
+00012650: 2276 616c 6964 222c 0a20 2020 2020 2020  "valid",.       
+00012660: 2064 696c 6174 696f 6e5f 7261 7465 3a20   dilation_rate: 
+00012670: 556e 696f 6e5b 5365 7175 656e 6365 5b69  Union[Sequence[i
+00012680: 6e74 5d2c 2069 6e74 5d20 3d20 312c 0a20  nt], int] = 1,. 
+00012690: 2020 2020 2020 2073 7472 6964 6573 3a20         strides: 
+000126a0: 5365 7175 656e 6365 5b69 6e74 5d2c 0a20  Sequence[int],. 
+000126b0: 2020 2020 2020 2069 6e5f 7370 6174 6961         in_spatia
+000126c0: 6c5f 6469 6d73 3a20 5365 7175 656e 6365  l_dims: Sequence
+000126d0: 5b44 696d 5d2c 0a20 2020 2020 2020 206f  [Dim],.        o
+000126e0: 7574 5f73 7061 7469 616c 5f64 696d 733a  ut_spatial_dims:
+000126f0: 204f 7074 696f 6e61 6c5b 5365 7175 656e   Optional[Sequen
+00012700: 6365 5b44 696d 5d5d 203d 204e 6f6e 652c  ce[Dim]] = None,
+00012710: 0a20 2020 2029 202d 3e20 5475 706c 655b  .    ) -> Tuple[
+00012720: 5465 6e73 6f72 2c20 5365 7175 656e 6365  Tensor, Sequence
+00012730: 5b44 696d 5d5d 3a0a 2020 2020 2020 2020  [Dim]]:.        
+00012740: 2222 2270 6f6f 6c22 2222 0a20 2020 2020  """pool""".     
+00012750: 2020 2069 6620 6f75 745f 7370 6174 6961     if out_spatia
+00012760: 6c5f 6469 6d73 2069 7320 4e6f 6e65 3a0a  l_dims is None:.
+00012770: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
+00012780: 7370 6174 6961 6c5f 6469 6d73 203d 2072  spatial_dims = r
+00012790: 662e 6d61 6b65 5f63 6f6e 765f 6f75 745f  f.make_conv_out_
+000127a0: 7370 6174 6961 6c5f 6469 6d73 280a 2020  spatial_dims(.  
+000127b0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000127c0: 5f73 7061 7469 616c 5f64 696d 733d 696e  _spatial_dims=in
+000127d0: 5f73 7061 7469 616c 5f64 696d 732c 0a20  _spatial_dims,. 
+000127e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000127f0: 696c 7465 725f 7369 7a65 3d70 6f6f 6c5f  ilter_size=pool_
+00012800: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00012810: 2020 2020 2020 7374 7269 6465 733d 7374        strides=st
+00012820: 7269 6465 732c 0a20 2020 2020 2020 2020  rides,.         
+00012830: 2020 2020 2020 2064 696c 6174 696f 6e5f         dilation_
+00012840: 7261 7465 3d64 696c 6174 696f 6e5f 7261  rate=dilation_ra
+00012850: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+00012860: 2020 2020 7061 6464 696e 673d 7061 6464      padding=padd
+00012870: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
+00012880: 2029 0a20 2020 2020 2020 2062 6174 6368   ).        batch
+00012890: 5f64 696d 7320 3d20 5b64 2066 6f72 2064  _dims = [d for d
+000128a0: 2069 6e20 736f 7572 6365 2e64 696d 7320   in source.dims 
+000128b0: 6966 2064 206e 6f74 2069 6e20 7475 706c  if d not in tupl
+000128c0: 6528 696e 5f73 7061 7469 616c 5f64 696d  e(in_spatial_dim
+000128d0: 7329 5d0a 2020 2020 2020 2020 2320 546f  s)].        # To
+000128e0: 7263 6820 636f 6e76 2065 7870 6563 7473  rch conv expects
+000128f0: 2028 4e2c 432c 3c73 7061 7469 616c 2064   (N,C,<spatial d
+00012900: 696d 733e 2920 6173 2073 6861 7065 2e0a  ims>) as shape..
+00012910: 2020 2020 2020 2020 2320 6261 7463 685f          # batch_
+00012920: 6469 6d73 2077 6f75 6c64 2061 6374 7561  dims would actua
+00012930: 6c6c 7920 636f 7665 7220 7468 6520 6368  lly cover the ch
+00012940: 616e 6e65 6c2d 6469 6d20 2843 2920 6173  annel-dim (C) as
+00012950: 2077 656c 6c2c 0a20 2020 2020 2020 2023   well,.        #
+00012960: 2061 7320 6974 2064 6f65 7320 6e6f 7420   as it does not 
+00012970: 7265 616c 6c79 206d 6174 7465 7220 746f  really matter to
+00012980: 2064 6966 6665 7265 6e74 6961 7465 2069   differentiate i
+00012990: 7420 6672 6f6d 206f 7468 6572 2062 6174  t from other bat
+000129a0: 6368 2064 696d 732e 0a20 2020 2020 2020  ch dims..       
+000129b0: 2073 6f75 7263 6520 3d20 736f 7572 6365   source = source
+000129c0: 2e63 6f70 795f 7472 616e 7370 6f73 6528  .copy_transpose(
+000129d0: 6261 7463 685f 6469 6d73 202b 206c 6973  batch_dims + lis
+000129e0: 7428 696e 5f73 7061 7469 616c 5f64 696d  t(in_spatial_dim
+000129f0: 7329 290a 2020 2020 2020 2020 7372 635f  s)).        src_
+00012a00: 7261 7720 3d20 746f 7263 682e 7265 7368  raw = torch.resh
+00012a10: 6170 6528 0a20 2020 2020 2020 2020 2020  ape(.           
+00012a20: 2073 6f75 7263 652e 7261 775f 7465 6e73   source.raw_tens
+00012a30: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+00012a40: 2320 506f 7465 6e74 6961 6c6c 7920 6d65  # Potentially me
+00012a50: 7267 6520 6261 7463 6820 6469 6d73 2061  rge batch dims a
+00012a60: 6c6c 2074 6f67 6574 6865 722e 0a20 2020  ll together..   
+00012a70: 2020 2020 2020 2020 2023 204b 6565 7020           # Keep 
+00012a80: 7468 6520 6c61 7374 2061 7320 7468 6520  the last as the 
+00012a90: 6368 616e 6e65 6c2d 6469 6d2c 2062 7574  channel-dim, but
+00012aa0: 206e 6f74 2073 7572 6520 6966 2074 6869   not sure if thi
+00012ab0: 7320 6973 2072 6561 6c6c 7920 7265 6c65  s is really rele
+00012ac0: 7661 6e74 2e0a 2020 2020 2020 2020 2020  vant..          
+00012ad0: 2020 5b2d 312c 2062 6174 6368 5f64 696d    [-1, batch_dim
+00012ae0: 735b 2d31 5d2e 6765 745f 6469 6d5f 7661  s[-1].get_dim_va
+00012af0: 6c75 6528 2920 6966 2062 6174 6368 5f64  lue() if batch_d
+00012b00: 696d 7320 656c 7365 2031 5d20 2b20 5b64  ims else 1] + [d
+00012b10: 2e67 6574 5f64 696d 5f76 616c 7565 2829  .get_dim_value()
+00012b20: 2066 6f72 2064 2069 6e20 696e 5f73 7061   for d in in_spa
+00012b30: 7469 616c 5f64 696d 735d 2c0a 2020 2020  tial_dims],.    
+00012b40: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+00012b50: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00012b60: 7374 7269 6465 732c 2028 6c69 7374 2c20  strides, (list, 
+00012b70: 7475 706c 6529 2920 616e 6420 6c65 6e28  tuple)) and len(
+00012b80: 7374 7269 6465 7329 203d 3d20 6c65 6e28  strides) == len(
+00012b90: 696e 5f73 7061 7469 616c 5f64 696d 7329  in_spatial_dims)
+00012ba0: 203d 3d20 6c65 6e28 706f 6f6c 5f73 697a   == len(pool_siz
+00012bb0: 6529 0a20 2020 2020 2020 2069 6620 7061  e).        if pa
+00012bc0: 6464 696e 672e 6c6f 7765 7228 2920 3d3d  dding.lower() ==
+00012bd0: 2022 7361 6d65 223a 0a20 2020 2020 2020   "same":.       
+00012be0: 2020 2020 2023 2070 6164 6469 6e67 3d27       # padding='
+00012bf0: 7361 6d65 2720 6973 206e 6f74 2071 7569  same' is not qui
+00012c00: 7465 2074 6865 2073 616d 6520 6173 2063  te the same as c
+00012c10: 6569 6c5f 6d6f 6465 3d54 7275 652c 2073  eil_mode=True, s
+00012c20: 6f20 7765 2065 7870 6c69 6369 746c 7920  o we explicitly 
+00012c30: 7061 6420 6865 7265 2e0a 2020 2020 2020  pad here..      
+00012c40: 2020 2020 2020 7061 6464 696e 6720 3d20        padding = 
+00012c50: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00012c60: 6f72 2069 2c20 7320 696e 2065 6e75 6d65  or i, s in enume
+00012c70: 7261 7465 2870 6f6f 6c5f 7369 7a65 293a  rate(pool_size):
+00012c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012c90: 2023 2053 6565 2063 6f6d 6d65 6e74 2069   # See comment i
+00012ca0: 6e20 636f 6e76 2e0a 2020 2020 2020 2020  n conv..        
+00012cb0: 2020 2020 2020 2020 7061 6420 3d20 7320          pad = s 
+00012cc0: 2d20 3120 2d20 2873 7263 5f72 6177 2e73  - 1 - (src_raw.s
+00012cd0: 6861 7065 5b32 202b 2069 5d20 2d20 3129  hape[2 + i] - 1)
+00012ce0: 2025 2073 7472 6964 6573 5b69 5d0a 2020   % strides[i].  
+00012cf0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00012d00: 6464 696e 672e 6170 7065 6e64 2870 6164  dding.append(pad
+00012d10: 202f 2f20 3229 0a20 2020 2020 2020 2020   // 2).         
+00012d20: 2020 2063 6569 6c5f 6d6f 6465 203d 2054     ceil_mode = T
+00012d30: 7275 650a 2020 2020 2020 2020 656c 6966  rue.        elif
+00012d40: 2070 6164 6469 6e67 2e6c 6f77 6572 2829   padding.lower()
+00012d50: 203d 3d20 2276 616c 6964 223a 0a20 2020   == "valid":.   
+00012d60: 2020 2020 2020 2020 2070 6164 6469 6e67           padding
+00012d70: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00012d80: 2063 6569 6c5f 6d6f 6465 203d 2046 616c   ceil_mode = Fal
+00012d90: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
+00012da0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00012db0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
+00012dc0: 696e 7661 6c69 6420 7061 6464 696e 6720  invalid padding 
+00012dd0: 7b70 6164 6469 6e67 2172 7d22 290a 2020  {padding!r}").  
+00012de0: 2020 2020 2020 6675 6e63 5f6e 616d 6520        func_name 
+00012df0: 3d20 6622 7b6d 6f64 657d 5f70 6f6f 6c7b  = f"{mode}_pool{
+00012e00: 6c65 6e28 696e 5f73 7061 7469 616c 5f64  len(in_spatial_d
+00012e10: 696d 7329 7d64 220a 2020 2020 2020 2020  ims)}d".        
+00012e20: 6675 6e63 203d 2067 6574 6174 7472 2874  func = getattr(t
+00012e30: 6f72 6368 2e6e 6e2e 6675 6e63 7469 6f6e  orch.nn.function
+00012e40: 616c 2c20 6675 6e63 5f6e 616d 6529 2020  al, func_name)  
+00012e50: 2320 652e 672e 2074 6f72 6368 2e6e 6e2e  # e.g. torch.nn.
+00012e60: 6675 6e63 7469 6f6e 616c 2e6d 6178 5f70  functional.max_p
+00012e70: 6f6f 6c31 640a 2020 2020 2020 2020 6b77  ool1d.        kw
+00012e80: 6172 6773 203d 207b 7d0a 2020 2020 2020  args = {}.      
+00012e90: 2020 6966 2064 696c 6174 696f 6e5f 7261    if dilation_ra
+00012ea0: 7465 2061 6e64 2061 6e79 280a 2020 2020  te and any(.    
+00012eb0: 2020 2020 2020 2020 6420 213d 2031 2066          d != 1 f
+00012ec0: 6f72 2064 2069 6e20 285b 6469 6c61 7469  or d in ([dilati
+00012ed0: 6f6e 5f72 6174 655d 2069 6620 6973 696e  on_rate] if isin
+00012ee0: 7374 616e 6365 2864 696c 6174 696f 6e5f  stance(dilation_
+00012ef0: 7261 7465 2c20 696e 7429 2065 6c73 6520  rate, int) else 
+00012f00: 6469 6c61 7469 6f6e 5f72 6174 6529 0a20  dilation_rate). 
+00012f10: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00012f20: 2020 2020 2020 2320 4f6e 6c79 206f 7074        # Only opt
+00012f30: 696f 6e61 6c6c 7920 6164 6420 6974 2074  ionally add it t
+00012f40: 6f20 6b77 6172 6773 2e20 4d69 6768 7420  o kwargs. Might 
+00012f50: 6e6f 7420 6265 2073 7570 706f 7274 6564  not be supported
+00012f60: 2062 7920 616c 6c20 706f 6f6c 206d 6f64   by all pool mod
+00012f70: 6573 2c20 652e 672e 2061 7667 5f70 6f6f  es, e.g. avg_poo
+00012f80: 6c2e 0a20 2020 2020 2020 2020 2020 2061  l..            a
+00012f90: 7373 6572 7420 6d6f 6465 203d 3d20 226d  ssert mode == "m
+00012fa0: 6178 222c 2022 6469 6c61 7469 6f6e 5f72  ax", "dilation_r
+00012fb0: 6174 6520 6f6e 6c79 2073 7570 706f 7274  ate only support
+00012fc0: 6564 2066 6f72 206d 6178 5f70 6f6f 6c22  ed for max_pool"
+00012fd0: 0a20 2020 2020 2020 2020 2020 206b 7761  .            kwa
+00012fe0: 7267 735b 2264 696c 6174 696f 6e22 5d20  rgs["dilation"] 
+00012ff0: 3d20 6469 6c61 7469 6f6e 5f72 6174 650a  = dilation_rate.
+00013000: 2020 2020 2020 2020 6966 206d 6f64 6520          if mode 
+00013010: 3d3d 2022 6176 6722 3a0a 2020 2020 2020  == "avg":.      
+00013020: 2020 2020 2020 6b77 6172 6773 5b22 636f        kwargs["co
+00013030: 756e 745f 696e 636c 7564 655f 7061 6422  unt_include_pad"
+00013040: 5d20 3d20 4661 6c73 650a 2020 2020 2020  ] = False.      
+00013050: 2020 6f75 745f 7261 7720 3d20 6675 6e63    out_raw = func
+00013060: 2873 7263 5f72 6177 2c20 6b65 726e 656c  (src_raw, kernel
+00013070: 5f73 697a 653d 706f 6f6c 5f73 697a 652c  _size=pool_size,
+00013080: 2073 7472 6964 653d 7374 7269 6465 732c   stride=strides,
+00013090: 2063 6569 6c5f 6d6f 6465 3d63 6569 6c5f   ceil_mode=ceil_
+000130a0: 6d6f 6465 2c20 7061 6464 696e 673d 7061  mode, padding=pa
+000130b0: 6464 696e 672c 202a 2a6b 7761 7267 7329  dding, **kwargs)
+000130c0: 0a20 2020 2020 2020 206f 7574 203d 2054  .        out = T
+000130d0: 656e 736f 7228 2270 6f6f 6c22 2c20 6469  ensor("pool", di
+000130e0: 6d73 3d62 6174 6368 5f64 696d 7320 2b20  ms=batch_dims + 
+000130f0: 6c69 7374 286f 7574 5f73 7061 7469 616c  list(out_spatial
+00013100: 5f64 696d 7329 2c20 6474 7970 653d 736f  _dims), dtype=so
+00013110: 7572 6365 2e64 7479 7065 290a 2020 2020  urce.dtype).    
+00013120: 2020 2020 6f75 742e 7261 775f 7465 6e73      out.raw_tens
+00013130: 6f72 203d 2074 6f72 6368 2e72 6573 6861  or = torch.resha
+00013140: 7065 286f 7574 5f72 6177 2c20 5b64 2e67  pe(out_raw, [d.g
+00013150: 6574 5f64 696d 5f76 616c 7565 2829 2066  et_dim_value() f
+00013160: 6f72 2064 2069 6e20 6f75 742e 6469 6d73  or d in out.dims
+00013170: 5d29 0a20 2020 2020 2020 2069 6620 736f  ]).        if so
+00013180: 7572 6365 2e66 6561 7475 7265 5f64 696d  urce.feature_dim
+00013190: 2061 6e64 2073 6f75 7263 652e 6665 6174   and source.feat
+000131a0: 7572 655f 6469 6d20 696e 206f 7574 2e64  ure_dim in out.d
+000131b0: 696d 733a 0a20 2020 2020 2020 2020 2020  ims:.           
+000131c0: 206f 7574 2e66 6561 7475 7265 5f64 696d   out.feature_dim
+000131d0: 203d 2073 6f75 7263 652e 6665 6174 7572   = source.featur
+000131e0: 655f 6469 6d0a 2020 2020 2020 2020 7265  e_dim.        re
+000131f0: 7475 726e 206f 7574 2c20 6f75 745f 7370  turn out, out_sp
+00013200: 6174 6961 6c5f 6469 6d73 0a0a 2020 2020  atial_dims..    
+00013210: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00013220: 2020 6465 6620 7374 6674 280a 2020 2020    def stft(.    
+00013230: 2020 2020 783a 2054 656e 736f 722c 0a20      x: Tensor,. 
+00013240: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+00013250: 2020 696e 5f73 7061 7469 616c 5f64 696d    in_spatial_dim
+00013260: 3a20 4469 6d2c 0a20 2020 2020 2020 2066  : Dim,.        f
+00013270: 7261 6d65 5f73 7465 703a 2069 6e74 2c0a  rame_step: int,.
+00013280: 2020 2020 2020 2020 6672 616d 655f 6c65          frame_le
+00013290: 6e67 7468 3a20 696e 742c 0a20 2020 2020  ngth: int,.     
+000132a0: 2020 2066 6674 5f6c 656e 6774 683a 2069     fft_length: i
+000132b0: 6e74 2c0a 2020 2020 2020 2020 7769 6e64  nt,.        wind
+000132c0: 6f77 5f75 7365 5f66 7261 6d65 5f6c 656e  ow_use_frame_len
+000132d0: 6774 683a 2062 6f6f 6c20 3d20 5472 7565  gth: bool = True
+000132e0: 2c0a 2020 2020 2020 2020 616c 6967 6e5f  ,.        align_
+000132f0: 7769 6e64 6f77 5f6c 6566 743a 2062 6f6f  window_left: boo
+00013300: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00013310: 2020 7769 6e64 6f77 5f65 6e66 6f72 6365    window_enforce
+00013320: 5f65 7665 6e3a 2062 6f6f 6c20 3d20 5472  _even: bool = Tr
+00013330: 7565 2c0a 2020 2020 2020 2020 6f75 745f  ue,.        out_
+00013340: 7370 6174 6961 6c5f 6469 6d3a 2044 696d  spatial_dim: Dim
+00013350: 2c0a 2020 2020 2020 2020 6f75 745f 6469  ,.        out_di
+00013360: 6d3a 2044 696d 2c0a 2020 2020 2920 2d3e  m: Dim,.    ) ->
+00013370: 2054 656e 736f 723a 0a20 2020 2020 2020   Tensor:.       
+00013380: 2022 2222 7374 6674 2222 220a 2020 2020   """stft""".    
+00013390: 2020 2020 6261 7463 685f 6469 6d73 203d      batch_dims =
+000133a0: 205b 6420 666f 7220 6420 696e 2078 2e64   [d for d in x.d
+000133b0: 696d 7320 6966 2064 2021 3d20 696e 5f73  ims if d != in_s
+000133c0: 7061 7469 616c 5f64 696d 5d0a 2020 2020  patial_dim].    
+000133d0: 2020 2020 7820 3d20 782e 636f 7079 5f74      x = x.copy_t
+000133e0: 7261 6e73 706f 7365 2862 6174 6368 5f64  ranspose(batch_d
+000133f0: 696d 7320 2b20 5b69 6e5f 7370 6174 6961  ims + [in_spatia
+00013400: 6c5f 6469 6d5d 290a 2020 2020 2020 2020  l_dim]).        
+00013410: 785f 7261 7720 3d20 746f 7263 682e 7265  x_raw = torch.re
+00013420: 7368 6170 6528 782e 7261 775f 7465 6e73  shape(x.raw_tens
+00013430: 6f72 2c20 5b2d 312c 2069 6e5f 7370 6174  or, [-1, in_spat
+00013440: 6961 6c5f 6469 6d2e 6765 745f 6469 6d5f  ial_dim.get_dim_
+00013450: 7661 6c75 6528 295d 290a 0a20 2020 2020  value()])..     
+00013460: 2020 2023 2054 4620 636f 6465 3a20 7920     # TF code: y 
+00013470: 3d20 7466 2e73 6967 6e61 6c2e 7374 6674  = tf.signal.stft
+00013480: 2878 2c20 6672 616d 655f 6c65 6e67 7468  (x, frame_length
+00013490: 3d66 7261 6d65 5f73 697a 652c 2066 7261  =frame_size, fra
+000134a0: 6d65 5f73 7465 703d 6672 616d 655f 7368  me_step=frame_sh
+000134b0: 6966 742c 2066 6674 5f6c 656e 6774 683d  ift, fft_length=
+000134c0: 6666 745f 7369 7a65 290a 2020 2020 2020  fft_size).      
+000134d0: 2020 2320 5468 6973 2069 7320 7369 6d69    # This is simi
+000134e0: 6c61 7220 746f 2077 6861 7420 5363 6950  lar to what SciP
+000134f0: 7920 7769 6c6c 2061 6c73 6f20 7265 7475  y will also retu
+00013500: 726e 2e0a 2020 2020 2020 2020 2320 4974  rn..        # It
+00013510: 2069 7320 736f 6d65 7768 6174 206e 6f6e   is somewhat non
+00013520: 7472 6976 6961 6c20 746f 2067 6574 2074  trivial to get t
+00013530: 6865 2073 616d 6520 7265 7375 6c74 2069  he same result i
+00013540: 6e20 5079 546f 7263 682c 2065 7370 2066  n PyTorch, esp f
+00013550: 6f72 2074 6865 2063 6173 6520 6672 616d  or the case fram
+00013560: 655f 6c65 6e67 7468 203c 2066 6674 5f6c  e_length < fft_l
+00013570: 656e 6774 682c 0a20 2020 2020 2020 2023  ength,.        #
+00013580: 2061 6e64 2065 7665 6e20 6d6f 7265 2077   and even more w
+00013590: 6865 6e20 6672 616d 655f 6c65 6e67 7468  hen frame_length
+000135a0: 2025 2032 2021 3d20 302e 0a20 2020 2020   % 2 != 0..     
+000135b0: 2020 2023 2050 7954 6f72 6368 2062 6568     # PyTorch beh
+000135c0: 6176 6573 206c 696b 6520 6c69 6272 6f73  aves like libros
+000135d0: 612e 0a20 2020 2020 2020 2023 2068 7474  a..        # htt
+000135e0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+000135f0: 7079 746f 7263 682f 7079 746f 7263 682f  pytorch/pytorch/
+00013600: 6973 7375 6573 2f31 3030 3137 370a 2020  issues/100177.  
+00013610: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
+00013620: 6769 7468 7562 2e63 6f6d 2f61 6c62 6572  github.com/alber
+00013630: 747a 2f70 6c61 7967 726f 756e 642f 626c  tz/playground/bl
+00013640: 6f62 2f6d 6173 7465 722f 7466 5f70 745f  ob/master/tf_pt_
+00013650: 7374 6674 2e70 790a 0a20 2020 2020 2020  stft.py..       
+00013660: 2069 6620 6672 616d 655f 6c65 6e67 7468   if frame_length
+00013670: 203c 2066 6674 5f6c 656e 6774 6820 616e   < fft_length an
+00013680: 6420 7769 6e64 6f77 5f75 7365 5f66 7261  d window_use_fra
+00013690: 6d65 5f6c 656e 6774 683a 0a20 2020 2020  me_length:.     
+000136a0: 2020 2020 2020 2023 2050 7954 6f72 6368         # PyTorch
+000136b0: 2075 7365 7320 7769 6e64 6f77 7320 616c   uses windows al
+000136c0: 7761 7973 206f 6620 7468 6520 6666 745f  ways of the fft_
+000136d0: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
+000136e0: 2020 2020 2320 736f 2074 6865 206f 7574      # so the out
+000136f0: 7075 7420 7365 7120 6c65 6e20 6973 20e2  put seq len is .
+00013700: 8c88 2854 202d 2066 6674 5f6c 656e 6774  ..(T - fft_lengt
+00013710: 6820 2b20 3129 202f 2066 7261 6d65 5f73  h + 1) / frame_s
+00013720: 7465 70e2 8c89 2e0a 2020 2020 2020 2020  tep.....        
+00013730: 2020 2020 2320 5446 2f53 6369 5079 2075      # TF/SciPy u
+00013740: 7365 2077 696e 646f 7773 206f 6620 6672  se windows of fr
+00013750: 616d 655f 6c65 6e67 7468 2c0a 2020 2020  ame_length,.    
+00013760: 2020 2020 2020 2020 2320 736f 2074 6865          # so the
+00013770: 206f 7574 7075 7420 7365 7120 6c65 6e20   output seq len 
+00013780: 6973 20e2 8c88 2854 202d 2066 7261 6d65  is ...(T - frame
+00013790: 5f6c 656e 6774 6820 2b20 3129 202f 2066  _length + 1) / f
+000137a0: 7261 6d65 5f73 7465 70e2 8c89 2e0a 2020  rame_step.....  
+000137b0: 2020 2020 2020 2020 2020 2320 4279 2070            # By p
+000137c0: 6164 6469 6e67 2074 6865 2064 6966 6665  adding the diffe
+000137d0: 7265 6e63 6520 2866 6674 5f6c 656e 6774  rence (fft_lengt
+000137e0: 6820 2d20 6672 616d 655f 6c65 6e67 7468  h - frame_length
+000137f0: 2920 746f 2074 6865 2072 6967 6874 2c0a  ) to the right,.
+00013800: 2020 2020 2020 2020 2020 2020 2320 7765              # we
+00013810: 2067 6574 2074 6865 2073 616d 6520 6f75   get the same ou
+00013820: 7470 7574 2073 6571 206c 656e 6774 6820  tput seq length 
+00013830: 696e 2062 6f74 6820 6361 7365 732e 0a20  in both cases.. 
+00013840: 2020 2020 2020 2020 2020 2078 5f72 6177             x_raw
+00013850: 203d 2074 6f72 6368 2e6e 6e2e 6675 6e63   = torch.nn.func
+00013860: 7469 6f6e 616c 2e70 6164 2878 5f72 6177  tional.pad(x_raw
+00013870: 2c20 2830 2c20 2866 6674 5f6c 656e 6774  , (0, (fft_lengt
+00013880: 6820 2d20 6672 616d 655f 6c65 6e67 7468  h - frame_length
+00013890: 2929 290a 0a20 2020 2020 2020 2069 6620  )))..        if 
+000138a0: 6672 616d 655f 6c65 6e67 7468 203e 2078  frame_length > x
+000138b0: 5f72 6177 2e73 6861 7065 5b31 5d3a 0a20  _raw.shape[1]:. 
+000138c0: 2020 2020 2020 2020 2020 2023 2054 6f72             # Tor
+000138d0: 6368 2064 6f65 7320 6e6f 7420 7265 616c  ch does not real
+000138e0: 6c79 2073 7570 706f 7274 2074 6865 2065  ly support the e
+000138f0: 6d70 7479 2063 6173 652e 0a20 2020 2020  mpty case..     
+00013900: 2020 2020 2020 2079 203d 2054 656e 736f         y = Tenso
+00013910: 7228 2273 7466 7422 2c20 6469 6d73 3d62  r("stft", dims=b
+00013920: 6174 6368 5f64 696d 7320 2b20 5b6f 7574  atch_dims + [out
+00013930: 5f64 696d 2c20 6f75 745f 7370 6174 6961  _dim, out_spatia
+00013940: 6c5f 6469 6d5d 2c20 6665 6174 7572 655f  l_dim], feature_
+00013950: 6469 6d3d 6f75 745f 6469 6d2c 2064 7479  dim=out_dim, dty
+00013960: 7065 3d22 636f 6d70 6c65 7836 3422 290a  pe="complex64").
+00013970: 2020 2020 2020 2020 2020 2020 792e 7261              y.ra
+00013980: 775f 7465 6e73 6f72 203d 2074 6f72 6368  w_tensor = torch
+00013990: 2e7a 6572 6f73 285b 642e 6765 745f 6469  .zeros([d.get_di
+000139a0: 6d5f 7661 6c75 6528 2920 666f 7220 6420  m_value() for d 
+000139b0: 696e 2079 2e64 696d 735d 2c20 6474 7970  in y.dims], dtyp
+000139c0: 653d 746f 7263 682e 636f 6d70 6c65 7836  e=torch.complex6
+000139d0: 3429 0a20 2020 2020 2020 2020 2020 2072  4).            r
+000139e0: 6574 7572 6e20 790a 0a20 2020 2020 2020  eturn y..       
+000139f0: 2069 6620 7769 6e64 6f77 5f65 6e66 6f72   if window_enfor
+00013a00: 6365 5f65 7665 6e3a 0a20 2020 2020 2020  ce_even:.       
+00013a10: 2020 2020 2066 7261 6d65 5f6c 656e 6774       frame_lengt
+00013a20: 6820 2d3d 2066 7261 6d65 5f6c 656e 6774  h -= frame_lengt
+00013a30: 6820 2520 320a 0a20 2020 2020 2020 2077  h % 2..        w
+00013a40: 696e 646f 775f 7074 203d 2074 6f72 6368  indow_pt = torch
+00013a50: 2e68 616e 6e5f 7769 6e64 6f77 2866 7261  .hann_window(fra
+00013a60: 6d65 5f6c 656e 6774 682c 2064 6576 6963  me_length, devic
+00013a70: 653d 785f 7261 772e 6465 7669 6365 290a  e=x_raw.device).
+00013a80: 2020 2020 2020 2020 6966 2066 7261 6d65          if frame
+00013a90: 5f6c 656e 6774 6820 3c20 6666 745f 6c65  _length < fft_le
+00013aa0: 6e67 7468 3a0a 2020 2020 2020 2020 2020  ngth:.          
+00013ab0: 2020 6966 2061 6c69 676e 5f77 696e 646f    if align_windo
+00013ac0: 775f 6c65 6674 3a20 2023 2074 6869 7320  w_left:  # this 
+00013ad0: 6973 2068 6f77 2054 462f 5363 6950 7920  is how TF/SciPy 
+00013ae0: 646f 2069 740a 2020 2020 2020 2020 2020  do it.          
+00013af0: 2020 2020 2020 7769 6e64 6f77 5f70 7420        window_pt 
+00013b00: 3d20 746f 7263 682e 6e6e 2e66 756e 6374  = torch.nn.funct
+00013b10: 696f 6e61 6c2e 7061 6428 7769 6e64 6f77  ional.pad(window
+00013b20: 5f70 742c 2028 302c 2028 6666 745f 6c65  _pt, (0, (fft_le
+00013b30: 6e67 7468 202d 2066 7261 6d65 5f6c 656e  ngth - frame_len
+00013b40: 6774 6829 2929 0a20 2020 2020 2020 2020  gth))).         
+00013b50: 2020 2065 6c73 653a 2020 2320 7468 6973     else:  # this
+00013b60: 2069 7320 686f 7720 5079 546f 7263 682f   is how PyTorch/
+00013b70: 6c69 6272 6f73 6120 646f 2069 740a 2020  librosa do it.  
+00013b80: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00013b90: 645f 6c65 6674 203d 2028 6666 745f 6c65  d_left = (fft_le
+00013ba0: 6e67 7468 202d 2066 7261 6d65 5f6c 656e  ngth - frame_len
+00013bb0: 6774 6829 202f 2f20 320a 2020 2020 2020  gth) // 2.      
+00013bc0: 2020 2020 2020 2020 2020 7061 645f 7269            pad_ri
+00013bd0: 6768 7420 3d20 6666 745f 6c65 6e67 7468  ght = fft_length
+00013be0: 202d 2066 7261 6d65 5f6c 656e 6774 6820   - frame_length 
+00013bf0: 2d20 7061 645f 6c65 6674 0a20 2020 2020  - pad_left.     
+00013c00: 2020 2020 2020 2020 2020 2077 696e 646f             windo
+00013c10: 775f 7074 203d 2074 6f72 6368 2e6e 6e2e  w_pt = torch.nn.
+00013c20: 6675 6e63 7469 6f6e 616c 2e70 6164 2877  functional.pad(w
+00013c30: 696e 646f 775f 7074 2c20 2870 6164 5f6c  indow_pt, (pad_l
+00013c40: 6566 742c 2070 6164 5f72 6967 6874 2929  eft, pad_right))
+00013c50: 0a0a 2020 2020 2020 2020 795f 7261 7720  ..        y_raw 
+00013c60: 3d20 746f 7263 682e 7374 6674 280a 2020  = torch.stft(.  
+00013c70: 2020 2020 2020 2020 2020 785f 7261 772c            x_raw,
+00013c80: 0a20 2020 2020 2020 2020 2020 206e 5f66  .            n_f
+00013c90: 6674 3d66 6674 5f6c 656e 6774 682c 0a20  ft=fft_length,. 
+00013ca0: 2020 2020 2020 2020 2020 2068 6f70 5f6c             hop_l
+00013cb0: 656e 6774 683d 6672 616d 655f 7374 6570  ength=frame_step
+00013cc0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00013cd0: 5079 546f 7263 6820 616e 7977 6179 2075  PyTorch anyway u
+00013ce0: 7365 7320 6120 7769 6e64 6f77 2077 6974  ses a window wit
+00013cf0: 6820 7369 7a65 203d 206e 5f66 6674 2069  h size = n_fft i
+00013d00: 6e74 6572 6e61 6c6c 792e 0a20 2020 2020  nternally..     
+00013d10: 2020 2020 2020 2023 2053 6f20 7765 206a         # So we j
+00013d20: 7573 7420 6578 706c 6963 6974 6c79 2068  ust explicitly h
+00013d30: 616e 646c 6520 7468 6520 7769 6e64 6f77  andle the window
+00013d40: 206c 6f67 6963 2e0a 2020 2020 2020 2020   logic..        
+00013d50: 2020 2020 7769 6e5f 6c65 6e67 7468 3d66      win_length=f
+00013d60: 6674 5f6c 656e 6774 682c 0a20 2020 2020  ft_length,.     
+00013d70: 2020 2020 2020 2077 696e 646f 773d 7769         window=wi
+00013d80: 6e64 6f77 5f70 742c 0a20 2020 2020 2020  ndow_pt,.       
+00013d90: 2020 2020 2063 656e 7465 723d 4661 6c73       center=Fals
+00013da0: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
+00013db0: 6574 7572 6e5f 636f 6d70 6c65 783d 5472  eturn_complex=Tr
+00013dc0: 7565 2c0a 2020 2020 2020 2020 290a 2020  ue,.        ).  
+00013dd0: 2020 2020 2020 7920 3d20 5465 6e73 6f72        y = Tensor
+00013de0: 2822 7374 6674 222c 2064 696d 733d 6261  ("stft", dims=ba
+00013df0: 7463 685f 6469 6d73 202b 205b 6f75 745f  tch_dims + [out_
+00013e00: 6469 6d2c 206f 7574 5f73 7061 7469 616c  dim, out_spatial
+00013e10: 5f64 696d 5d2c 2064 7479 7065 3d54 6f72  _dim], dtype=Tor
+00013e20: 6368 4261 636b 656e 642e 6765 745f 6474  chBackend.get_dt
+00013e30: 7970 655f 6e61 6d65 5f72 6177 2879 5f72  ype_name_raw(y_r
+00013e40: 6177 2929 0a20 2020 2020 2020 2079 2e66  aw)).        y.f
+00013e50: 6561 7475 7265 5f64 696d 203d 206f 7574  eature_dim = out
+00013e60: 5f64 696d 0a20 2020 2020 2020 2079 2e72  _dim.        y.r
+00013e70: 6177 5f74 656e 736f 7220 3d20 746f 7263  aw_tensor = torc
+00013e80: 682e 7265 7368 6170 6528 795f 7261 772c  h.reshape(y_raw,
+00013e90: 205b 642e 6765 745f 6469 6d5f 7661 6c75   [d.get_dim_valu
+00013ea0: 6528 2920 666f 7220 6420 696e 2079 2e64  e() for d in y.d
+00013eb0: 696d 735d 290a 2020 2020 2020 2020 7265  ims]).        re
+00013ec0: 7475 726e 2079 0a0a 2020 2020 4073 7461  turn y..    @sta
+00013ed0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00013ee0: 6620 6c73 746d 280a 2020 2020 2020 2020  f lstm(.        
+00013ef0: 736f 7572 6365 3a20 5f54 542c 0a20 2020  source: _TT,.   
+00013f00: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
+00013f10: 7374 6174 655f 683a 205f 5454 2c0a 2020  state_h: _TT,.  
+00013f20: 2020 2020 2020 7374 6174 655f 633a 205f        state_c: _
+00013f30: 5454 2c0a 2020 2020 2020 2020 6666 5f77  TT,.        ff_w
+00013f40: 6569 6768 743a 205f 5454 2c0a 2020 2020  eight: _TT,.    
+00013f50: 2020 2020 7265 635f 7765 6967 6874 3a20      rec_weight: 
+00013f60: 5f54 542c 0a20 2020 2020 2020 2062 6961  _TT,.        bia
+00013f70: 733a 204f 7074 696f 6e61 6c5b 5f54 545d  s: Optional[_TT]
+00013f80: 2c0a 2020 2020 2020 2020 7370 6174 6961  ,.        spatia
+00013f90: 6c5f 6469 6d3a 2044 696d 2c0a 2020 2020  l_dim: Dim,.    
+00013fa0: 2020 2020 696e 5f64 696d 3a20 4469 6d2c      in_dim: Dim,
+00013fb0: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
+00013fc0: 3a20 4469 6d2c 0a20 2020 2029 202d 3e20  : Dim,.    ) -> 
+00013fd0: 5475 706c 655b 5f54 542c 2054 7570 6c65  Tuple[_TT, Tuple
+00013fe0: 5b5f 5454 2c20 5f54 545d 5d3a 0a20 2020  [_TT, _TT]]:.   
+00013ff0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00014000: 2057 7261 7073 2074 6865 2066 756e 6374   Wraps the funct
+00014010: 696f 6e61 6c20 4c53 544d 2066 726f 6d20  ional LSTM from 
+00014020: 5079 546f 7263 682e 0a0a 2020 2020 2020  PyTorch...      
+00014030: 2020 3a72 6574 7572 6e3a 2054 7570 6c65    :return: Tuple
+00014040: 2063 6f6e 7369 7374 696e 6720 6f66 2074   consisting of t
+00014050: 776f 2065 6c65 6d65 6e74 733a 2074 6865  wo elements: the
+00014060: 2072 6573 756c 7420 6173 2061 203a 636c   result as a :cl
+00014070: 6173 733a 6054 656e 736f 7260 0a20 2020  ass:`Tensor`.   
+00014080: 2020 2020 2020 2020 2061 6e64 2074 6865           and the
+00014090: 206e 6577 2073 7461 7465 2061 7320 6120   new state as a 
+000140a0: 3a63 6c61 7373 3a60 5374 6174 6560 2028  :class:`State` (
+000140b0: 6469 6666 6572 656e 7420 6672 6f6d 2074  different from t
+000140c0: 6865 2070 7265 7669 6f75 7320 6f6e 6529  he previous one)
+000140d0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+000140e0: 2020 2020 2020 7371 7565 657a 655f 7370        squeeze_sp
+000140f0: 6174 6961 6c5f 6469 6d20 3d20 4661 6c73  atial_dim = Fals
+00014100: 650a 2020 2020 2020 2020 6966 2073 7061  e.        if spa
+00014110: 7469 616c 5f64 696d 203d 3d20 7369 6e67  tial_dim == sing
+00014120: 6c65 5f73 7465 705f 6469 6d3a 0a20 2020  le_step_dim:.   
+00014130: 2020 2020 2020 2020 2073 7061 7469 616c           spatial
+00014140: 5f64 696d 203d 2044 696d 2831 2c20 6e61  _dim = Dim(1, na
+00014150: 6d65 3d22 6475 6d6d 792d 7370 6174 6961  me="dummy-spatia
+00014160: 6c2d 6469 6d2d 7369 6e67 6c65 2d73 7465  l-dim-single-ste
+00014170: 7022 290a 2020 2020 2020 2020 2020 2020  p").            
+00014180: 736f 7572 6365 203d 2073 6f75 7263 652e  source = source.
+00014190: 636f 7079 5f61 6464 5f64 696d 5f62 795f  copy_add_dim_by_
+000141a0: 7461 6728 7370 6174 6961 6c5f 6469 6d2c  tag(spatial_dim,
+000141b0: 2075 6e62 726f 6164 6361 7374 3d54 7275   unbroadcast=Tru
+000141c0: 652c 2061 7869 733d 3029 0a20 2020 2020  e, axis=0).     
+000141d0: 2020 2020 2020 2073 7175 6565 7a65 5f73         squeeze_s
+000141e0: 7061 7469 616c 5f64 696d 203d 2054 7275  patial_dim = Tru
+000141f0: 650a 0a20 2020 2020 2020 2023 2054 6865  e..        # The
+00014200: 206f 7264 6572 2069 6e20 7468 6520 7061   order in the pa
+00014210: 7261 6d65 7465 7273 2066 6f72 206c 7374  rameters for lst
+00014220: 6d5f 7061 7261 6d73 2069 7320 7370 6563  m_params is spec
+00014230: 6966 6965 6420 6173 2066 6f6c 6c6f 7773  ified as follows
+00014240: 3a0a 2020 2020 2020 2020 2320 4665 6564  :.        # Feed
+00014250: 2d66 6f72 7761 7264 2068 6173 2070 7269  -forward has pri
+00014260: 6f72 6974 7920 6f76 6572 2072 6563 7572  ority over recur
+00014270: 7265 6e74 2c20 616e 6420 7765 6967 6874  rent, and weight
+00014280: 7320 6861 7665 2070 7269 6f72 6974 7920  s have priority 
+00014290: 6f76 6572 2062 6961 7365 733a 2028 775f  over biases: (w_
+000142a0: 6968 2c20 775f 6868 2c20 625f 6968 2c20  ih, w_hh, b_ih, 
+000142b0: 625f 6868 292e 0a20 2020 2020 2020 2023  b_hh)..        #
+000142c0: 2053 6565 2068 7474 7073 3a2f 2f67 6974   See https://git
+000142d0: 6875 622e 636f 6d2f 7079 746f 7263 682f  hub.com/pytorch/
+000142e0: 7079 746f 7263 682f 626c 6f62 2f63 3236  pytorch/blob/c26
+000142f0: 3362 6434 332f 746f 7263 682f 6e6e 2f6d  3bd43/torch/nn/m
+00014300: 6f64 756c 6573 2f72 6e6e 2e70 7923 4c31  odules/rnn.py#L1
+00014310: 3037 2e0a 2020 2020 2020 2020 2320 416c  07..        # Al
+00014320: 7465 726e 6174 6976 656c 7920 7365 6520  ternatively see 
+00014330: 7468 6520 696d 706c 656d 656e 7461 7469  the implementati
+00014340: 6f6e 206f 6620 4c53 544d 4365 6c6c 3a0a  on of LSTMCell:.
+00014350: 2020 2020 2020 2020 2320 6874 7470 733a          # https:
+00014360: 2f2f 6769 7468 7562 2e63 6f6d 2f70 7974  //github.com/pyt
+00014370: 6f72 6368 2f70 7974 6f72 6368 2f62 6c6f  orch/pytorch/blo
+00014380: 622f 3462 6561 6436 342f 6174 656e 2f73  b/4bead64/aten/s
+00014390: 7263 2f41 5465 6e2f 6e61 7469 7665 2f52  rc/ATen/native/R
+000143a0: 4e4e 2e63 7070 234c 3134 3538 2e0a 2020  NN.cpp#L1458..  
+000143b0: 2020 2020 2020 6966 2062 6961 7320 6973        if bias is
+000143c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000143d0: 2020 206c 7374 6d5f 7061 7261 6d73 203d     lstm_params =
+000143e0: 2028 6666 5f77 6569 6768 742e 7261 775f   (ff_weight.raw_
+000143f0: 7465 6e73 6f72 2c20 7265 635f 7765 6967  tensor, rec_weig
+00014400: 6874 2e72 6177 5f74 656e 736f 7229 0a20  ht.raw_tensor). 
+00014410: 2020 2020 2020 2020 2020 2068 6173 5f62             has_b
+00014420: 6961 7365 7320 3d20 4661 6c73 650a 2020  iases = False.  
+00014430: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00014440: 2020 2020 2020 2020 2320 4e6f 7465 2074          # Note t
+00014450: 6861 7420 7468 6520 6d61 7468 656d 6174  hat the mathemat
+00014460: 6963 616c 2064 6566 696e 6974 696f 6e20  ical definition 
+00014470: 6f66 2074 6865 206d 6f64 656c 2064 6f65  of the model doe
+00014480: 7320 6e6f 7420 7265 7175 6972 6520 7477  s not require tw
+00014490: 6f20 6269 6173 2074 6572 6d73 2e0a 2020  o bias terms..  
+000144a0: 2020 2020 2020 2020 2020 2320 5079 546f            # PyTo
+000144b0: 7263 6820 6a75 7374 2066 6f6c 6c6f 7773  rch just follows
+000144c0: 2077 6861 7420 4375 444e 4e20 646f 6573   what CuDNN does
+000144d0: 2068 6572 652e 0a20 2020 2020 2020 2020   here..         
+000144e0: 2020 2023 2049 2064 6f6e 2774 2072 6561     # I don't rea
+000144f0: 6c6c 7920 756e 6465 7273 7461 6e64 2077  lly understand w
+00014500: 6879 2043 7544 4e4e 2068 6176 6520 7477  hy CuDNN have tw
+00014510: 6f20 6269 6173 2074 6572 6d73 3a0a 2020  o bias terms:.  
+00014520: 2020 2020 2020 2020 2020 2320 6874 7470            # http
+00014530: 733a 2f2f 7374 6163 6b6f 7665 7266 6c6f  s://stackoverflo
+00014540: 772e 636f 6d2f 7175 6573 7469 6f6e 732f  w.com/questions/
+00014550: 3736 3035 3138 3030 2f77 6879 2d64 6f65  76051800/why-doe
+00014560: 732d 7468 652d 6375 646e 6e2d 6c73 746d  s-the-cudnn-lstm
+00014570: 2d72 6571 7569 7265 732d 7477 6f2d 6269  -requires-two-bi
+00014580: 6173 6573 2d62 2d69 682d 616e 642d 622d  ases-b-ih-and-b-
+00014590: 6868 0a20 2020 2020 2020 2020 2020 2023  hh.            #
+000145a0: 2049 7420 6c6f 6f6b 7320 6c69 6b65 2061   It looks like a
+000145b0: 6e20 6f76 6572 7369 6768 7420 6279 2074  n oversight by t
+000145c0: 6865 2043 7544 4e4e 2064 6576 732e 0a20  he CuDNN devs.. 
+000145d0: 2020 2020 2020 2020 2020 2023 2049 276d             # I'm
+000145e0: 206e 6f74 2073 7572 6520 6966 2074 6865   not sure if the
+000145f0: 2074 776f 2062 6961 7320 7465 726d 7320   two bias terms 
+00014600: 6765 7420 7468 6520 7361 6d65 2067 7261  get the same gra
+00014610: 6469 656e 7420 6f72 206e 6f74 2e0a 2020  dient or not..  
+00014620: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+00014630: 6865 7920 646f 206e 6f74 2c20 7468 6174  hey do not, that
+00014640: 2077 6f75 6c64 2062 6520 6d61 7468 656d   would be mathem
+00014650: 6174 6963 616c 2069 6e63 6f72 7265 6374  atical incorrect
+00014660: 2c20 6275 7420 6d61 7962 6520 7468 6174  , but maybe that
+00014670: 2773 2068 6f77 2043 7544 4e4e 2077 6f72  's how CuDNN wor
+00014680: 6b73 2e0a 2020 2020 2020 2020 2020 2020  ks..            
+00014690: 2320 546f 2072 6561 6c6c 7920 6765 7420  # To really get 
+000146a0: 626f 7468 2067 7261 6469 656e 7473 2c20  both gradients, 
+000146b0: 7765 2064 6f6e 2774 206a 7573 7420 7365  we don't just se
+000146c0: 7420 6f6e 6520 6269 6173 2074 6f20 7a65  t one bias to ze
+000146d0: 726f 2c20 6275 7420 7765 2075 7365 2030  ro, but we use 0
+000146e0: 2e35 202a 2062 6961 7320 666f 7220 626f  .5 * bias for bo
+000146f0: 7468 2e0a 2020 2020 2020 2020 2020 2020  th..            
+00014700: 6269 6173 5f72 6177 203d 2062 6961 732e  bias_raw = bias.
+00014710: 7261 775f 7465 6e73 6f72 202a 2030 2e35  raw_tensor * 0.5
+00014720: 0a20 2020 2020 2020 2020 2020 206c 7374  .            lst
+00014730: 6d5f 7061 7261 6d73 203d 2028 0a20 2020  m_params = (.   
+00014740: 2020 2020 2020 2020 2020 2020 2066 665f               ff_
+00014750: 7765 6967 6874 2e72 6177 5f74 656e 736f  weight.raw_tenso
+00014760: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00014770: 2020 2072 6563 5f77 6569 6768 742e 7261     rec_weight.ra
+00014780: 775f 7465 6e73 6f72 2c0a 2020 2020 2020  w_tensor,.      
+00014790: 2020 2020 2020 2020 2020 6269 6173 5f72            bias_r
+000147a0: 6177 2c0a 2020 2020 2020 2020 2020 2020  aw,.            
+000147b0: 2020 2020 6269 6173 5f72 6177 2c0a 2020      bias_raw,.  
+000147c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000147d0: 2020 2020 2020 2020 6861 735f 6269 6173          has_bias
+000147e0: 6573 203d 2054 7275 650a 0a20 2020 2020  es = True..     
+000147f0: 2020 2062 6174 6368 5f64 696d 7320 3d20     batch_dims = 
+00014800: 5b64 2066 6f72 2064 2069 6e20 736f 7572  [d for d in sour
+00014810: 6365 2e64 696d 7320 6966 2064 2021 3d20  ce.dims if d != 
+00014820: 7370 6174 6961 6c5f 6469 6d20 616e 6420  spatial_dim and 
+00014830: 6420 213d 2069 6e5f 6469 6d5d 0a20 2020  d != in_dim].   
+00014840: 2020 2020 2073 6f75 7263 6520 3d20 736f       source = so
+00014850: 7572 6365 2e63 6f70 795f 7472 616e 7370  urce.copy_transp
+00014860: 6f73 6528 5b73 7061 7469 616c 5f64 696d  ose([spatial_dim
+00014870: 5d20 2b20 6261 7463 685f 6469 6d73 202b  ] + batch_dims +
+00014880: 205b 696e 5f64 696d 5d29 0a20 2020 2020   [in_dim]).     
+00014890: 2020 2073 7461 7465 5f68 203d 2073 7461     state_h = sta
+000148a0: 7465 5f68 2e63 6f70 795f 7472 616e 7370  te_h.copy_transp
+000148b0: 6f73 6528 6261 7463 685f 6469 6d73 202b  ose(batch_dims +
+000148c0: 205b 6f75 745f 6469 6d5d 290a 2020 2020   [out_dim]).    
+000148d0: 2020 2020 7374 6174 655f 6320 3d20 7374      state_c = st
+000148e0: 6174 655f 632e 636f 7079 5f74 7261 6e73  ate_c.copy_trans
+000148f0: 706f 7365 2862 6174 6368 5f64 696d 7320  pose(batch_dims 
+00014900: 2b20 5b6f 7574 5f64 696d 5d29 0a0a 2020  + [out_dim])..  
+00014910: 2020 2020 2020 736f 7572 6365 5f72 6177        source_raw
+00014920: 203d 2073 6f75 7263 652e 7261 775f 7465   = source.raw_te
+00014930: 6e73 6f72 0a20 2020 2020 2020 2073 7461  nsor.        sta
+00014940: 7465 5f68 5f72 6177 203d 2073 7461 7465  te_h_raw = state
+00014950: 5f68 2e72 6177 5f74 656e 736f 720a 2020  _h.raw_tensor.  
+00014960: 2020 2020 2020 7374 6174 655f 635f 7261        state_c_ra
+00014970: 7720 3d20 7374 6174 655f 632e 7261 775f  w = state_c.raw_
+00014980: 7465 6e73 6f72 0a20 2020 2020 2020 2062  tensor.        b
+00014990: 6174 6368 5f64 696d 203d 2074 6f72 6368  atch_dim = torch
+000149a0: 2e70 726f 6428 746f 7263 682e 7465 6e73  .prod(torch.tens
+000149b0: 6f72 285b 642e 6765 745f 6469 6d5f 7661  or([d.get_dim_va
+000149c0: 6c75 6528 2920 666f 7220 6420 696e 2062  lue() for d in b
+000149d0: 6174 6368 5f64 696d 735d 2929 2069 6620  atch_dims])) if 
+000149e0: 6261 7463 685f 6469 6d73 2065 6c73 6520  batch_dims else 
+000149f0: 310a 2020 2020 2020 2020 6966 206c 656e  1.        if len
+00014a00: 2862 6174 6368 5f64 696d 7329 2021 3d20  (batch_dims) != 
+00014a10: 313a 0a20 2020 2020 2020 2020 2020 2023  1:.            #
+00014a20: 2054 6f72 6368 204c 5354 4d20 6578 7065   Torch LSTM expe
+00014a30: 6374 7320 2873 6571 5f6c 656e 2c20 6261  cts (seq_len, ba
+00014a40: 7463 682c 2069 6e70 7574 5f73 697a 6529  tch, input_size)
+00014a50: 2061 7320 7368 6170 652e 0a20 2020 2020   as shape..     
+00014a60: 2020 2020 2020 2023 2057 6520 6e65 6564         # We need
+00014a70: 2074 6f20 6d65 7267 6520 616c 6c20 6261   to merge all ba
+00014a80: 7463 6820 6469 6d73 2074 6f67 6574 6865  tch dims togethe
+00014a90: 722e 0a20 2020 2020 2020 2020 2020 2073  r..            s
+00014aa0: 6f75 7263 655f 7261 7720 3d20 746f 7263  ource_raw = torc
+00014ab0: 682e 7265 7368 6170 6528 0a20 2020 2020  h.reshape(.     
+00014ac0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+00014ad0: 655f 7261 772c 205b 7370 6174 6961 6c5f  e_raw, [spatial_
+00014ae0: 6469 6d2e 6765 745f 6469 6d5f 7661 6c75  dim.get_dim_valu
+00014af0: 6528 295d 202b 205b 6261 7463 685f 6469  e()] + [batch_di
+00014b00: 6d5d 202b 205b 696e 5f64 696d 2e67 6574  m] + [in_dim.get
+00014b10: 5f64 696d 5f76 616c 7565 2829 5d0a 2020  _dim_value()].  
+00014b20: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00014b30: 2020 2020 2320 546f 7263 6820 4c53 544d      # Torch LSTM
+00014b40: 2065 7870 6563 7473 2028 6e75 6d5f 6c61   expects (num_la
+00014b50: 7965 7273 202a 206e 756d 5f64 6972 6563  yers * num_direc
+00014b60: 7469 6f6e 732c 2062 6174 6368 2c20 6869  tions, batch, hi
+00014b70: 6464 656e 5f73 697a 6529 2061 7320 7368  dden_size) as sh
+00014b80: 6170 652e 0a20 2020 2020 2020 2073 7461  ape..        sta
+00014b90: 7465 5f68 5f72 6177 203d 2074 6f72 6368  te_h_raw = torch
+00014ba0: 2e72 6573 6861 7065 2873 7461 7465 5f68  .reshape(state_h
+00014bb0: 5f72 6177 2c20 5b31 2c20 6261 7463 685f  _raw, [1, batch_
+00014bc0: 6469 6d2c 206f 7574 5f64 696d 2e67 6574  dim, out_dim.get
+00014bd0: 5f64 696d 5f76 616c 7565 2829 5d29 0a20  _dim_value()]). 
+00014be0: 2020 2020 2020 2073 7461 7465 5f63 5f72         state_c_r
+00014bf0: 6177 203d 2074 6f72 6368 2e72 6573 6861  aw = torch.resha
+00014c00: 7065 2873 7461 7465 5f63 5f72 6177 2c20  pe(state_c_raw, 
+00014c10: 5b31 2c20 6261 7463 685f 6469 6d2c 206f  [1, batch_dim, o
+00014c20: 7574 5f64 696d 2e67 6574 5f64 696d 5f76  ut_dim.get_dim_v
+00014c30: 616c 7565 2829 5d29 0a0a 2020 2020 2020  alue()])..      
+00014c40: 2020 7369 7a65 7320 3d20 7370 6174 6961    sizes = spatia
+00014c50: 6c5f 6469 6d2e 6765 745f 7369 7a65 5f74  l_dim.get_size_t
+00014c60: 656e 736f 7228 290a 2020 2020 2020 2020  ensor().        
+00014c70: 7369 7a65 7320 3d20 7369 7a65 732e 636f  sizes = sizes.co
+00014c80: 7079 5f63 6f6d 7061 7469 626c 655f 746f  py_compatible_to
+00014c90: 280a 2020 2020 2020 2020 2020 2020 5465  (.            Te
+00014ca0: 6e73 6f72 2822 6261 7463 685f 6469 6d73  nsor("batch_dims
+00014cb0: 222c 2062 6174 6368 5f64 696d 732c 2064  ", batch_dims, d
+00014cc0: 7479 7065 3d73 697a 6573 2e64 7479 7065  type=sizes.dtype
+00014cd0: 292c 2075 6e62 726f 6164 6361 7374 3d54  ), unbroadcast=T
+00014ce0: 7275 652c 2063 6865 636b 5f73 7061 7273  rue, check_spars
+00014cf0: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
+00014d00: 290a 2020 2020 2020 2020 7369 7a65 735f  ).        sizes_
+00014d10: 7261 7720 3d20 746f 7263 682e 7265 7368  raw = torch.resh
+00014d20: 6170 6528 7369 7a65 732e 7261 775f 7465  ape(sizes.raw_te
+00014d30: 6e73 6f72 2c20 5b62 6174 6368 5f64 696d  nsor, [batch_dim
+00014d40: 5d29 0a0a 2020 2020 2020 2020 2320 5365  ])..        # Se
+00014d50: 6520 7468 6520 636f 6465 206f 6620 746f  e the code of to
+00014d60: 7263 682e 6e6e 2e4c 5354 4d20 666f 7220  rch.nn.LSTM for 
+00014d70: 736f 7274 696e 6720 7468 6520 6261 7463  sorting the batc
+00014d80: 6820 6469 6d73 2e0a 2020 2020 2020 2020  h dims..        
+00014d90: 2320 5765 206e 6565 6420 7061 636b 5f70  # We need pack_p
+00014da0: 6164 6465 645f 7365 7175 656e 6365 2062  added_sequence b
+00014db0: 6563 6175 7365 206f 7468 6572 7769 7365  ecause otherwise
+00014dc0: 2074 6865 204c 5354 4d20 776f 756c 6420   the LSTM would 
+00014dd0: 6967 6e6f 7265 2074 6865 2070 6164 6469  ignore the paddi
+00014de0: 6e67 2c0a 2020 2020 2020 2020 2320 616e  ng,.        # an
+00014df0: 6420 7765 2077 6f75 6c64 2067 6574 2069  d we would get i
+00014e00: 6e63 6f72 7265 6374 2066 696e 616c 2073  ncorrect final s
+00014e10: 7461 7465 732e 0a20 2020 2020 2020 2073  tates..        s
+00014e20: 6f75 7263 655f 7061 636b 6564 203d 2074  ource_packed = t
+00014e30: 6f72 6368 2e6e 6e2e 7574 696c 732e 726e  orch.nn.utils.rn
+00014e40: 6e2e 7061 636b 5f70 6164 6465 645f 7365  n.pack_padded_se
+00014e50: 7175 656e 6365 2873 6f75 7263 655f 7261  quence(source_ra
+00014e60: 772c 2073 697a 6573 5f72 6177 2c20 656e  w, sizes_raw, en
+00014e70: 666f 7263 655f 736f 7274 6564 3d46 616c  force_sorted=Fal
+00014e80: 7365 290a 2020 2020 2020 2020 7374 6174  se).        stat
+00014e90: 655f 685f 7261 7720 3d20 7374 6174 655f  e_h_raw = state_
+00014ea0: 685f 7261 772e 696e 6465 785f 7365 6c65  h_raw.index_sele
+00014eb0: 6374 2864 696d 3d31 2c20 696e 6465 783d  ct(dim=1, index=
+00014ec0: 736f 7572 6365 5f70 6163 6b65 642e 736f  source_packed.so
+00014ed0: 7274 6564 5f69 6e64 6963 6573 290a 2020  rted_indices).  
+00014ee0: 2020 2020 2020 7374 6174 655f 635f 7261        state_c_ra
+00014ef0: 7720 3d20 7374 6174 655f 635f 7261 772e  w = state_c_raw.
+00014f00: 696e 6465 785f 7365 6c65 6374 2864 696d  index_select(dim
+00014f10: 3d31 2c20 696e 6465 783d 736f 7572 6365  =1, index=source
+00014f20: 5f70 6163 6b65 642e 736f 7274 6564 5f69  _packed.sorted_i
+00014f30: 6e64 6963 6573 290a 0a20 2020 2020 2020  ndices)..       
+00014f40: 206f 7574 5f72 6177 2c20 6e65 775f 7374   out_raw, new_st
+00014f50: 6174 655f 685f 7261 772c 206e 6577 5f73  ate_h_raw, new_s
+00014f60: 7461 7465 5f63 5f72 6177 203d 2074 6f72  tate_c_raw = tor
+00014f70: 6368 2e6c 7374 6d28 0a20 2020 2020 2020  ch.lstm(.       
+00014f80: 2020 2020 2073 6f75 7263 655f 7061 636b       source_pack
+00014f90: 6564 2e64 6174 612c 0a20 2020 2020 2020  ed.data,.       
+00014fa0: 2020 2020 2073 6f75 7263 655f 7061 636b       source_pack
+00014fb0: 6564 2e62 6174 6368 5f73 697a 6573 2c0a  ed.batch_sizes,.
+00014fc0: 2020 2020 2020 2020 2020 2020 2873 7461              (sta
+00014fd0: 7465 5f68 5f72 6177 2c20 7374 6174 655f  te_h_raw, state_
+00014fe0: 635f 7261 7729 2c0a 2020 2020 2020 2020  c_raw),.        
+00014ff0: 2020 2020 6c73 746d 5f70 6172 616d 732c      lstm_params,
+00015000: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
+00015010: 5f62 6961 7365 733d 6861 735f 6269 6173  _biases=has_bias
+00015020: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00015030: 6e75 6d5f 6c61 7965 7273 3d31 2c0a 2020  num_layers=1,.  
+00015040: 2020 2020 2020 2020 2020 6472 6f70 6f75            dropou
+00015050: 743d 302e 302c 0a20 2020 2020 2020 2020  t=0.0,.         
+00015060: 2020 2074 7261 696e 3d72 662e 6765 745f     train=rf.get_
+00015070: 7275 6e5f 6374 7828 292e 7472 6169 6e5f  run_ctx().train_
+00015080: 666c 6167 2c0a 2020 2020 2020 2020 2020  flag,.          
+00015090: 2020 6269 6469 7265 6374 696f 6e61 6c3d    bidirectional=
+000150a0: 4661 6c73 652c 0a20 2020 2020 2020 2029  False,.        )
+000150b0: 0a0a 2020 2020 2020 2020 2320 556e 736f  ..        # Unso
+000150c0: 7274 2074 6865 2062 6174 6368 2064 696d  rt the batch dim
+000150d0: 732e 0a20 2020 2020 2020 206e 6577 5f73  s..        new_s
+000150e0: 7461 7465 5f68 5f72 6177 203d 206e 6577  tate_h_raw = new
+000150f0: 5f73 7461 7465 5f68 5f72 6177 2e69 6e64  _state_h_raw.ind
+00015100: 6578 5f73 656c 6563 7428 6469 6d3d 312c  ex_select(dim=1,
+00015110: 2069 6e64 6578 3d73 6f75 7263 655f 7061   index=source_pa
+00015120: 636b 6564 2e75 6e73 6f72 7465 645f 696e  cked.unsorted_in
+00015130: 6469 6365 7329 0a20 2020 2020 2020 206e  dices).        n
+00015140: 6577 5f73 7461 7465 5f63 5f72 6177 203d  ew_state_c_raw =
+00015150: 206e 6577 5f73 7461 7465 5f63 5f72 6177   new_state_c_raw
+00015160: 2e69 6e64 6578 5f73 656c 6563 7428 6469  .index_select(di
+00015170: 6d3d 312c 2069 6e64 6578 3d73 6f75 7263  m=1, index=sourc
+00015180: 655f 7061 636b 6564 2e75 6e73 6f72 7465  e_packed.unsorte
+00015190: 645f 696e 6469 6365 7329 0a20 2020 2020  d_indices).     
+000151a0: 2020 2023 2055 6e70 6163 6b20 7468 6520     # Unpack the 
+000151b0: 7365 7175 656e 6365 2e0a 2020 2020 2020  sequence..      
+000151c0: 2020 6f75 7470 7574 5f70 6163 6b65 6420    output_packed 
+000151d0: 3d20 746f 7263 682e 6e6e 2e75 7469 6c73  = torch.nn.utils
+000151e0: 2e72 6e6e 2e50 6163 6b65 6453 6571 7565  .rnn.PackedSeque
+000151f0: 6e63 6528 0a20 2020 2020 2020 2020 2020  nce(.           
+00015200: 206f 7574 5f72 6177 2c0a 2020 2020 2020   out_raw,.      
+00015210: 2020 2020 2020 6261 7463 685f 7369 7a65        batch_size
+00015220: 733d 736f 7572 6365 5f70 6163 6b65 642e  s=source_packed.
+00015230: 6261 7463 685f 7369 7a65 732c 0a20 2020  batch_sizes,.   
+00015240: 2020 2020 2020 2020 2073 6f72 7465 645f           sorted_
+00015250: 696e 6469 6365 733d 736f 7572 6365 5f70  indices=source_p
+00015260: 6163 6b65 642e 736f 7274 6564 5f69 6e64  acked.sorted_ind
+00015270: 6963 6573 2c0a 2020 2020 2020 2020 2020  ices,.          
+00015280: 2020 756e 736f 7274 6564 5f69 6e64 6963    unsorted_indic
+00015290: 6573 3d73 6f75 7263 655f 7061 636b 6564  es=source_packed
+000152a0: 2e75 6e73 6f72 7465 645f 696e 6469 6365  .unsorted_indice
+000152b0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+000152c0: 2020 2020 206f 7574 5f72 6177 203d 2074       out_raw = t
+000152d0: 6f72 6368 2e6e 6e2e 7574 696c 732e 726e  orch.nn.utils.rn
+000152e0: 6e2e 7061 645f 7061 636b 6564 5f73 6571  n.pad_packed_seq
+000152f0: 7565 6e63 6528 6f75 7470 7574 5f70 6163  uence(output_pac
+00015300: 6b65 6429 5b30 5d0a 0a20 2020 2020 2020  ked)[0]..       
+00015310: 2069 6620 6c65 6e28 6261 7463 685f 6469   if len(batch_di
+00015320: 6d73 2920 213d 2031 3a0a 2020 2020 2020  ms) != 1:.      
+00015330: 2020 2020 2020 6f75 745f 7261 7720 3d20        out_raw = 
+00015340: 746f 7263 682e 7265 7368 6170 6528 0a20  torch.reshape(. 
+00015350: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00015360: 7574 5f72 6177 2c0a 2020 2020 2020 2020  ut_raw,.        
+00015370: 2020 2020 2020 2020 5b73 7061 7469 616c          [spatial
+00015380: 5f64 696d 2e67 6574 5f64 696d 5f76 616c  _dim.get_dim_val
+00015390: 7565 2829 5d20 2b20 5b64 2e67 6574 5f64  ue()] + [d.get_d
+000153a0: 696d 5f76 616c 7565 2829 2066 6f72 2064  im_value() for d
+000153b0: 2069 6e20 6261 7463 685f 6469 6d73 5d20   in batch_dims] 
+000153c0: 2b20 5b6f 7574 5f64 696d 2e67 6574 5f64  + [out_dim.get_d
+000153d0: 696d 5f76 616c 7565 2829 5d2c 0a20 2020  im_value()],.   
+000153e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000153f0: 2020 206e 6577 5f73 7461 7465 5f68 5f72     new_state_h_r
+00015400: 6177 203d 2074 6f72 6368 2e72 6573 6861  aw = torch.resha
+00015410: 7065 286e 6577 5f73 7461 7465 5f68 5f72  pe(new_state_h_r
+00015420: 6177 2c20 5b64 2e67 6574 5f64 696d 5f76  aw, [d.get_dim_v
+00015430: 616c 7565 2829 2066 6f72 2064 2069 6e20  alue() for d in 
+00015440: 7374 6174 655f 682e 6469 6d73 5d29 0a20  state_h.dims]). 
+00015450: 2020 2020 2020 206e 6577 5f73 7461 7465         new_state
+00015460: 5f63 5f72 6177 203d 2074 6f72 6368 2e72  _c_raw = torch.r
+00015470: 6573 6861 7065 286e 6577 5f73 7461 7465  eshape(new_state
+00015480: 5f63 5f72 6177 2c20 5b64 2e67 6574 5f64  _c_raw, [d.get_d
+00015490: 696d 5f76 616c 7565 2829 2066 6f72 2064  im_value() for d
+000154a0: 2069 6e20 7374 6174 655f 632e 6469 6d73   in state_c.dims
+000154b0: 5d29 0a0a 2020 2020 2020 2020 6f75 7420  ])..        out 
+000154c0: 3d20 736f 7572 6365 2e63 6f70 795f 7465  = source.copy_te
+000154d0: 6d70 6c61 7465 5f72 6570 6c61 6365 5f64  mplate_replace_d
+000154e0: 696d 5f74 6167 2861 7869 733d 2d31 2c20  im_tag(axis=-1, 
+000154f0: 6e65 775f 6469 6d5f 7461 673d 6f75 745f  new_dim_tag=out_
+00015500: 6469 6d2c 206e 616d 653d 226c 7374 6d22  dim, name="lstm"
+00015510: 290a 2020 2020 2020 2020 6f75 742e 6665  ).        out.fe
+00015520: 6174 7572 655f 6469 6d20 3d20 6f75 745f  ature_dim = out_
+00015530: 6469 6d0a 2020 2020 2020 2020 6f75 742e  dim.        out.
+00015540: 7261 775f 7465 6e73 6f72 203d 206f 7574  raw_tensor = out
+00015550: 5f72 6177 0a0a 2020 2020 2020 2020 6e65  _raw..        ne
+00015560: 775f 7374 6174 655f 6820 3d20 7374 6174  w_state_h = stat
+00015570: 655f 682e 636f 7079 5f74 656d 706c 6174  e_h.copy_templat
+00015580: 6528 290a 2020 2020 2020 2020 6e65 775f  e().        new_
+00015590: 7374 6174 655f 682e 7261 775f 7465 6e73  state_h.raw_tens
+000155a0: 6f72 203d 206e 6577 5f73 7461 7465 5f68  or = new_state_h
+000155b0: 5f72 6177 0a20 2020 2020 2020 206e 6577  _raw.        new
+000155c0: 5f73 7461 7465 5f68 2e66 6561 7475 7265  _state_h.feature
+000155d0: 5f64 696d 203d 206f 7574 5f64 696d 0a20  _dim = out_dim. 
+000155e0: 2020 2020 2020 206e 6577 5f73 7461 7465         new_state
+000155f0: 5f63 203d 2073 7461 7465 5f63 2e63 6f70  _c = state_c.cop
+00015600: 795f 7465 6d70 6c61 7465 2829 0a20 2020  y_template().   
+00015610: 2020 2020 206e 6577 5f73 7461 7465 5f63       new_state_c
+00015620: 2e72 6177 5f74 656e 736f 7220 3d20 6e65  .raw_tensor = ne
+00015630: 775f 7374 6174 655f 635f 7261 770a 2020  w_state_c_raw.  
+00015640: 2020 2020 2020 6e65 775f 7374 6174 655f        new_state_
+00015650: 632e 6665 6174 7572 655f 6469 6d20 3d20  c.feature_dim = 
+00015660: 6f75 745f 6469 6d0a 0a20 2020 2020 2020  out_dim..       
+00015670: 2069 6620 7371 7565 657a 655f 7370 6174   if squeeze_spat
+00015680: 6961 6c5f 6469 6d3a 0a20 2020 2020 2020  ial_dim:.       
+00015690: 2020 2020 206f 7574 203d 206f 7574 2e63       out = out.c
+000156a0: 6f70 795f 7371 7565 657a 655f 6178 6573  opy_squeeze_axes
+000156b0: 285b 6f75 742e 6765 745f 6178 6973 5f66  ([out.get_axis_f
+000156c0: 726f 6d5f 6465 7363 7269 7074 696f 6e28  rom_description(
+000156d0: 7370 6174 6961 6c5f 6469 6d29 5d29 0a0a  spatial_dim)])..
+000156e0: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+000156f0: 7574 2c20 286e 6577 5f73 7461 7465 5f68  ut, (new_state_h
+00015700: 2c20 6e65 775f 7374 6174 655f 6329 0a0a  , new_state_c)..
+00015710: 2020 2020 5465 6e73 6f72 4172 7261 7954      TensorArrayT
+00015720: 7970 6520 3d20 4c69 7374 5b54 656e 736f  ype = List[Tenso
+00015730: 725d 0a0a 2020 2020 4073 7461 7469 636d  r]..    @staticm
+00015740: 6574 686f 640a 2020 2020 6465 6620 7465  ethod.    def te
+00015750: 6e73 6f72 5f61 7272 6179 5f75 6e73 7461  nsor_array_unsta
+00015760: 636b 2874 656e 736f 723a 2054 656e 736f  ck(tensor: Tenso
+00015770: 722c 202a 2c20 6178 6973 3a20 4469 6d29  r, *, axis: Dim)
+00015780: 202d 3e20 5465 6e73 6f72 4172 7261 7954   -> TensorArrayT
+00015790: 7970 653a 0a20 2020 2020 2020 2022 2222  ype:.        """
+000157a0: 756e 7374 6163 6b22 2222 0a20 2020 2020  unstack""".     
+000157b0: 2020 2061 7869 735f 696e 7420 3d20 7465     axis_int = te
+000157c0: 6e73 6f72 2e67 6574 5f61 7869 735f 6672  nsor.get_axis_fr
+000157d0: 6f6d 5f64 6573 6372 6970 7469 6f6e 2861  om_description(a
+000157e0: 7869 7329 0a20 2020 2020 2020 206f 7574  xis).        out
+000157f0: 5f74 656e 736f 7273 5f72 6177 203d 2074  _tensors_raw = t
+00015800: 6f72 6368 2e75 6e62 696e 6428 7465 6e73  orch.unbind(tens
+00015810: 6f72 2e72 6177 5f74 656e 736f 722c 2064  or.raw_tensor, d
+00015820: 696d 3d61 7869 735f 696e 7429 0a20 2020  im=axis_int).   
+00015830: 2020 2020 206f 7574 5f74 656e 736f 725f       out_tensor_
+00015840: 7465 6d70 6c61 7465 203d 2074 656e 736f  template = tenso
+00015850: 722e 636f 7079 5f74 656d 706c 6174 6528  r.copy_template(
+00015860: 292e 636f 7079 5f74 656d 706c 6174 655f  ).copy_template_
+00015870: 6578 636c 7564 696e 675f 6178 6973 2861  excluding_axis(a
+00015880: 7869 735f 696e 7429 0a20 2020 2020 2020  xis_int).       
+00015890: 206f 7574 5f74 656e 736f 7273 203d 205b   out_tensors = [
+000158a0: 5d0a 2020 2020 2020 2020 666f 7220 6f75  ].        for ou
+000158b0: 745f 7465 6e73 6f72 5f72 6177 2069 6e20  t_tensor_raw in 
+000158c0: 6f75 745f 7465 6e73 6f72 735f 7261 773a  out_tensors_raw:
+000158d0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+000158e0: 5f74 656e 736f 7220 3d20 6f75 745f 7465  _tensor = out_te
+000158f0: 6e73 6f72 5f74 656d 706c 6174 652e 636f  nsor_template.co
+00015900: 7079 5f74 656d 706c 6174 6528 290a 2020  py_template().  
+00015910: 2020 2020 2020 2020 2020 6f75 745f 7465            out_te
+00015920: 6e73 6f72 2e72 6177 5f74 656e 736f 7220  nsor.raw_tensor 
+00015930: 3d20 6f75 745f 7465 6e73 6f72 5f72 6177  = out_tensor_raw
+00015940: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00015950: 5f74 656e 736f 7273 2e61 7070 656e 6428  _tensors.append(
+00015960: 6f75 745f 7465 6e73 6f72 290a 2020 2020  out_tensor).    
+00015970: 2020 2020 7265 7475 726e 206f 7574 5f74      return out_t
+00015980: 656e 736f 7273 0a0a 2020 2020 4073 7461  ensors..    @sta
+00015990: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+000159a0: 6620 7465 6e73 6f72 5f61 7272 6179 5f73  f tensor_array_s
+000159b0: 7461 636b 2874 656e 736f 725f 6172 7261  tack(tensor_arra
+000159c0: 793a 2054 656e 736f 7241 7272 6179 5479  y: TensorArrayTy
+000159d0: 7065 2c20 2a2c 2061 7869 733a 2044 696d  pe, *, axis: Dim
+000159e0: 2c20 7465 6e73 6f72 5f74 656d 706c 6174  , tensor_templat
+000159f0: 653a 2054 656e 736f 7229 202d 3e20 5465  e: Tensor) -> Te
+00015a00: 6e73 6f72 3a0a 2020 2020 2020 2020 2222  nsor:.        ""
+00015a10: 2273 7461 636b 2222 220a 2020 2020 2020  "stack""".      
+00015a20: 2020 6966 2074 656e 736f 725f 6172 7261    if tensor_arra
+00015a30: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
+00015a40: 2049 6e20 7468 6520 6163 7475 616c 2061   In the actual a
+00015a50: 7272 6179 2c20 7468 6520 7465 6e73 6f72  rray, the tensor
+00015a60: 7320 6d69 6768 7420 6265 2061 2062 6574  s might be a bet
+00015a70: 7465 7220 7465 6d70 6c61 7465 2028 6469  ter template (di
+00015a80: 6666 6572 656e 7420 6469 6d20 6f72 6465  fferent dim orde
+00015a90: 7229 2e0a 2020 2020 2020 2020 2020 2020  r)..            
+00015aa0: 2320 5765 2061 6c72 6561 6479 2063 6865  # We already che
+00015ab0: 636b 6564 2069 6e20 5465 6e73 6f72 4172  cked in TensorAr
+00015ac0: 7261 7920 7468 6174 2074 6865 7920 6172  ray that they ar
+00015ad0: 6520 636f 6d70 6174 6962 6c65 2e0a 2020  e compatible..  
+00015ae0: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+00015af0: 5f74 656d 706c 6174 6520 3d20 7465 6e73  _template = tens
+00015b00: 6f72 5f61 7272 6179 5b30 5d2e 636f 7079  or_array[0].copy
+00015b10: 5f74 656d 706c 6174 6528 290a 2020 2020  _template().    
+00015b20: 2020 2020 6f75 745f 7465 6e73 6f72 203d      out_tensor =
+00015b30: 2074 656e 736f 725f 7465 6d70 6c61 7465   tensor_template
+00015b40: 2e63 6f70 795f 6164 645f 6469 6d5f 6279  .copy_add_dim_by
+00015b50: 5f74 6167 2861 7869 732c 2075 6e62 726f  _tag(axis, unbro
+00015b60: 6164 6361 7374 3d54 7275 652c 2061 7869  adcast=True, axi
+00015b70: 733d 3029 0a20 2020 2020 2020 2069 6620  s=0).        if 
+00015b80: 6e6f 7420 7465 6e73 6f72 5f61 7272 6179  not tensor_array
+00015b90: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015ba0: 7475 726e 2072 662e 7a65 726f 735f 6c69  turn rf.zeros_li
+00015bb0: 6b65 286f 7574 5f74 656e 736f 7229 0a20  ke(out_tensor). 
+00015bc0: 2020 2020 2020 2074 656e 736f 725f 6172         tensor_ar
+00015bd0: 7261 795f 7261 7720 3d20 5b74 656e 736f  ray_raw = [tenso
+00015be0: 722e 636f 7079 5f74 7261 6e73 706f 7365  r.copy_transpose
+00015bf0: 2874 656e 736f 725f 7465 6d70 6c61 7465  (tensor_template
+00015c00: 2e64 696d 7329 2e72 6177 5f74 656e 736f  .dims).raw_tenso
+00015c10: 7220 666f 7220 7465 6e73 6f72 2069 6e20  r for tensor in 
+00015c20: 7465 6e73 6f72 5f61 7272 6179 5d0a 2020  tensor_array].  
+00015c30: 2020 2020 2020 6f75 745f 7465 6e73 6f72        out_tensor
+00015c40: 5f72 6177 203d 2074 6f72 6368 2e73 7461  _raw = torch.sta
+00015c50: 636b 2874 656e 736f 725f 6172 7261 795f  ck(tensor_array_
+00015c60: 7261 772c 2064 696d 3d30 290a 2020 2020  raw, dim=0).    
+00015c70: 2020 2020 6f75 745f 7465 6e73 6f72 2e72      out_tensor.r
+00015c80: 6177 5f74 656e 736f 7220 3d20 6f75 745f  aw_tensor = out_
+00015c90: 7465 6e73 6f72 5f72 6177 0a20 2020 2020  tensor_raw.     
+00015ca0: 2020 2072 6574 7572 6e20 6f75 745f 7465     return out_te
+00015cb0: 6e73 6f72 0a                             nsor.
```

### Comparing `returnn-1.20240327.165809/returnn/torch/frontend/_rand.py` & `returnn-1.20240513.232708/returnn/torch/frontend/_rand.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/frontend/bridge.py` & `returnn-1.20240513.232708/returnn/torch/frontend/bridge.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/updater.py` & `returnn-1.20240513.232708/returnn/torch/updater.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/util/diagnose_gpu.py` & `returnn-1.20240513.232708/returnn/torch/util/diagnose_gpu.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/torch/util/scaled_gradient.py` & `returnn-1.20240513.232708/returnn/torch/util/scaled_gradient.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/basic.py` & `returnn-1.20240513.232708/returnn/util/basic.py`

 * *Files 0% similar despite different names*

```diff
@@ -362,15 +362,15 @@
 00001690: 5f5f 2e69 6e69 745f 636f 6e66 6967 2829  __.init_config()
 000016a0: 206f 7220 456e 6769 6e65 2e5f 5f69 6e69   or Engine.__ini
 000016b0: 745f 5f28 292e 0a0a 2020 2020 5365 6520  t__()...    See 
 000016c0: 3a72 6566 3a60 6265 6861 7669 6f72 5f76  :ref:`behavior_v
 000016d0: 6572 7369 6f6e 602e 0a20 2020 2022 2222  ersion`..    """
 000016e0: 0a0a 2020 2020 5f6c 6174 6573 745f 6265  ..    _latest_be
 000016f0: 6861 7669 6f72 5f76 6572 7369 6f6e 203d  havior_version =
-00001700: 2032 300a 2020 2020 5f62 6568 6176 696f   20.    _behavio
+00001700: 2032 310a 2020 2020 5f62 6568 6176 696f   21.    _behavio
 00001710: 725f 7665 7273 696f 6e20 3d20 4e6f 6e65  r_version = None
 00001720: 2020 2320 7479 7065 3a20 7479 7069 6e67    # type: typing
 00001730: 2e4f 7074 696f 6e61 6c5b 696e 745d 0a20  .Optional[int]. 
 00001740: 2020 205f 6d69 6e5f 6265 6861 7669 6f72     _min_behavior
 00001750: 5f76 6572 7369 6f6e 203d 2030 2020 2320  _version = 0  # 
 00001760: 7479 7065 3a20 696e 740a 0a20 2020 2040  type: int..    @
 00001770: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
@@ -930,7697 +930,7745 @@
 00003a10: 6b6e 6f77 6e28 6769 7420 6578 6365 7074  known(git except
 00003a20: 696f 6e3a 2025 7229 3e22 2025 2065 0a20  ion: %r)>" % e. 
 00003a30: 2020 2072 6574 7572 6e20 2225 7320 2825     return "%s (%
 00003a40: 7320 696e 2025 7329 2220 2520 2876 6572  s in %s)" % (ver
 00003a50: 7369 6f6e 2c20 6769 745f 696e 666f 2c20  sion, git_info, 
 00003a60: 7464 6972 290a 0a0a 6465 6620 6465 7363  tdir)...def desc
 00003a70: 7269 6265 5f74 6f72 6368 5f76 6572 7369  ribe_torch_versi
-00003a80: 6f6e 2829 3a0a 2020 2020 2222 220a 2020  on():.    """.  
-00003a90: 2020 3a72 7479 7065 3a20 7374 720a 2020    :rtype: str.  
-00003aa0: 2020 2222 220a 2020 2020 7472 793a 0a20    """.    try:. 
-00003ab0: 2020 2020 2020 2023 206e 6f69 6e73 7065         # noinspe
-00003ac0: 6374 696f 6e20 5079 5061 636b 6167 6552  ction PyPackageR
-00003ad0: 6571 7569 7265 6d65 6e74 730a 2020 2020  equirements.    
-00003ae0: 2020 2020 696d 706f 7274 2074 6f72 6368      import torch
-00003af0: 0a20 2020 2065 7863 6570 7420 496d 706f  .    except Impo
-00003b00: 7274 4572 726f 7220 6173 2065 7863 3a0a  rtError as exc:.
-00003b10: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-00003b20: 3c50 7954 6f72 6368 2049 6d70 6f72 7445  <PyTorch ImportE
-00003b30: 7272 6f72 3a20 2573 3e22 2025 2065 7863  rror: %s>" % exc
-00003b40: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-00003b50: 2020 7464 6972 203d 206f 732e 7061 7468    tdir = os.path
-00003b60: 2e64 6972 6e61 6d65 2874 6f72 6368 2e5f  .dirname(torch._
-00003b70: 5f66 696c 655f 5f29 0a20 2020 2065 7863  _file__).    exc
-00003b80: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00003b90: 2065 3a0a 2020 2020 2020 2020 7464 6972   e:.        tdir
-00003ba0: 203d 2022 3c75 6e6b 6e6f 776e 2865 7863   = "<unknown(exc
-00003bb0: 6570 7469 6f6e 3a20 2572 293e 2220 2520  eption: %r)>" % 
-00003bc0: 650a 2020 2020 7665 7273 696f 6e20 3d20  e.    version = 
-00003bd0: 6765 7461 7474 7228 746f 7263 682c 2022  getattr(torch, "
-00003be0: 5f5f 7665 7273 696f 6e5f 5f22 2c20 223c  __version__", "<
-00003bf0: 756e 6b6e 6f77 6e20 7665 7273 696f 6e3e  unknown version>
-00003c00: 2229 0a20 2020 2076 6572 7369 6f6e 202b  ").    version +
-00003c10: 3d20 2220 2825 7329 2220 2520 6765 7461  = " (%s)" % geta
-00003c20: 7474 7228 746f 7263 682e 7665 7273 696f  ttr(torch.versio
-00003c30: 6e2c 2022 6769 745f 7665 7273 696f 6e22  n, "git_version"
-00003c40: 2c20 223c 756e 6b6e 6f77 6e20 6769 7420  , "<unknown git 
-00003c50: 7665 7273 696f 6e3e 2229 0a20 2020 2074  version>").    t
-00003c60: 7279 3a0a 2020 2020 2020 2020 6966 2074  ry:.        if t
-00003c70: 6469 722e 7374 6172 7473 7769 7468 2822  dir.startswith("
-00003c80: 3c22 293a 0a20 2020 2020 2020 2020 2020  <"):.           
-00003c90: 2067 6974 5f69 6e66 6f20 3d20 223c 756e   git_info = "<un
-00003ca0: 6b6e 6f77 6e2d 6469 723e 220a 2020 2020  known-dir>".    
-00003cb0: 2020 2020 656c 6966 206f 732e 7061 7468      elif os.path
-00003cc0: 2e65 7869 7374 7328 7464 6972 202b 2022  .exists(tdir + "
-00003cd0: 2f2e 2e2f 2e67 6974 2229 3a0a 2020 2020  /../.git"):.    
-00003ce0: 2020 2020 2020 2020 6769 745f 696e 666f          git_info
-00003cf0: 203d 2022 6769 743a 2220 2b20 6769 745f   = "git:" + git_
-00003d00: 6465 7363 7269 6265 5f68 6561 645f 7665  describe_head_ve
-00003d10: 7273 696f 6e28 6769 745f 6469 723d 7464  rsion(git_dir=td
-00003d20: 6972 290a 2020 2020 2020 2020 656c 6966  ir).        elif
-00003d30: 2022 2f73 6974 652d 7061 636b 6167 6573   "/site-packages
-00003d40: 2f22 2069 6e20 7464 6972 3a0a 2020 2020  /" in tdir:.    
-00003d50: 2020 2020 2020 2020 6769 745f 696e 666f          git_info
-00003d60: 203d 2022 3c73 6974 652d 7061 636b 6167   = "<site-packag
-00003d70: 653e 220a 2020 2020 2020 2020 656c 7365  e>".        else
-00003d80: 3a0a 2020 2020 2020 2020 2020 2020 6769  :.            gi
-00003d90: 745f 696e 666f 203d 2022 3c6e 6f74 2d75  t_info = "<not-u
-00003da0: 6e64 6572 2d67 6974 3e22 0a20 2020 2065  nder-git>".    e
-00003db0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00003dc0: 6173 2065 3a0a 2020 2020 2020 2020 6769  as e:.        gi
-00003dd0: 745f 696e 666f 203d 2022 3c75 6e6b 6e6f  t_info = "<unkno
-00003de0: 776e 2867 6974 2065 7863 6570 7469 6f6e  wn(git exception
-00003df0: 3a20 2572 293e 2220 2520 650a 2020 2020  : %r)>" % e.    
-00003e00: 7265 7475 726e 2022 2573 2028 2573 2069  return "%s (%s i
-00003e10: 6e20 2573 2922 2025 2028 7665 7273 696f  n %s)" % (versio
-00003e20: 6e2c 2067 6974 5f69 6e66 6f2c 2074 6469  n, git_info, tdi
-00003e30: 7229 0a0a 0a64 6566 2067 6574 5f74 656e  r)...def get_ten
-00003e40: 736f 7266 6c6f 775f 7665 7273 696f 6e5f  sorflow_version_
-00003e50: 7475 706c 6528 293a 0a20 2020 2022 2222  tuple():.    """
-00003e60: 0a20 2020 203a 7265 7475 726e 3a20 7475  .    :return: tu
-00003e70: 706c 6520 6f66 2069 6e74 732c 2066 6972  ple of ints, fir
-00003e80: 7374 2065 6e74 7279 2069 7320 7468 6520  st entry is the 
-00003e90: 6d61 6a6f 7220 7665 7273 696f 6e0a 2020  major version.  
-00003ea0: 2020 3a72 7479 7065 3a20 7475 706c 655b    :rtype: tuple[
-00003eb0: 696e 745d 0a20 2020 2022 2222 0a20 2020  int].    """.   
-00003ec0: 2069 6d70 6f72 7420 7465 6e73 6f72 666c   import tensorfl
-00003ed0: 6f77 2061 7320 7466 0a20 2020 2069 6d70  ow as tf.    imp
-00003ee0: 6f72 7420 7265 0a0a 2020 2020 7265 7475  ort re..    retu
-00003ef0: 726e 2074 7570 6c65 285b 696e 7428 7265  rn tuple([int(re
-00003f00: 2e73 7562 2822 282d 7263 5b30 2d39 5d7c  .sub("(-rc[0-9]|
-00003f10: 2d64 6576 5b30 2d39 5d2a 2922 2c20 2222  -dev[0-9]*)", ""
-00003f20: 2c20 7329 2920 666f 7220 7320 696e 2074  , s)) for s in t
-00003f30: 662e 5f5f 7665 7273 696f 6e5f 5f2e 7370  f.__version__.sp
-00003f40: 6c69 7428 222e 2229 5d29 0a0a 0a64 6566  lit(".")])...def
-00003f50: 2065 7661 6c5f 7368 656c 6c5f 656e 7628   eval_shell_env(
-00003f60: 746f 6b65 6e29 3a0a 2020 2020 2222 220a  token):.    """.
-00003f70: 2020 2020 3a70 6172 616d 2073 7472 2074      :param str t
-00003f80: 6f6b 656e 3a0a 2020 2020 3a72 6574 7572  oken:.    :retur
-00003f90: 6e3a 2069 6620 2224 7661 7222 2c20 6c6f  n: if "$var", lo
-00003fa0: 6f6b 7320 696e 206f 732e 656e 7669 726f  oks in os.enviro
-00003fb0: 6e2c 206f 7468 6572 7769 7365 2072 6574  n, otherwise ret
-00003fc0: 7572 6e20 746f 6b65 6e20 6173 2069 730a  urn token as is.
-00003fd0: 2020 2020 3a72 7479 7065 3a20 7374 720a      :rtype: str.
-00003fe0: 2020 2020 2222 220a 2020 2020 6966 2074      """.    if t
-00003ff0: 6f6b 656e 2e73 7461 7274 7377 6974 6828  oken.startswith(
-00004000: 2224 2229 3a0a 2020 2020 2020 2020 7265  "$"):.        re
-00004010: 7475 726e 206f 732e 656e 7669 726f 6e2e  turn os.environ.
-00004020: 6765 7428 746f 6b65 6e5b 313a 5d2c 2022  get(token[1:], "
-00004030: 2229 0a20 2020 2072 6574 7572 6e20 746f  ").    return to
-00004040: 6b65 6e0a 0a0a 6465 6620 6576 616c 5f73  ken...def eval_s
-00004050: 6865 6c6c 5f73 7472 2873 293a 0a20 2020  hell_str(s):.   
-00004060: 2022 2222 0a20 2020 203a 7479 7065 2073   """.    :type s
-00004070: 3a20 7374 7220 7c20 6c69 7374 5b73 7472  : str | list[str
-00004080: 5d20 7c20 2829 2d3e 7374 7220 7c20 6c69  ] | ()->str | li
-00004090: 7374 5b28 292d 3e73 7472 5d20 7c20 2829  st[()->str] | ()
-000040a0: 2d3e 6c69 7374 5b73 7472 5d20 7c20 2829  ->list[str] | ()
-000040b0: 2d3e 6c69 7374 5b28 292d 3e73 7472 5d0a  ->list[()->str].
-000040c0: 2020 2020 3a72 7479 7065 3a20 6c69 7374      :rtype: list
-000040d0: 5b73 7472 5d0a 0a20 2020 2050 6172 7365  [str]..    Parse
-000040e0: 7320 6073 6020 6173 2073 6865 6c6c 206c  s `s` as shell l
-000040f0: 696b 6520 6172 6775 6d65 6e74 7320 2876  ike arguments (v
-00004100: 6961 2073 686c 6578 2e73 706c 6974 2920  ia shlex.split) 
-00004110: 616e 6420 6576 616c 7561 7465 7320 7368  and evaluates sh
-00004120: 656c 6c20 656e 7669 726f 6e6d 656e 7420  ell environment 
-00004130: 7661 7269 6162 6c65 730a 2020 2020 283a  variables.    (:
-00004140: 6675 6e63 3a60 6576 616c 5f73 6865 6c6c  func:`eval_shell
-00004150: 5f65 6e76 6029 2e0a 2020 2020 6073 6020  _env`)..    `s` 
-00004160: 6f72 2069 7473 2065 6c65 6d65 6e74 7320  or its elements 
-00004170: 6361 6e20 616c 736f 2062 6520 6361 6c6c  can also be call
-00004180: 6162 6c65 2e20 496e 2074 686f 7365 2063  able. In those c
-00004190: 6173 6573 2c20 7468 6579 2077 696c 6c20  ases, they will 
-000041a0: 6265 2063 616c 6c65 6420 616e 6420 7468  be called and th
-000041b0: 6520 7265 7475 726e 6564 2076 616c 7565  e returned value
-000041c0: 2069 7320 7573 6564 2e0a 2020 2020 2222   is used..    ""
-000041d0: 220a 2020 2020 746f 6b65 6e73 203d 205b  ".    tokens = [
-000041e0: 5d0a 2020 2020 6966 2063 616c 6c61 626c  ].    if callabl
-000041f0: 6528 7329 3a0a 2020 2020 2020 2020 7320  e(s):.        s 
-00004200: 3d20 7328 290a 2020 2020 6966 2069 7369  = s().    if isi
-00004210: 6e73 7461 6e63 6528 732c 2028 6c69 7374  nstance(s, (list
-00004220: 2c20 7475 706c 6529 293a 0a20 2020 2020  , tuple)):.     
-00004230: 2020 206c 7320 3d20 730a 2020 2020 656c     ls = s.    el
-00004240: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
-00004250: 7274 2069 7369 6e73 7461 6e63 6528 732c  rt isinstance(s,
-00004260: 2028 7374 722c 2075 6e69 636f 6465 2929   (str, unicode))
-00004270: 0a20 2020 2020 2020 206c 7320 3d20 7368  .        ls = sh
-00004280: 6c65 782e 7370 6c69 7428 7329 0a20 2020  lex.split(s).   
-00004290: 2066 6f72 2074 6f6b 656e 2069 6e20 6c73   for token in ls
-000042a0: 3a0a 2020 2020 2020 2020 6966 2063 616c  :.        if cal
-000042b0: 6c61 626c 6528 746f 6b65 6e29 3a0a 2020  lable(token):.  
-000042c0: 2020 2020 2020 2020 2020 746f 6b65 6e20            token 
-000042d0: 3d20 746f 6b65 6e28 290a 2020 2020 2020  = token().      
-000042e0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000042f0: 6e63 6528 746f 6b65 6e2c 2028 7374 722c  nce(token, (str,
-00004300: 2075 6e69 636f 6465 2929 0a20 2020 2020   unicode)).     
-00004310: 2020 2069 6620 746f 6b65 6e2e 7374 6172     if token.star
-00004320: 7473 7769 7468 2822 2422 293a 0a20 2020  tswith("$"):.   
-00004330: 2020 2020 2020 2020 2074 6f6b 656e 7320           tokens 
-00004340: 2b3d 2065 7661 6c5f 7368 656c 6c5f 7374  += eval_shell_st
-00004350: 7228 6576 616c 5f73 6865 6c6c 5f65 6e76  r(eval_shell_env
-00004360: 2874 6f6b 656e 2929 0a20 2020 2020 2020  (token)).       
-00004370: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00004380: 2020 2074 6f6b 656e 7320 2b3d 205b 746f     tokens += [to
-00004390: 6b65 6e5d 0a20 2020 2072 6574 7572 6e20  ken].    return 
-000043a0: 746f 6b65 6e73 0a0a 0a64 6566 2068 6466  tokens...def hdf
-000043b0: 355f 6469 6d65 6e73 696f 6e28 6669 6c65  5_dimension(file
-000043c0: 6e61 6d65 2c20 6469 6d65 6e73 696f 6e29  name, dimension)
-000043d0: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
-000043e0: 6172 616d 2073 7472 2066 696c 656e 616d  aram str filenam
-000043f0: 653a 0a20 2020 203a 7061 7261 6d20 7374  e:.    :param st
-00004400: 7220 6469 6d65 6e73 696f 6e3a 0a20 2020  r dimension:.   
-00004410: 203a 7274 7970 653a 206e 756d 7079 2e6e   :rtype: numpy.n
-00004420: 6461 7272 6179 7c69 6e74 0a20 2020 2022  darray|int.    "
-00004430: 2222 0a20 2020 2066 696e 203d 2068 3570  "".    fin = h5p
-00004440: 792e 4669 6c65 2866 696c 656e 616d 652c  y.File(filename,
-00004450: 2022 7222 290a 2020 2020 6966 2022 2f22   "r").    if "/"
-00004460: 2069 6e20 6469 6d65 6e73 696f 6e3a 0a20   in dimension:. 
-00004470: 2020 2020 2020 2072 6573 203d 2066 696e         res = fin
-00004480: 5b22 2f22 2e6a 6f69 6e28 6469 6d65 6e73  ["/".join(dimens
-00004490: 696f 6e2e 7370 6c69 7428 222f 2229 5b3a  ion.split("/")[:
-000044a0: 2d31 5d29 5d2e 6174 7472 735b 6469 6d65  -1])].attrs[dime
-000044b0: 6e73 696f 6e2e 7370 6c69 7428 222f 2229  nsion.split("/")
-000044c0: 5b2d 315d 5d0a 2020 2020 656c 7365 3a0a  [-1]].    else:.
-000044d0: 2020 2020 2020 2020 7265 7320 3d20 6669          res = fi
-000044e0: 6e2e 6174 7472 735b 6469 6d65 6e73 696f  n.attrs[dimensio
-000044f0: 6e5d 0a20 2020 2066 696e 2e63 6c6f 7365  n].    fin.close
-00004500: 2829 0a20 2020 2072 6574 7572 6e20 7265  ().    return re
-00004510: 730a 0a0a 6465 6620 6864 6635 5f67 726f  s...def hdf5_gro
-00004520: 7570 2866 696c 656e 616d 652c 2064 696d  up(filename, dim
-00004530: 656e 7369 6f6e 293a 0a20 2020 2022 2222  ension):.    """
-00004540: 0a20 2020 203a 7061 7261 6d20 7374 7220  .    :param str 
-00004550: 6669 6c65 6e61 6d65 3a0a 2020 2020 3a70  filename:.    :p
-00004560: 6172 616d 2073 7472 2064 696d 656e 7369  aram str dimensi
-00004570: 6f6e 3a0a 2020 2020 3a72 7479 7065 3a20  on:.    :rtype: 
-00004580: 6469 6374 5b73 7472 5d0a 2020 2020 2222  dict[str].    ""
-00004590: 220a 2020 2020 6669 6e20 3d20 6835 7079  ".    fin = h5py
-000045a0: 2e46 696c 6528 6669 6c65 6e61 6d65 2c20  .File(filename, 
-000045b0: 2272 2229 0a20 2020 2072 6573 203d 207b  "r").    res = {
-000045c0: 6b3a 2066 696e 5b64 696d 656e 7369 6f6e  k: fin[dimension
-000045d0: 5d2e 6174 7472 735b 6b5d 2066 6f72 206b  ].attrs[k] for k
-000045e0: 2069 6e20 6669 6e5b 6469 6d65 6e73 696f   in fin[dimensio
-000045f0: 6e5d 2e61 7474 7273 7d0a 2020 2020 6669  n].attrs}.    fi
-00004600: 6e2e 636c 6f73 6528 290a 2020 2020 7265  n.close().    re
-00004610: 7475 726e 2072 6573 0a0a 0a64 6566 2068  turn res...def h
-00004620: 6466 355f 7368 6170 6528 6669 6c65 6e61  df5_shape(filena
-00004630: 6d65 2c20 6469 6d65 6e73 696f 6e29 3a0a  me, dimension):.
-00004640: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
-00004650: 616d 2073 7472 2066 696c 656e 616d 653a  am str filename:
-00004660: 0a20 2020 203a 7061 7261 6d20 6469 6d65  .    :param dime
-00004670: 6e73 696f 6e3a 0a20 2020 203a 7274 7970  nsion:.    :rtyp
-00004680: 653a 2074 7570 6c65 5b69 6e74 5d0a 2020  e: tuple[int].  
-00004690: 2020 2222 220a 2020 2020 6669 6e20 3d20    """.    fin = 
-000046a0: 6835 7079 2e46 696c 6528 6669 6c65 6e61  h5py.File(filena
-000046b0: 6d65 2c20 2272 2229 0a20 2020 2072 6573  me, "r").    res
-000046c0: 203d 2066 696e 5b64 696d 656e 7369 6f6e   = fin[dimension
-000046d0: 5d2e 7368 6170 650a 2020 2020 6669 6e2e  ].shape.    fin.
-000046e0: 636c 6f73 6528 290a 2020 2020 7265 7475  close().    retu
-000046f0: 726e 2072 6573 0a0a 0a64 6566 2068 6466  rn res...def hdf
-00004700: 355f 7374 7269 6e67 7328 6861 6e64 6c65  5_strings(handle
-00004710: 2c20 6e61 6d65 2c20 6461 7461 293a 0a20  , name, data):. 
-00004720: 2020 2022 2222 0a20 2020 203a 7061 7261     """.    :para
-00004730: 6d20 6835 7079 2e46 696c 6520 6861 6e64  m h5py.File hand
-00004740: 6c65 3a0a 2020 2020 3a70 6172 616d 2073  le:.    :param s
-00004750: 7472 206e 616d 653a 0a20 2020 203a 7061  tr name:.    :pa
-00004760: 7261 6d20 6e75 6d70 792e 6e64 6172 7261  ram numpy.ndarra
-00004770: 797c 6c69 7374 5b73 7472 5d20 6461 7461  y|list[str] data
-00004780: 3a0a 2020 2020 2222 220a 2020 2020 2320  :.    """.    # 
-00004790: 6e6f 696e 7370 6563 7469 6f6e 2050 7942  noinspection PyB
-000047a0: 726f 6164 4578 6365 7074 696f 6e0a 2020  roadException.  
-000047b0: 2020 7472 793a 0a20 2020 2020 2020 2073    try:.        s
-000047c0: 203d 206d 6178 285b 6c65 6e28 6429 2066   = max([len(d) f
-000047d0: 6f72 2064 2069 6e20 6461 7461 5d29 0a20  or d in data]). 
-000047e0: 2020 2020 2020 2064 7365 7420 3d20 6861         dset = ha
-000047f0: 6e64 6c65 2e63 7265 6174 655f 6461 7461  ndle.create_data
-00004800: 7365 7428 6e61 6d65 2c20 286c 656e 2864  set(name, (len(d
-00004810: 6174 6129 2c29 2c20 6474 7970 653d 2253  ata),), dtype="S
-00004820: 2220 2b20 7374 7228 7329 290a 2020 2020  " + str(s)).    
-00004830: 2020 2020 6473 6574 5b2e 2e2e 5d20 3d20      dset[...] = 
-00004840: 6461 7461 0a20 2020 2065 7863 6570 7420  data.    except 
-00004850: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-00004860: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
-00004870: 6e20 5079 556e 7265 736f 6c76 6564 5265  n PyUnresolvedRe
-00004880: 6665 7265 6e63 6573 0a20 2020 2020 2020  ferences.       
-00004890: 2064 7420 3d20 6835 7079 2e73 7065 6369   dt = h5py.speci
-000048a0: 616c 5f64 7479 7065 2876 6c65 6e3d 756e  al_dtype(vlen=un
-000048b0: 6963 6f64 6529 0a20 2020 2020 2020 2064  icode).        d
-000048c0: 656c 2068 616e 646c 655b 6e61 6d65 5d0a  el handle[name].
-000048d0: 2020 2020 2020 2020 6473 6574 203d 2068          dset = h
-000048e0: 616e 646c 652e 6372 6561 7465 5f64 6174  andle.create_dat
-000048f0: 6173 6574 286e 616d 652c 2028 6c65 6e28  aset(name, (len(
-00004900: 6461 7461 292c 292c 2064 7479 7065 3d64  data),), dtype=d
-00004910: 7429 0a20 2020 2020 2020 2064 7365 745b  t).        dset[
-00004920: 2e2e 2e5d 203d 2064 6174 610a 0a0a 6465  ...] = data...de
-00004930: 6620 6d6f 6465 6c5f 6570 6f63 685f 6672  f model_epoch_fr
-00004940: 6f6d 5f66 696c 656e 616d 6528 6669 6c65  om_filename(file
-00004950: 6e61 6d65 293a 0a20 2020 2022 2222 0a20  name):.    """. 
-00004960: 2020 203a 7061 7261 6d20 7374 7220 6669     :param str fi
-00004970: 6c65 6e61 6d65 3a0a 2020 2020 3a72 6574  lename:.    :ret
-00004980: 7572 6e3a 2065 706f 6368 206e 756d 6265  urn: epoch numbe
-00004990: 720a 2020 2020 3a72 7479 7065 3a20 696e  r.    :rtype: in
-000049a0: 747c 4e6f 6e65 0a20 2020 2022 2222 0a20  t|None.    """. 
-000049b0: 2020 2023 2057 6520 636f 756c 6420 6368     # We could ch
-000049c0: 6563 6b20 7669 613a 0a20 2020 2023 2074  eck via:.    # t
-000049d0: 662e 636f 6e74 7269 622e 6672 616d 6577  f.contrib.framew
-000049e0: 6f72 6b2e 7079 7468 6f6e 2e66 7261 6d65  ork.python.frame
-000049f0: 776f 726b 2e63 6865 636b 706f 696e 745f  work.checkpoint_
-00004a00: 7574 696c 732e 6c6f 6164 5f76 6172 6961  utils.load_varia
-00004a10: 626c 6528 290a 2020 2020 2320 6f6e 6365  ble().    # once
-00004a20: 2077 6520 7361 7665 2074 6861 7420 696e   we save that in
-00004a30: 2074 6865 206d 6f64 656c 2e0a 2020 2020   the model..    
-00004a40: 2320 5365 6520 5446 4e65 7477 6f72 6b2e  # See TFNetwork.
-00004a50: 4e65 7477 6f72 6b2e 5f63 7265 6174 655f  Network._create_
-00004a60: 7361 7665 7228 292e 0a20 2020 2023 2057  saver()..    # W
-00004a70: 6520 646f 6e27 7420 6861 7665 2069 7420  e don't have it 
-00004a80: 696e 2074 6865 206d 6f64 656c 2c20 7468  in the model, th
-00004a90: 6f75 6768 2e0a 2020 2020 2320 466f 7220  ough..    # For 
-00004aa0: 6e6f 772c 206a 7573 7420 7061 7273 6520  now, just parse 
-00004ab0: 6974 2066 726f 6d20 6669 6c65 6e61 6d65  it from filename
-00004ac0: 2e0a 2020 2020 2320 4966 2054 462c 2061  ..    # If TF, a
-00004ad0: 6e64 2073 796d 6c69 6e6b 2c20 7265 736f  nd symlink, reso
-00004ae0: 6c76 6520 756e 7469 6c20 6e6f 2073 796d  lve until no sym
-00004af0: 6c69 6e6b 2061 6e79 6d6f 7265 2028 652e  link anymore (e.
-00004b00: 672e 2069 6620 7765 2073 796d 6c69 6e6b  g. if we symlink
-00004b10: 6564 2074 6865 2062 6573 7420 6570 6f63  ed the best epoc
-00004b20: 6829 2e0a 2020 2020 666f 7220 706f 7465  h)..    for pote
-00004b30: 6e74 6961 6c5f 6578 7420 696e 205b 222e  ntial_ext in [".
-00004b40: 6d65 7461 222c 2022 2e70 7422 5d3a 0a20  meta", ".pt"]:. 
-00004b50: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
-00004b60: 2e70 6174 682e 6578 6973 7473 2866 696c  .path.exists(fil
-00004b70: 656e 616d 6520 2b20 706f 7465 6e74 6961  ename + potentia
-00004b80: 6c5f 6578 7429 3a0a 2020 2020 2020 2020  l_ext):.        
-00004b90: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00004ba0: 2020 2020 2077 6869 6c65 206f 732e 7061       while os.pa
-00004bb0: 7468 2e65 7869 7374 7328 6669 6c65 6e61  th.exists(filena
-00004bc0: 6d65 202b 2070 6f74 656e 7469 616c 5f65  me + potential_e
-00004bd0: 7874 2920 616e 6420 6f73 2e70 6174 682e  xt) and os.path.
-00004be0: 6973 6c69 6e6b 2866 696c 656e 616d 6520  islink(filename 
-00004bf0: 2b20 706f 7465 6e74 6961 6c5f 6578 7429  + potential_ext)
-00004c00: 3a0a 2020 2020 2020 2020 2020 2020 666e  :.            fn
-00004c10: 5f77 6974 685f 6578 745f 203d 206f 732e  _with_ext_ = os.
-00004c20: 7265 6164 6c69 6e6b 2866 696c 656e 616d  readlink(filenam
-00004c30: 6520 2b20 706f 7465 6e74 6961 6c5f 6578  e + potential_ex
-00004c40: 7429 0a20 2020 2020 2020 2020 2020 2061  t).            a
-00004c50: 7373 6572 7420 666e 5f77 6974 685f 6578  ssert fn_with_ex
-00004c60: 745f 2e65 6e64 7377 6974 6828 706f 7465  t_.endswith(pote
-00004c70: 6e74 6961 6c5f 6578 7429 2c20 2273 7472  ntial_ext), "str
-00004c80: 616e 6765 3f20 2573 2c20 2573 2220 2520  ange? %s, %s" % 
-00004c90: 2866 696c 656e 616d 652c 2070 6f74 656e  (filename, poten
-00004ca0: 7469 616c 5f65 7874 290a 2020 2020 2020  tial_ext).      
-00004cb0: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
-00004cc0: 2066 6e5f 7769 7468 5f65 7874 5f5b 3a20   fn_with_ext_[: 
-00004cd0: 2d6c 656e 2870 6f74 656e 7469 616c 5f65  -len(potential_e
-00004ce0: 7874 295d 0a20 2020 2020 2020 2062 7265  xt)].        bre
-00004cf0: 616b 0a20 2020 206d 203d 2072 652e 6d61  ak.    m = re.ma
-00004d00: 7463 6828 222e 2a5c 5c2e 285b 302d 395d  tch(".*\\.([0-9]
-00004d10: 2b29 222c 2066 696c 656e 616d 6529 0a20  +)", filename). 
-00004d20: 2020 2069 6620 6e6f 7420 6d3a 0a20 2020     if not m:.   
-00004d30: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00004d40: 0a20 2020 2072 6574 7572 6e20 696e 7428  .    return int(
-00004d50: 6d2e 6772 6f75 7073 2829 5b30 5d29 0a0a  m.groups()[0])..
-00004d60: 0a64 6566 2064 6565 705f 7570 6461 7465  .def deep_update
-00004d70: 5f64 6963 745f 7661 6c75 6573 2864 2c20  _dict_values(d, 
-00004d80: 6b65 792c 206e 6577 5f76 616c 7565 293a  key, new_value):
-00004d90: 0a20 2020 2022 2222 0a20 2020 2056 6973  .    """.    Vis
-00004da0: 6974 7320 616c 6c20 6974 656d 7320 696e  its all items in
-00004db0: 2060 6460 2e0a 2020 2020 4966 2074 6865   `d`..    If the
-00004dc0: 2076 616c 7565 2069 7320 6120 6469 6374   value is a dict
-00004dd0: 2c20 6974 2077 696c 6c20 7265 6375 7273  , it will recurs
-00004de0: 6976 656c 7920 7669 7369 7420 6974 2e0a  ively visit it..
-00004df0: 0a20 2020 203a 7061 7261 6d20 6469 6374  .    :param dict
-00004e00: 5b73 7472 2c54 7c6f 626a 6563 747c 4e6f  [str,T|object|No
-00004e10: 6e65 7c64 6963 745d 2064 3a20 7769 6c6c  ne|dict] d: will
-00004e20: 2075 7064 6174 6520 696e 706c 6163 650a   update inplace.
-00004e30: 2020 2020 3a70 6172 616d 2073 7472 206b      :param str k
-00004e40: 6579 3a0a 2020 2020 3a70 6172 616d 2054  ey:.    :param T
-00004e50: 206e 6577 5f76 616c 7565 3a0a 2020 2020   new_value:.    
-00004e60: 2222 220a 2020 2020 666f 7220 7661 6c75  """.    for valu
-00004e70: 6520 696e 2064 2e76 616c 7565 7328 293a  e in d.values():
-00004e80: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00004e90: 7374 616e 6365 2876 616c 7565 2c20 6469  stance(value, di
-00004ea0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-00004eb0: 2064 6565 705f 7570 6461 7465 5f64 6963   deep_update_dic
-00004ec0: 745f 7661 6c75 6573 2876 616c 7565 2c20  t_values(value, 
-00004ed0: 6b65 793d 6b65 792c 206e 6577 5f76 616c  key=key, new_val
-00004ee0: 7565 3d6e 6577 5f76 616c 7565 290a 2020  ue=new_value).  
-00004ef0: 2020 6966 206b 6579 2069 6e20 643a 0a20    if key in d:. 
-00004f00: 2020 2020 2020 2064 5b6b 6579 5d20 3d20         d[key] = 
-00004f10: 6e65 775f 7661 6c75 650a 0a0a 6465 6620  new_value...def 
-00004f20: 7465 726d 696e 616c 5f73 697a 6528 6669  terminal_size(fi
-00004f30: 6c65 3d73 7973 2e73 7464 6f75 7429 3a0a  le=sys.stdout):.
-00004f40: 2020 2020 2222 220a 2020 2020 5265 7475      """.    Retu
-00004f50: 726e 7320 7468 6520 7465 726d 696e 616c  rns the terminal
-00004f60: 2073 697a 652e 0a20 2020 2054 6869 7320   size..    This 
-00004f70: 7769 6c6c 2070 726f 6261 626c 7920 776f  will probably wo
-00004f80: 726b 206f 6e20 6c69 6e75 7820 6f6e 6c79  rk on linux only
-00004f90: 2e0a 0a20 2020 203a 7061 7261 6d20 696f  ...    :param io
-00004fa0: 2e46 696c 6520 6669 6c65 3a0a 2020 2020  .File file:.    
-00004fb0: 3a72 6574 7572 6e3a 2028 636f 6c75 6d6e  :return: (column
-00004fc0: 732c 206c 696e 6573 292c 206f 7220 282d  s, lines), or (-
-00004fd0: 312c 2d31 290a 2020 2020 3a72 7479 7065  1,-1).    :rtype
-00004fe0: 3a20 2869 6e74 2c69 6e74 290a 2020 2020  : (int,int).    
-00004ff0: 2222 220a 2020 2020 696d 706f 7274 206f  """.    import o
-00005000: 730a 2020 2020 696d 706f 7274 2069 6f0a  s.    import io.
-00005010: 0a20 2020 2069 6620 6e6f 7420 6861 7361  .    if not hasa
-00005020: 7474 7228 6669 6c65 2c20 2266 696c 656e  ttr(file, "filen
-00005030: 6f22 293a 0a20 2020 2020 2020 2072 6574  o"):.        ret
-00005040: 7572 6e20 2d31 2c20 2d31 0a20 2020 2074  urn -1, -1.    t
-00005050: 7279 3a0a 2020 2020 2020 2020 6966 206e  ry:.        if n
-00005060: 6f74 206f 732e 6973 6174 7479 2866 696c  ot os.isatty(fil
-00005070: 652e 6669 6c65 6e6f 2829 293a 0a20 2020  e.fileno()):.   
-00005080: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00005090: 2d31 2c20 2d31 0a20 2020 2065 7863 6570  -1, -1.    excep
-000050a0: 7420 2869 6f2e 556e 7375 7070 6f72 7465  t (io.Unsupporte
-000050b0: 644f 7065 7261 7469 6f6e 2c20 5661 6c75  dOperation, Valu
-000050c0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-000050d0: 2072 6574 7572 6e20 2d31 2c20 2d31 0a20   return -1, -1. 
-000050e0: 2020 2065 6e76 203d 206f 732e 656e 7669     env = os.envi
-000050f0: 726f 6e0a 0a20 2020 2023 206e 6f69 6e73  ron..    # noins
-00005100: 7065 6374 696f 6e20 5079 5368 6164 6f77  pection PyShadow
-00005110: 696e 674e 616d 6573 0a20 2020 2064 6566  ingNames.    def
-00005120: 2069 6f63 746c 5f67 7769 6e73 7a28 6664   ioctl_gwinsz(fd
-00005130: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00005140: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
-00005150: 7420 6664 3a20 6669 6c65 2064 6573 6372  t fd: file descr
-00005160: 6970 746f 720a 2020 2020 2020 2020 3a72  iptor.        :r
-00005170: 7479 7065 3a20 7475 706c 655b 696e 745d  type: tuple[int]
-00005180: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00005190: 2020 2020 2023 206e 6f69 6e73 7065 6374       # noinspect
-000051a0: 696f 6e20 5079 4272 6f61 6445 7863 6570  ion PyBroadExcep
-000051b0: 7469 6f6e 0a20 2020 2020 2020 2074 7279  tion.        try
-000051c0: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-000051d0: 706f 7274 2066 636e 746c 0a20 2020 2020  port fcntl.     
-000051e0: 2020 2020 2020 2069 6d70 6f72 7420 7465         import te
-000051f0: 726d 696f 730a 2020 2020 2020 2020 2020  rmios.          
-00005200: 2020 696d 706f 7274 2073 7472 7563 740a    import struct.
-00005210: 0a20 2020 2020 2020 2020 2020 2063 725f  .            cr_
-00005220: 203d 2073 7472 7563 742e 756e 7061 636b   = struct.unpack
-00005230: 2822 6868 222c 2066 636e 746c 2e69 6f63  ("hh", fcntl.ioc
-00005240: 746c 2866 642c 2074 6572 6d69 6f73 2e54  tl(fd, termios.T
-00005250: 494f 4347 5749 4e53 5a2c 2022 3132 3334  IOCGWINSZ, "1234
-00005260: 2229 2920 2023 206e 6f71 610a 2020 2020  "))  # noqa.    
-00005270: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00005280: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00005290: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-000052a0: 2072 6574 7572 6e20 6372 5f0a 0a20 2020   return cr_..   
-000052b0: 2063 7220 3d20 696f 6374 6c5f 6777 696e   cr = ioctl_gwin
-000052c0: 737a 2866 696c 652e 6669 6c65 6e6f 2920  sz(file.fileno) 
-000052d0: 6f72 2069 6f63 746c 5f67 7769 6e73 7a28  or ioctl_gwinsz(
-000052e0: 3029 206f 7220 696f 6374 6c5f 6777 696e  0) or ioctl_gwin
-000052f0: 737a 2831 2920 6f72 2069 6f63 746c 5f67  sz(1) or ioctl_g
-00005300: 7769 6e73 7a28 3229 0a20 2020 2069 6620  winsz(2).    if 
-00005310: 6e6f 7420 6372 3a0a 2020 2020 2020 2020  not cr:.        
-00005320: 2320 6e6f 696e 7370 6563 7469 6f6e 2050  # noinspection P
-00005330: 7942 726f 6164 4578 6365 7074 696f 6e0a  yBroadException.
-00005340: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00005350: 2020 2020 2020 2020 2066 6420 3d20 6f73           fd = os
-00005360: 2e6f 7065 6e28 6f73 2e63 7465 726d 6964  .open(os.ctermid
-00005370: 2829 2c20 6f73 2e4f 5f52 444f 4e4c 5929  (), os.O_RDONLY)
-00005380: 0a20 2020 2020 2020 2020 2020 2063 7220  .            cr 
-00005390: 3d20 696f 6374 6c5f 6777 696e 737a 2866  = ioctl_gwinsz(f
-000053a0: 6429 0a20 2020 2020 2020 2020 2020 206f  d).            o
-000053b0: 732e 636c 6f73 6528 6664 290a 2020 2020  s.close(fd).    
-000053c0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000053d0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-000053e0: 2020 7061 7373 0a20 2020 2069 6620 6e6f    pass.    if no
-000053f0: 7420 6372 3a0a 2020 2020 2020 2020 6372  t cr:.        cr
-00005400: 203d 2028 656e 762e 6765 7428 224c 494e   = (env.get("LIN
-00005410: 4553 222c 2032 3529 2c20 656e 762e 6765  ES", 25), env.ge
-00005420: 7428 2243 4f4c 554d 4e53 222c 2038 3029  t("COLUMNS", 80)
-00005430: 290a 2020 2020 7265 7475 726e 2069 6e74  ).    return int
-00005440: 2863 725b 315d 292c 2069 6e74 2863 725b  (cr[1]), int(cr[
-00005450: 305d 290a 0a0a 6465 6620 6973 5f74 7479  0])...def is_tty
-00005460: 2866 696c 653d 7379 732e 7374 646f 7574  (file=sys.stdout
-00005470: 293a 0a20 2020 2022 2222 0a20 2020 203a  ):.    """.    :
-00005480: 7061 7261 6d20 696f 2e46 696c 6520 6669  param io.File fi
-00005490: 6c65 3a0a 2020 2020 3a72 7479 7065 3a20  le:.    :rtype: 
-000054a0: 626f 6f6c 0a20 2020 2022 2222 0a20 2020  bool.    """.   
-000054b0: 2074 6572 6d69 6e61 6c5f 7769 6474 682c   terminal_width,
-000054c0: 205f 203d 2074 6572 6d69 6e61 6c5f 7369   _ = terminal_si
-000054d0: 7a65 2866 696c 653d 6669 6c65 290a 2020  ze(file=file).  
-000054e0: 2020 7265 7475 726e 2074 6572 6d69 6e61    return termina
-000054f0: 6c5f 7769 6474 6820 3e20 300a 0a0a 6465  l_width > 0...de
-00005500: 6620 636f 6e66 6972 6d28 7478 742c 2065  f confirm(txt, e
-00005510: 7869 745f 6f6e 5f66 616c 7365 3d46 616c  xit_on_false=Fal
-00005520: 7365 293a 0a20 2020 2022 2222 0a20 2020  se):.    """.   
-00005530: 203a 7061 7261 6d20 7374 7220 7478 743a   :param str txt:
-00005540: 2065 2e67 2e20 2244 656c 6574 6520 6576   e.g. "Delete ev
-00005550: 6572 7974 6869 6e67 3f22 0a20 2020 203a  erything?".    :
-00005560: 7061 7261 6d20 626f 6f6c 2065 7869 745f  param bool exit_
-00005570: 6f6e 5f66 616c 7365 3a20 6966 2054 7275  on_false: if Tru
-00005580: 652c 2077 696c 6c20 6361 6c6c 2073 7973  e, will call sys
-00005590: 2e65 7869 7428 3129 2069 6620 6e6f 7420  .exit(1) if not 
-000055a0: 636f 6e66 6972 6d65 640a 2020 2020 3a72  confirmed.    :r
-000055b0: 7479 7065 3a20 626f 6f6c 0a20 2020 2022  type: bool.    "
-000055c0: 2222 0a20 2020 2077 6869 6c65 2054 7275  "".    while Tru
-000055d0: 653a 0a20 2020 2020 2020 2072 203d 2069  e:.        r = i
-000055e0: 6e70 7574 2822 2573 2043 6f6e 6669 726d  nput("%s Confirm
-000055f0: 3f20 5b79 6573 2f6e 6f5d 2220 2520 7478  ? [yes/no]" % tx
-00005600: 7429 0a20 2020 2020 2020 2069 6620 6e6f  t).        if no
-00005610: 7420 723a 0a20 2020 2020 2020 2020 2020  t r:.           
-00005620: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00005630: 2020 6966 2072 2069 6e20 5b22 7922 2c20    if r in ["y", 
-00005640: 2279 6573 225d 3a0a 2020 2020 2020 2020  "yes"]:.        
-00005650: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-00005660: 2020 2020 2020 2020 6966 2072 2069 6e20          if r in 
-00005670: 5b22 6e22 2c20 226e 6f22 5d3a 0a20 2020  ["n", "no"]:.   
-00005680: 2020 2020 2020 2020 2069 6620 6578 6974           if exit
-00005690: 5f6f 6e5f 6661 6c73 653a 0a20 2020 2020  _on_false:.     
-000056a0: 2020 2020 2020 2020 2020 2073 7973 2e65             sys.e
-000056b0: 7869 7428 3129 0a20 2020 2020 2020 2020  xit(1).         
-000056c0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-000056d0: 2020 2020 2020 2020 7072 696e 7428 2249          print("I
-000056e0: 6e76 616c 6964 2072 6573 706f 6e73 6520  nvalid response 
-000056f0: 2572 2e22 2025 2072 290a 0a0a 6465 6620  %r." % r)...def 
-00005700: 686d 7328 7329 3a0a 2020 2020 2222 220a  hms(s):.    """.
-00005710: 2020 2020 3a70 6172 616d 2066 6c6f 6174      :param float
-00005720: 7c69 6e74 2073 3a20 7365 636f 6e64 730a  |int s: seconds.
-00005730: 2020 2020 3a72 6574 7572 6e3a 2065 2e67      :return: e.g
-00005740: 2e20 2231 3a32 333a 3435 2220 2868 733a  . "1:23:45" (hs:
-00005750: 6d73 3a73 6563 7329 2e20 7365 6520 686d  ms:secs). see hm
-00005760: 735f 6672 6163 7469 6f6e 2069 6620 796f  s_fraction if yo
-00005770: 7520 7761 6e74 2074 6f20 6765 7420 6672  u want to get fr
-00005780: 6163 7469 6f6e 616c 2073 6563 6f6e 6473  actional seconds
-00005790: 0a20 2020 203a 7274 7970 653a 2073 7472  .    :rtype: str
-000057a0: 0a20 2020 2022 2222 0a20 2020 206d 2c20  .    """.    m, 
-000057b0: 7320 3d20 6469 766d 6f64 2873 2c20 3630  s = divmod(s, 60
-000057c0: 290a 2020 2020 682c 206d 203d 2064 6976  ).    h, m = div
-000057d0: 6d6f 6428 6d2c 2036 3029 0a20 2020 2072  mod(m, 60).    r
-000057e0: 6574 7572 6e20 2225 643a 2530 3264 3a25  eturn "%d:%02d:%
-000057f0: 3032 6422 2025 2028 682c 206d 2c20 7329  02d" % (h, m, s)
-00005800: 0a0a 0a64 6566 2068 6d73 5f66 7261 6374  ...def hms_fract
-00005810: 696f 6e28 732c 2064 6563 696d 616c 733d  ion(s, decimals=
-00005820: 3429 3a0a 2020 2020 2222 220a 2020 2020  4):.    """.    
-00005830: 3a70 6172 616d 2066 6c6f 6174 2073 3a20  :param float s: 
-00005840: 7365 636f 6e64 730a 2020 2020 3a70 6172  seconds.    :par
-00005850: 616d 2069 6e74 2064 6563 696d 616c 733a  am int decimals:
-00005860: 2068 6f77 206d 7563 6820 6465 6369 6d61   how much decima
-00005870: 6c73 2074 6f20 7072 696e 740a 2020 2020  ls to print.    
-00005880: 3a72 6574 7572 6e3a 2065 2e67 2e20 2231  :return: e.g. "1
-00005890: 3a32 333a 3435 2e36 3738 3922 2028 6873  :23:45.6789" (hs
-000058a0: 3a6d 733a 7365 6373 290a 2020 2020 3a72  :ms:secs).    :r
-000058b0: 7479 7065 3a20 7374 720a 2020 2020 2222  type: str.    ""
-000058c0: 220a 2020 2020 7265 7475 726e 2068 6d73  ".    return hms
-000058d0: 2869 6e74 2873 2929 202b 2028 2822 2525  (int(s)) + (("%%
-000058e0: 2e30 2569 6622 2025 2064 6563 696d 616c  .0%if" % decimal
-000058f0: 7329 2025 2028 7320 2d20 696e 7428 7329  s) % (s - int(s)
-00005900: 2929 5b31 3a5d 0a0a 0a64 6566 2068 756d  ))[1:]...def hum
-00005910: 616e 5f73 697a 6528 6e2c 2066 6163 746f  an_size(n, facto
-00005920: 723d 3130 3030 2c20 6672 6163 3d30 2e38  r=1000, frac=0.8
-00005930: 2c20 7072 6563 3d31 293a 0a20 2020 2022  , prec=1):.    "
-00005940: 2222 0a20 2020 203a 7061 7261 6d20 696e  "".    :param in
-00005950: 747c 666c 6f61 7420 6e3a 0a20 2020 203a  t|float n:.    :
-00005960: 7061 7261 6d20 696e 7420 6661 6374 6f72  param int factor
-00005970: 3a20 666f 7220 6561 6368 206f 6620 7468  : for each of th
-00005980: 6520 756e 6974 7320 4b2c 204d 2c20 472c  e units K, M, G,
-00005990: 2054 0a20 2020 203a 7061 7261 6d20 666c   T.    :param fl
-000059a0: 6f61 7420 6672 6163 3a20 7768 656e 2074  oat frac: when t
-000059b0: 6f20 676f 206f 7665 7220 746f 2074 6865  o go over to the
-000059c0: 206e 6578 7420 6269 6767 6572 2075 6e69   next bigger uni
-000059d0: 740a 2020 2020 3a70 6172 616d 2069 6e74  t.    :param int
-000059e0: 2070 7265 633a 2068 6f77 206d 7563 6820   prec: how much 
-000059f0: 6465 6369 6d61 6c73 2061 6674 6572 2074  decimals after t
-00005a00: 6865 2064 6f74 0a20 2020 203a 7265 7475  he dot.    :retu
-00005a10: 726e 3a20 6875 6d61 6e20 7265 6164 6162  rn: human readab
-00005a20: 6c65 2073 697a 652c 2075 7369 6e67 204b  le size, using K
-00005a30: 2c20 4d2c 2047 2c20 540a 2020 2020 3a72  , M, G, T.    :r
-00005a40: 7479 7065 3a20 7374 720a 2020 2020 2222  type: str.    ""
-00005a50: 220a 2020 2020 706f 7374 6669 7865 7320  ".    postfixes 
-00005a60: 3d20 5b22 222c 2022 4b22 2c20 224d 222c  = ["", "K", "M",
-00005a70: 2022 4722 2c20 2254 225d 0a20 2020 2069   "G", "T"].    i
-00005a80: 203d 2030 0a20 2020 2077 6869 6c65 2069   = 0.    while i
-00005a90: 203c 206c 656e 2870 6f73 7466 6978 6573   < len(postfixes
-00005aa0: 2920 2d20 3120 616e 6420 6e20 3e20 2866  ) - 1 and n > (f
-00005ab0: 6163 746f 7220 2a2a 2028 6920 2b20 3129  actor ** (i + 1)
-00005ac0: 2920 2a20 6672 6163 3a0a 2020 2020 2020  ) * frac:.      
-00005ad0: 2020 6920 2b3d 2031 0a20 2020 2069 6620    i += 1.    if 
-00005ae0: 6920 3d3d 2030 3a0a 2020 2020 2020 2020  i == 0:.        
-00005af0: 7265 7475 726e 2073 7472 286e 290a 2020  return str(n).  
-00005b00: 2020 7265 7475 726e 2028 2225 2e22 202b    return ("%." +
-00005b10: 2073 7472 2870 7265 6329 202b 2022 6622   str(prec) + "f"
-00005b20: 2920 2520 2866 6c6f 6174 286e 2920 2f20  ) % (float(n) / 
-00005b30: 2866 6163 746f 722a 2a69 2929 202b 2070  (factor**i)) + p
-00005b40: 6f73 7466 6978 6573 5b69 5d0a 0a0a 6465  ostfixes[i]...de
-00005b50: 6620 6875 6d61 6e5f 6279 7465 735f 7369  f human_bytes_si
-00005b60: 7a65 286e 2c20 6661 6374 6f72 3d31 3032  ze(n, factor=102
-00005b70: 342c 2066 7261 633d 302e 382c 2070 7265  4, frac=0.8, pre
-00005b80: 633d 3129 3a0a 2020 2020 2222 220a 2020  c=1):.    """.  
-00005b90: 2020 3a70 6172 616d 2069 6e74 7c66 6c6f    :param int|flo
-00005ba0: 6174 206e 3a0a 2020 2020 3a70 6172 616d  at n:.    :param
-00005bb0: 2069 6e74 2066 6163 746f 723a 2073 6565   int factor: see
-00005bc0: 203a 6675 6e63 3a60 6875 6d61 6e5f 7369   :func:`human_si
-00005bd0: 7a65 602e 2031 3032 3420 6279 2064 6566  ze`. 1024 by def
-00005be0: 6175 6c74 2066 6f72 2062 7974 6573 0a20  ault for bytes. 
-00005bf0: 2020 203a 7061 7261 6d20 666c 6f61 7420     :param float 
-00005c00: 6672 6163 3a20 7365 6520 3a66 756e 633a  frac: see :func:
-00005c10: 6068 756d 616e 5f73 697a 6560 0a20 2020  `human_size`.   
-00005c20: 203a 7061 7261 6d20 696e 7420 7072 6563   :param int prec
-00005c30: 3a20 686f 7720 6d75 6368 2064 6563 696d  : how much decim
-00005c40: 616c 7320 6166 7465 7220 7468 6520 646f  als after the do
-00005c50: 740a 2020 2020 3a72 6574 7572 6e3a 2068  t.    :return: h
-00005c60: 756d 616e 2072 6561 6461 626c 6520 6279  uman readable by
-00005c70: 7465 2073 697a 652c 2075 7369 6e67 204b  te size, using K
-00005c80: 2c20 4d2c 2047 2c20 542c 2077 6974 6820  , M, G, T, with 
-00005c90: 2242 2220 6174 2074 6865 2065 6e64 0a20  "B" at the end. 
-00005ca0: 2020 203a 7274 7970 653a 2073 7472 0a20     :rtype: str. 
-00005cb0: 2020 2022 2222 0a20 2020 2072 6574 7572     """.    retur
-00005cc0: 6e20 6875 6d61 6e5f 7369 7a65 286e 2c20  n human_size(n, 
-00005cd0: 6661 6374 6f72 3d66 6163 746f 722c 2066  factor=factor, f
-00005ce0: 7261 633d 6672 6163 2c20 7072 6563 3d70  rac=frac, prec=p
-00005cf0: 7265 6329 202b 2022 4222 0a0a 0a64 6566  rec) + "B"...def
-00005d00: 205f 7070 5f65 7874 7261 5f69 6e66 6f28   _pp_extra_info(
-00005d10: 6f62 6a2c 2064 6570 7468 5f6c 696d 6974  obj, depth_limit
-00005d20: 3d33 293a 0a20 2020 2022 2222 0a20 2020  =3):.    """.   
-00005d30: 203a 7061 7261 6d20 6f62 6a65 6374 206f   :param object o
-00005d40: 626a 3a0a 2020 2020 3a70 6172 616d 2069  bj:.    :param i
-00005d50: 6e74 2064 6570 7468 5f6c 696d 6974 3a0a  nt depth_limit:.
-00005d60: 2020 2020 3a72 6574 7572 6e3a 2065 7874      :return: ext
-00005d70: 7261 2069 6e66 6f20 2869 6620 6176 6169  ra info (if avai
-00005d80: 6c61 626c 653a 206c 656e 2c20 736f 6d65  lable: len, some
-00005d90: 2069 7465 6d73 2c20 2e2e 2e29 0a20 2020   items, ...).   
-00005da0: 203a 7274 7970 653a 2073 7472 0a20 2020   :rtype: str.   
-00005db0: 2022 2222 0a20 2020 2069 6620 6973 696e   """.    if isin
-00005dc0: 7374 616e 6365 286f 626a 2c20 6e70 2e6e  stance(obj, np.n
-00005dd0: 6461 7272 6179 293a 0a20 2020 2020 2020  darray):.       
-00005de0: 2072 6574 7572 6e20 2273 6861 7065 3d25   return "shape=%
-00005df0: 7222 2025 2028 6f62 6a2e 7368 6170 652c  r" % (obj.shape,
-00005e00: 290a 2020 2020 7320 3d20 5b5d 0a20 2020  ).    s = [].   
-00005e10: 2069 6620 6861 7361 7474 7228 6f62 6a2c   if hasattr(obj,
-00005e20: 2022 5f5f 6c65 6e5f 5f22 293a 0a20 2020   "__len__"):.   
-00005e30: 2020 2020 2023 206e 6f69 6e73 7065 6374       # noinspect
-00005e40: 696f 6e20 5079 4272 6f61 6445 7863 6570  ion PyBroadExcep
-00005e50: 7469 6f6e 0a20 2020 2020 2020 2074 7279  tion.        try
-00005e60: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00005e70: 6e6f 696e 7370 6563 7469 6f6e 2050 7954  noinspection PyT
-00005e80: 7970 6543 6865 636b 6572 0a20 2020 2020  ypeChecker.     
-00005e90: 2020 2020 2020 2069 6620 7479 7065 286f         if type(o
-00005ea0: 626a 2920 696e 2028 7374 722c 2075 6e69  bj) in (str, uni
-00005eb0: 636f 6465 2c20 6c69 7374 2c20 7475 706c  code, list, tupl
-00005ec0: 652c 2064 6963 7429 2061 6e64 206c 656e  e, dict) and len
-00005ed0: 286f 626a 2920 3c3d 2035 3a0a 2020 2020  (obj) <= 5:.    
-00005ee0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00005ef0: 2020 2320 646f 6e27 7420 7072 696e 7420    # don't print 
-00005f00: 6c65 6e20 696e 2074 6869 7320 6361 7365  len in this case
-00005f10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00005f20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00005f30: 2020 2073 202b 3d20 5b22 6c65 6e20 3d20     s += ["len = 
-00005f40: 2569 2220 2520 6f62 6a2e 5f5f 6c65 6e5f  %i" % obj.__len_
-00005f50: 5f28 295d 2020 2320 6e6f 7161 0a20 2020  _()]  # noqa.   
-00005f60: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-00005f70: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-00005f80: 2020 2070 6173 730a 2020 2020 6966 2064     pass.    if d
-00005f90: 6570 7468 5f6c 696d 6974 203e 2030 2061  epth_limit > 0 a
-00005fa0: 6e64 2068 6173 6174 7472 286f 626a 2c20  nd hasattr(obj, 
-00005fb0: 225f 5f67 6574 6974 656d 5f5f 2229 3a0a  "__getitem__"):.
-00005fc0: 2020 2020 2020 2020 2320 6e6f 696e 7370          # noinsp
-00005fd0: 6563 7469 6f6e 2050 7942 726f 6164 4578  ection PyBroadEx
-00005fe0: 6365 7074 696f 6e0a 2020 2020 2020 2020  ception.        
-00005ff0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00006000: 2069 6620 7479 7065 286f 626a 2920 696e   if type(obj) in
-00006010: 2028 7374 722c 2075 6e69 636f 6465 293a   (str, unicode):
-00006020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006030: 2070 6173 7320 2023 2064 6f65 736e 2774   pass  # doesn't
-00006040: 206d 616b 6520 7365 6e73 6520 746f 2067   make sense to g
-00006050: 6574 2073 7562 2069 7465 6d73 2068 6572  et sub items her
-00006060: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-00006070: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006080: 2020 2020 7375 625f 6f62 6a20 3d20 6f62      sub_obj = ob
-00006090: 6a2e 5f5f 6765 7469 7465 6d5f 5f28 3029  j.__getitem__(0)
-000060a0: 2020 2320 6e6f 7161 0a20 2020 2020 2020    # noqa.       
-000060b0: 2020 2020 2020 2020 2065 7874 7261 5f69           extra_i
-000060c0: 6e66 6f20 3d20 5f70 705f 6578 7472 615f  nfo = _pp_extra_
-000060d0: 696e 666f 2873 7562 5f6f 626a 2c20 6465  info(sub_obj, de
-000060e0: 7074 685f 6c69 6d69 7420 2d20 3129 0a20  pth_limit - 1). 
-000060f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006100: 6620 6578 7472 615f 696e 666f 2021 3d20  f extra_info != 
-00006110: 2222 3a0a 2020 2020 2020 2020 2020 2020  "":.            
-00006120: 2020 2020 2020 2020 7320 2b3d 205b 225f          s += ["_
-00006130: 5b30 5d3a 207b 2573 7d22 2025 2065 7874  [0]: {%s}" % ext
-00006140: 7261 5f69 6e66 6f5d 0a20 2020 2020 2020  ra_info].       
-00006150: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00006160: 6e3a 0a20 2020 2020 2020 2020 2020 2070  n:.            p
-00006170: 6173 730a 2020 2020 7265 7475 726e 2022  ass.    return "
-00006180: 2c20 222e 6a6f 696e 2873 290a 0a0a 5f70  , ".join(s)..._p
-00006190: 7265 7474 795f 7072 696e 745f 6c69 6d69  retty_print_limi
-000061a0: 7420 3d20 3330 300a 5f70 7265 7474 795f  t = 300._pretty_
-000061b0: 7072 696e 745f 6173 5f62 7974 6573 203d  print_as_bytes =
-000061c0: 2046 616c 7365 0a0a 0a64 6566 2073 6574   False...def set
-000061d0: 5f70 7265 7474 795f 7072 696e 745f 6465  _pretty_print_de
-000061e0: 6661 756c 745f 6c69 6d69 7428 6c69 6d69  fault_limit(limi
-000061f0: 7429 3a0a 2020 2020 2222 220a 2020 2020  t):.    """.    
-00006200: 3a70 6172 616d 2069 6e74 7c66 6c6f 6174  :param int|float
-00006210: 206c 696d 6974 3a20 7573 6520 666c 6f61   limit: use floa
-00006220: 7428 2269 6e66 2229 2074 6f20 6469 7361  t("inf") to disa
-00006230: 626c 650a 2020 2020 2222 220a 2020 2020  ble.    """.    
-00006240: 676c 6f62 616c 205f 7072 6574 7479 5f70  global _pretty_p
-00006250: 7269 6e74 5f6c 696d 6974 0a20 2020 205f  rint_limit.    _
-00006260: 7072 6574 7479 5f70 7269 6e74 5f6c 696d  pretty_print_lim
-00006270: 6974 203d 206c 696d 6974 0a0a 0a64 6566  it = limit...def
-00006280: 2073 6574 5f70 7265 7474 795f 7072 696e   set_pretty_prin
-00006290: 745f 6173 5f62 7974 6573 2861 735f 6279  t_as_bytes(as_by
-000062a0: 7465 7329 3a0a 2020 2020 2222 220a 2020  tes):.    """.  
-000062b0: 2020 3a70 6172 616d 2062 6f6f 6c20 6173    :param bool as
-000062c0: 5f62 7974 6573 3a0a 2020 2020 2222 220a  _bytes:.    """.
-000062d0: 2020 2020 676c 6f62 616c 205f 7072 6574      global _pret
-000062e0: 7479 5f70 7269 6e74 5f61 735f 6279 7465  ty_print_as_byte
-000062f0: 730a 2020 2020 5f70 7265 7474 795f 7072  s.    _pretty_pr
-00006300: 696e 745f 6173 5f62 7974 6573 203d 2061  int_as_bytes = a
-00006310: 735f 6279 7465 730a 0a0a 6465 6620 7072  s_bytes...def pr
-00006320: 6574 7479 5f70 7269 6e74 286f 626a 2c20  etty_print(obj, 
-00006330: 6c69 6d69 743d 4e6f 6e65 293a 0a20 2020  limit=None):.   
-00006340: 2022 2222 0a20 2020 203a 7061 7261 6d20   """.    :param 
-00006350: 6f62 6a65 6374 206f 626a 3a0a 2020 2020  object obj:.    
-00006360: 3a70 6172 616d 2069 6e74 7c66 6c6f 6174  :param int|float
-00006370: 206c 696d 6974 3a20 7573 6520 666c 6f61   limit: use floa
-00006380: 7428 2269 6e66 2229 2074 6f20 6469 7361  t("inf") to disa
-00006390: 626c 652e 204e 6f6e 6520 7769 6c6c 2075  ble. None will u
-000063a0: 7365 2074 6865 2064 6566 6175 6c74 2c20  se the default, 
-000063b0: 7669 6120 7365 745f 7072 6574 7479 5f70  via set_pretty_p
-000063c0: 7269 6e74 5f64 6566 6175 6c74 5f6c 696d  rint_default_lim
-000063d0: 6974 0a20 2020 203a 7265 7475 726e 3a20  it.    :return: 
-000063e0: 7265 7072 286f 626a 292c 206f 7220 736f  repr(obj), or so
-000063f0: 6d65 2073 686f 7274 6564 2076 6572 7369  me shorted versi
-00006400: 6f6e 206f 6620 7468 6174 2c20 6d61 7962  on of that, mayb
-00006410: 6520 7769 7468 2065 7874 7261 2069 6e66  e with extra inf
-00006420: 6f0a 2020 2020 3a72 7479 7065 3a20 7374  o.    :rtype: st
-00006430: 720a 2020 2020 2222 220a 2020 2020 6966  r.    """.    if
-00006440: 205f 7072 6574 7479 5f70 7269 6e74 5f61   _pretty_print_a
-00006450: 735f 6279 7465 7320 616e 6420 6973 696e  s_bytes and isin
-00006460: 7374 616e 6365 286f 626a 2c20 6e70 2e6e  stance(obj, np.n
-00006470: 6461 7272 6179 293a 0a20 2020 2020 2020  darray):.       
-00006480: 2062 7320 3d20 6f62 6a2e 746f 6279 7465   bs = obj.tobyte
-00006490: 7328 290a 2020 2020 2020 2020 696d 706f  s().        impo
-000064a0: 7274 2067 7a69 700a 0a20 2020 2020 2020  rt gzip..       
-000064b0: 2062 7320 3d20 677a 6970 2e63 6f6d 7072   bs = gzip.compr
-000064c0: 6573 7328 6273 290a 2020 2020 2020 2020  ess(bs).        
-000064d0: 696d 706f 7274 2062 6173 6536 340a 0a20  import base64.. 
-000064e0: 2020 2020 2020 2069 6620 6c65 6e28 6273         if len(bs
-000064f0: 2920 3e20 3537 3a0a 2020 2020 2020 2020  ) > 57:.        
-00006500: 2020 2020 7061 7274 7320 3d20 5b5d 0a20      parts = []. 
-00006510: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-00006520: 206c 656e 2862 7329 203e 2030 3a0a 2020   len(bs) > 0:.  
-00006530: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00006540: 7274 732e 6170 7065 6e64 2862 735b 3a35  rts.append(bs[:5
-00006550: 375d 290a 2020 2020 2020 2020 2020 2020  7]).            
-00006560: 2020 2020 6273 203d 2062 735b 3537 3a5d      bs = bs[57:]
-00006570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006580: 2069 6620 6c65 6e28 6273 2920 3d3d 2030   if len(bs) == 0
-00006590: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000065a0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-000065b0: 2020 2020 2020 2020 7320 3d20 225c 6e20          s = "\n 
-000065c0: 2022 202b 2022 5c6e 2020 222e 6a6f 696e   " + "\n  ".join
-000065d0: 285b 7265 7072 2862 6173 6536 342e 656e  ([repr(base64.en
-000065e0: 636f 6465 6279 7465 7328 6273 292e 7374  codebytes(bs).st
-000065f0: 7269 7028 2929 2066 6f72 2062 7320 696e  rip()) for bs in
-00006600: 2070 6172 7473 5d29 202b 2022 5c6e 2020   parts]) + "\n  
-00006610: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
-00006620: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
-00006630: 7265 7072 2862 6173 6536 342e 656e 636f  repr(base64.enco
-00006640: 6465 6279 7465 7328 6273 292e 7374 7269  debytes(bs).stri
-00006650: 7028 2929 0a20 2020 2020 2020 2073 203d  p()).        s =
-00006660: 2022 6e75 6d70 792e 6672 6f6d 6275 6666   "numpy.frombuff
-00006670: 6572 2867 7a69 702e 6465 636f 6d70 7265  er(gzip.decompre
-00006680: 7373 2862 6173 6536 342e 6465 636f 6465  ss(base64.decode
-00006690: 6279 7465 7328 2573 2929 2c20 6474 7970  bytes(%s)), dtyp
-000066a0: 653d 2572 292e 7265 7368 6170 6528 2572  e=%r).reshape(%r
-000066b0: 2922 2025 2028 0a20 2020 2020 2020 2020  )" % (.         
-000066c0: 2020 2073 2c0a 2020 2020 2020 2020 2020     s,.          
-000066d0: 2020 7374 7228 6f62 6a2e 6474 7970 6529    str(obj.dtype)
-000066e0: 2c0a 2020 2020 2020 2020 2020 2020 6f62  ,.            ob
-000066f0: 6a2e 7368 6170 652c 0a20 2020 2020 2020  j.shape,.       
-00006700: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-00006710: 2020 2020 2073 203d 2072 6570 7228 6f62       s = repr(ob
-00006720: 6a29 0a20 2020 2069 6620 6c69 6d69 7420  j).    if limit 
-00006730: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00006740: 206c 696d 6974 203d 205f 7072 6574 7479   limit = _pretty
-00006750: 5f70 7269 6e74 5f6c 696d 6974 0a20 2020  _print_limit.   
-00006760: 2069 6620 6c65 6e28 7329 203e 206c 696d   if len(s) > lim
-00006770: 6974 3a0a 2020 2020 2020 2020 7320 3d20  it:.        s = 
-00006780: 735b 3a20 696e 7428 6c69 6d69 7429 202d  s[: int(limit) -
-00006790: 2033 5d0a 2020 2020 2020 2020 7320 2b3d   3].        s +=
-000067a0: 2022 2e2e 2e22 0a20 2020 2065 7874 7261   "...".    extra
-000067b0: 5f69 6e66 6f20 3d20 5f70 705f 6578 7472  _info = _pp_extr
-000067c0: 615f 696e 666f 286f 626a 290a 2020 2020  a_info(obj).    
-000067d0: 6966 2065 7874 7261 5f69 6e66 6f20 213d  if extra_info !=
-000067e0: 2022 223a 0a20 2020 2020 2020 2073 202b   "":.        s +
-000067f0: 3d20 222c 2022 202b 2065 7874 7261 5f69  = ", " + extra_i
-00006800: 6e66 6f0a 2020 2020 7265 7475 726e 2073  nfo.    return s
-00006810: 0a0a 0a64 6566 2070 726f 6772 6573 735f  ...def progress_
-00006820: 6261 7228 636f 6d70 6c65 7465 3d31 2e30  bar(complete=1.0
-00006830: 2c20 7072 6566 6978 3d22 222c 2073 7566  , prefix="", suf
-00006840: 6669 783d 2222 2c20 6669 6c65 3d4e 6f6e  fix="", file=Non
-00006850: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00006860: 5072 696e 7473 2073 6f6d 6520 7072 6f67  Prints some prog
-00006870: 7265 7373 2062 6172 2e0a 0a20 2020 203a  ress bar...    :
-00006880: 7061 7261 6d20 666c 6f61 7420 636f 6d70  param float comp
-00006890: 6c65 7465 3a20 6672 6f6d 2030 2e30 2074  lete: from 0.0 t
-000068a0: 6f20 312e 300a 2020 2020 3a70 6172 616d  o 1.0.    :param
-000068b0: 2073 7472 2070 7265 6669 783a 0a20 2020   str prefix:.   
-000068c0: 203a 7061 7261 6d20 7374 7220 7375 6666   :param str suff
-000068d0: 6978 3a0a 2020 2020 3a70 6172 616d 2069  ix:.    :param i
-000068e0: 6f2e 5465 7874 494f 5772 6170 7065 727c  o.TextIOWrapper|
-000068f0: 7479 7069 6e67 2e54 6578 7449 4f7c 4e6f  typing.TextIO|No
-00006900: 6e65 2066 696c 653a 2077 6865 7265 2074  ne file: where t
-00006910: 6f20 7072 696e 742e 2073 7464 6f75 7420  o print. stdout 
-00006920: 6279 2064 6566 6175 6c74 0a20 2020 203a  by default.    :
-00006930: 7265 7475 726e 3a20 6e6f 7468 696e 672c  return: nothing,
-00006940: 2077 696c 6c20 7072 696e 7420 6f6e 2060   will print on `
-00006950: 6066 696c 6560 600a 2020 2020 2222 220a  `file``.    """.
-00006960: 2020 2020 6966 2066 696c 6520 6973 204e      if file is N
-00006970: 6f6e 653a 0a20 2020 2020 2020 2066 696c  one:.        fil
-00006980: 6520 3d20 7379 732e 7374 646f 7574 0a20  e = sys.stdout. 
-00006990: 2020 2074 6572 6d69 6e61 6c5f 7769 6474     terminal_widt
-000069a0: 682c 205f 203d 2074 6572 6d69 6e61 6c5f  h, _ = terminal_
-000069b0: 7369 7a65 2866 696c 653d 6669 6c65 290a  size(file=file).
-000069c0: 2020 2020 6966 2074 6572 6d69 6e61 6c5f      if terminal_
-000069d0: 7769 6474 6820 3c3d 2030 3a0a 2020 2020  width <= 0:.    
-000069e0: 2020 2020 7265 7475 726e 0a20 2020 2069      return.    i
-000069f0: 6620 636f 6d70 6c65 7465 203d 3d20 312e  f complete == 1.
-00006a00: 303a 0a20 2020 2020 2020 2066 696c 652e  0:.        file.
-00006a10: 7772 6974 6528 225c 7225 7322 2025 2028  write("\r%s" % (
-00006a20: 7465 726d 696e 616c 5f77 6964 7468 202a  terminal_width *
-00006a30: 2022 2022 2929 0a20 2020 2020 2020 2066   " ")).        f
-00006a40: 696c 652e 666c 7573 6828 290a 2020 2020  ile.flush().    
-00006a50: 2020 2020 6669 6c65 2e77 7269 7465 2822      file.write("
-00006a60: 5c72 2229 0a20 2020 2020 2020 2066 696c  \r").        fil
-00006a70: 652e 666c 7573 6828 290a 2020 2020 2020  e.flush().      
-00006a80: 2020 7265 7475 726e 0a20 2020 2070 726f    return.    pro
-00006a90: 6772 6573 7320 3d20 2225 2e30 3266 2525  gress = "%.02f%%
-00006aa0: 2220 2520 2863 6f6d 706c 6574 6520 2a20  " % (complete * 
-00006ab0: 3130 3029 0a20 2020 2069 6620 7072 6566  100).    if pref
-00006ac0: 6978 2021 3d20 2222 3a0a 2020 2020 2020  ix != "":.      
-00006ad0: 2020 7072 6566 6978 203d 2070 7265 6669    prefix = prefi
-00006ae0: 7820 2b20 2220 220a 2020 2020 6966 2073  x + " ".    if s
-00006af0: 7566 6669 7820 213d 2022 223a 0a20 2020  uffix != "":.   
-00006b00: 2020 2020 2073 7566 6669 7820 3d20 2220       suffix = " 
-00006b10: 2220 2b20 7375 6666 6978 0a20 2020 206e  " + suffix.    n
-00006b20: 746f 7461 6c20 3d20 7465 726d 696e 616c  total = terminal
-00006b30: 5f77 6964 7468 202d 206c 656e 2870 726f  _width - len(pro
-00006b40: 6772 6573 7329 202d 206c 656e 2870 7265  gress) - len(pre
-00006b50: 6669 7829 202d 206c 656e 2873 7566 6669  fix) - len(suffi
-00006b60: 7829 202d 2034 0a20 2020 2062 6172 7320  x) - 4.    bars 
-00006b70: 3d20 227c 2220 2a20 696e 7428 636f 6d70  = "|" * int(comp
-00006b80: 6c65 7465 202a 206e 746f 7461 6c29 0a20  lete * ntotal). 
-00006b90: 2020 2073 7061 6365 7320 3d20 2220 2220     spaces = " " 
-00006ba0: 2a20 286e 746f 7461 6c20 2d20 696e 7428  * (ntotal - int(
-00006bb0: 636f 6d70 6c65 7465 202a 206e 746f 7461  complete * ntota
-00006bc0: 6c29 290a 2020 2020 6261 7220 3d20 6261  l)).    bar = ba
-00006bd0: 7273 202b 2073 7061 6365 730a 2020 2020  rs + spaces.    
-00006be0: 6669 6c65 2e77 7269 7465 280a 2020 2020  file.write(.    
-00006bf0: 2020 2020 225c 7225 7322 2025 2070 7265      "\r%s" % pre
-00006c00: 6669 7820 2b20 225b 2220 2b20 6261 725b  fix + "[" + bar[
-00006c10: 3a20 6c65 6e28 6261 7229 202f 2f20 325d  : len(bar) // 2]
-00006c20: 202b 2022 2022 202b 2070 726f 6772 6573   + " " + progres
-00006c30: 7320 2b20 2220 2220 2b20 6261 725b 6c65  s + " " + bar[le
-00006c40: 6e28 6261 7229 202f 2f20 3220 3a5d 202b  n(bar) // 2 :] +
-00006c50: 2022 5d22 202b 2073 7566 6669 780a 2020   "]" + suffix.  
-00006c60: 2020 290a 2020 2020 6669 6c65 2e66 6c75    ).    file.flu
-00006c70: 7368 2829 0a0a 0a63 6c61 7373 205f 5072  sh()...class _Pr
-00006c80: 6f67 7265 7373 4261 7257 6974 6854 696d  ogressBarWithTim
-00006c90: 6553 7461 7473 3a0a 2020 2020 2222 220a  eStats:.    """.
-00006ca0: 2020 2020 476c 6f62 616c 2063 6c6f 7375      Global closu
-00006cb0: 7265 2e20 5573 6564 2062 7920 3a66 756e  re. Used by :fun
-00006cc0: 633a 6070 726f 6772 6573 735f 6261 725f  c:`progress_bar_
-00006cd0: 7769 7468 5f74 696d 6560 2e0a 2020 2020  with_time`..    
-00006ce0: 2222 220a 0a20 2020 2073 7461 7274 5f74  """..    start_t
-00006cf0: 696d 6520 3d20 4e6f 6e65 0a20 2020 206c  ime = None.    l
-00006d00: 6173 745f 636f 6d70 6c65 7465 203d 204e  ast_complete = N
-00006d10: 6f6e 650a 0a0a 6465 6620 7072 6f67 7265  one...def progre
-00006d20: 7373 5f62 6172 5f77 6974 685f 7469 6d65  ss_bar_with_time
-00006d30: 2863 6f6d 706c 6574 653d 312e 302c 2070  (complete=1.0, p
-00006d40: 7265 6669 783d 2222 2c20 2a2a 6b77 6172  refix="", **kwar
-00006d50: 6773 293a 0a20 2020 2022 2222 0a20 2020  gs):.    """.   
-00006d60: 203a 6675 6e63 3a60 7072 6f67 7265 7373   :func:`progress
-00006d70: 5f62 6172 6020 7769 7468 2061 6464 6974  _bar` with addit
-00006d80: 696f 6e61 6c20 7265 6d61 696e 696e 6720  ional remaining 
-00006d90: 7469 6d65 2065 7374 696d 6174 696f 6e2e  time estimation.
-00006da0: 0a0a 2020 2020 3a70 6172 616d 2066 6c6f  ..    :param flo
-00006db0: 6174 2063 6f6d 706c 6574 653a 0a20 2020  at complete:.   
-00006dc0: 203a 7061 7261 6d20 7374 7220 7072 6566   :param str pref
-00006dd0: 6978 3a0a 2020 2020 3a70 6172 616d 206b  ix:.    :param k
-00006de0: 7761 7267 733a 2070 6173 7365 6420 746f  wargs: passed to
-00006df0: 203a 6675 6e63 3a60 7072 6f67 7265 7373   :func:`progress
-00006e00: 5f62 6172 600a 2020 2020 3a72 6574 7572  _bar`.    :retur
-00006e10: 6e3a 206e 6f74 6869 6e67 0a20 2020 2022  n: nothing.    "
-00006e20: 2222 0a20 2020 2073 7461 7473 203d 205f  "".    stats = _
-00006e30: 5072 6f67 7265 7373 4261 7257 6974 6854  ProgressBarWithT
-00006e40: 696d 6553 7461 7473 0a20 2020 2069 6620  imeStats.    if 
-00006e50: 7374 6174 732e 7374 6172 745f 7469 6d65  stats.start_time
-00006e60: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00006e70: 2020 7374 6174 732e 7374 6172 745f 7469    stats.start_ti
-00006e80: 6d65 203d 2074 696d 652e 7469 6d65 2829  me = time.time()
-00006e90: 0a20 2020 2020 2020 2073 7461 7473 2e6c  .        stats.l
-00006ea0: 6173 745f 636f 6d70 6c65 7465 203d 2063  ast_complete = c
-00006eb0: 6f6d 706c 6574 650a 2020 2020 6966 2073  omplete.    if s
-00006ec0: 7461 7473 2e6c 6173 745f 636f 6d70 6c65  tats.last_comple
-00006ed0: 7465 203e 2063 6f6d 706c 6574 653a 0a20  te > complete:. 
-00006ee0: 2020 2020 2020 2073 7461 7473 2e73 7461         stats.sta
-00006ef0: 7274 5f74 696d 6520 3d20 7469 6d65 2e74  rt_time = time.t
-00006f00: 696d 6528 290a 2020 2020 7374 6174 732e  ime().    stats.
-00006f10: 6c61 7374 5f63 6f6d 706c 6574 6520 3d20  last_complete = 
-00006f20: 636f 6d70 6c65 7465 0a0a 2020 2020 7374  complete..    st
-00006f30: 6172 745f 656c 6170 7365 6420 3d20 7469  art_elapsed = ti
-00006f40: 6d65 2e74 696d 6528 2920 2d20 7374 6174  me.time() - stat
-00006f50: 732e 7374 6172 745f 7469 6d65 0a20 2020  s.start_time.   
-00006f60: 2069 6620 636f 6d70 6c65 7465 203e 2030   if complete > 0
-00006f70: 3a0a 2020 2020 2020 2020 746f 7461 6c5f  :.        total_
-00006f80: 7469 6d65 5f65 7374 696d 6174 6564 203d  time_estimated =
-00006f90: 2073 7461 7274 5f65 6c61 7073 6564 202f   start_elapsed /
-00006fa0: 2063 6f6d 706c 6574 650a 2020 2020 2020   complete.      
-00006fb0: 2020 7265 6d61 696e 696e 675f 6573 7469    remaining_esti
-00006fc0: 6d61 7465 6420 3d20 746f 7461 6c5f 7469  mated = total_ti
-00006fd0: 6d65 5f65 7374 696d 6174 6564 202d 2073  me_estimated - s
-00006fe0: 7461 7274 5f65 6c61 7073 6564 0a20 2020  tart_elapsed.   
-00006ff0: 2020 2020 2069 6620 7072 6566 6978 3a0a       if prefix:.
-00007000: 2020 2020 2020 2020 2020 2020 7072 6566              pref
-00007010: 6978 202b 3d20 222c 2022 202b 2068 6d73  ix += ", " + hms
-00007020: 2872 656d 6169 6e69 6e67 5f65 7374 696d  (remaining_estim
-00007030: 6174 6564 290a 2020 2020 2020 2020 656c  ated).        el
-00007040: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00007050: 7072 6566 6978 203d 2068 6d73 2872 656d  prefix = hms(rem
-00007060: 6169 6e69 6e67 5f65 7374 696d 6174 6564  aining_estimated
-00007070: 290a 2020 2020 7072 6f67 7265 7373 5f62  ).    progress_b
-00007080: 6172 2863 6f6d 706c 6574 652c 2070 7265  ar(complete, pre
-00007090: 6669 783d 7072 6566 6978 2c20 2a2a 6b77  fix=prefix, **kw
-000070a0: 6172 6773 290a 0a0a 6465 6620 6176 6169  args)...def avai
-000070b0: 6c61 626c 655f 7068 7973 6963 616c 5f6d  lable_physical_m
-000070c0: 656d 6f72 795f 696e 5f62 7974 6573 2829  emory_in_bytes()
-000070d0: 3a0a 2020 2020 2222 220a 2020 2020 3a72  :.    """.    :r
-000070e0: 7479 7065 3a20 696e 740a 2020 2020 2222  type: int.    ""
-000070f0: 220a 2020 2020 2320 6e6f 696e 7370 6563  ".    # noinspec
-00007100: 7469 6f6e 2050 7942 726f 6164 4578 6365  tion PyBroadExce
-00007110: 7074 696f 6e0a 2020 2020 7472 793a 0a20  ption.    try:. 
-00007120: 2020 2020 2020 206d 656d 5f62 7974 6573         mem_bytes
-00007130: 203d 206f 732e 7379 7363 6f6e 6628 2253   = os.sysconf("S
-00007140: 435f 5041 4745 5f53 495a 4522 2920 2a20  C_PAGE_SIZE") * 
-00007150: 6f73 2e73 7973 636f 6e66 2822 5343 5f50  os.sysconf("SC_P
-00007160: 4859 535f 5041 4745 5322 290a 2020 2020  HYS_PAGES").    
-00007170: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00007180: 3a0a 2020 2020 2020 2020 6d65 6d5f 6279  :.        mem_by
-00007190: 7465 7320 3d20 3130 3234 2a2a 3420 2023  tes = 1024**4  #
-000071a0: 206a 7573 7420 736f 6d65 2072 616e 646f   just some rando
-000071b0: 6d20 6e75 6d62 6572 2c20 3154 420a 2020  m number, 1TB.  
-000071c0: 2020 7265 7475 726e 206d 656d 5f62 7974    return mem_byt
-000071d0: 6573 0a0a 0a64 6566 2064 6566 6175 6c74  es...def default
-000071e0: 5f63 6163 6865 5f73 697a 655f 696e 5f67  _cache_size_in_g
-000071f0: 6279 7465 7328 6661 6374 6f72 3d30 2e37  bytes(factor=0.7
-00007200: 293a 0a20 2020 2022 2222 0a20 2020 203a  ):.    """.    :
-00007210: 7061 7261 6d20 666c 6f61 747c 696e 7420  param float|int 
-00007220: 6661 6374 6f72 3a0a 2020 2020 3a72 7479  factor:.    :rty
-00007230: 7065 3a20 696e 740a 2020 2020 2222 220a  pe: int.    """.
-00007240: 2020 2020 6d65 6d5f 6762 7974 6573 203d      mem_gbytes =
-00007250: 2061 7661 696c 6162 6c65 5f70 6879 7369   available_physi
-00007260: 6361 6c5f 6d65 6d6f 7279 5f69 6e5f 6279  cal_memory_in_by
-00007270: 7465 7328 2920 2f20 2831 3032 342e 302a  tes() / (1024.0*
-00007280: 2a33 290a 2020 2020 7265 7475 726e 2069  *3).    return i
-00007290: 6e74 286d 656d 5f67 6279 7465 7320 2a20  nt(mem_gbytes * 
-000072a0: 6661 6374 6f72 290a 0a0a 6465 6620 6265  factor)...def be
-000072b0: 7474 6572 5f72 6570 7228 6f29 3a0a 2020  tter_repr(o):.  
-000072c0: 2020 2222 220a 2020 2020 5468 6520 6d61    """.    The ma
-000072d0: 696e 2064 6966 6665 7265 6e63 6520 746f  in difference to
-000072e0: 203a 6675 6e63 3a60 7265 7072 603a 2074   :func:`repr`: t
-000072f0: 6869 7320 6f6e 6520 6973 2064 6574 6572  his one is deter
-00007300: 6d69 6e69 7374 6963 2e0a 2020 2020 5468  ministic..    Th
-00007310: 6520 6f72 6967 2064 6963 742e 5f5f 7265  e orig dict.__re
-00007320: 7072 5f5f 2068 6173 2074 6865 206f 7264  pr__ has the ord
-00007330: 6572 2075 6e64 6566 696e 6564 2066 6f72  er undefined for
-00007340: 2064 6963 7420 6f72 2073 6574 2e0a 2020   dict or set..  
-00007350: 2020 466f 7220 6269 6720 6469 6374 732f    For big dicts/
-00007360: 7365 7473 2f6c 6973 7473 2c20 6164 6420  sets/lists, add 
-00007370: 222c 2220 6174 2074 6865 2065 6e64 2074  "," at the end t
-00007380: 6f20 6d61 6b65 2074 6578 7475 616c 2064  o make textual d
-00007390: 6966 6673 206e 6963 6572 2e0a 0a20 2020  iffs nicer...   
-000073a0: 203a 7061 7261 6d20 6f62 6a65 6374 206f   :param object o
-000073b0: 3a0a 2020 2020 3a72 7479 7065 3a20 7374  :.    :rtype: st
-000073c0: 720a 2020 2020 2222 220a 2020 2020 6966  r.    """.    if
-000073d0: 2069 7369 6e73 7461 6e63 6528 6f2c 206c   isinstance(o, l
-000073e0: 6973 7429 3a0a 2020 2020 2020 2020 7265  ist):.        re
-000073f0: 7475 726e 2022 5b5c 6e25 735d 2220 2520  turn "[\n%s]" % 
-00007400: 2222 2e6a 6f69 6e28 6d61 7028 6c61 6d62  "".join(map(lamb
-00007410: 6461 2076 3a20 6265 7474 6572 5f72 6570  da v: better_rep
-00007420: 7228 7629 202b 2022 2c5c 6e22 2c20 6f29  r(v) + ",\n", o)
-00007430: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
-00007440: 6e63 6528 6f2c 2064 6571 7565 293a 0a20  nce(o, deque):. 
-00007450: 2020 2020 2020 2072 6574 7572 6e20 2264         return "d
-00007460: 6571 7565 285b 5c6e 2573 5d29 2220 2520  eque([\n%s])" % 
-00007470: 2222 2e6a 6f69 6e28 6d61 7028 6c61 6d62  "".join(map(lamb
-00007480: 6461 2076 3a20 6265 7474 6572 5f72 6570  da v: better_rep
-00007490: 7228 7629 202b 2022 2c5c 6e22 2c20 6f29  r(v) + ",\n", o)
-000074a0: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
-000074b0: 6e63 6528 6f2c 2074 7570 6c65 293a 0a20  nce(o, tuple):. 
-000074c0: 2020 2020 2020 2069 6620 6c65 6e28 6f29         if len(o)
-000074d0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-000074e0: 2020 2072 6574 7572 6e20 2228 2573 2c29     return "(%s,)
-000074f0: 2220 2520 6f5b 305d 0a20 2020 2020 2020  " % o[0].       
-00007500: 2072 6574 7572 6e20 2228 2573 2922 2025   return "(%s)" %
-00007510: 2022 2c20 222e 6a6f 696e 286d 6170 2862   ", ".join(map(b
-00007520: 6574 7465 725f 7265 7072 2c20 6f29 290a  etter_repr, o)).
-00007530: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00007540: 6528 6f2c 2064 6963 7429 3a0a 2020 2020  e(o, dict):.    
-00007550: 2020 2020 6c73 203d 205b 6265 7474 6572      ls = [better
-00007560: 5f72 6570 7228 6b29 202b 2022 3a20 2220  _repr(k) + ": " 
-00007570: 2b20 6265 7474 6572 5f72 6570 7228 7629  + better_repr(v)
-00007580: 2066 6f72 2028 6b2c 2076 2920 696e 2073   for (k, v) in s
-00007590: 6f72 7465 6428 6f2e 6974 656d 7328 2929  orted(o.items())
-000075a0: 5d0a 2020 2020 2020 2020 6966 2073 756d  ].        if sum
-000075b0: 285b 6c65 6e28 7629 2066 6f72 2076 2069  ([len(v) for v i
-000075c0: 6e20 6c73 5d29 203e 3d20 3430 3a0a 2020  n ls]) >= 40:.  
-000075d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000075e0: 2022 7b5c 6e25 737d 2220 2520 2222 2e6a   "{\n%s}" % "".j
-000075f0: 6f69 6e28 5b76 202b 2022 2c5c 6e22 2066  oin([v + ",\n" f
-00007600: 6f72 2076 2069 6e20 6c73 5d29 0a20 2020  or v in ls]).   
-00007610: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00007620: 2020 2020 2020 2072 6574 7572 6e20 227b         return "{
-00007630: 2573 7d22 2025 2022 2c20 222e 6a6f 696e  %s}" % ", ".join
-00007640: 286c 7329 0a20 2020 2069 6620 6973 696e  (ls).    if isin
-00007650: 7374 616e 6365 286f 2c20 7365 7429 3a0a  stance(o, set):.
-00007660: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-00007670: 7365 7428 5b5c 6e25 735d 2922 2025 2022  set([\n%s])" % "
-00007680: 222e 6a6f 696e 286d 6170 286c 616d 6264  ".join(map(lambd
-00007690: 6120 763a 2062 6574 7465 725f 7265 7072  a v: better_repr
-000076a0: 2876 2920 2b20 222c 5c6e 222c 206f 2929  (v) + ",\n", o))
-000076b0: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-000076c0: 6365 286f 2c20 666c 6f61 7429 2061 6e64  ce(o, float) and
-000076d0: 2028 6d61 7468 2e69 736e 616e 286f 2920   (math.isnan(o) 
-000076e0: 6f72 206d 6174 682e 6973 696e 6628 6f29  or math.isinf(o)
-000076f0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00007700: 6e20 2266 6c6f 6174 2827 2573 2729 2220  n "float('%s')" 
-00007710: 2520 7265 7072 286f 290a 2020 2020 2320  % repr(o).    # 
-00007720: 6661 6c6c 6261 636b 0a20 2020 2072 6574  fallback.    ret
-00007730: 7572 6e20 7265 7072 286f 290a 0a0a 6465  urn repr(o)...de
-00007740: 6620 7369 6d70 6c65 5f6f 626a 5f72 6570  f simple_obj_rep
-00007750: 7228 6f62 6a29 3a0a 2020 2020 2222 220a  r(obj):.    """.
-00007760: 2020 2020 3a72 6574 7572 6e3a 2041 6c6c      :return: All
-00007770: 2073 656c 662e 5f5f 696e 6974 5f5f 2061   self.__init__ a
-00007780: 7267 732e 0a20 2020 203a 7274 7970 653a  rgs..    :rtype:
-00007790: 2073 7472 0a20 2020 2022 2222 0a20 2020   str.    """.   
-000077a0: 2072 6574 7572 6e20 6f62 6a2e 5f5f 636c   return obj.__cl
-000077b0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 202b  ass__.__name__ +
-000077c0: 2022 2825 7329 2220 2520 222c 2022 2e6a   "(%s)" % ", ".j
-000077d0: 6f69 6e28 0a20 2020 2020 2020 205b 2225  oin(.        ["%
-000077e0: 733d 2573 2220 2520 2861 7267 2c20 6265  s=%s" % (arg, be
-000077f0: 7474 6572 5f72 6570 7228 6765 7461 7474  tter_repr(getatt
-00007800: 7228 6f62 6a2c 2061 7267 2929 2920 666f  r(obj, arg))) fo
-00007810: 7220 6172 6720 696e 2067 6574 6172 6773  r arg in getargs
-00007820: 7065 6328 6f62 6a2e 5f5f 696e 6974 5f5f  pec(obj.__init__
-00007830: 292e 6172 6773 5b31 3a5d 5d0a 2020 2020  ).args[1:]].    
-00007840: 290a 0a0a 636c 6173 7320 4f62 6a41 7344  )...class ObjAsD
-00007850: 6963 7428 7479 7069 6e67 2e4d 6170 7069  ict(typing.Mappi
-00007860: 6e67 5b73 7472 2c20 6f62 6a65 6374 5d29  ng[str, object])
-00007870: 3a0a 2020 2020 2222 220a 2020 2020 5772  :.    """.    Wr
-00007880: 6170 7320 7570 2061 6e79 206f 626a 6563  aps up any objec
-00007890: 7420 6173 2061 2064 6963 742c 2077 6865  t as a dict, whe
-000078a0: 7265 2074 6865 2061 7474 7269 6275 7465  re the attribute
-000078b0: 7320 6265 636f 6d65 7320 7468 6520 6b65  s becomes the ke
-000078c0: 7973 2e0a 2020 2020 5365 6520 616c 736f  ys..    See also
-000078d0: 203a 636c 6173 733a 6044 6963 7441 734f   :class:`DictAsO
-000078e0: 626a 602e 0a20 2020 2022 2222 0a0a 2020  bj`..    """..  
-000078f0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00007900: 656c 662c 206f 626a 293a 0a20 2020 2020  elf, obj):.     
-00007910: 2020 2073 656c 662e 5f5f 6f62 6a20 3d20     self.__obj = 
-00007920: 6f62 6a0a 0a20 2020 2064 6566 205f 5f67  obj..    def __g
-00007930: 6574 6974 656d 5f5f 2873 656c 662c 2069  etitem__(self, i
-00007940: 7465 6d29 3a0a 2020 2020 2020 2020 6966  tem):.        if
-00007950: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00007960: 6974 656d 2c20 2873 7472 2c20 756e 6963  item, (str, unic
-00007970: 6f64 6529 293a 0a20 2020 2020 2020 2020  ode)):.         
-00007980: 2020 2072 6169 7365 204b 6579 4572 726f     raise KeyErro
-00007990: 7228 6974 656d 290a 2020 2020 2020 2020  r(item).        
-000079a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000079b0: 2072 6574 7572 6e20 6765 7461 7474 7228   return getattr(
-000079c0: 7365 6c66 2e5f 5f6f 626a 2c20 6974 656d  self.__obj, item
-000079d0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-000079e0: 2041 7474 7269 6275 7465 4572 726f 7220   AttributeError 
-000079f0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00007a00: 2020 7261 6973 6520 4b65 7945 7272 6f72    raise KeyError
-00007a10: 2865 290a 0a20 2020 2064 6566 205f 5f6c  (e)..    def __l
-00007a20: 656e 5f5f 2873 656c 6629 3a0a 2020 2020  en__(self):.    
-00007a30: 2020 2020 7265 7475 726e 206c 656e 2876      return len(v
-00007a40: 6172 7328 7365 6c66 2e5f 5f6f 626a 2929  ars(self.__obj))
-00007a50: 0a0a 2020 2020 6465 6620 5f5f 6974 6572  ..    def __iter
-00007a60: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-00007a70: 2020 7265 7475 726e 2069 7465 7228 7661    return iter(va
-00007a80: 7273 2873 656c 662e 5f5f 6f62 6a29 290a  rs(self.__obj)).
-00007a90: 0a20 2020 2064 6566 2069 7465 6d73 2873  .    def items(s
-00007aa0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00007ab0: 220a 2020 2020 2020 2020 3a72 6574 7572  ".        :retur
-00007ac0: 6e3a 2076 6172 7328 2e2e 292e 6974 656d  n: vars(..).item
-00007ad0: 7328 290a 2020 2020 2020 2020 3a72 7479  s().        :rty
-00007ae0: 7065 3a20 7365 745b 2873 7472 2c6f 626a  pe: set[(str,obj
-00007af0: 6563 7429 5d0a 2020 2020 2020 2020 2222  ect)].        ""
-00007b00: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00007b10: 2076 6172 7328 7365 6c66 2e5f 5f6f 626a   vars(self.__obj
-00007b20: 292e 6974 656d 7328 290a 0a0a 636c 6173  ).items()...clas
-00007b30: 7320 4469 6374 4173 4f62 6a3a 0a20 2020  s DictAsObj:.   
-00007b40: 2022 2222 0a20 2020 2057 7261 7073 2075   """.    Wraps u
-00007b50: 7020 616e 7920 6469 6374 696f 6e61 7279  p any dictionary
-00007b60: 2061 7320 616e 206f 626a 6563 742c 2077   as an object, w
-00007b70: 6865 7265 2074 6865 206b 6579 7320 6265  here the keys be
-00007b80: 636f 6d65 7320 7468 6520 6174 7472 6962  comes the attrib
-00007b90: 7574 6573 2e0a 2020 2020 5365 6520 616c  utes..    See al
-00007ba0: 736f 203a 636c 6173 733a 604f 626a 4173  so :class:`ObjAs
-00007bb0: 4469 6374 602e 0a20 2020 2022 2222 0a0a  Dict`..    """..
-00007bc0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00007bd0: 2873 656c 662c 2064 696b 743a 2044 6963  (self, dikt: Dic
-00007be0: 745b 7374 722c 2041 6e79 5d29 3a0a 2020  t[str, Any]):.  
-00007bf0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00007c00: 2020 3a70 6172 616d 2064 696b 743a 0a20    :param dikt:. 
-00007c10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007c20: 2020 2073 656c 662e 5f5f 6469 6374 5f5f     self.__dict__
-00007c30: 203d 2064 696b 740a 0a0a 6465 6620 6469   = dikt...def di
-00007c40: 6374 5f6a 6f69 6e65 6428 2a64 7329 3a0a  ct_joined(*ds):.
-00007c50: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
-00007c60: 616d 2064 6963 745b 542c 565d 2064 733a  am dict[T,V] ds:
-00007c70: 0a20 2020 203a 7265 7475 726e 3a20 616c  .    :return: al
-00007c80: 6c20 6469 6374 7320 6a6f 696e 6564 2074  l dicts joined t
-00007c90: 6f67 6574 6865 720a 2020 2020 3a72 7479  ogether.    :rty
-00007ca0: 7065 3a20 6469 6374 5b54 2c56 5d0a 2020  pe: dict[T,V].  
-00007cb0: 2020 2222 220a 2020 2020 7265 7320 3d20    """.    res = 
-00007cc0: 7b7d 0a20 2020 2066 6f72 2064 2069 6e20  {}.    for d in 
-00007cd0: 6473 3a0a 2020 2020 2020 2020 7265 732e  ds:.        res.
-00007ce0: 7570 6461 7465 2864 290a 2020 2020 7265  update(d).    re
-00007cf0: 7475 726e 2072 6573 0a0a 0a64 6566 206f  turn res...def o
-00007d00: 626a 5f64 6966 665f 7374 7228 7365 6c66  bj_diff_str(self
-00007d10: 2c20 6f74 6865 722c 202a 2a6b 7761 7267  , other, **kwarg
-00007d20: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
-00007d30: 3a70 6172 616d 206f 626a 6563 7420 7365  :param object se
-00007d40: 6c66 3a0a 2020 2020 3a70 6172 616d 206f  lf:.    :param o
-00007d50: 626a 6563 7420 6f74 6865 723a 0a20 2020  bject other:.   
-00007d60: 203a 7265 7475 726e 3a20 7468 6520 6469   :return: the di
-00007d70: 6666 6572 656e 6365 2064 6573 6372 6962  fference describ
-00007d80: 6564 0a20 2020 203a 7274 7970 653a 2073  ed.    :rtype: s
-00007d90: 7472 0a20 2020 2022 2222 0a20 2020 2064  tr.    """.    d
-00007da0: 6966 665f 6c69 7374 203d 206f 626a 5f64  iff_list = obj_d
-00007db0: 6966 665f 6c69 7374 2873 656c 662c 206f  iff_list(self, o
-00007dc0: 7468 6572 2c20 2a2a 6b77 6172 6773 290a  ther, **kwargs).
-00007dd0: 2020 2020 6966 206e 6f74 2064 6966 665f      if not diff_
-00007de0: 6c69 7374 3a0a 2020 2020 2020 2020 7265  list:.        re
-00007df0: 7475 726e 2022 4e6f 2064 6966 662e 220a  turn "No diff.".
-00007e00: 2020 2020 7265 7475 726e 2022 5c6e 222e      return "\n".
-00007e10: 6a6f 696e 2864 6966 665f 6c69 7374 290a  join(diff_list).
-00007e20: 0a0a 6465 6620 6f62 6a5f 6469 6666 5f6c  ..def obj_diff_l
-00007e30: 6973 7428 7365 6c66 2c20 6f74 6865 722c  ist(self, other,
-00007e40: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00007e50: 2222 220a 2020 2020 4e6f 7465 2074 6861  """.    Note tha
-00007e60: 7420 7765 2072 6563 7572 7365 2074 6f20  t we recurse to 
-00007e70: 6120 6365 7274 6169 6e20 6465 6772 6565  a certain degree
-00007e80: 2074 6f20 7468 6520 6974 656d 732c 2062   to the items, b
-00007e90: 7574 206e 6f74 2066 756c 6c79 2e0a 2020  ut not fully..  
-00007ea0: 2020 536f 6d65 2064 6966 6665 7265 6e63    Some differenc
-00007eb0: 6573 206d 6967 6874 206a 7573 7420 6265  es might just be
-00007ec0: 2073 756d 6d61 7269 7a65 642e 0a0a 2020   summarized...  
-00007ed0: 2020 3a70 6172 616d 206f 626a 6563 7420    :param object 
-00007ee0: 7365 6c66 3a0a 2020 2020 3a70 6172 616d  self:.    :param
-00007ef0: 206f 626a 6563 7420 6f74 6865 723a 0a20   object other:. 
-00007f00: 2020 203a 7265 7475 726e 3a20 7468 6520     :return: the 
-00007f10: 6469 6666 6572 656e 6365 2064 6573 6372  difference descr
-00007f20: 6962 6564 0a20 2020 203a 7274 7970 653a  ibed.    :rtype:
-00007f30: 206c 6973 745b 7374 725d 0a20 2020 2022   list[str].    "
-00007f40: 2222 0a20 2020 2023 2048 6176 696e 6720  "".    # Having 
-00007f50: 7468 656d 2065 7870 6c69 6369 746c 7920  them explicitly 
-00007f60: 696e 206b 7761 7267 7320 6265 6361 7573  in kwargs becaus
-00007f70: 6520 7765 2063 616e 6e6f 7420 7573 6520  e we cannot use 
-00007f80: 602a 6020 696e 2050 7974 686f 6e20 322c  `*` in Python 2,
-00007f90: 0a20 2020 2023 2062 7574 2077 6520 646f  .    # but we do
-00007fa0: 206e 6f74 2077 616e 7420 746f 2061 6c6c   not want to all
-00007fb0: 6f77 2074 6865 6d20 6173 2070 6f73 6974  ow them as posit
-00007fc0: 696f 6e61 6c20 6172 6773 2e0a 2020 2020  ional args..    
-00007fd0: 7072 6566 6978 203d 206b 7761 7267 732e  prefix = kwargs.
-00007fe0: 706f 7028 225f 7072 6566 6978 222c 2022  pop("_prefix", "
-00007ff0: 2229 0a20 2020 2023 2049 6620 616c 6c6f  ").    # If allo
-00008000: 7765 645f 6d61 7070 696e 6728 7365 6c66  wed_mapping(self
-00008010: 2c20 6f74 6865 7229 2c0a 2020 2020 2320  , other),.    # 
-00008020: 7468 6579 2061 7265 2061 7373 6967 6e65  they are assigne
-00008030: 6420 746f 2074 6865 2065 7175 616c 5f6d  d to the equal_m
-00008040: 6170 7069 6e67 2c20 6966 2070 6f73 7369  apping, if possi
-00008050: 626c 6520 746f 2064 6f20 736f 2075 6e61  ble to do so una
-00008060: 6d62 6967 756f 7573 6c79 2e0a 2020 2020  mbiguously..    
-00008070: 616c 6c6f 7765 645f 6d61 7070 696e 6720  allowed_mapping 
-00008080: 3d20 6b77 6172 6773 2e70 6f70 2822 616c  = kwargs.pop("al
-00008090: 6c6f 7765 645f 6d61 7070 696e 6722 2c20  lowed_mapping", 
-000080a0: 4e6f 6e65 290a 2020 2020 6571 7561 6c5f  None).    equal_
-000080b0: 6d61 705f 7332 6f20 3d20 6b77 6172 6773  map_s2o = kwargs
-000080c0: 2e70 6f70 2822 5f65 7175 616c 5f6d 6170  .pop("_equal_map
-000080d0: 5f73 326f 222c 204e 6f6e 6529 2020 2320  _s2o", None)  # 
-000080e0: 7365 6c66 202d 3e20 6f74 6865 720a 2020  self -> other.  
-000080f0: 2020 6571 7561 6c5f 6d61 705f 6f32 7320    equal_map_o2s 
-00008100: 3d20 6b77 6172 6773 2e70 6f70 2822 5f65  = kwargs.pop("_e
-00008110: 7175 616c 5f6d 6170 5f6f 3273 222c 204e  qual_map_o2s", N
-00008120: 6f6e 6529 2020 2320 6f74 6865 7220 2d3e  one)  # other ->
-00008130: 2073 656c 660a 2020 2020 6571 7561 6c5f   self.    equal_
-00008140: 6d61 705f 6669 6e69 7368 6564 203d 206b  map_finished = k
-00008150: 7761 7267 732e 706f 7028 225f 6571 7561  wargs.pop("_equa
-00008160: 6c5f 6d61 705f 6669 6e69 7368 6564 222c  l_map_finished",
-00008170: 2046 616c 7365 290a 2020 2020 6966 206b   False).    if k
-00008180: 7761 7267 733a 0a20 2020 2020 2020 2072  wargs:.        r
-00008190: 6169 7365 2054 7970 6545 7272 6f72 2822  aise TypeError("
-000081a0: 6f62 6a5f 6469 6666 5f6c 6973 743a 2069  obj_diff_list: i
-000081b0: 6e76 616c 6964 206b 7761 7267 7320 2572  nvalid kwargs %r
-000081c0: 2220 2520 6b77 6172 6773 290a 0a20 2020  " % kwargs)..   
-000081d0: 2069 6620 7365 6c66 2069 7320 4e6f 6e65   if self is None
-000081e0: 2061 6e64 206f 7468 6572 2069 7320 4e6f   and other is No
-000081f0: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
-00008200: 726e 205b 5d0a 2020 2020 6966 2073 656c  rn [].    if sel
-00008210: 6620 6973 204e 6f6e 6520 616e 6420 6f74  f is None and ot
-00008220: 6865 7220 6973 206e 6f74 204e 6f6e 653a  her is not None:
-00008230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00008240: 5b22 2573 7365 6c66 2069 7320 4e6f 6e65  ["%sself is None
-00008250: 2061 6e64 206f 7468 6572 2069 7320 2572   and other is %r
-00008260: 2220 2520 2870 7265 6669 782c 206f 7468  " % (prefix, oth
-00008270: 6572 295d 0a20 2020 2069 6620 7365 6c66  er)].    if self
-00008280: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-00008290: 206f 7468 6572 2069 7320 4e6f 6e65 3a0a   other is None:.
-000082a0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-000082b0: 2225 736f 7468 6572 2069 7320 4e6f 6e65  "%sother is None
-000082c0: 2061 6e64 2073 656c 6620 6973 2025 7222   and self is %r"
-000082d0: 2025 2028 7072 6566 6978 2c20 7365 6c66   % (prefix, self
-000082e0: 295d 0a20 2020 2069 6620 7479 7065 2873  )].    if type(s
-000082f0: 656c 6629 2021 3d20 7479 7065 286f 7468  elf) != type(oth
-00008300: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
-00008310: 7572 6e20 5b22 2573 7479 7065 2064 6966  urn ["%stype dif
-00008320: 663a 2073 656c 6620 6973 2025 7320 6275  f: self is %s bu
-00008330: 7420 6f74 6865 7220 6973 2025 7322 2025  t other is %s" %
-00008340: 2028 7072 6566 6978 2c20 7479 7065 2873   (prefix, type(s
-00008350: 656c 6629 2e5f 5f6e 616d 655f 5f2c 2074  elf).__name__, t
-00008360: 7970 6528 6f74 6865 7229 2e5f 5f6e 616d  ype(other).__nam
-00008370: 655f 5f29 5d0a 0a20 2020 2069 6620 616c  e__)]..    if al
-00008380: 6c6f 7765 645f 6d61 7070 696e 673a 0a20  lowed_mapping:. 
-00008390: 2020 2020 2020 2069 6620 6571 7561 6c5f         if equal_
-000083a0: 6d61 705f 7332 6f20 6973 204e 6f6e 653a  map_s2o is None:
-000083b0: 0a20 2020 2020 2020 2020 2020 2023 2042  .            # B
-000083c0: 7569 6c64 2075 7020 7468 6520 756e 6571  uild up the uneq
-000083d0: 7561 6c5f 6d61 702c 2062 7920 676f 696e  ual_map, by goin
-000083e0: 6720 7468 726f 7567 6820 7468 6520 6f62  g through the ob
-000083f0: 6a65 6374 732e 0a20 2020 2020 2020 2020  jects..         
-00008400: 2020 2065 7175 616c 5f6d 6170 5f73 326f     equal_map_s2o
-00008410: 2c20 6571 7561 6c5f 6d61 705f 6f32 7320  , equal_map_o2s 
-00008420: 3d20 7b7d 2c20 7b7d 0a20 2020 2020 2020  = {}, {}.       
-00008430: 2020 2020 206f 626a 5f64 6966 665f 6c69       obj_diff_li
-00008440: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00008450: 2020 2020 7365 6c66 2c20 6f74 6865 722c      self, other,
-00008460: 2061 6c6c 6f77 6564 5f6d 6170 7069 6e67   allowed_mapping
-00008470: 3d61 6c6c 6f77 6564 5f6d 6170 7069 6e67  =allowed_mapping
-00008480: 2c20 5f65 7175 616c 5f6d 6170 5f73 326f  , _equal_map_s2o
-00008490: 3d65 7175 616c 5f6d 6170 5f73 326f 2c20  =equal_map_s2o, 
-000084a0: 5f65 7175 616c 5f6d 6170 5f6f 3273 3d65  _equal_map_o2s=e
-000084b0: 7175 616c 5f6d 6170 5f6f 3273 0a20 2020  qual_map_o2s.   
-000084c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000084d0: 2020 2020 2020 2065 7175 616c 5f6d 6170         equal_map
-000084e0: 5f66 696e 6973 6865 6420 3d20 5472 7565  _finished = True
-000084f0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00008500: 2020 2065 7175 616c 5f6d 6170 5f66 696e     equal_map_fin
-00008510: 6973 6865 6420 3d20 5472 7565 0a20 2020  ished = True.   
-00008520: 2069 6620 6571 7561 6c5f 6d61 705f 7332   if equal_map_s2
-00008530: 6f20 6973 204e 6f6e 6520 6f72 2065 7175  o is None or equ
-00008540: 616c 5f6d 6170 5f6f 3273 2069 7320 4e6f  al_map_o2s is No
-00008550: 6e65 3a0a 2020 2020 2020 2020 6571 7561  ne:.        equa
-00008560: 6c5f 6d61 705f 7332 6f2c 2065 7175 616c  l_map_s2o, equal
-00008570: 5f6d 6170 5f6f 3273 203d 207b 7d2c 207b  _map_o2s = {}, {
-00008580: 7d20 2023 2073 696d 706c 6966 6965 7320  }  # simplifies 
-00008590: 7468 6520 636f 6465 2062 656c 6f77 0a0a  the code below..
-000085a0: 2020 2020 7375 625f 6b77 6172 6773 203d      sub_kwargs =
-000085b0: 2064 6963 7428 0a20 2020 2020 2020 2061   dict(.        a
-000085c0: 6c6c 6f77 6564 5f6d 6170 7069 6e67 3d61  llowed_mapping=a
-000085d0: 6c6c 6f77 6564 5f6d 6170 7069 6e67 2c0a  llowed_mapping,.
-000085e0: 2020 2020 2020 2020 5f65 7175 616c 5f6d          _equal_m
-000085f0: 6170 5f73 326f 3d65 7175 616c 5f6d 6170  ap_s2o=equal_map
-00008600: 5f73 326f 2c0a 2020 2020 2020 2020 5f65  _s2o,.        _e
-00008610: 7175 616c 5f6d 6170 5f6f 3273 3d65 7175  qual_map_o2s=equ
-00008620: 616c 5f6d 6170 5f6f 3273 2c0a 2020 2020  al_map_o2s,.    
-00008630: 2020 2020 5f65 7175 616c 5f6d 6170 5f66      _equal_map_f
-00008640: 696e 6973 6865 643d 6571 7561 6c5f 6d61  inished=equal_ma
-00008650: 705f 6669 6e69 7368 6564 2c0a 2020 2020  p_finished,.    
-00008660: 290a 0a20 2020 2069 6620 6973 696e 7374  )..    if isinst
-00008670: 616e 6365 2873 656c 662c 2028 6c69 7374  ance(self, (list
-00008680: 2c20 7475 706c 6529 293a 0a20 2020 2020  , tuple)):.     
-00008690: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-000086a0: 616e 6365 286f 7468 6572 2c20 286c 6973  ance(other, (lis
-000086b0: 742c 2074 7570 6c65 2929 0a20 2020 2020  t, tuple)).     
-000086c0: 2020 2069 6620 6c65 6e28 7365 6c66 2920     if len(self) 
-000086d0: 213d 206c 656e 286f 7468 6572 293a 0a20  != len(other):. 
-000086e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000086f0: 6e20 5b22 2573 6c69 7374 2064 6966 6620  n ["%slist diff 
-00008700: 6c65 6e3a 206c 656e 2073 656c 663a 2025  len: len self: %
-00008710: 692c 206c 656e 206f 7468 6572 3a20 2569  i, len other: %i
-00008720: 2220 2520 2870 7265 6669 782c 206c 656e  " % (prefix, len
-00008730: 2873 656c 6629 2c20 6c65 6e28 6f74 6865  (self), len(othe
-00008740: 7229 295d 0a20 2020 2020 2020 2073 203d  r))].        s =
-00008750: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-00008760: 692c 2028 612c 2062 2920 696e 2065 6e75  i, (a, b) in enu
-00008770: 6d65 7261 7465 287a 6970 2873 656c 662c  merate(zip(self,
-00008780: 206f 7468 6572 2929 3a0a 2020 2020 2020   other)):.      
-00008790: 2020 2020 2020 7320 2b3d 206f 626a 5f64        s += obj_d
-000087a0: 6966 665f 6c69 7374 2861 2c20 622c 205f  iff_list(a, b, _
-000087b0: 7072 6566 6978 3d22 2573 5b25 695d 2022  prefix="%s[%i] "
-000087c0: 2025 2028 7072 6566 6978 2c20 6929 2c20   % (prefix, i), 
-000087d0: 2a2a 7375 625f 6b77 6172 6773 290a 2020  **sub_kwargs).  
-000087e0: 2020 2020 2020 6966 2073 3a0a 2020 2020        if s:.    
-000087f0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-00008800: 2225 736c 6973 7420 6469 6666 3a22 2025  "%slist diff:" %
-00008810: 2070 7265 6669 785d 202b 2073 0a20 2020   prefix] + s.   
-00008820: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
-00008830: 2020 2020 6465 6620 5f73 6574 5f64 6966      def _set_dif
-00008840: 6628 615f 2c20 625f 293a 0a20 2020 2020  f(a_, b_):.     
-00008850: 2020 2023 2061 7373 756d 6520 7468 6520     # assume the 
-00008860: 7661 6c75 6573 2063 616e 2062 6520 736f  values can be so
-00008870: 7274 6564 0a20 2020 2020 2020 2061 5f20  rted.        a_ 
-00008880: 3d20 736f 7274 6564 2861 5f29 0a20 2020  = sorted(a_).   
-00008890: 2020 2020 2062 5f20 3d20 736f 7274 6564       b_ = sorted
-000088a0: 2862 5f29 0a20 2020 2020 2020 2073 656c  (b_).        sel
-000088b0: 665f 6469 6666 5f20 3d20 5b5d 0a20 2020  f_diff_ = [].   
-000088c0: 2020 2020 2073 616d 655f 203d 205b 5d0a       same_ = [].
-000088d0: 2020 2020 2020 2020 666f 7220 7620 696e          for v in
-000088e0: 2061 5f3a 0a20 2020 2020 2020 2020 2020   a_:.           
-000088f0: 2076 5f20 3d20 6571 7561 6c5f 6d61 705f   v_ = equal_map_
-00008900: 7332 6f2e 6765 7428 762c 2076 290a 2020  s2o.get(v, v).  
-00008910: 2020 2020 2020 2020 2020 6966 2076 5f20            if v_ 
-00008920: 696e 2062 5f3a 0a20 2020 2020 2020 2020  in b_:.         
-00008930: 2020 2020 2020 2073 616d 655f 2e61 7070         same_.app
-00008940: 656e 6428 7629 0a20 2020 2020 2020 2020  end(v).         
-00008950: 2020 2020 2020 2062 5f2e 7265 6d6f 7665         b_.remove
-00008960: 2876 5f29 0a20 2020 2020 2020 2020 2020  (v_).           
-00008970: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00008980: 2020 2020 2020 2073 656c 665f 6469 6666         self_diff
-00008990: 5f2e 6170 7065 6e64 2876 290a 2020 2020  _.append(v).    
-000089a0: 2020 2020 6f74 6865 725f 6469 6666 5f20      other_diff_ 
-000089b0: 3d20 625f 0a20 2020 2020 2020 2072 6574  = b_.        ret
-000089c0: 7572 6e20 7365 6c66 5f64 6966 665f 2c20  urn self_diff_, 
-000089d0: 7361 6d65 5f2c 206f 7468 6572 5f64 6966  same_, other_dif
-000089e0: 665f 0a0a 2020 2020 6966 2069 7369 6e73  f_..    if isins
-000089f0: 7461 6e63 6528 7365 6c66 2c20 7365 7429  tance(self, set)
-00008a00: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00008a10: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
-00008a20: 722c 2073 6574 290a 2020 2020 2020 2020  r, set).        
-00008a30: 7365 6c66 5f64 6966 662c 205f 2c20 6f74  self_diff, _, ot
-00008a40: 6865 725f 6469 6666 203d 205f 7365 745f  her_diff = _set_
-00008a50: 6469 6666 2873 656c 662c 206f 7468 6572  diff(self, other
-00008a60: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-00008a70: 2873 656c 665f 6469 6666 2920 3d3d 206c  (self_diff) == l
-00008a80: 656e 286f 7468 6572 5f64 6966 6629 203d  en(other_diff) =
-00008a90: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-00008aa0: 2023 2070 6f74 656e 7469 616c 6c79 2075   # potentially u
-00008ab0: 7064 6174 6520 6571 7561 6c5f 6d61 700a  pdate equal_map.
-00008ac0: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
-00008ad0: 6f62 6a5f 6469 6666 5f6c 6973 7428 6c69  obj_diff_list(li
-00008ae0: 7374 2873 656c 665f 6469 6666 295b 305d  st(self_diff)[0]
-00008af0: 2c20 6c69 7374 286f 7468 6572 5f64 6966  , list(other_dif
-00008b00: 6629 5b30 5d2c 202a 2a73 7562 5f6b 7761  f)[0], **sub_kwa
-00008b10: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-00008b20: 2023 2069 676e 6f72 6520 7468 6520 706f   # ignore the po
-00008b30: 7465 6e74 6961 6c20 7570 6461 7465 6420  tential updated 
-00008b40: 6571 7561 6c5f 6d61 7020 6e6f 7720 666f  equal_map now fo
-00008b50: 7220 7369 6d70 6c69 6369 7479 2e20 7765  r simplicity. we
-00008b60: 2077 696c 6c20 616e 7977 6179 2064 6f20   will anyway do 
-00008b70: 6120 7365 636f 6e64 2070 6173 7320 6c61  a second pass la
-00008b80: 7465 722e 0a20 2020 2020 2020 2020 2020  ter..           
-00008b90: 2069 6620 6c65 6e28 7329 203d 3d20 313a   if len(s) == 1:
-00008ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008bb0: 2072 6574 7572 6e20 5b22 2573 7365 7420   return ["%sset 
-00008bc0: 6469 6666 2076 616c 7565 3a20 2573 2220  diff value: %s" 
-00008bd0: 2520 2870 7265 6669 782c 2073 5b30 5d29  % (prefix, s[0])
-00008be0: 5d0a 2020 2020 2020 2020 7320 3d20 5b5d  ].        s = []
-00008bf0: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
-00008c00: 2069 6e20 7365 6c66 5f64 6966 663a 0a20   in self_diff:. 
-00008c10: 2020 2020 2020 2020 2020 2073 202b 3d20             s += 
-00008c20: 5b22 2573 2020 2572 206e 6f74 2069 6e20  ["%s  %r not in 
-00008c30: 6f74 6865 7222 2025 2028 7072 6566 6978  other" % (prefix
-00008c40: 2c20 6b65 7929 5d0a 2020 2020 2020 2020  , key)].        
-00008c50: 666f 7220 6b65 7920 696e 206f 7468 6572  for key in other
-00008c60: 5f64 6966 663a 0a20 2020 2020 2020 2020  _diff:.         
-00008c70: 2020 2073 202b 3d20 5b22 2573 2020 2572     s += ["%s  %r
-00008c80: 206e 6f74 2069 6e20 7365 6c66 2220 2520   not in self" % 
-00008c90: 2870 7265 6669 782c 206b 6579 295d 0a20  (prefix, key)]. 
-00008ca0: 2020 2020 2020 2069 6620 733a 0a20 2020         if s:.   
-00008cb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00008cc0: 5b22 2573 7365 7420 6469 6666 3a22 2025  ["%sset diff:" %
-00008cd0: 2070 7265 6669 785d 202b 2073 0a20 2020   prefix] + s.   
-00008ce0: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
-00008cf0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00008d00: 6528 7365 6c66 2c20 6469 6374 293a 0a20  e(self, dict):. 
-00008d10: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00008d20: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
-00008d30: 6469 6374 290a 2020 2020 2020 2020 7365  dict).        se
-00008d40: 6c66 5f64 6966 662c 2073 616d 652c 206f  lf_diff, same, o
-00008d50: 7468 6572 5f64 6966 6620 3d20 5f73 6574  ther_diff = _set
-00008d60: 5f64 6966 6628 7365 6c66 2e6b 6579 7328  _diff(self.keys(
-00008d70: 292c 206f 7468 6572 2e6b 6579 7328 2929  ), other.keys())
-00008d80: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00008d90: 6571 7561 6c5f 6d61 705f 6669 6e69 7368  equal_map_finish
-00008da0: 6564 2061 6e64 206c 656e 2873 656c 665f  ed and len(self_
-00008db0: 6469 6666 2920 3d3d 206c 656e 286f 7468  diff) == len(oth
-00008dc0: 6572 5f64 6966 6629 203d 3d20 313a 0a20  er_diff) == 1:. 
-00008dd0: 2020 2020 2020 2020 2020 2023 2070 6f74             # pot
-00008de0: 656e 7469 616c 6c79 2075 7064 6174 6520  entially update 
-00008df0: 6571 7561 6c5f 6d61 700a 2020 2020 2020  equal_map.      
-00008e00: 2020 2020 2020 6f62 6a5f 6469 6666 5f6c        obj_diff_l
-00008e10: 6973 7428 6c69 7374 2873 656c 665f 6469  ist(list(self_di
-00008e20: 6666 295b 305d 2c20 6c69 7374 286f 7468  ff)[0], list(oth
-00008e30: 6572 5f64 6966 6629 5b30 5d2c 202a 2a73  er_diff)[0], **s
-00008e40: 7562 5f6b 7761 7267 7329 0a20 2020 2020  ub_kwargs).     
-00008e50: 2020 2020 2020 2023 2069 676e 6f72 6520         # ignore 
-00008e60: 7468 6520 706f 7465 6e74 6961 6c20 7570  the potential up
-00008e70: 6461 7465 6420 6571 7561 6c5f 6d61 7020  dated equal_map 
-00008e80: 6e6f 7720 666f 7220 7369 6d70 6c69 6369  now for simplici
-00008e90: 7479 2e20 7765 2077 696c 6c20 616e 7977  ty. we will anyw
-00008ea0: 6179 2064 6f20 6120 7365 636f 6e64 2070  ay do a second p
-00008eb0: 6173 7320 6c61 7465 722e 0a20 2020 2020  ass later..     
-00008ec0: 2020 2073 203d 205b 5d0a 2020 2020 2020     s = [].      
-00008ed0: 2020 666f 7220 6b65 7920 696e 2073 656c    for key in sel
-00008ee0: 665f 6469 6666 3a0a 2020 2020 2020 2020  f_diff:.        
-00008ef0: 2020 2020 7320 2b3d 205b 2225 7320 206b      s += ["%s  k
-00008f00: 6579 2025 7220 6e6f 7420 696e 206f 7468  ey %r not in oth
-00008f10: 6572 2220 2520 2870 7265 6669 782c 206b  er" % (prefix, k
-00008f20: 6579 295d 0a20 2020 2020 2020 2066 6f72  ey)].        for
-00008f30: 206b 6579 2069 6e20 6f74 6865 725f 6469   key in other_di
-00008f40: 6666 3a0a 2020 2020 2020 2020 2020 2020  ff:.            
-00008f50: 7320 2b3d 205b 2225 7320 206b 6579 2025  s += ["%s  key %
-00008f60: 7220 6e6f 7420 696e 2073 656c 6622 2025  r not in self" %
-00008f70: 2028 7072 6566 6978 2c20 6b65 7929 5d0a   (prefix, key)].
-00008f80: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00008f90: 696e 2073 616d 653a 0a20 2020 2020 2020  in same:.       
-00008fa0: 2020 2020 206b 6579 5f20 3d20 6571 7561       key_ = equa
-00008fb0: 6c5f 6d61 705f 7332 6f2e 6765 7428 6b65  l_map_s2o.get(ke
-00008fc0: 792c 206b 6579 290a 2020 2020 2020 2020  y, key).        
-00008fd0: 2020 2020 7661 6c75 655f 7365 6c66 203d      value_self =
-00008fe0: 2073 656c 665b 6b65 795d 0a20 2020 2020   self[key].     
-00008ff0: 2020 2020 2020 2076 616c 7565 5f6f 7468         value_oth
-00009000: 6572 203d 206f 7468 6572 5b6b 6579 5f5d  er = other[key_]
-00009010: 0a20 2020 2020 2020 2020 2020 2073 202b  .            s +
-00009020: 3d20 6f62 6a5f 6469 6666 5f6c 6973 7428  = obj_diff_list(
-00009030: 7661 6c75 655f 7365 6c66 2c20 7661 6c75  value_self, valu
-00009040: 655f 6f74 6865 722c 205f 7072 6566 6978  e_other, _prefix
-00009050: 3d22 2573 5b25 725d 2022 2025 2028 7072  ="%s[%r] " % (pr
-00009060: 6566 6978 2c20 6b65 7929 2c20 2a2a 7375  efix, key), **su
-00009070: 625f 6b77 6172 6773 290a 2020 2020 2020  b_kwargs).      
-00009080: 2020 6966 2073 3a0a 2020 2020 2020 2020    if s:.        
-00009090: 2020 2020 7265 7475 726e 205b 2225 7364      return ["%sd
-000090a0: 6963 7420 6469 6666 3a22 2025 2070 7265  ict diff:" % pre
-000090b0: 6669 785d 202b 2073 0a20 2020 2020 2020  fix] + s.       
-000090c0: 2072 6574 7572 6e20 5b5d 0a0a 2020 2020   return []..    
-000090d0: 6966 2069 7369 6e73 7461 6e63 6528 7365  if isinstance(se
-000090e0: 6c66 2c20 6e70 2e6e 6461 7272 6179 293a  lf, np.ndarray):
-000090f0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00009100: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
-00009110: 2c20 6e70 2e6e 6461 7272 6179 290a 2020  , np.ndarray).  
-00009120: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
-00009130: 6172 7261 795f 6571 7561 6c28 7365 6c66  array_equal(self
-00009140: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
-00009150: 2020 2020 2020 7265 7475 726e 205b 2225        return ["%
-00009160: 7373 656c 663a 2025 7220 213d 206f 7468  sself: %r != oth
-00009170: 6572 3a20 2572 2220 2520 2870 7265 6669  er: %r" % (prefi
-00009180: 782c 2073 656c 662c 206f 7468 6572 295d  x, self, other)]
-00009190: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000091a0: 5b5d 0a0a 2020 2020 6966 2061 6c6c 6f77  []..    if allow
-000091b0: 6564 5f6d 6170 7069 6e67 2061 6e64 2073  ed_mapping and s
-000091c0: 656c 6620 213d 206f 7468 6572 2061 6e64  elf != other and
-000091d0: 2061 6c6c 6f77 6564 5f6d 6170 7069 6e67   allowed_mapping
-000091e0: 2873 656c 662c 206f 7468 6572 293a 0a20  (self, other):. 
-000091f0: 2020 2020 2020 2069 6620 7365 6c66 2069         if self i
-00009200: 6e20 6571 7561 6c5f 6d61 705f 7332 6f3a  n equal_map_s2o:
-00009210: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00009220: 6620 3d20 6571 7561 6c5f 6d61 705f 7332  f = equal_map_s2
-00009230: 6f5b 7365 6c66 5d0a 2020 2020 2020 2020  o[self].        
-00009240: 656c 6966 206f 7468 6572 206e 6f74 2069  elif other not i
-00009250: 6e20 6571 7561 6c5f 6d61 705f 6f32 733a  n equal_map_o2s:
-00009260: 2020 2320 646f 6e27 7420 6d61 7020 6d75    # don't map mu
-00009270: 6c74 6970 6c65 2074 696d 6573 2074 6f20  ltiple times to 
-00009280: 7468 6973 0a20 2020 2020 2020 2020 2020  this.           
-00009290: 2065 7175 616c 5f6d 6170 5f73 326f 5b73   equal_map_s2o[s
-000092a0: 656c 665d 203d 206f 7468 6572 0a20 2020  elf] = other.   
-000092b0: 2020 2020 2020 2020 2065 7175 616c 5f6d           equal_m
-000092c0: 6170 5f6f 3273 5b6f 7468 6572 5d20 3d20  ap_o2s[other] = 
-000092d0: 7365 6c66 0a0a 2020 2020 6966 2073 656c  self..    if sel
-000092e0: 6620 213d 206f 7468 6572 3a0a 2020 2020  f != other:.    
-000092f0: 2020 2020 7265 7475 726e 205b 2225 7373      return ["%ss
-00009300: 656c 663a 2025 7220 213d 206f 7468 6572  elf: %r != other
-00009310: 3a20 2572 2220 2520 2870 7265 6669 782c  : %r" % (prefix,
-00009320: 2073 656c 662c 206f 7468 6572 295d 0a20   self, other)]. 
-00009330: 2020 2072 6574 7572 6e20 5b5d 0a0a 0a64     return []...d
-00009340: 6566 2066 696e 645f 7261 6e67 6573 286c  ef find_ranges(l
-00009350: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
-00009360: 3a74 7970 6520 6c73 3a20 6c69 7374 5b69  :type ls: list[i
-00009370: 6e74 5d0a 2020 2020 3a72 6574 7572 6e73  nt].    :returns
-00009380: 206c 6973 7420 6f66 2072 616e 6765 7320   list of ranges 
-00009390: 2873 7461 7274 2c65 6e64 2920 7768 6572  (start,end) wher
-000093a0: 6520 656e 6420 6973 2065 7863 6c75 7369  e end is exclusi
-000093b0: 7665 0a20 2020 2073 7563 6820 7468 6174  ve.    such that
-000093c0: 2074 6865 2075 6e69 6f6e 206f 6620 7261   the union of ra
-000093d0: 6e67 6528 7374 6172 742c 656e 6429 206d  nge(start,end) m
-000093e0: 6174 6368 6573 206c 2e0a 2020 2020 3a72  atches l..    :r
-000093f0: 7479 7065 3a20 6c69 7374 5b28 696e 742c  type: list[(int,
-00009400: 696e 7429 5d0a 2020 2020 5765 2065 7870  int)].    We exp
-00009410: 6563 7420 7468 6174 2074 6865 2069 6e63  ect that the inc
-00009420: 6f6d 696e 6720 6c69 7374 2069 7320 736f  oming list is so
-00009430: 7274 6564 2061 6e64 2073 7472 6f6e 676c  rted and strongl
-00009440: 7920 6d6f 6e6f 746f 6e69 6320 696e 6372  y monotonic incr
-00009450: 6561 7369 6e67 2e0a 2020 2020 2222 220a  easing..    """.
-00009460: 2020 2020 6966 206e 6f74 206c 733a 0a20      if not ls:. 
-00009470: 2020 2020 2020 2072 6574 7572 6e20 5b5d         return []
-00009480: 0a20 2020 2072 616e 6765 7320 3d20 5b28  .    ranges = [(
-00009490: 6c73 5b30 5d2c 206c 735b 305d 295d 0a20  ls[0], ls[0])]. 
-000094a0: 2020 2066 6f72 206b 2069 6e20 6c73 3a0a     for k in ls:.
-000094b0: 2020 2020 2020 2020 6173 7365 7274 206b          assert k
-000094c0: 203e 3d20 7261 6e67 6573 5b2d 315d 5b31   >= ranges[-1][1
-000094d0: 5d20 2023 2073 7472 6f6e 676c 7920 6d6f  ]  # strongly mo
-000094e0: 6e6f 746f 6e69 6320 696e 6372 6561 7369  notonic increasi
-000094f0: 6e67 0a20 2020 2020 2020 2069 6620 6b20  ng.        if k 
-00009500: 3d3d 2072 616e 6765 735b 2d31 5d5b 315d  == ranges[-1][1]
-00009510: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00009520: 6e67 6573 5b2d 315d 203d 2028 7261 6e67  nges[-1] = (rang
-00009530: 6573 5b2d 315d 5b30 5d2c 206b 202b 2031  es[-1][0], k + 1
-00009540: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00009550: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
-00009560: 6573 202b 3d20 5b28 6b2c 206b 202b 2031  es += [(k, k + 1
-00009570: 295d 0a20 2020 2072 6574 7572 6e20 7261  )].    return ra
-00009580: 6e67 6573 0a0a 0a5f 7468 7265 6164 5f6a  nges..._thread_j
-00009590: 6f69 6e5f 6861 636b 5f69 6e73 7461 6c6c  oin_hack_install
-000095a0: 6564 203d 2046 616c 7365 0a0a 0a64 6566  ed = False...def
-000095b0: 2069 6e69 745f 7468 7265 6164 5f6a 6f69   init_thread_joi
-000095c0: 6e5f 6861 636b 2829 3a0a 2020 2020 2222  n_hack():.    ""
-000095d0: 220a 2020 2020 6060 7468 7265 6164 696e  ".    ``threadin
-000095e0: 672e 5468 7265 6164 2e6a 6f69 6e60 6020  g.Thread.join`` 
-000095f0: 616e 6420 6060 7468 7265 6164 696e 672e  and ``threading.
-00009600: 436f 6e64 6974 696f 6e2e 7761 6974 6060  Condition.wait``
-00009610: 2077 6f75 6c64 2062 6c6f 636b 2073 6967   would block sig
-00009620: 6e61 6c73 2077 6865 6e20 7275 6e20 696e  nals when run in
-00009630: 2074 6865 206d 6169 6e20 7468 7265 6164   the main thread
-00009640: 2e0a 2020 2020 5765 206e 6576 6572 2077  ..    We never w
-00009650: 616e 7420 746f 2062 6c6f 636b 2073 6967  ant to block sig
-00009660: 6e61 6c73 2e0a 2020 2020 4865 7265 2077  nals..    Here w
-00009670: 6520 7061 7463 6820 6177 6179 2074 6861  e patch away tha
-00009680: 7420 6265 6861 7669 6f72 2e0a 2020 2020  t behavior..    
-00009690: 2222 220a 2020 2020 676c 6f62 616c 205f  """.    global _
-000096a0: 7468 7265 6164 5f6a 6f69 6e5f 6861 636b  thread_join_hack
-000096b0: 5f69 6e73 7461 6c6c 6564 0a20 2020 2069  _installed.    i
-000096c0: 6620 5f74 6872 6561 645f 6a6f 696e 5f68  f _thread_join_h
-000096d0: 6163 6b5f 696e 7374 616c 6c65 643a 2020  ack_installed:  
-000096e0: 2320 646f 6e27 7420 696e 7374 616c 6c20  # don't install 
-000096f0: 7477 6963 650a 2020 2020 2020 2020 7265  twice.        re
-00009700: 7475 726e 0a20 2020 205f 7468 7265 6164  turn.    _thread
-00009710: 5f6a 6f69 6e5f 6861 636b 5f69 6e73 7461  _join_hack_insta
-00009720: 6c6c 6564 203d 2054 7275 650a 2020 2020  lled = True.    
-00009730: 6966 2050 5933 3a0a 2020 2020 2020 2020  if PY3:.        
-00009740: 2320 5468 6573 6520 6d6f 6e6b 6579 2070  # These monkey p
-00009750: 6174 6368 6573 2061 7265 206e 6f74 206e  atches are not n
-00009760: 6563 6573 7361 7279 2061 6e79 6d6f 7265  ecessary anymore
-00009770: 2e20 4e6f 7468 696e 6720 626c 6f63 6b73  . Nothing blocks
-00009780: 2073 6967 6e61 6c73 2061 6e79 6d6f 7265   signals anymore
-00009790: 2069 6e20 5079 7468 6f6e 2033 2e0a 2020   in Python 3..  
-000097a0: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
-000097b0: 6769 7468 7562 2e63 6f6d 2f61 6c62 6572  github.com/alber
-000097c0: 747a 2f70 6c61 7967 726f 756e 642f 626c  tz/playground/bl
-000097d0: 6f62 2f6d 6173 7465 722f 7468 7265 6164  ob/master/thread
-000097e0: 2d6a 6f69 6e2d 626c 6f63 6b2e 7079 0a20  -join-block.py. 
-000097f0: 2020 2020 2020 2023 2068 7474 7073 3a2f         # https:/
-00009800: 2f67 6974 6875 622e 636f 6d2f 616c 6265  /github.com/albe
-00009810: 7274 7a2f 706c 6179 6772 6f75 6e64 2f62  rtz/playground/b
-00009820: 6c6f 622f 6d61 7374 6572 2f63 6f6e 642d  lob/master/cond-
-00009830: 7761 6974 2d62 6c6f 636b 2e70 790a 2020  wait-block.py.  
-00009840: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00009850: 206d 6169 6e5f 7468 7265 6164 203d 2074   main_thread = t
-00009860: 6872 6561 6469 6e67 2e63 7572 7265 6e74  hreading.current
-00009870: 5468 7265 6164 2829 0a20 2020 2023 206e  Thread().    # n
-00009880: 6f69 6e73 7065 6374 696f 6e20 5079 556e  oinspection PyUn
-00009890: 7265 736f 6c76 6564 5265 6665 7265 6e63  resolvedReferenc
-000098a0: 6573 2c50 7950 726f 7465 6374 6564 4d65  es,PyProtectedMe
-000098b0: 6d62 6572 0a20 2020 2061 7373 6572 7420  mber.    assert 
-000098c0: 6973 696e 7374 616e 6365 286d 6169 6e5f  isinstance(main_
-000098d0: 7468 7265 6164 2c20 7468 7265 6164 696e  thread, threadin
-000098e0: 672e 5f4d 6169 6e54 6872 6561 6429 0a20  g._MainThread). 
-000098f0: 2020 206d 6169 6e5f 7468 7265 6164 5f69     main_thread_i
-00009900: 6420 3d20 7468 7265 6164 2e67 6574 5f69  d = thread.get_i
-00009910: 6465 6e74 2829 0a0a 2020 2020 2320 5061  dent()..    # Pa
-00009920: 7463 6820 5468 7265 6164 2e6a 6f69 6e28  tch Thread.join(
-00009930: 292e 0a20 2020 206a 6f69 6e5f 6f72 6967  )..    join_orig
-00009940: 203d 2074 6872 6561 6469 6e67 2e54 6872   = threading.Thr
-00009950: 6561 642e 6a6f 696e 0a0a 2020 2020 6465  ead.join..    de
-00009960: 6620 6a6f 696e 5f68 6163 6b65 6428 7468  f join_hacked(th
-00009970: 7265 6164 5f6f 626a 2c20 7469 6d65 6f75  read_obj, timeou
-00009980: 743d 4e6f 6e65 293a 0a20 2020 2020 2020  t=None):.       
-00009990: 2022 2222 0a20 2020 2020 2020 203a 7479   """.        :ty
-000099a0: 7065 2074 6872 6561 645f 6f62 6a3a 2074  pe thread_obj: t
-000099b0: 6872 6561 6469 6e67 2e54 6872 6561 640a  hreading.Thread.
-000099c0: 2020 2020 2020 2020 3a74 7970 6520 7469          :type ti
-000099d0: 6d65 6f75 743a 2066 6c6f 6174 7c4e 6f6e  meout: float|Non
-000099e0: 650a 2020 2020 2020 2020 3a72 6574 7572  e.        :retur
-000099f0: 6e3a 2061 6c77 6179 7320 4e6f 6e65 0a20  n: always None. 
-00009a00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00009a10: 2020 2069 6620 7468 7265 6164 2e67 6574     if thread.get
-00009a20: 5f69 6465 6e74 2829 203d 3d20 6d61 696e  _ident() == main
-00009a30: 5f74 6872 6561 645f 6964 2061 6e64 2074  _thread_id and t
-00009a40: 696d 656f 7574 2069 7320 4e6f 6e65 3a0a  imeout is None:.
-00009a50: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00009a60: 6973 2069 7320 6120 4841 434b 2066 6f72  is is a HACK for
-00009a70: 2054 6872 6561 642e 6a6f 696e 2829 2069   Thread.join() i
-00009a80: 6620 7765 2061 7265 2069 6e20 7468 6520  f we are in the 
-00009a90: 6d61 696e 2074 6872 6561 642e 0a20 2020  main thread..   
-00009aa0: 2020 2020 2020 2020 2023 2049 6e20 7468           # In th
-00009ab0: 6174 2063 6173 652c 2061 2054 6872 6561  at case, a Threa
-00009ac0: 642e 6a6f 696e 2874 696d 656f 7574 3d4e  d.join(timeout=N
-00009ad0: 6f6e 6529 2077 6f75 6c64 2068 616e 6720  one) would hang 
-00009ae0: 616e 6420 6576 656e 206e 6f74 2072 6573  and even not res
-00009af0: 706f 6e64 2074 6f20 7369 676e 616c 730a  pond to signals.
-00009b00: 2020 2020 2020 2020 2020 2020 2320 6265              # be
-00009b10: 6361 7573 6520 7369 676e 616c 7320 7769  cause signals wi
-00009b20: 6c6c 2067 6574 2064 656c 6976 6572 6564  ll get delivered
-00009b30: 2074 6f20 6f74 6865 7220 7468 7265 6164   to other thread
-00009b40: 7320 616e 6420 5079 7468 6f6e 2077 6f75  s and Python wou
-00009b50: 6c64 2066 6f72 7761 7264 0a20 2020 2020  ld forward.     
-00009b60: 2020 2020 2020 2023 2074 6865 6d20 666f         # them fo
-00009b70: 7220 6465 6c61 7965 6420 6861 6e64 6c69  r delayed handli
-00009b80: 6e67 2074 6f20 7468 6520 6d61 696e 2074  ng to the main t
-00009b90: 6872 6561 6420 7768 6963 6820 6861 6e67  hread which hang
-00009ba0: 732e 0a20 2020 2020 2020 2020 2020 2023  s..            #
-00009bb0: 2053 6565 2043 5079 7468 6f6e 2073 6967   See CPython sig
-00009bc0: 6e61 6c6d 6f64 756c 652e 632e 0a20 2020  nalmodule.c..   
-00009bd0: 2020 2020 2020 2020 2023 2043 7572 7265           # Curre
-00009be0: 6e74 6c79 2074 6865 2062 6573 7420 736f  ntly the best so
-00009bf0: 6c75 7469 6f6e 2049 2063 616e 2074 6869  lution I can thi
-00009c00: 6e6b 206f 663a 0a20 2020 2020 2020 2020  nk of:.         
-00009c10: 2020 2077 6869 6c65 2074 6872 6561 645f     while thread_
-00009c20: 6f62 6a2e 6973 5f61 6c69 7665 2829 3a0a  obj.is_alive():.
-00009c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c40: 6a6f 696e 5f6f 7269 6728 7468 7265 6164  join_orig(thread
-00009c50: 5f6f 626a 2c20 7469 6d65 6f75 743d 302e  _obj, timeout=0.
-00009c60: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
-00009c70: 7468 7265 6164 2e67 6574 5f69 6465 6e74  thread.get_ident
-00009c80: 2829 203d 3d20 6d61 696e 5f74 6872 6561  () == main_threa
-00009c90: 645f 6964 2061 6e64 2074 696d 656f 7574  d_id and timeout
-00009ca0: 203e 2030 2e31 3a0a 2020 2020 2020 2020   > 0.1:.        
-00009cb0: 2020 2020 2320 4c69 6d69 7420 7468 6520      # Limit the 
-00009cc0: 7469 6d65 6f75 742e 2054 6869 7320 7368  timeout. This sh
-00009cd0: 6f75 6c64 206e 6f74 206d 6174 7465 7220  ould not matter 
-00009ce0: 666f 7220 7468 6520 756e 6465 726c 7969  for the underlyi
-00009cf0: 6e67 2063 6f64 652e 0a20 2020 2020 2020  ng code..       
-00009d00: 2020 2020 206a 6f69 6e5f 6f72 6967 2874       join_orig(t
-00009d10: 6872 6561 645f 6f62 6a2c 2074 696d 656f  hread_obj, timeo
-00009d20: 7574 3d30 2e31 290a 2020 2020 2020 2020  ut=0.1).        
-00009d30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00009d40: 2020 2320 496e 2061 6c6c 206f 7468 6572    # In all other
-00009d50: 2063 6173 6573 2c20 7765 2063 616e 2075   cases, we can u
-00009d60: 7365 2074 6865 206f 7269 6769 6e61 6c2e  se the original.
-00009d70: 0a20 2020 2020 2020 2020 2020 206a 6f69  .            joi
-00009d80: 6e5f 6f72 6967 2874 6872 6561 645f 6f62  n_orig(thread_ob
-00009d90: 6a2c 2074 696d 656f 7574 3d74 696d 656f  j, timeout=timeo
-00009da0: 7574 290a 0a20 2020 2074 6872 6561 6469  ut)..    threadi
-00009db0: 6e67 2e54 6872 6561 642e 6a6f 696e 203d  ng.Thread.join =
-00009dc0: 206a 6f69 6e5f 6861 636b 6564 0a0a 2020   join_hacked..  
-00009dd0: 2020 2320 4d6f 7374 6c79 2074 6865 2073    # Mostly the s
-00009de0: 616d 6520 666f 7220 436f 6e64 6974 696f  ame for Conditio
-00009df0: 6e2e 7761 6974 2829 2e0a 2020 2020 6966  n.wait()..    if
-00009e00: 2050 5933 3a0a 2020 2020 2020 2020 2320   PY3:.        # 
-00009e10: 6874 7470 733a 2f2f 796f 7574 7261 636b  https://youtrack
-00009e20: 2e6a 6574 6272 6169 6e73 2e63 6f6d 2f69  .jetbrains.com/i
-00009e30: 7373 7565 2f50 592d 3334 3938 330a 2020  ssue/PY-34983.  
-00009e40: 2020 2020 2020 2320 6e6f 696e 7370 6563        # noinspec
-00009e50: 7469 6f6e 2050 7950 6570 384e 616d 696e  tion PyPep8Namin
-00009e60: 670a 2020 2020 2020 2020 436f 6e64 6974  g.        Condit
-00009e70: 696f 6e20 3d20 7468 7265 6164 696e 672e  ion = threading.
-00009e80: 436f 6e64 6974 696f 6e0a 2020 2020 656c  Condition.    el
-00009e90: 7365 3a0a 2020 2020 2020 2020 2320 6e6f  se:.        # no
-00009ea0: 696e 7370 6563 7469 6f6e 2050 7955 6e72  inspection PyUnr
-00009eb0: 6573 6f6c 7665 6452 6566 6572 656e 6365  esolvedReference
-00009ec0: 732c 5079 5065 7038 4e61 6d69 6e67 2c50  s,PyPep8Naming,P
-00009ed0: 7950 726f 7465 6374 6564 4d65 6d62 6572  yProtectedMember
-00009ee0: 0a20 2020 2020 2020 2043 6f6e 6469 7469  .        Conditi
-00009ef0: 6f6e 203d 2074 6872 6561 6469 6e67 2e5f  on = threading._
-00009f00: 436f 6e64 6974 696f 6e0a 2020 2020 636f  Condition.    co
-00009f10: 6e64 5f77 6169 745f 6f72 6967 203d 2043  nd_wait_orig = C
-00009f20: 6f6e 6469 7469 6f6e 2e77 6169 740a 0a20  ondition.wait.. 
-00009f30: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
-00009f40: 6e20 5079 556e 7573 6564 4c6f 6361 6c0a  n PyUnusedLocal.
-00009f50: 2020 2020 6465 6620 636f 6e64 5f77 6169      def cond_wai
-00009f60: 745f 6861 636b 6564 2863 6f6e 642c 2074  t_hacked(cond, t
-00009f70: 696d 656f 7574 3d4e 6f6e 652c 202a 6172  imeout=None, *ar
-00009f80: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
-00009f90: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00009fa0: 436f 6e64 6974 696f 6e20 636f 6e64 3a0a  Condition cond:.
-00009fb0: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-00009fc0: 6c6f 6174 7c4e 6f6e 6520 7469 6d65 6f75  loat|None timeou
-00009fd0: 743a 0a20 2020 2020 2020 203a 7061 7261  t:.        :para
-00009fe0: 6d20 6172 6773 3a0a 2020 2020 2020 2020  m args:.        
-00009ff0: 3a72 7479 7065 3a20 626f 6f6c 0a20 2020  :rtype: bool.   
-0000a000: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000a010: 2069 6620 7468 7265 6164 2e67 6574 5f69   if thread.get_i
-0000a020: 6465 6e74 2829 203d 3d20 6d61 696e 5f74  dent() == main_t
-0000a030: 6872 6561 645f 6964 3a0a 2020 2020 2020  hread_id:.      
-0000a040: 2020 2020 2020 6966 2074 696d 656f 7574        if timeout
-0000a050: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000a060: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
-0000a070: 6120 7469 6d65 6f75 7420 616e 7977 6179  a timeout anyway
-0000a080: 2e20 5468 6973 2073 686f 756c 6420 6e6f  . This should no
-0000a090: 7420 6d61 7474 6572 2066 6f72 2074 6865  t matter for the
-0000a0a0: 2075 6e64 6572 6c79 696e 6720 636f 6465   underlying code
-0000a0b0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000a0c0: 2020 7265 7475 726e 2063 6f6e 645f 7761    return cond_wa
-0000a0d0: 6974 5f6f 7269 6728 636f 6e64 2c20 7469  it_orig(cond, ti
-0000a0e0: 6d65 6f75 743d 302e 3129 2020 2320 6e6f  meout=0.1)  # no
-0000a0f0: 7161 2020 2320 6874 7470 733a 2f2f 796f  qa  # https://yo
-0000a100: 7574 7261 636b 2e6a 6574 6272 6169 6e73  utrack.jetbrains
-0000a110: 2e63 6f6d 2f69 7373 7565 2f50 592d 3433  .com/issue/PY-43
-0000a120: 3931 350a 2020 2020 2020 2020 2020 2020  915.            
-0000a130: 2320 5468 6572 6520 6973 2073 6f6d 6520  # There is some 
-0000a140: 636f 6465 2028 652e 672e 206d 756c 7469  code (e.g. multi
-0000a150: 7072 6f63 6573 7369 6e67 2e70 6f6f 6c29  processing.pool)
-0000a160: 2077 6869 6368 2072 656c 6965 7320 6f6e   which relies on
-0000a170: 2074 6861 740a 2020 2020 2020 2020 2020   that.          
-0000a180: 2020 2320 7765 2072 6573 7065 6374 2074    # we respect t
-0000a190: 6865 2072 6561 6c20 7370 6563 6966 6965  he real specifie
-0000a1a0: 6420 7469 6d65 6f75 742e 0a20 2020 2020  d timeout..     
-0000a1b0: 2020 2020 2020 2023 2048 6f77 6576 6572         # However
-0000a1c0: 2c20 7765 2063 616e 6e6f 7420 646f 206d  , we cannot do m
-0000a1d0: 756c 7469 706c 6520 7265 7065 6174 6564  ultiple repeated
-0000a1e0: 2063 616c 6c73 2074 6f20 636f 6e64 5f77   calls to cond_w
-0000a1f0: 6169 745f 6f72 6967 2061 7320 7765 206d  ait_orig as we m
-0000a200: 6967 6874 206d 6973 7320 7468 6520 636f  ight miss the co
-0000a210: 6e64 6974 696f 6e20 6e6f 7469 6679 2e0a  ndition notify..
-0000a220: 2020 2020 2020 2020 2020 2020 2320 4275              # Bu
-0000a230: 7420 696e 2073 6f6d 6520 5079 7468 6f6e  t in some Python
-0000a240: 2076 6572 7369 6f6e 732c 2074 6865 2075   versions, the u
-0000a250: 6e64 6572 6c79 696e 6720 636f 6e64 5f77  nderlying cond_w
-0000a260: 6169 745f 6f72 6967 2077 696c 6c20 616e  ait_orig will an
-0000a270: 7977 6179 2061 6c73 6f20 7573 6520 736c  yway also use sl
-0000a280: 6565 702e 0a20 2020 2020 2020 2020 2020  eep..           
-0000a290: 2072 6574 7572 6e20 636f 6e64 5f77 6169   return cond_wai
-0000a2a0: 745f 6f72 6967 2863 6f6e 642c 2074 696d  t_orig(cond, tim
-0000a2b0: 656f 7574 3d74 696d 656f 7574 2920 2023  eout=timeout)  #
-0000a2c0: 206e 6f71 610a 2020 2020 2020 2020 656c   noqa.        el
-0000a2d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a2e0: 7265 7475 726e 2063 6f6e 645f 7761 6974  return cond_wait
-0000a2f0: 5f6f 7269 6728 636f 6e64 2c20 7469 6d65  _orig(cond, time
-0000a300: 6f75 743d 7469 6d65 6f75 7429 2020 2320  out=timeout)  # 
-0000a310: 6e6f 7161 0a0a 2020 2020 436f 6e64 6974  noqa..    Condit
-0000a320: 696f 6e2e 7761 6974 203d 2063 6f6e 645f  ion.wait = cond_
-0000a330: 7761 6974 5f68 6163 6b65 640a 0a20 2020  wait_hacked..   
-0000a340: 2023 2041 6e64 2074 6865 2073 616d 6520   # And the same 
-0000a350: 666f 7220 4c6f 636b 2e61 6371 7569 7265  for Lock.acquire
-0000a360: 2c20 7665 7279 2073 696d 696c 6172 2074  , very similar t
-0000a370: 6f20 436f 6e64 6974 696f 6e2e 7761 6974  o Condition.wait
-0000a380: 2e0a 2020 2020 2320 486f 7765 7665 723a  ..    # However:
-0000a390: 2063 616e 2774 2073 6574 2061 7474 7269   can't set attri
-0000a3a0: 6275 7465 7320 6f66 2062 7569 6c74 2d69  butes of built-i
-0000a3b0: 6e2f 6578 7465 6e73 696f 6e20 7479 7065  n/extension type
-0000a3c0: 2027 7468 7265 6164 2e6c 6f63 6b27 2e0a   'thread.lock'..
-0000a3d0: 2020 2020 2320 5765 2063 6f75 6c64 2077      # We could w
-0000a3e0: 7261 7020 7468 6520 7768 6f6c 6520 7468  rap the whole th
-0000a3f0: 7265 6164 696e 672e 4c6f 636b 2c20 6275  reading.Lock, bu
-0000a400: 7420 7468 6174 2069 7320 746f 6f20 616e  t that is too an
-0000a410: 6e6f 7969 6e67 2066 6f72 206d 6520 6e6f  noying for me no
-0000a420: 772e 2e2e 0a20 2020 2023 206e 6f69 6e73  w....    # noins
-0000a430: 7065 6374 696f 6e20 5079 5065 7038 4e61  pection PyPep8Na
-0000a440: 6d69 6e67 0a20 2020 204c 6f63 6b20 3d20  ming.    Lock = 
-0000a450: 4e6f 6e65 0a20 2020 2069 6620 4c6f 636b  None.    if Lock
-0000a460: 3a0a 2020 2020 2020 2020 6c6f 636b 5f61  :.        lock_a
-0000a470: 6371 7569 7265 5f6f 7269 6720 3d20 4c6f  cquire_orig = Lo
-0000a480: 636b 2e61 6371 7569 7265 2020 2320 6e6f  ck.acquire  # no
-0000a490: 7161 0a0a 2020 2020 2020 2020 2320 4e6f  qa..        # No
-0000a4a0: 7465 3a20 7469 6d65 6f75 7420 6172 6775  te: timeout argu
-0000a4b0: 6d65 6e74 2077 6173 2069 6e74 726f 6475  ment was introdu
-0000a4c0: 6365 6420 696e 2050 7974 686f 6e20 332e  ced in Python 3.
-0000a4d0: 0a20 2020 2020 2020 2064 6566 206c 6f63  .        def loc
-0000a4e0: 6b5f 6163 7175 6972 655f 6861 636b 6564  k_acquire_hacked
-0000a4f0: 286c 6f63 6b2c 2062 6c6f 636b 696e 673d  (lock, blocking=
-0000a500: 5472 7565 2c20 7469 6d65 6f75 743d 2d31  True, timeout=-1
-0000a510: 293a 0a20 2020 2020 2020 2020 2020 2022  ):.            "
-0000a520: 2222 0a20 2020 2020 2020 2020 2020 203a  "".            :
-0000a530: 7061 7261 6d20 7468 7265 6164 696e 672e  param threading.
-0000a540: 4c6f 636b 206c 6f63 6b3a 0a20 2020 2020  Lock lock:.     
-0000a550: 2020 2020 2020 203a 7061 7261 6d20 626f         :param bo
-0000a560: 6f6c 2062 6c6f 636b 696e 673a 0a20 2020  ol blocking:.   
-0000a570: 2020 2020 2020 2020 203a 7061 7261 6d20           :param 
-0000a580: 666c 6f61 7420 7469 6d65 6f75 743a 0a20  float timeout:. 
-0000a590: 2020 2020 2020 2020 2020 203a 7274 7970             :rtyp
-0000a5a0: 653a 2062 6f6f 6c0a 2020 2020 2020 2020  e: bool.        
-0000a5b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000a5c0: 2020 2020 6966 206e 6f74 2062 6c6f 636b      if not block
-0000a5d0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-0000a5e0: 2020 2020 2072 6574 7572 6e20 6c6f 636b       return lock
-0000a5f0: 5f61 6371 7569 7265 5f6f 7269 6728 6c6f  _acquire_orig(lo
-0000a600: 636b 2c20 626c 6f63 6b69 6e67 3d46 616c  ck, blocking=Fal
-0000a610: 7365 2920 2023 206e 6f20 7469 6d65 6f75  se)  # no timeou
-0000a620: 7420 6966 206e 6f74 2062 6c6f 636b 696e  t if not blockin
-0000a630: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
-0000a640: 4576 6572 7974 6869 6e67 2069 7320 626c  Everything is bl
-0000a650: 6f63 6b69 6e67 206e 6f77 2e0a 2020 2020  ocking now..    
-0000a660: 2020 2020 2020 2020 6966 2074 6872 6561          if threa
-0000a670: 642e 6765 745f 6964 656e 7428 2920 3d3d  d.get_ident() ==
-0000a680: 206d 6169 6e5f 7468 7265 6164 5f69 643a   main_thread_id:
-0000a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a6a0: 2069 6620 7469 6d65 6f75 7420 6973 204e   if timeout is N
-0000a6b0: 6f6e 6520 6f72 2074 696d 656f 7574 203c  one or timeout <
-0000a6c0: 2030 3a20 2023 2062 6c6f 636b 696e 6720   0:  # blocking 
-0000a6d0: 7769 7468 6f75 7420 7469 6d65 6f75 740a  without timeout.
-0000a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a6f0: 2020 2020 6966 2050 5933 3a0a 2020 2020      if PY3:.    
+00003a80: 6f6e 2829 202d 3e20 7374 723a 0a20 2020  on() -> str:.   
+00003a90: 2022 2222 0a20 2020 203a 7265 7475 726e   """.    :return
+00003aa0: 3a20 546f 7263 6820 7665 7273 696f 6e20  : Torch version 
+00003ab0: 616e 6420 7061 7468 2069 6e66 6f0a 2020  and path info.  
+00003ac0: 2020 2222 220a 2020 2020 7472 793a 0a20    """.    try:. 
+00003ad0: 2020 2020 2020 2023 206e 6f69 6e73 7065         # noinspe
+00003ae0: 6374 696f 6e20 5079 5061 636b 6167 6552  ction PyPackageR
+00003af0: 6571 7569 7265 6d65 6e74 730a 2020 2020  equirements.    
+00003b00: 2020 2020 696d 706f 7274 2074 6f72 6368      import torch
+00003b10: 0a20 2020 2065 7863 6570 7420 496d 706f  .    except Impo
+00003b20: 7274 4572 726f 7220 6173 2065 7863 3a0a  rtError as exc:.
+00003b30: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+00003b40: 3c50 7954 6f72 6368 2049 6d70 6f72 7445  <PyTorch ImportE
+00003b50: 7272 6f72 3a20 2573 3e22 2025 2065 7863  rror: %s>" % exc
+00003b60: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00003b70: 2020 7464 6972 203d 206f 732e 7061 7468    tdir = os.path
+00003b80: 2e64 6972 6e61 6d65 2874 6f72 6368 2e5f  .dirname(torch._
+00003b90: 5f66 696c 655f 5f29 0a20 2020 2065 7863  _file__).    exc
+00003ba0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+00003bb0: 2065 3a0a 2020 2020 2020 2020 7464 6972   e:.        tdir
+00003bc0: 203d 2022 3c75 6e6b 6e6f 776e 2865 7863   = "<unknown(exc
+00003bd0: 6570 7469 6f6e 3a20 2572 293e 2220 2520  eption: %r)>" % 
+00003be0: 650a 2020 2020 7665 7273 696f 6e20 3d20  e.    version = 
+00003bf0: 6765 7461 7474 7228 746f 7263 682c 2022  getattr(torch, "
+00003c00: 5f5f 7665 7273 696f 6e5f 5f22 2c20 223c  __version__", "<
+00003c10: 756e 6b6e 6f77 6e20 7665 7273 696f 6e3e  unknown version>
+00003c20: 2229 0a20 2020 2076 6572 7369 6f6e 202b  ").    version +
+00003c30: 3d20 2220 2825 7329 2220 2520 6765 7461  = " (%s)" % geta
+00003c40: 7474 7228 746f 7263 682e 7665 7273 696f  ttr(torch.versio
+00003c50: 6e2c 2022 6769 745f 7665 7273 696f 6e22  n, "git_version"
+00003c60: 2c20 223c 756e 6b6e 6f77 6e20 6769 7420  , "<unknown git 
+00003c70: 7665 7273 696f 6e3e 2229 0a20 2020 2074  version>").    t
+00003c80: 7279 3a0a 2020 2020 2020 2020 6966 2074  ry:.        if t
+00003c90: 6469 722e 7374 6172 7473 7769 7468 2822  dir.startswith("
+00003ca0: 3c22 293a 0a20 2020 2020 2020 2020 2020  <"):.           
+00003cb0: 2067 6974 5f69 6e66 6f20 3d20 223c 756e   git_info = "<un
+00003cc0: 6b6e 6f77 6e2d 6469 723e 220a 2020 2020  known-dir>".    
+00003cd0: 2020 2020 656c 6966 206f 732e 7061 7468      elif os.path
+00003ce0: 2e65 7869 7374 7328 7464 6972 202b 2022  .exists(tdir + "
+00003cf0: 2f2e 2e2f 2e67 6974 2229 3a0a 2020 2020  /../.git"):.    
+00003d00: 2020 2020 2020 2020 6769 745f 696e 666f          git_info
+00003d10: 203d 2022 6769 743a 2220 2b20 6769 745f   = "git:" + git_
+00003d20: 6465 7363 7269 6265 5f68 6561 645f 7665  describe_head_ve
+00003d30: 7273 696f 6e28 6769 745f 6469 723d 7464  rsion(git_dir=td
+00003d40: 6972 290a 2020 2020 2020 2020 656c 6966  ir).        elif
+00003d50: 2022 2f73 6974 652d 7061 636b 6167 6573   "/site-packages
+00003d60: 2f22 2069 6e20 7464 6972 3a0a 2020 2020  /" in tdir:.    
+00003d70: 2020 2020 2020 2020 6769 745f 696e 666f          git_info
+00003d80: 203d 2022 3c73 6974 652d 7061 636b 6167   = "<site-packag
+00003d90: 653e 220a 2020 2020 2020 2020 656c 7365  e>".        else
+00003da0: 3a0a 2020 2020 2020 2020 2020 2020 6769  :.            gi
+00003db0: 745f 696e 666f 203d 2022 3c6e 6f74 2d75  t_info = "<not-u
+00003dc0: 6e64 6572 2d67 6974 3e22 0a20 2020 2065  nder-git>".    e
+00003dd0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00003de0: 6173 2065 3a0a 2020 2020 2020 2020 6769  as e:.        gi
+00003df0: 745f 696e 666f 203d 2022 3c75 6e6b 6e6f  t_info = "<unkno
+00003e00: 776e 2867 6974 2065 7863 6570 7469 6f6e  wn(git exception
+00003e10: 3a20 2572 293e 2220 2520 650a 2020 2020  : %r)>" % e.    
+00003e20: 7265 7475 726e 2022 2573 2028 2573 2069  return "%s (%s i
+00003e30: 6e20 2573 2922 2025 2028 7665 7273 696f  n %s)" % (versio
+00003e40: 6e2c 2067 6974 5f69 6e66 6f2c 2074 6469  n, git_info, tdi
+00003e50: 7229 0a0a 0a64 6566 2067 6574 5f74 656e  r)...def get_ten
+00003e60: 736f 7266 6c6f 775f 7665 7273 696f 6e5f  sorflow_version_
+00003e70: 7475 706c 6528 293a 0a20 2020 2022 2222  tuple():.    """
+00003e80: 0a20 2020 203a 7265 7475 726e 3a20 7475  .    :return: tu
+00003e90: 706c 6520 6f66 2069 6e74 732c 2066 6972  ple of ints, fir
+00003ea0: 7374 2065 6e74 7279 2069 7320 7468 6520  st entry is the 
+00003eb0: 6d61 6a6f 7220 7665 7273 696f 6e0a 2020  major version.  
+00003ec0: 2020 3a72 7479 7065 3a20 7475 706c 655b    :rtype: tuple[
+00003ed0: 696e 745d 0a20 2020 2022 2222 0a20 2020  int].    """.   
+00003ee0: 2069 6d70 6f72 7420 7465 6e73 6f72 666c   import tensorfl
+00003ef0: 6f77 2061 7320 7466 0a20 2020 2069 6d70  ow as tf.    imp
+00003f00: 6f72 7420 7265 0a0a 2020 2020 7265 7475  ort re..    retu
+00003f10: 726e 2074 7570 6c65 285b 696e 7428 7265  rn tuple([int(re
+00003f20: 2e73 7562 2822 282d 7263 5b30 2d39 5d7c  .sub("(-rc[0-9]|
+00003f30: 2d64 6576 5b30 2d39 5d2a 2922 2c20 2222  -dev[0-9]*)", ""
+00003f40: 2c20 7329 2920 666f 7220 7320 696e 2074  , s)) for s in t
+00003f50: 662e 5f5f 7665 7273 696f 6e5f 5f2e 7370  f.__version__.sp
+00003f60: 6c69 7428 222e 2229 5d29 0a0a 0a64 6566  lit(".")])...def
+00003f70: 2065 7661 6c5f 7368 656c 6c5f 656e 7628   eval_shell_env(
+00003f80: 746f 6b65 6e29 3a0a 2020 2020 2222 220a  token):.    """.
+00003f90: 2020 2020 3a70 6172 616d 2073 7472 2074      :param str t
+00003fa0: 6f6b 656e 3a0a 2020 2020 3a72 6574 7572  oken:.    :retur
+00003fb0: 6e3a 2069 6620 2224 7661 7222 2c20 6c6f  n: if "$var", lo
+00003fc0: 6f6b 7320 696e 206f 732e 656e 7669 726f  oks in os.enviro
+00003fd0: 6e2c 206f 7468 6572 7769 7365 2072 6574  n, otherwise ret
+00003fe0: 7572 6e20 746f 6b65 6e20 6173 2069 730a  urn token as is.
+00003ff0: 2020 2020 3a72 7479 7065 3a20 7374 720a      :rtype: str.
+00004000: 2020 2020 2222 220a 2020 2020 6966 2074      """.    if t
+00004010: 6f6b 656e 2e73 7461 7274 7377 6974 6828  oken.startswith(
+00004020: 2224 2229 3a0a 2020 2020 2020 2020 7265  "$"):.        re
+00004030: 7475 726e 206f 732e 656e 7669 726f 6e2e  turn os.environ.
+00004040: 6765 7428 746f 6b65 6e5b 313a 5d2c 2022  get(token[1:], "
+00004050: 2229 0a20 2020 2072 6574 7572 6e20 746f  ").    return to
+00004060: 6b65 6e0a 0a0a 6465 6620 6576 616c 5f73  ken...def eval_s
+00004070: 6865 6c6c 5f73 7472 2873 293a 0a20 2020  hell_str(s):.   
+00004080: 2022 2222 0a20 2020 203a 7479 7065 2073   """.    :type s
+00004090: 3a20 7374 7220 7c20 6c69 7374 5b73 7472  : str | list[str
+000040a0: 5d20 7c20 2829 2d3e 7374 7220 7c20 6c69  ] | ()->str | li
+000040b0: 7374 5b28 292d 3e73 7472 5d20 7c20 2829  st[()->str] | ()
+000040c0: 2d3e 6c69 7374 5b73 7472 5d20 7c20 2829  ->list[str] | ()
+000040d0: 2d3e 6c69 7374 5b28 292d 3e73 7472 5d0a  ->list[()->str].
+000040e0: 2020 2020 3a72 7479 7065 3a20 6c69 7374      :rtype: list
+000040f0: 5b73 7472 5d0a 0a20 2020 2050 6172 7365  [str]..    Parse
+00004100: 7320 6073 6020 6173 2073 6865 6c6c 206c  s `s` as shell l
+00004110: 696b 6520 6172 6775 6d65 6e74 7320 2876  ike arguments (v
+00004120: 6961 2073 686c 6578 2e73 706c 6974 2920  ia shlex.split) 
+00004130: 616e 6420 6576 616c 7561 7465 7320 7368  and evaluates sh
+00004140: 656c 6c20 656e 7669 726f 6e6d 656e 7420  ell environment 
+00004150: 7661 7269 6162 6c65 730a 2020 2020 283a  variables.    (:
+00004160: 6675 6e63 3a60 6576 616c 5f73 6865 6c6c  func:`eval_shell
+00004170: 5f65 6e76 6029 2e0a 2020 2020 6073 6020  _env`)..    `s` 
+00004180: 6f72 2069 7473 2065 6c65 6d65 6e74 7320  or its elements 
+00004190: 6361 6e20 616c 736f 2062 6520 6361 6c6c  can also be call
+000041a0: 6162 6c65 2e20 496e 2074 686f 7365 2063  able. In those c
+000041b0: 6173 6573 2c20 7468 6579 2077 696c 6c20  ases, they will 
+000041c0: 6265 2063 616c 6c65 6420 616e 6420 7468  be called and th
+000041d0: 6520 7265 7475 726e 6564 2076 616c 7565  e returned value
+000041e0: 2069 7320 7573 6564 2e0a 2020 2020 2222   is used..    ""
+000041f0: 220a 2020 2020 746f 6b65 6e73 203d 205b  ".    tokens = [
+00004200: 5d0a 2020 2020 6966 2063 616c 6c61 626c  ].    if callabl
+00004210: 6528 7329 3a0a 2020 2020 2020 2020 7320  e(s):.        s 
+00004220: 3d20 7328 290a 2020 2020 6966 2069 7369  = s().    if isi
+00004230: 6e73 7461 6e63 6528 732c 2028 6c69 7374  nstance(s, (list
+00004240: 2c20 7475 706c 6529 293a 0a20 2020 2020  , tuple)):.     
+00004250: 2020 206c 7320 3d20 730a 2020 2020 656c     ls = s.    el
+00004260: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
+00004270: 7274 2069 7369 6e73 7461 6e63 6528 732c  rt isinstance(s,
+00004280: 2028 7374 722c 2075 6e69 636f 6465 2929   (str, unicode))
+00004290: 0a20 2020 2020 2020 206c 7320 3d20 7368  .        ls = sh
+000042a0: 6c65 782e 7370 6c69 7428 7329 0a20 2020  lex.split(s).   
+000042b0: 2066 6f72 2074 6f6b 656e 2069 6e20 6c73   for token in ls
+000042c0: 3a0a 2020 2020 2020 2020 6966 2063 616c  :.        if cal
+000042d0: 6c61 626c 6528 746f 6b65 6e29 3a0a 2020  lable(token):.  
+000042e0: 2020 2020 2020 2020 2020 746f 6b65 6e20            token 
+000042f0: 3d20 746f 6b65 6e28 290a 2020 2020 2020  = token().      
+00004300: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00004310: 6e63 6528 746f 6b65 6e2c 2028 7374 722c  nce(token, (str,
+00004320: 2075 6e69 636f 6465 2929 0a20 2020 2020   unicode)).     
+00004330: 2020 2069 6620 746f 6b65 6e2e 7374 6172     if token.star
+00004340: 7473 7769 7468 2822 2422 293a 0a20 2020  tswith("$"):.   
+00004350: 2020 2020 2020 2020 2074 6f6b 656e 7320           tokens 
+00004360: 2b3d 2065 7661 6c5f 7368 656c 6c5f 7374  += eval_shell_st
+00004370: 7228 6576 616c 5f73 6865 6c6c 5f65 6e76  r(eval_shell_env
+00004380: 2874 6f6b 656e 2929 0a20 2020 2020 2020  (token)).       
+00004390: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000043a0: 2020 2074 6f6b 656e 7320 2b3d 205b 746f     tokens += [to
+000043b0: 6b65 6e5d 0a20 2020 2072 6574 7572 6e20  ken].    return 
+000043c0: 746f 6b65 6e73 0a0a 0a64 6566 2068 6466  tokens...def hdf
+000043d0: 355f 6469 6d65 6e73 696f 6e28 6669 6c65  5_dimension(file
+000043e0: 6e61 6d65 2c20 6469 6d65 6e73 696f 6e29  name, dimension)
+000043f0: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
+00004400: 6172 616d 2073 7472 2066 696c 656e 616d  aram str filenam
+00004410: 653a 0a20 2020 203a 7061 7261 6d20 7374  e:.    :param st
+00004420: 7220 6469 6d65 6e73 696f 6e3a 0a20 2020  r dimension:.   
+00004430: 203a 7274 7970 653a 206e 756d 7079 2e6e   :rtype: numpy.n
+00004440: 6461 7272 6179 7c69 6e74 0a20 2020 2022  darray|int.    "
+00004450: 2222 0a20 2020 2066 696e 203d 2068 3570  "".    fin = h5p
+00004460: 792e 4669 6c65 2866 696c 656e 616d 652c  y.File(filename,
+00004470: 2022 7222 290a 2020 2020 6966 2022 2f22   "r").    if "/"
+00004480: 2069 6e20 6469 6d65 6e73 696f 6e3a 0a20   in dimension:. 
+00004490: 2020 2020 2020 2072 6573 203d 2066 696e         res = fin
+000044a0: 5b22 2f22 2e6a 6f69 6e28 6469 6d65 6e73  ["/".join(dimens
+000044b0: 696f 6e2e 7370 6c69 7428 222f 2229 5b3a  ion.split("/")[:
+000044c0: 2d31 5d29 5d2e 6174 7472 735b 6469 6d65  -1])].attrs[dime
+000044d0: 6e73 696f 6e2e 7370 6c69 7428 222f 2229  nsion.split("/")
+000044e0: 5b2d 315d 5d0a 2020 2020 656c 7365 3a0a  [-1]].    else:.
+000044f0: 2020 2020 2020 2020 7265 7320 3d20 6669          res = fi
+00004500: 6e2e 6174 7472 735b 6469 6d65 6e73 696f  n.attrs[dimensio
+00004510: 6e5d 0a20 2020 2066 696e 2e63 6c6f 7365  n].    fin.close
+00004520: 2829 0a20 2020 2072 6574 7572 6e20 7265  ().    return re
+00004530: 730a 0a0a 6465 6620 6864 6635 5f67 726f  s...def hdf5_gro
+00004540: 7570 2866 696c 656e 616d 652c 2064 696d  up(filename, dim
+00004550: 656e 7369 6f6e 293a 0a20 2020 2022 2222  ension):.    """
+00004560: 0a20 2020 203a 7061 7261 6d20 7374 7220  .    :param str 
+00004570: 6669 6c65 6e61 6d65 3a0a 2020 2020 3a70  filename:.    :p
+00004580: 6172 616d 2073 7472 2064 696d 656e 7369  aram str dimensi
+00004590: 6f6e 3a0a 2020 2020 3a72 7479 7065 3a20  on:.    :rtype: 
+000045a0: 6469 6374 5b73 7472 5d0a 2020 2020 2222  dict[str].    ""
+000045b0: 220a 2020 2020 6669 6e20 3d20 6835 7079  ".    fin = h5py
+000045c0: 2e46 696c 6528 6669 6c65 6e61 6d65 2c20  .File(filename, 
+000045d0: 2272 2229 0a20 2020 2072 6573 203d 207b  "r").    res = {
+000045e0: 6b3a 2066 696e 5b64 696d 656e 7369 6f6e  k: fin[dimension
+000045f0: 5d2e 6174 7472 735b 6b5d 2066 6f72 206b  ].attrs[k] for k
+00004600: 2069 6e20 6669 6e5b 6469 6d65 6e73 696f   in fin[dimensio
+00004610: 6e5d 2e61 7474 7273 7d0a 2020 2020 6669  n].attrs}.    fi
+00004620: 6e2e 636c 6f73 6528 290a 2020 2020 7265  n.close().    re
+00004630: 7475 726e 2072 6573 0a0a 0a64 6566 2068  turn res...def h
+00004640: 6466 355f 7368 6170 6528 6669 6c65 6e61  df5_shape(filena
+00004650: 6d65 2c20 6469 6d65 6e73 696f 6e29 3a0a  me, dimension):.
+00004660: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
+00004670: 616d 2073 7472 2066 696c 656e 616d 653a  am str filename:
+00004680: 0a20 2020 203a 7061 7261 6d20 6469 6d65  .    :param dime
+00004690: 6e73 696f 6e3a 0a20 2020 203a 7274 7970  nsion:.    :rtyp
+000046a0: 653a 2074 7570 6c65 5b69 6e74 5d0a 2020  e: tuple[int].  
+000046b0: 2020 2222 220a 2020 2020 6669 6e20 3d20    """.    fin = 
+000046c0: 6835 7079 2e46 696c 6528 6669 6c65 6e61  h5py.File(filena
+000046d0: 6d65 2c20 2272 2229 0a20 2020 2072 6573  me, "r").    res
+000046e0: 203d 2066 696e 5b64 696d 656e 7369 6f6e   = fin[dimension
+000046f0: 5d2e 7368 6170 650a 2020 2020 6669 6e2e  ].shape.    fin.
+00004700: 636c 6f73 6528 290a 2020 2020 7265 7475  close().    retu
+00004710: 726e 2072 6573 0a0a 0a64 6566 2068 6466  rn res...def hdf
+00004720: 355f 7374 7269 6e67 7328 6861 6e64 6c65  5_strings(handle
+00004730: 2c20 6e61 6d65 2c20 6461 7461 293a 0a20  , name, data):. 
+00004740: 2020 2022 2222 0a20 2020 203a 7061 7261     """.    :para
+00004750: 6d20 6835 7079 2e46 696c 6520 6861 6e64  m h5py.File hand
+00004760: 6c65 3a0a 2020 2020 3a70 6172 616d 2073  le:.    :param s
+00004770: 7472 206e 616d 653a 0a20 2020 203a 7061  tr name:.    :pa
+00004780: 7261 6d20 6e75 6d70 792e 6e64 6172 7261  ram numpy.ndarra
+00004790: 797c 6c69 7374 5b73 7472 5d20 6461 7461  y|list[str] data
+000047a0: 3a0a 2020 2020 2222 220a 2020 2020 2320  :.    """.    # 
+000047b0: 6e6f 696e 7370 6563 7469 6f6e 2050 7942  noinspection PyB
+000047c0: 726f 6164 4578 6365 7074 696f 6e0a 2020  roadException.  
+000047d0: 2020 7472 793a 0a20 2020 2020 2020 2073    try:.        s
+000047e0: 203d 206d 6178 285b 6c65 6e28 6429 2066   = max([len(d) f
+000047f0: 6f72 2064 2069 6e20 6461 7461 5d29 0a20  or d in data]). 
+00004800: 2020 2020 2020 2064 7365 7420 3d20 6861         dset = ha
+00004810: 6e64 6c65 2e63 7265 6174 655f 6461 7461  ndle.create_data
+00004820: 7365 7428 6e61 6d65 2c20 286c 656e 2864  set(name, (len(d
+00004830: 6174 6129 2c29 2c20 6474 7970 653d 2253  ata),), dtype="S
+00004840: 2220 2b20 7374 7228 7329 290a 2020 2020  " + str(s)).    
+00004850: 2020 2020 6473 6574 5b2e 2e2e 5d20 3d20      dset[...] = 
+00004860: 6461 7461 0a20 2020 2065 7863 6570 7420  data.    except 
+00004870: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+00004880: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
+00004890: 6e20 5079 556e 7265 736f 6c76 6564 5265  n PyUnresolvedRe
+000048a0: 6665 7265 6e63 6573 0a20 2020 2020 2020  ferences.       
+000048b0: 2064 7420 3d20 6835 7079 2e73 7065 6369   dt = h5py.speci
+000048c0: 616c 5f64 7479 7065 2876 6c65 6e3d 756e  al_dtype(vlen=un
+000048d0: 6963 6f64 6529 0a20 2020 2020 2020 2064  icode).        d
+000048e0: 656c 2068 616e 646c 655b 6e61 6d65 5d0a  el handle[name].
+000048f0: 2020 2020 2020 2020 6473 6574 203d 2068          dset = h
+00004900: 616e 646c 652e 6372 6561 7465 5f64 6174  andle.create_dat
+00004910: 6173 6574 286e 616d 652c 2028 6c65 6e28  aset(name, (len(
+00004920: 6461 7461 292c 292c 2064 7479 7065 3d64  data),), dtype=d
+00004930: 7429 0a20 2020 2020 2020 2064 7365 745b  t).        dset[
+00004940: 2e2e 2e5d 203d 2064 6174 610a 0a0a 6465  ...] = data...de
+00004950: 6620 6d6f 6465 6c5f 6570 6f63 685f 6672  f model_epoch_fr
+00004960: 6f6d 5f66 696c 656e 616d 6528 6669 6c65  om_filename(file
+00004970: 6e61 6d65 293a 0a20 2020 2022 2222 0a20  name):.    """. 
+00004980: 2020 203a 7061 7261 6d20 7374 7220 6669     :param str fi
+00004990: 6c65 6e61 6d65 3a0a 2020 2020 3a72 6574  lename:.    :ret
+000049a0: 7572 6e3a 2065 706f 6368 206e 756d 6265  urn: epoch numbe
+000049b0: 720a 2020 2020 3a72 7479 7065 3a20 696e  r.    :rtype: in
+000049c0: 747c 4e6f 6e65 0a20 2020 2022 2222 0a20  t|None.    """. 
+000049d0: 2020 2023 2057 6520 636f 756c 6420 6368     # We could ch
+000049e0: 6563 6b20 7669 613a 0a20 2020 2023 2074  eck via:.    # t
+000049f0: 662e 636f 6e74 7269 622e 6672 616d 6577  f.contrib.framew
+00004a00: 6f72 6b2e 7079 7468 6f6e 2e66 7261 6d65  ork.python.frame
+00004a10: 776f 726b 2e63 6865 636b 706f 696e 745f  work.checkpoint_
+00004a20: 7574 696c 732e 6c6f 6164 5f76 6172 6961  utils.load_varia
+00004a30: 626c 6528 290a 2020 2020 2320 6f6e 6365  ble().    # once
+00004a40: 2077 6520 7361 7665 2074 6861 7420 696e   we save that in
+00004a50: 2074 6865 206d 6f64 656c 2e0a 2020 2020   the model..    
+00004a60: 2320 5365 6520 5446 4e65 7477 6f72 6b2e  # See TFNetwork.
+00004a70: 4e65 7477 6f72 6b2e 5f63 7265 6174 655f  Network._create_
+00004a80: 7361 7665 7228 292e 0a20 2020 2023 2057  saver()..    # W
+00004a90: 6520 646f 6e27 7420 6861 7665 2069 7420  e don't have it 
+00004aa0: 696e 2074 6865 206d 6f64 656c 2c20 7468  in the model, th
+00004ab0: 6f75 6768 2e0a 2020 2020 2320 466f 7220  ough..    # For 
+00004ac0: 6e6f 772c 206a 7573 7420 7061 7273 6520  now, just parse 
+00004ad0: 6974 2066 726f 6d20 6669 6c65 6e61 6d65  it from filename
+00004ae0: 2e0a 2020 2020 2320 4966 2054 462c 2061  ..    # If TF, a
+00004af0: 6e64 2073 796d 6c69 6e6b 2c20 7265 736f  nd symlink, reso
+00004b00: 6c76 6520 756e 7469 6c20 6e6f 2073 796d  lve until no sym
+00004b10: 6c69 6e6b 2061 6e79 6d6f 7265 2028 652e  link anymore (e.
+00004b20: 672e 2069 6620 7765 2073 796d 6c69 6e6b  g. if we symlink
+00004b30: 6564 2074 6865 2062 6573 7420 6570 6f63  ed the best epoc
+00004b40: 6829 2e0a 2020 2020 666f 7220 706f 7465  h)..    for pote
+00004b50: 6e74 6961 6c5f 6578 7420 696e 205b 222e  ntial_ext in [".
+00004b60: 6d65 7461 222c 2022 2e70 7422 5d3a 0a20  meta", ".pt"]:. 
+00004b70: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
+00004b80: 2e70 6174 682e 6578 6973 7473 2866 696c  .path.exists(fil
+00004b90: 656e 616d 6520 2b20 706f 7465 6e74 6961  ename + potentia
+00004ba0: 6c5f 6578 7429 3a0a 2020 2020 2020 2020  l_ext):.        
+00004bb0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00004bc0: 2020 2020 2077 6869 6c65 206f 732e 7061       while os.pa
+00004bd0: 7468 2e65 7869 7374 7328 6669 6c65 6e61  th.exists(filena
+00004be0: 6d65 202b 2070 6f74 656e 7469 616c 5f65  me + potential_e
+00004bf0: 7874 2920 616e 6420 6f73 2e70 6174 682e  xt) and os.path.
+00004c00: 6973 6c69 6e6b 2866 696c 656e 616d 6520  islink(filename 
+00004c10: 2b20 706f 7465 6e74 6961 6c5f 6578 7429  + potential_ext)
+00004c20: 3a0a 2020 2020 2020 2020 2020 2020 666e  :.            fn
+00004c30: 5f77 6974 685f 6578 745f 203d 206f 732e  _with_ext_ = os.
+00004c40: 7265 6164 6c69 6e6b 2866 696c 656e 616d  readlink(filenam
+00004c50: 6520 2b20 706f 7465 6e74 6961 6c5f 6578  e + potential_ex
+00004c60: 7429 0a20 2020 2020 2020 2020 2020 2061  t).            a
+00004c70: 7373 6572 7420 666e 5f77 6974 685f 6578  ssert fn_with_ex
+00004c80: 745f 2e65 6e64 7377 6974 6828 706f 7465  t_.endswith(pote
+00004c90: 6e74 6961 6c5f 6578 7429 2c20 2273 7472  ntial_ext), "str
+00004ca0: 616e 6765 3f20 2573 2c20 2573 2220 2520  ange? %s, %s" % 
+00004cb0: 2866 696c 656e 616d 652c 2070 6f74 656e  (filename, poten
+00004cc0: 7469 616c 5f65 7874 290a 2020 2020 2020  tial_ext).      
+00004cd0: 2020 2020 2020 6669 6c65 6e61 6d65 203d        filename =
+00004ce0: 2066 6e5f 7769 7468 5f65 7874 5f5b 3a20   fn_with_ext_[: 
+00004cf0: 2d6c 656e 2870 6f74 656e 7469 616c 5f65  -len(potential_e
+00004d00: 7874 295d 0a20 2020 2020 2020 2062 7265  xt)].        bre
+00004d10: 616b 0a20 2020 206d 203d 2072 652e 6d61  ak.    m = re.ma
+00004d20: 7463 6828 222e 2a5c 5c2e 285b 302d 395d  tch(".*\\.([0-9]
+00004d30: 2b29 222c 2066 696c 656e 616d 6529 0a20  +)", filename). 
+00004d40: 2020 2069 6620 6e6f 7420 6d3a 0a20 2020     if not m:.   
+00004d50: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00004d60: 0a20 2020 2072 6574 7572 6e20 696e 7428  .    return int(
+00004d70: 6d2e 6772 6f75 7073 2829 5b30 5d29 0a0a  m.groups()[0])..
+00004d80: 0a64 6566 2064 6565 705f 7570 6461 7465  .def deep_update
+00004d90: 5f64 6963 745f 7661 6c75 6573 2864 2c20  _dict_values(d, 
+00004da0: 6b65 792c 206e 6577 5f76 616c 7565 293a  key, new_value):
+00004db0: 0a20 2020 2022 2222 0a20 2020 2056 6973  .    """.    Vis
+00004dc0: 6974 7320 616c 6c20 6974 656d 7320 696e  its all items in
+00004dd0: 2060 6460 2e0a 2020 2020 4966 2074 6865   `d`..    If the
+00004de0: 2076 616c 7565 2069 7320 6120 6469 6374   value is a dict
+00004df0: 2c20 6974 2077 696c 6c20 7265 6375 7273  , it will recurs
+00004e00: 6976 656c 7920 7669 7369 7420 6974 2e0a  ively visit it..
+00004e10: 0a20 2020 203a 7061 7261 6d20 6469 6374  .    :param dict
+00004e20: 5b73 7472 2c54 7c6f 626a 6563 747c 4e6f  [str,T|object|No
+00004e30: 6e65 7c64 6963 745d 2064 3a20 7769 6c6c  ne|dict] d: will
+00004e40: 2075 7064 6174 6520 696e 706c 6163 650a   update inplace.
+00004e50: 2020 2020 3a70 6172 616d 2073 7472 206b      :param str k
+00004e60: 6579 3a0a 2020 2020 3a70 6172 616d 2054  ey:.    :param T
+00004e70: 206e 6577 5f76 616c 7565 3a0a 2020 2020   new_value:.    
+00004e80: 2222 220a 2020 2020 666f 7220 7661 6c75  """.    for valu
+00004e90: 6520 696e 2064 2e76 616c 7565 7328 293a  e in d.values():
+00004ea0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00004eb0: 7374 616e 6365 2876 616c 7565 2c20 6469  stance(value, di
+00004ec0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
+00004ed0: 2064 6565 705f 7570 6461 7465 5f64 6963   deep_update_dic
+00004ee0: 745f 7661 6c75 6573 2876 616c 7565 2c20  t_values(value, 
+00004ef0: 6b65 793d 6b65 792c 206e 6577 5f76 616c  key=key, new_val
+00004f00: 7565 3d6e 6577 5f76 616c 7565 290a 2020  ue=new_value).  
+00004f10: 2020 6966 206b 6579 2069 6e20 643a 0a20    if key in d:. 
+00004f20: 2020 2020 2020 2064 5b6b 6579 5d20 3d20         d[key] = 
+00004f30: 6e65 775f 7661 6c75 650a 0a0a 6465 6620  new_value...def 
+00004f40: 7465 726d 696e 616c 5f73 697a 6528 6669  terminal_size(fi
+00004f50: 6c65 3d73 7973 2e73 7464 6f75 7429 3a0a  le=sys.stdout):.
+00004f60: 2020 2020 2222 220a 2020 2020 5265 7475      """.    Retu
+00004f70: 726e 7320 7468 6520 7465 726d 696e 616c  rns the terminal
+00004f80: 2073 697a 652e 0a20 2020 2054 6869 7320   size..    This 
+00004f90: 7769 6c6c 2070 726f 6261 626c 7920 776f  will probably wo
+00004fa0: 726b 206f 6e20 6c69 6e75 7820 6f6e 6c79  rk on linux only
+00004fb0: 2e0a 0a20 2020 203a 7061 7261 6d20 696f  ...    :param io
+00004fc0: 2e46 696c 6520 6669 6c65 3a0a 2020 2020  .File file:.    
+00004fd0: 3a72 6574 7572 6e3a 2028 636f 6c75 6d6e  :return: (column
+00004fe0: 732c 206c 696e 6573 292c 206f 7220 282d  s, lines), or (-
+00004ff0: 312c 2d31 290a 2020 2020 3a72 7479 7065  1,-1).    :rtype
+00005000: 3a20 2869 6e74 2c69 6e74 290a 2020 2020  : (int,int).    
+00005010: 2222 220a 2020 2020 696d 706f 7274 206f  """.    import o
+00005020: 730a 2020 2020 696d 706f 7274 2069 6f0a  s.    import io.
+00005030: 0a20 2020 2069 6620 6e6f 7420 6861 7361  .    if not hasa
+00005040: 7474 7228 6669 6c65 2c20 2266 696c 656e  ttr(file, "filen
+00005050: 6f22 293a 0a20 2020 2020 2020 2072 6574  o"):.        ret
+00005060: 7572 6e20 2d31 2c20 2d31 0a20 2020 2074  urn -1, -1.    t
+00005070: 7279 3a0a 2020 2020 2020 2020 6966 206e  ry:.        if n
+00005080: 6f74 206f 732e 6973 6174 7479 2866 696c  ot os.isatty(fil
+00005090: 652e 6669 6c65 6e6f 2829 293a 0a20 2020  e.fileno()):.   
+000050a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000050b0: 2d31 2c20 2d31 0a20 2020 2065 7863 6570  -1, -1.    excep
+000050c0: 7420 2869 6f2e 556e 7375 7070 6f72 7465  t (io.Unsupporte
+000050d0: 644f 7065 7261 7469 6f6e 2c20 5661 6c75  dOperation, Valu
+000050e0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+000050f0: 2072 6574 7572 6e20 2d31 2c20 2d31 0a20   return -1, -1. 
+00005100: 2020 2065 6e76 203d 206f 732e 656e 7669     env = os.envi
+00005110: 726f 6e0a 0a20 2020 2023 206e 6f69 6e73  ron..    # noins
+00005120: 7065 6374 696f 6e20 5079 5368 6164 6f77  pection PyShadow
+00005130: 696e 674e 616d 6573 0a20 2020 2064 6566  ingNames.    def
+00005140: 2069 6f63 746c 5f67 7769 6e73 7a28 6664   ioctl_gwinsz(fd
+00005150: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00005160: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+00005170: 7420 6664 3a20 6669 6c65 2064 6573 6372  t fd: file descr
+00005180: 6970 746f 720a 2020 2020 2020 2020 3a72  iptor.        :r
+00005190: 7479 7065 3a20 7475 706c 655b 696e 745d  type: tuple[int]
+000051a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000051b0: 2020 2020 2023 206e 6f69 6e73 7065 6374       # noinspect
+000051c0: 696f 6e20 5079 4272 6f61 6445 7863 6570  ion PyBroadExcep
+000051d0: 7469 6f6e 0a20 2020 2020 2020 2074 7279  tion.        try
+000051e0: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+000051f0: 706f 7274 2066 636e 746c 0a20 2020 2020  port fcntl.     
+00005200: 2020 2020 2020 2069 6d70 6f72 7420 7465         import te
+00005210: 726d 696f 730a 2020 2020 2020 2020 2020  rmios.          
+00005220: 2020 696d 706f 7274 2073 7472 7563 740a    import struct.
+00005230: 0a20 2020 2020 2020 2020 2020 2063 725f  .            cr_
+00005240: 203d 2073 7472 7563 742e 756e 7061 636b   = struct.unpack
+00005250: 2822 6868 222c 2066 636e 746c 2e69 6f63  ("hh", fcntl.ioc
+00005260: 746c 2866 642c 2074 6572 6d69 6f73 2e54  tl(fd, termios.T
+00005270: 494f 4347 5749 4e53 5a2c 2022 3132 3334  IOCGWINSZ, "1234
+00005280: 2229 2920 2023 206e 6f71 610a 2020 2020  "))  # noqa.    
+00005290: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000052a0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+000052b0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+000052c0: 2072 6574 7572 6e20 6372 5f0a 0a20 2020   return cr_..   
+000052d0: 2063 7220 3d20 696f 6374 6c5f 6777 696e   cr = ioctl_gwin
+000052e0: 737a 2866 696c 652e 6669 6c65 6e6f 2920  sz(file.fileno) 
+000052f0: 6f72 2069 6f63 746c 5f67 7769 6e73 7a28  or ioctl_gwinsz(
+00005300: 3029 206f 7220 696f 6374 6c5f 6777 696e  0) or ioctl_gwin
+00005310: 737a 2831 2920 6f72 2069 6f63 746c 5f67  sz(1) or ioctl_g
+00005320: 7769 6e73 7a28 3229 0a20 2020 2069 6620  winsz(2).    if 
+00005330: 6e6f 7420 6372 3a0a 2020 2020 2020 2020  not cr:.        
+00005340: 2320 6e6f 696e 7370 6563 7469 6f6e 2050  # noinspection P
+00005350: 7942 726f 6164 4578 6365 7074 696f 6e0a  yBroadException.
+00005360: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00005370: 2020 2020 2020 2020 2066 6420 3d20 6f73           fd = os
+00005380: 2e6f 7065 6e28 6f73 2e63 7465 726d 6964  .open(os.ctermid
+00005390: 2829 2c20 6f73 2e4f 5f52 444f 4e4c 5929  (), os.O_RDONLY)
+000053a0: 0a20 2020 2020 2020 2020 2020 2063 7220  .            cr 
+000053b0: 3d20 696f 6374 6c5f 6777 696e 737a 2866  = ioctl_gwinsz(f
+000053c0: 6429 0a20 2020 2020 2020 2020 2020 206f  d).            o
+000053d0: 732e 636c 6f73 6528 6664 290a 2020 2020  s.close(fd).    
+000053e0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000053f0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00005400: 2020 7061 7373 0a20 2020 2069 6620 6e6f    pass.    if no
+00005410: 7420 6372 3a0a 2020 2020 2020 2020 6372  t cr:.        cr
+00005420: 203d 2028 656e 762e 6765 7428 224c 494e   = (env.get("LIN
+00005430: 4553 222c 2032 3529 2c20 656e 762e 6765  ES", 25), env.ge
+00005440: 7428 2243 4f4c 554d 4e53 222c 2038 3029  t("COLUMNS", 80)
+00005450: 290a 2020 2020 7265 7475 726e 2069 6e74  ).    return int
+00005460: 2863 725b 315d 292c 2069 6e74 2863 725b  (cr[1]), int(cr[
+00005470: 305d 290a 0a0a 6465 6620 6973 5f74 7479  0])...def is_tty
+00005480: 2866 696c 653d 7379 732e 7374 646f 7574  (file=sys.stdout
+00005490: 293a 0a20 2020 2022 2222 0a20 2020 203a  ):.    """.    :
+000054a0: 7061 7261 6d20 696f 2e46 696c 6520 6669  param io.File fi
+000054b0: 6c65 3a0a 2020 2020 3a72 7479 7065 3a20  le:.    :rtype: 
+000054c0: 626f 6f6c 0a20 2020 2022 2222 0a20 2020  bool.    """.   
+000054d0: 2074 6572 6d69 6e61 6c5f 7769 6474 682c   terminal_width,
+000054e0: 205f 203d 2074 6572 6d69 6e61 6c5f 7369   _ = terminal_si
+000054f0: 7a65 2866 696c 653d 6669 6c65 290a 2020  ze(file=file).  
+00005500: 2020 7265 7475 726e 2074 6572 6d69 6e61    return termina
+00005510: 6c5f 7769 6474 6820 3e20 300a 0a0a 6465  l_width > 0...de
+00005520: 6620 636f 6e66 6972 6d28 7478 742c 2065  f confirm(txt, e
+00005530: 7869 745f 6f6e 5f66 616c 7365 3d46 616c  xit_on_false=Fal
+00005540: 7365 293a 0a20 2020 2022 2222 0a20 2020  se):.    """.   
+00005550: 203a 7061 7261 6d20 7374 7220 7478 743a   :param str txt:
+00005560: 2065 2e67 2e20 2244 656c 6574 6520 6576   e.g. "Delete ev
+00005570: 6572 7974 6869 6e67 3f22 0a20 2020 203a  erything?".    :
+00005580: 7061 7261 6d20 626f 6f6c 2065 7869 745f  param bool exit_
+00005590: 6f6e 5f66 616c 7365 3a20 6966 2054 7275  on_false: if Tru
+000055a0: 652c 2077 696c 6c20 6361 6c6c 2073 7973  e, will call sys
+000055b0: 2e65 7869 7428 3129 2069 6620 6e6f 7420  .exit(1) if not 
+000055c0: 636f 6e66 6972 6d65 640a 2020 2020 3a72  confirmed.    :r
+000055d0: 7479 7065 3a20 626f 6f6c 0a20 2020 2022  type: bool.    "
+000055e0: 2222 0a20 2020 2077 6869 6c65 2054 7275  "".    while Tru
+000055f0: 653a 0a20 2020 2020 2020 2072 203d 2069  e:.        r = i
+00005600: 6e70 7574 2822 2573 2043 6f6e 6669 726d  nput("%s Confirm
+00005610: 3f20 5b79 6573 2f6e 6f5d 2220 2520 7478  ? [yes/no]" % tx
+00005620: 7429 0a20 2020 2020 2020 2069 6620 6e6f  t).        if no
+00005630: 7420 723a 0a20 2020 2020 2020 2020 2020  t r:.           
+00005640: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00005650: 2020 6966 2072 2069 6e20 5b22 7922 2c20    if r in ["y", 
+00005660: 2279 6573 225d 3a0a 2020 2020 2020 2020  "yes"]:.        
+00005670: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+00005680: 2020 2020 2020 2020 6966 2072 2069 6e20          if r in 
+00005690: 5b22 6e22 2c20 226e 6f22 5d3a 0a20 2020  ["n", "no"]:.   
+000056a0: 2020 2020 2020 2020 2069 6620 6578 6974           if exit
+000056b0: 5f6f 6e5f 6661 6c73 653a 0a20 2020 2020  _on_false:.     
+000056c0: 2020 2020 2020 2020 2020 2073 7973 2e65             sys.e
+000056d0: 7869 7428 3129 0a20 2020 2020 2020 2020  xit(1).         
+000056e0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+000056f0: 2020 2020 2020 2020 7072 696e 7428 2249          print("I
+00005700: 6e76 616c 6964 2072 6573 706f 6e73 6520  nvalid response 
+00005710: 2572 2e22 2025 2072 290a 0a0a 6465 6620  %r." % r)...def 
+00005720: 686d 7328 7329 3a0a 2020 2020 2222 220a  hms(s):.    """.
+00005730: 2020 2020 3a70 6172 616d 2066 6c6f 6174      :param float
+00005740: 7c69 6e74 2073 3a20 7365 636f 6e64 730a  |int s: seconds.
+00005750: 2020 2020 3a72 6574 7572 6e3a 2065 2e67      :return: e.g
+00005760: 2e20 2231 3a32 333a 3435 2220 2868 733a  . "1:23:45" (hs:
+00005770: 6d73 3a73 6563 7329 2e20 7365 6520 686d  ms:secs). see hm
+00005780: 735f 6672 6163 7469 6f6e 2069 6620 796f  s_fraction if yo
+00005790: 7520 7761 6e74 2074 6f20 6765 7420 6672  u want to get fr
+000057a0: 6163 7469 6f6e 616c 2073 6563 6f6e 6473  actional seconds
+000057b0: 0a20 2020 203a 7274 7970 653a 2073 7472  .    :rtype: str
+000057c0: 0a20 2020 2022 2222 0a20 2020 206d 2c20  .    """.    m, 
+000057d0: 7320 3d20 6469 766d 6f64 2873 2c20 3630  s = divmod(s, 60
+000057e0: 290a 2020 2020 682c 206d 203d 2064 6976  ).    h, m = div
+000057f0: 6d6f 6428 6d2c 2036 3029 0a20 2020 2072  mod(m, 60).    r
+00005800: 6574 7572 6e20 2225 643a 2530 3264 3a25  eturn "%d:%02d:%
+00005810: 3032 6422 2025 2028 682c 206d 2c20 7329  02d" % (h, m, s)
+00005820: 0a0a 0a64 6566 2068 6d73 5f66 7261 6374  ...def hms_fract
+00005830: 696f 6e28 732c 2064 6563 696d 616c 733d  ion(s, decimals=
+00005840: 3429 3a0a 2020 2020 2222 220a 2020 2020  4):.    """.    
+00005850: 3a70 6172 616d 2066 6c6f 6174 2073 3a20  :param float s: 
+00005860: 7365 636f 6e64 730a 2020 2020 3a70 6172  seconds.    :par
+00005870: 616d 2069 6e74 2064 6563 696d 616c 733a  am int decimals:
+00005880: 2068 6f77 206d 7563 6820 6465 6369 6d61   how much decima
+00005890: 6c73 2074 6f20 7072 696e 740a 2020 2020  ls to print.    
+000058a0: 3a72 6574 7572 6e3a 2065 2e67 2e20 2231  :return: e.g. "1
+000058b0: 3a32 333a 3435 2e36 3738 3922 2028 6873  :23:45.6789" (hs
+000058c0: 3a6d 733a 7365 6373 290a 2020 2020 3a72  :ms:secs).    :r
+000058d0: 7479 7065 3a20 7374 720a 2020 2020 2222  type: str.    ""
+000058e0: 220a 2020 2020 7265 7475 726e 2068 6d73  ".    return hms
+000058f0: 2869 6e74 2873 2929 202b 2028 2822 2525  (int(s)) + (("%%
+00005900: 2e30 2569 6622 2025 2064 6563 696d 616c  .0%if" % decimal
+00005910: 7329 2025 2028 7320 2d20 696e 7428 7329  s) % (s - int(s)
+00005920: 2929 5b31 3a5d 0a0a 0a64 6566 2068 756d  ))[1:]...def hum
+00005930: 616e 5f73 697a 6528 6e2c 2066 6163 746f  an_size(n, facto
+00005940: 723d 3130 3030 2c20 6672 6163 3d30 2e38  r=1000, frac=0.8
+00005950: 2c20 7072 6563 3d31 293a 0a20 2020 2022  , prec=1):.    "
+00005960: 2222 0a20 2020 203a 7061 7261 6d20 696e  "".    :param in
+00005970: 747c 666c 6f61 7420 6e3a 0a20 2020 203a  t|float n:.    :
+00005980: 7061 7261 6d20 696e 7420 6661 6374 6f72  param int factor
+00005990: 3a20 666f 7220 6561 6368 206f 6620 7468  : for each of th
+000059a0: 6520 756e 6974 7320 4b2c 204d 2c20 472c  e units K, M, G,
+000059b0: 2054 0a20 2020 203a 7061 7261 6d20 666c   T.    :param fl
+000059c0: 6f61 7420 6672 6163 3a20 7768 656e 2074  oat frac: when t
+000059d0: 6f20 676f 206f 7665 7220 746f 2074 6865  o go over to the
+000059e0: 206e 6578 7420 6269 6767 6572 2075 6e69   next bigger uni
+000059f0: 740a 2020 2020 3a70 6172 616d 2069 6e74  t.    :param int
+00005a00: 2070 7265 633a 2068 6f77 206d 7563 6820   prec: how much 
+00005a10: 6465 6369 6d61 6c73 2061 6674 6572 2074  decimals after t
+00005a20: 6865 2064 6f74 0a20 2020 203a 7265 7475  he dot.    :retu
+00005a30: 726e 3a20 6875 6d61 6e20 7265 6164 6162  rn: human readab
+00005a40: 6c65 2073 697a 652c 2075 7369 6e67 204b  le size, using K
+00005a50: 2c20 4d2c 2047 2c20 540a 2020 2020 3a72  , M, G, T.    :r
+00005a60: 7479 7065 3a20 7374 720a 2020 2020 2222  type: str.    ""
+00005a70: 220a 2020 2020 706f 7374 6669 7865 7320  ".    postfixes 
+00005a80: 3d20 5b22 222c 2022 4b22 2c20 224d 222c  = ["", "K", "M",
+00005a90: 2022 4722 2c20 2254 225d 0a20 2020 2069   "G", "T"].    i
+00005aa0: 203d 2030 0a20 2020 2077 6869 6c65 2069   = 0.    while i
+00005ab0: 203c 206c 656e 2870 6f73 7466 6978 6573   < len(postfixes
+00005ac0: 2920 2d20 3120 616e 6420 6e20 3e20 2866  ) - 1 and n > (f
+00005ad0: 6163 746f 7220 2a2a 2028 6920 2b20 3129  actor ** (i + 1)
+00005ae0: 2920 2a20 6672 6163 3a0a 2020 2020 2020  ) * frac:.      
+00005af0: 2020 6920 2b3d 2031 0a20 2020 2069 6620    i += 1.    if 
+00005b00: 6920 3d3d 2030 3a0a 2020 2020 2020 2020  i == 0:.        
+00005b10: 7265 7475 726e 2073 7472 286e 290a 2020  return str(n).  
+00005b20: 2020 7265 7475 726e 2028 2225 2e22 202b    return ("%." +
+00005b30: 2073 7472 2870 7265 6329 202b 2022 6622   str(prec) + "f"
+00005b40: 2920 2520 2866 6c6f 6174 286e 2920 2f20  ) % (float(n) / 
+00005b50: 2866 6163 746f 722a 2a69 2929 202b 2070  (factor**i)) + p
+00005b60: 6f73 7466 6978 6573 5b69 5d0a 0a0a 6465  ostfixes[i]...de
+00005b70: 6620 6875 6d61 6e5f 6279 7465 735f 7369  f human_bytes_si
+00005b80: 7a65 286e 2c20 6661 6374 6f72 3d31 3032  ze(n, factor=102
+00005b90: 342c 2066 7261 633d 302e 382c 2070 7265  4, frac=0.8, pre
+00005ba0: 633d 3129 3a0a 2020 2020 2222 220a 2020  c=1):.    """.  
+00005bb0: 2020 3a70 6172 616d 2069 6e74 7c66 6c6f    :param int|flo
+00005bc0: 6174 206e 3a0a 2020 2020 3a70 6172 616d  at n:.    :param
+00005bd0: 2069 6e74 2066 6163 746f 723a 2073 6565   int factor: see
+00005be0: 203a 6675 6e63 3a60 6875 6d61 6e5f 7369   :func:`human_si
+00005bf0: 7a65 602e 2031 3032 3420 6279 2064 6566  ze`. 1024 by def
+00005c00: 6175 6c74 2066 6f72 2062 7974 6573 0a20  ault for bytes. 
+00005c10: 2020 203a 7061 7261 6d20 666c 6f61 7420     :param float 
+00005c20: 6672 6163 3a20 7365 6520 3a66 756e 633a  frac: see :func:
+00005c30: 6068 756d 616e 5f73 697a 6560 0a20 2020  `human_size`.   
+00005c40: 203a 7061 7261 6d20 696e 7420 7072 6563   :param int prec
+00005c50: 3a20 686f 7720 6d75 6368 2064 6563 696d  : how much decim
+00005c60: 616c 7320 6166 7465 7220 7468 6520 646f  als after the do
+00005c70: 740a 2020 2020 3a72 6574 7572 6e3a 2068  t.    :return: h
+00005c80: 756d 616e 2072 6561 6461 626c 6520 6279  uman readable by
+00005c90: 7465 2073 697a 652c 2075 7369 6e67 204b  te size, using K
+00005ca0: 2c20 4d2c 2047 2c20 542c 2077 6974 6820  , M, G, T, with 
+00005cb0: 2242 2220 6174 2074 6865 2065 6e64 0a20  "B" at the end. 
+00005cc0: 2020 203a 7274 7970 653a 2073 7472 0a20     :rtype: str. 
+00005cd0: 2020 2022 2222 0a20 2020 2072 6574 7572     """.    retur
+00005ce0: 6e20 6875 6d61 6e5f 7369 7a65 286e 2c20  n human_size(n, 
+00005cf0: 6661 6374 6f72 3d66 6163 746f 722c 2066  factor=factor, f
+00005d00: 7261 633d 6672 6163 2c20 7072 6563 3d70  rac=frac, prec=p
+00005d10: 7265 6329 202b 2022 4222 0a0a 0a64 6566  rec) + "B"...def
+00005d20: 205f 7070 5f65 7874 7261 5f69 6e66 6f28   _pp_extra_info(
+00005d30: 6f62 6a2c 2064 6570 7468 5f6c 696d 6974  obj, depth_limit
+00005d40: 3d33 293a 0a20 2020 2022 2222 0a20 2020  =3):.    """.   
+00005d50: 203a 7061 7261 6d20 6f62 6a65 6374 206f   :param object o
+00005d60: 626a 3a0a 2020 2020 3a70 6172 616d 2069  bj:.    :param i
+00005d70: 6e74 2064 6570 7468 5f6c 696d 6974 3a0a  nt depth_limit:.
+00005d80: 2020 2020 3a72 6574 7572 6e3a 2065 7874      :return: ext
+00005d90: 7261 2069 6e66 6f20 2869 6620 6176 6169  ra info (if avai
+00005da0: 6c61 626c 653a 206c 656e 2c20 736f 6d65  lable: len, some
+00005db0: 2069 7465 6d73 2c20 2e2e 2e29 0a20 2020   items, ...).   
+00005dc0: 203a 7274 7970 653a 2073 7472 0a20 2020   :rtype: str.   
+00005dd0: 2022 2222 0a20 2020 2069 6620 6973 696e   """.    if isin
+00005de0: 7374 616e 6365 286f 626a 2c20 6e70 2e6e  stance(obj, np.n
+00005df0: 6461 7272 6179 293a 0a20 2020 2020 2020  darray):.       
+00005e00: 2072 6574 7572 6e20 2273 6861 7065 3d25   return "shape=%
+00005e10: 7222 2025 2028 6f62 6a2e 7368 6170 652c  r" % (obj.shape,
+00005e20: 290a 2020 2020 7320 3d20 5b5d 0a20 2020  ).    s = [].   
+00005e30: 2069 6620 6861 7361 7474 7228 6f62 6a2c   if hasattr(obj,
+00005e40: 2022 5f5f 6c65 6e5f 5f22 293a 0a20 2020   "__len__"):.   
+00005e50: 2020 2020 2023 206e 6f69 6e73 7065 6374       # noinspect
+00005e60: 696f 6e20 5079 4272 6f61 6445 7863 6570  ion PyBroadExcep
+00005e70: 7469 6f6e 0a20 2020 2020 2020 2074 7279  tion.        try
+00005e80: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00005e90: 6e6f 696e 7370 6563 7469 6f6e 2050 7954  noinspection PyT
+00005ea0: 7970 6543 6865 636b 6572 0a20 2020 2020  ypeChecker.     
+00005eb0: 2020 2020 2020 2069 6620 7479 7065 286f         if type(o
+00005ec0: 626a 2920 696e 2028 7374 722c 2075 6e69  bj) in (str, uni
+00005ed0: 636f 6465 2c20 6c69 7374 2c20 7475 706c  code, list, tupl
+00005ee0: 652c 2064 6963 7429 2061 6e64 206c 656e  e, dict) and len
+00005ef0: 286f 626a 2920 3c3d 2035 3a0a 2020 2020  (obj) <= 5:.    
+00005f00: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00005f10: 2020 2320 646f 6e27 7420 7072 696e 7420    # don't print 
+00005f20: 6c65 6e20 696e 2074 6869 7320 6361 7365  len in this case
+00005f30: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00005f40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00005f50: 2020 2073 202b 3d20 5b22 6c65 6e20 3d20     s += ["len = 
+00005f60: 2569 2220 2520 6f62 6a2e 5f5f 6c65 6e5f  %i" % obj.__len_
+00005f70: 5f28 295d 2020 2320 6e6f 7161 0a20 2020  _()]  # noqa.   
+00005f80: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00005f90: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+00005fa0: 2020 2070 6173 730a 2020 2020 6966 2064     pass.    if d
+00005fb0: 6570 7468 5f6c 696d 6974 203e 2030 2061  epth_limit > 0 a
+00005fc0: 6e64 2068 6173 6174 7472 286f 626a 2c20  nd hasattr(obj, 
+00005fd0: 225f 5f67 6574 6974 656d 5f5f 2229 3a0a  "__getitem__"):.
+00005fe0: 2020 2020 2020 2020 2320 6e6f 696e 7370          # noinsp
+00005ff0: 6563 7469 6f6e 2050 7942 726f 6164 4578  ection PyBroadEx
+00006000: 6365 7074 696f 6e0a 2020 2020 2020 2020  ception.        
+00006010: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00006020: 2069 6620 7479 7065 286f 626a 2920 696e   if type(obj) in
+00006030: 2028 7374 722c 2075 6e69 636f 6465 293a   (str, unicode):
+00006040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006050: 2070 6173 7320 2023 2064 6f65 736e 2774   pass  # doesn't
+00006060: 206d 616b 6520 7365 6e73 6520 746f 2067   make sense to g
+00006070: 6574 2073 7562 2069 7465 6d73 2068 6572  et sub items her
+00006080: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+00006090: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000060a0: 2020 2020 7375 625f 6f62 6a20 3d20 6f62      sub_obj = ob
+000060b0: 6a2e 5f5f 6765 7469 7465 6d5f 5f28 3029  j.__getitem__(0)
+000060c0: 2020 2320 6e6f 7161 0a20 2020 2020 2020    # noqa.       
+000060d0: 2020 2020 2020 2020 2065 7874 7261 5f69           extra_i
+000060e0: 6e66 6f20 3d20 5f70 705f 6578 7472 615f  nfo = _pp_extra_
+000060f0: 696e 666f 2873 7562 5f6f 626a 2c20 6465  info(sub_obj, de
+00006100: 7074 685f 6c69 6d69 7420 2d20 3129 0a20  pth_limit - 1). 
+00006110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00006120: 6620 6578 7472 615f 696e 666f 2021 3d20  f extra_info != 
+00006130: 2222 3a0a 2020 2020 2020 2020 2020 2020  "":.            
+00006140: 2020 2020 2020 2020 7320 2b3d 205b 225f          s += ["_
+00006150: 5b30 5d3a 207b 2573 7d22 2025 2065 7874  [0]: {%s}" % ext
+00006160: 7261 5f69 6e66 6f5d 0a20 2020 2020 2020  ra_info].       
+00006170: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00006180: 6e3a 0a20 2020 2020 2020 2020 2020 2070  n:.            p
+00006190: 6173 730a 2020 2020 7265 7475 726e 2022  ass.    return "
+000061a0: 2c20 222e 6a6f 696e 2873 290a 0a0a 5f70  , ".join(s)..._p
+000061b0: 7265 7474 795f 7072 696e 745f 6c69 6d69  retty_print_limi
+000061c0: 7420 3d20 3330 300a 5f70 7265 7474 795f  t = 300._pretty_
+000061d0: 7072 696e 745f 6173 5f62 7974 6573 203d  print_as_bytes =
+000061e0: 2046 616c 7365 0a0a 0a64 6566 2073 6574   False...def set
+000061f0: 5f70 7265 7474 795f 7072 696e 745f 6465  _pretty_print_de
+00006200: 6661 756c 745f 6c69 6d69 7428 6c69 6d69  fault_limit(limi
+00006210: 7429 3a0a 2020 2020 2222 220a 2020 2020  t):.    """.    
+00006220: 3a70 6172 616d 2069 6e74 7c66 6c6f 6174  :param int|float
+00006230: 206c 696d 6974 3a20 7573 6520 666c 6f61   limit: use floa
+00006240: 7428 2269 6e66 2229 2074 6f20 6469 7361  t("inf") to disa
+00006250: 626c 650a 2020 2020 2222 220a 2020 2020  ble.    """.    
+00006260: 676c 6f62 616c 205f 7072 6574 7479 5f70  global _pretty_p
+00006270: 7269 6e74 5f6c 696d 6974 0a20 2020 205f  rint_limit.    _
+00006280: 7072 6574 7479 5f70 7269 6e74 5f6c 696d  pretty_print_lim
+00006290: 6974 203d 206c 696d 6974 0a0a 0a64 6566  it = limit...def
+000062a0: 2073 6574 5f70 7265 7474 795f 7072 696e   set_pretty_prin
+000062b0: 745f 6173 5f62 7974 6573 2861 735f 6279  t_as_bytes(as_by
+000062c0: 7465 7329 3a0a 2020 2020 2222 220a 2020  tes):.    """.  
+000062d0: 2020 3a70 6172 616d 2062 6f6f 6c20 6173    :param bool as
+000062e0: 5f62 7974 6573 3a0a 2020 2020 2222 220a  _bytes:.    """.
+000062f0: 2020 2020 676c 6f62 616c 205f 7072 6574      global _pret
+00006300: 7479 5f70 7269 6e74 5f61 735f 6279 7465  ty_print_as_byte
+00006310: 730a 2020 2020 5f70 7265 7474 795f 7072  s.    _pretty_pr
+00006320: 696e 745f 6173 5f62 7974 6573 203d 2061  int_as_bytes = a
+00006330: 735f 6279 7465 730a 0a0a 6465 6620 7072  s_bytes...def pr
+00006340: 6574 7479 5f70 7269 6e74 286f 626a 2c20  etty_print(obj, 
+00006350: 6c69 6d69 743d 4e6f 6e65 293a 0a20 2020  limit=None):.   
+00006360: 2022 2222 0a20 2020 203a 7061 7261 6d20   """.    :param 
+00006370: 6f62 6a65 6374 206f 626a 3a0a 2020 2020  object obj:.    
+00006380: 3a70 6172 616d 2069 6e74 7c66 6c6f 6174  :param int|float
+00006390: 206c 696d 6974 3a20 7573 6520 666c 6f61   limit: use floa
+000063a0: 7428 2269 6e66 2229 2074 6f20 6469 7361  t("inf") to disa
+000063b0: 626c 652e 204e 6f6e 6520 7769 6c6c 2075  ble. None will u
+000063c0: 7365 2074 6865 2064 6566 6175 6c74 2c20  se the default, 
+000063d0: 7669 6120 7365 745f 7072 6574 7479 5f70  via set_pretty_p
+000063e0: 7269 6e74 5f64 6566 6175 6c74 5f6c 696d  rint_default_lim
+000063f0: 6974 0a20 2020 203a 7265 7475 726e 3a20  it.    :return: 
+00006400: 7265 7072 286f 626a 292c 206f 7220 736f  repr(obj), or so
+00006410: 6d65 2073 686f 7274 6564 2076 6572 7369  me shorted versi
+00006420: 6f6e 206f 6620 7468 6174 2c20 6d61 7962  on of that, mayb
+00006430: 6520 7769 7468 2065 7874 7261 2069 6e66  e with extra inf
+00006440: 6f0a 2020 2020 3a72 7479 7065 3a20 7374  o.    :rtype: st
+00006450: 720a 2020 2020 2222 220a 2020 2020 6966  r.    """.    if
+00006460: 205f 7072 6574 7479 5f70 7269 6e74 5f61   _pretty_print_a
+00006470: 735f 6279 7465 7320 616e 6420 6973 696e  s_bytes and isin
+00006480: 7374 616e 6365 286f 626a 2c20 6e70 2e6e  stance(obj, np.n
+00006490: 6461 7272 6179 293a 0a20 2020 2020 2020  darray):.       
+000064a0: 2062 7320 3d20 6f62 6a2e 746f 6279 7465   bs = obj.tobyte
+000064b0: 7328 290a 2020 2020 2020 2020 696d 706f  s().        impo
+000064c0: 7274 2067 7a69 700a 0a20 2020 2020 2020  rt gzip..       
+000064d0: 2062 7320 3d20 677a 6970 2e63 6f6d 7072   bs = gzip.compr
+000064e0: 6573 7328 6273 290a 2020 2020 2020 2020  ess(bs).        
+000064f0: 696d 706f 7274 2062 6173 6536 340a 0a20  import base64.. 
+00006500: 2020 2020 2020 2069 6620 6c65 6e28 6273         if len(bs
+00006510: 2920 3e20 3537 3a0a 2020 2020 2020 2020  ) > 57:.        
+00006520: 2020 2020 7061 7274 7320 3d20 5b5d 0a20      parts = []. 
+00006530: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+00006540: 206c 656e 2862 7329 203e 2030 3a0a 2020   len(bs) > 0:.  
+00006550: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00006560: 7274 732e 6170 7065 6e64 2862 735b 3a35  rts.append(bs[:5
+00006570: 375d 290a 2020 2020 2020 2020 2020 2020  7]).            
+00006580: 2020 2020 6273 203d 2062 735b 3537 3a5d      bs = bs[57:]
+00006590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000065a0: 2069 6620 6c65 6e28 6273 2920 3d3d 2030   if len(bs) == 0
+000065b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000065c0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+000065d0: 2020 2020 2020 2020 7320 3d20 225c 6e20          s = "\n 
+000065e0: 2022 202b 2022 5c6e 2020 222e 6a6f 696e   " + "\n  ".join
+000065f0: 285b 7265 7072 2862 6173 6536 342e 656e  ([repr(base64.en
+00006600: 636f 6465 6279 7465 7328 6273 292e 7374  codebytes(bs).st
+00006610: 7269 7028 2929 2066 6f72 2062 7320 696e  rip()) for bs in
+00006620: 2070 6172 7473 5d29 202b 2022 5c6e 2020   parts]) + "\n  
+00006630: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
+00006640: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
+00006650: 7265 7072 2862 6173 6536 342e 656e 636f  repr(base64.enco
+00006660: 6465 6279 7465 7328 6273 292e 7374 7269  debytes(bs).stri
+00006670: 7028 2929 0a20 2020 2020 2020 2073 203d  p()).        s =
+00006680: 2022 6e75 6d70 792e 6672 6f6d 6275 6666   "numpy.frombuff
+00006690: 6572 2867 7a69 702e 6465 636f 6d70 7265  er(gzip.decompre
+000066a0: 7373 2862 6173 6536 342e 6465 636f 6465  ss(base64.decode
+000066b0: 6279 7465 7328 2573 2929 2c20 6474 7970  bytes(%s)), dtyp
+000066c0: 653d 2572 292e 7265 7368 6170 6528 2572  e=%r).reshape(%r
+000066d0: 2922 2025 2028 0a20 2020 2020 2020 2020  )" % (.         
+000066e0: 2020 2073 2c0a 2020 2020 2020 2020 2020     s,.          
+000066f0: 2020 7374 7228 6f62 6a2e 6474 7970 6529    str(obj.dtype)
+00006700: 2c0a 2020 2020 2020 2020 2020 2020 6f62  ,.            ob
+00006710: 6a2e 7368 6170 652c 0a20 2020 2020 2020  j.shape,.       
+00006720: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
+00006730: 2020 2020 2073 203d 2072 6570 7228 6f62       s = repr(ob
+00006740: 6a29 0a20 2020 2069 6620 6c69 6d69 7420  j).    if limit 
+00006750: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00006760: 206c 696d 6974 203d 205f 7072 6574 7479   limit = _pretty
+00006770: 5f70 7269 6e74 5f6c 696d 6974 0a20 2020  _print_limit.   
+00006780: 2069 6620 6c65 6e28 7329 203e 206c 696d   if len(s) > lim
+00006790: 6974 3a0a 2020 2020 2020 2020 7320 3d20  it:.        s = 
+000067a0: 735b 3a20 696e 7428 6c69 6d69 7429 202d  s[: int(limit) -
+000067b0: 2033 5d0a 2020 2020 2020 2020 7320 2b3d   3].        s +=
+000067c0: 2022 2e2e 2e22 0a20 2020 2065 7874 7261   "...".    extra
+000067d0: 5f69 6e66 6f20 3d20 5f70 705f 6578 7472  _info = _pp_extr
+000067e0: 615f 696e 666f 286f 626a 290a 2020 2020  a_info(obj).    
+000067f0: 6966 2065 7874 7261 5f69 6e66 6f20 213d  if extra_info !=
+00006800: 2022 223a 0a20 2020 2020 2020 2073 202b   "":.        s +
+00006810: 3d20 222c 2022 202b 2065 7874 7261 5f69  = ", " + extra_i
+00006820: 6e66 6f0a 2020 2020 7265 7475 726e 2073  nfo.    return s
+00006830: 0a0a 0a64 6566 2070 726f 6772 6573 735f  ...def progress_
+00006840: 6261 7228 636f 6d70 6c65 7465 3d31 2e30  bar(complete=1.0
+00006850: 2c20 7072 6566 6978 3d22 222c 2073 7566  , prefix="", suf
+00006860: 6669 783d 2222 2c20 6669 6c65 3d4e 6f6e  fix="", file=Non
+00006870: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+00006880: 5072 696e 7473 2073 6f6d 6520 7072 6f67  Prints some prog
+00006890: 7265 7373 2062 6172 2e0a 0a20 2020 203a  ress bar...    :
+000068a0: 7061 7261 6d20 666c 6f61 7420 636f 6d70  param float comp
+000068b0: 6c65 7465 3a20 6672 6f6d 2030 2e30 2074  lete: from 0.0 t
+000068c0: 6f20 312e 300a 2020 2020 3a70 6172 616d  o 1.0.    :param
+000068d0: 2073 7472 2070 7265 6669 783a 0a20 2020   str prefix:.   
+000068e0: 203a 7061 7261 6d20 7374 7220 7375 6666   :param str suff
+000068f0: 6978 3a0a 2020 2020 3a70 6172 616d 2069  ix:.    :param i
+00006900: 6f2e 5465 7874 494f 5772 6170 7065 727c  o.TextIOWrapper|
+00006910: 7479 7069 6e67 2e54 6578 7449 4f7c 4e6f  typing.TextIO|No
+00006920: 6e65 2066 696c 653a 2077 6865 7265 2074  ne file: where t
+00006930: 6f20 7072 696e 742e 2073 7464 6f75 7420  o print. stdout 
+00006940: 6279 2064 6566 6175 6c74 0a20 2020 203a  by default.    :
+00006950: 7265 7475 726e 3a20 6e6f 7468 696e 672c  return: nothing,
+00006960: 2077 696c 6c20 7072 696e 7420 6f6e 2060   will print on `
+00006970: 6066 696c 6560 600a 2020 2020 2222 220a  `file``.    """.
+00006980: 2020 2020 6966 2066 696c 6520 6973 204e      if file is N
+00006990: 6f6e 653a 0a20 2020 2020 2020 2066 696c  one:.        fil
+000069a0: 6520 3d20 7379 732e 7374 646f 7574 0a20  e = sys.stdout. 
+000069b0: 2020 2074 6572 6d69 6e61 6c5f 7769 6474     terminal_widt
+000069c0: 682c 205f 203d 2074 6572 6d69 6e61 6c5f  h, _ = terminal_
+000069d0: 7369 7a65 2866 696c 653d 6669 6c65 290a  size(file=file).
+000069e0: 2020 2020 6966 2074 6572 6d69 6e61 6c5f      if terminal_
+000069f0: 7769 6474 6820 3c3d 2030 3a0a 2020 2020  width <= 0:.    
+00006a00: 2020 2020 7265 7475 726e 0a20 2020 2069      return.    i
+00006a10: 6620 636f 6d70 6c65 7465 203d 3d20 312e  f complete == 1.
+00006a20: 303a 0a20 2020 2020 2020 2066 696c 652e  0:.        file.
+00006a30: 7772 6974 6528 225c 7225 7322 2025 2028  write("\r%s" % (
+00006a40: 7465 726d 696e 616c 5f77 6964 7468 202a  terminal_width *
+00006a50: 2022 2022 2929 0a20 2020 2020 2020 2066   " ")).        f
+00006a60: 696c 652e 666c 7573 6828 290a 2020 2020  ile.flush().    
+00006a70: 2020 2020 6669 6c65 2e77 7269 7465 2822      file.write("
+00006a80: 5c72 2229 0a20 2020 2020 2020 2066 696c  \r").        fil
+00006a90: 652e 666c 7573 6828 290a 2020 2020 2020  e.flush().      
+00006aa0: 2020 7265 7475 726e 0a20 2020 2070 726f    return.    pro
+00006ab0: 6772 6573 7320 3d20 2225 2e30 3266 2525  gress = "%.02f%%
+00006ac0: 2220 2520 2863 6f6d 706c 6574 6520 2a20  " % (complete * 
+00006ad0: 3130 3029 0a20 2020 2069 6620 7072 6566  100).    if pref
+00006ae0: 6978 2021 3d20 2222 3a0a 2020 2020 2020  ix != "":.      
+00006af0: 2020 7072 6566 6978 203d 2070 7265 6669    prefix = prefi
+00006b00: 7820 2b20 2220 220a 2020 2020 6966 2073  x + " ".    if s
+00006b10: 7566 6669 7820 213d 2022 223a 0a20 2020  uffix != "":.   
+00006b20: 2020 2020 2073 7566 6669 7820 3d20 2220       suffix = " 
+00006b30: 2220 2b20 7375 6666 6978 0a20 2020 206e  " + suffix.    n
+00006b40: 746f 7461 6c20 3d20 7465 726d 696e 616c  total = terminal
+00006b50: 5f77 6964 7468 202d 206c 656e 2870 726f  _width - len(pro
+00006b60: 6772 6573 7329 202d 206c 656e 2870 7265  gress) - len(pre
+00006b70: 6669 7829 202d 206c 656e 2873 7566 6669  fix) - len(suffi
+00006b80: 7829 202d 2034 0a20 2020 2062 6172 7320  x) - 4.    bars 
+00006b90: 3d20 227c 2220 2a20 696e 7428 636f 6d70  = "|" * int(comp
+00006ba0: 6c65 7465 202a 206e 746f 7461 6c29 0a20  lete * ntotal). 
+00006bb0: 2020 2073 7061 6365 7320 3d20 2220 2220     spaces = " " 
+00006bc0: 2a20 286e 746f 7461 6c20 2d20 696e 7428  * (ntotal - int(
+00006bd0: 636f 6d70 6c65 7465 202a 206e 746f 7461  complete * ntota
+00006be0: 6c29 290a 2020 2020 6261 7220 3d20 6261  l)).    bar = ba
+00006bf0: 7273 202b 2073 7061 6365 730a 2020 2020  rs + spaces.    
+00006c00: 6669 6c65 2e77 7269 7465 280a 2020 2020  file.write(.    
+00006c10: 2020 2020 225c 7225 7322 2025 2070 7265      "\r%s" % pre
+00006c20: 6669 7820 2b20 225b 2220 2b20 6261 725b  fix + "[" + bar[
+00006c30: 3a20 6c65 6e28 6261 7229 202f 2f20 325d  : len(bar) // 2]
+00006c40: 202b 2022 2022 202b 2070 726f 6772 6573   + " " + progres
+00006c50: 7320 2b20 2220 2220 2b20 6261 725b 6c65  s + " " + bar[le
+00006c60: 6e28 6261 7229 202f 2f20 3220 3a5d 202b  n(bar) // 2 :] +
+00006c70: 2022 5d22 202b 2073 7566 6669 780a 2020   "]" + suffix.  
+00006c80: 2020 290a 2020 2020 6669 6c65 2e66 6c75    ).    file.flu
+00006c90: 7368 2829 0a0a 0a63 6c61 7373 205f 5072  sh()...class _Pr
+00006ca0: 6f67 7265 7373 4261 7257 6974 6854 696d  ogressBarWithTim
+00006cb0: 6553 7461 7473 3a0a 2020 2020 2222 220a  eStats:.    """.
+00006cc0: 2020 2020 476c 6f62 616c 2063 6c6f 7375      Global closu
+00006cd0: 7265 2e20 5573 6564 2062 7920 3a66 756e  re. Used by :fun
+00006ce0: 633a 6070 726f 6772 6573 735f 6261 725f  c:`progress_bar_
+00006cf0: 7769 7468 5f74 696d 6560 2e0a 2020 2020  with_time`..    
+00006d00: 2222 220a 0a20 2020 2073 7461 7274 5f74  """..    start_t
+00006d10: 696d 6520 3d20 4e6f 6e65 0a20 2020 206c  ime = None.    l
+00006d20: 6173 745f 636f 6d70 6c65 7465 203d 204e  ast_complete = N
+00006d30: 6f6e 650a 0a0a 6465 6620 7072 6f67 7265  one...def progre
+00006d40: 7373 5f62 6172 5f77 6974 685f 7469 6d65  ss_bar_with_time
+00006d50: 2863 6f6d 706c 6574 653d 312e 302c 2070  (complete=1.0, p
+00006d60: 7265 6669 783d 2222 2c20 2a2a 6b77 6172  refix="", **kwar
+00006d70: 6773 293a 0a20 2020 2022 2222 0a20 2020  gs):.    """.   
+00006d80: 203a 6675 6e63 3a60 7072 6f67 7265 7373   :func:`progress
+00006d90: 5f62 6172 6020 7769 7468 2061 6464 6974  _bar` with addit
+00006da0: 696f 6e61 6c20 7265 6d61 696e 696e 6720  ional remaining 
+00006db0: 7469 6d65 2065 7374 696d 6174 696f 6e2e  time estimation.
+00006dc0: 0a0a 2020 2020 3a70 6172 616d 2066 6c6f  ..    :param flo
+00006dd0: 6174 2063 6f6d 706c 6574 653a 0a20 2020  at complete:.   
+00006de0: 203a 7061 7261 6d20 7374 7220 7072 6566   :param str pref
+00006df0: 6978 3a0a 2020 2020 3a70 6172 616d 206b  ix:.    :param k
+00006e00: 7761 7267 733a 2070 6173 7365 6420 746f  wargs: passed to
+00006e10: 203a 6675 6e63 3a60 7072 6f67 7265 7373   :func:`progress
+00006e20: 5f62 6172 600a 2020 2020 3a72 6574 7572  _bar`.    :retur
+00006e30: 6e3a 206e 6f74 6869 6e67 0a20 2020 2022  n: nothing.    "
+00006e40: 2222 0a20 2020 2073 7461 7473 203d 205f  "".    stats = _
+00006e50: 5072 6f67 7265 7373 4261 7257 6974 6854  ProgressBarWithT
+00006e60: 696d 6553 7461 7473 0a20 2020 2069 6620  imeStats.    if 
+00006e70: 7374 6174 732e 7374 6172 745f 7469 6d65  stats.start_time
+00006e80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00006e90: 2020 7374 6174 732e 7374 6172 745f 7469    stats.start_ti
+00006ea0: 6d65 203d 2074 696d 652e 7469 6d65 2829  me = time.time()
+00006eb0: 0a20 2020 2020 2020 2073 7461 7473 2e6c  .        stats.l
+00006ec0: 6173 745f 636f 6d70 6c65 7465 203d 2063  ast_complete = c
+00006ed0: 6f6d 706c 6574 650a 2020 2020 6966 2073  omplete.    if s
+00006ee0: 7461 7473 2e6c 6173 745f 636f 6d70 6c65  tats.last_comple
+00006ef0: 7465 203e 2063 6f6d 706c 6574 653a 0a20  te > complete:. 
+00006f00: 2020 2020 2020 2073 7461 7473 2e73 7461         stats.sta
+00006f10: 7274 5f74 696d 6520 3d20 7469 6d65 2e74  rt_time = time.t
+00006f20: 696d 6528 290a 2020 2020 7374 6174 732e  ime().    stats.
+00006f30: 6c61 7374 5f63 6f6d 706c 6574 6520 3d20  last_complete = 
+00006f40: 636f 6d70 6c65 7465 0a0a 2020 2020 7374  complete..    st
+00006f50: 6172 745f 656c 6170 7365 6420 3d20 7469  art_elapsed = ti
+00006f60: 6d65 2e74 696d 6528 2920 2d20 7374 6174  me.time() - stat
+00006f70: 732e 7374 6172 745f 7469 6d65 0a20 2020  s.start_time.   
+00006f80: 2069 6620 636f 6d70 6c65 7465 203e 2030   if complete > 0
+00006f90: 3a0a 2020 2020 2020 2020 746f 7461 6c5f  :.        total_
+00006fa0: 7469 6d65 5f65 7374 696d 6174 6564 203d  time_estimated =
+00006fb0: 2073 7461 7274 5f65 6c61 7073 6564 202f   start_elapsed /
+00006fc0: 2063 6f6d 706c 6574 650a 2020 2020 2020   complete.      
+00006fd0: 2020 7265 6d61 696e 696e 675f 6573 7469    remaining_esti
+00006fe0: 6d61 7465 6420 3d20 746f 7461 6c5f 7469  mated = total_ti
+00006ff0: 6d65 5f65 7374 696d 6174 6564 202d 2073  me_estimated - s
+00007000: 7461 7274 5f65 6c61 7073 6564 0a20 2020  tart_elapsed.   
+00007010: 2020 2020 2069 6620 7072 6566 6978 3a0a       if prefix:.
+00007020: 2020 2020 2020 2020 2020 2020 7072 6566              pref
+00007030: 6978 202b 3d20 222c 2022 202b 2068 6d73  ix += ", " + hms
+00007040: 2872 656d 6169 6e69 6e67 5f65 7374 696d  (remaining_estim
+00007050: 6174 6564 290a 2020 2020 2020 2020 656c  ated).        el
+00007060: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007070: 7072 6566 6978 203d 2068 6d73 2872 656d  prefix = hms(rem
+00007080: 6169 6e69 6e67 5f65 7374 696d 6174 6564  aining_estimated
+00007090: 290a 2020 2020 7072 6f67 7265 7373 5f62  ).    progress_b
+000070a0: 6172 2863 6f6d 706c 6574 652c 2070 7265  ar(complete, pre
+000070b0: 6669 783d 7072 6566 6978 2c20 2a2a 6b77  fix=prefix, **kw
+000070c0: 6172 6773 290a 0a0a 6465 6620 6176 6169  args)...def avai
+000070d0: 6c61 626c 655f 7068 7973 6963 616c 5f6d  lable_physical_m
+000070e0: 656d 6f72 795f 696e 5f62 7974 6573 2829  emory_in_bytes()
+000070f0: 3a0a 2020 2020 2222 220a 2020 2020 3a72  :.    """.    :r
+00007100: 7479 7065 3a20 696e 740a 2020 2020 2222  type: int.    ""
+00007110: 220a 2020 2020 2320 6e6f 696e 7370 6563  ".    # noinspec
+00007120: 7469 6f6e 2050 7942 726f 6164 4578 6365  tion PyBroadExce
+00007130: 7074 696f 6e0a 2020 2020 7472 793a 0a20  ption.    try:. 
+00007140: 2020 2020 2020 206d 656d 5f62 7974 6573         mem_bytes
+00007150: 203d 206f 732e 7379 7363 6f6e 6628 2253   = os.sysconf("S
+00007160: 435f 5041 4745 5f53 495a 4522 2920 2a20  C_PAGE_SIZE") * 
+00007170: 6f73 2e73 7973 636f 6e66 2822 5343 5f50  os.sysconf("SC_P
+00007180: 4859 535f 5041 4745 5322 290a 2020 2020  HYS_PAGES").    
+00007190: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+000071a0: 3a0a 2020 2020 2020 2020 6d65 6d5f 6279  :.        mem_by
+000071b0: 7465 7320 3d20 3130 3234 2a2a 3420 2023  tes = 1024**4  #
+000071c0: 206a 7573 7420 736f 6d65 2072 616e 646f   just some rando
+000071d0: 6d20 6e75 6d62 6572 2c20 3154 420a 2020  m number, 1TB.  
+000071e0: 2020 7265 7475 726e 206d 656d 5f62 7974    return mem_byt
+000071f0: 6573 0a0a 0a64 6566 2064 6566 6175 6c74  es...def default
+00007200: 5f63 6163 6865 5f73 697a 655f 696e 5f67  _cache_size_in_g
+00007210: 6279 7465 7328 6661 6374 6f72 3d30 2e37  bytes(factor=0.7
+00007220: 293a 0a20 2020 2022 2222 0a20 2020 203a  ):.    """.    :
+00007230: 7061 7261 6d20 666c 6f61 747c 696e 7420  param float|int 
+00007240: 6661 6374 6f72 3a0a 2020 2020 3a72 7479  factor:.    :rty
+00007250: 7065 3a20 696e 740a 2020 2020 2222 220a  pe: int.    """.
+00007260: 2020 2020 6d65 6d5f 6762 7974 6573 203d      mem_gbytes =
+00007270: 2061 7661 696c 6162 6c65 5f70 6879 7369   available_physi
+00007280: 6361 6c5f 6d65 6d6f 7279 5f69 6e5f 6279  cal_memory_in_by
+00007290: 7465 7328 2920 2f20 2831 3032 342e 302a  tes() / (1024.0*
+000072a0: 2a33 290a 2020 2020 7265 7475 726e 2069  *3).    return i
+000072b0: 6e74 286d 656d 5f67 6279 7465 7320 2a20  nt(mem_gbytes * 
+000072c0: 6661 6374 6f72 290a 0a0a 6465 6620 6265  factor)...def be
+000072d0: 7474 6572 5f72 6570 7228 6f29 3a0a 2020  tter_repr(o):.  
+000072e0: 2020 2222 220a 2020 2020 5468 6520 6d61    """.    The ma
+000072f0: 696e 2064 6966 6665 7265 6e63 6520 746f  in difference to
+00007300: 203a 6675 6e63 3a60 7265 7072 603a 2074   :func:`repr`: t
+00007310: 6869 7320 6f6e 6520 6973 2064 6574 6572  his one is deter
+00007320: 6d69 6e69 7374 6963 2e0a 2020 2020 5468  ministic..    Th
+00007330: 6520 6f72 6967 2064 6963 742e 5f5f 7265  e orig dict.__re
+00007340: 7072 5f5f 2068 6173 2074 6865 206f 7264  pr__ has the ord
+00007350: 6572 2075 6e64 6566 696e 6564 2066 6f72  er undefined for
+00007360: 2064 6963 7420 6f72 2073 6574 2e0a 2020   dict or set..  
+00007370: 2020 466f 7220 6269 6720 6469 6374 732f    For big dicts/
+00007380: 7365 7473 2f6c 6973 7473 2c20 6164 6420  sets/lists, add 
+00007390: 222c 2220 6174 2074 6865 2065 6e64 2074  "," at the end t
+000073a0: 6f20 6d61 6b65 2074 6578 7475 616c 2064  o make textual d
+000073b0: 6966 6673 206e 6963 6572 2e0a 0a20 2020  iffs nicer...   
+000073c0: 203a 7061 7261 6d20 6f62 6a65 6374 206f   :param object o
+000073d0: 3a0a 2020 2020 3a72 7479 7065 3a20 7374  :.    :rtype: st
+000073e0: 720a 2020 2020 2222 220a 2020 2020 6966  r.    """.    if
+000073f0: 2069 7369 6e73 7461 6e63 6528 6f2c 206c   isinstance(o, l
+00007400: 6973 7429 3a0a 2020 2020 2020 2020 7265  ist):.        re
+00007410: 7475 726e 2022 5b5c 6e25 735d 2220 2520  turn "[\n%s]" % 
+00007420: 2222 2e6a 6f69 6e28 6d61 7028 6c61 6d62  "".join(map(lamb
+00007430: 6461 2076 3a20 6265 7474 6572 5f72 6570  da v: better_rep
+00007440: 7228 7629 202b 2022 2c5c 6e22 2c20 6f29  r(v) + ",\n", o)
+00007450: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
+00007460: 6e63 6528 6f2c 2064 6571 7565 293a 0a20  nce(o, deque):. 
+00007470: 2020 2020 2020 2072 6574 7572 6e20 2264         return "d
+00007480: 6571 7565 285b 5c6e 2573 5d29 2220 2520  eque([\n%s])" % 
+00007490: 2222 2e6a 6f69 6e28 6d61 7028 6c61 6d62  "".join(map(lamb
+000074a0: 6461 2076 3a20 6265 7474 6572 5f72 6570  da v: better_rep
+000074b0: 7228 7629 202b 2022 2c5c 6e22 2c20 6f29  r(v) + ",\n", o)
+000074c0: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
+000074d0: 6e63 6528 6f2c 2074 7570 6c65 293a 0a20  nce(o, tuple):. 
+000074e0: 2020 2020 2020 2069 6620 6c65 6e28 6f29         if len(o)
+000074f0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+00007500: 2020 2072 6574 7572 6e20 2228 2573 2c29     return "(%s,)
+00007510: 2220 2520 6f5b 305d 0a20 2020 2020 2020  " % o[0].       
+00007520: 2072 6574 7572 6e20 2228 2573 2922 2025   return "(%s)" %
+00007530: 2022 2c20 222e 6a6f 696e 286d 6170 2862   ", ".join(map(b
+00007540: 6574 7465 725f 7265 7072 2c20 6f29 290a  etter_repr, o)).
+00007550: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00007560: 6528 6f2c 2064 6963 7429 3a0a 2020 2020  e(o, dict):.    
+00007570: 2020 2020 6c73 203d 205b 6265 7474 6572      ls = [better
+00007580: 5f72 6570 7228 6b29 202b 2022 3a20 2220  _repr(k) + ": " 
+00007590: 2b20 6265 7474 6572 5f72 6570 7228 7629  + better_repr(v)
+000075a0: 2066 6f72 2028 6b2c 2076 2920 696e 2073   for (k, v) in s
+000075b0: 6f72 7465 6428 6f2e 6974 656d 7328 2929  orted(o.items())
+000075c0: 5d0a 2020 2020 2020 2020 6966 2073 756d  ].        if sum
+000075d0: 285b 6c65 6e28 7629 2066 6f72 2076 2069  ([len(v) for v i
+000075e0: 6e20 6c73 5d29 203e 3d20 3430 3a0a 2020  n ls]) >= 40:.  
+000075f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00007600: 2022 7b5c 6e25 737d 2220 2520 2222 2e6a   "{\n%s}" % "".j
+00007610: 6f69 6e28 5b76 202b 2022 2c5c 6e22 2066  oin([v + ",\n" f
+00007620: 6f72 2076 2069 6e20 6c73 5d29 0a20 2020  or v in ls]).   
+00007630: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007640: 2020 2020 2020 2072 6574 7572 6e20 227b         return "{
+00007650: 2573 7d22 2025 2022 2c20 222e 6a6f 696e  %s}" % ", ".join
+00007660: 286c 7329 0a20 2020 2069 6620 6973 696e  (ls).    if isin
+00007670: 7374 616e 6365 286f 2c20 7365 7429 3a0a  stance(o, set):.
+00007680: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+00007690: 7365 7428 5b5c 6e25 735d 2922 2025 2022  set([\n%s])" % "
+000076a0: 222e 6a6f 696e 286d 6170 286c 616d 6264  ".join(map(lambd
+000076b0: 6120 763a 2062 6574 7465 725f 7265 7072  a v: better_repr
+000076c0: 2876 2920 2b20 222c 5c6e 222c 206f 2929  (v) + ",\n", o))
+000076d0: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
+000076e0: 6365 286f 2c20 666c 6f61 7429 2061 6e64  ce(o, float) and
+000076f0: 2028 6d61 7468 2e69 736e 616e 286f 2920   (math.isnan(o) 
+00007700: 6f72 206d 6174 682e 6973 696e 6628 6f29  or math.isinf(o)
+00007710: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00007720: 6e20 2266 6c6f 6174 2827 2573 2729 2220  n "float('%s')" 
+00007730: 2520 7265 7072 286f 290a 2020 2020 2320  % repr(o).    # 
+00007740: 6661 6c6c 6261 636b 0a20 2020 2072 6574  fallback.    ret
+00007750: 7572 6e20 7265 7072 286f 290a 0a0a 6465  urn repr(o)...de
+00007760: 6620 7369 6d70 6c65 5f6f 626a 5f72 6570  f simple_obj_rep
+00007770: 7228 6f62 6a29 3a0a 2020 2020 2222 220a  r(obj):.    """.
+00007780: 2020 2020 3a72 6574 7572 6e3a 2041 6c6c      :return: All
+00007790: 2073 656c 662e 5f5f 696e 6974 5f5f 2061   self.__init__ a
+000077a0: 7267 732e 0a20 2020 203a 7274 7970 653a  rgs..    :rtype:
+000077b0: 2073 7472 0a20 2020 2022 2222 0a20 2020   str.    """.   
+000077c0: 2072 6574 7572 6e20 6f62 6a2e 5f5f 636c   return obj.__cl
+000077d0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 202b  ass__.__name__ +
+000077e0: 2022 2825 7329 2220 2520 222c 2022 2e6a   "(%s)" % ", ".j
+000077f0: 6f69 6e28 0a20 2020 2020 2020 205b 2225  oin(.        ["%
+00007800: 733d 2573 2220 2520 2861 7267 2c20 6265  s=%s" % (arg, be
+00007810: 7474 6572 5f72 6570 7228 6765 7461 7474  tter_repr(getatt
+00007820: 7228 6f62 6a2c 2061 7267 2929 2920 666f  r(obj, arg))) fo
+00007830: 7220 6172 6720 696e 2067 6574 6172 6773  r arg in getargs
+00007840: 7065 6328 6f62 6a2e 5f5f 696e 6974 5f5f  pec(obj.__init__
+00007850: 292e 6172 6773 5b31 3a5d 5d0a 2020 2020  ).args[1:]].    
+00007860: 290a 0a0a 636c 6173 7320 4f62 6a41 7344  )...class ObjAsD
+00007870: 6963 7428 7479 7069 6e67 2e4d 6170 7069  ict(typing.Mappi
+00007880: 6e67 5b73 7472 2c20 6f62 6a65 6374 5d29  ng[str, object])
+00007890: 3a0a 2020 2020 2222 220a 2020 2020 5772  :.    """.    Wr
+000078a0: 6170 7320 7570 2061 6e79 206f 626a 6563  aps up any objec
+000078b0: 7420 6173 2061 2064 6963 742c 2077 6865  t as a dict, whe
+000078c0: 7265 2074 6865 2061 7474 7269 6275 7465  re the attribute
+000078d0: 7320 6265 636f 6d65 7320 7468 6520 6b65  s becomes the ke
+000078e0: 7973 2e0a 2020 2020 5365 6520 616c 736f  ys..    See also
+000078f0: 203a 636c 6173 733a 6044 6963 7441 734f   :class:`DictAsO
+00007900: 626a 602e 0a20 2020 2022 2222 0a0a 2020  bj`..    """..  
+00007910: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00007920: 656c 662c 206f 626a 293a 0a20 2020 2020  elf, obj):.     
+00007930: 2020 2073 656c 662e 5f5f 6f62 6a20 3d20     self.__obj = 
+00007940: 6f62 6a0a 0a20 2020 2064 6566 205f 5f67  obj..    def __g
+00007950: 6574 6974 656d 5f5f 2873 656c 662c 2069  etitem__(self, i
+00007960: 7465 6d29 3a0a 2020 2020 2020 2020 6966  tem):.        if
+00007970: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00007980: 6974 656d 2c20 2873 7472 2c20 756e 6963  item, (str, unic
+00007990: 6f64 6529 293a 0a20 2020 2020 2020 2020  ode)):.         
+000079a0: 2020 2072 6169 7365 204b 6579 4572 726f     raise KeyErro
+000079b0: 7228 6974 656d 290a 2020 2020 2020 2020  r(item).        
+000079c0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000079d0: 2072 6574 7572 6e20 6765 7461 7474 7228   return getattr(
+000079e0: 7365 6c66 2e5f 5f6f 626a 2c20 6974 656d  self.__obj, item
+000079f0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00007a00: 2041 7474 7269 6275 7465 4572 726f 7220   AttributeError 
+00007a10: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00007a20: 2020 7261 6973 6520 4b65 7945 7272 6f72    raise KeyError
+00007a30: 2865 290a 0a20 2020 2064 6566 205f 5f6c  (e)..    def __l
+00007a40: 656e 5f5f 2873 656c 6629 3a0a 2020 2020  en__(self):.    
+00007a50: 2020 2020 7265 7475 726e 206c 656e 2876      return len(v
+00007a60: 6172 7328 7365 6c66 2e5f 5f6f 626a 2929  ars(self.__obj))
+00007a70: 0a0a 2020 2020 6465 6620 5f5f 6974 6572  ..    def __iter
+00007a80: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00007a90: 2020 7265 7475 726e 2069 7465 7228 7661    return iter(va
+00007aa0: 7273 2873 656c 662e 5f5f 6f62 6a29 290a  rs(self.__obj)).
+00007ab0: 0a20 2020 2064 6566 2069 7465 6d73 2873  .    def items(s
+00007ac0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+00007ad0: 220a 2020 2020 2020 2020 3a72 6574 7572  ".        :retur
+00007ae0: 6e3a 2076 6172 7328 2e2e 292e 6974 656d  n: vars(..).item
+00007af0: 7328 290a 2020 2020 2020 2020 3a72 7479  s().        :rty
+00007b00: 7065 3a20 7365 745b 2873 7472 2c6f 626a  pe: set[(str,obj
+00007b10: 6563 7429 5d0a 2020 2020 2020 2020 2222  ect)].        ""
+00007b20: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00007b30: 2076 6172 7328 7365 6c66 2e5f 5f6f 626a   vars(self.__obj
+00007b40: 292e 6974 656d 7328 290a 0a0a 636c 6173  ).items()...clas
+00007b50: 7320 4469 6374 4173 4f62 6a3a 0a20 2020  s DictAsObj:.   
+00007b60: 2022 2222 0a20 2020 2057 7261 7073 2075   """.    Wraps u
+00007b70: 7020 616e 7920 6469 6374 696f 6e61 7279  p any dictionary
+00007b80: 2061 7320 616e 206f 626a 6563 742c 2077   as an object, w
+00007b90: 6865 7265 2074 6865 206b 6579 7320 6265  here the keys be
+00007ba0: 636f 6d65 7320 7468 6520 6174 7472 6962  comes the attrib
+00007bb0: 7574 6573 2e0a 2020 2020 5365 6520 616c  utes..    See al
+00007bc0: 736f 203a 636c 6173 733a 604f 626a 4173  so :class:`ObjAs
+00007bd0: 4469 6374 602e 0a20 2020 2022 2222 0a0a  Dict`..    """..
+00007be0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00007bf0: 2873 656c 662c 2064 696b 743a 2044 6963  (self, dikt: Dic
+00007c00: 745b 7374 722c 2041 6e79 5d29 3a0a 2020  t[str, Any]):.  
+00007c10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00007c20: 2020 3a70 6172 616d 2064 696b 743a 0a20    :param dikt:. 
+00007c30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00007c40: 2020 2073 656c 662e 5f5f 6469 6374 5f5f     self.__dict__
+00007c50: 203d 2064 696b 740a 0a0a 6465 6620 6469   = dikt...def di
+00007c60: 6374 5f6a 6f69 6e65 6428 2a64 7329 3a0a  ct_joined(*ds):.
+00007c70: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
+00007c80: 616d 2064 6963 745b 542c 565d 2064 733a  am dict[T,V] ds:
+00007c90: 0a20 2020 203a 7265 7475 726e 3a20 616c  .    :return: al
+00007ca0: 6c20 6469 6374 7320 6a6f 696e 6564 2074  l dicts joined t
+00007cb0: 6f67 6574 6865 720a 2020 2020 3a72 7479  ogether.    :rty
+00007cc0: 7065 3a20 6469 6374 5b54 2c56 5d0a 2020  pe: dict[T,V].  
+00007cd0: 2020 2222 220a 2020 2020 7265 7320 3d20    """.    res = 
+00007ce0: 7b7d 0a20 2020 2066 6f72 2064 2069 6e20  {}.    for d in 
+00007cf0: 6473 3a0a 2020 2020 2020 2020 7265 732e  ds:.        res.
+00007d00: 7570 6461 7465 2864 290a 2020 2020 7265  update(d).    re
+00007d10: 7475 726e 2072 6573 0a0a 0a64 6566 206f  turn res...def o
+00007d20: 626a 5f64 6966 665f 7374 7228 7365 6c66  bj_diff_str(self
+00007d30: 2c20 6f74 6865 722c 202a 2a6b 7761 7267  , other, **kwarg
+00007d40: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
+00007d50: 3a70 6172 616d 206f 626a 6563 7420 7365  :param object se
+00007d60: 6c66 3a0a 2020 2020 3a70 6172 616d 206f  lf:.    :param o
+00007d70: 626a 6563 7420 6f74 6865 723a 0a20 2020  bject other:.   
+00007d80: 203a 7265 7475 726e 3a20 7468 6520 6469   :return: the di
+00007d90: 6666 6572 656e 6365 2064 6573 6372 6962  fference describ
+00007da0: 6564 0a20 2020 203a 7274 7970 653a 2073  ed.    :rtype: s
+00007db0: 7472 0a20 2020 2022 2222 0a20 2020 2064  tr.    """.    d
+00007dc0: 6966 665f 6c69 7374 203d 206f 626a 5f64  iff_list = obj_d
+00007dd0: 6966 665f 6c69 7374 2873 656c 662c 206f  iff_list(self, o
+00007de0: 7468 6572 2c20 2a2a 6b77 6172 6773 290a  ther, **kwargs).
+00007df0: 2020 2020 6966 206e 6f74 2064 6966 665f      if not diff_
+00007e00: 6c69 7374 3a0a 2020 2020 2020 2020 7265  list:.        re
+00007e10: 7475 726e 2022 4e6f 2064 6966 662e 220a  turn "No diff.".
+00007e20: 2020 2020 7265 7475 726e 2022 5c6e 222e      return "\n".
+00007e30: 6a6f 696e 2864 6966 665f 6c69 7374 290a  join(diff_list).
+00007e40: 0a0a 6465 6620 6f62 6a5f 6469 6666 5f6c  ..def obj_diff_l
+00007e50: 6973 7428 7365 6c66 2c20 6f74 6865 722c  ist(self, other,
+00007e60: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00007e70: 2222 220a 2020 2020 4e6f 7465 2074 6861  """.    Note tha
+00007e80: 7420 7765 2072 6563 7572 7365 2074 6f20  t we recurse to 
+00007e90: 6120 6365 7274 6169 6e20 6465 6772 6565  a certain degree
+00007ea0: 2074 6f20 7468 6520 6974 656d 732c 2062   to the items, b
+00007eb0: 7574 206e 6f74 2066 756c 6c79 2e0a 2020  ut not fully..  
+00007ec0: 2020 536f 6d65 2064 6966 6665 7265 6e63    Some differenc
+00007ed0: 6573 206d 6967 6874 206a 7573 7420 6265  es might just be
+00007ee0: 2073 756d 6d61 7269 7a65 642e 0a0a 2020   summarized...  
+00007ef0: 2020 3a70 6172 616d 206f 626a 6563 7420    :param object 
+00007f00: 7365 6c66 3a0a 2020 2020 3a70 6172 616d  self:.    :param
+00007f10: 206f 626a 6563 7420 6f74 6865 723a 0a20   object other:. 
+00007f20: 2020 203a 7265 7475 726e 3a20 7468 6520     :return: the 
+00007f30: 6469 6666 6572 656e 6365 2064 6573 6372  difference descr
+00007f40: 6962 6564 0a20 2020 203a 7274 7970 653a  ibed.    :rtype:
+00007f50: 206c 6973 745b 7374 725d 0a20 2020 2022   list[str].    "
+00007f60: 2222 0a20 2020 2023 2048 6176 696e 6720  "".    # Having 
+00007f70: 7468 656d 2065 7870 6c69 6369 746c 7920  them explicitly 
+00007f80: 696e 206b 7761 7267 7320 6265 6361 7573  in kwargs becaus
+00007f90: 6520 7765 2063 616e 6e6f 7420 7573 6520  e we cannot use 
+00007fa0: 602a 6020 696e 2050 7974 686f 6e20 322c  `*` in Python 2,
+00007fb0: 0a20 2020 2023 2062 7574 2077 6520 646f  .    # but we do
+00007fc0: 206e 6f74 2077 616e 7420 746f 2061 6c6c   not want to all
+00007fd0: 6f77 2074 6865 6d20 6173 2070 6f73 6974  ow them as posit
+00007fe0: 696f 6e61 6c20 6172 6773 2e0a 2020 2020  ional args..    
+00007ff0: 7072 6566 6978 203d 206b 7761 7267 732e  prefix = kwargs.
+00008000: 706f 7028 225f 7072 6566 6978 222c 2022  pop("_prefix", "
+00008010: 2229 0a20 2020 2023 2049 6620 616c 6c6f  ").    # If allo
+00008020: 7765 645f 6d61 7070 696e 6728 7365 6c66  wed_mapping(self
+00008030: 2c20 6f74 6865 7229 2c0a 2020 2020 2320  , other),.    # 
+00008040: 7468 6579 2061 7265 2061 7373 6967 6e65  they are assigne
+00008050: 6420 746f 2074 6865 2065 7175 616c 5f6d  d to the equal_m
+00008060: 6170 7069 6e67 2c20 6966 2070 6f73 7369  apping, if possi
+00008070: 626c 6520 746f 2064 6f20 736f 2075 6e61  ble to do so una
+00008080: 6d62 6967 756f 7573 6c79 2e0a 2020 2020  mbiguously..    
+00008090: 616c 6c6f 7765 645f 6d61 7070 696e 6720  allowed_mapping 
+000080a0: 3d20 6b77 6172 6773 2e70 6f70 2822 616c  = kwargs.pop("al
+000080b0: 6c6f 7765 645f 6d61 7070 696e 6722 2c20  lowed_mapping", 
+000080c0: 4e6f 6e65 290a 2020 2020 6571 7561 6c5f  None).    equal_
+000080d0: 6d61 705f 7332 6f20 3d20 6b77 6172 6773  map_s2o = kwargs
+000080e0: 2e70 6f70 2822 5f65 7175 616c 5f6d 6170  .pop("_equal_map
+000080f0: 5f73 326f 222c 204e 6f6e 6529 2020 2320  _s2o", None)  # 
+00008100: 7365 6c66 202d 3e20 6f74 6865 720a 2020  self -> other.  
+00008110: 2020 6571 7561 6c5f 6d61 705f 6f32 7320    equal_map_o2s 
+00008120: 3d20 6b77 6172 6773 2e70 6f70 2822 5f65  = kwargs.pop("_e
+00008130: 7175 616c 5f6d 6170 5f6f 3273 222c 204e  qual_map_o2s", N
+00008140: 6f6e 6529 2020 2320 6f74 6865 7220 2d3e  one)  # other ->
+00008150: 2073 656c 660a 2020 2020 6571 7561 6c5f   self.    equal_
+00008160: 6d61 705f 6669 6e69 7368 6564 203d 206b  map_finished = k
+00008170: 7761 7267 732e 706f 7028 225f 6571 7561  wargs.pop("_equa
+00008180: 6c5f 6d61 705f 6669 6e69 7368 6564 222c  l_map_finished",
+00008190: 2046 616c 7365 290a 2020 2020 6966 206b   False).    if k
+000081a0: 7761 7267 733a 0a20 2020 2020 2020 2072  wargs:.        r
+000081b0: 6169 7365 2054 7970 6545 7272 6f72 2822  aise TypeError("
+000081c0: 6f62 6a5f 6469 6666 5f6c 6973 743a 2069  obj_diff_list: i
+000081d0: 6e76 616c 6964 206b 7761 7267 7320 2572  nvalid kwargs %r
+000081e0: 2220 2520 6b77 6172 6773 290a 0a20 2020  " % kwargs)..   
+000081f0: 2069 6620 7365 6c66 2069 7320 4e6f 6e65   if self is None
+00008200: 2061 6e64 206f 7468 6572 2069 7320 4e6f   and other is No
+00008210: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
+00008220: 726e 205b 5d0a 2020 2020 6966 2073 656c  rn [].    if sel
+00008230: 6620 6973 204e 6f6e 6520 616e 6420 6f74  f is None and ot
+00008240: 6865 7220 6973 206e 6f74 204e 6f6e 653a  her is not None:
+00008250: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00008260: 5b22 2573 7365 6c66 2069 7320 4e6f 6e65  ["%sself is None
+00008270: 2061 6e64 206f 7468 6572 2069 7320 2572   and other is %r
+00008280: 2220 2520 2870 7265 6669 782c 206f 7468  " % (prefix, oth
+00008290: 6572 295d 0a20 2020 2069 6620 7365 6c66  er)].    if self
+000082a0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000082b0: 206f 7468 6572 2069 7320 4e6f 6e65 3a0a   other is None:.
+000082c0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+000082d0: 2225 736f 7468 6572 2069 7320 4e6f 6e65  "%sother is None
+000082e0: 2061 6e64 2073 656c 6620 6973 2025 7222   and self is %r"
+000082f0: 2025 2028 7072 6566 6978 2c20 7365 6c66   % (prefix, self
+00008300: 295d 0a20 2020 2069 6620 7479 7065 2873  )].    if type(s
+00008310: 656c 6629 2021 3d20 7479 7065 286f 7468  elf) != type(oth
+00008320: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
+00008330: 7572 6e20 5b22 2573 7479 7065 2064 6966  urn ["%stype dif
+00008340: 663a 2073 656c 6620 6973 2025 7320 6275  f: self is %s bu
+00008350: 7420 6f74 6865 7220 6973 2025 7322 2025  t other is %s" %
+00008360: 2028 7072 6566 6978 2c20 7479 7065 2873   (prefix, type(s
+00008370: 656c 6629 2e5f 5f6e 616d 655f 5f2c 2074  elf).__name__, t
+00008380: 7970 6528 6f74 6865 7229 2e5f 5f6e 616d  ype(other).__nam
+00008390: 655f 5f29 5d0a 0a20 2020 2069 6620 616c  e__)]..    if al
+000083a0: 6c6f 7765 645f 6d61 7070 696e 673a 0a20  lowed_mapping:. 
+000083b0: 2020 2020 2020 2069 6620 6571 7561 6c5f         if equal_
+000083c0: 6d61 705f 7332 6f20 6973 204e 6f6e 653a  map_s2o is None:
+000083d0: 0a20 2020 2020 2020 2020 2020 2023 2042  .            # B
+000083e0: 7569 6c64 2075 7020 7468 6520 756e 6571  uild up the uneq
+000083f0: 7561 6c5f 6d61 702c 2062 7920 676f 696e  ual_map, by goin
+00008400: 6720 7468 726f 7567 6820 7468 6520 6f62  g through the ob
+00008410: 6a65 6374 732e 0a20 2020 2020 2020 2020  jects..         
+00008420: 2020 2065 7175 616c 5f6d 6170 5f73 326f     equal_map_s2o
+00008430: 2c20 6571 7561 6c5f 6d61 705f 6f32 7320  , equal_map_o2s 
+00008440: 3d20 7b7d 2c20 7b7d 0a20 2020 2020 2020  = {}, {}.       
+00008450: 2020 2020 206f 626a 5f64 6966 665f 6c69       obj_diff_li
+00008460: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00008470: 2020 2020 7365 6c66 2c20 6f74 6865 722c      self, other,
+00008480: 2061 6c6c 6f77 6564 5f6d 6170 7069 6e67   allowed_mapping
+00008490: 3d61 6c6c 6f77 6564 5f6d 6170 7069 6e67  =allowed_mapping
+000084a0: 2c20 5f65 7175 616c 5f6d 6170 5f73 326f  , _equal_map_s2o
+000084b0: 3d65 7175 616c 5f6d 6170 5f73 326f 2c20  =equal_map_s2o, 
+000084c0: 5f65 7175 616c 5f6d 6170 5f6f 3273 3d65  _equal_map_o2s=e
+000084d0: 7175 616c 5f6d 6170 5f6f 3273 0a20 2020  qual_map_o2s.   
+000084e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000084f0: 2020 2020 2020 2065 7175 616c 5f6d 6170         equal_map
+00008500: 5f66 696e 6973 6865 6420 3d20 5472 7565  _finished = True
+00008510: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00008520: 2020 2065 7175 616c 5f6d 6170 5f66 696e     equal_map_fin
+00008530: 6973 6865 6420 3d20 5472 7565 0a20 2020  ished = True.   
+00008540: 2069 6620 6571 7561 6c5f 6d61 705f 7332   if equal_map_s2
+00008550: 6f20 6973 204e 6f6e 6520 6f72 2065 7175  o is None or equ
+00008560: 616c 5f6d 6170 5f6f 3273 2069 7320 4e6f  al_map_o2s is No
+00008570: 6e65 3a0a 2020 2020 2020 2020 6571 7561  ne:.        equa
+00008580: 6c5f 6d61 705f 7332 6f2c 2065 7175 616c  l_map_s2o, equal
+00008590: 5f6d 6170 5f6f 3273 203d 207b 7d2c 207b  _map_o2s = {}, {
+000085a0: 7d20 2023 2073 696d 706c 6966 6965 7320  }  # simplifies 
+000085b0: 7468 6520 636f 6465 2062 656c 6f77 0a0a  the code below..
+000085c0: 2020 2020 7375 625f 6b77 6172 6773 203d      sub_kwargs =
+000085d0: 2064 6963 7428 0a20 2020 2020 2020 2061   dict(.        a
+000085e0: 6c6c 6f77 6564 5f6d 6170 7069 6e67 3d61  llowed_mapping=a
+000085f0: 6c6c 6f77 6564 5f6d 6170 7069 6e67 2c0a  llowed_mapping,.
+00008600: 2020 2020 2020 2020 5f65 7175 616c 5f6d          _equal_m
+00008610: 6170 5f73 326f 3d65 7175 616c 5f6d 6170  ap_s2o=equal_map
+00008620: 5f73 326f 2c0a 2020 2020 2020 2020 5f65  _s2o,.        _e
+00008630: 7175 616c 5f6d 6170 5f6f 3273 3d65 7175  qual_map_o2s=equ
+00008640: 616c 5f6d 6170 5f6f 3273 2c0a 2020 2020  al_map_o2s,.    
+00008650: 2020 2020 5f65 7175 616c 5f6d 6170 5f66      _equal_map_f
+00008660: 696e 6973 6865 643d 6571 7561 6c5f 6d61  inished=equal_ma
+00008670: 705f 6669 6e69 7368 6564 2c0a 2020 2020  p_finished,.    
+00008680: 290a 0a20 2020 2069 6620 6973 696e 7374  )..    if isinst
+00008690: 616e 6365 2873 656c 662c 2028 6c69 7374  ance(self, (list
+000086a0: 2c20 7475 706c 6529 293a 0a20 2020 2020  , tuple)):.     
+000086b0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+000086c0: 616e 6365 286f 7468 6572 2c20 286c 6973  ance(other, (lis
+000086d0: 742c 2074 7570 6c65 2929 0a20 2020 2020  t, tuple)).     
+000086e0: 2020 2069 6620 6c65 6e28 7365 6c66 2920     if len(self) 
+000086f0: 213d 206c 656e 286f 7468 6572 293a 0a20  != len(other):. 
+00008700: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00008710: 6e20 5b22 2573 6c69 7374 2064 6966 6620  n ["%slist diff 
+00008720: 6c65 6e3a 206c 656e 2073 656c 663a 2025  len: len self: %
+00008730: 692c 206c 656e 206f 7468 6572 3a20 2569  i, len other: %i
+00008740: 2220 2520 2870 7265 6669 782c 206c 656e  " % (prefix, len
+00008750: 2873 656c 6629 2c20 6c65 6e28 6f74 6865  (self), len(othe
+00008760: 7229 295d 0a20 2020 2020 2020 2073 203d  r))].        s =
+00008770: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+00008780: 692c 2028 612c 2062 2920 696e 2065 6e75  i, (a, b) in enu
+00008790: 6d65 7261 7465 287a 6970 2873 656c 662c  merate(zip(self,
+000087a0: 206f 7468 6572 2929 3a0a 2020 2020 2020   other)):.      
+000087b0: 2020 2020 2020 7320 2b3d 206f 626a 5f64        s += obj_d
+000087c0: 6966 665f 6c69 7374 2861 2c20 622c 205f  iff_list(a, b, _
+000087d0: 7072 6566 6978 3d22 2573 5b25 695d 2022  prefix="%s[%i] "
+000087e0: 2025 2028 7072 6566 6978 2c20 6929 2c20   % (prefix, i), 
+000087f0: 2a2a 7375 625f 6b77 6172 6773 290a 2020  **sub_kwargs).  
+00008800: 2020 2020 2020 6966 2073 3a0a 2020 2020        if s:.    
+00008810: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+00008820: 2225 736c 6973 7420 6469 6666 3a22 2025  "%slist diff:" %
+00008830: 2070 7265 6669 785d 202b 2073 0a20 2020   prefix] + s.   
+00008840: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
+00008850: 2020 2020 6465 6620 5f73 6574 5f64 6966      def _set_dif
+00008860: 6628 615f 2c20 625f 293a 0a20 2020 2020  f(a_, b_):.     
+00008870: 2020 2023 2061 7373 756d 6520 7468 6520     # assume the 
+00008880: 7661 6c75 6573 2063 616e 2062 6520 736f  values can be so
+00008890: 7274 6564 0a20 2020 2020 2020 2061 5f20  rted.        a_ 
+000088a0: 3d20 736f 7274 6564 2861 5f29 0a20 2020  = sorted(a_).   
+000088b0: 2020 2020 2062 5f20 3d20 736f 7274 6564       b_ = sorted
+000088c0: 2862 5f29 0a20 2020 2020 2020 2073 656c  (b_).        sel
+000088d0: 665f 6469 6666 5f20 3d20 5b5d 0a20 2020  f_diff_ = [].   
+000088e0: 2020 2020 2073 616d 655f 203d 205b 5d0a       same_ = [].
+000088f0: 2020 2020 2020 2020 666f 7220 7620 696e          for v in
+00008900: 2061 5f3a 0a20 2020 2020 2020 2020 2020   a_:.           
+00008910: 2076 5f20 3d20 6571 7561 6c5f 6d61 705f   v_ = equal_map_
+00008920: 7332 6f2e 6765 7428 762c 2076 290a 2020  s2o.get(v, v).  
+00008930: 2020 2020 2020 2020 2020 6966 2076 5f20            if v_ 
+00008940: 696e 2062 5f3a 0a20 2020 2020 2020 2020  in b_:.         
+00008950: 2020 2020 2020 2073 616d 655f 2e61 7070         same_.app
+00008960: 656e 6428 7629 0a20 2020 2020 2020 2020  end(v).         
+00008970: 2020 2020 2020 2062 5f2e 7265 6d6f 7665         b_.remove
+00008980: 2876 5f29 0a20 2020 2020 2020 2020 2020  (v_).           
+00008990: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000089a0: 2020 2020 2020 2073 656c 665f 6469 6666         self_diff
+000089b0: 5f2e 6170 7065 6e64 2876 290a 2020 2020  _.append(v).    
+000089c0: 2020 2020 6f74 6865 725f 6469 6666 5f20      other_diff_ 
+000089d0: 3d20 625f 0a20 2020 2020 2020 2072 6574  = b_.        ret
+000089e0: 7572 6e20 7365 6c66 5f64 6966 665f 2c20  urn self_diff_, 
+000089f0: 7361 6d65 5f2c 206f 7468 6572 5f64 6966  same_, other_dif
+00008a00: 665f 0a0a 2020 2020 6966 2069 7369 6e73  f_..    if isins
+00008a10: 7461 6e63 6528 7365 6c66 2c20 7365 7429  tance(self, set)
+00008a20: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00008a30: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
+00008a40: 722c 2073 6574 290a 2020 2020 2020 2020  r, set).        
+00008a50: 7365 6c66 5f64 6966 662c 205f 2c20 6f74  self_diff, _, ot
+00008a60: 6865 725f 6469 6666 203d 205f 7365 745f  her_diff = _set_
+00008a70: 6469 6666 2873 656c 662c 206f 7468 6572  diff(self, other
+00008a80: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
+00008a90: 2873 656c 665f 6469 6666 2920 3d3d 206c  (self_diff) == l
+00008aa0: 656e 286f 7468 6572 5f64 6966 6629 203d  en(other_diff) =
+00008ab0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00008ac0: 2023 2070 6f74 656e 7469 616c 6c79 2075   # potentially u
+00008ad0: 7064 6174 6520 6571 7561 6c5f 6d61 700a  pdate equal_map.
+00008ae0: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
+00008af0: 6f62 6a5f 6469 6666 5f6c 6973 7428 6c69  obj_diff_list(li
+00008b00: 7374 2873 656c 665f 6469 6666 295b 305d  st(self_diff)[0]
+00008b10: 2c20 6c69 7374 286f 7468 6572 5f64 6966  , list(other_dif
+00008b20: 6629 5b30 5d2c 202a 2a73 7562 5f6b 7761  f)[0], **sub_kwa
+00008b30: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+00008b40: 2023 2069 676e 6f72 6520 7468 6520 706f   # ignore the po
+00008b50: 7465 6e74 6961 6c20 7570 6461 7465 6420  tential updated 
+00008b60: 6571 7561 6c5f 6d61 7020 6e6f 7720 666f  equal_map now fo
+00008b70: 7220 7369 6d70 6c69 6369 7479 2e20 7765  r simplicity. we
+00008b80: 2077 696c 6c20 616e 7977 6179 2064 6f20   will anyway do 
+00008b90: 6120 7365 636f 6e64 2070 6173 7320 6c61  a second pass la
+00008ba0: 7465 722e 0a20 2020 2020 2020 2020 2020  ter..           
+00008bb0: 2069 6620 6c65 6e28 7329 203d 3d20 313a   if len(s) == 1:
+00008bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008bd0: 2072 6574 7572 6e20 5b22 2573 7365 7420   return ["%sset 
+00008be0: 6469 6666 2076 616c 7565 3a20 2573 2220  diff value: %s" 
+00008bf0: 2520 2870 7265 6669 782c 2073 5b30 5d29  % (prefix, s[0])
+00008c00: 5d0a 2020 2020 2020 2020 7320 3d20 5b5d  ].        s = []
+00008c10: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00008c20: 2069 6e20 7365 6c66 5f64 6966 663a 0a20   in self_diff:. 
+00008c30: 2020 2020 2020 2020 2020 2073 202b 3d20             s += 
+00008c40: 5b22 2573 2020 2572 206e 6f74 2069 6e20  ["%s  %r not in 
+00008c50: 6f74 6865 7222 2025 2028 7072 6566 6978  other" % (prefix
+00008c60: 2c20 6b65 7929 5d0a 2020 2020 2020 2020  , key)].        
+00008c70: 666f 7220 6b65 7920 696e 206f 7468 6572  for key in other
+00008c80: 5f64 6966 663a 0a20 2020 2020 2020 2020  _diff:.         
+00008c90: 2020 2073 202b 3d20 5b22 2573 2020 2572     s += ["%s  %r
+00008ca0: 206e 6f74 2069 6e20 7365 6c66 2220 2520   not in self" % 
+00008cb0: 2870 7265 6669 782c 206b 6579 295d 0a20  (prefix, key)]. 
+00008cc0: 2020 2020 2020 2069 6620 733a 0a20 2020         if s:.   
+00008cd0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00008ce0: 5b22 2573 7365 7420 6469 6666 3a22 2025  ["%sset diff:" %
+00008cf0: 2070 7265 6669 785d 202b 2073 0a20 2020   prefix] + s.   
+00008d00: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
+00008d10: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00008d20: 6528 7365 6c66 2c20 6469 6374 293a 0a20  e(self, dict):. 
+00008d30: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00008d40: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+00008d50: 6469 6374 290a 2020 2020 2020 2020 7365  dict).        se
+00008d60: 6c66 5f64 6966 662c 2073 616d 652c 206f  lf_diff, same, o
+00008d70: 7468 6572 5f64 6966 6620 3d20 5f73 6574  ther_diff = _set
+00008d80: 5f64 6966 6628 7365 6c66 2e6b 6579 7328  _diff(self.keys(
+00008d90: 292c 206f 7468 6572 2e6b 6579 7328 2929  ), other.keys())
+00008da0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00008db0: 6571 7561 6c5f 6d61 705f 6669 6e69 7368  equal_map_finish
+00008dc0: 6564 2061 6e64 206c 656e 2873 656c 665f  ed and len(self_
+00008dd0: 6469 6666 2920 3d3d 206c 656e 286f 7468  diff) == len(oth
+00008de0: 6572 5f64 6966 6629 203d 3d20 313a 0a20  er_diff) == 1:. 
+00008df0: 2020 2020 2020 2020 2020 2023 2070 6f74             # pot
+00008e00: 656e 7469 616c 6c79 2075 7064 6174 6520  entially update 
+00008e10: 6571 7561 6c5f 6d61 700a 2020 2020 2020  equal_map.      
+00008e20: 2020 2020 2020 6f62 6a5f 6469 6666 5f6c        obj_diff_l
+00008e30: 6973 7428 6c69 7374 2873 656c 665f 6469  ist(list(self_di
+00008e40: 6666 295b 305d 2c20 6c69 7374 286f 7468  ff)[0], list(oth
+00008e50: 6572 5f64 6966 6629 5b30 5d2c 202a 2a73  er_diff)[0], **s
+00008e60: 7562 5f6b 7761 7267 7329 0a20 2020 2020  ub_kwargs).     
+00008e70: 2020 2020 2020 2023 2069 676e 6f72 6520         # ignore 
+00008e80: 7468 6520 706f 7465 6e74 6961 6c20 7570  the potential up
+00008e90: 6461 7465 6420 6571 7561 6c5f 6d61 7020  dated equal_map 
+00008ea0: 6e6f 7720 666f 7220 7369 6d70 6c69 6369  now for simplici
+00008eb0: 7479 2e20 7765 2077 696c 6c20 616e 7977  ty. we will anyw
+00008ec0: 6179 2064 6f20 6120 7365 636f 6e64 2070  ay do a second p
+00008ed0: 6173 7320 6c61 7465 722e 0a20 2020 2020  ass later..     
+00008ee0: 2020 2073 203d 205b 5d0a 2020 2020 2020     s = [].      
+00008ef0: 2020 666f 7220 6b65 7920 696e 2073 656c    for key in sel
+00008f00: 665f 6469 6666 3a0a 2020 2020 2020 2020  f_diff:.        
+00008f10: 2020 2020 7320 2b3d 205b 2225 7320 206b      s += ["%s  k
+00008f20: 6579 2025 7220 6e6f 7420 696e 206f 7468  ey %r not in oth
+00008f30: 6572 2220 2520 2870 7265 6669 782c 206b  er" % (prefix, k
+00008f40: 6579 295d 0a20 2020 2020 2020 2066 6f72  ey)].        for
+00008f50: 206b 6579 2069 6e20 6f74 6865 725f 6469   key in other_di
+00008f60: 6666 3a0a 2020 2020 2020 2020 2020 2020  ff:.            
+00008f70: 7320 2b3d 205b 2225 7320 206b 6579 2025  s += ["%s  key %
+00008f80: 7220 6e6f 7420 696e 2073 656c 6622 2025  r not in self" %
+00008f90: 2028 7072 6566 6978 2c20 6b65 7929 5d0a   (prefix, key)].
+00008fa0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+00008fb0: 696e 2073 616d 653a 0a20 2020 2020 2020  in same:.       
+00008fc0: 2020 2020 206b 6579 5f20 3d20 6571 7561       key_ = equa
+00008fd0: 6c5f 6d61 705f 7332 6f2e 6765 7428 6b65  l_map_s2o.get(ke
+00008fe0: 792c 206b 6579 290a 2020 2020 2020 2020  y, key).        
+00008ff0: 2020 2020 7661 6c75 655f 7365 6c66 203d      value_self =
+00009000: 2073 656c 665b 6b65 795d 0a20 2020 2020   self[key].     
+00009010: 2020 2020 2020 2076 616c 7565 5f6f 7468         value_oth
+00009020: 6572 203d 206f 7468 6572 5b6b 6579 5f5d  er = other[key_]
+00009030: 0a20 2020 2020 2020 2020 2020 2073 202b  .            s +
+00009040: 3d20 6f62 6a5f 6469 6666 5f6c 6973 7428  = obj_diff_list(
+00009050: 7661 6c75 655f 7365 6c66 2c20 7661 6c75  value_self, valu
+00009060: 655f 6f74 6865 722c 205f 7072 6566 6978  e_other, _prefix
+00009070: 3d22 2573 5b25 725d 2022 2025 2028 7072  ="%s[%r] " % (pr
+00009080: 6566 6978 2c20 6b65 7929 2c20 2a2a 7375  efix, key), **su
+00009090: 625f 6b77 6172 6773 290a 2020 2020 2020  b_kwargs).      
+000090a0: 2020 6966 2073 3a0a 2020 2020 2020 2020    if s:.        
+000090b0: 2020 2020 7265 7475 726e 205b 2225 7364      return ["%sd
+000090c0: 6963 7420 6469 6666 3a22 2025 2070 7265  ict diff:" % pre
+000090d0: 6669 785d 202b 2073 0a20 2020 2020 2020  fix] + s.       
+000090e0: 2072 6574 7572 6e20 5b5d 0a0a 2020 2020   return []..    
+000090f0: 6966 2069 7369 6e73 7461 6e63 6528 7365  if isinstance(se
+00009100: 6c66 2c20 6e70 2e6e 6461 7272 6179 293a  lf, np.ndarray):
+00009110: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00009120: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
+00009130: 2c20 6e70 2e6e 6461 7272 6179 290a 2020  , np.ndarray).  
+00009140: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
+00009150: 6172 7261 795f 6571 7561 6c28 7365 6c66  array_equal(self
+00009160: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
+00009170: 2020 2020 2020 7265 7475 726e 205b 2225        return ["%
+00009180: 7373 656c 663a 2025 7220 213d 206f 7468  sself: %r != oth
+00009190: 6572 3a20 2572 2220 2520 2870 7265 6669  er: %r" % (prefi
+000091a0: 782c 2073 656c 662c 206f 7468 6572 295d  x, self, other)]
+000091b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000091c0: 5b5d 0a0a 2020 2020 6966 2061 6c6c 6f77  []..    if allow
+000091d0: 6564 5f6d 6170 7069 6e67 2061 6e64 2073  ed_mapping and s
+000091e0: 656c 6620 213d 206f 7468 6572 2061 6e64  elf != other and
+000091f0: 2061 6c6c 6f77 6564 5f6d 6170 7069 6e67   allowed_mapping
+00009200: 2873 656c 662c 206f 7468 6572 293a 0a20  (self, other):. 
+00009210: 2020 2020 2020 2069 6620 7365 6c66 2069         if self i
+00009220: 6e20 6571 7561 6c5f 6d61 705f 7332 6f3a  n equal_map_s2o:
+00009230: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00009240: 6620 3d20 6571 7561 6c5f 6d61 705f 7332  f = equal_map_s2
+00009250: 6f5b 7365 6c66 5d0a 2020 2020 2020 2020  o[self].        
+00009260: 656c 6966 206f 7468 6572 206e 6f74 2069  elif other not i
+00009270: 6e20 6571 7561 6c5f 6d61 705f 6f32 733a  n equal_map_o2s:
+00009280: 2020 2320 646f 6e27 7420 6d61 7020 6d75    # don't map mu
+00009290: 6c74 6970 6c65 2074 696d 6573 2074 6f20  ltiple times to 
+000092a0: 7468 6973 0a20 2020 2020 2020 2020 2020  this.           
+000092b0: 2065 7175 616c 5f6d 6170 5f73 326f 5b73   equal_map_s2o[s
+000092c0: 656c 665d 203d 206f 7468 6572 0a20 2020  elf] = other.   
+000092d0: 2020 2020 2020 2020 2065 7175 616c 5f6d           equal_m
+000092e0: 6170 5f6f 3273 5b6f 7468 6572 5d20 3d20  ap_o2s[other] = 
+000092f0: 7365 6c66 0a0a 2020 2020 6966 2073 656c  self..    if sel
+00009300: 6620 213d 206f 7468 6572 3a0a 2020 2020  f != other:.    
+00009310: 2020 2020 7265 7475 726e 205b 2225 7373      return ["%ss
+00009320: 656c 663a 2025 7220 213d 206f 7468 6572  elf: %r != other
+00009330: 3a20 2572 2220 2520 2870 7265 6669 782c  : %r" % (prefix,
+00009340: 2073 656c 662c 206f 7468 6572 295d 0a20   self, other)]. 
+00009350: 2020 2072 6574 7572 6e20 5b5d 0a0a 0a64     return []...d
+00009360: 6566 2066 696e 645f 7261 6e67 6573 286c  ef find_ranges(l
+00009370: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
+00009380: 3a74 7970 6520 6c73 3a20 6c69 7374 5b69  :type ls: list[i
+00009390: 6e74 5d0a 2020 2020 3a72 6574 7572 6e73  nt].    :returns
+000093a0: 206c 6973 7420 6f66 2072 616e 6765 7320   list of ranges 
+000093b0: 2873 7461 7274 2c65 6e64 2920 7768 6572  (start,end) wher
+000093c0: 6520 656e 6420 6973 2065 7863 6c75 7369  e end is exclusi
+000093d0: 7665 0a20 2020 2073 7563 6820 7468 6174  ve.    such that
+000093e0: 2074 6865 2075 6e69 6f6e 206f 6620 7261   the union of ra
+000093f0: 6e67 6528 7374 6172 742c 656e 6429 206d  nge(start,end) m
+00009400: 6174 6368 6573 206c 2e0a 2020 2020 3a72  atches l..    :r
+00009410: 7479 7065 3a20 6c69 7374 5b28 696e 742c  type: list[(int,
+00009420: 696e 7429 5d0a 2020 2020 5765 2065 7870  int)].    We exp
+00009430: 6563 7420 7468 6174 2074 6865 2069 6e63  ect that the inc
+00009440: 6f6d 696e 6720 6c69 7374 2069 7320 736f  oming list is so
+00009450: 7274 6564 2061 6e64 2073 7472 6f6e 676c  rted and strongl
+00009460: 7920 6d6f 6e6f 746f 6e69 6320 696e 6372  y monotonic incr
+00009470: 6561 7369 6e67 2e0a 2020 2020 2222 220a  easing..    """.
+00009480: 2020 2020 6966 206e 6f74 206c 733a 0a20      if not ls:. 
+00009490: 2020 2020 2020 2072 6574 7572 6e20 5b5d         return []
+000094a0: 0a20 2020 2072 616e 6765 7320 3d20 5b28  .    ranges = [(
+000094b0: 6c73 5b30 5d2c 206c 735b 305d 295d 0a20  ls[0], ls[0])]. 
+000094c0: 2020 2066 6f72 206b 2069 6e20 6c73 3a0a     for k in ls:.
+000094d0: 2020 2020 2020 2020 6173 7365 7274 206b          assert k
+000094e0: 203e 3d20 7261 6e67 6573 5b2d 315d 5b31   >= ranges[-1][1
+000094f0: 5d20 2023 2073 7472 6f6e 676c 7920 6d6f  ]  # strongly mo
+00009500: 6e6f 746f 6e69 6320 696e 6372 6561 7369  notonic increasi
+00009510: 6e67 0a20 2020 2020 2020 2069 6620 6b20  ng.        if k 
+00009520: 3d3d 2072 616e 6765 735b 2d31 5d5b 315d  == ranges[-1][1]
+00009530: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00009540: 6e67 6573 5b2d 315d 203d 2028 7261 6e67  nges[-1] = (rang
+00009550: 6573 5b2d 315d 5b30 5d2c 206b 202b 2031  es[-1][0], k + 1
+00009560: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00009570: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
+00009580: 6573 202b 3d20 5b28 6b2c 206b 202b 2031  es += [(k, k + 1
+00009590: 295d 0a20 2020 2072 6574 7572 6e20 7261  )].    return ra
+000095a0: 6e67 6573 0a0a 0a5f 7468 7265 6164 5f6a  nges..._thread_j
+000095b0: 6f69 6e5f 6861 636b 5f69 6e73 7461 6c6c  oin_hack_install
+000095c0: 6564 203d 2046 616c 7365 0a0a 0a64 6566  ed = False...def
+000095d0: 2069 6e69 745f 7468 7265 6164 5f6a 6f69   init_thread_joi
+000095e0: 6e5f 6861 636b 2829 3a0a 2020 2020 2222  n_hack():.    ""
+000095f0: 220a 2020 2020 6060 7468 7265 6164 696e  ".    ``threadin
+00009600: 672e 5468 7265 6164 2e6a 6f69 6e60 6020  g.Thread.join`` 
+00009610: 616e 6420 6060 7468 7265 6164 696e 672e  and ``threading.
+00009620: 436f 6e64 6974 696f 6e2e 7761 6974 6060  Condition.wait``
+00009630: 2077 6f75 6c64 2062 6c6f 636b 2073 6967   would block sig
+00009640: 6e61 6c73 2077 6865 6e20 7275 6e20 696e  nals when run in
+00009650: 2074 6865 206d 6169 6e20 7468 7265 6164   the main thread
+00009660: 2e0a 2020 2020 5765 206e 6576 6572 2077  ..    We never w
+00009670: 616e 7420 746f 2062 6c6f 636b 2073 6967  ant to block sig
+00009680: 6e61 6c73 2e0a 2020 2020 4865 7265 2077  nals..    Here w
+00009690: 6520 7061 7463 6820 6177 6179 2074 6861  e patch away tha
+000096a0: 7420 6265 6861 7669 6f72 2e0a 2020 2020  t behavior..    
+000096b0: 2222 220a 2020 2020 676c 6f62 616c 205f  """.    global _
+000096c0: 7468 7265 6164 5f6a 6f69 6e5f 6861 636b  thread_join_hack
+000096d0: 5f69 6e73 7461 6c6c 6564 0a20 2020 2069  _installed.    i
+000096e0: 6620 5f74 6872 6561 645f 6a6f 696e 5f68  f _thread_join_h
+000096f0: 6163 6b5f 696e 7374 616c 6c65 643a 2020  ack_installed:  
+00009700: 2320 646f 6e27 7420 696e 7374 616c 6c20  # don't install 
+00009710: 7477 6963 650a 2020 2020 2020 2020 7265  twice.        re
+00009720: 7475 726e 0a20 2020 205f 7468 7265 6164  turn.    _thread
+00009730: 5f6a 6f69 6e5f 6861 636b 5f69 6e73 7461  _join_hack_insta
+00009740: 6c6c 6564 203d 2054 7275 650a 2020 2020  lled = True.    
+00009750: 6966 2050 5933 3a0a 2020 2020 2020 2020  if PY3:.        
+00009760: 2320 5468 6573 6520 6d6f 6e6b 6579 2070  # These monkey p
+00009770: 6174 6368 6573 2061 7265 206e 6f74 206e  atches are not n
+00009780: 6563 6573 7361 7279 2061 6e79 6d6f 7265  ecessary anymore
+00009790: 2e20 4e6f 7468 696e 6720 626c 6f63 6b73  . Nothing blocks
+000097a0: 2073 6967 6e61 6c73 2061 6e79 6d6f 7265   signals anymore
+000097b0: 2069 6e20 5079 7468 6f6e 2033 2e0a 2020   in Python 3..  
+000097c0: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
+000097d0: 6769 7468 7562 2e63 6f6d 2f61 6c62 6572  github.com/alber
+000097e0: 747a 2f70 6c61 7967 726f 756e 642f 626c  tz/playground/bl
+000097f0: 6f62 2f6d 6173 7465 722f 7468 7265 6164  ob/master/thread
+00009800: 2d6a 6f69 6e2d 626c 6f63 6b2e 7079 0a20  -join-block.py. 
+00009810: 2020 2020 2020 2023 2068 7474 7073 3a2f         # https:/
+00009820: 2f67 6974 6875 622e 636f 6d2f 616c 6265  /github.com/albe
+00009830: 7274 7a2f 706c 6179 6772 6f75 6e64 2f62  rtz/playground/b
+00009840: 6c6f 622f 6d61 7374 6572 2f63 6f6e 642d  lob/master/cond-
+00009850: 7761 6974 2d62 6c6f 636b 2e70 790a 2020  wait-block.py.  
+00009860: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00009870: 206d 6169 6e5f 7468 7265 6164 203d 2074   main_thread = t
+00009880: 6872 6561 6469 6e67 2e63 7572 7265 6e74  hreading.current
+00009890: 5468 7265 6164 2829 0a20 2020 2023 206e  Thread().    # n
+000098a0: 6f69 6e73 7065 6374 696f 6e20 5079 556e  oinspection PyUn
+000098b0: 7265 736f 6c76 6564 5265 6665 7265 6e63  resolvedReferenc
+000098c0: 6573 2c50 7950 726f 7465 6374 6564 4d65  es,PyProtectedMe
+000098d0: 6d62 6572 0a20 2020 2061 7373 6572 7420  mber.    assert 
+000098e0: 6973 696e 7374 616e 6365 286d 6169 6e5f  isinstance(main_
+000098f0: 7468 7265 6164 2c20 7468 7265 6164 696e  thread, threadin
+00009900: 672e 5f4d 6169 6e54 6872 6561 6429 0a20  g._MainThread). 
+00009910: 2020 206d 6169 6e5f 7468 7265 6164 5f69     main_thread_i
+00009920: 6420 3d20 7468 7265 6164 2e67 6574 5f69  d = thread.get_i
+00009930: 6465 6e74 2829 0a0a 2020 2020 2320 5061  dent()..    # Pa
+00009940: 7463 6820 5468 7265 6164 2e6a 6f69 6e28  tch Thread.join(
+00009950: 292e 0a20 2020 206a 6f69 6e5f 6f72 6967  )..    join_orig
+00009960: 203d 2074 6872 6561 6469 6e67 2e54 6872   = threading.Thr
+00009970: 6561 642e 6a6f 696e 0a0a 2020 2020 6465  ead.join..    de
+00009980: 6620 6a6f 696e 5f68 6163 6b65 6428 7468  f join_hacked(th
+00009990: 7265 6164 5f6f 626a 2c20 7469 6d65 6f75  read_obj, timeou
+000099a0: 743d 4e6f 6e65 293a 0a20 2020 2020 2020  t=None):.       
+000099b0: 2022 2222 0a20 2020 2020 2020 203a 7479   """.        :ty
+000099c0: 7065 2074 6872 6561 645f 6f62 6a3a 2074  pe thread_obj: t
+000099d0: 6872 6561 6469 6e67 2e54 6872 6561 640a  hreading.Thread.
+000099e0: 2020 2020 2020 2020 3a74 7970 6520 7469          :type ti
+000099f0: 6d65 6f75 743a 2066 6c6f 6174 7c4e 6f6e  meout: float|Non
+00009a00: 650a 2020 2020 2020 2020 3a72 6574 7572  e.        :retur
+00009a10: 6e3a 2061 6c77 6179 7320 4e6f 6e65 0a20  n: always None. 
+00009a20: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00009a30: 2020 2069 6620 7468 7265 6164 2e67 6574     if thread.get
+00009a40: 5f69 6465 6e74 2829 203d 3d20 6d61 696e  _ident() == main
+00009a50: 5f74 6872 6561 645f 6964 2061 6e64 2074  _thread_id and t
+00009a60: 696d 656f 7574 2069 7320 4e6f 6e65 3a0a  imeout is None:.
+00009a70: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00009a80: 6973 2069 7320 6120 4841 434b 2066 6f72  is is a HACK for
+00009a90: 2054 6872 6561 642e 6a6f 696e 2829 2069   Thread.join() i
+00009aa0: 6620 7765 2061 7265 2069 6e20 7468 6520  f we are in the 
+00009ab0: 6d61 696e 2074 6872 6561 642e 0a20 2020  main thread..   
+00009ac0: 2020 2020 2020 2020 2023 2049 6e20 7468           # In th
+00009ad0: 6174 2063 6173 652c 2061 2054 6872 6561  at case, a Threa
+00009ae0: 642e 6a6f 696e 2874 696d 656f 7574 3d4e  d.join(timeout=N
+00009af0: 6f6e 6529 2077 6f75 6c64 2068 616e 6720  one) would hang 
+00009b00: 616e 6420 6576 656e 206e 6f74 2072 6573  and even not res
+00009b10: 706f 6e64 2074 6f20 7369 676e 616c 730a  pond to signals.
+00009b20: 2020 2020 2020 2020 2020 2020 2320 6265              # be
+00009b30: 6361 7573 6520 7369 676e 616c 7320 7769  cause signals wi
+00009b40: 6c6c 2067 6574 2064 656c 6976 6572 6564  ll get delivered
+00009b50: 2074 6f20 6f74 6865 7220 7468 7265 6164   to other thread
+00009b60: 7320 616e 6420 5079 7468 6f6e 2077 6f75  s and Python wou
+00009b70: 6c64 2066 6f72 7761 7264 0a20 2020 2020  ld forward.     
+00009b80: 2020 2020 2020 2023 2074 6865 6d20 666f         # them fo
+00009b90: 7220 6465 6c61 7965 6420 6861 6e64 6c69  r delayed handli
+00009ba0: 6e67 2074 6f20 7468 6520 6d61 696e 2074  ng to the main t
+00009bb0: 6872 6561 6420 7768 6963 6820 6861 6e67  hread which hang
+00009bc0: 732e 0a20 2020 2020 2020 2020 2020 2023  s..            #
+00009bd0: 2053 6565 2043 5079 7468 6f6e 2073 6967   See CPython sig
+00009be0: 6e61 6c6d 6f64 756c 652e 632e 0a20 2020  nalmodule.c..   
+00009bf0: 2020 2020 2020 2020 2023 2043 7572 7265           # Curre
+00009c00: 6e74 6c79 2074 6865 2062 6573 7420 736f  ntly the best so
+00009c10: 6c75 7469 6f6e 2049 2063 616e 2074 6869  lution I can thi
+00009c20: 6e6b 206f 663a 0a20 2020 2020 2020 2020  nk of:.         
+00009c30: 2020 2077 6869 6c65 2074 6872 6561 645f     while thread_
+00009c40: 6f62 6a2e 6973 5f61 6c69 7665 2829 3a0a  obj.is_alive():.
+00009c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c60: 6a6f 696e 5f6f 7269 6728 7468 7265 6164  join_orig(thread
+00009c70: 5f6f 626a 2c20 7469 6d65 6f75 743d 302e  _obj, timeout=0.
+00009c80: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
+00009c90: 7468 7265 6164 2e67 6574 5f69 6465 6e74  thread.get_ident
+00009ca0: 2829 203d 3d20 6d61 696e 5f74 6872 6561  () == main_threa
+00009cb0: 645f 6964 2061 6e64 2074 696d 656f 7574  d_id and timeout
+00009cc0: 203e 2030 2e31 3a0a 2020 2020 2020 2020   > 0.1:.        
+00009cd0: 2020 2020 2320 4c69 6d69 7420 7468 6520      # Limit the 
+00009ce0: 7469 6d65 6f75 742e 2054 6869 7320 7368  timeout. This sh
+00009cf0: 6f75 6c64 206e 6f74 206d 6174 7465 7220  ould not matter 
+00009d00: 666f 7220 7468 6520 756e 6465 726c 7969  for the underlyi
+00009d10: 6e67 2063 6f64 652e 0a20 2020 2020 2020  ng code..       
+00009d20: 2020 2020 206a 6f69 6e5f 6f72 6967 2874       join_orig(t
+00009d30: 6872 6561 645f 6f62 6a2c 2074 696d 656f  hread_obj, timeo
+00009d40: 7574 3d30 2e31 290a 2020 2020 2020 2020  ut=0.1).        
+00009d50: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00009d60: 2020 2320 496e 2061 6c6c 206f 7468 6572    # In all other
+00009d70: 2063 6173 6573 2c20 7765 2063 616e 2075   cases, we can u
+00009d80: 7365 2074 6865 206f 7269 6769 6e61 6c2e  se the original.
+00009d90: 0a20 2020 2020 2020 2020 2020 206a 6f69  .            joi
+00009da0: 6e5f 6f72 6967 2874 6872 6561 645f 6f62  n_orig(thread_ob
+00009db0: 6a2c 2074 696d 656f 7574 3d74 696d 656f  j, timeout=timeo
+00009dc0: 7574 290a 0a20 2020 2074 6872 6561 6469  ut)..    threadi
+00009dd0: 6e67 2e54 6872 6561 642e 6a6f 696e 203d  ng.Thread.join =
+00009de0: 206a 6f69 6e5f 6861 636b 6564 0a0a 2020   join_hacked..  
+00009df0: 2020 2320 4d6f 7374 6c79 2074 6865 2073    # Mostly the s
+00009e00: 616d 6520 666f 7220 436f 6e64 6974 696f  ame for Conditio
+00009e10: 6e2e 7761 6974 2829 2e0a 2020 2020 6966  n.wait()..    if
+00009e20: 2050 5933 3a0a 2020 2020 2020 2020 2320   PY3:.        # 
+00009e30: 6874 7470 733a 2f2f 796f 7574 7261 636b  https://youtrack
+00009e40: 2e6a 6574 6272 6169 6e73 2e63 6f6d 2f69  .jetbrains.com/i
+00009e50: 7373 7565 2f50 592d 3334 3938 330a 2020  ssue/PY-34983.  
+00009e60: 2020 2020 2020 2320 6e6f 696e 7370 6563        # noinspec
+00009e70: 7469 6f6e 2050 7950 6570 384e 616d 696e  tion PyPep8Namin
+00009e80: 670a 2020 2020 2020 2020 436f 6e64 6974  g.        Condit
+00009e90: 696f 6e20 3d20 7468 7265 6164 696e 672e  ion = threading.
+00009ea0: 436f 6e64 6974 696f 6e0a 2020 2020 656c  Condition.    el
+00009eb0: 7365 3a0a 2020 2020 2020 2020 2320 6e6f  se:.        # no
+00009ec0: 696e 7370 6563 7469 6f6e 2050 7955 6e72  inspection PyUnr
+00009ed0: 6573 6f6c 7665 6452 6566 6572 656e 6365  esolvedReference
+00009ee0: 732c 5079 5065 7038 4e61 6d69 6e67 2c50  s,PyPep8Naming,P
+00009ef0: 7950 726f 7465 6374 6564 4d65 6d62 6572  yProtectedMember
+00009f00: 0a20 2020 2020 2020 2043 6f6e 6469 7469  .        Conditi
+00009f10: 6f6e 203d 2074 6872 6561 6469 6e67 2e5f  on = threading._
+00009f20: 436f 6e64 6974 696f 6e0a 2020 2020 636f  Condition.    co
+00009f30: 6e64 5f77 6169 745f 6f72 6967 203d 2043  nd_wait_orig = C
+00009f40: 6f6e 6469 7469 6f6e 2e77 6169 740a 0a20  ondition.wait.. 
+00009f50: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
+00009f60: 6e20 5079 556e 7573 6564 4c6f 6361 6c0a  n PyUnusedLocal.
+00009f70: 2020 2020 6465 6620 636f 6e64 5f77 6169      def cond_wai
+00009f80: 745f 6861 636b 6564 2863 6f6e 642c 2074  t_hacked(cond, t
+00009f90: 696d 656f 7574 3d4e 6f6e 652c 202a 6172  imeout=None, *ar
+00009fa0: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
+00009fb0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00009fc0: 436f 6e64 6974 696f 6e20 636f 6e64 3a0a  Condition cond:.
+00009fd0: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
+00009fe0: 6c6f 6174 7c4e 6f6e 6520 7469 6d65 6f75  loat|None timeou
+00009ff0: 743a 0a20 2020 2020 2020 203a 7061 7261  t:.        :para
+0000a000: 6d20 6172 6773 3a0a 2020 2020 2020 2020  m args:.        
+0000a010: 3a72 7479 7065 3a20 626f 6f6c 0a20 2020  :rtype: bool.   
+0000a020: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000a030: 2069 6620 7468 7265 6164 2e67 6574 5f69   if thread.get_i
+0000a040: 6465 6e74 2829 203d 3d20 6d61 696e 5f74  dent() == main_t
+0000a050: 6872 6561 645f 6964 3a0a 2020 2020 2020  hread_id:.      
+0000a060: 2020 2020 2020 6966 2074 696d 656f 7574        if timeout
+0000a070: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000a080: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+0000a090: 6120 7469 6d65 6f75 7420 616e 7977 6179  a timeout anyway
+0000a0a0: 2e20 5468 6973 2073 686f 756c 6420 6e6f  . This should no
+0000a0b0: 7420 6d61 7474 6572 2066 6f72 2074 6865  t matter for the
+0000a0c0: 2075 6e64 6572 6c79 696e 6720 636f 6465   underlying code
+0000a0d0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000a0e0: 2020 7265 7475 726e 2063 6f6e 645f 7761    return cond_wa
+0000a0f0: 6974 5f6f 7269 6728 636f 6e64 2c20 7469  it_orig(cond, ti
+0000a100: 6d65 6f75 743d 302e 3129 2020 2320 6e6f  meout=0.1)  # no
+0000a110: 7161 2020 2320 6874 7470 733a 2f2f 796f  qa  # https://yo
+0000a120: 7574 7261 636b 2e6a 6574 6272 6169 6e73  utrack.jetbrains
+0000a130: 2e63 6f6d 2f69 7373 7565 2f50 592d 3433  .com/issue/PY-43
+0000a140: 3931 350a 2020 2020 2020 2020 2020 2020  915.            
+0000a150: 2320 5468 6572 6520 6973 2073 6f6d 6520  # There is some 
+0000a160: 636f 6465 2028 652e 672e 206d 756c 7469  code (e.g. multi
+0000a170: 7072 6f63 6573 7369 6e67 2e70 6f6f 6c29  processing.pool)
+0000a180: 2077 6869 6368 2072 656c 6965 7320 6f6e   which relies on
+0000a190: 2074 6861 740a 2020 2020 2020 2020 2020   that.          
+0000a1a0: 2020 2320 7765 2072 6573 7065 6374 2074    # we respect t
+0000a1b0: 6865 2072 6561 6c20 7370 6563 6966 6965  he real specifie
+0000a1c0: 6420 7469 6d65 6f75 742e 0a20 2020 2020  d timeout..     
+0000a1d0: 2020 2020 2020 2023 2048 6f77 6576 6572         # However
+0000a1e0: 2c20 7765 2063 616e 6e6f 7420 646f 206d  , we cannot do m
+0000a1f0: 756c 7469 706c 6520 7265 7065 6174 6564  ultiple repeated
+0000a200: 2063 616c 6c73 2074 6f20 636f 6e64 5f77   calls to cond_w
+0000a210: 6169 745f 6f72 6967 2061 7320 7765 206d  ait_orig as we m
+0000a220: 6967 6874 206d 6973 7320 7468 6520 636f  ight miss the co
+0000a230: 6e64 6974 696f 6e20 6e6f 7469 6679 2e0a  ndition notify..
+0000a240: 2020 2020 2020 2020 2020 2020 2320 4275              # Bu
+0000a250: 7420 696e 2073 6f6d 6520 5079 7468 6f6e  t in some Python
+0000a260: 2076 6572 7369 6f6e 732c 2074 6865 2075   versions, the u
+0000a270: 6e64 6572 6c79 696e 6720 636f 6e64 5f77  nderlying cond_w
+0000a280: 6169 745f 6f72 6967 2077 696c 6c20 616e  ait_orig will an
+0000a290: 7977 6179 2061 6c73 6f20 7573 6520 736c  yway also use sl
+0000a2a0: 6565 702e 0a20 2020 2020 2020 2020 2020  eep..           
+0000a2b0: 2072 6574 7572 6e20 636f 6e64 5f77 6169   return cond_wai
+0000a2c0: 745f 6f72 6967 2863 6f6e 642c 2074 696d  t_orig(cond, tim
+0000a2d0: 656f 7574 3d74 696d 656f 7574 2920 2023  eout=timeout)  #
+0000a2e0: 206e 6f71 610a 2020 2020 2020 2020 656c   noqa.        el
+0000a2f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000a300: 7265 7475 726e 2063 6f6e 645f 7761 6974  return cond_wait
+0000a310: 5f6f 7269 6728 636f 6e64 2c20 7469 6d65  _orig(cond, time
+0000a320: 6f75 743d 7469 6d65 6f75 7429 2020 2320  out=timeout)  # 
+0000a330: 6e6f 7161 0a0a 2020 2020 436f 6e64 6974  noqa..    Condit
+0000a340: 696f 6e2e 7761 6974 203d 2063 6f6e 645f  ion.wait = cond_
+0000a350: 7761 6974 5f68 6163 6b65 640a 0a20 2020  wait_hacked..   
+0000a360: 2023 2041 6e64 2074 6865 2073 616d 6520   # And the same 
+0000a370: 666f 7220 4c6f 636b 2e61 6371 7569 7265  for Lock.acquire
+0000a380: 2c20 7665 7279 2073 696d 696c 6172 2074  , very similar t
+0000a390: 6f20 436f 6e64 6974 696f 6e2e 7761 6974  o Condition.wait
+0000a3a0: 2e0a 2020 2020 2320 486f 7765 7665 723a  ..    # However:
+0000a3b0: 2063 616e 2774 2073 6574 2061 7474 7269   can't set attri
+0000a3c0: 6275 7465 7320 6f66 2062 7569 6c74 2d69  butes of built-i
+0000a3d0: 6e2f 6578 7465 6e73 696f 6e20 7479 7065  n/extension type
+0000a3e0: 2027 7468 7265 6164 2e6c 6f63 6b27 2e0a   'thread.lock'..
+0000a3f0: 2020 2020 2320 5765 2063 6f75 6c64 2077      # We could w
+0000a400: 7261 7020 7468 6520 7768 6f6c 6520 7468  rap the whole th
+0000a410: 7265 6164 696e 672e 4c6f 636b 2c20 6275  reading.Lock, bu
+0000a420: 7420 7468 6174 2069 7320 746f 6f20 616e  t that is too an
+0000a430: 6e6f 7969 6e67 2066 6f72 206d 6520 6e6f  noying for me no
+0000a440: 772e 2e2e 0a20 2020 2023 206e 6f69 6e73  w....    # noins
+0000a450: 7065 6374 696f 6e20 5079 5065 7038 4e61  pection PyPep8Na
+0000a460: 6d69 6e67 0a20 2020 204c 6f63 6b20 3d20  ming.    Lock = 
+0000a470: 4e6f 6e65 0a20 2020 2069 6620 4c6f 636b  None.    if Lock
+0000a480: 3a0a 2020 2020 2020 2020 6c6f 636b 5f61  :.        lock_a
+0000a490: 6371 7569 7265 5f6f 7269 6720 3d20 4c6f  cquire_orig = Lo
+0000a4a0: 636b 2e61 6371 7569 7265 2020 2320 6e6f  ck.acquire  # no
+0000a4b0: 7161 0a0a 2020 2020 2020 2020 2320 4e6f  qa..        # No
+0000a4c0: 7465 3a20 7469 6d65 6f75 7420 6172 6775  te: timeout argu
+0000a4d0: 6d65 6e74 2077 6173 2069 6e74 726f 6475  ment was introdu
+0000a4e0: 6365 6420 696e 2050 7974 686f 6e20 332e  ced in Python 3.
+0000a4f0: 0a20 2020 2020 2020 2064 6566 206c 6f63  .        def loc
+0000a500: 6b5f 6163 7175 6972 655f 6861 636b 6564  k_acquire_hacked
+0000a510: 286c 6f63 6b2c 2062 6c6f 636b 696e 673d  (lock, blocking=
+0000a520: 5472 7565 2c20 7469 6d65 6f75 743d 2d31  True, timeout=-1
+0000a530: 293a 0a20 2020 2020 2020 2020 2020 2022  ):.            "
+0000a540: 2222 0a20 2020 2020 2020 2020 2020 203a  "".            :
+0000a550: 7061 7261 6d20 7468 7265 6164 696e 672e  param threading.
+0000a560: 4c6f 636b 206c 6f63 6b3a 0a20 2020 2020  Lock lock:.     
+0000a570: 2020 2020 2020 203a 7061 7261 6d20 626f         :param bo
+0000a580: 6f6c 2062 6c6f 636b 696e 673a 0a20 2020  ol blocking:.   
+0000a590: 2020 2020 2020 2020 203a 7061 7261 6d20           :param 
+0000a5a0: 666c 6f61 7420 7469 6d65 6f75 743a 0a20  float timeout:. 
+0000a5b0: 2020 2020 2020 2020 2020 203a 7274 7970             :rtyp
+0000a5c0: 653a 2062 6f6f 6c0a 2020 2020 2020 2020  e: bool.        
+0000a5d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000a5e0: 2020 2020 6966 206e 6f74 2062 6c6f 636b      if not block
+0000a5f0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+0000a600: 2020 2020 2072 6574 7572 6e20 6c6f 636b       return lock
+0000a610: 5f61 6371 7569 7265 5f6f 7269 6728 6c6f  _acquire_orig(lo
+0000a620: 636b 2c20 626c 6f63 6b69 6e67 3d46 616c  ck, blocking=Fal
+0000a630: 7365 2920 2023 206e 6f20 7469 6d65 6f75  se)  # no timeou
+0000a640: 7420 6966 206e 6f74 2062 6c6f 636b 696e  t if not blockin
+0000a650: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
+0000a660: 4576 6572 7974 6869 6e67 2069 7320 626c  Everything is bl
+0000a670: 6f63 6b69 6e67 206e 6f77 2e0a 2020 2020  ocking now..    
+0000a680: 2020 2020 2020 2020 6966 2074 6872 6561          if threa
+0000a690: 642e 6765 745f 6964 656e 7428 2920 3d3d  d.get_ident() ==
+0000a6a0: 206d 6169 6e5f 7468 7265 6164 5f69 643a   main_thread_id:
+0000a6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a6c0: 2069 6620 7469 6d65 6f75 7420 6973 204e   if timeout is N
+0000a6d0: 6f6e 6520 6f72 2074 696d 656f 7574 203c  one or timeout <
+0000a6e0: 2030 3a20 2023 2062 6c6f 636b 696e 6720   0:  # blocking 
+0000a6f0: 7769 7468 6f75 7420 7469 6d65 6f75 740a  without timeout.
 0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a710: 2020 2020 7768 696c 6520 6e6f 7420 6c6f      while not lo
-0000a720: 636b 5f61 6371 7569 7265 5f6f 7269 6728  ck_acquire_orig(
-0000a730: 6c6f 636b 2c20 626c 6f63 6b69 6e67 3d54  lock, blocking=T
-0000a740: 7275 652c 2074 696d 656f 7574 3d30 2e31  rue, timeout=0.1
-0000a750: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000a760: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000a770: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-0000a780: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000a790: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
-0000a7a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000a7b0: 3a20 2023 2050 7974 686f 6e20 322e 2063  :  # Python 2. c
-0000a7c0: 616e 6e6f 7420 7573 6520 7469 6d65 6f75  annot use timeou
-0000a7d0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0000a7e0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-0000a7f0: 6e6f 7420 6c6f 636b 5f61 6371 7569 7265  not lock_acquire
-0000a800: 5f6f 7269 6728 6c6f 636b 2c20 626c 6f63  _orig(lock, bloc
-0000a810: 6b69 6e67 3d46 616c 7365 293a 0a20 2020  king=False):.   
-0000a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a830: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
-0000a840: 6565 7028 302e 3129 0a20 2020 2020 2020  eep(0.1).       
-0000a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a860: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
-0000a870: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000a880: 653a 2020 2320 7469 6d65 6f75 7420 6973  e:  # timeout is
-0000a890: 2073 6574 2e20 2843 616e 206f 6e6c 7920   set. (Can only 
-0000a8a0: 6265 2077 6974 6820 5079 7468 6f6e 2033  be with Python 3
-0000a8b0: 2e29 0a20 2020 2020 2020 2020 2020 2020  .).             
-0000a8c0: 2020 2020 2020 2023 2055 7365 2061 2063         # Use a c
-0000a8d0: 6170 7065 6420 7469 6d65 6f75 742e 2054  apped timeout. T
-0000a8e0: 6869 7320 7368 6f75 6c64 206e 6f74 206d  his should not m
-0000a8f0: 6174 7465 7220 666f 7220 7468 6520 756e  atter for the un
-0000a900: 6465 726c 7969 6e67 2063 6f64 652e 0a20  derlying code.. 
-0000a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a920: 2020 2072 6574 7572 6e20 6c6f 636b 5f61     return lock_a
-0000a930: 6371 7569 7265 5f6f 7269 6728 6c6f 636b  cquire_orig(lock
-0000a940: 2c20 626c 6f63 6b69 6e67 3d54 7275 652c  , blocking=True,
-0000a950: 2074 696d 656f 7574 3d6d 696e 2874 696d   timeout=min(tim
-0000a960: 656f 7574 2c20 302e 3129 290a 2020 2020  eout, 0.1)).    
-0000a970: 2020 2020 2020 2020 2320 4661 6c6c 6261          # Fallba
-0000a980: 636b 2074 6f20 6465 6661 756c 742e 0a20  ck to default.. 
-0000a990: 2020 2020 2020 2020 2020 2069 6620 5059             if PY
-0000a9a0: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
-0000a9b0: 2020 2072 6574 7572 6e20 6c6f 636b 5f61     return lock_a
-0000a9c0: 6371 7569 7265 5f6f 7269 6728 6c6f 636b  cquire_orig(lock
-0000a9d0: 2c20 626c 6f63 6b69 6e67 3d54 7275 652c  , blocking=True,
-0000a9e0: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
-0000a9f0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0000aa00: 7475 726e 206c 6f63 6b5f 6163 7175 6972  turn lock_acquir
-0000aa10: 655f 6f72 6967 286c 6f63 6b2c 2062 6c6f  e_orig(lock, blo
-0000aa20: 636b 696e 673d 5472 7565 290a 0a20 2020  cking=True)..   
-0000aa30: 2020 2020 204c 6f63 6b2e 6163 7175 6972       Lock.acquir
-0000aa40: 6520 3d20 6c6f 636b 5f61 6371 7569 7265  e = lock_acquire
-0000aa50: 5f68 6163 6b65 640a 0a0a 6465 6620 7374  _hacked...def st
-0000aa60: 6172 745f 6461 656d 6f6e 5f74 6872 6561  art_daemon_threa
-0000aa70: 6428 7461 7267 6574 2c20 6172 6773 3d28  d(target, args=(
-0000aa80: 2929 3a0a 2020 2020 2222 220a 2020 2020  )):.    """.    
-0000aa90: 3a70 6172 616d 2028 292d 3e4e 6f6e 6520  :param ()->None 
-0000aaa0: 7461 7267 6574 3a0a 2020 2020 3a70 6172  target:.    :par
-0000aab0: 616d 2074 7570 6c65 2061 7267 733a 0a20  am tuple args:. 
-0000aac0: 2020 203a 7265 7475 726e 3a20 6e6f 7468     :return: noth
-0000aad0: 696e 670a 2020 2020 2222 220a 2020 2020  ing.    """.    
-0000aae0: 6672 6f6d 2074 6872 6561 6469 6e67 2069  from threading i
-0000aaf0: 6d70 6f72 7420 5468 7265 6164 0a0a 2020  mport Thread..  
-0000ab00: 2020 7420 3d20 5468 7265 6164 2874 6172    t = Thread(tar
-0000ab10: 6765 743d 7461 7267 6574 2c20 6172 6773  get=target, args
-0000ab20: 3d61 7267 7329 0a20 2020 2074 2e64 6165  =args).    t.dae
-0000ab30: 6d6f 6e20 3d20 5472 7565 0a20 2020 2074  mon = True.    t
-0000ab40: 2e73 7461 7274 2829 0a0a 0a64 6566 2069  .start()...def i
-0000ab50: 735f 7175 6974 7469 6e67 2829 3a0a 2020  s_quitting():.  
-0000ab60: 2020 2222 220a 2020 2020 3a72 6574 7572    """.    :retur
-0000ab70: 6e3a 2077 6865 7468 6572 2077 6520 6172  n: whether we ar
-0000ab80: 6520 6375 7272 656e 746c 7920 7175 6974  e currently quit
-0000ab90: 7469 6e67 2028 7669 6120 3a66 756e 633a  ting (via :func:
-0000aba0: 6072 6e6e 2e66 696e 616c 697a 6560 290a  `rnn.finalize`).
-0000abb0: 2020 2020 3a72 7479 7065 3a20 626f 6f6c      :rtype: bool
-0000abc0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-0000abd0: 6f72 7420 7265 7475 726e 6e2e 5f5f 6d61  ort returnn.__ma
-0000abe0: 696e 5f5f 2061 7320 726e 6e0a 0a20 2020  in__ as rnn..   
-0000abf0: 2069 6620 726e 6e2e 7175 6974 5f72 6574   if rnn.quit_ret
-0000ac00: 7572 6e6e 3a20 2023 2076 6961 2072 6e6e  urnn:  # via rnn
-0000ac10: 2e66 696e 616c 697a 6528 290a 2020 2020  .finalize().    
-0000ac20: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-0000ac30: 2020 2020 6966 2067 6574 6174 7472 2873      if getattr(s
-0000ac40: 7973 2c20 2265 7869 7465 6422 2c20 4661  ys, "exited", Fa
-0000ac50: 6c73 6529 3a20 2023 2073 6574 2076 6961  lse):  # set via
-0000ac60: 2044 6562 7567 206d 6f64 756c 6520 7768   Debug module wh
-0000ac70: 656e 2061 6e20 756e 6578 7065 6374 6564  en an unexpected
-0000ac80: 2053 4947 494e 5420 6f63 6375 7273 2c20   SIGINT occurs, 
-0000ac90: 6f72 2068 6572 650a 2020 2020 2020 2020  or here.        
-0000aca0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
-0000acb0: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
-0000acc0: 6566 2069 6e74 6572 7275 7074 5f6d 6169  ef interrupt_mai
-0000acd0: 6e28 293a 0a20 2020 2022 2222 0a20 2020  n():.    """.   
-0000ace0: 2053 656e 6473 203a 636c 6173 733a 604b   Sends :class:`K
-0000acf0: 6579 626f 6172 6449 6e74 6572 7275 7074  eyboardInterrupt
-0000ad00: 6020 746f 2074 6865 206d 6169 6e20 7468  ` to the main th
-0000ad10: 7265 6164 2e0a 0a20 2020 203a 7265 7475  read...    :retu
-0000ad20: 726e 3a20 6e6f 7468 696e 670a 2020 2020  rn: nothing.    
-0000ad30: 2222 220a 2020 2020 2320 6e6f 696e 7370  """.    # noinsp
-0000ad40: 6563 7469 6f6e 2050 7950 726f 7465 6374  ection PyProtect
-0000ad50: 6564 4d65 6d62 6572 2c50 7955 6e72 6573  edMember,PyUnres
-0000ad60: 6f6c 7665 6452 6566 6572 656e 6365 730a  olvedReferences.
-0000ad70: 2020 2020 6973 5f6d 6169 6e5f 7468 7265      is_main_thre
-0000ad80: 6164 203d 2069 7369 6e73 7461 6e63 6528  ad = isinstance(
-0000ad90: 7468 7265 6164 696e 672e 6375 7272 656e  threading.curren
-0000ada0: 7454 6872 6561 6428 292c 2074 6872 6561  tThread(), threa
-0000adb0: 6469 6e67 2e5f 4d61 696e 5468 7265 6164  ding._MainThread
-0000adc0: 290a 2020 2020 6966 2069 735f 7175 6974  ).    if is_quit
-0000add0: 7469 6e67 2829 3a20 2023 2069 676e 6f72  ting():  # ignor
-0000ade0: 6520 6966 2077 6520 6172 6520 616c 7265  e if we are alre
-0000adf0: 6164 7920 7175 6974 7469 6e67 0a20 2020  ady quitting.   
-0000ae00: 2020 2020 2069 6620 6973 5f6d 6169 6e5f       if is_main_
-0000ae10: 7468 7265 6164 3a20 2023 2073 7472 616e  thread:  # stran
-0000ae20: 6765 2074 6f20 6765 7420 6167 6169 6e20  ge to get again 
-0000ae30: 696e 206d 6169 6e20 7468 7265 6164 0a20  in main thread. 
-0000ae40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000ae50: 2045 7863 6570 7469 6f6e 2822 696e 7465   Exception("inte
-0000ae60: 7272 7570 745f 6d61 696e 2829 2066 726f  rrupt_main() fro
-0000ae70: 6d20 6d61 696e 2074 6872 6561 6420 7768  m main thread wh
-0000ae80: 696c 6520 616c 7265 6164 7920 7175 6974  ile already quit
-0000ae90: 7469 6e67 2229 0a20 2020 2020 2020 2023  ting").        #
-0000aea0: 204e 6f74 206d 6169 6e20 7468 7265 6164   Not main thread
-0000aeb0: 2e20 5468 6973 2077 696c 6c20 6a75 7374  . This will just
-0000aec0: 2065 7869 7420 7468 6520 7468 7265 6164   exit the thread
-0000aed0: 2e0a 2020 2020 2020 2020 7379 732e 6578  ..        sys.ex
-0000aee0: 6974 2831 290a 2020 2020 7379 732e 6578  it(1).    sys.ex
-0000aef0: 6974 6564 203d 2054 7275 6520 2023 2044  ited = True  # D
-0000af00: 6f6e 2774 2064 6f20 6974 2074 7769 6365  on't do it twice
-0000af10: 2e0a 2020 2020 2320 6e6f 696e 7370 6563  ..    # noinspec
-0000af20: 7469 6f6e 2050 7950 726f 7465 6374 6564  tion PyProtected
-0000af30: 4d65 6d62 6572 2c50 7955 6e72 6573 6f6c  Member,PyUnresol
-0000af40: 7665 6452 6566 6572 656e 6365 730a 2020  vedReferences.  
-0000af50: 2020 7379 732e 6578 6974 6564 5f66 7261    sys.exited_fra
-0000af60: 6d65 203d 2073 7973 2e5f 6765 7466 7261  me = sys._getfra
-0000af70: 6d65 2829 0a20 2020 2069 6620 6973 5f6d  me().    if is_m
-0000af80: 6169 6e5f 7468 7265 6164 3a0a 2020 2020  ain_thread:.    
-0000af90: 2020 2020 7261 6973 6520 4b65 7962 6f61      raise Keyboa
-0000afa0: 7264 496e 7465 7272 7570 740a 2020 2020  rdInterrupt.    
-0000afb0: 656c 7365 3a0a 2020 2020 2020 2020 7468  else:.        th
-0000afc0: 7265 6164 2e69 6e74 6572 7275 7074 5f6d  read.interrupt_m
-0000afd0: 6169 6e28 290a 2020 2020 2020 2020 7379  ain().        sy
-0000afe0: 732e 6578 6974 2831 2920 2023 2041 6e64  s.exit(1)  # And
-0000aff0: 2065 7869 7420 7468 6520 7468 7265 6164   exit the thread
-0000b000: 2e0a 0a0a 636c 6173 7320 4173 796e 6354  ....class AsyncT
-0000b010: 6872 6561 6452 756e 2874 6872 6561 6469  hreadRun(threadi
-0000b020: 6e67 2e54 6872 6561 6429 3a0a 2020 2020  ng.Thread):.    
-0000b030: 2222 220a 2020 2020 4461 656d 6f6e 2074  """.    Daemon t
-0000b040: 6872 6561 642c 2077 7261 7070 696e 6720  hread, wrapping 
-0000b050: 736f 6d65 2066 756e 6374 696f 6e20 6060  some function ``
-0000b060: 6675 6e63 6060 2076 6961 203a 6675 6e63  func`` via :func
-0000b070: 3a60 7772 6170 5f61 7379 6e63 5f66 756e  :`wrap_async_fun
-0000b080: 6360 2e0a 2020 2020 2222 220a 0a20 2020  c`..    """..   
-0000b090: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0000b0a0: 6c66 2c20 6e61 6d65 2c20 6675 6e63 293a  lf, name, func):
-0000b0b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000b0c0: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
-0000b0d0: 6e61 6d65 3a0a 2020 2020 2020 2020 3a70  name:.        :p
-0000b0e0: 6172 616d 2028 292d 3e54 2066 756e 633a  aram ()->T func:
-0000b0f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000b100: 2020 2020 2073 7570 6572 2841 7379 6e63       super(Async
-0000b110: 5468 7265 6164 5275 6e2c 2073 656c 6629  ThreadRun, self)
-0000b120: 2e5f 5f69 6e69 745f 5f28 6e61 6d65 3d6e  .__init__(name=n
-0000b130: 616d 652c 2074 6172 6765 743d 7365 6c66  ame, target=self
-0000b140: 2e6d 6169 6e29 0a20 2020 2020 2020 2073  .main).        s
-0000b150: 656c 662e 6675 6e63 203d 2066 756e 630a  elf.func = func.
-0000b160: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-0000b170: 756c 7420 3d20 4e6f 6e65 0a20 2020 2020  ult = None.     
-0000b180: 2020 2073 656c 662e 6461 656d 6f6e 203d     self.daemon =
-0000b190: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
-0000b1a0: 6c66 2e73 7461 7274 2829 0a0a 2020 2020  lf.start()..    
-0000b1b0: 6465 6620 6d61 696e 2873 656c 6629 3a0a  def main(self):.
-0000b1c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000b1d0: 2020 2020 5468 7265 6164 2074 6172 6765      Thread targe
-0000b1e0: 7420 6675 6e63 7469 6f6e 2e0a 0a20 2020  t function...   
-0000b1f0: 2020 2020 203a 7265 7475 726e 3a20 6e6f       :return: no
-0000b200: 7468 696e 672c 2077 696c 6c20 6a75 7374  thing, will just
-0000b210: 2073 6574 2073 656c 662e 7265 7375 6c74   set self.result
-0000b220: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000b230: 2020 2020 2073 656c 662e 7265 7375 6c74       self.result
-0000b240: 203d 2077 7261 705f 6173 796e 635f 6675   = wrap_async_fu
-0000b250: 6e63 2873 656c 662e 6675 6e63 290a 0a20  nc(self.func).. 
-0000b260: 2020 2064 6566 2067 6574 2873 656c 6629     def get(self)
-0000b270: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0000b280: 2020 2020 2020 3a72 6574 7572 6e3a 206a        :return: j
-0000b290: 6f69 6e73 2074 6865 2074 6872 6561 642c  oins the thread,
-0000b2a0: 2061 6e64 2074 6865 6e20 7265 7475 726e   and then return
-0000b2b0: 7320 7468 6520 7265 7375 6c74 0a20 2020  s the result.   
-0000b2c0: 2020 2020 203a 7274 7970 653a 2054 0a20       :rtype: T. 
-0000b2d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000b2e0: 2020 2073 656c 662e 6a6f 696e 2829 0a20     self.join(). 
-0000b2f0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000b300: 6c66 2e72 6573 756c 740a 0a0a 6465 6620  lf.result...def 
-0000b310: 7772 6170 5f61 7379 6e63 5f66 756e 6328  wrap_async_func(
-0000b320: 6629 3a0a 2020 2020 2222 220a 2020 2020  f):.    """.    
-0000b330: 4361 6c6c 7320 6060 6628 2960 6020 616e  Calls ``f()`` an
-0000b340: 6420 7265 7475 726e 7320 7468 6520 7265  d returns the re
-0000b350: 7375 6c74 2e0a 2020 2020 5772 6170 7065  sult..    Wrappe
-0000b360: 6420 7570 2077 6974 6820 6361 7463 6869  d up with catchi
-0000b370: 6e67 2061 6c6c 2065 7863 6570 7469 6f6e  ng all exception
-0000b380: 732c 2070 7269 6e74 696e 6720 7374 6163  s, printing stac
-0000b390: 6b20 7472 6163 652c 2061 6e64 203a 6675  k trace, and :fu
-0000b3a0: 6e63 3a60 696e 7465 7272 7570 745f 6d61  nc:`interrupt_ma
-0000b3b0: 696e 602e 0a0a 2020 2020 3a70 6172 616d  in`...    :param
-0000b3c0: 2028 292d 3e54 2066 3a0a 2020 2020 3a72   ()->T f:.    :r
-0000b3d0: 7479 7065 3a20 540a 2020 2020 2222 220a  type: T.    """.
-0000b3e0: 2020 2020 2320 6e6f 696e 7370 6563 7469      # noinspecti
-0000b3f0: 6f6e 2050 7942 726f 6164 4578 6365 7074  on PyBroadExcept
-0000b400: 696f 6e0a 2020 2020 7472 793a 0a20 2020  ion.    try:.   
-0000b410: 2020 2020 2066 726f 6d20 7265 7475 726e       from return
-0000b420: 6e2e 7574 696c 2069 6d70 6f72 7420 6265  n.util import be
-0000b430: 7474 6572 5f65 7863 686f 6f6b 0a0a 2020  tter_exchook..  
-0000b440: 2020 2020 2020 6265 7474 6572 5f65 7863        better_exc
-0000b450: 686f 6f6b 2e69 6e73 7461 6c6c 2829 0a20  hook.install(). 
-0000b460: 2020 2020 2020 2072 6574 7572 6e20 6628         return f(
-0000b470: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-0000b480: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0000b490: 7379 732e 6578 6365 7074 686f 6f6b 282a  sys.excepthook(*
-0000b4a0: 7379 732e 6578 635f 696e 666f 2829 290a  sys.exc_info()).
-0000b4b0: 2020 2020 2020 2020 696e 7465 7272 7570          interrup
-0000b4c0: 745f 6d61 696e 2829 0a0a 0a64 6566 2074  t_main()...def t
-0000b4d0: 7279 5f72 756e 2866 756e 632c 2061 7267  ry_run(func, arg
-0000b4e0: 733d 2829 2c20 6361 7463 685f 6578 633d  s=(), catch_exc=
-0000b4f0: 4578 6365 7074 696f 6e2c 2064 6566 6175  Exception, defau
-0000b500: 6c74 3d4e 6f6e 6529 3a0a 2020 2020 2222  lt=None):.    ""
-0000b510: 220a 2020 2020 3a70 6172 616d 2028 2829  ".    :param (()
-0000b520: 2d3e 5429 7c28 2858 292d 3e54 2920 6675  ->T)|((X)->T) fu
-0000b530: 6e63 3a0a 2020 2020 3a70 6172 616d 2074  nc:.    :param t
-0000b540: 7570 6c65 2061 7267 733a 0a20 2020 203a  uple args:.    :
-0000b550: 7061 7261 6d20 7479 7065 5b45 7863 6570  param type[Excep
-0000b560: 7469 6f6e 5d20 6361 7463 685f 6578 633a  tion] catch_exc:
-0000b570: 0a20 2020 203a 7061 7261 6d20 5432 2064  .    :param T2 d
-0000b580: 6566 6175 6c74 3a0a 2020 2020 3a72 6574  efault:.    :ret
-0000b590: 7572 6e3a 2065 6974 6865 7220 6060 6675  urn: either ``fu
-0000b5a0: 6e63 2829 6060 206f 7220 6060 6465 6661  nc()`` or ``defa
-0000b5b0: 756c 7460 6020 6966 2074 6865 7265 2077  ult`` if there w
-0000b5c0: 6173 2073 6f6d 6520 6578 6365 7074 696f  as some exceptio
-0000b5d0: 6e0a 2020 2020 3a72 7479 7065 3a20 547c  n.    :rtype: T|
-0000b5e0: 5432 0a20 2020 2022 2222 0a20 2020 2023  T2.    """.    #
-0000b5f0: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
-0000b600: 4272 6f61 6445 7863 6570 7469 6f6e 0a20  BroadException. 
-0000b610: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000b620: 7265 7475 726e 2066 756e 6328 2a61 7267  return func(*arg
-0000b630: 7329 0a20 2020 2065 7863 6570 7420 6361  s).    except ca
-0000b640: 7463 685f 6578 633a 0a20 2020 2020 2020  tch_exc:.       
-0000b650: 2072 6574 7572 6e20 6465 6661 756c 740a   return default.
-0000b660: 0a0a 6465 6620 7661 6c69 6461 7465 5f62  ..def validate_b
-0000b670: 726f 6164 6361 7374 5f61 6c6c 5f73 6f75  roadcast_all_sou
-0000b680: 7263 6573 2861 6c6c 6f77 5f62 726f 6164  rces(allow_broad
-0000b690: 6361 7374 5f61 6c6c 5f73 6f75 7263 6573  cast_all_sources
-0000b6a0: 2c20 696e 7075 7473 2c20 636f 6d6d 6f6e  , inputs, common
-0000b6b0: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
-0000b6c0: 616c 6c20 7468 6973 2077 6865 6e20 616c  all this when al
-0000b6d0: 6c20 696e 7075 7473 2074 6f20 736f 6d65  l inputs to some
-0000b6e0: 206f 7065 7261 7469 6f6e 2028 6c61 7965   operation (laye
-0000b6f0: 7229 206d 7573 7420 6265 2062 726f 6164  r) must be broad
-0000b700: 6361 7374 6564 2e0a 2020 2020 4974 2063  casted..    It c
-0000b710: 6865 636b 7320 7768 6574 6865 7220 6272  hecks whether br
-0000b720: 6f61 6463 6173 7469 6e67 2074 6f20 616c  oadcasting to al
-0000b730: 6c20 736f 7572 6365 7320 7368 6f75 6c64  l sources should
-0000b740: 2062 6520 616c 6c6f 7765 642e 0a20 2020   be allowed..   
-0000b750: 2045 2e67 2e20 666f 7220 696e 7075 7420   E.g. for input 
-0000b760: 5b42 2c54 312c 4431 5d20 2b20 5b42 2c54  [B,T1,D1] + [B,T
-0000b770: 322c 4432 5d2c 2077 6865 6e20 616c 6c6f  2,D2], when allo
-0000b780: 7765 642c 2069 7420 776f 756c 6420 6272  wed, it would br
-0000b790: 6f61 6463 6173 7420 746f 205b 422c 5431  oadcast to [B,T1
-0000b7a0: 2c54 322c 4431 2c44 325d 2e0a 2020 2020  ,T2,D1,D2]..    
-0000b7b0: 5768 656e 206e 6f74 2061 6c6c 6f77 6564  When not allowed
-0000b7c0: 2c20 7468 6572 6520 6d75 7374 2062 6520  , there must be 
-0000b7d0: 6174 206c 6561 7374 206f 6e65 2073 6f75  at least one sou
-0000b7e0: 7263 6520 7768 6572 6520 6e6f 2062 726f  rce where no bro
-0000b7f0: 6164 6361 7374 696e 6720 7769 6c6c 2062  adcasting will b
-0000b800: 6520 646f 6e65 2e0a 2020 2020 5768 6574  e done..    Whet
-0000b810: 6865 7220 6974 2069 7320 616c 6c6f 7765  her it is allowe
-0000b820: 642c 2074 6869 7320 6465 7065 6e64 7320  d, this depends 
-0000b830: 6f6e 2074 6865 2062 6568 6176 696f 7220  on the behavior 
-0000b840: 7665 7273 696f 6e2e 0a20 2020 2020 2068  version..      h
-0000b850: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-0000b860: 6d2f 7277 7468 2d69 362f 7265 7475 726e  m/rwth-i6/return
-0000b870: 6e2f 6973 7375 6573 2f36 3931 0a0a 2020  n/issues/691..  
-0000b880: 2020 436f 6d6d 6f6e 2075 7361 6765 7320    Common usages 
-0000b890: 6172 6520 666f 7220 3a66 756e 633a 6067  are for :func:`g
-0000b8a0: 6574 5f63 6f6d 6d6f 6e5f 7368 6170 6560  et_common_shape`
-0000b8b0: 206f 7220 3a66 756e 633a 6044 6174 612e   or :func:`Data.
-0000b8c0: 6765 745f 636f 6d6d 6f6e 5f64 6174 6160  get_common_data`
-0000b8d0: 2e0a 0a20 2020 203a 7061 7261 6d20 626f  ...    :param bo
-0000b8e0: 6f6c 7c4e 6f74 5370 6563 6966 6965 6420  ol|NotSpecified 
-0000b8f0: 616c 6c6f 775f 6272 6f61 6463 6173 745f  allow_broadcast_
-0000b900: 616c 6c5f 736f 7572 6365 733a 0a20 2020  all_sources:.   
-0000b910: 203a 7061 7261 6d20 696e 7075 7473 3a20   :param inputs: 
-0000b920: 616e 7974 6869 6e67 2063 6f6e 7665 7274  anything convert
-0000b930: 6962 6c65 2074 6f20 6974 6572 6162 6c65  ible to iterable
-0000b940: 206f 6620 7374 722c 2075 7365 6420 666f   of str, used fo
-0000b950: 7220 7265 706f 7274 696e 670a 2020 2020  r reporting.    
-0000b960: 3a70 6172 616d 2063 6f6d 6d6f 6e3a 2061  :param common: a
-0000b970: 6e79 7468 696e 6720 636f 6e76 6572 7469  nything converti
-0000b980: 626c 6520 746f 2073 7472 2c20 7573 6564  ble to str, used
-0000b990: 2066 6f72 2072 6570 6f72 7469 6e67 0a20   for reporting. 
-0000b9a0: 2020 2022 2222 0a20 2020 206d 7367 203d     """.    msg =
-0000b9b0: 2028 0a20 2020 2020 2020 2022 416c 6c20   (.        "All 
-0000b9c0: 696e 7075 7473 5c6e 2573 5c6e 7265 7175  inputs\n%s\nrequ
-0000b9d0: 6972 6520 6272 6f61 6463 6173 7469 6e67  ire broadcasting
-0000b9e0: 2074 6f20 5c6e 2020 2573 2e5c 6e22 2025   to \n  %s.\n" %
-0000b9f0: 2028 225c 6e22 2e6a 6f69 6e28 2220 2d20   ("\n".join(" - 
-0000ba00: 2573 2220 2520 696e 7020 666f 7220 696e  %s" % inp for in
-0000ba10: 7020 696e 2069 6e70 7574 7329 2c20 636f  p in inputs), co
-0000ba20: 6d6d 6f6e 290a 2020 2020 2020 2020 2b20  mmon).        + 
-0000ba30: 2254 6869 7320 6d75 7374 2062 6520 6578  "This must be ex
-0000ba40: 706c 6963 6974 6c79 2061 6c6c 6f77 6564  plicitly allowed
-0000ba50: 2c20 652e 672e 2062 7920 7370 6563 6966  , e.g. by specif
-0000ba60: 7969 6e67 206f 7574 5f73 6861 7065 2e22  ying out_shape."
-0000ba70: 0a20 2020 2029 0a20 2020 2069 6620 616c  .    ).    if al
-0000ba80: 6c6f 775f 6272 6f61 6463 6173 745f 616c  low_broadcast_al
-0000ba90: 6c5f 736f 7572 6365 7320 6973 204e 6f74  l_sources is Not
-0000baa0: 5370 6563 6966 6965 643a 0a20 2020 2020  Specified:.     
-0000bab0: 2020 2066 726f 6d20 7265 7475 726e 6e2e     from returnn.
-0000bac0: 7574 696c 2069 6d70 6f72 7420 4265 6861  util import Beha
-0000bad0: 7669 6f72 5665 7273 696f 6e0a 0a20 2020  viorVersion..   
-0000bae0: 2020 2020 2042 6568 6176 696f 7256 6572       BehaviorVer
-0000baf0: 7369 6f6e 2e72 6571 7569 7265 2876 6572  sion.require(ver
-0000bb00: 7369 6f6e 3d34 2c20 636f 6e64 6974 696f  sion=4, conditio
-0000bb10: 6e3d 4661 6c73 652c 206d 6573 7361 6765  n=False, message
-0000bb20: 3d6d 7367 290a 2020 2020 2020 2020 7265  =msg).        re
-0000bb30: 7475 726e 0a20 2020 2069 6620 616c 6c6f  turn.    if allo
-0000bb40: 775f 6272 6f61 6463 6173 745f 616c 6c5f  w_broadcast_all_
-0000bb50: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
-0000bb60: 2072 6574 7572 6e0a 2020 2020 7261 6973   return.    rais
-0000bb70: 6520 4578 6365 7074 696f 6e28 6d73 6729  e Exception(msg)
-0000bb80: 0a0a 0a64 6566 2063 6c61 7373 5f69 6478  ...def class_idx
-0000bb90: 5f73 6571 5f74 6f5f 315f 6f66 5f6b 2873  _seq_to_1_of_k(s
-0000bba0: 6571 2c20 6e75 6d5f 636c 6173 7365 7329  eq, num_classes)
-0000bbb0: 3a0a 2020 2020 2222 220a 2020 2020 4261  :.    """.    Ba
-0000bbc0: 7369 6361 6c6c 7920 6f6e 655f 686f 742e  sically one_hot.
-0000bbd0: 0a0a 2020 2020 3a70 6172 616d 206c 6973  ..    :param lis
-0000bbe0: 745b 696e 745d 7c6e 702e 6e64 6172 7261  t[int]|np.ndarra
-0000bbf0: 7920 7365 713a 0a20 2020 203a 7061 7261  y seq:.    :para
-0000bc00: 6d20 696e 7420 6e75 6d5f 636c 6173 7365  m int num_classe
-0000bc10: 733a 0a20 2020 203a 7274 7970 653a 206e  s:.    :rtype: n
-0000bc20: 702e 6e64 6172 7261 790a 2020 2020 2222  p.ndarray.    ""
-0000bc30: 220a 2020 2020 6e75 6d5f 6672 616d 6573  ".    num_frames
-0000bc40: 203d 206c 656e 2873 6571 290a 2020 2020   = len(seq).    
-0000bc50: 6d20 3d20 6e70 2e7a 6572 6f73 2828 6e75  m = np.zeros((nu
-0000bc60: 6d5f 6672 616d 6573 2c20 6e75 6d5f 636c  m_frames, num_cl
-0000bc70: 6173 7365 7329 2c20 6474 7970 653d 2266  asses), dtype="f
-0000bc80: 6c6f 6174 3332 2229 0a20 2020 206d 5b6e  loat32").    m[n
-0000bc90: 702e 6172 616e 6765 286e 756d 5f66 7261  p.arange(num_fra
-0000bca0: 6d65 7329 2c20 7365 715d 203d 2031 0a20  mes), seq] = 1. 
-0000bcb0: 2020 2072 6574 7572 6e20 6d0a 0a0a 6465     return m...de
-0000bcc0: 6620 756e 6971 2873 6571 293a 0a20 2020  f uniq(seq):.   
-0000bcd0: 2022 2222 0a20 2020 204c 696b 6520 556e   """.    Like Un
-0000bce0: 6978 2074 6f6f 6c20 756e 6971 2e20 5265  ix tool uniq. Re
-0000bcf0: 6d6f 7665 7320 7265 7065 6174 6564 2065  moves repeated e
-0000bd00: 6e74 7269 6573 2e0a 2020 2020 5365 6520  ntries..    See 
-0000bd10: 3a66 756e 633a 6075 6e69 715f 6765 6e65  :func:`uniq_gene
-0000bd20: 7269 6360 2066 6f72 2061 2067 656e 6572  ric` for a gener
-0000bd30: 6963 2028 6e6f 6e2d 4e75 6d70 7929 2076  ic (non-Numpy) v
-0000bd40: 6572 7369 6f6e 2e0a 0a20 2020 203a 7061  ersion...    :pa
-0000bd50: 7261 6d20 6e75 6d70 792e 6e64 6172 7261  ram numpy.ndarra
-0000bd60: 7920 7365 713a 0a20 2020 203a 7265 7475  y seq:.    :retu
-0000bd70: 726e 3a20 7365 710a 2020 2020 3a72 7479  rn: seq.    :rty
-0000bd80: 7065 3a20 6e75 6d70 792e 6e64 6172 7261  pe: numpy.ndarra
-0000bd90: 790a 2020 2020 2222 220a 2020 2020 6469  y.    """.    di
-0000bda0: 6666 7320 3d20 6e70 2e6f 6e65 735f 6c69  ffs = np.ones_li
-0000bdb0: 6b65 2873 6571 290a 2020 2020 6469 6666  ke(seq).    diff
-0000bdc0: 735b 313a 5d20 3d20 7365 715b 313a 5d20  s[1:] = seq[1:] 
-0000bdd0: 2d20 7365 715b 3a2d 315d 0a20 2020 2069  - seq[:-1].    i
-0000bde0: 6478 203d 2064 6966 6673 2e6e 6f6e 7a65  dx = diffs.nonze
-0000bdf0: 726f 2829 0a20 2020 2072 6574 7572 6e20  ro().    return 
-0000be00: 7365 715b 6964 785d 0a0a 0a64 6566 2075  seq[idx]...def u
-0000be10: 6e69 715f 6765 6e65 7269 6328 7365 7129  niq_generic(seq)
-0000be20: 3a0a 2020 2020 2222 220a 2020 2020 4c69  :.    """.    Li
-0000be30: 6b65 2055 6e69 7820 746f 6f6c 2075 6e69  ke Unix tool uni
-0000be40: 712e 2052 656d 6f76 6573 2072 6570 6561  q. Removes repea
-0000be50: 7465 6420 656e 7472 6965 732e 0a20 2020  ted entries..   
-0000be60: 2053 6565 203a 6675 6e63 3a60 756e 6971   See :func:`uniq
-0000be70: 6020 666f 7220 616e 2065 6666 6963 6965  ` for an efficie
-0000be80: 6e74 204e 756d 7079 2069 6d70 6c65 6d65  nt Numpy impleme
-0000be90: 6e74 6174 696f 6e2e 0a20 2020 2053 6565  ntation..    See
-0000bea0: 203a 6675 6e63 3a60 7265 7475 726e 6e2e   :func:`returnn.
-0000beb0: 7466 2e75 7469 6c2e 6261 7369 632e 756e  tf.util.basic.un
-0000bec0: 6971 6020 666f 7220 616e 2065 6666 6963  iq` for an effic
-0000bed0: 6965 6e74 2054 4620 696d 706c 656d 656e  ient TF implemen
-0000bee0: 7461 7469 6f6e 2e0a 0a20 2020 203a 7061  tation...    :pa
-0000bef0: 7261 6d20 6c69 7374 5b54 5d7c 7475 706c  ram list[T]|tupl
-0000bf00: 655b 545d 2073 6571 3a0a 2020 2020 3a72  e[T] seq:.    :r
-0000bf10: 6574 7572 6e3a 2073 6571 0a20 2020 203a  eturn: seq.    :
-0000bf20: 7274 7970 653a 206c 6973 745b 545d 0a20  rtype: list[T]. 
-0000bf30: 2020 2022 2222 0a20 2020 206f 7574 203d     """.    out =
-0000bf40: 205b 5d0a 2020 2020 7669 7369 7465 6420   [].    visited 
-0000bf50: 3d20 7365 7428 290a 2020 2020 666f 7220  = set().    for 
-0000bf60: 7820 696e 2073 6571 3a0a 2020 2020 2020  x in seq:.      
-0000bf70: 2020 6966 2078 2069 6e20 7669 7369 7465    if x in visite
-0000bf80: 643a 0a20 2020 2020 2020 2020 2020 2063  d:.            c
-0000bf90: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-0000bfa0: 6f75 742e 6170 7065 6e64 2878 290a 2020  out.append(x).  
-0000bfb0: 2020 2020 2020 7669 7369 7465 642e 6164        visited.ad
-0000bfc0: 6428 7829 0a20 2020 2072 6574 7572 6e20  d(x).    return 
-0000bfd0: 6f75 740a 0a0a 6465 6620 736c 6963 655f  out...def slice_
-0000bfe0: 7061 645f 7a65 726f 7328 783a 206e 756d  pad_zeros(x: num
-0000bff0: 7079 2e6e 6461 7272 6179 2c20 6265 6769  py.ndarray, begi
-0000c000: 6e3a 2069 6e74 2c20 656e 643a 2069 6e74  n: int, end: int
-0000c010: 2c20 6178 6973 3a20 696e 7420 3d20 3029  , axis: int = 0)
-0000c020: 202d 3e20 6e75 6d70 792e 6e64 6172 7261   -> numpy.ndarra
-0000c030: 793a 0a20 2020 2022 2222 0a20 2020 203a  y:.    """.    :
-0000c040: 7061 7261 6d20 783a 206f 6620 7368 6170  param x: of shap
-0000c050: 6520 282e 2e2e 2c20 7469 6d65 2c20 2e2e  e (..., time, ..
-0000c060: 2e29 0a20 2020 203a 7061 7261 6d20 6265  .).    :param be
-0000c070: 6769 6e3a 0a20 2020 203a 7061 7261 6d20  gin:.    :param 
-0000c080: 656e 643a 0a20 2020 203a 7061 7261 6d20  end:.    :param 
-0000c090: 6178 6973 3a0a 2020 2020 3a72 6574 7572  axis:.    :retur
-0000c0a0: 6e3a 2062 6173 6963 616c 6c79 2078 5b62  n: basically x[b
-0000c0b0: 6567 696e 3a65 6e64 5d20 2877 6974 6820  egin:end] (with 
-0000c0c0: 6178 6973 3d3d 3029 2062 7574 2069 6620  axis==0) but if 
-0000c0d0: 6265 6769 6e20 3c20 3020 6f72 2065 6e64  begin < 0 or end
-0000c0e0: 203e 2078 2e73 6861 7065 5b30 5d2c 0a20   > x.shape[0],. 
-0000c0f0: 2020 2020 6974 2077 696c 6c20 6e6f 7420      it will not 
-0000c100: 6469 7363 6172 6420 7468 6573 6520 6672  discard these fr
-0000c110: 616d 6573 2062 7574 2070 6164 207a 6572  ames but pad zer
-0000c120: 6f73 2c20 7375 6368 2074 6861 7420 7468  os, such that th
-0000c130: 6520 7265 7375 6c74 696e 6720 7368 6170  e resulting shap
-0000c140: 655b 305d 203d 3d20 656e 6420 2d20 6265  e[0] == end - be
-0000c150: 6769 6e2e 0a20 2020 2022 2222 0a20 2020  gin..    """.   
-0000c160: 2061 7373 6572 7420 6178 6973 203d 3d20   assert axis == 
-0000c170: 302c 2022 6e6f 7420 7965 7420 6675 6c6c  0, "not yet full
-0000c180: 7920 696d 706c 656d 656e 7465 6420 6f74  y implemented ot
-0000c190: 6865 7277 6973 6522 0a20 2020 2070 6164  herwise".    pad
-0000c1a0: 5f6c 6566 742c 2070 6164 5f72 6967 6874  _left, pad_right
-0000c1b0: 203d 2030 2c20 300a 2020 2020 6966 2062   = 0, 0.    if b
-0000c1c0: 6567 696e 203c 2030 3a0a 2020 2020 2020  egin < 0:.      
-0000c1d0: 2020 7061 645f 6c65 6674 203d 202d 6265    pad_left = -be
-0000c1e0: 6769 6e0a 2020 2020 2020 2020 6265 6769  gin.        begi
-0000c1f0: 6e20 3d20 300a 2020 2020 656c 6966 2062  n = 0.    elif b
-0000c200: 6567 696e 203e 3d20 782e 7368 6170 655b  egin >= x.shape[
-0000c210: 6178 6973 5d3a 0a20 2020 2020 2020 2072  axis]:.        r
-0000c220: 6574 7572 6e20 6e70 2e7a 6572 6f73 2828  eturn np.zeros((
-0000c230: 656e 6420 2d20 6265 6769 6e2c 2920 2b20  end - begin,) + 
-0000c240: 782e 7368 6170 655b 313a 5d2c 2064 7479  x.shape[1:], dty
-0000c250: 7065 3d78 2e64 7479 7065 290a 2020 2020  pe=x.dtype).    
-0000c260: 6173 7365 7274 2065 6e64 203e 3d20 6265  assert end >= be
-0000c270: 6769 6e0a 2020 2020 6966 2065 6e64 203e  gin.    if end >
-0000c280: 2078 2e73 6861 7065 5b61 7869 735d 3a0a   x.shape[axis]:.
-0000c290: 2020 2020 2020 2020 7061 645f 7269 6768          pad_righ
-0000c2a0: 7420 3d20 656e 6420 2d20 782e 7368 6170  t = end - x.shap
-0000c2b0: 655b 6178 6973 5d0a 2020 2020 2020 2020  e[axis].        
-0000c2c0: 656e 6420 3d20 782e 7368 6170 655b 6178  end = x.shape[ax
-0000c2d0: 6973 5d0a 2020 2020 7265 7475 726e 206e  is].    return n
-0000c2e0: 702e 7061 6428 785b 6265 6769 6e3a 656e  p.pad(x[begin:en
-0000c2f0: 645d 2c20 5b28 7061 645f 6c65 6674 2c20  d], [(pad_left, 
-0000c300: 7061 645f 7269 6768 7429 5d20 2b20 5b28  pad_right)] + [(
-0000c310: 302c 2030 295d 202a 2028 782e 6e64 696d  0, 0)] * (x.ndim
-0000c320: 202d 2031 292c 206d 6f64 653d 2263 6f6e   - 1), mode="con
-0000c330: 7374 616e 7422 290a 0a0a 6465 6620 7261  stant")...def ra
-0000c340: 6e64 6f6d 5f6f 7274 686f 676f 6e61 6c28  ndom_orthogonal(
-0000c350: 7368 6170 652c 2067 6169 6e3d 312e 302c  shape, gain=1.0,
-0000c360: 2073 6565 643d 4e6f 6e65 293a 0a20 2020   seed=None):.   
-0000c370: 2022 2222 0a20 2020 2052 6574 7572 6e73   """.    Returns
-0000c380: 2061 2072 616e 646f 6d20 6f72 7468 6f67   a random orthog
-0000c390: 6f6e 616c 206d 6174 7269 7820 6f66 2074  onal matrix of t
-0000c3a0: 6865 2067 6976 656e 2073 6861 7065 2e0a  he given shape..
-0000c3b0: 2020 2020 436f 6465 2062 6f72 726f 7765      Code borrowe
-0000c3c0: 6420 616e 6420 6164 6170 7465 6420 6672  d and adapted fr
-0000c3d0: 6f6d 204b 6572 6173 3a20 6874 7470 733a  om Keras: https:
-0000c3e0: 2f2f 6769 7468 7562 2e63 6f6d 2f66 6368  //github.com/fch
-0000c3f0: 6f6c 6c65 742f 6b65 7261 732f 626c 6f62  ollet/keras/blob
-0000c400: 2f6d 6173 7465 722f 6b65 7261 732f 696e  /master/keras/in
-0000c410: 6974 6961 6c69 7a65 7273 2e70 790a 2020  itializers.py.  
-0000c420: 2020 5265 6665 7265 6e63 653a 2053 6178    Reference: Sax
-0000c430: 6520 6574 2061 6c2e 2c20 6874 7470 733a  e et al., https:
-0000c440: 2f2f 6172 7869 762e 6f72 672f 6162 732f  //arxiv.org/abs/
-0000c450: 3133 3132 2e36 3132 300a 2020 2020 5265  1312.6120.    Re
-0000c460: 6c61 7465 643a 2055 6e69 7461 7279 2045  lated: Unitary E
-0000c470: 766f 6c75 7469 6f6e 2052 6563 7572 7265  volution Recurre
-0000c480: 6e74 204e 6575 7261 6c20 4e65 7477 6f72  nt Neural Networ
-0000c490: 6b73 2c20 6874 7470 733a 2f2f 6172 7869  ks, https://arxi
-0000c4a0: 762e 6f72 672f 6162 732f 3135 3131 2e30  v.org/abs/1511.0
-0000c4b0: 3634 3634 0a0a 2020 2020 3a70 6172 616d  6464..    :param
-0000c4c0: 2074 7570 6c65 5b69 6e74 5d20 7368 6170   tuple[int] shap
-0000c4d0: 653a 0a20 2020 203a 7061 7261 6d20 666c  e:.    :param fl
-0000c4e0: 6f61 7420 6761 696e 3a0a 2020 2020 3a70  oat gain:.    :p
-0000c4f0: 6172 616d 2069 6e74 2073 6565 643a 2066  aram int seed: f
-0000c500: 6f72 204e 756d 7079 2072 616e 646f 6d20  or Numpy random 
-0000c510: 6765 6e65 7261 746f 720a 2020 2020 3a72  generator.    :r
-0000c520: 6574 7572 6e3a 2072 616e 646f 6d20 6f72  eturn: random or
-0000c530: 7468 6f67 6f6e 616c 206d 6174 7269 780a  thogonal matrix.
-0000c540: 2020 2020 3a72 7479 7065 3a20 6e75 6d70      :rtype: nump
-0000c550: 792e 6e64 6172 7261 790a 2020 2020 2222  y.ndarray.    ""
-0000c560: 220a 2020 2020 6e75 6d5f 726f 7773 203d  ".    num_rows =
-0000c570: 2031 0a20 2020 2066 6f72 2064 696d 2069   1.    for dim i
-0000c580: 6e20 7368 6170 655b 3a2d 315d 3a0a 2020  n shape[:-1]:.  
-0000c590: 2020 2020 2020 6e75 6d5f 726f 7773 202a        num_rows *
-0000c5a0: 3d20 6469 6d0a 2020 2020 6e75 6d5f 636f  = dim.    num_co
-0000c5b0: 6c73 203d 2073 6861 7065 5b2d 315d 0a20  ls = shape[-1]. 
-0000c5c0: 2020 2066 6c61 745f 7368 6170 6520 3d20     flat_shape = 
-0000c5d0: 286e 756d 5f72 6f77 732c 206e 756d 5f63  (num_rows, num_c
-0000c5e0: 6f6c 7329 0a20 2020 2069 6620 7365 6564  ols).    if seed
-0000c5f0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000c600: 2020 2020 2020 726e 6420 3d20 6e70 2e72        rnd = np.r
-0000c610: 616e 646f 6d2e 5261 6e64 6f6d 5374 6174  andom.RandomStat
-0000c620: 6528 7365 6564 3d73 6565 6429 0a20 2020  e(seed=seed).   
-0000c630: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-0000c640: 6e64 203d 206e 702e 7261 6e64 6f6d 0a20  nd = np.random. 
-0000c650: 2020 2061 203d 2072 6e64 2e6e 6f72 6d61     a = rnd.norma
-0000c660: 6c28 302e 302c 2031 2e30 2c20 666c 6174  l(0.0, 1.0, flat
-0000c670: 5f73 6861 7065 290a 2020 2020 752c 205f  _shape).    u, _
-0000c680: 2c20 7620 3d20 6e70 2e6c 696e 616c 672e  , v = np.linalg.
-0000c690: 7376 6428 612c 2066 756c 6c5f 6d61 7472  svd(a, full_matr
-0000c6a0: 6963 6573 3d46 616c 7365 290a 2020 2020  ices=False).    
-0000c6b0: 2320 5069 636b 2074 6865 206f 6e65 2077  # Pick the one w
-0000c6c0: 6974 6820 7468 6520 636f 7272 6563 7420  ith the correct 
-0000c6d0: 7368 6170 652e 0a20 2020 2071 203d 2075  shape..    q = u
-0000c6e0: 2069 6620 752e 7368 6170 6520 3d3d 2066   if u.shape == f
-0000c6f0: 6c61 745f 7368 6170 6520 656c 7365 2076  lat_shape else v
-0000c700: 0a20 2020 2071 203d 2071 2e72 6573 6861  .    q = q.resha
-0000c710: 7065 2873 6861 7065 290a 2020 2020 7265  pe(shape).    re
-0000c720: 7475 726e 2067 6169 6e20 2a20 715b 3a20  turn gain * q[: 
-0000c730: 7368 6170 655b 305d 2c20 3a20 7368 6170  shape[0], : shap
-0000c740: 655b 315d 5d0a 0a0a 2320 6e6f 696e 7370  e[1]]...# noinsp
-0000c750: 6563 7469 6f6e 2050 7955 6e75 7365 644c  ection PyUnusedL
-0000c760: 6f63 616c 0a64 6566 2069 6e70 6c61 6365  ocal.def inplace
-0000c770: 5f69 6e63 7265 6d65 6e74 2878 2c20 6964  _increment(x, id
-0000c780: 782c 2079 293a 0a20 2020 2022 2222 0a20  x, y):.    """. 
-0000c790: 2020 2054 6869 7320 6261 7369 6361 6c6c     This basicall
-0000c7a0: 7920 646f 6573 2060 785b 6964 785d 202b  y does `x[idx] +
-0000c7b0: 3d20 7960 2e0a 2020 2020 5468 6520 6469  = y`..    The di
-0000c7c0: 6666 6572 656e 6365 2074 6f20 7468 6520  fference to the 
-0000c7d0: 4e75 6d70 7920 7665 7273 696f 6e20 6973  Numpy version is
-0000c7e0: 2074 6861 7420 696e 2063 6173 6520 736f   that in case so
-0000c7f0: 6d65 2069 6e64 6578 2069 7320 7468 6572  me index is ther
-0000c800: 6520 6d75 6c74 6970 6c65 0a20 2020 2074  e multiple.    t
-0000c810: 696d 6573 2c20 6974 2077 696c 6c20 6f6e  imes, it will on
-0000c820: 6c79 2062 6520 696e 6372 656d 656e 7465  ly be incremente
-0000c830: 6420 6f6e 6365 2028 616e 6420 6974 2069  d once (and it i
-0000c840: 7320 6e6f 7420 7370 6563 6966 6965 6420  s not specified 
-0000c850: 7768 6963 6820 6f6e 6529 2e0a 2020 2020  which one)..    
-0000c860: 5365 6520 616c 736f 2074 6865 616e 6f2e  See also theano.
-0000c870: 7465 6e73 6f72 2e73 7562 7465 6e73 6f72  tensor.subtensor
-0000c880: 2e41 6476 616e 6365 6449 6e63 5375 6274  .AdvancedIncSubt
-0000c890: 656e 736f 7220 646f 6375 6d65 6e74 6174  ensor documentat
-0000c8a0: 696f 6e2e 0a0a 2020 2020 3a70 6172 616d  ion...    :param
-0000c8b0: 206e 756d 7079 2e6e 6461 7272 6179 2078   numpy.ndarray x
-0000c8c0: 3a0a 2020 2020 3a70 6172 616d 206e 756d  :.    :param num
-0000c8d0: 7079 2e6e 6461 7272 6179 2069 6478 3a0a  py.ndarray idx:.
-0000c8e0: 2020 2020 3a70 6172 616d 206e 756d 7079      :param numpy
-0000c8f0: 2e6e 6461 7272 6179 2079 3a0a 2020 2020  .ndarray y:.    
-0000c900: 3a72 7479 7065 3a20 6e75 6d70 792e 6e64  :rtype: numpy.nd
-0000c910: 6172 7261 790a 2020 2020 2222 220a 2020  array.    """.  
-0000c920: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-0000c930: 6d65 6e74 6564 4572 726f 7228 2254 6869  mentedError("Thi
-0000c940: 7320 6665 6174 7572 6520 7761 7320 7265  s feature was re
-0000c950: 6d6f 7665 6420 7769 7468 2064 726f 7070  moved with dropp
-0000c960: 6564 2054 6865 616e 6f20 7375 7070 6f72  ed Theano suppor
-0000c970: 7422 290a 0a0a 6465 6620 7072 6f64 286c  t")...def prod(l
-0000c980: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
-0000c990: 3a70 6172 616d 206c 6973 745b 545d 7c74  :param list[T]|t
-0000c9a0: 7570 6c65 5b54 5d7c 6e75 6d70 792e 6e64  uple[T]|numpy.nd
-0000c9b0: 6172 7261 7920 6c73 3a0a 2020 2020 3a72  array ls:.    :r
-0000c9c0: 7479 7065 3a20 547c 696e 747c 666c 6f61  type: T|int|floa
-0000c9d0: 740a 2020 2020 2222 220a 2020 2020 6966  t.    """.    if
-0000c9e0: 206c 656e 286c 7329 203d 3d20 303a 0a20   len(ls) == 0:. 
-0000c9f0: 2020 2020 2020 2072 6574 7572 6e20 310a         return 1.
-0000ca00: 2020 2020 7820 3d20 6c73 5b30 5d0a 2020      x = ls[0].  
-0000ca10: 2020 666f 7220 7920 696e 206c 735b 313a    for y in ls[1:
-0000ca20: 5d3a 0a20 2020 2020 2020 2078 203d 2078  ]:.        x = x
-0000ca30: 202a 2079 2020 2320 2a3d 2064 6f65 736e   * y  # *= doesn
-0000ca40: 2774 2077 6f72 6b20 6265 6361 7573 6520  't work because 
-0000ca50: 7820 6d69 6768 7420 6265 2061 2074 656e  x might be a ten
-0000ca60: 736f 722c 2061 6e64 2066 6f72 2065 2e67  sor, and for e.g
-0000ca70: 2e20 746f 7263 682e 5465 6e73 6f72 2074  . torch.Tensor t
-0000ca80: 6869 7320 6f70 2069 7320 696e 2d70 6c61  his op is in-pla
-0000ca90: 6365 0a20 2020 2072 6574 7572 6e20 780a  ce.    return x.
-0000caa0: 0a0a 6465 6620 7061 7273 655f 6f72 7468  ..def parse_orth
-0000cab0: 6f67 7261 7068 795f 696e 746f 5f73 796d  ography_into_sym
-0000cac0: 626f 6c73 280a 2020 2020 6f72 7468 6f67  bols(.    orthog
-0000cad0: 7261 7068 792c 2075 7070 6572 5f63 6173  raphy, upper_cas
-0000cae0: 655f 7370 6563 6961 6c3d 5472 7565 2c20  e_special=True, 
-0000caf0: 776f 7264 5f62 6173 6564 3d46 616c 7365  word_based=False
-0000cb00: 2c20 7371 7561 7265 5f62 7261 636b 6574  , square_bracket
-0000cb10: 735f 666f 725f 7370 6563 6961 6c73 3d54  s_for_specials=T
-0000cb20: 7275 650a 293a 0a20 2020 2022 2222 0a20  rue.):.    """. 
-0000cb30: 2020 2046 6f72 2053 7065 6563 682e 0a20     For Speech.. 
-0000cb40: 2020 2045 7861 6d70 6c65 3a0a 2020 2020     Example:.    
-0000cb50: 2020 6f72 7468 6f67 7261 7068 7920 3d20    orthography = 
-0000cb60: 2268 656c 6c6f 205b 4845 5349 5441 5449  "hello [HESITATI
-0000cb70: 4f4e 5d20 7468 6572 6520 220a 2020 2020  ON] there ".    
-0000cb80: 2020 7769 7468 2077 6f72 645f 6261 7365    with word_base
-0000cb90: 6420 3d3d 2046 616c 7365 3a20 7265 7475  d == False: retu
-0000cba0: 726e 7320 6c69 7374 2822 6865 6c6c 6f20  rns list("hello 
-0000cbb0: 2229 202b 205b 225b 4845 5349 5441 5449  ") + ["[HESITATI
-0000cbc0: 4f4e 5d22 5d20 2b20 6c69 7374 2822 2074  ON]"] + list(" t
-0000cbd0: 6865 7265 2022 292e 0a20 2020 2020 2077  here ")..      w
-0000cbe0: 6974 6820 776f 7264 5f62 6173 6564 203d  ith word_based =
-0000cbf0: 3d20 5472 7565 3a20 7265 7475 726e 7320  = True: returns 
-0000cc00: 5b22 6865 6c6c 6f22 2c20 225b 4845 5349  ["hello", "[HESI
-0000cc10: 5441 5449 4f4e 5d22 2c20 2274 6865 7265  TATION]", "there
-0000cc20: 225d 0a20 2020 204e 6f20 7072 652f 706f  "].    No pre/po
-0000cc30: 7374 2d70 726f 6365 7373 696e 6720 7375  st-processing su
-0000cc40: 6368 2061 733a 0a20 2020 2053 7061 6365  ch as:.    Space
-0000cc50: 7320 6172 6520 6b65 7074 2061 732d 6973  s are kept as-is
-0000cc60: 2e20 4e6f 2073 7472 6970 7069 6e67 2061  . No stripping a
-0000cc70: 7420 6265 6769 6e2f 656e 642e 2028 452e  t begin/end. (E.
-0000cc80: 672e 2074 7261 696c 696e 6720 7370 6163  g. trailing spac
-0000cc90: 6573 2061 7265 206e 6f74 2072 656d 6f76  es are not remov
-0000cca0: 6564 2e29 0a20 2020 204e 6f20 746f 6c6f  ed.).    No tolo
-0000ccb0: 7765 722f 746f 7570 7065 722e 0a20 2020  wer/toupper..   
-0000ccc0: 2044 6f65 736e 2774 2061 6464 205b 4245   Doesn't add [BE
-0000ccd0: 4749 4e5d 2f5b 454e 445d 2073 796d 626f  GIN]/[END] symbo
-0000cce0: 6c73 206f 7220 736f 2e0a 2020 2020 416e  ls or so..    An
-0000ccf0: 7920 7375 6368 206f 7065 7261 7469 6f6e  y such operation
-0000cd00: 7320 7368 6f75 6c64 2062 6520 646f 6e65  s should be done
-0000cd10: 2065 7870 6c69 6369 746c 7920 696e 2061   explicitly in a
-0000cd20: 6e20 6164 6469 7469 6f6e 616c 2066 756e  n additional fun
-0000cd30: 6374 696f 6e2e 0a20 2020 2041 6e79 7468  ction..    Anyth
-0000cd40: 696e 6720 696e 205b 5d2d 6272 6163 6b65  ing in []-bracke
-0000cd50: 7473 2061 7265 206d 6561 6e74 2061 7320  ts are meant as 
-0000cd60: 7370 6563 6961 6c2d 7379 6d62 6f6c 732e  special-symbols.
-0000cd70: 0a20 2020 2041 6c73 6f20 7365 6520 7061  .    Also see pa
-0000cd80: 7273 655f 6f72 7468 6f67 7261 7068 7928  rse_orthography(
-0000cd90: 2920 7768 6963 6820 696e 636c 7564 6573  ) which includes
-0000cda0: 2073 6f6d 6520 7072 6570 726f 6365 7373   some preprocess
-0000cdb0: 696e 672e 0a0a 2020 2020 3a70 6172 616d  ing...    :param
-0000cdc0: 2073 7472 206f 7274 686f 6772 6170 6879   str orthography
-0000cdd0: 3a20 6578 616d 706c 653a 2022 6865 6c6c  : example: "hell
-0000cde0: 6f20 5b48 4553 4954 4154 494f 4e5d 2074  o [HESITATION] t
-0000cdf0: 6865 7265 2022 0a20 2020 203a 7061 7261  here ".    :para
-0000ce00: 6d20 626f 6f6c 2075 7070 6572 5f63 6173  m bool upper_cas
-0000ce10: 655f 7370 6563 6961 6c3a 2077 6865 7468  e_special: wheth
-0000ce20: 6572 2074 6865 2073 7065 6369 616c 2073  er the special s
-0000ce30: 796d 626f 6c73 2061 7265 2061 6c77 6179  ymbols are alway
-0000ce40: 7320 6d61 6465 2075 7070 6572 2063 6173  s made upper cas
-0000ce50: 650a 2020 2020 3a70 6172 616d 2062 6f6f  e.    :param boo
-0000ce60: 6c20 776f 7264 5f62 6173 6564 3a20 7768  l word_based: wh
-0000ce70: 6574 6865 7220 7765 2073 706c 6974 206f  ether we split o
-0000ce80: 6e20 7370 6163 6520 616e 6420 7265 7475  n space and retu
-0000ce90: 726e 2066 756c 6c20 776f 7264 730a 2020  rn full words.  
-0000cea0: 2020 3a70 6172 616d 2062 6f6f 6c20 7371    :param bool sq
-0000ceb0: 7561 7265 5f62 7261 636b 6574 735f 666f  uare_brackets_fo
-0000cec0: 725f 7370 6563 6961 6c73 3a20 6861 6e64  r_specials: hand
-0000ced0: 6c65 2022 5b2e 2e2e 5d22 0a20 2020 203a  le "[...]".    :
-0000cee0: 7274 7970 653a 206c 6973 745b 7374 725d  rtype: list[str]
-0000cef0: 0a20 2020 2022 2222 0a20 2020 2072 6574  .    """.    ret
-0000cf00: 203d 205b 5d0a 2020 2020 696e 5f73 7065   = [].    in_spe
-0000cf10: 6369 616c 203d 2030 0a20 2020 2066 6f72  cial = 0.    for
-0000cf20: 2063 2069 6e20 6f72 7468 6f67 7261 7068   c in orthograph
-0000cf30: 793a 0a20 2020 2020 2020 2069 6620 696e  y:.        if in
-0000cf40: 5f73 7065 6369 616c 3a0a 2020 2020 2020  _special:.      
-0000cf50: 2020 2020 2020 6966 2063 203d 3d20 225b        if c == "[
-0000cf60: 223a 2020 2320 7370 6563 6961 6c2d 7370  ":  # special-sp
-0000cf70: 6563 6961 6c0a 2020 2020 2020 2020 2020  ecial.          
-0000cf80: 2020 2020 2020 696e 5f73 7065 6369 616c        in_special
-0000cf90: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-0000cfa0: 2020 2020 2020 7265 745b 2d31 5d20 2b3d        ret[-1] +=
-0000cfb0: 2022 5b22 0a20 2020 2020 2020 2020 2020   "[".           
-0000cfc0: 2065 6c69 6620 6320 3d3d 2022 5d22 3a0a   elif c == "]":.
-0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfe0: 696e 5f73 7065 6369 616c 202d 3d20 310a  in_special -= 1.
+0000a710: 2020 2020 6966 2050 5933 3a0a 2020 2020      if PY3:.    
+0000a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a730: 2020 2020 7768 696c 6520 6e6f 7420 6c6f      while not lo
+0000a740: 636b 5f61 6371 7569 7265 5f6f 7269 6728  ck_acquire_orig(
+0000a750: 6c6f 636b 2c20 626c 6f63 6b69 6e67 3d54  lock, blocking=T
+0000a760: 7275 652c 2074 696d 656f 7574 3d30 2e31  rue, timeout=0.1
+0000a770: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000a780: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000a790: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+0000a7a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000a7b0: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
+0000a7c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000a7d0: 3a20 2023 2050 7974 686f 6e20 322e 2063  :  # Python 2. c
+0000a7e0: 616e 6e6f 7420 7573 6520 7469 6d65 6f75  annot use timeou
+0000a7f0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0000a800: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+0000a810: 6e6f 7420 6c6f 636b 5f61 6371 7569 7265  not lock_acquire
+0000a820: 5f6f 7269 6728 6c6f 636b 2c20 626c 6f63  _orig(lock, bloc
+0000a830: 6b69 6e67 3d46 616c 7365 293a 0a20 2020  king=False):.   
+0000a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a850: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+0000a860: 6565 7028 302e 3129 0a20 2020 2020 2020  eep(0.1).       
+0000a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a880: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
+0000a890: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000a8a0: 653a 2020 2320 7469 6d65 6f75 7420 6973  e:  # timeout is
+0000a8b0: 2073 6574 2e20 2843 616e 206f 6e6c 7920   set. (Can only 
+0000a8c0: 6265 2077 6974 6820 5079 7468 6f6e 2033  be with Python 3
+0000a8d0: 2e29 0a20 2020 2020 2020 2020 2020 2020  .).             
+0000a8e0: 2020 2020 2020 2023 2055 7365 2061 2063         # Use a c
+0000a8f0: 6170 7065 6420 7469 6d65 6f75 742e 2054  apped timeout. T
+0000a900: 6869 7320 7368 6f75 6c64 206e 6f74 206d  his should not m
+0000a910: 6174 7465 7220 666f 7220 7468 6520 756e  atter for the un
+0000a920: 6465 726c 7969 6e67 2063 6f64 652e 0a20  derlying code.. 
+0000a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a940: 2020 2072 6574 7572 6e20 6c6f 636b 5f61     return lock_a
+0000a950: 6371 7569 7265 5f6f 7269 6728 6c6f 636b  cquire_orig(lock
+0000a960: 2c20 626c 6f63 6b69 6e67 3d54 7275 652c  , blocking=True,
+0000a970: 2074 696d 656f 7574 3d6d 696e 2874 696d   timeout=min(tim
+0000a980: 656f 7574 2c20 302e 3129 290a 2020 2020  eout, 0.1)).    
+0000a990: 2020 2020 2020 2020 2320 4661 6c6c 6261          # Fallba
+0000a9a0: 636b 2074 6f20 6465 6661 756c 742e 0a20  ck to default.. 
+0000a9b0: 2020 2020 2020 2020 2020 2069 6620 5059             if PY
+0000a9c0: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
+0000a9d0: 2020 2072 6574 7572 6e20 6c6f 636b 5f61     return lock_a
+0000a9e0: 6371 7569 7265 5f6f 7269 6728 6c6f 636b  cquire_orig(lock
+0000a9f0: 2c20 626c 6f63 6b69 6e67 3d54 7275 652c  , blocking=True,
+0000aa00: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
+0000aa10: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000aa20: 7475 726e 206c 6f63 6b5f 6163 7175 6972  turn lock_acquir
+0000aa30: 655f 6f72 6967 286c 6f63 6b2c 2062 6c6f  e_orig(lock, blo
+0000aa40: 636b 696e 673d 5472 7565 290a 0a20 2020  cking=True)..   
+0000aa50: 2020 2020 204c 6f63 6b2e 6163 7175 6972       Lock.acquir
+0000aa60: 6520 3d20 6c6f 636b 5f61 6371 7569 7265  e = lock_acquire
+0000aa70: 5f68 6163 6b65 640a 0a0a 6465 6620 7374  _hacked...def st
+0000aa80: 6172 745f 6461 656d 6f6e 5f74 6872 6561  art_daemon_threa
+0000aa90: 6428 7461 7267 6574 2c20 6172 6773 3d28  d(target, args=(
+0000aaa0: 2929 3a0a 2020 2020 2222 220a 2020 2020  )):.    """.    
+0000aab0: 3a70 6172 616d 2028 292d 3e4e 6f6e 6520  :param ()->None 
+0000aac0: 7461 7267 6574 3a0a 2020 2020 3a70 6172  target:.    :par
+0000aad0: 616d 2074 7570 6c65 2061 7267 733a 0a20  am tuple args:. 
+0000aae0: 2020 203a 7265 7475 726e 3a20 6e6f 7468     :return: noth
+0000aaf0: 696e 670a 2020 2020 2222 220a 2020 2020  ing.    """.    
+0000ab00: 6672 6f6d 2074 6872 6561 6469 6e67 2069  from threading i
+0000ab10: 6d70 6f72 7420 5468 7265 6164 0a0a 2020  mport Thread..  
+0000ab20: 2020 7420 3d20 5468 7265 6164 2874 6172    t = Thread(tar
+0000ab30: 6765 743d 7461 7267 6574 2c20 6172 6773  get=target, args
+0000ab40: 3d61 7267 7329 0a20 2020 2074 2e64 6165  =args).    t.dae
+0000ab50: 6d6f 6e20 3d20 5472 7565 0a20 2020 2074  mon = True.    t
+0000ab60: 2e73 7461 7274 2829 0a0a 0a64 6566 2069  .start()...def i
+0000ab70: 735f 7175 6974 7469 6e67 2829 3a0a 2020  s_quitting():.  
+0000ab80: 2020 2222 220a 2020 2020 3a72 6574 7572    """.    :retur
+0000ab90: 6e3a 2077 6865 7468 6572 2077 6520 6172  n: whether we ar
+0000aba0: 6520 6375 7272 656e 746c 7920 7175 6974  e currently quit
+0000abb0: 7469 6e67 2028 7669 6120 3a66 756e 633a  ting (via :func:
+0000abc0: 6072 6e6e 2e66 696e 616c 697a 6560 290a  `rnn.finalize`).
+0000abd0: 2020 2020 3a72 7479 7065 3a20 626f 6f6c      :rtype: bool
+0000abe0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+0000abf0: 6f72 7420 7265 7475 726e 6e2e 5f5f 6d61  ort returnn.__ma
+0000ac00: 696e 5f5f 2061 7320 726e 6e0a 0a20 2020  in__ as rnn..   
+0000ac10: 2069 6620 726e 6e2e 7175 6974 5f72 6574   if rnn.quit_ret
+0000ac20: 7572 6e6e 3a20 2023 2076 6961 2072 6e6e  urnn:  # via rnn
+0000ac30: 2e66 696e 616c 697a 6528 290a 2020 2020  .finalize().    
+0000ac40: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+0000ac50: 2020 2020 6966 2067 6574 6174 7472 2873      if getattr(s
+0000ac60: 7973 2c20 2265 7869 7465 6422 2c20 4661  ys, "exited", Fa
+0000ac70: 6c73 6529 3a20 2023 2073 6574 2076 6961  lse):  # set via
+0000ac80: 2044 6562 7567 206d 6f64 756c 6520 7768   Debug module wh
+0000ac90: 656e 2061 6e20 756e 6578 7065 6374 6564  en an unexpected
+0000aca0: 2053 4947 494e 5420 6f63 6375 7273 2c20   SIGINT occurs, 
+0000acb0: 6f72 2068 6572 650a 2020 2020 2020 2020  or here.        
+0000acc0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
+0000acd0: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
+0000ace0: 6566 2069 6e74 6572 7275 7074 5f6d 6169  ef interrupt_mai
+0000acf0: 6e28 293a 0a20 2020 2022 2222 0a20 2020  n():.    """.   
+0000ad00: 2053 656e 6473 203a 636c 6173 733a 604b   Sends :class:`K
+0000ad10: 6579 626f 6172 6449 6e74 6572 7275 7074  eyboardInterrupt
+0000ad20: 6020 746f 2074 6865 206d 6169 6e20 7468  ` to the main th
+0000ad30: 7265 6164 2e0a 0a20 2020 203a 7265 7475  read...    :retu
+0000ad40: 726e 3a20 6e6f 7468 696e 670a 2020 2020  rn: nothing.    
+0000ad50: 2222 220a 2020 2020 2320 6e6f 696e 7370  """.    # noinsp
+0000ad60: 6563 7469 6f6e 2050 7950 726f 7465 6374  ection PyProtect
+0000ad70: 6564 4d65 6d62 6572 2c50 7955 6e72 6573  edMember,PyUnres
+0000ad80: 6f6c 7665 6452 6566 6572 656e 6365 730a  olvedReferences.
+0000ad90: 2020 2020 6973 5f6d 6169 6e5f 7468 7265      is_main_thre
+0000ada0: 6164 203d 2069 7369 6e73 7461 6e63 6528  ad = isinstance(
+0000adb0: 7468 7265 6164 696e 672e 6375 7272 656e  threading.curren
+0000adc0: 7454 6872 6561 6428 292c 2074 6872 6561  tThread(), threa
+0000add0: 6469 6e67 2e5f 4d61 696e 5468 7265 6164  ding._MainThread
+0000ade0: 290a 2020 2020 6966 2069 735f 7175 6974  ).    if is_quit
+0000adf0: 7469 6e67 2829 3a20 2023 2069 676e 6f72  ting():  # ignor
+0000ae00: 6520 6966 2077 6520 6172 6520 616c 7265  e if we are alre
+0000ae10: 6164 7920 7175 6974 7469 6e67 0a20 2020  ady quitting.   
+0000ae20: 2020 2020 2069 6620 6973 5f6d 6169 6e5f       if is_main_
+0000ae30: 7468 7265 6164 3a20 2023 2073 7472 616e  thread:  # stran
+0000ae40: 6765 2074 6f20 6765 7420 6167 6169 6e20  ge to get again 
+0000ae50: 696e 206d 6169 6e20 7468 7265 6164 0a20  in main thread. 
+0000ae60: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000ae70: 2045 7863 6570 7469 6f6e 2822 696e 7465   Exception("inte
+0000ae80: 7272 7570 745f 6d61 696e 2829 2066 726f  rrupt_main() fro
+0000ae90: 6d20 6d61 696e 2074 6872 6561 6420 7768  m main thread wh
+0000aea0: 696c 6520 616c 7265 6164 7920 7175 6974  ile already quit
+0000aeb0: 7469 6e67 2229 0a20 2020 2020 2020 2023  ting").        #
+0000aec0: 204e 6f74 206d 6169 6e20 7468 7265 6164   Not main thread
+0000aed0: 2e20 5468 6973 2077 696c 6c20 6a75 7374  . This will just
+0000aee0: 2065 7869 7420 7468 6520 7468 7265 6164   exit the thread
+0000aef0: 2e0a 2020 2020 2020 2020 7379 732e 6578  ..        sys.ex
+0000af00: 6974 2831 290a 2020 2020 7379 732e 6578  it(1).    sys.ex
+0000af10: 6974 6564 203d 2054 7275 6520 2023 2044  ited = True  # D
+0000af20: 6f6e 2774 2064 6f20 6974 2074 7769 6365  on't do it twice
+0000af30: 2e0a 2020 2020 2320 6e6f 696e 7370 6563  ..    # noinspec
+0000af40: 7469 6f6e 2050 7950 726f 7465 6374 6564  tion PyProtected
+0000af50: 4d65 6d62 6572 2c50 7955 6e72 6573 6f6c  Member,PyUnresol
+0000af60: 7665 6452 6566 6572 656e 6365 730a 2020  vedReferences.  
+0000af70: 2020 7379 732e 6578 6974 6564 5f66 7261    sys.exited_fra
+0000af80: 6d65 203d 2073 7973 2e5f 6765 7466 7261  me = sys._getfra
+0000af90: 6d65 2829 0a20 2020 2069 6620 6973 5f6d  me().    if is_m
+0000afa0: 6169 6e5f 7468 7265 6164 3a0a 2020 2020  ain_thread:.    
+0000afb0: 2020 2020 7261 6973 6520 4b65 7962 6f61      raise Keyboa
+0000afc0: 7264 496e 7465 7272 7570 740a 2020 2020  rdInterrupt.    
+0000afd0: 656c 7365 3a0a 2020 2020 2020 2020 7468  else:.        th
+0000afe0: 7265 6164 2e69 6e74 6572 7275 7074 5f6d  read.interrupt_m
+0000aff0: 6169 6e28 290a 2020 2020 2020 2020 7379  ain().        sy
+0000b000: 732e 6578 6974 2831 2920 2023 2041 6e64  s.exit(1)  # And
+0000b010: 2065 7869 7420 7468 6520 7468 7265 6164   exit the thread
+0000b020: 2e0a 0a0a 636c 6173 7320 4173 796e 6354  ....class AsyncT
+0000b030: 6872 6561 6452 756e 2874 6872 6561 6469  hreadRun(threadi
+0000b040: 6e67 2e54 6872 6561 6429 3a0a 2020 2020  ng.Thread):.    
+0000b050: 2222 220a 2020 2020 4461 656d 6f6e 2074  """.    Daemon t
+0000b060: 6872 6561 642c 2077 7261 7070 696e 6720  hread, wrapping 
+0000b070: 736f 6d65 2066 756e 6374 696f 6e20 6060  some function ``
+0000b080: 6675 6e63 6060 2076 6961 203a 6675 6e63  func`` via :func
+0000b090: 3a60 7772 6170 5f61 7379 6e63 5f66 756e  :`wrap_async_fun
+0000b0a0: 6360 2e0a 2020 2020 2222 220a 0a20 2020  c`..    """..   
+0000b0b0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000b0c0: 6c66 2c20 6e61 6d65 2c20 6675 6e63 293a  lf, name, func):
+0000b0d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000b0e0: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
+0000b0f0: 6e61 6d65 3a0a 2020 2020 2020 2020 3a70  name:.        :p
+0000b100: 6172 616d 2028 292d 3e54 2066 756e 633a  aram ()->T func:
+0000b110: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000b120: 2020 2020 2073 7570 6572 2841 7379 6e63       super(Async
+0000b130: 5468 7265 6164 5275 6e2c 2073 656c 6629  ThreadRun, self)
+0000b140: 2e5f 5f69 6e69 745f 5f28 6e61 6d65 3d6e  .__init__(name=n
+0000b150: 616d 652c 2074 6172 6765 743d 7365 6c66  ame, target=self
+0000b160: 2e6d 6169 6e29 0a20 2020 2020 2020 2073  .main).        s
+0000b170: 656c 662e 6675 6e63 203d 2066 756e 630a  elf.func = func.
+0000b180: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+0000b190: 756c 7420 3d20 4e6f 6e65 0a20 2020 2020  ult = None.     
+0000b1a0: 2020 2073 656c 662e 6461 656d 6f6e 203d     self.daemon =
+0000b1b0: 2054 7275 650a 2020 2020 2020 2020 7365   True.        se
+0000b1c0: 6c66 2e73 7461 7274 2829 0a0a 2020 2020  lf.start()..    
+0000b1d0: 6465 6620 6d61 696e 2873 656c 6629 3a0a  def main(self):.
+0000b1e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000b1f0: 2020 2020 5468 7265 6164 2074 6172 6765      Thread targe
+0000b200: 7420 6675 6e63 7469 6f6e 2e0a 0a20 2020  t function...   
+0000b210: 2020 2020 203a 7265 7475 726e 3a20 6e6f       :return: no
+0000b220: 7468 696e 672c 2077 696c 6c20 6a75 7374  thing, will just
+0000b230: 2073 6574 2073 656c 662e 7265 7375 6c74   set self.result
+0000b240: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000b250: 2020 2020 2073 656c 662e 7265 7375 6c74       self.result
+0000b260: 203d 2077 7261 705f 6173 796e 635f 6675   = wrap_async_fu
+0000b270: 6e63 2873 656c 662e 6675 6e63 290a 0a20  nc(self.func).. 
+0000b280: 2020 2064 6566 2067 6574 2873 656c 6629     def get(self)
+0000b290: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000b2a0: 2020 2020 2020 3a72 6574 7572 6e3a 206a        :return: j
+0000b2b0: 6f69 6e73 2074 6865 2074 6872 6561 642c  oins the thread,
+0000b2c0: 2061 6e64 2074 6865 6e20 7265 7475 726e   and then return
+0000b2d0: 7320 7468 6520 7265 7375 6c74 0a20 2020  s the result.   
+0000b2e0: 2020 2020 203a 7274 7970 653a 2054 0a20       :rtype: T. 
+0000b2f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000b300: 2020 2073 656c 662e 6a6f 696e 2829 0a20     self.join(). 
+0000b310: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000b320: 6c66 2e72 6573 756c 740a 0a0a 6465 6620  lf.result...def 
+0000b330: 7772 6170 5f61 7379 6e63 5f66 756e 6328  wrap_async_func(
+0000b340: 6629 3a0a 2020 2020 2222 220a 2020 2020  f):.    """.    
+0000b350: 4361 6c6c 7320 6060 6628 2960 6020 616e  Calls ``f()`` an
+0000b360: 6420 7265 7475 726e 7320 7468 6520 7265  d returns the re
+0000b370: 7375 6c74 2e0a 2020 2020 5772 6170 7065  sult..    Wrappe
+0000b380: 6420 7570 2077 6974 6820 6361 7463 6869  d up with catchi
+0000b390: 6e67 2061 6c6c 2065 7863 6570 7469 6f6e  ng all exception
+0000b3a0: 732c 2070 7269 6e74 696e 6720 7374 6163  s, printing stac
+0000b3b0: 6b20 7472 6163 652c 2061 6e64 203a 6675  k trace, and :fu
+0000b3c0: 6e63 3a60 696e 7465 7272 7570 745f 6d61  nc:`interrupt_ma
+0000b3d0: 696e 602e 0a0a 2020 2020 3a70 6172 616d  in`...    :param
+0000b3e0: 2028 292d 3e54 2066 3a0a 2020 2020 3a72   ()->T f:.    :r
+0000b3f0: 7479 7065 3a20 540a 2020 2020 2222 220a  type: T.    """.
+0000b400: 2020 2020 2320 6e6f 696e 7370 6563 7469      # noinspecti
+0000b410: 6f6e 2050 7942 726f 6164 4578 6365 7074  on PyBroadExcept
+0000b420: 696f 6e0a 2020 2020 7472 793a 0a20 2020  ion.    try:.   
+0000b430: 2020 2020 2066 726f 6d20 7265 7475 726e       from return
+0000b440: 6e2e 7574 696c 2069 6d70 6f72 7420 6265  n.util import be
+0000b450: 7474 6572 5f65 7863 686f 6f6b 0a0a 2020  tter_exchook..  
+0000b460: 2020 2020 2020 6265 7474 6572 5f65 7863        better_exc
+0000b470: 686f 6f6b 2e69 6e73 7461 6c6c 2829 0a20  hook.install(). 
+0000b480: 2020 2020 2020 2072 6574 7572 6e20 6628         return f(
+0000b490: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
+0000b4a0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
+0000b4b0: 7379 732e 6578 6365 7074 686f 6f6b 282a  sys.excepthook(*
+0000b4c0: 7379 732e 6578 635f 696e 666f 2829 290a  sys.exc_info()).
+0000b4d0: 2020 2020 2020 2020 696e 7465 7272 7570          interrup
+0000b4e0: 745f 6d61 696e 2829 0a0a 0a64 6566 2074  t_main()...def t
+0000b4f0: 7279 5f72 756e 2866 756e 632c 2061 7267  ry_run(func, arg
+0000b500: 733d 2829 2c20 6361 7463 685f 6578 633d  s=(), catch_exc=
+0000b510: 4578 6365 7074 696f 6e2c 2064 6566 6175  Exception, defau
+0000b520: 6c74 3d4e 6f6e 6529 3a0a 2020 2020 2222  lt=None):.    ""
+0000b530: 220a 2020 2020 3a70 6172 616d 2028 2829  ".    :param (()
+0000b540: 2d3e 5429 7c28 2858 292d 3e54 2920 6675  ->T)|((X)->T) fu
+0000b550: 6e63 3a0a 2020 2020 3a70 6172 616d 2074  nc:.    :param t
+0000b560: 7570 6c65 2061 7267 733a 0a20 2020 203a  uple args:.    :
+0000b570: 7061 7261 6d20 7479 7065 5b45 7863 6570  param type[Excep
+0000b580: 7469 6f6e 5d20 6361 7463 685f 6578 633a  tion] catch_exc:
+0000b590: 0a20 2020 203a 7061 7261 6d20 5432 2064  .    :param T2 d
+0000b5a0: 6566 6175 6c74 3a0a 2020 2020 3a72 6574  efault:.    :ret
+0000b5b0: 7572 6e3a 2065 6974 6865 7220 6060 6675  urn: either ``fu
+0000b5c0: 6e63 2829 6060 206f 7220 6060 6465 6661  nc()`` or ``defa
+0000b5d0: 756c 7460 6020 6966 2074 6865 7265 2077  ult`` if there w
+0000b5e0: 6173 2073 6f6d 6520 6578 6365 7074 696f  as some exceptio
+0000b5f0: 6e0a 2020 2020 3a72 7479 7065 3a20 547c  n.    :rtype: T|
+0000b600: 5432 0a20 2020 2022 2222 0a20 2020 2023  T2.    """.    #
+0000b610: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
+0000b620: 4272 6f61 6445 7863 6570 7469 6f6e 0a20  BroadException. 
+0000b630: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000b640: 7265 7475 726e 2066 756e 6328 2a61 7267  return func(*arg
+0000b650: 7329 0a20 2020 2065 7863 6570 7420 6361  s).    except ca
+0000b660: 7463 685f 6578 633a 0a20 2020 2020 2020  tch_exc:.       
+0000b670: 2072 6574 7572 6e20 6465 6661 756c 740a   return default.
+0000b680: 0a0a 6465 6620 7661 6c69 6461 7465 5f62  ..def validate_b
+0000b690: 726f 6164 6361 7374 5f61 6c6c 5f73 6f75  roadcast_all_sou
+0000b6a0: 7263 6573 2861 6c6c 6f77 5f62 726f 6164  rces(allow_broad
+0000b6b0: 6361 7374 5f61 6c6c 5f73 6f75 7263 6573  cast_all_sources
+0000b6c0: 2c20 696e 7075 7473 2c20 636f 6d6d 6f6e  , inputs, common
+0000b6d0: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+0000b6e0: 616c 6c20 7468 6973 2077 6865 6e20 616c  all this when al
+0000b6f0: 6c20 696e 7075 7473 2074 6f20 736f 6d65  l inputs to some
+0000b700: 206f 7065 7261 7469 6f6e 2028 6c61 7965   operation (laye
+0000b710: 7229 206d 7573 7420 6265 2062 726f 6164  r) must be broad
+0000b720: 6361 7374 6564 2e0a 2020 2020 4974 2063  casted..    It c
+0000b730: 6865 636b 7320 7768 6574 6865 7220 6272  hecks whether br
+0000b740: 6f61 6463 6173 7469 6e67 2074 6f20 616c  oadcasting to al
+0000b750: 6c20 736f 7572 6365 7320 7368 6f75 6c64  l sources should
+0000b760: 2062 6520 616c 6c6f 7765 642e 0a20 2020   be allowed..   
+0000b770: 2045 2e67 2e20 666f 7220 696e 7075 7420   E.g. for input 
+0000b780: 5b42 2c54 312c 4431 5d20 2b20 5b42 2c54  [B,T1,D1] + [B,T
+0000b790: 322c 4432 5d2c 2077 6865 6e20 616c 6c6f  2,D2], when allo
+0000b7a0: 7765 642c 2069 7420 776f 756c 6420 6272  wed, it would br
+0000b7b0: 6f61 6463 6173 7420 746f 205b 422c 5431  oadcast to [B,T1
+0000b7c0: 2c54 322c 4431 2c44 325d 2e0a 2020 2020  ,T2,D1,D2]..    
+0000b7d0: 5768 656e 206e 6f74 2061 6c6c 6f77 6564  When not allowed
+0000b7e0: 2c20 7468 6572 6520 6d75 7374 2062 6520  , there must be 
+0000b7f0: 6174 206c 6561 7374 206f 6e65 2073 6f75  at least one sou
+0000b800: 7263 6520 7768 6572 6520 6e6f 2062 726f  rce where no bro
+0000b810: 6164 6361 7374 696e 6720 7769 6c6c 2062  adcasting will b
+0000b820: 6520 646f 6e65 2e0a 2020 2020 5768 6574  e done..    Whet
+0000b830: 6865 7220 6974 2069 7320 616c 6c6f 7765  her it is allowe
+0000b840: 642c 2074 6869 7320 6465 7065 6e64 7320  d, this depends 
+0000b850: 6f6e 2074 6865 2062 6568 6176 696f 7220  on the behavior 
+0000b860: 7665 7273 696f 6e2e 0a20 2020 2020 2068  version..      h
+0000b870: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+0000b880: 6d2f 7277 7468 2d69 362f 7265 7475 726e  m/rwth-i6/return
+0000b890: 6e2f 6973 7375 6573 2f36 3931 0a0a 2020  n/issues/691..  
+0000b8a0: 2020 436f 6d6d 6f6e 2075 7361 6765 7320    Common usages 
+0000b8b0: 6172 6520 666f 7220 3a66 756e 633a 6067  are for :func:`g
+0000b8c0: 6574 5f63 6f6d 6d6f 6e5f 7368 6170 6560  et_common_shape`
+0000b8d0: 206f 7220 3a66 756e 633a 6044 6174 612e   or :func:`Data.
+0000b8e0: 6765 745f 636f 6d6d 6f6e 5f64 6174 6160  get_common_data`
+0000b8f0: 2e0a 0a20 2020 203a 7061 7261 6d20 626f  ...    :param bo
+0000b900: 6f6c 7c4e 6f74 5370 6563 6966 6965 6420  ol|NotSpecified 
+0000b910: 616c 6c6f 775f 6272 6f61 6463 6173 745f  allow_broadcast_
+0000b920: 616c 6c5f 736f 7572 6365 733a 0a20 2020  all_sources:.   
+0000b930: 203a 7061 7261 6d20 696e 7075 7473 3a20   :param inputs: 
+0000b940: 616e 7974 6869 6e67 2063 6f6e 7665 7274  anything convert
+0000b950: 6962 6c65 2074 6f20 6974 6572 6162 6c65  ible to iterable
+0000b960: 206f 6620 7374 722c 2075 7365 6420 666f   of str, used fo
+0000b970: 7220 7265 706f 7274 696e 670a 2020 2020  r reporting.    
+0000b980: 3a70 6172 616d 2063 6f6d 6d6f 6e3a 2061  :param common: a
+0000b990: 6e79 7468 696e 6720 636f 6e76 6572 7469  nything converti
+0000b9a0: 626c 6520 746f 2073 7472 2c20 7573 6564  ble to str, used
+0000b9b0: 2066 6f72 2072 6570 6f72 7469 6e67 0a20   for reporting. 
+0000b9c0: 2020 2022 2222 0a20 2020 206d 7367 203d     """.    msg =
+0000b9d0: 2028 0a20 2020 2020 2020 2022 416c 6c20   (.        "All 
+0000b9e0: 696e 7075 7473 5c6e 2573 5c6e 7265 7175  inputs\n%s\nrequ
+0000b9f0: 6972 6520 6272 6f61 6463 6173 7469 6e67  ire broadcasting
+0000ba00: 2074 6f20 5c6e 2020 2573 2e5c 6e22 2025   to \n  %s.\n" %
+0000ba10: 2028 225c 6e22 2e6a 6f69 6e28 2220 2d20   ("\n".join(" - 
+0000ba20: 2573 2220 2520 696e 7020 666f 7220 696e  %s" % inp for in
+0000ba30: 7020 696e 2069 6e70 7574 7329 2c20 636f  p in inputs), co
+0000ba40: 6d6d 6f6e 290a 2020 2020 2020 2020 2b20  mmon).        + 
+0000ba50: 2254 6869 7320 6d75 7374 2062 6520 6578  "This must be ex
+0000ba60: 706c 6963 6974 6c79 2061 6c6c 6f77 6564  plicitly allowed
+0000ba70: 2c20 652e 672e 2062 7920 7370 6563 6966  , e.g. by specif
+0000ba80: 7969 6e67 206f 7574 5f73 6861 7065 2e22  ying out_shape."
+0000ba90: 0a20 2020 2029 0a20 2020 2069 6620 616c  .    ).    if al
+0000baa0: 6c6f 775f 6272 6f61 6463 6173 745f 616c  low_broadcast_al
+0000bab0: 6c5f 736f 7572 6365 7320 6973 204e 6f74  l_sources is Not
+0000bac0: 5370 6563 6966 6965 643a 0a20 2020 2020  Specified:.     
+0000bad0: 2020 2066 726f 6d20 7265 7475 726e 6e2e     from returnn.
+0000bae0: 7574 696c 2069 6d70 6f72 7420 4265 6861  util import Beha
+0000baf0: 7669 6f72 5665 7273 696f 6e0a 0a20 2020  viorVersion..   
+0000bb00: 2020 2020 2042 6568 6176 696f 7256 6572       BehaviorVer
+0000bb10: 7369 6f6e 2e72 6571 7569 7265 2876 6572  sion.require(ver
+0000bb20: 7369 6f6e 3d34 2c20 636f 6e64 6974 696f  sion=4, conditio
+0000bb30: 6e3d 4661 6c73 652c 206d 6573 7361 6765  n=False, message
+0000bb40: 3d6d 7367 290a 2020 2020 2020 2020 7265  =msg).        re
+0000bb50: 7475 726e 0a20 2020 2069 6620 616c 6c6f  turn.    if allo
+0000bb60: 775f 6272 6f61 6463 6173 745f 616c 6c5f  w_broadcast_all_
+0000bb70: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
+0000bb80: 2072 6574 7572 6e0a 2020 2020 7261 6973   return.    rais
+0000bb90: 6520 4578 6365 7074 696f 6e28 6d73 6729  e Exception(msg)
+0000bba0: 0a0a 0a64 6566 2063 6c61 7373 5f69 6478  ...def class_idx
+0000bbb0: 5f73 6571 5f74 6f5f 315f 6f66 5f6b 2873  _seq_to_1_of_k(s
+0000bbc0: 6571 2c20 6e75 6d5f 636c 6173 7365 7329  eq, num_classes)
+0000bbd0: 3a0a 2020 2020 2222 220a 2020 2020 4261  :.    """.    Ba
+0000bbe0: 7369 6361 6c6c 7920 6f6e 655f 686f 742e  sically one_hot.
+0000bbf0: 0a0a 2020 2020 3a70 6172 616d 206c 6973  ..    :param lis
+0000bc00: 745b 696e 745d 7c6e 702e 6e64 6172 7261  t[int]|np.ndarra
+0000bc10: 7920 7365 713a 0a20 2020 203a 7061 7261  y seq:.    :para
+0000bc20: 6d20 696e 7420 6e75 6d5f 636c 6173 7365  m int num_classe
+0000bc30: 733a 0a20 2020 203a 7274 7970 653a 206e  s:.    :rtype: n
+0000bc40: 702e 6e64 6172 7261 790a 2020 2020 2222  p.ndarray.    ""
+0000bc50: 220a 2020 2020 6e75 6d5f 6672 616d 6573  ".    num_frames
+0000bc60: 203d 206c 656e 2873 6571 290a 2020 2020   = len(seq).    
+0000bc70: 6d20 3d20 6e70 2e7a 6572 6f73 2828 6e75  m = np.zeros((nu
+0000bc80: 6d5f 6672 616d 6573 2c20 6e75 6d5f 636c  m_frames, num_cl
+0000bc90: 6173 7365 7329 2c20 6474 7970 653d 2266  asses), dtype="f
+0000bca0: 6c6f 6174 3332 2229 0a20 2020 206d 5b6e  loat32").    m[n
+0000bcb0: 702e 6172 616e 6765 286e 756d 5f66 7261  p.arange(num_fra
+0000bcc0: 6d65 7329 2c20 7365 715d 203d 2031 0a20  mes), seq] = 1. 
+0000bcd0: 2020 2072 6574 7572 6e20 6d0a 0a0a 6465     return m...de
+0000bce0: 6620 756e 6971 2873 6571 293a 0a20 2020  f uniq(seq):.   
+0000bcf0: 2022 2222 0a20 2020 204c 696b 6520 556e   """.    Like Un
+0000bd00: 6978 2074 6f6f 6c20 756e 6971 2e20 5265  ix tool uniq. Re
+0000bd10: 6d6f 7665 7320 7265 7065 6174 6564 2065  moves repeated e
+0000bd20: 6e74 7269 6573 2e0a 2020 2020 5365 6520  ntries..    See 
+0000bd30: 3a66 756e 633a 6075 6e69 715f 6765 6e65  :func:`uniq_gene
+0000bd40: 7269 6360 2066 6f72 2061 2067 656e 6572  ric` for a gener
+0000bd50: 6963 2028 6e6f 6e2d 4e75 6d70 7929 2076  ic (non-Numpy) v
+0000bd60: 6572 7369 6f6e 2e0a 0a20 2020 203a 7061  ersion...    :pa
+0000bd70: 7261 6d20 6e75 6d70 792e 6e64 6172 7261  ram numpy.ndarra
+0000bd80: 7920 7365 713a 0a20 2020 203a 7265 7475  y seq:.    :retu
+0000bd90: 726e 3a20 7365 710a 2020 2020 3a72 7479  rn: seq.    :rty
+0000bda0: 7065 3a20 6e75 6d70 792e 6e64 6172 7261  pe: numpy.ndarra
+0000bdb0: 790a 2020 2020 2222 220a 2020 2020 6469  y.    """.    di
+0000bdc0: 6666 7320 3d20 6e70 2e6f 6e65 735f 6c69  ffs = np.ones_li
+0000bdd0: 6b65 2873 6571 290a 2020 2020 6469 6666  ke(seq).    diff
+0000bde0: 735b 313a 5d20 3d20 7365 715b 313a 5d20  s[1:] = seq[1:] 
+0000bdf0: 2d20 7365 715b 3a2d 315d 0a20 2020 2069  - seq[:-1].    i
+0000be00: 6478 203d 2064 6966 6673 2e6e 6f6e 7a65  dx = diffs.nonze
+0000be10: 726f 2829 0a20 2020 2072 6574 7572 6e20  ro().    return 
+0000be20: 7365 715b 6964 785d 0a0a 0a64 6566 2075  seq[idx]...def u
+0000be30: 6e69 715f 6765 6e65 7269 6328 7365 7129  niq_generic(seq)
+0000be40: 3a0a 2020 2020 2222 220a 2020 2020 4c69  :.    """.    Li
+0000be50: 6b65 2055 6e69 7820 746f 6f6c 2075 6e69  ke Unix tool uni
+0000be60: 712e 2052 656d 6f76 6573 2072 6570 6561  q. Removes repea
+0000be70: 7465 6420 656e 7472 6965 732e 0a20 2020  ted entries..   
+0000be80: 2053 6565 203a 6675 6e63 3a60 756e 6971   See :func:`uniq
+0000be90: 6020 666f 7220 616e 2065 6666 6963 6965  ` for an efficie
+0000bea0: 6e74 204e 756d 7079 2069 6d70 6c65 6d65  nt Numpy impleme
+0000beb0: 6e74 6174 696f 6e2e 0a20 2020 2053 6565  ntation..    See
+0000bec0: 203a 6675 6e63 3a60 7265 7475 726e 6e2e   :func:`returnn.
+0000bed0: 7466 2e75 7469 6c2e 6261 7369 632e 756e  tf.util.basic.un
+0000bee0: 6971 6020 666f 7220 616e 2065 6666 6963  iq` for an effic
+0000bef0: 6965 6e74 2054 4620 696d 706c 656d 656e  ient TF implemen
+0000bf00: 7461 7469 6f6e 2e0a 0a20 2020 203a 7061  tation...    :pa
+0000bf10: 7261 6d20 6c69 7374 5b54 5d7c 7475 706c  ram list[T]|tupl
+0000bf20: 655b 545d 2073 6571 3a0a 2020 2020 3a72  e[T] seq:.    :r
+0000bf30: 6574 7572 6e3a 2073 6571 0a20 2020 203a  eturn: seq.    :
+0000bf40: 7274 7970 653a 206c 6973 745b 545d 0a20  rtype: list[T]. 
+0000bf50: 2020 2022 2222 0a20 2020 206f 7574 203d     """.    out =
+0000bf60: 205b 5d0a 2020 2020 7669 7369 7465 6420   [].    visited 
+0000bf70: 3d20 7365 7428 290a 2020 2020 666f 7220  = set().    for 
+0000bf80: 7820 696e 2073 6571 3a0a 2020 2020 2020  x in seq:.      
+0000bf90: 2020 6966 2078 2069 6e20 7669 7369 7465    if x in visite
+0000bfa0: 643a 0a20 2020 2020 2020 2020 2020 2063  d:.            c
+0000bfb0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+0000bfc0: 6f75 742e 6170 7065 6e64 2878 290a 2020  out.append(x).  
+0000bfd0: 2020 2020 2020 7669 7369 7465 642e 6164        visited.ad
+0000bfe0: 6428 7829 0a20 2020 2072 6574 7572 6e20  d(x).    return 
+0000bff0: 6f75 740a 0a0a 6465 6620 736c 6963 655f  out...def slice_
+0000c000: 7061 645f 7a65 726f 7328 783a 206e 756d  pad_zeros(x: num
+0000c010: 7079 2e6e 6461 7272 6179 2c20 6265 6769  py.ndarray, begi
+0000c020: 6e3a 2069 6e74 2c20 656e 643a 2069 6e74  n: int, end: int
+0000c030: 2c20 6178 6973 3a20 696e 7420 3d20 3029  , axis: int = 0)
+0000c040: 202d 3e20 6e75 6d70 792e 6e64 6172 7261   -> numpy.ndarra
+0000c050: 793a 0a20 2020 2022 2222 0a20 2020 203a  y:.    """.    :
+0000c060: 7061 7261 6d20 783a 206f 6620 7368 6170  param x: of shap
+0000c070: 6520 282e 2e2e 2c20 7469 6d65 2c20 2e2e  e (..., time, ..
+0000c080: 2e29 0a20 2020 203a 7061 7261 6d20 6265  .).    :param be
+0000c090: 6769 6e3a 0a20 2020 203a 7061 7261 6d20  gin:.    :param 
+0000c0a0: 656e 643a 0a20 2020 203a 7061 7261 6d20  end:.    :param 
+0000c0b0: 6178 6973 3a0a 2020 2020 3a72 6574 7572  axis:.    :retur
+0000c0c0: 6e3a 2062 6173 6963 616c 6c79 2078 5b62  n: basically x[b
+0000c0d0: 6567 696e 3a65 6e64 5d20 2877 6974 6820  egin:end] (with 
+0000c0e0: 6178 6973 3d3d 3029 2062 7574 2069 6620  axis==0) but if 
+0000c0f0: 6265 6769 6e20 3c20 3020 6f72 2065 6e64  begin < 0 or end
+0000c100: 203e 2078 2e73 6861 7065 5b30 5d2c 0a20   > x.shape[0],. 
+0000c110: 2020 2020 6974 2077 696c 6c20 6e6f 7420      it will not 
+0000c120: 6469 7363 6172 6420 7468 6573 6520 6672  discard these fr
+0000c130: 616d 6573 2062 7574 2070 6164 207a 6572  ames but pad zer
+0000c140: 6f73 2c20 7375 6368 2074 6861 7420 7468  os, such that th
+0000c150: 6520 7265 7375 6c74 696e 6720 7368 6170  e resulting shap
+0000c160: 655b 305d 203d 3d20 656e 6420 2d20 6265  e[0] == end - be
+0000c170: 6769 6e2e 0a20 2020 2022 2222 0a20 2020  gin..    """.   
+0000c180: 2061 7373 6572 7420 6178 6973 203d 3d20   assert axis == 
+0000c190: 302c 2022 6e6f 7420 7965 7420 6675 6c6c  0, "not yet full
+0000c1a0: 7920 696d 706c 656d 656e 7465 6420 6f74  y implemented ot
+0000c1b0: 6865 7277 6973 6522 0a20 2020 2070 6164  herwise".    pad
+0000c1c0: 5f6c 6566 742c 2070 6164 5f72 6967 6874  _left, pad_right
+0000c1d0: 203d 2030 2c20 300a 2020 2020 6966 2062   = 0, 0.    if b
+0000c1e0: 6567 696e 203c 2030 3a0a 2020 2020 2020  egin < 0:.      
+0000c1f0: 2020 7061 645f 6c65 6674 203d 202d 6265    pad_left = -be
+0000c200: 6769 6e0a 2020 2020 2020 2020 6265 6769  gin.        begi
+0000c210: 6e20 3d20 300a 2020 2020 656c 6966 2062  n = 0.    elif b
+0000c220: 6567 696e 203e 3d20 782e 7368 6170 655b  egin >= x.shape[
+0000c230: 6178 6973 5d3a 0a20 2020 2020 2020 2072  axis]:.        r
+0000c240: 6574 7572 6e20 6e70 2e7a 6572 6f73 2828  eturn np.zeros((
+0000c250: 656e 6420 2d20 6265 6769 6e2c 2920 2b20  end - begin,) + 
+0000c260: 782e 7368 6170 655b 313a 5d2c 2064 7479  x.shape[1:], dty
+0000c270: 7065 3d78 2e64 7479 7065 290a 2020 2020  pe=x.dtype).    
+0000c280: 6173 7365 7274 2065 6e64 203e 3d20 6265  assert end >= be
+0000c290: 6769 6e0a 2020 2020 6966 2065 6e64 203e  gin.    if end >
+0000c2a0: 2078 2e73 6861 7065 5b61 7869 735d 3a0a   x.shape[axis]:.
+0000c2b0: 2020 2020 2020 2020 7061 645f 7269 6768          pad_righ
+0000c2c0: 7420 3d20 656e 6420 2d20 782e 7368 6170  t = end - x.shap
+0000c2d0: 655b 6178 6973 5d0a 2020 2020 2020 2020  e[axis].        
+0000c2e0: 656e 6420 3d20 782e 7368 6170 655b 6178  end = x.shape[ax
+0000c2f0: 6973 5d0a 2020 2020 7265 7475 726e 206e  is].    return n
+0000c300: 702e 7061 6428 785b 6265 6769 6e3a 656e  p.pad(x[begin:en
+0000c310: 645d 2c20 5b28 7061 645f 6c65 6674 2c20  d], [(pad_left, 
+0000c320: 7061 645f 7269 6768 7429 5d20 2b20 5b28  pad_right)] + [(
+0000c330: 302c 2030 295d 202a 2028 782e 6e64 696d  0, 0)] * (x.ndim
+0000c340: 202d 2031 292c 206d 6f64 653d 2263 6f6e   - 1), mode="con
+0000c350: 7374 616e 7422 290a 0a0a 6465 6620 7261  stant")...def ra
+0000c360: 6e64 6f6d 5f6f 7274 686f 676f 6e61 6c28  ndom_orthogonal(
+0000c370: 7368 6170 652c 2067 6169 6e3d 312e 302c  shape, gain=1.0,
+0000c380: 2073 6565 643d 4e6f 6e65 293a 0a20 2020   seed=None):.   
+0000c390: 2022 2222 0a20 2020 2052 6574 7572 6e73   """.    Returns
+0000c3a0: 2061 2072 616e 646f 6d20 6f72 7468 6f67   a random orthog
+0000c3b0: 6f6e 616c 206d 6174 7269 7820 6f66 2074  onal matrix of t
+0000c3c0: 6865 2067 6976 656e 2073 6861 7065 2e0a  he given shape..
+0000c3d0: 2020 2020 436f 6465 2062 6f72 726f 7765      Code borrowe
+0000c3e0: 6420 616e 6420 6164 6170 7465 6420 6672  d and adapted fr
+0000c3f0: 6f6d 204b 6572 6173 3a20 6874 7470 733a  om Keras: https:
+0000c400: 2f2f 6769 7468 7562 2e63 6f6d 2f66 6368  //github.com/fch
+0000c410: 6f6c 6c65 742f 6b65 7261 732f 626c 6f62  ollet/keras/blob
+0000c420: 2f6d 6173 7465 722f 6b65 7261 732f 696e  /master/keras/in
+0000c430: 6974 6961 6c69 7a65 7273 2e70 790a 2020  itializers.py.  
+0000c440: 2020 5265 6665 7265 6e63 653a 2053 6178    Reference: Sax
+0000c450: 6520 6574 2061 6c2e 2c20 6874 7470 733a  e et al., https:
+0000c460: 2f2f 6172 7869 762e 6f72 672f 6162 732f  //arxiv.org/abs/
+0000c470: 3133 3132 2e36 3132 300a 2020 2020 5265  1312.6120.    Re
+0000c480: 6c61 7465 643a 2055 6e69 7461 7279 2045  lated: Unitary E
+0000c490: 766f 6c75 7469 6f6e 2052 6563 7572 7265  volution Recurre
+0000c4a0: 6e74 204e 6575 7261 6c20 4e65 7477 6f72  nt Neural Networ
+0000c4b0: 6b73 2c20 6874 7470 733a 2f2f 6172 7869  ks, https://arxi
+0000c4c0: 762e 6f72 672f 6162 732f 3135 3131 2e30  v.org/abs/1511.0
+0000c4d0: 3634 3634 0a0a 2020 2020 3a70 6172 616d  6464..    :param
+0000c4e0: 2074 7570 6c65 5b69 6e74 5d20 7368 6170   tuple[int] shap
+0000c4f0: 653a 0a20 2020 203a 7061 7261 6d20 666c  e:.    :param fl
+0000c500: 6f61 7420 6761 696e 3a0a 2020 2020 3a70  oat gain:.    :p
+0000c510: 6172 616d 2069 6e74 2073 6565 643a 2066  aram int seed: f
+0000c520: 6f72 204e 756d 7079 2072 616e 646f 6d20  or Numpy random 
+0000c530: 6765 6e65 7261 746f 720a 2020 2020 3a72  generator.    :r
+0000c540: 6574 7572 6e3a 2072 616e 646f 6d20 6f72  eturn: random or
+0000c550: 7468 6f67 6f6e 616c 206d 6174 7269 780a  thogonal matrix.
+0000c560: 2020 2020 3a72 7479 7065 3a20 6e75 6d70      :rtype: nump
+0000c570: 792e 6e64 6172 7261 790a 2020 2020 2222  y.ndarray.    ""
+0000c580: 220a 2020 2020 6e75 6d5f 726f 7773 203d  ".    num_rows =
+0000c590: 2031 0a20 2020 2066 6f72 2064 696d 2069   1.    for dim i
+0000c5a0: 6e20 7368 6170 655b 3a2d 315d 3a0a 2020  n shape[:-1]:.  
+0000c5b0: 2020 2020 2020 6e75 6d5f 726f 7773 202a        num_rows *
+0000c5c0: 3d20 6469 6d0a 2020 2020 6e75 6d5f 636f  = dim.    num_co
+0000c5d0: 6c73 203d 2073 6861 7065 5b2d 315d 0a20  ls = shape[-1]. 
+0000c5e0: 2020 2066 6c61 745f 7368 6170 6520 3d20     flat_shape = 
+0000c5f0: 286e 756d 5f72 6f77 732c 206e 756d 5f63  (num_rows, num_c
+0000c600: 6f6c 7329 0a20 2020 2069 6620 7365 6564  ols).    if seed
+0000c610: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000c620: 2020 2020 2020 726e 6420 3d20 6e70 2e72        rnd = np.r
+0000c630: 616e 646f 6d2e 5261 6e64 6f6d 5374 6174  andom.RandomStat
+0000c640: 6528 7365 6564 3d73 6565 6429 0a20 2020  e(seed=seed).   
+0000c650: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+0000c660: 6e64 203d 206e 702e 7261 6e64 6f6d 0a20  nd = np.random. 
+0000c670: 2020 2061 203d 2072 6e64 2e6e 6f72 6d61     a = rnd.norma
+0000c680: 6c28 302e 302c 2031 2e30 2c20 666c 6174  l(0.0, 1.0, flat
+0000c690: 5f73 6861 7065 290a 2020 2020 752c 205f  _shape).    u, _
+0000c6a0: 2c20 7620 3d20 6e70 2e6c 696e 616c 672e  , v = np.linalg.
+0000c6b0: 7376 6428 612c 2066 756c 6c5f 6d61 7472  svd(a, full_matr
+0000c6c0: 6963 6573 3d46 616c 7365 290a 2020 2020  ices=False).    
+0000c6d0: 2320 5069 636b 2074 6865 206f 6e65 2077  # Pick the one w
+0000c6e0: 6974 6820 7468 6520 636f 7272 6563 7420  ith the correct 
+0000c6f0: 7368 6170 652e 0a20 2020 2071 203d 2075  shape..    q = u
+0000c700: 2069 6620 752e 7368 6170 6520 3d3d 2066   if u.shape == f
+0000c710: 6c61 745f 7368 6170 6520 656c 7365 2076  lat_shape else v
+0000c720: 0a20 2020 2071 203d 2071 2e72 6573 6861  .    q = q.resha
+0000c730: 7065 2873 6861 7065 290a 2020 2020 7265  pe(shape).    re
+0000c740: 7475 726e 2067 6169 6e20 2a20 715b 3a20  turn gain * q[: 
+0000c750: 7368 6170 655b 305d 2c20 3a20 7368 6170  shape[0], : shap
+0000c760: 655b 315d 5d0a 0a0a 2320 6e6f 696e 7370  e[1]]...# noinsp
+0000c770: 6563 7469 6f6e 2050 7955 6e75 7365 644c  ection PyUnusedL
+0000c780: 6f63 616c 0a64 6566 2069 6e70 6c61 6365  ocal.def inplace
+0000c790: 5f69 6e63 7265 6d65 6e74 2878 2c20 6964  _increment(x, id
+0000c7a0: 782c 2079 293a 0a20 2020 2022 2222 0a20  x, y):.    """. 
+0000c7b0: 2020 2054 6869 7320 6261 7369 6361 6c6c     This basicall
+0000c7c0: 7920 646f 6573 2060 785b 6964 785d 202b  y does `x[idx] +
+0000c7d0: 3d20 7960 2e0a 2020 2020 5468 6520 6469  = y`..    The di
+0000c7e0: 6666 6572 656e 6365 2074 6f20 7468 6520  fference to the 
+0000c7f0: 4e75 6d70 7920 7665 7273 696f 6e20 6973  Numpy version is
+0000c800: 2074 6861 7420 696e 2063 6173 6520 736f   that in case so
+0000c810: 6d65 2069 6e64 6578 2069 7320 7468 6572  me index is ther
+0000c820: 6520 6d75 6c74 6970 6c65 0a20 2020 2074  e multiple.    t
+0000c830: 696d 6573 2c20 6974 2077 696c 6c20 6f6e  imes, it will on
+0000c840: 6c79 2062 6520 696e 6372 656d 656e 7465  ly be incremente
+0000c850: 6420 6f6e 6365 2028 616e 6420 6974 2069  d once (and it i
+0000c860: 7320 6e6f 7420 7370 6563 6966 6965 6420  s not specified 
+0000c870: 7768 6963 6820 6f6e 6529 2e0a 2020 2020  which one)..    
+0000c880: 5365 6520 616c 736f 2074 6865 616e 6f2e  See also theano.
+0000c890: 7465 6e73 6f72 2e73 7562 7465 6e73 6f72  tensor.subtensor
+0000c8a0: 2e41 6476 616e 6365 6449 6e63 5375 6274  .AdvancedIncSubt
+0000c8b0: 656e 736f 7220 646f 6375 6d65 6e74 6174  ensor documentat
+0000c8c0: 696f 6e2e 0a0a 2020 2020 3a70 6172 616d  ion...    :param
+0000c8d0: 206e 756d 7079 2e6e 6461 7272 6179 2078   numpy.ndarray x
+0000c8e0: 3a0a 2020 2020 3a70 6172 616d 206e 756d  :.    :param num
+0000c8f0: 7079 2e6e 6461 7272 6179 2069 6478 3a0a  py.ndarray idx:.
+0000c900: 2020 2020 3a70 6172 616d 206e 756d 7079      :param numpy
+0000c910: 2e6e 6461 7272 6179 2079 3a0a 2020 2020  .ndarray y:.    
+0000c920: 3a72 7479 7065 3a20 6e75 6d70 792e 6e64  :rtype: numpy.nd
+0000c930: 6172 7261 790a 2020 2020 2222 220a 2020  array.    """.  
+0000c940: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+0000c950: 6d65 6e74 6564 4572 726f 7228 2254 6869  mentedError("Thi
+0000c960: 7320 6665 6174 7572 6520 7761 7320 7265  s feature was re
+0000c970: 6d6f 7665 6420 7769 7468 2064 726f 7070  moved with dropp
+0000c980: 6564 2054 6865 616e 6f20 7375 7070 6f72  ed Theano suppor
+0000c990: 7422 290a 0a0a 6465 6620 7072 6f64 286c  t")...def prod(l
+0000c9a0: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
+0000c9b0: 3a70 6172 616d 206c 6973 745b 545d 7c74  :param list[T]|t
+0000c9c0: 7570 6c65 5b54 5d7c 6e75 6d70 792e 6e64  uple[T]|numpy.nd
+0000c9d0: 6172 7261 7920 6c73 3a0a 2020 2020 3a72  array ls:.    :r
+0000c9e0: 7479 7065 3a20 547c 696e 747c 666c 6f61  type: T|int|floa
+0000c9f0: 740a 2020 2020 2222 220a 2020 2020 6966  t.    """.    if
+0000ca00: 206c 656e 286c 7329 203d 3d20 303a 0a20   len(ls) == 0:. 
+0000ca10: 2020 2020 2020 2072 6574 7572 6e20 310a         return 1.
+0000ca20: 2020 2020 7820 3d20 6c73 5b30 5d0a 2020      x = ls[0].  
+0000ca30: 2020 666f 7220 7920 696e 206c 735b 313a    for y in ls[1:
+0000ca40: 5d3a 0a20 2020 2020 2020 2078 203d 2078  ]:.        x = x
+0000ca50: 202a 2079 2020 2320 2a3d 2064 6f65 736e   * y  # *= doesn
+0000ca60: 2774 2077 6f72 6b20 6265 6361 7573 6520  't work because 
+0000ca70: 7820 6d69 6768 7420 6265 2061 2074 656e  x might be a ten
+0000ca80: 736f 722c 2061 6e64 2066 6f72 2065 2e67  sor, and for e.g
+0000ca90: 2e20 746f 7263 682e 5465 6e73 6f72 2074  . torch.Tensor t
+0000caa0: 6869 7320 6f70 2069 7320 696e 2d70 6c61  his op is in-pla
+0000cab0: 6365 0a20 2020 2072 6574 7572 6e20 780a  ce.    return x.
+0000cac0: 0a0a 6465 6620 7061 7273 655f 6f72 7468  ..def parse_orth
+0000cad0: 6f67 7261 7068 795f 696e 746f 5f73 796d  ography_into_sym
+0000cae0: 626f 6c73 280a 2020 2020 6f72 7468 6f67  bols(.    orthog
+0000caf0: 7261 7068 792c 2075 7070 6572 5f63 6173  raphy, upper_cas
+0000cb00: 655f 7370 6563 6961 6c3d 5472 7565 2c20  e_special=True, 
+0000cb10: 776f 7264 5f62 6173 6564 3d46 616c 7365  word_based=False
+0000cb20: 2c20 7371 7561 7265 5f62 7261 636b 6574  , square_bracket
+0000cb30: 735f 666f 725f 7370 6563 6961 6c73 3d54  s_for_specials=T
+0000cb40: 7275 650a 293a 0a20 2020 2022 2222 0a20  rue.):.    """. 
+0000cb50: 2020 2046 6f72 2053 7065 6563 682e 0a20     For Speech.. 
+0000cb60: 2020 2045 7861 6d70 6c65 3a0a 2020 2020     Example:.    
+0000cb70: 2020 6f72 7468 6f67 7261 7068 7920 3d20    orthography = 
+0000cb80: 2268 656c 6c6f 205b 4845 5349 5441 5449  "hello [HESITATI
+0000cb90: 4f4e 5d20 7468 6572 6520 220a 2020 2020  ON] there ".    
+0000cba0: 2020 7769 7468 2077 6f72 645f 6261 7365    with word_base
+0000cbb0: 6420 3d3d 2046 616c 7365 3a20 7265 7475  d == False: retu
+0000cbc0: 726e 7320 6c69 7374 2822 6865 6c6c 6f20  rns list("hello 
+0000cbd0: 2229 202b 205b 225b 4845 5349 5441 5449  ") + ["[HESITATI
+0000cbe0: 4f4e 5d22 5d20 2b20 6c69 7374 2822 2074  ON]"] + list(" t
+0000cbf0: 6865 7265 2022 292e 0a20 2020 2020 2077  here ")..      w
+0000cc00: 6974 6820 776f 7264 5f62 6173 6564 203d  ith word_based =
+0000cc10: 3d20 5472 7565 3a20 7265 7475 726e 7320  = True: returns 
+0000cc20: 5b22 6865 6c6c 6f22 2c20 225b 4845 5349  ["hello", "[HESI
+0000cc30: 5441 5449 4f4e 5d22 2c20 2274 6865 7265  TATION]", "there
+0000cc40: 225d 0a20 2020 204e 6f20 7072 652f 706f  "].    No pre/po
+0000cc50: 7374 2d70 726f 6365 7373 696e 6720 7375  st-processing su
+0000cc60: 6368 2061 733a 0a20 2020 2053 7061 6365  ch as:.    Space
+0000cc70: 7320 6172 6520 6b65 7074 2061 732d 6973  s are kept as-is
+0000cc80: 2e20 4e6f 2073 7472 6970 7069 6e67 2061  . No stripping a
+0000cc90: 7420 6265 6769 6e2f 656e 642e 2028 452e  t begin/end. (E.
+0000cca0: 672e 2074 7261 696c 696e 6720 7370 6163  g. trailing spac
+0000ccb0: 6573 2061 7265 206e 6f74 2072 656d 6f76  es are not remov
+0000ccc0: 6564 2e29 0a20 2020 204e 6f20 746f 6c6f  ed.).    No tolo
+0000ccd0: 7765 722f 746f 7570 7065 722e 0a20 2020  wer/toupper..   
+0000cce0: 2044 6f65 736e 2774 2061 6464 205b 4245   Doesn't add [BE
+0000ccf0: 4749 4e5d 2f5b 454e 445d 2073 796d 626f  GIN]/[END] symbo
+0000cd00: 6c73 206f 7220 736f 2e0a 2020 2020 416e  ls or so..    An
+0000cd10: 7920 7375 6368 206f 7065 7261 7469 6f6e  y such operation
+0000cd20: 7320 7368 6f75 6c64 2062 6520 646f 6e65  s should be done
+0000cd30: 2065 7870 6c69 6369 746c 7920 696e 2061   explicitly in a
+0000cd40: 6e20 6164 6469 7469 6f6e 616c 2066 756e  n additional fun
+0000cd50: 6374 696f 6e2e 0a20 2020 2041 6e79 7468  ction..    Anyth
+0000cd60: 696e 6720 696e 205b 5d2d 6272 6163 6b65  ing in []-bracke
+0000cd70: 7473 2061 7265 206d 6561 6e74 2061 7320  ts are meant as 
+0000cd80: 7370 6563 6961 6c2d 7379 6d62 6f6c 732e  special-symbols.
+0000cd90: 0a20 2020 2041 6c73 6f20 7365 6520 7061  .    Also see pa
+0000cda0: 7273 655f 6f72 7468 6f67 7261 7068 7928  rse_orthography(
+0000cdb0: 2920 7768 6963 6820 696e 636c 7564 6573  ) which includes
+0000cdc0: 2073 6f6d 6520 7072 6570 726f 6365 7373   some preprocess
+0000cdd0: 696e 672e 0a0a 2020 2020 3a70 6172 616d  ing...    :param
+0000cde0: 2073 7472 206f 7274 686f 6772 6170 6879   str orthography
+0000cdf0: 3a20 6578 616d 706c 653a 2022 6865 6c6c  : example: "hell
+0000ce00: 6f20 5b48 4553 4954 4154 494f 4e5d 2074  o [HESITATION] t
+0000ce10: 6865 7265 2022 0a20 2020 203a 7061 7261  here ".    :para
+0000ce20: 6d20 626f 6f6c 2075 7070 6572 5f63 6173  m bool upper_cas
+0000ce30: 655f 7370 6563 6961 6c3a 2077 6865 7468  e_special: wheth
+0000ce40: 6572 2074 6865 2073 7065 6369 616c 2073  er the special s
+0000ce50: 796d 626f 6c73 2061 7265 2061 6c77 6179  ymbols are alway
+0000ce60: 7320 6d61 6465 2075 7070 6572 2063 6173  s made upper cas
+0000ce70: 650a 2020 2020 3a70 6172 616d 2062 6f6f  e.    :param boo
+0000ce80: 6c20 776f 7264 5f62 6173 6564 3a20 7768  l word_based: wh
+0000ce90: 6574 6865 7220 7765 2073 706c 6974 206f  ether we split o
+0000cea0: 6e20 7370 6163 6520 616e 6420 7265 7475  n space and retu
+0000ceb0: 726e 2066 756c 6c20 776f 7264 730a 2020  rn full words.  
+0000cec0: 2020 3a70 6172 616d 2062 6f6f 6c20 7371    :param bool sq
+0000ced0: 7561 7265 5f62 7261 636b 6574 735f 666f  uare_brackets_fo
+0000cee0: 725f 7370 6563 6961 6c73 3a20 6861 6e64  r_specials: hand
+0000cef0: 6c65 2022 5b2e 2e2e 5d22 0a20 2020 203a  le "[...]".    :
+0000cf00: 7274 7970 653a 206c 6973 745b 7374 725d  rtype: list[str]
+0000cf10: 0a20 2020 2022 2222 0a20 2020 2072 6574  .    """.    ret
+0000cf20: 203d 205b 5d0a 2020 2020 696e 5f73 7065   = [].    in_spe
+0000cf30: 6369 616c 203d 2030 0a20 2020 2066 6f72  cial = 0.    for
+0000cf40: 2063 2069 6e20 6f72 7468 6f67 7261 7068   c in orthograph
+0000cf50: 793a 0a20 2020 2020 2020 2069 6620 696e  y:.        if in
+0000cf60: 5f73 7065 6369 616c 3a0a 2020 2020 2020  _special:.      
+0000cf70: 2020 2020 2020 6966 2063 203d 3d20 225b        if c == "[
+0000cf80: 223a 2020 2320 7370 6563 6961 6c2d 7370  ":  # special-sp
+0000cf90: 6563 6961 6c0a 2020 2020 2020 2020 2020  ecial.          
+0000cfa0: 2020 2020 2020 696e 5f73 7065 6369 616c        in_special
+0000cfb0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0000cfc0: 2020 2020 2020 7265 745b 2d31 5d20 2b3d        ret[-1] +=
+0000cfd0: 2022 5b22 0a20 2020 2020 2020 2020 2020   "[".           
+0000cfe0: 2065 6c69 6620 6320 3d3d 2022 5d22 3a0a   elif c == "]":.
 0000cff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d000: 7265 745b 2d31 5d20 2b3d 2022 5d22 0a20  ret[-1] += "]". 
-0000d010: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000d020: 7570 7065 725f 6361 7365 5f73 7065 6369  upper_case_speci
-0000d030: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
-0000d040: 2020 2020 7265 745b 2d31 5d20 2b3d 2063      ret[-1] += c
-0000d050: 2e75 7070 6572 2829 0a20 2020 2020 2020  .upper().       
-0000d060: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000d070: 2020 2020 2020 2020 2020 2072 6574 5b2d             ret[-
-0000d080: 315d 202b 3d20 630a 2020 2020 2020 2020  1] += c.        
-0000d090: 656c 7365 3a20 2023 206e 6f74 2069 6e5f  else:  # not in_
-0000d0a0: 7370 6563 6961 6c0a 2020 2020 2020 2020  special.        
-0000d0b0: 2020 2020 6966 2073 7175 6172 655f 6272      if square_br
-0000d0c0: 6163 6b65 7473 5f66 6f72 5f73 7065 6369  ackets_for_speci
-0000d0d0: 616c 7320 616e 6420 6320 3d3d 2022 5b22  als and c == "["
-0000d0e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d0f0: 2020 696e 5f73 7065 6369 616c 203d 2031    in_special = 1
-0000d100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d110: 2069 6620 7265 7420 616e 6420 6e6f 7420   if ret and not 
-0000d120: 7265 745b 2d31 5d3a 0a20 2020 2020 2020  ret[-1]:.       
-0000d130: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000d140: 5b2d 315d 202b 3d20 630a 2020 2020 2020  [-1] += c.      
-0000d150: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000d160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d170: 2020 2020 7265 7420 2b3d 205b 225b 225d      ret += ["["]
-0000d180: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000d190: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000d1a0: 2020 2069 6620 776f 7264 5f62 6173 6564     if word_based
-0000d1b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d1c0: 2020 2020 2020 6966 2063 2e69 7373 7061        if c.isspa
-0000d1d0: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
-0000d1e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000d1f0: 7420 2b3d 205b 2222 5d0a 2020 2020 2020  t += [""].      
-0000d200: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000d210: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000d220: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000d230: 6f74 2072 6574 3a0a 2020 2020 2020 2020  ot ret:.        
-0000d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d250: 2020 2020 7265 7420 2b3d 205b 2222 5d0a      ret += [""].
+0000d000: 696e 5f73 7065 6369 616c 202d 3d20 310a  in_special -= 1.
+0000d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d020: 7265 745b 2d31 5d20 2b3d 2022 5d22 0a20  ret[-1] += "]". 
+0000d030: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0000d040: 7570 7065 725f 6361 7365 5f73 7065 6369  upper_case_speci
+0000d050: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
+0000d060: 2020 2020 7265 745b 2d31 5d20 2b3d 2063      ret[-1] += c
+0000d070: 2e75 7070 6572 2829 0a20 2020 2020 2020  .upper().       
+0000d080: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000d090: 2020 2020 2020 2020 2020 2072 6574 5b2d             ret[-
+0000d0a0: 315d 202b 3d20 630a 2020 2020 2020 2020  1] += c.        
+0000d0b0: 656c 7365 3a20 2023 206e 6f74 2069 6e5f  else:  # not in_
+0000d0c0: 7370 6563 6961 6c0a 2020 2020 2020 2020  special.        
+0000d0d0: 2020 2020 6966 2073 7175 6172 655f 6272      if square_br
+0000d0e0: 6163 6b65 7473 5f66 6f72 5f73 7065 6369  ackets_for_speci
+0000d0f0: 616c 7320 616e 6420 6320 3d3d 2022 5b22  als and c == "["
+0000d100: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d110: 2020 696e 5f73 7065 6369 616c 203d 2031    in_special = 1
+0000d120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d130: 2069 6620 7265 7420 616e 6420 6e6f 7420   if ret and not 
+0000d140: 7265 745b 2d31 5d3a 0a20 2020 2020 2020  ret[-1]:.       
+0000d150: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000d160: 5b2d 315d 202b 3d20 630a 2020 2020 2020  [-1] += c.      
+0000d170: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d190: 2020 2020 7265 7420 2b3d 205b 225b 225d      ret += ["["]
+0000d1a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000d1b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000d1c0: 2020 2069 6620 776f 7264 5f62 6173 6564     if word_based
+0000d1d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d1e0: 2020 2020 2020 6966 2063 2e69 7373 7061        if c.isspa
+0000d1f0: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
+0000d200: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000d210: 7420 2b3d 205b 2222 5d0a 2020 2020 2020  t += [""].      
+0000d220: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000d230: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000d240: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000d250: 6f74 2072 6574 3a0a 2020 2020 2020 2020  ot ret:.        
 0000d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d270: 2020 2020 2020 2020 7265 745b 2d31 5d20          ret[-1] 
-0000d280: 2b3d 2063 0a20 2020 2020 2020 2020 2020  += c.           
-0000d290: 2020 2020 2065 6c73 653a 2020 2320 6e6f       else:  # no
-0000d2a0: 7420 776f 7264 5f62 6173 6564 0a20 2020  t word_based.   
-0000d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2c0: 2072 6574 202b 3d20 630a 2020 2020 7265   ret += c.    re
-0000d2d0: 7475 726e 2072 6574 0a0a 0a64 6566 2070  turn ret...def p
-0000d2e0: 6172 7365 5f6f 7274 686f 6772 6170 6879  arse_orthography
-0000d2f0: 280a 2020 2020 6f72 7468 6f67 7261 7068  (.    orthograph
-0000d300: 792c 2070 7265 6669 783d 2829 2c20 706f  y, prefix=(), po
-0000d310: 7374 6669 783d 2822 5b45 4e44 5d22 2c29  stfix=("[END]",)
-0000d320: 2c20 7265 6d6f 7665 5f63 6861 7273 3d22  , remove_chars="
-0000d330: 2829 7b7d 222c 2063 6f6c 6c61 7073 655f  (){}", collapse_
-0000d340: 7370 6163 6573 3d54 7275 652c 2066 696e  spaces=True, fin
-0000d350: 616c 5f73 7472 6970 3d54 7275 652c 202a  al_strip=True, *
-0000d360: 2a6b 7761 7267 730a 293a 0a20 2020 2022  *kwargs.):.    "
-0000d370: 2222 0a20 2020 2046 6f72 2053 7065 6563  "".    For Speec
-0000d380: 682e 2046 756c 6c20 7072 6f63 6573 7369  h. Full processi
-0000d390: 6e67 2e0a 2020 2020 4578 616d 706c 653a  ng..    Example:
-0000d3a0: 0a20 2020 2020 206f 7274 686f 6772 6170  .      orthograp
-0000d3b0: 6879 203d 2022 6865 6c6c 6f20 5b48 4553  hy = "hello [HES
-0000d3c0: 4954 4154 494f 4e5d 2074 6865 7265 2022  ITATION] there "
-0000d3d0: 0a20 2020 2020 2077 6974 6820 776f 7264  .      with word
-0000d3e0: 5f62 6173 6564 203d 3d20 4661 6c73 653a  _based == False:
-0000d3f0: 2072 6574 7572 6e73 206c 6973 7428 2268   returns list("h
-0000d400: 656c 6c6f 2022 2920 2b20 5b22 5b48 4553  ello ") + ["[HES
-0000d410: 4954 4154 494f 4e5d 225d 202b 206c 6973  ITATION]"] + lis
-0000d420: 7428 2220 7468 6572 6522 2920 2b20 5b22  t(" there") + ["
-0000d430: 5b45 4e44 5d22 5d0a 2020 2020 2020 7769  [END]"].      wi
-0000d440: 7468 2077 6f72 645f 6261 7365 6420 3d3d  th word_based ==
-0000d450: 2054 7275 653a 2072 6574 7572 6e73 205b   True: returns [
-0000d460: 2268 656c 6c6f 222c 2022 5b48 4553 4954  "hello", "[HESIT
-0000d470: 4154 494f 4e5d 222c 2022 7468 6572 6522  ATION]", "there"
-0000d480: 2c20 225b 454e 445d 225d 0a20 2020 2044  , "[END]"].    D
-0000d490: 6f65 7320 736f 6d65 2070 7265 7072 6f63  oes some preproc
-0000d4a0: 6573 7369 6e67 206f 6e20 6f72 7468 6f67  essing on orthog
-0000d4b0: 7261 7068 7920 616e 6420 7468 656e 2070  raphy and then p
-0000d4c0: 6173 7365 7320 6974 206f 6e20 746f 2070  asses it on to p
-0000d4d0: 6172 7365 5f6f 7274 686f 6772 6170 6879  arse_orthography
-0000d4e0: 5f69 6e74 6f5f 7379 6d62 6f6c 7328 292e  _into_symbols().
-0000d4f0: 0a0a 2020 2020 3a70 6172 616d 2073 7472  ..    :param str
-0000d500: 206f 7274 686f 6772 6170 6879 3a20 652e   orthography: e.
-0000d510: 672e 2022 6865 6c6c 6f20 5b48 4553 4954  g. "hello [HESIT
-0000d520: 4154 494f 4e5d 2074 6865 7265 2022 0a20  ATION] there ". 
-0000d530: 2020 203a 7061 7261 6d20 6c69 7374 5b73     :param list[s
-0000d540: 7472 5d20 7072 6566 6978 3a20 7769 6c6c  tr] prefix: will
-0000d550: 2061 6464 2074 6869 7320 7072 6566 6978   add this prefix
-0000d560: 0a20 2020 203a 7061 7261 6d20 6c69 7374  .    :param list
-0000d570: 5b73 7472 5d20 706f 7374 6669 783a 2077  [str] postfix: w
-0000d580: 696c 6c20 6164 6420 7468 6973 2070 6f73  ill add this pos
-0000d590: 7466 6978 0a20 2020 203a 7061 7261 6d20  tfix.    :param 
-0000d5a0: 7374 7220 7265 6d6f 7665 5f63 6861 7273  str remove_chars
-0000d5b0: 3a20 7468 6f73 6520 6368 6172 7320 7769  : those chars wi
-0000d5c0: 6c6c 206a 7573 7420 6265 2072 656d 6f76  ll just be remov
-0000d5d0: 6564 2061 7420 7468 6520 6265 6769 6e6e  ed at the beginn
-0000d5e0: 696e 670a 2020 2020 3a70 6172 616d 2062  ing.    :param b
-0000d5f0: 6f6f 6c20 636f 6c6c 6170 7365 5f73 7061  ool collapse_spa
-0000d600: 6365 733a 2077 6865 7468 6572 206d 756c  ces: whether mul
-0000d610: 7469 706c 6520 7370 6163 6573 2061 6e64  tiple spaces and
-0000d620: 2074 6162 7320 6172 6520 636f 6c6c 6170   tabs are collap
-0000d630: 7365 6420 696e 746f 2061 2073 696e 676c  sed into a singl
-0000d640: 6520 7370 6163 650a 2020 2020 3a70 6172  e space.    :par
-0000d650: 616d 2062 6f6f 6c20 6669 6e61 6c5f 7374  am bool final_st
-0000d660: 7269 703a 2077 6865 7468 6572 2077 6520  rip: whether we 
-0000d670: 7374 7269 7020 6c65 6674 2061 6e64 2072  strip left and r
-0000d680: 6967 6874 0a20 2020 203a 7061 7261 6d20  ight.    :param 
-0000d690: 6b77 6172 6773 3a20 7061 7373 6564 206f  kwargs: passed o
-0000d6a0: 6e20 746f 2070 6172 7365 5f6f 7274 686f  n to parse_ortho
-0000d6b0: 6772 6170 6879 5f69 6e74 6f5f 7379 6d62  graphy_into_symb
-0000d6c0: 6f6c 7328 290a 2020 2020 3a72 7479 7065  ols().    :rtype
-0000d6d0: 3a20 6c69 7374 5b73 7472 5d0a 2020 2020  : list[str].    
-0000d6e0: 2222 220a 2020 2020 666f 7220 6320 696e  """.    for c in
-0000d6f0: 2072 656d 6f76 655f 6368 6172 733a 0a20   remove_chars:. 
-0000d700: 2020 2020 2020 206f 7274 686f 6772 6170         orthograp
-0000d710: 6879 203d 206f 7274 686f 6772 6170 6879  hy = orthography
-0000d720: 2e72 6570 6c61 6365 2863 2c20 2222 290a  .replace(c, "").
-0000d730: 2020 2020 6966 2063 6f6c 6c61 7073 655f      if collapse_
-0000d740: 7370 6163 6573 3a0a 2020 2020 2020 2020  spaces:.        
-0000d750: 6f72 7468 6f67 7261 7068 7920 3d20 2220  orthography = " 
-0000d760: 222e 6a6f 696e 286f 7274 686f 6772 6170  ".join(orthograp
-0000d770: 6879 2e73 706c 6974 2829 290a 2020 2020  hy.split()).    
-0000d780: 6966 2066 696e 616c 5f73 7472 6970 3a0a  if final_strip:.
-0000d790: 2020 2020 2020 2020 6f72 7468 6f67 7261          orthogra
-0000d7a0: 7068 7920 3d20 6f72 7468 6f67 7261 7068  phy = orthograph
-0000d7b0: 792e 7374 7269 7028 290a 2020 2020 7265  y.strip().    re
-0000d7c0: 7475 726e 206c 6973 7428 7072 6566 6978  turn list(prefix
-0000d7d0: 2920 2b20 7061 7273 655f 6f72 7468 6f67  ) + parse_orthog
-0000d7e0: 7261 7068 795f 696e 746f 5f73 796d 626f  raphy_into_symbo
-0000d7f0: 6c73 286f 7274 686f 6772 6170 6879 2c20  ls(orthography, 
-0000d800: 2a2a 6b77 6172 6773 2920 2b20 6c69 7374  **kwargs) + list
-0000d810: 2870 6f73 7466 6978 290a 0a0a 6465 6620  (postfix)...def 
-0000d820: 6a73 6f6e 5f72 656d 6f76 655f 636f 6d6d  json_remove_comm
-0000d830: 656e 7473 2873 7472 696e 672c 2073 7472  ents(string, str
-0000d840: 6970 5f73 7061 6365 3d54 7275 6529 3a0a  ip_space=True):.
-0000d850: 2020 2020 2222 220a 2020 2020 3a74 7970      """.    :typ
-0000d860: 6520 7374 7269 6e67 3a20 7374 720a 2020  e string: str.  
-0000d870: 2020 3a70 6172 616d 2062 6f6f 6c20 7374    :param bool st
-0000d880: 7269 705f 7370 6163 653a 0a20 2020 203a  rip_space:.    :
-0000d890: 7274 7970 653a 2073 7472 0a0a 2020 2020  rtype: str..    
-0000d8a0: 7669 6120 6874 7470 733a 2f2f 6769 7468  via https://gith
-0000d8b0: 7562 2e63 6f6d 2f67 6574 6966 792f 4a53  ub.com/getify/JS
-0000d8c0: 4f4e 2e6d 696e 6966 792f 626c 6f62 2f6d  ON.minify/blob/m
-0000d8d0: 6173 7465 722f 6d69 6e69 6679 5f6a 736f  aster/minify_jso
-0000d8e0: 6e2e 7079 2c0a 2020 2020 6279 2047 6572  n.py,.    by Ger
-0000d8f0: 616c 6420 5374 6f72 6572 2c20 5072 6164  ald Storer, Prad
-0000d900: 7975 6e20 532e 2047 6564 616d 2c20 6d6f  yun S. Gedam, mo
-0000d910: 6469 6669 6564 2062 7920 7573 2e0a 2020  dified by us..  
-0000d920: 2020 2222 220a 2020 2020 746f 6b65 6e69    """.    tokeni
-0000d930: 7a65 7220 3d20 7265 2e63 6f6d 7069 6c65  zer = re.compile
-0000d940: 2827 227c 282f 5c5c 2a29 7c28 5c5c 2a2f  ('"|(/\\*)|(\\*/
-0000d950: 297c 282f 2f29 7c5c 6e7c 5c72 2729 0a20  )|(//)|\n|\r'). 
-0000d960: 2020 2065 6e64 5f73 6c61 7368 6573 5f72     end_slashes_r
-0000d970: 6520 3d20 7265 2e63 6f6d 7069 6c65 2872  e = re.compile(r
-0000d980: 2228 5c5c 292a 2422 290a 0a20 2020 2069  "(\\)*$")..    i
-0000d990: 6e5f 7374 7269 6e67 203d 2046 616c 7365  n_string = False
-0000d9a0: 0a20 2020 2069 6e5f 6d75 6c74 6920 3d20  .    in_multi = 
-0000d9b0: 4661 6c73 650a 2020 2020 696e 5f73 696e  False.    in_sin
-0000d9c0: 676c 6520 3d20 4661 6c73 650a 0a20 2020  gle = False..   
-0000d9d0: 206e 6577 5f73 7472 203d 205b 5d0a 2020   new_str = [].  
-0000d9e0: 2020 696e 6465 7820 3d20 300a 0a20 2020    index = 0..   
-0000d9f0: 2066 6f72 206d 6174 6368 2069 6e20 7265   for match in re
-0000da00: 2e66 696e 6469 7465 7228 746f 6b65 6e69  .finditer(tokeni
-0000da10: 7a65 722c 2073 7472 696e 6729 3a0a 0a20  zer, string):.. 
-0000da20: 2020 2020 2020 2069 6620 6e6f 7420 2869         if not (i
-0000da30: 6e5f 6d75 6c74 6920 6f72 2069 6e5f 7369  n_multi or in_si
-0000da40: 6e67 6c65 293a 0a20 2020 2020 2020 2020  ngle):.         
-0000da50: 2020 2074 6d70 203d 2073 7472 696e 675b     tmp = string[
-0000da60: 696e 6465 7820 3a20 6d61 7463 682e 7374  index : match.st
-0000da70: 6172 7428 295d 0a20 2020 2020 2020 2020  art()].         
-0000da80: 2020 2069 6620 6e6f 7420 696e 5f73 7472     if not in_str
-0000da90: 696e 6720 616e 6420 7374 7269 705f 7370  ing and strip_sp
-0000daa0: 6163 653a 0a20 2020 2020 2020 2020 2020  ace:.           
-0000dab0: 2020 2020 2023 2072 6570 6c61 6365 2077       # replace w
-0000dac0: 6869 7465 2073 7061 6365 2061 7320 6465  hite space as de
-0000dad0: 6669 6e65 6420 696e 2073 7461 6e64 6172  fined in standar
-0000dae0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000daf0: 2020 746d 7020 3d20 7265 2e73 7562 2822    tmp = re.sub("
-0000db00: 5b20 5c74 5c6e 5c72 5d2b 222c 2022 222c  [ \t\n\r]+", "",
-0000db10: 2074 6d70 290a 2020 2020 2020 2020 2020   tmp).          
-0000db20: 2020 6e65 775f 7374 722e 6170 7065 6e64    new_str.append
-0000db30: 2874 6d70 290a 0a20 2020 2020 2020 2069  (tmp)..        i
-0000db40: 6e64 6578 203d 206d 6174 6368 2e65 6e64  ndex = match.end
-0000db50: 2829 0a20 2020 2020 2020 2076 616c 203d  ().        val =
-0000db60: 206d 6174 6368 2e67 726f 7570 2829 0a0a   match.group()..
-0000db70: 2020 2020 2020 2020 6966 2076 616c 203d          if val =
-0000db80: 3d20 2722 2720 616e 6420 6e6f 7420 2869  = '"' and not (i
-0000db90: 6e5f 6d75 6c74 6920 6f72 2069 6e5f 7369  n_multi or in_si
-0000dba0: 6e67 6c65 293a 0a20 2020 2020 2020 2020  ngle):.         
-0000dbb0: 2020 2065 7363 6170 6564 203d 2065 6e64     escaped = end
-0000dbc0: 5f73 6c61 7368 6573 5f72 652e 7365 6172  _slashes_re.sear
-0000dbd0: 6368 2873 7472 696e 672c 2030 2c20 6d61  ch(string, 0, ma
-0000dbe0: 7463 682e 7374 6172 7428 2929 0a0a 2020  tch.start())..  
-0000dbf0: 2020 2020 2020 2020 2020 2320 7374 6172            # star
-0000dc00: 7420 6f66 2073 7472 696e 6720 6f72 2075  t of string or u
-0000dc10: 6e65 7363 6170 6564 2071 756f 7465 2063  nescaped quote c
-0000dc20: 6861 7261 6374 6572 2074 6f20 656e 6420  haracter to end 
-0000dc30: 7374 7269 6e67 0a20 2020 2020 2020 2020  string.         
-0000dc40: 2020 2069 6620 6e6f 7420 696e 5f73 7472     if not in_str
-0000dc50: 696e 6720 6f72 2028 6573 6361 7065 6420  ing or (escaped 
-0000dc60: 6973 204e 6f6e 6520 6f72 206c 656e 2865  is None or len(e
-0000dc70: 7363 6170 6564 2e67 726f 7570 2829 2920  scaped.group()) 
-0000dc80: 2520 3220 3d3d 2030 293a 0a20 2020 2020  % 2 == 0):.     
-0000dc90: 2020 2020 2020 2020 2020 2069 6e5f 7374             in_st
-0000dca0: 7269 6e67 203d 206e 6f74 2069 6e5f 7374  ring = not in_st
-0000dcb0: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
-0000dcc0: 2069 6e64 6578 202d 3d20 3120 2023 2069   index -= 1  # i
-0000dcd0: 6e63 6c75 6465 2022 2063 6861 7261 6374  nclude " charact
-0000dce0: 6572 2069 6e20 6e65 7874 2063 6174 6368  er in next catch
-0000dcf0: 0a20 2020 2020 2020 2065 6c69 6620 6e6f  .        elif no
-0000dd00: 7420 2869 6e5f 7374 7269 6e67 206f 7220  t (in_string or 
-0000dd10: 696e 5f6d 756c 7469 206f 7220 696e 5f73  in_multi or in_s
-0000dd20: 696e 676c 6529 3a0a 2020 2020 2020 2020  ingle):.        
-0000dd30: 2020 2020 6966 2076 616c 203d 3d20 222f      if val == "/
-0000dd40: 2a22 3a0a 2020 2020 2020 2020 2020 2020  *":.            
-0000dd50: 2020 2020 696e 5f6d 756c 7469 203d 2054      in_multi = T
-0000dd60: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0000dd70: 656c 6966 2076 616c 203d 3d20 222f 2f22  elif val == "//"
-0000dd80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000dd90: 2020 696e 5f73 696e 676c 6520 3d20 5472    in_single = Tr
-0000dda0: 7565 0a20 2020 2020 2020 2065 6c69 6620  ue.        elif 
-0000ddb0: 7661 6c20 3d3d 2022 2a2f 2220 616e 6420  val == "*/" and 
-0000ddc0: 696e 5f6d 756c 7469 2061 6e64 206e 6f74  in_multi and not
-0000ddd0: 2028 696e 5f73 7472 696e 6720 6f72 2069   (in_string or i
-0000dde0: 6e5f 7369 6e67 6c65 293a 0a20 2020 2020  n_single):.     
-0000ddf0: 2020 2020 2020 2069 6e5f 6d75 6c74 6920         in_multi 
-0000de00: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000de10: 656c 6966 2076 616c 2069 6e20 225c 725c  elif val in "\r\
-0000de20: 6e22 2061 6e64 206e 6f74 2028 696e 5f6d  n" and not (in_m
-0000de30: 756c 7469 206f 7220 696e 5f73 7472 696e  ulti or in_strin
-0000de40: 6729 2061 6e64 2069 6e5f 7369 6e67 6c65  g) and in_single
-0000de50: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-0000de60: 5f73 696e 676c 6520 3d20 4661 6c73 650a  _single = False.
-0000de70: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-0000de80: 2028 2869 6e5f 6d75 6c74 6920 6f72 2069   ((in_multi or i
-0000de90: 6e5f 7369 6e67 6c65 2920 6f72 2028 7661  n_single) or (va
-0000dea0: 6c20 696e 2022 205c 725c 6e5c 7422 2061  l in " \r\n\t" a
-0000deb0: 6e64 2073 7472 6970 5f73 7061 6365 2929  nd strip_space))
-0000dec0: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
-0000ded0: 775f 7374 722e 6170 7065 6e64 2876 616c  w_str.append(val
-0000dee0: 290a 0a20 2020 206e 6577 5f73 7472 2e61  )..    new_str.a
-0000def0: 7070 656e 6428 7374 7269 6e67 5b69 6e64  ppend(string[ind
-0000df00: 6578 3a5d 290a 2020 2020 7265 7475 726e  ex:]).    return
-0000df10: 2022 222e 6a6f 696e 286e 6577 5f73 7472   "".join(new_str
-0000df20: 290a 0a0a 6465 6620 5f70 7932 5f75 6e69  )...def _py2_uni
-0000df30: 636f 6465 5f74 6f5f 7374 725f 7265 6375  code_to_str_recu
-0000df40: 7273 6976 6528 7329 3a0a 2020 2020 2222  rsive(s):.    ""
-0000df50: 220a 2020 2020 5468 6973 2069 7320 7375  ".    This is su
-0000df60: 7070 6f73 6564 2074 6f20 6265 2072 756e  pposed to be run
-0000df70: 2077 6974 6820 5079 7468 6f6e 2032 2e0a   with Python 2..
-0000df80: 2020 2020 416c 736f 2073 6565 203a 6675      Also see :fu
-0000df90: 6e63 3a60 6173 5f73 7472 6020 616e 6420  nc:`as_str` and 
-0000dfa0: 3a66 756e 633a 6070 7932 5f75 7466 385f  :func:`py2_utf8_
-0000dfb0: 7374 725f 746f 5f75 6e69 636f 6465 602e  str_to_unicode`.
-0000dfc0: 0a0a 2020 2020 3a70 6172 616d 2073 7472  ..    :param str
-0000dfd0: 7c75 6e69 636f 6465 2073 3a20 6f72 2061  |unicode s: or a
-0000dfe0: 6e79 2072 6563 7572 7369 7665 2073 7472  ny recursive str
-0000dff0: 7563 7475 7265 2073 7563 6820 6173 2064  ucture such as d
-0000e000: 6963 742c 206c 6973 742c 2074 7570 6c65  ict, list, tuple
-0000e010: 0a20 2020 203a 7265 7475 726e 3a20 5079  .    :return: Py
-0000e020: 7468 6f6e 2032 2073 7472 2028 6973 206c  thon 2 str (is l
-0000e030: 696b 6520 5079 7468 6f6e 2033 2055 5446  ike Python 3 UTF
-0000e040: 2d38 2066 6f72 6d61 7474 6564 2062 7974  -8 formatted byt
-0000e050: 6573 290a 2020 2020 3a72 7479 7065 3a20  es).    :rtype: 
-0000e060: 7374 720a 2020 2020 2222 220a 2020 2020  str.    """.    
-0000e070: 6966 2069 7369 6e73 7461 6e63 6528 732c  if isinstance(s,
-0000e080: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
-0000e090: 7265 7475 726e 207b 5f70 7932 5f75 6e69  return {_py2_uni
-0000e0a0: 636f 6465 5f74 6f5f 7374 725f 7265 6375  code_to_str_recu
-0000e0b0: 7273 6976 6528 6b65 7929 3a20 5f70 7932  rsive(key): _py2
-0000e0c0: 5f75 6e69 636f 6465 5f74 6f5f 7374 725f  _unicode_to_str_
-0000e0d0: 7265 6375 7273 6976 6528 7661 6c75 6529  recursive(value)
-0000e0e0: 2066 6f72 206b 6579 2c20 7661 6c75 6520   for key, value 
-0000e0f0: 696e 2073 2e69 7465 6d73 2829 7d0a 2020  in s.items()}.  
-0000e100: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0000e110: 6528 732c 2028 6c69 7374 2c20 7475 706c  e(s, (list, tupl
-0000e120: 6529 293a 0a20 2020 2020 2020 2072 6574  e)):.        ret
-0000e130: 7572 6e20 6d61 6b65 5f73 6571 5f6f 665f  urn make_seq_of_
-0000e140: 7479 7065 2874 7970 6528 7329 2c20 5b5f  type(type(s), [_
-0000e150: 7079 325f 756e 6963 6f64 655f 746f 5f73  py2_unicode_to_s
-0000e160: 7472 5f72 6563 7572 7369 7665 2865 6c65  tr_recursive(ele
-0000e170: 6d65 6e74 2920 666f 7220 656c 656d 656e  ment) for elemen
-0000e180: 7420 696e 2073 5d29 0a20 2020 2065 6c69  t in s]).    eli
-0000e190: 6620 6973 696e 7374 616e 6365 2873 2c20  f isinstance(s, 
-0000e1a0: 756e 6963 6f64 6529 3a0a 2020 2020 2020  unicode):.      
-0000e1b0: 2020 7265 7475 726e 2073 2e65 6e63 6f64    return s.encod
-0000e1c0: 6528 2275 7466 2d38 2229 2020 2320 5079  e("utf-8")  # Py
-0000e1d0: 7468 6f6e 2032 2073 7472 2c20 5079 7468  thon 2 str, Pyth
-0000e1e0: 6f6e 2033 2062 7974 6573 0a20 2020 2065  on 3 bytes.    e
-0000e1f0: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
-0000e200: 7572 6e20 730a 0a0a 6465 6620 6c6f 6164  urn s...def load
-0000e210: 5f6a 736f 6e28 6669 6c65 6e61 6d65 3d4e  _json(filename=N
-0000e220: 6f6e 652c 2063 6f6e 7465 6e74 3d4e 6f6e  one, content=Non
-0000e230: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-0000e240: 3a70 6172 616d 2073 7472 7c4e 6f6e 6520  :param str|None 
-0000e250: 6669 6c65 6e61 6d65 3a0a 2020 2020 3a70  filename:.    :p
-0000e260: 6172 616d 2073 7472 7c4e 6f6e 6520 636f  aram str|None co
-0000e270: 6e74 656e 743a 0a20 2020 203a 7274 7970  ntent:.    :rtyp
-0000e280: 653a 2064 6963 745b 7374 725d 0a20 2020  e: dict[str].   
-0000e290: 2022 2222 0a20 2020 2069 6620 636f 6e74   """.    if cont
-0000e2a0: 656e 743a 0a20 2020 2020 2020 2061 7373  ent:.        ass
-0000e2b0: 6572 7420 6e6f 7420 6669 6c65 6e61 6d65  ert not filename
-0000e2c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0000e2d0: 2020 2063 6f6e 7465 6e74 203d 206f 7065     content = ope
-0000e2e0: 6e28 6669 6c65 6e61 6d65 292e 7265 6164  n(filename).read
-0000e2f0: 2829 0a20 2020 2069 6d70 6f72 7420 6a73  ().    import js
-0000e300: 6f6e 0a0a 2020 2020 636f 6e74 656e 7420  on..    content 
-0000e310: 3d20 6a73 6f6e 5f72 656d 6f76 655f 636f  = json_remove_co
-0000e320: 6d6d 656e 7473 2863 6f6e 7465 6e74 290a  mments(content).
-0000e330: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000e340: 206a 736f 6e5f 636f 6e74 656e 7420 3d20   json_content = 
-0000e350: 6a73 6f6e 2e6c 6f61 6473 2863 6f6e 7465  json.loads(conte
-0000e360: 6e74 290a 2020 2020 6578 6365 7074 2056  nt).    except V
-0000e370: 616c 7565 4572 726f 7220 6173 2065 3a0a  alueError as e:.
-0000e380: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0000e390: 6365 7074 696f 6e28 2263 6f6e 6669 6720  ception("config 
-0000e3a0: 6c6f 6f6b 7320 6c69 6b65 204a 534f 4e20  looks like JSON 
-0000e3b0: 6275 7420 696e 7661 6c69 6420 6a73 6f6e  but invalid json
-0000e3c0: 2063 6f6e 7465 6e74 2c20 2572 2220 2520   content, %r" % 
-0000e3d0: 6529 0a20 2020 2069 6620 6e6f 7420 5059  e).    if not PY
-0000e3e0: 333a 0a20 2020 2020 2020 206a 736f 6e5f  3:.        json_
-0000e3f0: 636f 6e74 656e 7420 3d20 5f70 7932 5f75  content = _py2_u
-0000e400: 6e69 636f 6465 5f74 6f5f 7374 725f 7265  nicode_to_str_re
-0000e410: 6375 7273 6976 6528 6a73 6f6e 5f63 6f6e  cursive(json_con
-0000e420: 7465 6e74 290a 2020 2020 7265 7475 726e  tent).    return
-0000e430: 206a 736f 6e5f 636f 6e74 656e 740a 0a0a   json_content...
-0000e440: 636c 6173 7320 4e75 6d62 6572 7344 6963  class NumbersDic
-0000e450: 743a 0a20 2020 2022 2222 0a20 2020 2049  t:.    """.    I
-0000e460: 7427 7320 6d6f 7374 6c79 206c 696b 6520  t's mostly like 
-0000e470: 6469 6374 5b73 7472 2c66 6c6f 6174 7c69  dict[str,float|i
-0000e480: 6e74 5d20 2620 736f 6d65 206f 7074 696f  nt] & some optio
-0000e490: 6e61 6c20 6272 6f61 6463 6173 7420 6465  nal broadcast de
-0000e4a0: 6661 756c 7420 7661 6c75 652e 0a20 2020  fault value..   
-0000e4b0: 2049 7420 696d 706c 656d 656e 7473 2074   It implements t
-0000e4c0: 6865 2073 7461 6e64 6172 6420 6d61 7468  he standard math
-0000e4d0: 2062 696e 206f 7073 2069 6e20 6120 7374   bin ops in a st
-0000e4e0: 7261 6967 6874 2d66 6f72 7761 7264 2077  raight-forward w
-0000e4f0: 6179 2e0a 2020 2020 2222 220a 0a20 2020  ay..    """..   
-0000e500: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-0000e510: 6c66 2c20 6175 746f 5f63 6f6e 7665 7274  lf, auto_convert
-0000e520: 3d4e 6f6e 652c 206e 756d 6265 7273 5f64  =None, numbers_d
-0000e530: 6963 743d 4e6f 6e65 2c20 6272 6f61 6463  ict=None, broadc
-0000e540: 6173 745f 7661 6c75 653d 4e6f 6e65 293a  ast_value=None):
-0000e550: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000e560: 2020 2020 203a 7061 7261 6d20 6469 6374       :param dict
-0000e570: 7c4e 756d 6265 7273 4469 6374 7c54 2061  |NumbersDict|T a
-0000e580: 7574 6f5f 636f 6e76 6572 743a 2066 6972  uto_convert: fir
-0000e590: 7374 2061 7267 756d 656e 742c 2073 6f20  st argument, so 
-0000e5a0: 7468 6174 2077 6520 6361 6e20 6175 746f  that we can auto
-0000e5b0: 6d61 7469 6361 6c6c 7920 636f 6e76 6572  matically conver
-0000e5c0: 742f 636f 7079 0a20 2020 2020 2020 203a  t/copy.        :
-0000e5d0: 7061 7261 6d20 6469 6374 206e 756d 6265  param dict numbe
-0000e5e0: 7273 5f64 6963 743a 0a20 2020 2020 2020  rs_dict:.       
-0000e5f0: 203a 7061 7261 6d20 5420 6272 6f61 6463   :param T broadc
-0000e600: 6173 745f 7661 6c75 653a 0a20 2020 2020  ast_value:.     
-0000e610: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-0000e620: 6620 6175 746f 5f63 6f6e 7665 7274 2069  f auto_convert i
-0000e630: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0000e640: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
-0000e650: 726f 6164 6361 7374 5f76 616c 7565 2069  roadcast_value i
-0000e660: 7320 4e6f 6e65 0a20 2020 2020 2020 2020  s None.         
-0000e670: 2020 2061 7373 6572 7420 6e75 6d62 6572     assert number
-0000e680: 735f 6469 6374 2069 7320 4e6f 6e65 0a20  s_dict is None. 
-0000e690: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0000e6a0: 696e 7374 616e 6365 2861 7574 6f5f 636f  instance(auto_co
-0000e6b0: 6e76 6572 742c 2064 6963 7429 3a0a 2020  nvert, dict):.  
-0000e6c0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-0000e6d0: 6d62 6572 735f 6469 6374 203d 2061 7574  mbers_dict = aut
-0000e6e0: 6f5f 636f 6e76 6572 740a 2020 2020 2020  o_convert.      
-0000e6f0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-0000e700: 7461 6e63 6528 6175 746f 5f63 6f6e 7665  tance(auto_conve
-0000e710: 7274 2c20 4e75 6d62 6572 7344 6963 7429  rt, NumbersDict)
-0000e720: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e730: 2020 6e75 6d62 6572 735f 6469 6374 203d    numbers_dict =
-0000e740: 2061 7574 6f5f 636f 6e76 6572 742e 6469   auto_convert.di
-0000e750: 6374 0a20 2020 2020 2020 2020 2020 2020  ct.             
-0000e760: 2020 2062 726f 6164 6361 7374 5f76 616c     broadcast_val
-0000e770: 7565 203d 2061 7574 6f5f 636f 6e76 6572  ue = auto_conver
-0000e780: 742e 7661 6c75 650a 2020 2020 2020 2020  t.value.        
-0000e790: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000e7a0: 2020 2020 2020 2020 2020 6272 6f61 6463            broadc
-0000e7b0: 6173 745f 7661 6c75 6520 3d20 6175 746f  ast_value = auto
-0000e7c0: 5f63 6f6e 7665 7274 0a20 2020 2020 2020  _convert.       
-0000e7d0: 2069 6620 6e75 6d62 6572 735f 6469 6374   if numbers_dict
-0000e7e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000e7f0: 2020 2020 2020 6e75 6d62 6572 735f 6469        numbers_di
-0000e800: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
-0000e810: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000e820: 2020 6e75 6d62 6572 735f 6469 6374 203d    numbers_dict =
-0000e830: 2064 6963 7428 6e75 6d62 6572 735f 6469   dict(numbers_di
-0000e840: 6374 2920 2023 2066 6f72 6365 2063 6f70  ct)  # force cop
-0000e850: 790a 0a20 2020 2020 2020 2073 656c 662e  y..        self.
-0000e860: 6469 6374 203d 206e 756d 6265 7273 5f64  dict = numbers_d
-0000e870: 6963 740a 2020 2020 2020 2020 7365 6c66  ict.        self
-0000e880: 2e76 616c 7565 203d 2062 726f 6164 6361  .value = broadca
-0000e890: 7374 5f76 616c 7565 0a20 2020 2020 2020  st_value.       
-0000e8a0: 2073 656c 662e 6d61 7820 3d20 7365 6c66   self.max = self
-0000e8b0: 2e5f 6d61 785f 6572 726f 720a 0a20 2020  ._max_error..   
-0000e8c0: 2064 6566 2063 6f70 7928 7365 6c66 293a   def copy(self):
-0000e8d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000e8e0: 2020 2020 203a 7274 7970 653a 204e 756d       :rtype: Num
-0000e8f0: 6265 7273 4469 6374 0a20 2020 2020 2020  bersDict.       
-0000e900: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-0000e910: 7572 6e20 4e75 6d62 6572 7344 6963 7428  urn NumbersDict(
-0000e920: 7365 6c66 290a 0a20 2020 2040 636c 6173  self)..    @clas
-0000e930: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
-0000e940: 636f 6e73 7461 6e74 5f6c 696b 6528 636c  constant_like(cl
-0000e950: 732c 2063 6f6e 7374 5f6e 756d 6265 722c  s, const_number,
-0000e960: 206e 756d 6265 7273 5f64 6963 7429 3a0a   numbers_dict):.
-0000e970: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000e980: 2020 2020 3a70 6172 616d 2069 6e74 7c66      :param int|f
-0000e990: 6c6f 6174 7c6f 626a 6563 7420 636f 6e73  loat|object cons
-0000e9a0: 745f 6e75 6d62 6572 3a0a 2020 2020 2020  t_number:.      
-0000e9b0: 2020 3a70 6172 616d 204e 756d 6265 7273    :param Numbers
-0000e9c0: 4469 6374 206e 756d 6265 7273 5f64 6963  Dict numbers_dic
-0000e9d0: 743a 0a20 2020 2020 2020 203a 7265 7475  t:.        :retu
-0000e9e0: 726e 3a20 4e75 6d62 6572 7344 6963 7420  rn: NumbersDict 
-0000e9f0: 7769 7468 2073 616d 6520 6b65 7973 2061  with same keys a
-0000ea00: 7320 6e75 6d62 6572 735f 6469 6374 0a20  s numbers_dict. 
-0000ea10: 2020 2020 2020 203a 7274 7970 653a 204e         :rtype: N
-0000ea20: 756d 6265 7273 4469 6374 0a20 2020 2020  umbersDict.     
-0000ea30: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-0000ea40: 6574 7572 6e20 4e75 6d62 6572 7344 6963  eturn NumbersDic
-0000ea50: 7428 0a20 2020 2020 2020 2020 2020 2062  t(.            b
-0000ea60: 726f 6164 6361 7374 5f76 616c 7565 3d63  roadcast_value=c
-0000ea70: 6f6e 7374 5f6e 756d 6265 7220 6966 2028  onst_number if (
-0000ea80: 6e75 6d62 6572 735f 6469 6374 2e76 616c  numbers_dict.val
-0000ea90: 7565 2069 7320 6e6f 7420 4e6f 6e65 2920  ue is not None) 
-0000eaa0: 656c 7365 204e 6f6e 652c 0a20 2020 2020  else None,.     
-0000eab0: 2020 2020 2020 206e 756d 6265 7273 5f64         numbers_d
-0000eac0: 6963 743d 7b6b 3a20 636f 6e73 745f 6e75  ict={k: const_nu
-0000ead0: 6d62 6572 2066 6f72 206b 2069 6e20 6e75  mber for k in nu
-0000eae0: 6d62 6572 735f 6469 6374 2e64 6963 742e  mbers_dict.dict.
-0000eaf0: 6b65 7973 2829 7d2c 0a20 2020 2020 2020  keys()},.       
-0000eb00: 2029 0a0a 2020 2020 6465 6620 636f 7079   )..    def copy
-0000eb10: 5f6c 696b 6528 7365 6c66 2c20 6e75 6d62  _like(self, numb
-0000eb20: 6572 735f 6469 6374 293a 0a20 2020 2020  ers_dict):.     
-0000eb30: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
-0000eb40: 7061 7261 6d20 4e75 6d62 6572 7344 6963  param NumbersDic
-0000eb50: 7420 6e75 6d62 6572 735f 6469 6374 3a0a  t numbers_dict:.
-0000eb60: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0000eb70: 2063 6f70 7920 6f66 2073 656c 6620 7769   copy of self wi
-0000eb80: 7468 2073 616d 6520 6b65 7973 2061 7320  th same keys as 
-0000eb90: 6e75 6d62 6572 735f 6469 6374 2061 7320  numbers_dict as 
-0000eba0: 6661 7220 6173 2077 6520 6861 7665 2074  far as we have t
-0000ebb0: 6865 6d0a 2020 2020 2020 2020 3a72 7479  hem.        :rty
-0000ebc0: 7065 3a20 4e75 6d62 6572 7344 6963 740a  pe: NumbersDict.
-0000ebd0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000ebe0: 2020 2020 6966 2073 656c 662e 7661 6c75      if self.valu
-0000ebf0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-0000ec00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000ec10: 6e20 4e75 6d62 6572 7344 6963 7428 0a20  n NumbersDict(. 
-0000ec20: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000ec30: 726f 6164 6361 7374 5f76 616c 7565 3d73  roadcast_value=s
-0000ec40: 656c 662e 7661 6c75 6520 6966 2028 6e75  elf.value if (nu
-0000ec50: 6d62 6572 735f 6469 6374 2e76 616c 7565  mbers_dict.value
-0000ec60: 2069 7320 6e6f 7420 4e6f 6e65 2920 656c   is not None) el
-0000ec70: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
-0000ec80: 2020 2020 2020 2020 206e 756d 6265 7273           numbers
-0000ec90: 5f64 6963 743d 7b6b 3a20 7365 6c66 5b6b  _dict={k: self[k
-0000eca0: 5d20 666f 7220 6b20 696e 206e 756d 6265  ] for k in numbe
-0000ecb0: 7273 5f64 6963 742e 6469 6374 2e6b 6579  rs_dict.dict.key
-0000ecc0: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
-0000ecd0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-0000ece0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000ecf0: 7475 726e 204e 756d 6265 7273 4469 6374  turn NumbersDict
-0000ed00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000ed10: 2020 6272 6f61 6463 6173 745f 7661 6c75    broadcast_valu
-0000ed20: 653d 4e6f 6e65 2c20 6e75 6d62 6572 735f  e=None, numbers_
-0000ed30: 6469 6374 3d7b 6b3a 2073 656c 665b 6b5d  dict={k: self[k]
-0000ed40: 2066 6f72 206b 2069 6e20 6e75 6d62 6572   for k in number
-0000ed50: 735f 6469 6374 2e64 6963 742e 6b65 7973  s_dict.dict.keys
-0000ed60: 2829 2069 6620 6b20 696e 2073 656c 662e  () if k in self.
-0000ed70: 6469 6374 7d0a 2020 2020 2020 2020 2020  dict}.          
-0000ed80: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
-0000ed90: 7479 0a20 2020 2064 6566 206b 6579 735f  ty.    def keys_
-0000eda0: 7365 7428 7365 6c66 293a 0a20 2020 2020  set(self):.     
-0000edb0: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
-0000edc0: 6c73 6f20 7365 6520 3a66 756e 633a 606b  lso see :func:`k
-0000edd0: 6579 735f 756e 696f 6e60 2069 6620 796f  eys_union` if yo
-0000ede0: 7520 7761 6e74 2074 6f20 6861 7665 2061  u want to have a
-0000edf0: 2064 6574 6572 6d69 6e69 7374 6963 206f   deterministic o
-0000ee00: 7264 6572 2e0a 0a20 2020 2020 2020 203a  rder...        :
-0000ee10: 7274 7970 653a 2073 6574 5b73 7472 5d0a  rtype: set[str].
-0000ee20: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000ee30: 2020 2020 7265 7475 726e 2073 6574 2873      return set(s
-0000ee40: 656c 662e 6469 6374 2e6b 6579 7328 2929  elf.dict.keys())
-0000ee50: 0a0a 2020 2020 6465 6620 6b65 7973 5f75  ..    def keys_u
-0000ee60: 6e69 6f6e 282a 6e75 6d62 6572 5f64 6963  nion(*number_dic
-0000ee70: 7473 3a20 4e75 6d62 6572 7344 6963 7429  ts: NumbersDict)
-0000ee80: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
-0000ee90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000eea0: 2020 203a 7265 7475 726e 3a20 756e 696f     :return: unio
-0000eeb0: 6e20 6f66 206b 6579 7320 6f76 6572 2073  n of keys over s
-0000eec0: 656c 6620 616e 6420 6f74 6865 722e 2054  elf and other. T
-0000eed0: 6865 206f 7264 6572 2077 696c 6c20 6265  he order will be
-0000eee0: 2064 6574 6572 6d69 6e69 7374 6963 2028   deterministic (
-0000eef0: 756e 6c69 6b65 203a 6675 6e63 3a60 6b65  unlike :func:`ke
-0000ef00: 7973 5f73 6574 6029 0a20 2020 2020 2020  ys_set`).       
-0000ef10: 2022 2222 0a20 2020 2020 2020 2073 6565   """.        see
-0000ef20: 6e20 3d20 7365 7428 290a 2020 2020 2020  n = set().      
-0000ef30: 2020 7265 7320 3d20 5b5d 0a20 2020 2020    res = [].     
-0000ef40: 2020 2066 6f72 206e 756d 6265 725f 6469     for number_di
-0000ef50: 6374 2069 6e20 6e75 6d62 6572 5f64 6963  ct in number_dic
-0000ef60: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0000ef70: 666f 7220 6b65 7920 696e 206e 756d 6265  for key in numbe
-0000ef80: 725f 6469 6374 2e64 6963 742e 6b65 7973  r_dict.dict.keys
-0000ef90: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000efa0: 2020 2020 6966 206b 6579 206e 6f74 2069      if key not i
-0000efb0: 6e20 7365 656e 3a0a 2020 2020 2020 2020  n seen:.        
-0000efc0: 2020 2020 2020 2020 2020 2020 7365 656e              seen
-0000efd0: 2e61 6464 286b 6579 290a 2020 2020 2020  .add(key).      
-0000efe0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000eff0: 732e 6170 7065 6e64 286b 6579 290a 2020  s.append(key).  
-0000f000: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0000f010: 0a0a 2020 2020 6465 6620 5f5f 6765 7469  ..    def __geti
-0000f020: 7465 6d5f 5f28 7365 6c66 2c20 6b65 7929  tem__(self, key)
-0000f030: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-0000f040: 662e 7661 6c75 6520 6973 206e 6f74 204e  f.value is not N
-0000f050: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000f060: 2072 6574 7572 6e20 7365 6c66 2e64 6963   return self.dic
-0000f070: 742e 6765 7428 6b65 792c 2073 656c 662e  t.get(key, self.
-0000f080: 7661 6c75 6529 0a20 2020 2020 2020 2072  value).        r
-0000f090: 6574 7572 6e20 7365 6c66 2e64 6963 745b  eturn self.dict[
-0000f0a0: 6b65 795d 0a0a 2020 2020 6465 6620 5f5f  key]..    def __
-0000f0b0: 7365 7469 7465 6d5f 5f28 7365 6c66 2c20  setitem__(self, 
-0000f0c0: 6b65 792c 2076 616c 7565 293a 0a20 2020  key, value):.   
-0000f0d0: 2020 2020 2073 656c 662e 6469 6374 5b6b       self.dict[k
-0000f0e0: 6579 5d20 3d20 7661 6c75 650a 0a20 2020  ey] = value..   
-0000f0f0: 2064 6566 205f 5f64 656c 6974 656d 5f5f   def __delitem__
-0000f100: 2873 656c 662c 206b 6579 293a 0a20 2020  (self, key):.   
-0000f110: 2020 2020 2064 656c 2073 656c 662e 6469       del self.di
-0000f120: 6374 5b6b 6579 5d0a 0a20 2020 2064 6566  ct[key]..    def
-0000f130: 2067 6574 2873 656c 662c 206b 6579 2c20   get(self, key, 
-0000f140: 6465 6661 756c 743d 4e6f 6e65 293a 0a20  default=None):. 
-0000f150: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000f160: 2020 203a 7061 7261 6d20 7374 7220 6b65     :param str ke
-0000f170: 793a 0a20 2020 2020 2020 203a 7061 7261  y:.        :para
-0000f180: 6d20 5420 6465 6661 756c 743a 0a20 2020  m T default:.   
-0000f190: 2020 2020 203a 7274 7970 653a 206f 626a       :rtype: obj
-0000f1a0: 6563 747c 540a 2020 2020 2020 2020 2222  ect|T.        ""
-0000f1b0: 220a 2020 2020 2020 2020 2320 4b65 6570  ".        # Keep
-0000f1c0: 2063 6f6e 7369 7374 656e 7420 7769 7468   consistent with
-0000f1d0: 2073 656c 662e 5f5f 6765 745f 6974 656d   self.__get_item
-0000f1e0: 5f5f 2e20 4966 2073 656c 662e 7661 6c75  __. If self.valu
-0000f1f0: 6520 6973 2073 6574 2c20 7468 6973 2077  e is set, this w
-0000f200: 696c 6c20 616c 7761 7973 2062 6520 7468  ill always be th
-0000f210: 6520 6465 6661 756c 7420 7661 6c75 652e  e default value.
-0000f220: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f230: 7365 6c66 2e64 6963 742e 6765 7428 6b65  self.dict.get(ke
-0000f240: 792c 2073 656c 662e 7661 6c75 6520 6966  y, self.value if
-0000f250: 2073 656c 662e 7661 6c75 6520 6973 206e   self.value is n
-0000f260: 6f74 204e 6f6e 6520 656c 7365 2064 6566  ot None else def
-0000f270: 6175 6c74 290a 0a20 2020 2064 6566 2070  ault)..    def p
-0000f280: 6f70 2873 656c 662c 206b 6579 2c20 2a61  op(self, key, *a
-0000f290: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
-0000f2a0: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
-0000f2b0: 2073 7472 206b 6579 3a0a 2020 2020 2020   str key:.      
-0000f2c0: 2020 3a70 6172 616d 2054 2061 7267 733a    :param T args:
-0000f2d0: 2064 6566 6175 6c74 2c20 6f72 206e 6f74   default, or not
-0000f2e0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-0000f2f0: 206f 626a 6563 747c 540a 2020 2020 2020   object|T.      
-0000f300: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-0000f310: 7475 726e 2073 656c 662e 6469 6374 2e70  turn self.dict.p
-0000f320: 6f70 286b 6579 2c20 2a61 7267 7329 0a0a  op(key, *args)..
-0000f330: 2020 2020 6465 6620 5f5f 6974 6572 5f5f      def __iter__
-0000f340: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000f350: 2320 5468 6973 2063 616e 2070 6f74 656e  # This can poten
-0000f360: 7469 616c 6c79 2063 6175 7365 2063 6f6e  tially cause con
-0000f370: 6675 7369 6f6e 2e20 536f 2065 6e66 6f72  fusion. So enfor
-0000f380: 6365 2065 7870 6c69 6369 746e 6573 732e  ce explicitness.
-0000f390: 0a20 2020 2020 2020 2023 2046 6f72 2061  .        # For a
-0000f3a0: 2064 6963 742c 2077 6520 776f 756c 6420   dict, we would 
-0000f3b0: 7265 7475 726e 2074 6865 2064 6963 7420  return the dict 
-0000f3c0: 6b65 7973 2068 6572 652e 0a20 2020 2020  keys here..     
-0000f3d0: 2020 2023 2041 6c73 6f2c 206d 6178 2873     # Also, max(s
-0000f3e0: 656c 6629 2077 6f75 6c64 2072 6573 756c  elf) would resul
-0000f3f0: 7420 696e 2061 2063 616c 6c20 746f 2073  t in a call to s
-0000f400: 656c 662e 5f5f 6974 6572 5f5f 2829 2c0a  elf.__iter__(),.
-0000f410: 2020 2020 2020 2020 2320 7768 6963 6820          # which 
-0000f420: 776f 756c 6420 6f6e 6c79 206d 616b 6520  would only make 
-0000f430: 7365 6e73 6520 666f 7220 6f75 7220 7661  sense for our va
-0000f440: 6c75 6573 2c20 6e6f 7420 7468 6520 6469  lues, not the di
-0000f450: 6374 206b 6579 732e 0a20 2020 2020 2020  ct keys..       
-0000f460: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-0000f470: 2822 2573 2e5f 5f69 7465 725f 5f20 6973  ("%s.__iter__ is
-0000f480: 2075 6e64 6566 696e 6564 2220 2520 7365   undefined" % se
-0000f490: 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  lf.__class__.__n
-0000f4a0: 616d 655f 5f29 0a0a 2020 2020 6465 6620  ame__)..    def 
-0000f4b0: 6b65 7973 2873 656c 6629 3a0a 2020 2020  keys(self):.    
-0000f4c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000f4d0: 3a72 7479 7065 3a20 7365 745b 7374 725d  :rtype: set[str]
-0000f4e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000f4f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000f500: 2e64 6963 742e 6b65 7973 2829 0a0a 2020  .dict.keys()..  
-0000f510: 2020 6465 6620 7661 6c75 6573 2873 656c    def values(sel
-0000f520: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-0000f530: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-0000f540: 6c69 7374 5b6f 626a 6563 745d 0a20 2020  list[object].   
-0000f550: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000f560: 2072 6574 7572 6e20 6c69 7374 2873 656c   return list(sel
-0000f570: 662e 6469 6374 2e76 616c 7565 7328 2929  f.dict.values())
-0000f580: 202b 2028 5b73 656c 662e 7661 6c75 655d   + ([self.value]
-0000f590: 2069 6620 7365 6c66 2e76 616c 7565 2069   if self.value i
-0000f5a0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-0000f5b0: 5b5d 290a 0a20 2020 2064 6566 2069 7465  [])..    def ite
-0000f5c0: 6d73 2873 656c 6629 3a0a 2020 2020 2020  ms(self):.      
-0000f5d0: 2020 2222 220a 2020 2020 2020 2020 3a72    """.        :r
-0000f5e0: 6574 7572 6e3a 2064 6963 7420 6974 656d  eturn: dict item
-0000f5f0: 732e 2074 6869 7320 6578 636c 7564 6573  s. this excludes
-0000f600: 2073 656c 662e 7661 6c75 650a 2020 2020   self.value.    
-0000f610: 2020 2020 3a72 7479 7065 3a20 7374 725b      :rtype: str[
-0000f620: 2873 7472 2c6f 626a 6563 7429 5d0a 2020  (str,object)].  
-0000f630: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000f640: 2020 7265 7475 726e 2073 656c 662e 6469    return self.di
-0000f650: 6374 2e69 7465 6d73 2829 0a0a 2020 2020  ct.items()..    
-0000f660: 6465 6620 6861 735f 7661 6c75 6573 2873  def has_values(s
-0000f670: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-0000f680: 220a 2020 2020 2020 2020 3a72 7479 7065  ".        :rtype
-0000f690: 3a20 626f 6f6c 0a20 2020 2020 2020 2022  : bool.        "
-0000f6a0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-0000f6b0: 6e20 626f 6f6c 2873 656c 662e 6469 6374  n bool(self.dict
-0000f6c0: 2920 6f72 2073 656c 662e 7661 6c75 6520  ) or self.value 
-0000f6d0: 6973 206e 6f74 204e 6f6e 650a 0a20 2020  is not None..   
-0000f6e0: 2064 6566 2075 6e61 7279 5f6f 7028 7365   def unary_op(se
-0000f6f0: 6c66 2c20 6f70 293a 0a20 2020 2020 2020  lf, op):.       
-0000f700: 2022 2222 0a20 2020 2020 2020 203a 7061   """.        :pa
-0000f710: 7261 6d20 2854 292d 3e54 3220 6f70 3a0a  ram (T)->T2 op:.
-0000f720: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0000f730: 206e 6577 204e 756d 6265 7273 4469 6374   new NumbersDict
-0000f740: 2c20 7768 6572 6520 6060 6f70 6060 2069  , where ``op`` i
-0000f750: 7320 6170 706c 6965 6420 6f6e 2061 6c6c  s applied on all
-0000f760: 2076 616c 7565 730a 2020 2020 2020 2020   values.        
-0000f770: 3a72 7479 7065 3a20 4e75 6d62 6572 7344  :rtype: NumbersD
-0000f780: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
-0000f790: 2020 2020 2020 2020 7265 7320 3d20 4e75          res = Nu
-0000f7a0: 6d62 6572 7344 6963 7428 290a 2020 2020  mbersDict().    
-0000f7b0: 2020 2020 6966 2073 656c 662e 7661 6c75      if self.valu
-0000f7c0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-0000f7d0: 2020 2020 2020 2020 2020 2072 6573 2e76             res.v
-0000f7e0: 616c 7565 203d 206f 7028 7365 6c66 2e76  alue = op(self.v
-0000f7f0: 616c 7565 290a 2020 2020 2020 2020 666f  alue).        fo
-0000f800: 7220 6b2c 2076 2069 6e20 7365 6c66 2e64  r k, v in self.d
-0000f810: 6963 742e 6974 656d 7328 293a 0a20 2020  ict.items():.   
-0000f820: 2020 2020 2020 2020 2072 6573 2e64 6963           res.dic
-0000f830: 745b 6b5d 203d 206f 7028 7629 0a20 2020  t[k] = op(v).   
-0000f840: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
-0000f850: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-0000f860: 640a 2020 2020 6465 6620 6269 6e5f 6f70  d.    def bin_op
-0000f870: 5f73 6361 6c61 725f 6f70 7469 6f6e 616c  _scalar_optional
-0000f880: 2863 6c73 2c20 7365 6c66 2c20 6f74 6865  (cls, self, othe
-0000f890: 722c 207a 6572 6f2c 206f 7029 3a0a 2020  r, zero, op):.  
-0000f8a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000f8b0: 2020 3a70 6172 616d 2054 2073 656c 663a    :param T self:
-0000f8c0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000f8d0: 5420 6f74 6865 723a 0a20 2020 2020 2020  T other:.       
-0000f8e0: 203a 7061 7261 6d20 5420 7a65 726f 3a0a   :param T zero:.
-0000f8f0: 2020 2020 2020 2020 3a70 6172 616d 2028          :param (
-0000f900: 542c 5429 2d3e 5420 6f70 3a0a 2020 2020  T,T)->T op:.    
-0000f910: 2020 2020 3a72 7479 7065 3a20 540a 2020      :rtype: T.  
-0000f920: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000f930: 2020 6966 2073 656c 6620 6973 204e 6f6e    if self is Non
-0000f940: 6520 616e 6420 6f74 6865 7220 6973 204e  e and other is N
-0000f950: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000f960: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0000f970: 2020 2020 2069 6620 7365 6c66 2069 7320       if self is 
-0000f980: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000f990: 2020 7365 6c66 203d 207a 6572 6f0a 2020    self = zero.  
-0000f9a0: 2020 2020 2020 6966 206f 7468 6572 2069        if other i
-0000f9b0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000f9c0: 2020 2020 6f74 6865 7220 3d20 7a65 726f      other = zero
-0000f9d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f9e0: 6f70 2873 656c 662c 206f 7468 6572 290a  op(self, other).
-0000f9f0: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-0000fa00: 640a 2020 2020 6465 6620 6269 6e5f 6f70  d.    def bin_op
-0000fa10: 2863 6c73 2c20 7365 6c66 2c20 6f74 6865  (cls, self, othe
-0000fa20: 722c 206f 702c 207a 6572 6f2c 2072 6573  r, op, zero, res
-0000fa30: 756c 743d 4e6f 6e65 293a 0a20 2020 2020  ult=None):.     
-0000fa40: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
-0000fa50: 7061 7261 6d20 4e75 6d62 6572 7344 6963  param NumbersDic
-0000fa60: 747c 696e 747c 666c 6f61 747c 5420 7365  t|int|float|T se
-0000fa70: 6c66 3a0a 2020 2020 2020 2020 3a70 6172  lf:.        :par
-0000fa80: 616d 204e 756d 6265 7273 4469 6374 7c69  am NumbersDict|i
-0000fa90: 6e74 7c66 6c6f 6174 7c54 206f 7468 6572  nt|float|T other
-0000faa0: 3a0a 2020 2020 2020 2020 3a70 6172 616d  :.        :param
-0000fab0: 2028 542c 5429 2d3e 5420 6f70 3a0a 2020   (T,T)->T op:.  
-0000fac0: 2020 2020 2020 3a70 6172 616d 2054 207a        :param T z
-0000fad0: 6572 6f3a 0a20 2020 2020 2020 203a 7061  ero:.        :pa
-0000fae0: 7261 6d20 4e75 6d62 6572 7344 6963 747c  ram NumbersDict|
-0000faf0: 4e6f 6e65 2072 6573 756c 743a 0a20 2020  None result:.   
-0000fb00: 2020 2020 203a 7274 7970 653a 204e 756d       :rtype: Num
-0000fb10: 6265 7273 4469 6374 0a20 2020 2020 2020  bersDict.       
-0000fb20: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-0000fb30: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
-0000fb40: 656c 662c 204e 756d 6265 7273 4469 6374  elf, NumbersDict
-0000fb50: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0000fb60: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0000fb70: 6572 2c20 4e75 6d62 6572 7344 6963 7429  er, NumbersDict)
-0000fb80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fb90: 2020 7365 6c66 203d 204e 756d 6265 7273    self = Numbers
-0000fba0: 4469 6374 2e63 6f6e 7374 616e 745f 6c69  Dict.constant_li
-0000fbb0: 6b65 2873 656c 662c 206e 756d 6265 7273  ke(self, numbers
-0000fbc0: 5f64 6963 743d 6f74 6865 7229 0a20 2020  _dict=other).   
-0000fbd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000fbf0: 656c 6620 3d20 4e75 6d62 6572 7344 6963  elf = NumbersDic
-0000fc00: 7428 7365 6c66 290a 2020 2020 2020 2020  t(self).        
-0000fc10: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-0000fc20: 6528 6f74 6865 722c 204e 756d 6265 7273  e(other, Numbers
-0000fc30: 4469 6374 293a 0a20 2020 2020 2020 2020  Dict):.         
-0000fc40: 2020 206f 7468 6572 203d 204e 756d 6265     other = Numbe
-0000fc50: 7273 4469 6374 2e63 6f6e 7374 616e 745f  rsDict.constant_
-0000fc60: 6c69 6b65 286f 7468 6572 2c20 6e75 6d62  like(other, numb
-0000fc70: 6572 735f 6469 6374 3d73 656c 6629 0a20  ers_dict=self). 
-0000fc80: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
-0000fc90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000fca0: 2020 2020 2020 7265 7375 6c74 203d 204e        result = N
-0000fcb0: 756d 6265 7273 4469 6374 2829 0a20 2020  umbersDict().   
-0000fcc0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0000fcd0: 7374 616e 6365 2872 6573 756c 742c 204e  stance(result, N
-0000fce0: 756d 6265 7273 4469 6374 290a 2020 2020  umbersDict).    
-0000fcf0: 2020 2020 666f 7220 6b20 696e 2073 656c      for k in sel
-0000fd00: 662e 6b65 7973 5f75 6e69 6f6e 286f 7468  f.keys_union(oth
-0000fd10: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
-0000fd20: 2072 6573 756c 745b 6b5d 203d 2063 6c73   result[k] = cls
-0000fd30: 2e62 696e 5f6f 705f 7363 616c 6172 5f6f  .bin_op_scalar_o
-0000fd40: 7074 696f 6e61 6c28 7365 6c66 2e67 6574  ptional(self.get
-0000fd50: 286b 2c20 4e6f 6e65 292c 206f 7468 6572  (k, None), other
-0000fd60: 2e67 6574 286b 2c20 4e6f 6e65 292c 207a  .get(k, None), z
-0000fd70: 6572 6f3d 7a65 726f 2c20 6f70 3d6f 7029  ero=zero, op=op)
-0000fd80: 0a20 2020 2020 2020 2072 6573 756c 742e  .        result.
-0000fd90: 7661 6c75 6520 3d20 636c 732e 6269 6e5f  value = cls.bin_
-0000fda0: 6f70 5f73 6361 6c61 725f 6f70 7469 6f6e  op_scalar_option
-0000fdb0: 616c 2873 656c 662e 7661 6c75 652c 206f  al(self.value, o
-0000fdc0: 7468 6572 2e76 616c 7565 2c20 7a65 726f  ther.value, zero
-0000fdd0: 3d7a 6572 6f2c 206f 703d 6f70 290a 2020  =zero, op=op).  
-0000fde0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0000fdf0: 756c 740a 0a20 2020 2064 6566 205f 5f61  ult..    def __a
-0000fe00: 6464 5f5f 2873 656c 662c 206f 7468 6572  dd__(self, other
-0000fe10: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000fe20: 6e20 7365 6c66 2e62 696e 5f6f 7028 7365  n self.bin_op(se
-0000fe30: 6c66 2c20 6f74 6865 722c 206f 703d 6c61  lf, other, op=la
-0000fe40: 6d62 6461 2061 2c20 623a 2061 202b 2062  mbda a, b: a + b
-0000fe50: 2c20 7a65 726f 3d30 290a 0a20 2020 205f  , zero=0)..    _
-0000fe60: 5f72 6164 645f 5f20 3d20 5f5f 6164 645f  _radd__ = __add_
-0000fe70: 5f0a 0a20 2020 2064 6566 205f 5f69 6164  _..    def __iad
-0000fe80: 645f 5f28 7365 6c66 2c20 6f74 6865 7229  d__(self, other)
-0000fe90: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000fea0: 2073 656c 662e 6269 6e5f 6f70 2873 656c   self.bin_op(sel
-0000feb0: 662c 206f 7468 6572 2c20 6f70 3d6c 616d  f, other, op=lam
-0000fec0: 6264 6120 612c 2062 3a20 6120 2b20 622c  bda a, b: a + b,
-0000fed0: 207a 6572 6f3d 302c 2072 6573 756c 743d   zero=0, result=
-0000fee0: 7365 6c66 290a 0a20 2020 2064 6566 205f  self)..    def _
-0000fef0: 5f73 7562 5f5f 2873 656c 662c 206f 7468  _sub__(self, oth
-0000ff00: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
-0000ff10: 7572 6e20 7365 6c66 2e62 696e 5f6f 7028  urn self.bin_op(
-0000ff20: 7365 6c66 2c20 6f74 6865 722c 206f 703d  self, other, op=
-0000ff30: 6c61 6d62 6461 2061 2c20 623a 2061 202d  lambda a, b: a -
-0000ff40: 2062 2c20 7a65 726f 3d30 290a 0a20 2020   b, zero=0)..   
-0000ff50: 2064 6566 205f 5f72 7375 625f 5f28 7365   def __rsub__(se
-0000ff60: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
-0000ff70: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000ff80: 6269 6e5f 6f70 2873 656c 662c 206f 7468  bin_op(self, oth
-0000ff90: 6572 2c20 6f70 3d6c 616d 6264 6120 612c  er, op=lambda a,
-0000ffa0: 2062 3a20 6220 2d20 612c 207a 6572 6f3d   b: b - a, zero=
-0000ffb0: 3029 0a0a 2020 2020 6465 6620 5f5f 6973  0)..    def __is
-0000ffc0: 7562 5f5f 2873 656c 662c 206f 7468 6572  ub__(self, other
-0000ffd0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000ffe0: 6e20 7365 6c66 2e62 696e 5f6f 7028 7365  n self.bin_op(se
-0000fff0: 6c66 2c20 6f74 6865 722c 206f 703d 6c61  lf, other, op=la
-00010000: 6d62 6461 2061 2c20 623a 2061 202d 2062  mbda a, b: a - b
-00010010: 2c20 7a65 726f 3d30 2c20 7265 7375 6c74  , zero=0, result
-00010020: 3d73 656c 6629 0a0a 2020 2020 6465 6620  =self)..    def 
-00010030: 5f5f 6d75 6c5f 5f28 7365 6c66 2c20 6f74  __mul__(self, ot
-00010040: 6865 7229 3a0a 2020 2020 2020 2020 7265  her):.        re
-00010050: 7475 726e 2073 656c 662e 6269 6e5f 6f70  turn self.bin_op
-00010060: 2873 656c 662c 206f 7468 6572 2c20 6f70  (self, other, op
-00010070: 3d6c 616d 6264 6120 612c 2062 3a20 6120  =lambda a, b: a 
-00010080: 2a20 622c 207a 6572 6f3d 3129 0a0a 2020  * b, zero=1)..  
-00010090: 2020 5f5f 726d 756c 5f5f 203d 205f 5f6d    __rmul__ = __m
-000100a0: 756c 5f5f 0a0a 2020 2020 6465 6620 5f5f  ul__..    def __
-000100b0: 696d 756c 5f5f 2873 656c 662c 206f 7468  imul__(self, oth
-000100c0: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
-000100d0: 7572 6e20 7365 6c66 2e62 696e 5f6f 7028  urn self.bin_op(
-000100e0: 7365 6c66 2c20 6f74 6865 722c 206f 703d  self, other, op=
-000100f0: 6c61 6d62 6461 2061 2c20 623a 2061 202a  lambda a, b: a *
-00010100: 2062 2c20 7a65 726f 3d31 2c20 7265 7375   b, zero=1, resu
-00010110: 6c74 3d73 656c 6629 0a0a 2020 2020 6465  lt=self)..    de
-00010120: 6620 5f5f 6469 765f 5f28 7365 6c66 2c20  f __div__(self, 
-00010130: 6f74 6865 7229 3a0a 2020 2020 2020 2020  other):.        
-00010140: 7265 7475 726e 2073 656c 662e 6269 6e5f  return self.bin_
-00010150: 6f70 2873 656c 662c 206f 7468 6572 2c20  op(self, other, 
-00010160: 6f70 3d6c 616d 6264 6120 612c 2062 3a20  op=lambda a, b: 
-00010170: 6120 2f20 622c 207a 6572 6f3d 3129 0a0a  a / b, zero=1)..
-00010180: 2020 2020 5f5f 7264 6976 5f5f 203d 205f      __rdiv__ = _
-00010190: 5f64 6976 5f5f 0a20 2020 205f 5f74 7275  _div__.    __tru
-000101a0: 6564 6976 5f5f 203d 205f 5f64 6976 5f5f  ediv__ = __div__
-000101b0: 0a0a 2020 2020 6465 6620 5f5f 6964 6976  ..    def __idiv
-000101c0: 5f5f 2873 656c 662c 206f 7468 6572 293a  __(self, other):
-000101d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000101e0: 7365 6c66 2e62 696e 5f6f 7028 7365 6c66  self.bin_op(self
-000101f0: 2c20 6f74 6865 722c 206f 703d 6c61 6d62  , other, op=lamb
-00010200: 6461 2061 2c20 623a 2061 202f 2062 2c20  da a, b: a / b, 
-00010210: 7a65 726f 3d31 2c20 7265 7375 6c74 3d73  zero=1, result=s
-00010220: 656c 6629 0a0a 2020 2020 5f5f 6974 7275  elf)..    __itru
-00010230: 6564 6976 5f5f 203d 205f 5f69 6469 765f  ediv__ = __idiv_
-00010240: 5f0a 0a20 2020 2064 6566 205f 5f66 6c6f  _..    def __flo
-00010250: 6f72 6469 765f 5f28 7365 6c66 2c20 6f74  ordiv__(self, ot
-00010260: 6865 7229 3a0a 2020 2020 2020 2020 7265  her):.        re
-00010270: 7475 726e 2073 656c 662e 6269 6e5f 6f70  turn self.bin_op
-00010280: 2873 656c 662c 206f 7468 6572 2c20 6f70  (self, other, op
-00010290: 3d6c 616d 6264 6120 612c 2062 3a20 6120  =lambda a, b: a 
-000102a0: 2f2f 2062 2c20 7a65 726f 3d31 290a 0a20  // b, zero=1).. 
-000102b0: 2020 2064 6566 205f 5f69 666c 6f6f 7264     def __ifloord
-000102c0: 6976 5f5f 2873 656c 662c 206f 7468 6572  iv__(self, other
-000102d0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-000102e0: 6e20 7365 6c66 2e62 696e 5f6f 7028 7365  n self.bin_op(se
-000102f0: 6c66 2c20 6f74 6865 722c 206f 703d 6c61  lf, other, op=la
-00010300: 6d62 6461 2061 2c20 623a 2061 202f 2f20  mbda a, b: a // 
-00010310: 622c 207a 6572 6f3d 312c 2072 6573 756c  b, zero=1, resul
-00010320: 743d 7365 6c66 290a 0a20 2020 2064 6566  t=self)..    def
-00010330: 205f 5f6e 6567 5f5f 2873 656c 6629 3a0a   __neg__(self):.
-00010340: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00010350: 656c 662e 756e 6172 795f 6f70 286f 703d  elf.unary_op(op=
-00010360: 6c61 6d62 6461 2061 3a20 2d61 290a 0a20  lambda a: -a).. 
-00010370: 2020 2064 6566 205f 5f62 6f6f 6c5f 5f28     def __bool__(
-00010380: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00010390: 6574 7572 6e20 616e 7928 7365 6c66 2e76  eturn any(self.v
-000103a0: 616c 7565 7328 2929 0a0a 2020 2020 5f5f  alues())..    __
-000103b0: 6e6f 6e7a 6572 6f5f 5f20 3d20 5f5f 626f  nonzero__ = __bo
-000103c0: 6f6c 5f5f 2020 2320 5079 7468 6f6e 2032  ol__  # Python 2
-000103d0: 0a0a 2020 2020 6465 6620 656c 656d 5f65  ..    def elem_e
-000103e0: 7128 7365 6c66 2c20 6f74 6865 722c 2072  q(self, other, r
-000103f0: 6573 756c 745f 7769 7468 5f64 6566 6175  esult_with_defau
-00010400: 6c74 3d54 7275 6529 3a0a 2020 2020 2020  lt=True):.      
-00010410: 2020 2222 220a 2020 2020 2020 2020 456c    """.        El
-00010420: 656d 656e 742d 7769 7365 2065 7175 616c  ement-wise equal
-00010430: 6974 7920 6368 6563 6b20 7769 7468 206f  ity check with o
-00010440: 7468 6572 2e0a 2020 2020 2020 2020 4e6f  ther..        No
-00010450: 7465 2061 626f 7574 2062 726f 6164 6361  te about broadca
-00010460: 7374 2064 6566 6175 6c74 2076 616c 7565  st default value
-00010470: 3a20 436f 6e73 6964 6572 2073 6f6d 6520  : Consider some 
-00010480: 6b65 7920 7768 6963 6820 6973 206e 6569  key which is nei
-00010490: 7468 6572 2069 6e20 7365 6c66 206e 6f72  ther in self nor
-000104a0: 2069 6e20 6f74 6865 722e 0a20 2020 2020   in other..     
-000104b0: 2020 2020 2054 6869 7320 6d65 616e 7320       This means 
-000104c0: 7468 6174 2073 656c 665b 6b65 795d 203d  that self[key] =
-000104d0: 3d20 7365 6c66 2e64 6566 6175 6c74 2c20  = self.default, 
-000104e0: 6f74 6865 725b 6b65 795d 203d 3d20 6f74  other[key] == ot
-000104f0: 6865 722e 6465 6661 756c 742e 0a20 2020  her.default..   
-00010500: 2020 2020 2020 2054 6875 732c 2069 6e20         Thus, in 
-00010510: 6361 7365 2074 6861 7420 7365 6c66 2e64  case that self.d
-00010520: 6566 6175 6c74 2021 3d20 6f74 6865 722e  efault != other.
-00010530: 6465 6661 756c 742c 2077 6520 6765 7420  default, we get 
-00010540: 7265 732e 6465 6661 756c 7420 3d3d 2046  res.default == F
-00010550: 616c 7365 2e0a 2020 2020 2020 2020 2020  alse..          
-00010560: 5468 656e 2c20 616c 6c28 7265 732e 7661  Then, all(res.va
-00010570: 6c75 6573 2829 2920 3d3d 2046 616c 7365  lues()) == False
-00010580: 2c20 6576 656e 2077 6865 6e20 616c 6c20  , even when all 
-00010590: 6f74 6865 7220 7661 6c75 6573 2061 7265  other values are
-000105a0: 2054 7275 652e 0a20 2020 2020 2020 2020   True..         
-000105b0: 2054 6869 7320 6973 2073 6f6d 6574 696d   This is sometim
-000105c0: 6573 206e 6f74 2077 6861 7420 7765 2077  es not what we w
-000105d0: 616e 742e 0a20 2020 2020 2020 2020 2059  ant..          Y
-000105e0: 6f75 2063 616e 2063 6f6e 7472 6f6c 2074  ou can control t
-000105f0: 6865 2062 6568 6176 696f 7220 7669 6120  he behavior via 
-00010600: 7265 7375 6c74 5f77 6974 685f 6465 6661  result_with_defa
-00010610: 756c 742e 0a0a 2020 2020 2020 2020 3a70  ult...        :p
-00010620: 6172 616d 204e 756d 6265 7273 4469 6374  aram NumbersDict
-00010630: 7c54 206f 7468 6572 3a0a 2020 2020 2020  |T other:.      
-00010640: 2020 3a70 6172 616d 2062 6f6f 6c20 7265    :param bool re
-00010650: 7375 6c74 5f77 6974 685f 6465 6661 756c  sult_with_defaul
-00010660: 743a 0a20 2020 2020 2020 203a 7274 7970  t:.        :rtyp
-00010670: 653a 204e 756d 6265 7273 4469 6374 0a20  e: NumbersDict. 
-00010680: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00010690: 2020 2020 6465 6620 6f70 2861 2c20 6229      def op(a, b)
-000106a0: 3a0a 2020 2020 2020 2020 2020 2020 2222  :.            ""
-000106b0: 220a 2020 2020 2020 2020 2020 2020 3a70  ".            :p
-000106c0: 6172 616d 2061 3a0a 2020 2020 2020 2020  aram a:.        
-000106d0: 2020 2020 3a70 6172 616d 2062 3a0a 2020      :param b:.  
-000106e0: 2020 2020 2020 2020 2020 3a72 7479 7065            :rtype
-000106f0: 3a20 626f 6f6c 7c4e 6f6e 650a 2020 2020  : bool|None.    
-00010700: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00010710: 2020 2020 2020 2020 6966 2061 2069 7320          if a is 
-00010720: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00010730: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00010740: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00010750: 2062 2069 7320 4e6f 6e65 3a0a 2020 2020   b is None:.    
-00010760: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010770: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
-00010780: 2020 2020 7265 7475 726e 2061 203d 3d20      return a == 
-00010790: 620a 0a20 2020 2020 2020 2072 6573 203d  b..        res =
-000107a0: 2073 656c 662e 6269 6e5f 6f70 2873 656c   self.bin_op(sel
-000107b0: 662c 206f 7468 6572 2c20 6f70 3d6f 702c  f, other, op=op,
-000107c0: 207a 6572 6f3d 4e6f 6e65 290a 2020 2020   zero=None).    
-000107d0: 2020 2020 6966 206e 6f74 2072 6573 756c      if not resul
-000107e0: 745f 7769 7468 5f64 6566 6175 6c74 3a0a  t_with_default:.
-000107f0: 2020 2020 2020 2020 2020 2020 7265 732e              res.
-00010800: 7661 6c75 6520 3d20 4e6f 6e65 0a20 2020  value = None.   
-00010810: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
-00010820: 0a20 2020 2064 6566 205f 5f65 715f 5f28  .    def __eq__(
-00010830: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
-00010840: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00010850: 2020 3a70 6172 616d 204e 756d 6265 7273    :param Numbers
-00010860: 4469 6374 7c54 206f 7468 6572 3a0a 2020  Dict|T other:.  
-00010870: 2020 2020 2020 3a72 6574 7572 6e3a 2077        :return: w
-00010880: 6865 7468 6572 2073 656c 6620 3d3d 206f  hether self == o
-00010890: 7468 6572 2065 6c65 6d77 6973 652e 2073  ther elemwise. s
-000108a0: 6565 2073 656c 662e 656c 656d 5f65 710a  ee self.elem_eq.
-000108b0: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-000108c0: 626f 6f6c 0a20 2020 2020 2020 2022 2222  bool.        """
-000108d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000108e0: 616c 6c28 7365 6c66 2e65 6c65 6d5f 6571  all(self.elem_eq
-000108f0: 286f 7468 6572 292e 7661 6c75 6573 2829  (other).values()
-00010900: 290a 0a20 2020 2064 6566 205f 5f6e 655f  )..    def __ne_
-00010910: 5f28 7365 6c66 2c20 6f74 6865 7229 3a0a  _(self, other):.
-00010920: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00010930: 2020 2020 3a70 6172 616d 204e 756d 6265      :param Numbe
-00010940: 7273 4469 6374 7c54 206f 7468 6572 3a0a  rsDict|T other:.
-00010950: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00010960: 206e 6f74 2028 7365 6c66 203d 3d20 6f74   not (self == ot
-00010970: 6865 7229 0a20 2020 2020 2020 203a 7274  her).        :rt
-00010980: 7970 653a 2062 6f6f 6c0a 2020 2020 2020  ype: bool.      
-00010990: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-000109a0: 7475 726e 206e 6f74 2028 7365 6c66 203d  turn not (self =
-000109b0: 3d20 6f74 6865 7229 0a0a 2020 2020 6465  = other)..    de
-000109c0: 6620 5f5f 636d 705f 5f28 7365 6c66 2c20  f __cmp__(self, 
-000109d0: 6f74 6865 7229 3a0a 2020 2020 2020 2020  other):.        
-000109e0: 2320 5468 6572 6520 6973 206e 6f20 676f  # There is no go
-000109f0: 6f64 2073 7472 6169 6768 742d 666f 7277  od straight-forw
-00010a00: 6172 6420 696d 706c 656d 656e 7461 7469  ard implementati
-00010a10: 6f6e 0a20 2020 2020 2020 2023 2061 6e64  on.        # and
-00010a20: 2069 7420 776f 756c 6420 6a75 7374 2063   it would just c
-00010a30: 6f6e 6675 7365 2e0a 2020 2020 2020 2020  onfuse..        
-00010a40: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-00010a50: 2225 732e 5f5f 636d 705f 5f20 6973 2075  "%s.__cmp__ is u
-00010a60: 6e64 6566 696e 6564 2220 2520 7365 6c66  ndefined" % self
-00010a70: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
-00010a80: 655f 5f29 0a0a 2020 2020 6465 6620 616e  e__)..    def an
-00010a90: 795f 636f 6d70 6172 6528 7365 6c66 2c20  y_compare(self, 
-00010aa0: 6f74 6865 722c 2063 6d70 293a 0a20 2020  other, cmp):.   
-00010ab0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00010ac0: 203a 7061 7261 6d20 4e75 6d62 6572 7344   :param NumbersD
-00010ad0: 6963 7420 6f74 6865 723a 0a20 2020 2020  ict other:.     
-00010ae0: 2020 203a 7061 7261 6d20 2828 6f62 6a65     :param ((obje
-00010af0: 6374 2c6f 626a 6563 7429 2d3e 5472 7565  ct,object)->True
-00010b00: 2920 636d 703a 0a20 2020 2020 2020 203a  ) cmp:.        :
-00010b10: 7274 7970 653a 2054 7275 650a 2020 2020  rtype: True.    
-00010b20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00010b30: 666f 7220 6b65 7920 696e 2073 656c 662e  for key in self.
-00010b40: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
-00010b50: 2020 2020 6966 206b 6579 2069 6e20 6f74      if key in ot
-00010b60: 6865 722e 6b65 7973 2829 3a0a 2020 2020  her.keys():.    
-00010b70: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00010b80: 6d70 2873 656c 665b 6b65 795d 2c20 6f74  mp(self[key], ot
-00010b90: 6865 725b 6b65 795d 293a 0a20 2020 2020  her[key]):.     
-00010ba0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010bb0: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
-00010bc0: 2020 2020 2020 2065 6c69 6620 6f74 6865         elif othe
-00010bd0: 722e 7661 6c75 6520 6973 206e 6f74 204e  r.value is not N
-00010be0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00010bf0: 2020 2020 2069 6620 636d 7028 7365 6c66       if cmp(self
-00010c00: 5b6b 6579 5d2c 206f 7468 6572 2e76 616c  [key], other.val
-00010c10: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
-00010c20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00010c30: 5472 7565 0a20 2020 2020 2020 2069 6620  True.        if 
-00010c40: 7365 6c66 2e76 616c 7565 2069 7320 6e6f  self.value is no
-00010c50: 7420 4e6f 6e65 2061 6e64 206f 7468 6572  t None and other
-00010c60: 2e76 616c 7565 2069 7320 6e6f 7420 4e6f  .value is not No
-00010c70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00010c80: 6966 2063 6d70 2873 656c 662e 7661 6c75  if cmp(self.valu
-00010c90: 652c 206f 7468 6572 2e76 616c 7565 293a  e, other.value):
-00010ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010cb0: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
-00010cc0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00010cd0: 650a 0a20 2020 2040 7374 6174 6963 6d65  e..    @staticme
-00010ce0: 7468 6f64 0a20 2020 2064 6566 205f 6d61  thod.    def _ma
-00010cf0: 7828 2a61 7267 7329 3a0a 2020 2020 2020  x(*args):.      
-00010d00: 2020 6172 6773 203d 205b 6120 666f 7220    args = [a for 
-00010d10: 6120 696e 2061 7267 7320 6966 2061 2069  a in args if a i
-00010d20: 7320 6e6f 7420 4e6f 6e65 5d0a 2020 2020  s not None].    
-00010d30: 2020 2020 6966 206e 6f74 2061 7267 733a      if not args:
-00010d40: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00010d50: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-00010d60: 2069 6620 6c65 6e28 6172 6773 2920 3d3d   if len(args) ==
-00010d70: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00010d80: 7265 7475 726e 2061 7267 735b 305d 0a20  return args[0]. 
-00010d90: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
-00010da0: 7828 2a61 7267 7329 0a0a 2020 2020 4073  x(*args)..    @s
-00010db0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-00010dc0: 6465 6620 5f6d 696e 282a 6172 6773 293a  def _min(*args):
-00010dd0: 0a20 2020 2020 2020 2061 7267 7320 3d20  .        args = 
-00010de0: 5b61 2066 6f72 2061 2069 6e20 6172 6773  [a for a in args
-00010df0: 2069 6620 6120 6973 206e 6f74 204e 6f6e   if a is not Non
-00010e00: 655d 0a20 2020 2020 2020 2069 6620 6e6f  e].        if no
-00010e10: 7420 6172 6773 3a0a 2020 2020 2020 2020  t args:.        
-00010e20: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00010e30: 2020 2020 2020 2020 6966 206c 656e 2861          if len(a
-00010e40: 7267 7329 203d 3d20 313a 0a20 2020 2020  rgs) == 1:.     
-00010e50: 2020 2020 2020 2072 6574 7572 6e20 6172         return ar
-00010e60: 6773 5b30 5d0a 2020 2020 2020 2020 7265  gs[0].        re
-00010e70: 7475 726e 206d 696e 282a 6172 6773 290a  turn min(*args).
-00010e80: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-00010e90: 640a 2020 2020 6465 6620 6d61 7828 636c  d.    def max(cl
-00010ea0: 732c 2069 7465 6d73 293a 0a20 2020 2020  s, items):.     
-00010eb0: 2020 2022 2222 0a20 2020 2020 2020 2045     """.        E
-00010ec0: 6c65 6d65 6e74 2d77 6973 6520 6d61 7869  lement-wise maxi
-00010ed0: 6d75 6d20 666f 7220 6974 656d 2069 6e20  mum for item in 
-00010ee0: 6974 656d 732e 0a20 2020 2020 2020 203a  items..        :
-00010ef0: 7061 7261 6d20 6c69 7374 5b4e 756d 6265  param list[Numbe
-00010f00: 7273 4469 6374 7c69 6e74 7c66 6c6f 6174  rsDict|int|float
-00010f10: 5d20 6974 656d 733a 0a20 2020 2020 2020  ] items:.       
-00010f20: 203a 7274 7970 653a 204e 756d 6265 7273   :rtype: Numbers
-00010f30: 4469 6374 0a20 2020 2020 2020 2022 2222  Dict.        """
-00010f40: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00010f50: 6974 656d 730a 2020 2020 2020 2020 6966  items.        if
-00010f60: 206c 656e 2869 7465 6d73 2920 3d3d 2031   len(items) == 1
-00010f70: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00010f80: 7475 726e 204e 756d 6265 7273 4469 6374  turn NumbersDict
-00010f90: 2869 7465 6d73 5b30 5d29 0a20 2020 2020  (items[0]).     
-00010fa0: 2020 2069 6620 6c65 6e28 6974 656d 7329     if len(items)
-00010fb0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-00010fc0: 2020 2072 6574 7572 6e20 636c 732e 6269     return cls.bi
-00010fd0: 6e5f 6f70 2869 7465 6d73 5b30 5d2c 2069  n_op(items[0], i
-00010fe0: 7465 6d73 5b31 5d2c 206f 703d 636c 732e  tems[1], op=cls.
-00010ff0: 5f6d 6178 2c20 7a65 726f 3d4e 6f6e 6529  _max, zero=None)
-00011000: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011010: 636c 732e 6d61 7828 5b69 7465 6d73 5b30  cls.max([items[0
-00011020: 5d2c 2063 6c73 2e6d 6178 2869 7465 6d73  ], cls.max(items
-00011030: 5b31 3a5d 295d 290a 0a20 2020 2040 636c  [1:])])..    @cl
-00011040: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
-00011050: 6620 6d69 6e28 636c 732c 2069 7465 6d73  f min(cls, items
-00011060: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00011070: 2020 2020 2020 2045 6c65 6d65 6e74 2d77         Element-w
-00011080: 6973 6520 6d69 6e69 6d75 6d20 666f 7220  ise minimum for 
-00011090: 6974 656d 2069 6e20 6974 656d 732e 0a20  item in items.. 
-000110a0: 2020 2020 2020 203a 7061 7261 6d20 6c69         :param li
-000110b0: 7374 5b4e 756d 6265 7273 4469 6374 7c69  st[NumbersDict|i
-000110c0: 6e74 7c66 6c6f 6174 5d20 6974 656d 733a  nt|float] items:
-000110d0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
-000110e0: 204e 756d 6265 7273 4469 6374 0a20 2020   NumbersDict.   
-000110f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00011100: 2061 7373 6572 7420 6974 656d 730a 2020   assert items.  
-00011110: 2020 2020 2020 6966 206c 656e 2869 7465        if len(ite
-00011120: 6d73 2920 3d3d 2031 3a0a 2020 2020 2020  ms) == 1:.      
-00011130: 2020 2020 2020 7265 7475 726e 204e 756d        return Num
-00011140: 6265 7273 4469 6374 2869 7465 6d73 5b30  bersDict(items[0
-00011150: 5d29 0a20 2020 2020 2020 2069 6620 6c65  ]).        if le
-00011160: 6e28 6974 656d 7329 203d 3d20 323a 0a20  n(items) == 2:. 
-00011170: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00011180: 6e20 636c 732e 6269 6e5f 6f70 2869 7465  n cls.bin_op(ite
-00011190: 6d73 5b30 5d2c 2069 7465 6d73 5b31 5d2c  ms[0], items[1],
-000111a0: 206f 703d 636c 732e 5f6d 696e 2c20 7a65   op=cls._min, ze
-000111b0: 726f 3d4e 6f6e 6529 0a20 2020 2020 2020  ro=None).       
-000111c0: 2072 6574 7572 6e20 636c 732e 6d69 6e28   return cls.min(
-000111d0: 5b69 7465 6d73 5b30 5d2c 2063 6c73 2e6d  [items[0], cls.m
-000111e0: 696e 2869 7465 6d73 5b31 3a5d 295d 290a  in(items[1:])]).
-000111f0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-00011200: 6f64 0a20 2020 2064 6566 205f 6d61 785f  od.    def _max_
-00011210: 6572 726f 7228 293a 0a20 2020 2020 2020  error():.       
-00011220: 2023 2057 696c 6c20 7265 706c 6163 6520   # Will replace 
-00011230: 7365 6c66 2e6d 6178 2066 6f72 2065 6163  self.max for eac
-00011240: 6820 696e 7374 616e 6365 2e20 546f 2062  h instance. To b
-00011250: 6520 7375 7265 2074 6861 7420 7765 2064  e sure that we d
-00011260: 6f6e 2774 2063 6f6e 6675 7365 2069 7420  on't confuse it 
-00011270: 7769 7468 2073 656c 662e 6d61 785f 7661  with self.max_va
-00011280: 6c75 652e 0a20 2020 2020 2020 2072 6169  lue..        rai
-00011290: 7365 2045 7863 6570 7469 6f6e 2822 5573  se Exception("Us
-000112a0: 6520 6d61 785f 7661 6c75 6520 696e 7374  e max_value inst
-000112b0: 6561 642e 2229 0a0a 2020 2020 6465 6620  ead.")..    def 
-000112c0: 6d61 785f 7661 6c75 6528 7365 6c66 293a  max_value(self):
-000112d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000112e0: 2020 2020 204d 6178 696d 756d 206f 6620       Maximum of 
-000112f0: 6f75 7220 7661 6c75 6573 2e0a 2020 2020  our values..    
-00011300: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00011310: 7265 7475 726e 206d 6178 2873 656c 662e  return max(self.
-00011320: 7661 6c75 6573 2829 290a 0a20 2020 2064  values())..    d
-00011330: 6566 206d 696e 5f76 616c 7565 2873 656c  ef min_value(sel
-00011340: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-00011350: 2020 2020 2020 2020 4d69 6e69 6d75 6d20          Minimum 
-00011360: 6f66 206f 7572 2076 616c 7565 732e 0a20  of our values.. 
-00011370: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00011380: 2020 2072 6574 7572 6e20 6d69 6e28 7365     return min(se
-00011390: 6c66 2e76 616c 7565 7328 2929 0a0a 2020  lf.values())..  
-000113a0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
-000113b0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
-000113c0: 2073 656c 662e 7661 6c75 6520 6973 204e   self.value is N
-000113d0: 6f6e 6520 616e 6420 6e6f 7420 7365 6c66  one and not self
-000113e0: 2e64 6963 743a 0a20 2020 2020 2020 2020  .dict:.         
-000113f0: 2020 2072 6574 7572 6e20 2225 7328 2922     return "%s()"
-00011400: 2025 2073 656c 662e 5f5f 636c 6173 735f   % self.__class_
-00011410: 5f2e 5f5f 6e61 6d65 5f5f 0a20 2020 2020  _.__name__.     
-00011420: 2020 2069 6620 7365 6c66 2e76 616c 7565     if self.value
-00011430: 2069 7320 4e6f 6e65 2061 6e64 2073 656c   is None and sel
-00011440: 662e 6469 6374 3a0a 2020 2020 2020 2020  f.dict:.        
-00011450: 2020 2020 7265 7475 726e 2022 2573 2825      return "%s(%
-00011460: 7229 2220 2520 2873 656c 662e 5f5f 636c  r)" % (self.__cl
-00011470: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 2c20  ass__.__name__, 
-00011480: 7365 6c66 2e64 6963 7429 0a20 2020 2020  self.dict).     
-00011490: 2020 2069 6620 6e6f 7420 7365 6c66 2e64     if not self.d
-000114a0: 6963 7420 616e 6420 7365 6c66 2e76 616c  ict and self.val
-000114b0: 7565 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ue is not None:.
-000114c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000114d0: 726e 2022 2573 2825 7229 2220 2520 2873  rn "%s(%r)" % (s
-000114e0: 656c 662e 5f5f 636c 6173 735f 5f2e 5f5f  elf.__class__.__
-000114f0: 6e61 6d65 5f5f 2c20 7365 6c66 2e76 616c  name__, self.val
-00011500: 7565 290a 2020 2020 2020 2020 7265 7475  ue).        retu
-00011510: 726e 2022 2573 286e 756d 6265 7273 5f64  rn "%s(numbers_d
-00011520: 6963 743d 2572 2c20 6272 6f61 6463 6173  ict=%r, broadcas
-00011530: 745f 7661 6c75 653d 2572 2922 2025 2028  t_value=%r)" % (
-00011540: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
-00011550: 5f6e 616d 655f 5f2c 2073 656c 662e 6469  _name__, self.di
-00011560: 6374 2c20 7365 6c66 2e76 616c 7565 290a  ct, self.value).
-00011570: 0a0a 6465 6620 636f 6c6c 6563 745f 636c  ..def collect_cl
-00011580: 6173 735f 696e 6974 5f6b 7761 7267 7328  ass_init_kwargs(
-00011590: 636c 732c 206f 6e6c 795f 7769 7468 5f64  cls, only_with_d
-000115a0: 6566 6175 6c74 3d46 616c 7365 293a 0a20  efault=False):. 
-000115b0: 2020 2022 2222 0a20 2020 203a 7061 7261     """.    :para
-000115c0: 6d20 7479 7065 2063 6c73 3a20 636c 6173  m type cls: clas
-000115d0: 732c 2077 6865 7265 2069 7420 6173 7375  s, where it assu
-000115e0: 6d65 7320 7468 6174 206b 7761 7267 7320  mes that kwargs 
-000115f0: 6172 6520 7061 7373 6564 206f 6e20 746f  are passed on to
-00011600: 2062 6173 6520 636c 6173 7365 730a 2020   base classes.  
-00011610: 2020 3a70 6172 616d 2062 6f6f 6c20 6f6e    :param bool on
-00011620: 6c79 5f77 6974 685f 6465 6661 756c 743a  ly_with_default:
-00011630: 2069 6620 6769 7665 6e20 7769 6c6c 206f   if given will o
-00011640: 6e6c 7920 7265 7475 726e 2074 6865 206b  nly return the k
-00011650: 7761 7267 7320 7769 7468 2064 6566 6175  wargs with defau
-00011660: 6c74 2076 616c 7565 730a 2020 2020 3a72  lt values.    :r
-00011670: 6574 7572 6e3a 2073 6574 2069 6620 6e6f  eturn: set if no
-00011680: 7420 7769 7468 5f64 6566 6175 6c74 2c20  t with_default, 
-00011690: 6f74 6865 7277 6973 6520 7468 6520 6469  otherwise the di
-000116a0: 6374 2074 6f20 7468 6520 6465 6661 756c  ct to the defaul
-000116b0: 7420 7661 6c75 6573 0a20 2020 203a 7274  t values.    :rt
-000116c0: 7970 653a 206c 6973 745b 7374 725d 207c  ype: list[str] |
-000116d0: 2064 6963 745b 7374 725d 0a20 2020 2022   dict[str].    "
-000116e0: 2222 0a20 2020 2066 726f 6d20 636f 6c6c  "".    from coll
-000116f0: 6563 7469 6f6e 7320 696d 706f 7274 204f  ections import O
-00011700: 7264 6572 6564 4469 6374 0a0a 2020 2020  rderedDict..    
-00011710: 6966 206f 6e6c 795f 7769 7468 5f64 6566  if only_with_def
-00011720: 6175 6c74 3a0a 2020 2020 2020 2020 6b77  ault:.        kw
-00011730: 6172 6773 203d 204f 7264 6572 6564 4469  args = OrderedDi
-00011740: 6374 2829 0a20 2020 2065 6c73 653a 0a20  ct().    else:. 
-00011750: 2020 2020 2020 206b 7761 7267 7320 3d20         kwargs = 
-00011760: 5b5d 0a20 2020 2066 6f72 2063 6c73 5f20  [].    for cls_ 
-00011770: 696e 2069 6e73 7065 6374 2e67 6574 6d72  in inspect.getmr
-00011780: 6f28 636c 7329 3a0a 2020 2020 2020 2020  o(cls):.        
-00011790: 2320 4368 6563 6b20 5079 7468 6f6e 2066  # Check Python f
-000117a0: 756e 6374 696f 6e2e 2043 6f75 6c64 2062  unction. Could b
-000117b0: 6520 6275 696c 7469 6e20 6675 6e63 206f  e builtin func o
-000117c0: 7220 736f 2e20 5079 7468 6f6e 2032 2067  r so. Python 2 g
-000117d0: 6574 6172 6773 7065 6320 646f 6573 206e  etargspec does n
-000117e0: 6f74 2077 6f72 6b20 696e 2074 6861 7420  ot work in that 
-000117f0: 6361 7365 2e0a 2020 2020 2020 2020 6966  case..        if
-00011800: 206e 6f74 2069 6e73 7065 6374 2e69 736d   not inspect.ism
-00011810: 6574 686f 6428 636c 735f 2e5f 5f69 6e69  ethod(cls_.__ini
-00011820: 745f 5f29 2061 6e64 206e 6f74 2069 6e73  t__) and not ins
-00011830: 7065 6374 2e69 7366 756e 6374 696f 6e28  pect.isfunction(
-00011840: 636c 735f 2e5f 5f69 6e69 745f 5f29 3a0a  cls_.__init__):.
-00011850: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00011860: 696e 7565 0a20 2020 2020 2020 2061 7267  inue.        arg
-00011870: 5f73 7065 6320 3d20 6765 7461 7267 7370  _spec = getargsp
-00011880: 6563 2863 6c73 5f2e 5f5f 696e 6974 5f5f  ec(cls_.__init__
-00011890: 290a 2020 2020 2020 2020 6172 6773 203d  ).        args =
-000118a0: 2061 7267 5f73 7065 632e 6172 6773 5b31   arg_spec.args[1
-000118b0: 3a5d 2020 2320 6669 7273 7420 6172 6720  :]  # first arg 
-000118c0: 6973 2073 656c 662c 2069 676e 6f72 650a  is self, ignore.
-000118d0: 2020 2020 2020 2020 6966 206f 6e6c 795f          if only_
-000118e0: 7769 7468 5f64 6566 6175 6c74 3a0a 2020  with_default:.  
-000118f0: 2020 2020 2020 2020 2020 6966 2061 7267            if arg
-00011900: 5f73 7065 632e 6465 6661 756c 7473 3a0a  _spec.defaults:.
-00011910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011920: 6173 7365 7274 206c 656e 2861 7267 5f73  assert len(arg_s
-00011930: 7065 632e 6465 6661 756c 7473 2920 3c3d  pec.defaults) <=
-00011940: 206c 656e 2861 7267 7329 0a20 2020 2020   len(args).     
-00011950: 2020 2020 2020 2020 2020 2061 7267 7320             args 
-00011960: 3d20 6172 6773 5b6c 656e 2861 7267 7329  = args[len(args)
-00011970: 202d 206c 656e 2861 7267 5f73 7065 632e   - len(arg_spec.
-00011980: 6465 6661 756c 7473 2920 3a5d 0a20 2020  defaults) :].   
-00011990: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000119a0: 6572 7420 6c65 6e28 6172 675f 7370 6563  ert len(arg_spec
-000119b0: 2e64 6566 6175 6c74 7329 203d 3d20 6c65  .defaults) == le
-000119c0: 6e28 6172 6773 292c 2061 7267 5f73 7065  n(args), arg_spe
-000119d0: 630a 2020 2020 2020 2020 2020 2020 2020  c.              
-000119e0: 2020 666f 7220 6172 672c 2064 6566 6175    for arg, defau
-000119f0: 6c74 2069 6e20 7a69 7028 6172 6773 2c20  lt in zip(args, 
-00011a00: 6172 675f 7370 6563 2e64 6566 6175 6c74  arg_spec.default
-00011a10: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00011a20: 2020 2020 2020 2020 6b77 6172 6773 5b61          kwargs[a
-00011a30: 7267 5d20 3d20 6465 6661 756c 740a 2020  rg] = default.  
-00011a40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00011a50: 2020 2020 2020 2020 666f 7220 6172 6720          for arg 
-00011a60: 696e 2061 7267 733a 0a20 2020 2020 2020  in args:.       
-00011a70: 2020 2020 2020 2020 2069 6620 6172 6720           if arg 
-00011a80: 6e6f 7420 696e 206b 7761 7267 733a 0a20  not in kwargs:. 
-00011a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011aa0: 2020 206b 7761 7267 732e 6170 7065 6e64     kwargs.append
-00011ab0: 2861 7267 290a 2020 2020 7265 7475 726e  (arg).    return
-00011ac0: 206b 7761 7267 730a 0a0a 6465 6620 6765   kwargs...def ge
-00011ad0: 7461 7267 7370 6563 2866 756e 6329 3a0a  targspec(func):.
-00011ae0: 2020 2020 2222 220a 2020 2020 3a66 756e      """.    :fun
-00011af0: 633a 6069 6e73 7065 6374 2e67 6574 6675  c:`inspect.getfu
-00011b00: 6c6c 6172 6773 7065 6360 206f 7220 6069  llargspec` or `i
-00011b10: 6e73 7065 6374 2e67 6574 6172 6773 7065  nspect.getargspe
-00011b20: 6360 2028 5079 7468 6f6e 2032 290a 0a20  c` (Python 2).. 
-00011b30: 2020 203a 7061 7261 6d20 6675 6e63 3a0a     :param func:.
-00011b40: 2020 2020 3a72 6574 7572 6e3a 2046 756c      :return: Ful
-00011b50: 6c41 7267 5370 6563 0a20 2020 2022 2222  lArgSpec.    """
-00011b60: 0a20 2020 2069 6620 5059 333a 0a20 2020  .    if PY3:.   
-00011b70: 2020 2020 2072 6574 7572 6e20 696e 7370       return insp
-00011b80: 6563 742e 6765 7466 756c 6c61 7267 7370  ect.getfullargsp
-00011b90: 6563 2866 756e 6329 0a20 2020 2065 6c73  ec(func).    els
-00011ba0: 653a 0a20 2020 2020 2020 2023 206e 6f69  e:.        # noi
-00011bb0: 6e73 7065 6374 696f 6e20 5079 4465 7072  nspection PyDepr
-00011bc0: 6563 6174 696f 6e0a 2020 2020 2020 2020  ecation.        
-00011bd0: 7265 7475 726e 2069 6e73 7065 6374 2e67  return inspect.g
-00011be0: 6574 6172 6773 7065 6328 6675 6e63 290a  etargspec(func).
-00011bf0: 0a0a 6465 6620 636f 6c6c 6563 745f 6d61  ..def collect_ma
-00011c00: 6e64 6174 6f72 795f 636c 6173 735f 696e  ndatory_class_in
-00011c10: 6974 5f6b 7761 7267 7328 636c 7329 3a0a  it_kwargs(cls):.
-00011c20: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
-00011c30: 616d 2074 7970 6520 636c 733a 0a20 2020  am type cls:.   
-00011c40: 203a 7265 7475 726e 3a20 6c69 7374 206f   :return: list o
-00011c50: 6620 6b77 6172 6773 2077 6869 6368 2068  f kwargs which h
-00011c60: 6176 6520 6e6f 2064 6566 6175 6c74 2c20  ave no default, 
-00011c70: 692e 652e 2077 6869 6368 206d 7573 7420  i.e. which must 
-00011c80: 6265 2070 726f 7669 6465 640a 2020 2020  be provided.    
-00011c90: 3a72 7479 7065 3a20 6c69 7374 5b73 7472  :rtype: list[str
-00011ca0: 5d0a 2020 2020 2222 220a 2020 2020 616c  ].    """.    al
-00011cb0: 6c5f 6b77 6172 6773 203d 2063 6f6c 6c65  l_kwargs = colle
-00011cc0: 6374 5f63 6c61 7373 5f69 6e69 745f 6b77  ct_class_init_kw
-00011cd0: 6172 6773 2863 6c73 2c20 6f6e 6c79 5f77  args(cls, only_w
-00011ce0: 6974 685f 6465 6661 756c 743d 4661 6c73  ith_default=Fals
-00011cf0: 6529 0a20 2020 2064 6566 6175 6c74 5f6b  e).    default_k
-00011d00: 7761 7267 7320 3d20 636f 6c6c 6563 745f  wargs = collect_
-00011d10: 636c 6173 735f 696e 6974 5f6b 7761 7267  class_init_kwarg
-00011d20: 7328 636c 732c 206f 6e6c 795f 7769 7468  s(cls, only_with
-00011d30: 5f64 6566 6175 6c74 3d54 7275 6529 0a20  _default=True). 
-00011d40: 2020 206d 616e 6461 746f 7279 5f6b 7761     mandatory_kwa
-00011d50: 7267 7320 3d20 5b5d 0a20 2020 2066 6f72  rgs = [].    for
-00011d60: 2061 7267 2069 6e20 616c 6c5f 6b77 6172   arg in all_kwar
-00011d70: 6773 3a0a 2020 2020 2020 2020 6966 2061  gs:.        if a
-00011d80: 7267 206e 6f74 2069 6e20 6465 6661 756c  rg not in defaul
-00011d90: 745f 6b77 6172 6773 3a0a 2020 2020 2020  t_kwargs:.      
-00011da0: 2020 2020 2020 6d61 6e64 6174 6f72 795f        mandatory_
-00011db0: 6b77 6172 6773 2e61 7070 656e 6428 6172  kwargs.append(ar
-00011dc0: 6729 0a20 2020 2072 6574 7572 6e20 6d61  g).    return ma
-00011dd0: 6e64 6174 6f72 795f 6b77 6172 6773 0a0a  ndatory_kwargs..
-00011de0: 0a64 6566 2068 656c 705f 6f6e 5f74 7970  .def help_on_typ
-00011df0: 655f 6572 726f 725f 7772 6f6e 675f 6172  e_error_wrong_ar
-00011e00: 6773 2863 6c73 2c20 6b77 6172 6773 293a  gs(cls, kwargs):
-00011e10: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
-00011e20: 7261 6d20 7479 7065 2063 6c73 3a0a 2020  ram type cls:.  
-00011e30: 2020 3a70 6172 616d 206c 6973 745b 7374    :param list[st
-00011e40: 725d 206b 7761 7267 733a 0a20 2020 2022  r] kwargs:.    "
-00011e50: 2222 0a20 2020 206d 616e 6461 746f 7279  "".    mandatory
-00011e60: 5f61 7267 7320 3d20 636f 6c6c 6563 745f  _args = collect_
-00011e70: 6d61 6e64 6174 6f72 795f 636c 6173 735f  mandatory_class_
-00011e80: 696e 6974 5f6b 7761 7267 7328 636c 7329  init_kwargs(cls)
-00011e90: 0a20 2020 2066 6f72 2061 7267 2069 6e20  .    for arg in 
-00011ea0: 6b77 6172 6773 3a0a 2020 2020 2020 2020  kwargs:.        
-00011eb0: 6966 2061 7267 2069 6e20 6d61 6e64 6174  if arg in mandat
-00011ec0: 6f72 795f 6172 6773 3a0a 2020 2020 2020  ory_args:.      
-00011ed0: 2020 2020 2020 6d61 6e64 6174 6f72 795f        mandatory_
-00011ee0: 6172 6773 2e72 656d 6f76 6528 6172 6729  args.remove(arg)
-00011ef0: 0a20 2020 2061 6c6c 5f6b 7761 7267 7320  .    all_kwargs 
-00011f00: 3d20 636f 6c6c 6563 745f 636c 6173 735f  = collect_class_
-00011f10: 696e 6974 5f6b 7761 7267 7328 636c 7329  init_kwargs(cls)
-00011f20: 0a20 2020 2075 6e6b 6e6f 776e 5f61 7267  .    unknown_arg
-00011f30: 7320 3d20 5b5d 0a20 2020 2066 6f72 2061  s = [].    for a
-00011f40: 7267 2069 6e20 6b77 6172 6773 3a0a 2020  rg in kwargs:.  
-00011f50: 2020 2020 2020 6966 2061 7267 206e 6f74        if arg not
-00011f60: 2069 6e20 616c 6c5f 6b77 6172 6773 3a0a   in all_kwargs:.
-00011f70: 2020 2020 2020 2020 2020 2020 756e 6b6e              unkn
-00011f80: 6f77 6e5f 6172 6773 2e61 7070 656e 6428  own_args.append(
-00011f90: 6172 6729 0a20 2020 2069 6620 6d61 6e64  arg).    if mand
-00011fa0: 6174 6f72 795f 6172 6773 206f 7220 756e  atory_args or un
-00011fb0: 6b6e 6f77 6e5f 6172 6773 3a0a 2020 2020  known_args:.    
-00011fc0: 2020 2020 7072 696e 7428 2241 7267 7320      print("Args 
-00011fd0: 6d69 736d 6174 6368 3f20 4d69 7373 696e  mismatch? Missin
-00011fe0: 6720 6172 6520 2572 2c20 756e 6b6e 6f77  g are %r, unknow
-00011ff0: 6e73 2061 7265 2025 722e 204b 7761 7267  ns are %r. Kwarg
-00012000: 7320 2572 2e22 2025 2028 6d61 6e64 6174  s %r." % (mandat
-00012010: 6f72 795f 6172 6773 2c20 756e 6b6e 6f77  ory_args, unknow
-00012020: 6e5f 6172 6773 2c20 6b77 6172 6773 2929  n_args, kwargs))
-00012030: 0a0a 0a64 6566 2063 7573 746f 6d5f 6578  ...def custom_ex
-00012040: 6563 2873 6f75 7263 653a 2073 7472 2c20  ec(source: str, 
-00012050: 736f 7572 6365 5f66 696c 656e 616d 653a  source_filename:
-00012060: 2073 7472 2c20 7573 6572 5f6e 733a 2044   str, user_ns: D
-00012070: 6963 745b 7374 722c 2041 6e79 5d2c 2075  ict[str, Any], u
-00012080: 7365 725f 676c 6f62 616c 5f6e 733a 2044  ser_global_ns: D
-00012090: 6963 745b 7374 722c 2041 6e79 5d29 3a0a  ict[str, Any]):.
-000120a0: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
-000120b0: 616d 2073 6f75 7263 653a 0a20 2020 203a  am source:.    :
-000120c0: 7061 7261 6d20 736f 7572 6365 5f66 696c  param source_fil
-000120d0: 656e 616d 653a 0a20 2020 203a 7061 7261  ename:.    :para
-000120e0: 6d20 7573 6572 5f6e 733a 0a20 2020 203a  m user_ns:.    :
-000120f0: 7061 7261 6d20 7573 6572 5f67 6c6f 6261  param user_globa
-00012100: 6c5f 6e73 3a0a 2020 2020 3a72 6574 7572  l_ns:.    :retur
-00012110: 6e3a 206e 6f74 6869 6e67 0a20 2020 2022  n: nothing.    "
-00012120: 2222 0a20 2020 2069 6620 6e6f 7420 736f  "".    if not so
-00012130: 7572 6365 2e65 6e64 7377 6974 6828 225c  urce.endswith("\
-00012140: 6e22 293a 0a20 2020 2020 2020 2073 6f75  n"):.        sou
-00012150: 7263 6520 2b3d 2022 5c6e 220a 2020 2020  rce += "\n".    
-00012160: 636f 203d 2063 6f6d 7069 6c65 2873 6f75  co = compile(sou
-00012170: 7263 652c 2073 6f75 7263 655f 6669 6c65  rce, source_file
-00012180: 6e61 6d65 2c20 2265 7865 6322 290a 2020  name, "exec").  
-00012190: 2020 7573 6572 5f67 6c6f 6261 6c5f 6e73    user_global_ns
-000121a0: 5b22 5f5f 7061 636b 6167 655f 5f22 5d20  ["__package__"] 
-000121b0: 3d20 2272 6574 7572 6e6e 2220 2023 2069  = "returnn"  # i
-000121c0: 6d70 6f72 7461 6e74 2073 6f20 7468 6174  mportant so that
-000121d0: 2069 6d70 6f72 7473 2077 6f72 6b0a 2020   imports work.  
-000121e0: 2020 6576 616c 2863 6f2c 2075 7365 725f    eval(co, user_
-000121f0: 676c 6f62 616c 5f6e 732c 2075 7365 725f  global_ns, user_
-00012200: 6e73 290a 0a0a 636c 6173 7320 4672 6f7a  ns)...class Froz
-00012210: 656e 4469 6374 2864 6963 7429 3a0a 2020  enDict(dict):.  
-00012220: 2020 2222 220a 2020 2020 4672 6f7a 656e    """.    Frozen
-00012230: 2064 6963 742e 0a20 2020 2022 2222 0a0a   dict..    """..
-00012240: 2020 2020 6465 6620 5f5f 7365 7469 7465      def __setite
-00012250: 6d5f 5f28 7365 6c66 2c20 6b65 792c 2076  m__(self, key, v
-00012260: 616c 7565 293a 0a20 2020 2020 2020 2072  alue):.        r
-00012270: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00012280: 2246 726f 7a65 6e44 6963 7420 6361 6e6e  "FrozenDict cann
-00012290: 6f74 2062 6520 6d6f 6469 6669 6564 2229  ot be modified")
-000122a0: 0a0a 2020 2020 6465 6620 5f5f 6861 7368  ..    def __hash
-000122b0: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-000122c0: 2020 7265 7475 726e 2068 6173 6828 7475    return hash(tu
-000122d0: 706c 6528 736f 7274 6564 2873 656c 662e  ple(sorted(self.
-000122e0: 6974 656d 7328 2929 2929 0a0a 0a64 6566  items())))...def
-000122f0: 206d 616b 655f 6861 7368 6162 6c65 286f   make_hashable(o
-00012300: 626a 293a 0a20 2020 2022 2222 0a20 2020  bj):.    """.   
-00012310: 2054 6865 616e 6f20 6e65 6564 7320 6861   Theano needs ha
-00012320: 7368 6162 6c65 206f 626a 6563 7473 2069  shable objects i
-00012330: 6e20 736f 6d65 2063 6173 6573 2c20 652e  n some cases, e.
-00012340: 672e 2074 6865 2070 726f 7065 7274 6965  g. the propertie
-00012350: 7320 6f66 204f 7073 2e0a 2020 2020 5468  s of Ops..    Th
-00012360: 6973 2063 6f6e 7665 7274 7320 616c 6c20  is converts all 
-00012370: 6f62 6a65 6374 7320 6173 2073 7563 682c  objects as such,
-00012380: 2069 2e65 2e20 696e 746f 2069 6d6d 7574   i.e. into immut
-00012390: 6162 6c65 2066 726f 7a65 6e20 7479 7065  able frozen type
-000123a0: 732e 0a0a 2020 2020 3a70 6172 616d 2054  s...    :param T
-000123b0: 7c64 6963 747c 6c69 7374 7c74 7570 6c65  |dict|list|tuple
-000123c0: 206f 626a 3a0a 2020 2020 3a72 7479 7065   obj:.    :rtype
-000123d0: 3a20 547c 4672 6f7a 656e 4469 6374 7c74  : T|FrozenDict|t
-000123e0: 7570 6c65 0a20 2020 2022 2222 0a20 2020  uple.    """.   
-000123f0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-00012400: 626a 2c20 6469 6374 293a 0a20 2020 2020  bj, dict):.     
-00012410: 2020 2072 6574 7572 6e20 4672 6f7a 656e     return Frozen
-00012420: 4469 6374 285b 6d61 6b65 5f68 6173 6861  Dict([make_hasha
-00012430: 626c 6528 6974 656d 2920 666f 7220 6974  ble(item) for it
-00012440: 656d 2069 6e20 6f62 6a2e 6974 656d 7328  em in obj.items(
-00012450: 295d 290a 2020 2020 6966 2069 7369 6e73  )]).    if isins
-00012460: 7461 6e63 6528 6f62 6a2c 2028 6c69 7374  tance(obj, (list
-00012470: 2c20 7475 706c 6529 293a 0a20 2020 2020  , tuple)):.     
-00012480: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
-00012490: 5b6d 616b 655f 6861 7368 6162 6c65 2869  [make_hashable(i
-000124a0: 7465 6d29 2066 6f72 2069 7465 6d20 696e  tem) for item in
-000124b0: 206f 626a 5d29 0a20 2020 2069 6620 6973   obj]).    if is
-000124c0: 696e 7374 616e 6365 286f 626a 2c20 2873  instance(obj, (s
-000124d0: 7472 2c20 756e 6963 6f64 652c 2066 6c6f  tr, unicode, flo
-000124e0: 6174 2c20 696e 742c 206c 6f6e 6729 293a  at, int, long)):
-000124f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012500: 6f62 6a0a 2020 2020 6966 206f 626a 2069  obj.    if obj i
-00012510: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00012520: 7265 7475 726e 206f 626a 0a20 2020 2069  return obj.    i
-00012530: 6620 2274 656e 736f 7266 6c6f 7722 2069  f "tensorflow" i
-00012540: 6e20 7379 732e 6d6f 6475 6c65 733a 0a20  n sys.modules:. 
-00012550: 2020 2020 2020 2069 6d70 6f72 7420 7465         import te
-00012560: 6e73 6f72 666c 6f77 2061 7320 7466 0a0a  nsorflow as tf..
-00012570: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00012580: 7461 6e63 6528 6f62 6a2c 2074 662e 5465  tance(obj, tf.Te
-00012590: 6e73 6f72 293a 0a20 2020 2020 2020 2020  nsor):.         
-000125a0: 2020 2072 6574 7572 6e20 5265 6649 6445     return RefIdE
-000125b0: 7128 6f62 6a29 0a20 2020 2061 7373 6572  q(obj).    asser
-000125c0: 7420 4661 6c73 652c 2022 646f 6e27 7420  t False, "don't 
-000125d0: 6b6e 6f77 2068 6f77 2074 6f20 6d61 6b65  know how to make
-000125e0: 2068 6173 6861 626c 653a 2025 7220 2825   hashable: %r (%
-000125f0: 7229 2220 2520 286f 626a 2c20 7479 7065  r)" % (obj, type
-00012600: 286f 626a 2929 0a0a 0a63 6c61 7373 2052  (obj))...class R
-00012610: 6566 4964 4571 2847 656e 6572 6963 5b54  efIdEq(Generic[T
-00012620: 5d29 3a0a 2020 2020 2222 220a 2020 2020  ]):.    """.    
-00012630: 5265 6665 7265 6e63 6520 746f 2073 6f6d  Reference to som
-00012640: 6520 6f62 6a65 6374 2028 652e 672e 2074  e object (e.g. t
-00012650: 2e66 5465 6e73 6f72 292c 2062 7574 2074  .fTensor), but t
-00012660: 6869 7320 6f62 6a65 6374 2069 7320 616c  his object is al
-00012670: 7761 7973 2068 6173 6861 626c 652c 0a20  ways hashable,. 
-00012680: 2020 2061 6e64 2075 7365 7320 7468 6520     and uses the 
-00012690: 6069 6460 206f 6620 7468 6520 6675 6e63  `id` of the func
-000126a0: 7469 6f6e 2066 6f72 2074 6865 2068 6173  tion for the has
-000126b0: 6820 616e 6420 6571 7561 6c69 7479 2e0a  h and equality..
-000126c0: 0a20 2020 2028 496e 2063 6173 6520 6f66  .    (In case of
-000126d0: 2074 662e 5465 6e73 6f72 2c20 7468 6973   tf.Tensor, this
-000126e0: 2069 7320 666f 7220 636f 6d70 6174 6962   is for compatib
-000126f0: 696c 6974 790a 2020 2020 2062 6563 6175  ility.     becau
-00012700: 7365 2074 662e 5465 6e73 6f72 2e72 6566  se tf.Tensor.ref
-00012710: 2829 2077 6173 206e 6f74 2061 7661 696c  () was not avail
-00012720: 6162 6c65 2069 6e20 6561 726c 6965 7220  able in earlier 
-00012730: 5446 2076 6572 7369 6f6e 732e 0a20 2020  TF versions..   
-00012740: 2020 486f 7765 7665 722c 2077 6520 616c    However, we al
-00012750: 736f 206e 6565 6420 7468 6973 2066 6f72  so need this for
-00012760: 203a 636c 6173 733a 6044 6963 7452 6566   :class:`DictRef
-00012770: 4b65 7973 602e 290a 2020 2020 2854 6869  Keys`.).    (Thi
-00012780: 7320 7761 7320 5465 6e73 6f72 5265 6620  s was TensorRef 
-00012790: 696e 2065 6172 6c69 6572 2052 4554 5552  in earlier RETUR
-000127a0: 4e4e 2076 6572 7369 6f6e 732e 290a 2020  NN versions.).  
-000127b0: 2020 2222 220a 0a20 2020 2064 6566 205f    """..    def _
-000127c0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6f62  _init__(self, ob
-000127d0: 6a3a 2054 293a 0a20 2020 2020 2020 2022  j: T):.        "
-000127e0: 2222 0a20 2020 2020 2020 203a 7061 7261  "".        :para
-000127f0: 6d20 6f62 6a3a 2066 6f72 2065 7861 6d70  m obj: for examp
-00012800: 6c65 2074 662e 5465 6e73 6f72 0a20 2020  le tf.Tensor.   
-00012810: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00012820: 2073 656c 662e 6f62 6a20 3d20 6f62 6a0a   self.obj = obj.
-00012830: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
-00012840: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-00012850: 2072 6574 7572 6e20 2254 656e 736f 7252   return "TensorR
-00012860: 6566 7b25 727d 2220 2520 7365 6c66 2e6f  ef{%r}" % self.o
-00012870: 626a 0a0a 2020 2020 6465 6620 5f5f 6571  bj..    def __eq
-00012880: 5f5f 2873 656c 662c 206f 7468 6572 293a  __(self, other):
-00012890: 0a20 2020 2020 2020 2069 6620 6f74 6865  .        if othe
-000128a0: 7220 6973 204e 6f6e 6520 6f72 206e 6f74  r is None or not
-000128b0: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
-000128c0: 722c 2052 6566 4964 4571 293a 0a20 2020  r, RefIdEq):.   
-000128d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000128e0: 4661 6c73 650a 2020 2020 2020 2020 7265  False.        re
-000128f0: 7475 726e 2073 656c 662e 6f62 6a20 6973  turn self.obj is
-00012900: 206f 7468 6572 2e6f 626a 0a0a 2020 2020   other.obj..    
-00012910: 6465 6620 5f5f 6e65 5f5f 2873 656c 662c  def __ne__(self,
-00012920: 206f 7468 6572 293a 0a20 2020 2020 2020   other):.       
-00012930: 2072 6574 7572 6e20 6e6f 7420 7365 6c66   return not self
-00012940: 2e5f 5f65 715f 5f28 6f74 6865 7229 0a0a  .__eq__(other)..
-00012950: 2020 2020 6465 6620 5f5f 6861 7368 5f5f      def __hash__
-00012960: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00012970: 7265 7475 726e 2069 6428 7365 6c66 2e6f  return id(self.o
-00012980: 626a 290a 0a0a 636c 6173 7320 4469 6374  bj)...class Dict
-00012990: 5265 664b 6579 7328 4765 6e65 7269 635b  RefKeys(Generic[
-000129a0: 4b2c 2056 5d29 3a0a 2020 2020 2222 220a  K, V]):.    """.
-000129b0: 2020 2020 4c69 6b65 2060 6469 6374 602c      Like `dict`,
-000129c0: 2062 7574 2068 6173 6820 616e 6420 6571   but hash and eq
-000129d0: 7561 6c69 7479 206f 6620 7468 6520 6b65  uality of the ke
-000129e0: 7973 0a20 2020 2022 2222 0a0a 2020 2020  ys.    """..    
-000129f0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00012a00: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00012a10: 2e5f 6420 3d20 7b7d 2020 2320 7479 7065  ._d = {}  # type
-00012a20: 3a20 4469 6374 5b52 6566 4964 4571 5b4b  : Dict[RefIdEq[K
-00012a30: 5d2c 2056 5d0a 0a20 2020 2064 6566 205f  ], V]..    def _
-00012a40: 5f72 6570 725f 5f28 7365 6c66 293a 0a20  _repr__(self):. 
-00012a50: 2020 2020 2020 2072 6574 7572 6e20 2244         return "D
-00012a60: 6963 7452 6566 4b65 7973 2825 7329 2220  ictRefKeys(%s)" 
-00012a70: 2520 222c 2022 2e6a 6f69 6e28 5b22 2572  % ", ".join(["%r
-00012a80: 3a20 2572 2220 2520 286b 2c20 7629 2066  : %r" % (k, v) f
-00012a90: 6f72 2028 6b2c 2076 2920 696e 2073 656c  or (k, v) in sel
-00012aa0: 662e 6974 656d 7328 295d 290a 0a20 2020  f.items()])..   
-00012ab0: 2064 6566 2069 7465 6d73 2873 656c 6629   def items(self)
-00012ac0: 202d 3e20 4974 6572 6162 6c65 5b54 7570   -> Iterable[Tup
-00012ad0: 6c65 5b4b 2c20 565d 5d3a 0a20 2020 2020  le[K, V]]:.     
-00012ae0: 2020 2022 2222 6974 656d 7322 2222 0a20     """items""". 
-00012af0: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-00012b00: 696e 2073 656c 662e 5f64 2e69 7465 6d73  in self._d.items
-00012b10: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00012b20: 7969 656c 6420 6b2e 6f62 6a2c 2076 0a0a  yield k.obj, v..
-00012b30: 2020 2020 6465 6620 6b65 7973 2873 656c      def keys(sel
-00012b40: 6629 202d 3e20 4974 6572 6162 6c65 5b4b  f) -> Iterable[K
-00012b50: 5d3a 0a20 2020 2020 2020 2022 2222 6b65  ]:.        """ke
-00012b60: 7973 2222 220a 2020 2020 2020 2020 666f  ys""".        fo
-00012b70: 7220 6b20 696e 2073 656c 662e 5f64 2e6b  r k in self._d.k
-00012b80: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-00012b90: 2020 2079 6965 6c64 206b 2e6f 626a 0a0a     yield k.obj..
-00012ba0: 2020 2020 6465 6620 7661 6c75 6573 2873      def values(s
-00012bb0: 656c 6629 202d 3e20 4974 6572 6162 6c65  elf) -> Iterable
-00012bc0: 5b56 5d3a 0a20 2020 2020 2020 2022 2222  [V]:.        """
-00012bd0: 7661 6c75 6573 2222 220a 2020 2020 2020  values""".      
-00012be0: 2020 666f 7220 7620 696e 2073 656c 662e    for v in self.
-00012bf0: 5f64 2e76 616c 7565 7328 293a 0a20 2020  _d.values():.   
-00012c00: 2020 2020 2020 2020 2079 6965 6c64 2076           yield v
-00012c10: 0a0a 2020 2020 6465 6620 5f5f 6765 7469  ..    def __geti
-00012c20: 7465 6d5f 5f28 7365 6c66 2c20 6974 656d  tem__(self, item
-00012c30: 3a20 4b29 202d 3e20 563a 0a20 2020 2020  : K) -> V:.     
-00012c40: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00012c50: 645b 5265 6649 6445 7128 6974 656d 295d  d[RefIdEq(item)]
-00012c60: 0a0a 2020 2020 6465 6620 5f5f 7365 7469  ..    def __seti
-00012c70: 7465 6d5f 5f28 7365 6c66 2c20 6b65 793a  tem__(self, key:
-00012c80: 204b 2c20 7661 6c75 653a 2056 293a 0a20   K, value: V):. 
-00012c90: 2020 2020 2020 2073 656c 662e 5f64 5b52         self._d[R
-00012ca0: 6566 4964 4571 286b 6579 295d 203d 2076  efIdEq(key)] = v
-00012cb0: 616c 7565 0a0a 2020 2020 6465 6620 5f5f  alue..    def __
-00012cc0: 636f 6e74 6169 6e73 5f5f 2873 656c 662c  contains__(self,
-00012cd0: 2069 7465 6d3a 204b 293a 0a20 2020 2020   item: K):.     
-00012ce0: 2020 2072 6574 7572 6e20 5265 6649 6445     return RefIdE
-00012cf0: 7128 6974 656d 2920 696e 2073 656c 662e  q(item) in self.
-00012d00: 5f64 0a0a 0a64 6566 206d 616b 655f 646c  _d...def make_dl
-00012d10: 6c5f 6e61 6d65 2862 6173 656e 616d 6529  l_name(basename)
-00012d20: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
-00012d30: 6172 616d 2073 7472 2062 6173 656e 616d  aram str basenam
-00012d40: 653a 0a20 2020 203a 7265 7475 726e 3a20  e:.    :return: 
-00012d50: 652e 672e 2022 6c69 6225 732e 736f 2220  e.g. "lib%s.so" 
-00012d60: 2520 6261 7365 6e61 6d65 2c20 6465 7065  % basename, depe
-00012d70: 6e64 696e 6720 6f6e 2073 7973 2e70 6c61  nding on sys.pla
-00012d80: 7466 6f72 6d0a 2020 2020 3a72 7479 7065  tform.    :rtype
-00012d90: 3a20 7374 720a 2020 2020 2222 220a 2020  : str.    """.  
-00012da0: 2020 6966 2073 7973 2e70 6c61 7466 6f72    if sys.platfor
-00012db0: 6d20 3d3d 2022 6461 7277 696e 223a 0a20  m == "darwin":. 
-00012dc0: 2020 2020 2020 2072 6574 7572 6e20 226c         return "l
-00012dd0: 6962 2573 2e64 796c 6962 2220 2520 6261  ib%s.dylib" % ba
-00012de0: 7365 6e61 6d65 0a20 2020 2065 6c69 6620  sename.    elif 
-00012df0: 7379 732e 706c 6174 666f 726d 203d 3d20  sys.platform == 
-00012e00: 2277 696e 3332 223a 0a20 2020 2020 2020  "win32":.       
-00012e10: 2072 6574 7572 6e20 2225 732e 646c 6c22   return "%s.dll"
-00012e20: 2025 2062 6173 656e 616d 650a 2020 2020   % basename.    
-00012e30: 656c 7365 3a20 2023 204c 696e 7578 2c20  else:  # Linux, 
-00012e40: 556e 6978 0a20 2020 2020 2020 2072 6574  Unix.        ret
-00012e50: 7572 6e20 226c 6962 2573 2e73 6f22 2025  urn "lib%s.so" %
-00012e60: 2062 6173 656e 616d 650a 0a0a 6465 6620   basename...def 
-00012e70: 6573 6361 7065 5f63 5f73 7472 2873 293a  escape_c_str(s):
-00012e80: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
-00012e90: 7261 6d20 7374 7220 733a 0a20 2020 203a  ram str s:.    :
-00012ea0: 7265 7475 726e 3a20 432d 6573 6361 7065  return: C-escape
-00012eb0: 6420 7374 720a 2020 2020 3a72 7479 7065  d str.    :rtype
-00012ec0: 3a20 7374 720a 2020 2020 2222 220a 2020  : str.    """.  
-00012ed0: 2020 7265 7475 726e 2027 2225 7322 2720    return '"%s"' 
-00012ee0: 2520 732e 7265 706c 6163 6528 225c 5c5c  % s.replace("\\\
-00012ef0: 5c22 2c20 225c 5c22 292e 7265 706c 6163  \", "\\").replac
-00012f00: 6528 225c 6e22 2c20 225c 5c6e 2229 2e72  e("\n", "\\n").r
-00012f10: 6570 6c61 6365 2827 2227 2c20 275c 5c22  eplace('"', '\\"
-00012f20: 2729 2e72 6570 6c61 6365 2822 2722 2c20  ').replace("'", 
-00012f30: 225c 5c27 2229 0a0a 0a64 6566 2061 7474  "\\'")...def att
-00012f40: 725f 6368 6169 6e28 6261 7365 2c20 6174  r_chain(base, at
-00012f50: 7472 6962 7329 3a0a 2020 2020 2222 220a  tribs):.    """.
-00012f60: 2020 2020 3a70 6172 616d 206f 626a 6563      :param objec
-00012f70: 7420 6261 7365 3a0a 2020 2020 3a70 6172  t base:.    :par
-00012f80: 616d 206c 6973 745b 7374 725d 7c74 7570  am list[str]|tup
-00012f90: 6c65 5b73 7472 5d7c 7374 7220 6174 7472  le[str]|str attr
-00012fa0: 6962 733a 0a20 2020 203a 7265 7475 726e  ibs:.    :return
-00012fb0: 3a20 6765 7461 7474 7228 6765 7461 7474  : getattr(getatt
-00012fc0: 7228 6f62 6a65 6374 2c20 6174 7472 6962  r(object, attrib
-00012fd0: 735b 305d 292c 2061 7474 7269 6273 5b31  s[0]), attribs[1
-00012fe0: 5d29 202e 2e2e 0a20 2020 203a 7274 7970  ]) ....    :rtyp
-00012ff0: 653a 206f 626a 6563 740a 2020 2020 2222  e: object.    ""
-00013000: 220a 2020 2020 6966 206e 6f74 2069 7369  ".    if not isi
-00013010: 6e73 7461 6e63 6528 6174 7472 6962 732c  nstance(attribs,
-00013020: 2028 6c69 7374 2c20 7475 706c 6529 293a   (list, tuple)):
-00013030: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00013040: 6973 696e 7374 616e 6365 2861 7474 7269  isinstance(attri
-00013050: 6273 2c20 7374 7229 0a20 2020 2020 2020  bs, str).       
-00013060: 2061 7474 7269 6273 203d 205b 6174 7472   attribs = [attr
-00013070: 6962 735d 0a20 2020 2065 6c73 653a 0a20  ibs].    else:. 
-00013080: 2020 2020 2020 2061 7474 7269 6273 203d         attribs =
-00013090: 206c 6973 7428 6174 7472 6962 7329 0a20   list(attribs). 
-000130a0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-000130b0: 6528 6c65 6e28 6174 7472 6962 7329 293a  e(len(attribs)):
-000130c0: 0a20 2020 2020 2020 2062 6173 6520 3d20  .        base = 
-000130d0: 6765 7461 7474 7228 6261 7365 2c20 6174  getattr(base, at
-000130e0: 7472 6962 735b 695d 290a 2020 2020 7265  tribs[i]).    re
-000130f0: 7475 726e 2062 6173 650a 0a0a 6465 6620  turn base...def 
-00013100: 746f 5f62 6f6f 6c28 7629 3a0a 2020 2020  to_bool(v):.    
-00013110: 2222 220a 2020 2020 3a70 6172 616d 2069  """.    :param i
-00013120: 6e74 7c66 6c6f 6174 7c73 7472 2076 3a20  nt|float|str v: 
-00013130: 6966 2069 7420 6973 2061 2073 7472 696e  if it is a strin
-00013140: 672c 2069 7420 7368 6f75 6c64 2072 6570  g, it should rep
-00013150: 7265 7365 6e74 2073 6f6d 6520 696e 7465  resent some inte
-00013160: 6765 722c 206f 7220 616c 7465 726e 6174  ger, or alternat
-00013170: 6976 656c 7920 2274 7275 6522 206f 7220  ively "true" or 
-00013180: 2266 616c 7365 220a 2020 2020 3a72 7479  "false".    :rty
-00013190: 7065 3a20 626f 6f6c 0a20 2020 2022 2222  pe: bool.    """
-000131a0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-000131b0: 2020 7265 7475 726e 2062 6f6f 6c28 696e    return bool(in
-000131c0: 7428 7629 290a 2020 2020 6578 6365 7074  t(v)).    except
-000131d0: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
-000131e0: 2020 2020 2070 6173 730a 2020 2020 6966       pass.    if
-000131f0: 2069 7369 6e73 7461 6e63 6528 762c 2028   isinstance(v, (
-00013200: 7374 722c 2075 6e69 636f 6465 2929 3a0a  str, unicode)):.
-00013210: 2020 2020 2020 2020 7620 3d20 762e 6c6f          v = v.lo
-00013220: 7765 7228 290a 2020 2020 2020 2020 6966  wer().        if
-00013230: 2076 2069 6e20 5b22 7472 7565 222c 2022   v in ["true", "
-00013240: 7965 7322 2c20 226f 6e22 2c20 2231 225d  yes", "on", "1"]
-00013250: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00013260: 7475 726e 2054 7275 650a 2020 2020 2020  turn True.      
-00013270: 2020 6966 2076 2069 6e20 5b22 6661 6c73    if v in ["fals
-00013280: 6522 2c20 226e 6f22 2c20 226f 6666 222c  e", "no", "off",
-00013290: 2022 3022 5d3a 0a20 2020 2020 2020 2020   "0"]:.         
-000132a0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-000132b0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-000132c0: 7272 6f72 2822 746f 5f62 6f6f 6c20 6361  rror("to_bool ca
-000132d0: 6e6e 6f74 2068 616e 646c 6520 2572 2220  nnot handle %r" 
-000132e0: 2520 7629 0a0a 0a64 6566 2061 735f 7374  % v)...def as_st
-000132f0: 7228 7329 3a0a 2020 2020 2222 220a 2020  r(s):.    """.  
-00013300: 2020 3a70 6172 616d 2073 7472 7c75 6e69    :param str|uni
-00013310: 636f 6465 7c62 7974 6573 2073 3a0a 2020  code|bytes s:.  
-00013320: 2020 3a72 7479 7065 3a20 7374 727c 756e    :rtype: str|un
-00013330: 6963 6f64 650a 2020 2020 2222 220a 2020  icode.    """.  
-00013340: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00013350: 732c 2073 7472 2920 6f72 2022 756e 6963  s, str) or "unic
-00013360: 6f64 6522 2069 6e20 7374 7228 7479 7065  ode" in str(type
-00013370: 2873 2929 3a0a 2020 2020 2020 2020 7265  (s)):.        re
-00013380: 7475 726e 2073 0a20 2020 2069 6620 6973  turn s.    if is
-00013390: 696e 7374 616e 6365 2873 2c20 6279 7465  instance(s, byte
-000133a0: 7329 206f 7220 6973 696e 7374 616e 6365  s) or isinstance
-000133b0: 2873 2c20 756e 6963 6f64 6529 3a0a 2020  (s, unicode):.  
-000133c0: 2020 2020 2020 2320 6e6f 696e 7370 6563        # noinspec
-000133d0: 7469 6f6e 2050 7955 6e72 6573 6f6c 7665  tion PyUnresolve
-000133e0: 6452 6566 6572 656e 6365 730a 2020 2020  dReferences.    
-000133f0: 2020 2020 7265 7475 726e 2073 2e64 6563      return s.dec
-00013400: 6f64 6528 2275 7466 3822 290a 2020 2020  ode("utf8").    
-00013410: 6173 7365 7274 2046 616c 7365 2c20 2275  assert False, "u
-00013420: 6e6b 6e6f 776e 2074 7970 6520 2573 2220  nknown type %s" 
-00013430: 2520 7479 7065 2873 290a 0a0a 6465 6620  % type(s)...def 
-00013440: 7079 325f 7574 6638 5f73 7472 5f74 6f5f  py2_utf8_str_to_
-00013450: 756e 6963 6f64 6528 7329 3a0a 2020 2020  unicode(s):.    
-00013460: 2222 220a 2020 2020 3a70 6172 616d 2073  """.    :param s
-00013470: 7472 2073 3a20 652e 672e 2074 6865 2073  tr s: e.g. the s
-00013480: 7472 696e 6720 6c69 7465 7261 6c20 22c3  tring literal ".
-00013490: a4c3 b6c3 bc22 2069 6e20 5079 7468 6f6e  ....." in Python
-000134a0: 2033 2069 7320 636f 7272 6563 742c 2062   3 is correct, b
-000134b0: 7574 2069 6e20 5079 7468 6f6e 2032 2069  ut in Python 2 i
-000134c0: 7420 7368 6f75 6c64 2068 6176 6520 6265  t should have be
-000134d0: 656e 2075 22c3 a4c3 b6c3 bc22 2c0a 2020  en u"......",.  
-000134e0: 2020 2020 6275 7420 6a75 7374 2075 7369      but just usi
-000134f0: 6e67 2022 c3a4 c3b6 c3bc 2220 7769 6c6c  ng "......" will
-00013500: 2061 6374 7561 6c6c 7920 6265 2074 6865   actually be the
-00013510: 2072 6177 2075 7466 3820 6279 7465 2073   raw utf8 byte s
-00013520: 6571 7565 6e63 652e 0a20 2020 2020 2054  equence..      T
-00013530: 6869 7320 6361 6e20 6861 7070 656e 2077  his can happen w
-00013540: 6865 6e20 796f 7520 6576 616c 2829 2073  hen you eval() s
-00013550: 6f6d 6520 7374 7269 6e67 2e0a 2020 2020  ome string..    
-00013560: 2020 5765 2061 7373 756d 6520 7468 6174    We assume that
-00013570: 2079 6f75 2061 7265 2075 7369 6e67 2050   you are using P
-00013580: 7974 686f 6e20 322c 2061 6e64 2067 6f74  ython 2, and got
-00013590: 2074 6865 2073 7472 696e 6720 286e 6f74   the string (not
-000135a0: 2075 6e69 636f 6465 206f 626a 6563 7429   unicode object)
-000135b0: 2022 c3a4 c3b6 c3bc 222c 206f 7220 6d61   "......", or ma
-000135c0: 7962 6520 2261 6263 222e 0a20 2020 2020  ybe "abc"..     
-000135d0: 2041 6c73 6f20 7365 6520 3a66 756e 633a   Also see :func:
-000135e0: 605f 7079 325f 756e 6963 6f64 655f 746f  `_py2_unicode_to
-000135f0: 5f73 7472 5f72 6563 7572 7369 7665 6020  _str_recursive` 
-00013600: 616e 6420 3a66 756e 633a 6061 735f 7374  and :func:`as_st
-00013610: 7260 2e0a 2020 2020 3a72 6574 7572 6e3a  r`..    :return:
-00013620: 2069 6620 6974 2069 7320 696e 6465 6564   if it is indeed
-00013630: 2075 6e69 636f 6465 2c20 6974 2077 696c   unicode, it wil
-00013640: 6c20 7265 7475 726e 2074 6865 2075 6e69  l return the uni
-00013650: 636f 6465 206f 626a 6563 742c 206f 7468  code object, oth
-00013660: 6572 7769 7365 2069 7420 6b65 6570 7320  erwise it keeps 
-00013670: 7468 6520 7374 7269 6e67 0a20 2020 203a  the string.    :
-00013680: 7274 7970 653a 2073 7472 7c75 6e69 636f  rtype: str|unico
-00013690: 6465 0a20 2020 2022 2222 0a20 2020 2061  de.    """.    a
-000136a0: 7373 6572 7420 6e6f 7420 5059 330a 2020  ssert not PY3.  
-000136b0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000136c0: 6e63 6528 732c 2073 7472 290a 2020 2020  nce(s, str).    
-000136d0: 7472 793a 0a20 2020 2020 2020 2023 206e  try:.        # n
-000136e0: 6f69 6e73 7065 6374 696f 6e20 5079 556e  oinspection PyUn
-000136f0: 7265 736f 6c76 6564 5265 6665 7265 6e63  resolvedReferenc
-00013700: 6573 0a20 2020 2020 2020 2073 2e64 6563  es.        s.dec
-00013710: 6f64 6528 2261 7363 6969 2229 0a20 2020  ode("ascii").   
-00013720: 2020 2020 2072 6574 7572 6e20 730a 2020       return s.  
-00013730: 2020 6578 6365 7074 2055 6e69 636f 6465    except Unicode
-00013740: 4465 636f 6465 4572 726f 723a 0a20 2020  DecodeError:.   
-00013750: 2020 2020 2070 6173 730a 2020 2020 2320       pass.    # 
-00013760: 6e6f 696e 7370 6563 7469 6f6e 2050 7955  noinspection PyU
-00013770: 6e72 6573 6f6c 7665 6452 6566 6572 656e  nresolvedReferen
-00013780: 6365 730a 2020 2020 7265 7475 726e 2073  ces.    return s
-00013790: 2e64 6563 6f64 6528 2275 7466 3822 290a  .decode("utf8").
-000137a0: 0a0a 6465 6620 756e 6963 6f64 655f 746f  ..def unicode_to
-000137b0: 5f73 7472 2873 293a 0a20 2020 2022 2222  _str(s):.    """
-000137c0: 0a20 2020 2054 6865 2062 6568 6176 696f  .    The behavio
-000137d0: 7220 6973 2064 6966 6665 7265 6e74 2064  r is different d
-000137e0: 6570 656e 6469 6e67 206f 6e20 5079 7468  epending on Pyth
-000137f0: 6f6e 2032 206f 7220 5079 7468 6f6e 2033  on 2 or Python 3
-00013800: 2e20 496e 2061 6c6c 2063 6173 6573 2c20  . In all cases, 
-00013810: 7468 6520 7265 7475 726e 6564 2074 7970  the returned typ
-00013820: 6520 6973 2061 2073 7472 206f 626a 6563  e is a str objec
-00013830: 742e 0a20 2020 2050 7974 686f 6e20 323a  t..    Python 2:
-00013840: 0a20 2020 2020 2057 6520 7265 7475 726e  .      We return
-00013850: 2074 6865 2075 7466 3820 656e 636f 6465   the utf8 encode
-00013860: 6420 7374 7220 2877 6869 6368 2069 7320  d str (which is 
-00013870: 6c69 6b65 2050 7974 686f 6e20 3320 6279  like Python 3 by
-00013880: 7465 732c 206f 7220 666f 7220 4153 4349  tes, or for ASCI
-00013890: 492c 2074 6865 7265 2069 7320 6e6f 2064  I, there is no d
-000138a0: 6966 6665 7265 6e63 6529 2e0a 2020 2020  ifference)..    
-000138b0: 5079 7468 6f6e 2033 3a0a 2020 2020 2020  Python 3:.      
-000138c0: 5765 2072 6574 7572 6e20 6120 7374 7220  We return a str 
-000138d0: 6f62 6a65 6374 2e0a 2020 2020 4e6f 7465  object..    Note
-000138e0: 2074 6861 7420 7468 6973 2066 756e 6374   that this funct
-000138f0: 696f 6e20 7072 6f62 6162 6c79 2064 6f65  ion probably doe
-00013900: 7320 6e6f 7420 6d61 6b65 206d 7563 6820  s not make much 
-00013910: 7365 6e73 652e 0a20 2020 2049 7420 6d69  sense..    It mi
-00013920: 6768 7420 6265 2075 7365 6420 7768 656e  ght be used when
-00013930: 2074 6865 7265 2069 7320 6f74 6865 7220   there is other 
-00013940: 636f 6465 2077 6869 6368 2065 7870 6563  code which expec
-00013950: 7473 2061 2073 7472 206f 626a 6563 742c  ts a str object,
-00013960: 206e 6f20 6d61 7474 6572 2069 6620 5079   no matter if Py
-00013970: 7468 6f6e 2032 206f 7220 5079 7468 6f6e  thon 2 or Python
-00013980: 2033 2e0a 2020 2020 496e 2050 7974 686f   3..    In Pytho
-00013990: 6e20 322c 2061 2073 7472 206f 626a 6563  n 2, a str objec
-000139a0: 7420 6f66 7465 6e20 686f 6c64 7320 5554  t often holds UT
-000139b0: 4638 2074 6578 742c 2073 6f20 7468 6520  F8 text, so the 
-000139c0: 6265 6861 7669 6f72 206f 6620 7468 6973  behavior of this
-000139d0: 2066 756e 6374 696f 6e20 6973 2066 696e   function is fin
-000139e0: 6520 7468 656e 2e0a 2020 2020 416c 736f  e then..    Also
-000139f0: 2073 6565 203a 6675 6e63 3a60 6173 5f73   see :func:`as_s
-00013a00: 7472 602e 0a0a 2020 2020 3a70 6172 616d  tr`...    :param
-00013a10: 2073 7472 7c75 6e69 636f 6465 7c62 7974   str|unicode|byt
-00013a20: 6573 2073 3a0a 2020 2020 3a72 7479 7065  es s:.    :rtype
-00013a30: 3a20 7374 720a 2020 2020 2222 220a 2020  : str.    """.  
-00013a40: 2020 6966 2050 5933 2061 6e64 2069 7369    if PY3 and isi
-00013a50: 6e73 7461 6e63 6528 732c 2062 7974 6573  nstance(s, bytes
-00013a60: 293a 0a20 2020 2020 2020 2073 203d 2073  ):.        s = s
-00013a70: 2e64 6563 6f64 6528 2275 7466 3822 290a  .decode("utf8").
-00013a80: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00013a90: 7369 6e73 7461 6e63 6528 732c 2073 7472  sinstance(s, str
-00013aa0: 290a 2020 2020 6966 206e 6f74 2050 5933  ).    if not PY3
-00013ab0: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
-00013ac0: 732c 2075 6e69 636f 6465 293a 0a20 2020  s, unicode):.   
-00013ad0: 2020 2020 2073 203d 2073 2e65 6e63 6f64       s = s.encod
-00013ae0: 6528 2275 7466 3822 290a 2020 2020 2020  e("utf8").      
-00013af0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00013b00: 6e63 6528 732c 2073 7472 290a 2020 2020  nce(s, str).    
-00013b10: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00013b20: 6528 732c 2073 7472 290a 2020 2020 7265  e(s, str).    re
-00013b30: 7475 726e 2073 0a0a 0a64 6566 2064 6565  turn s...def dee
-00013b40: 7063 6f70 7928 782c 2073 746f 705f 7479  pcopy(x, stop_ty
-00013b50: 7065 733d 4e6f 6e65 293a 0a20 2020 2022  pes=None):.    "
-00013b60: 2222 0a20 2020 2053 696d 706c 6572 2076  "".    Simpler v
-00013b70: 6172 6961 6e74 206f 6620 636f 7079 2e64  ariant of copy.d
-00013b80: 6565 7063 6f70 7928 292e 0a20 2020 2053  eepcopy()..    S
-00013b90: 686f 756c 6420 6861 6e64 6c65 2073 6f6d  hould handle som
-00013ba0: 6520 6564 6765 2063 6173 6573 2061 7320  e edge cases as 
-00013bb0: 7765 6c6c 2c20 6c69 6b65 2063 6f70 7969  well, like copyi
-00013bc0: 6e67 206d 6f64 756c 6520 7265 6665 7265  ng module refere
-00013bd0: 6e63 6573 2e0a 0a20 2020 203a 7061 7261  nces...    :para
-00013be0: 6d20 5420 783a 2061 6e20 6172 6269 7472  m T x: an arbitr
-00013bf0: 6172 7920 6f62 6a65 6374 0a20 2020 203a  ary object.    :
-00013c00: 7061 7261 6d20 6c69 7374 5b74 7970 655d  param list[type]
-00013c10: 7c4e 6f6e 6520 7374 6f70 5f74 7970 6573  |None stop_types
-00013c20: 3a20 6f62 6a65 6374 7320 6f66 2074 6865  : objects of the
-00013c30: 7365 2074 7970 6573 2077 696c 6c20 6e6f  se types will no
-00013c40: 7420 6265 2064 6565 702d 636f 7069 6564  t be deep-copied
-00013c50: 2c20 6f6e 6c79 2074 6865 2072 6566 6572  , only the refer
-00013c60: 656e 6365 2069 7320 7061 7373 6564 0a20  ence is passed. 
-00013c70: 2020 203a 7274 7970 653a 2054 0a20 2020     :rtype: T.   
-00013c80: 2022 2222 0a20 2020 2023 2053 6565 2061   """.    # See a
-00013c90: 6c73 6f20 636c 6173 7320 5069 636b 6c65  lso class Pickle
-00013ca0: 7220 6672 6f6d 2054 6173 6b53 7973 7465  r from TaskSyste
-00013cb0: 6d2e 0a20 2020 2023 204f 723a 2068 7474  m..    # Or: htt
-00013cc0: 7073 3a2f 2f6d 6169 6c2e 7079 7468 6f6e  ps://mail.python
-00013cd0: 2e6f 7267 2f70 6970 6572 6d61 696c 2f70  .org/pipermail/p
-00013ce0: 7974 686f 6e2d 6964 6561 732f 3230 3133  ython-ideas/2013
-00013cf0: 2d4a 756c 792f 3032 3139 3539 2e68 746d  -July/021959.htm
-00013d00: 6c0a 2020 2020 6672 6f6d 202e 7461 736b  l.    from .task
-00013d10: 5f73 7973 7465 6d20 696d 706f 7274 2050  _system import P
-00013d20: 6963 6b6c 6572 2c20 556e 7069 636b 6c65  ickler, Unpickle
-00013d30: 720a 0a20 2020 2070 6572 7369 7374 656e  r..    persisten
-00013d40: 745f 6d65 6d6f 203d 207b 7d20 2023 2069  t_memo = {}  # i
-00013d50: 6420 2d3e 206f 626a 0a0a 2020 2020 6465  d -> obj..    de
-00013d60: 6620 7065 7273 6973 7465 6e74 5f69 6428  f persistent_id(
-00013d70: 6f62 6a29 3a0a 2020 2020 2020 2020 2222  obj):.        ""
-00013d80: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
-00013d90: 206f 626a 6563 7420 6f62 6a3a 0a20 2020   object obj:.   
-00013da0: 2020 2020 203a 7274 7970 653a 2069 6e74       :rtype: int
-00013db0: 7c4e 6f6e 650a 2020 2020 2020 2020 2222  |None.        ""
-00013dc0: 220a 2020 2020 2020 2020 6966 2073 746f  ".        if sto
-00013dd0: 705f 7479 7065 7320 616e 6420 6973 696e  p_types and isin
-00013de0: 7374 616e 6365 286f 626a 2c20 7475 706c  stance(obj, tupl
-00013df0: 6528 7374 6f70 5f74 7970 6573 2929 3a0a  e(stop_types)):.
-00013e00: 2020 2020 2020 2020 2020 2020 7065 7273              pers
-00013e10: 6973 7465 6e74 5f6d 656d 6f5b 6964 286f  istent_memo[id(o
-00013e20: 626a 295d 203d 206f 626a 0a20 2020 2020  bj)] = obj.     
-00013e30: 2020 2020 2020 2072 6574 7572 6e20 6964         return id
-00013e40: 286f 626a 290a 2020 2020 2020 2020 7265  (obj).        re
-00013e50: 7475 726e 204e 6f6e 650a 0a20 2020 2064  turn None..    d
-00013e60: 6566 2070 6963 6b6c 655f 6475 6d70 7328  ef pickle_dumps(
-00013e70: 6f62 6a29 3a0a 2020 2020 2020 2020 2222  obj):.        ""
-00013e80: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
-00013e90: 206f 626a 6563 7420 6f62 6a3a 0a20 2020   object obj:.   
-00013ea0: 2020 2020 203a 7274 7970 653a 2062 7974       :rtype: byt
-00013eb0: 6573 0a20 2020 2020 2020 2022 2222 0a20  es.        """. 
-00013ec0: 2020 2020 2020 2073 696f 203d 2042 7974         sio = Byt
-00013ed0: 6573 494f 2829 0a20 2020 2020 2020 2070  esIO().        p
-00013ee0: 203d 2050 6963 6b6c 6572 2873 696f 290a   = Pickler(sio).
-00013ef0: 2020 2020 2020 2020 702e 7065 7273 6973          p.persis
-00013f00: 7465 6e74 5f69 6420 3d20 7065 7273 6973  tent_id = persis
-00013f10: 7465 6e74 5f69 640a 2020 2020 2020 2020  tent_id.        
-00013f20: 702e 6475 6d70 286f 626a 290a 2020 2020  p.dump(obj).    
-00013f30: 2020 2020 7265 7475 726e 2073 696f 2e67      return sio.g
-00013f40: 6574 7661 6c75 6528 290a 0a20 2020 2023  etvalue()..    #
-00013f50: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
-00013f60: 5368 6164 6f77 696e 674e 616d 6573 0a20  ShadowingNames. 
-00013f70: 2020 2064 6566 2070 6963 6b6c 655f 6c6f     def pickle_lo
-00013f80: 6164 7328 7329 3a0a 2020 2020 2020 2020  ads(s):.        
-00013f90: 2222 220a 2020 2020 2020 2020 3a70 6172  """.        :par
-00013fa0: 616d 2062 7974 6573 2073 3a0a 2020 2020  am bytes s:.    
-00013fb0: 2020 2020 3a72 7479 7065 3a20 6f62 6a65      :rtype: obje
-00013fc0: 6374 0a20 2020 2020 2020 2022 2222 0a20  ct.        """. 
-00013fd0: 2020 2020 2020 2070 203d 2055 6e70 6963         p = Unpic
-00013fe0: 6b6c 6572 2842 7974 6573 494f 2873 2929  kler(BytesIO(s))
-00013ff0: 0a20 2020 2020 2020 2070 2e70 6572 7369  .        p.persi
-00014000: 7374 656e 745f 6c6f 6164 203d 2070 6572  stent_load = per
-00014010: 7369 7374 656e 745f 6d65 6d6f 2e5f 5f67  sistent_memo.__g
-00014020: 6574 6974 656d 5f5f 0a20 2020 2020 2020  etitem__.       
-00014030: 2072 6574 7572 6e20 702e 6c6f 6164 2829   return p.load()
-00014040: 0a0a 2020 2020 7320 3d20 7069 636b 6c65  ..    s = pickle
-00014050: 5f64 756d 7073 2878 290a 2020 2020 6320  _dumps(x).    c 
-00014060: 3d20 7069 636b 6c65 5f6c 6f61 6473 2873  = pickle_loads(s
-00014070: 290a 2020 2020 7265 7475 726e 2063 0a0a  ).    return c..
-00014080: 0a64 6566 2072 6561 645f 6279 7465 735f  .def read_bytes_
-00014090: 746f 5f6e 6577 5f62 7566 6665 7228 703a  to_new_buffer(p:
-000140a0: 2074 7970 696e 672e 4269 6e61 7279 494f   typing.BinaryIO
-000140b0: 2c20 7369 7a65 3a20 696e 7429 202d 3e20  , size: int) -> 
-000140c0: 4279 7465 7349 4f3a 0a20 2020 2022 2222  BytesIO:.    """
-000140d0: 0a20 2020 2052 6561 6420 6279 7465 7320  .    Read bytes 
-000140e0: 6672 6f6d 2073 7472 6561 6d20 7320 696e  from stream s in
-000140f0: 746f 2061 2042 7974 6573 494f 2062 7566  to a BytesIO buf
-00014100: 6665 722e 0a20 2020 2052 6169 7365 7320  fer..    Raises 
-00014110: 454f 4645 7272 6f72 2069 6620 6e6f 7420  EOFError if not 
-00014120: 656e 6f75 6768 2062 7974 6573 2061 7265  enough bytes are
-00014130: 2061 7661 696c 6162 6c65 2e0a 2020 2020   available..    
-00014140: 5468 656e 2072 6561 6420 6974 2076 6961  Then read it via
-00014150: 203a 6675 6e63 3a60 7265 6164 5f70 6963   :func:`read_pic
-00014160: 6b6c 6564 5f6f 626a 6563 7460 2e0a 2020  kled_object`..  
-00014170: 2020 2222 220a 2020 2020 7374 7265 616d    """.    stream
-00014180: 203d 2042 7974 6573 494f 2829 0a20 2020   = BytesIO().   
-00014190: 2072 6561 645f 7369 7a65 203d 2030 0a20   read_size = 0. 
-000141a0: 2020 2077 6869 6c65 2072 6561 645f 7369     while read_si
-000141b0: 7a65 203c 2073 697a 653a 0a20 2020 2020  ze < size:.     
-000141c0: 2020 2064 6174 615f 7261 7720 3d20 702e     data_raw = p.
-000141d0: 7265 6164 2873 697a 6520 2d20 7265 6164  read(size - read
-000141e0: 5f73 697a 6529 0a20 2020 2020 2020 2069  _size).        i
-000141f0: 6620 6c65 6e28 6461 7461 5f72 6177 2920  f len(data_raw) 
-00014200: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00014210: 2020 7261 6973 6520 454f 4645 7272 6f72    raise EOFError
-00014220: 2822 6578 7065 6374 6564 2074 6f20 7265  ("expected to re
-00014230: 6164 2025 6920 6279 7465 7320 6275 7420  ad %i bytes but 
-00014240: 676f 7420 454f 4620 6166 7465 7220 2569  got EOF after %i
-00014250: 2062 7974 6573 2220 2520 2873 697a 652c   bytes" % (size,
-00014260: 2072 6561 645f 7369 7a65 2929 0a20 2020   read_size)).   
-00014270: 2020 2020 2072 6561 645f 7369 7a65 202b       read_size +
-00014280: 3d20 6c65 6e28 6461 7461 5f72 6177 290a  = len(data_raw).
-00014290: 2020 2020 2020 2020 7374 7265 616d 2e77          stream.w
-000142a0: 7269 7465 2864 6174 615f 7261 7729 0a20  rite(data_raw). 
-000142b0: 2020 2073 7472 6561 6d2e 7365 656b 2830     stream.seek(0
-000142c0: 290a 2020 2020 7265 7475 726e 2073 7472  ).    return str
-000142d0: 6561 6d0a 0a0a 6465 6620 7265 6164 5f70  eam...def read_p
-000142e0: 6963 6b6c 6564 5f6f 626a 6563 7428 703a  ickled_object(p:
-000142f0: 2074 7970 696e 672e 4269 6e61 7279 494f   typing.BinaryIO
-00014300: 2c20 2a2c 2065 6e63 6f64 696e 673d 4e6f  , *, encoding=No
-00014310: 6e65 2920 2d3e 2041 6e79 3a0a 2020 2020  ne) -> Any:.    
-00014320: 2222 220a 2020 2020 5265 6164 2070 6963  """.    Read pic
-00014330: 6b6c 6564 206f 626a 6563 7420 6672 6f6d  kled object from
-00014340: 2073 7472 6561 6d20 702c 0a20 2020 2061   stream p,.    a
-00014350: 6674 6572 2069 7420 7761 7320 7772 6974  fter it was writ
-00014360: 7465 6e20 7669 6120 3a66 756e 633a 6072  ten via :func:`r
-00014370: 6561 645f 6279 7465 735f 746f 5f6e 6577  ead_bytes_to_new
-00014380: 5f62 7566 6665 7260 2e0a 0a20 2020 203a  _buffer`...    :
-00014390: 7061 7261 6d20 703a 0a20 2020 203a 7061  param p:.    :pa
-000143a0: 7261 6d20 656e 636f 6469 6e67 3a20 6966  ram encoding: if
-000143b0: 2067 6976 656e 2c20 7061 7373 6564 2074   given, passed t
-000143c0: 6f20 556e 7069 636b 6c65 720a 2020 2020  o Unpickler.    
-000143d0: 2222 220a 2020 2020 6672 6f6d 2072 6574  """.    from ret
-000143e0: 7572 6e6e 2e75 7469 6c2e 7461 736b 5f73  urnn.util.task_s
-000143f0: 7973 7465 6d20 696d 706f 7274 2055 6e70  ystem import Unp
-00014400: 6963 6b6c 6572 0a0a 2020 2020 7369 7a65  ickler..    size
-00014410: 5f72 6177 203d 2072 6561 645f 6279 7465  _raw = read_byte
-00014420: 735f 746f 5f6e 6577 5f62 7566 6665 7228  s_to_new_buffer(
-00014430: 702c 2034 292e 6765 7476 616c 7565 2829  p, 4).getvalue()
-00014440: 0a20 2020 2028 7369 7a65 2c29 203d 2073  .    (size,) = s
-00014450: 7472 7563 742e 756e 7061 636b 2822 3c69  truct.unpack("<i
-00014460: 222c 2073 697a 655f 7261 7729 0a20 2020  ", size_raw).   
-00014470: 2061 7373 6572 7420 7369 7a65 203e 2030   assert size > 0
-00014480: 2c20 2272 6561 645f 7069 636b 6c65 645f  , "read_pickled_
-00014490: 6f62 6a65 6374 3a20 5765 2065 7870 6563  object: We expec
-000144a0: 7420 746f 2067 6574 2073 6f6d 6520 6e6f  t to get some no
-000144b0: 6e2d 656d 7074 7920 7061 636b 6167 652e  n-empty package.
-000144c0: 220a 2020 2020 7374 7265 616d 203d 2072  ".    stream = r
-000144d0: 6561 645f 6279 7465 735f 746f 5f6e 6577  ead_bytes_to_new
-000144e0: 5f62 7566 6665 7228 702c 2073 697a 6529  _buffer(p, size)
-000144f0: 0a20 2020 2075 6e70 6963 6b6c 6572 5f6b  .    unpickler_k
-00014500: 7761 7267 7320 3d20 7b7d 0a20 2020 2069  wargs = {}.    i
-00014510: 6620 656e 636f 6469 6e67 3a0a 2020 2020  f encoding:.    
-00014520: 2020 2020 756e 7069 636b 6c65 725f 6b77      unpickler_kw
-00014530: 6172 6773 5b22 656e 636f 6469 6e67 225d  args["encoding"]
-00014540: 203d 2065 6e63 6f64 696e 670a 2020 2020   = encoding.    
-00014550: 7265 7475 726e 2055 6e70 6963 6b6c 6572  return Unpickler
-00014560: 2873 7472 6561 6d2c 202a 2a75 6e70 6963  (stream, **unpic
-00014570: 6b6c 6572 5f6b 7761 7267 7329 2e6c 6f61  kler_kwargs).loa
-00014580: 6428 290a 0a0a 6465 6620 7772 6974 655f  d()...def write_
-00014590: 7069 636b 6c65 645f 6f62 6a65 6374 2870  pickled_object(p
-000145a0: 3a20 7479 7069 6e67 2e42 696e 6172 7949  : typing.BinaryI
-000145b0: 4f2c 206f 626a 3a20 416e 7929 3a0a 2020  O, obj: Any):.  
-000145c0: 2020 2222 220a 2020 2020 5772 6974 6573    """.    Writes
-000145d0: 2070 6963 6b6c 6564 206f 626a 6563 7420   pickled object 
-000145e0: 746f 2073 7472 6561 6d20 702e 0a20 2020  to stream p..   
-000145f0: 2022 2222 0a20 2020 2066 726f 6d20 7265   """.    from re
-00014600: 7475 726e 6e2e 7574 696c 2e74 6173 6b5f  turnn.util.task_
-00014610: 7379 7374 656d 2069 6d70 6f72 7420 5069  system import Pi
-00014620: 636b 6c65 720a 0a20 2020 2073 7472 6561  ckler..    strea
-00014630: 6d20 3d20 4279 7465 7349 4f28 290a 2020  m = BytesIO().  
-00014640: 2020 5069 636b 6c65 7228 7374 7265 616d    Pickler(stream
-00014650: 292e 6475 6d70 286f 626a 290a 2020 2020  ).dump(obj).    
-00014660: 7261 775f 6461 7461 203d 2073 7472 6561  raw_data = strea
-00014670: 6d2e 6765 7476 616c 7565 2829 0a20 2020  m.getvalue().   
-00014680: 2061 7373 6572 7420 6c65 6e28 7261 775f   assert len(raw_
-00014690: 6461 7461 2920 3e20 300a 2020 2020 702e  data) > 0.    p.
-000146a0: 7772 6974 6528 7374 7275 6374 2e70 6163  write(struct.pac
-000146b0: 6b28 223c 6922 2c20 6c65 6e28 7261 775f  k("<i", len(raw_
-000146c0: 6461 7461 2929 290a 2020 2020 702e 7772  data))).    p.wr
-000146d0: 6974 6528 7261 775f 6461 7461 290a 2020  ite(raw_data).  
-000146e0: 2020 702e 666c 7573 6828 290a 0a0a 6465    p.flush()...de
-000146f0: 6620 6c6f 6164 5f74 7874 5f76 6563 746f  f load_txt_vecto
-00014700: 7228 6669 6c65 6e61 6d65 293a 0a20 2020  r(filename):.   
-00014710: 2022 2222 0a20 2020 2045 7870 6563 7420   """.    Expect 
-00014720: 6c69 6e65 2d62 6173 6564 2074 6578 7420  line-based text 
-00014730: 656e 636f 6469 6e67 2069 6e20 6669 6c65  encoding in file
-00014740: 2e0a 2020 2020 5765 2061 6c73 6f20 7375  ..    We also su
-00014750: 7070 6f72 7420 5370 7269 6e74 2058 4d4c  pport Sprint XML
-00014760: 2066 6f72 6d61 742c 2077 6869 6368 2068   format, which h
-00014770: 6173 2073 6f6d 6520 6164 6469 7469 6f6e  as some addition
-00014780: 616c 2078 6d6c 2068 6561 6465 7220 616e  al xml header an
-00014790: 6420 666f 6f74 6572 2c0a 2020 2020 7768  d footer,.    wh
-000147a0: 6963 6820 7765 2077 696c 6c20 6a75 7374  ich we will just
-000147b0: 2073 7472 6970 2061 7761 792e 0a0a 2020   strip away...  
-000147c0: 2020 3a70 6172 616d 2073 7472 2066 696c    :param str fil
-000147d0: 656e 616d 653a 0a20 2020 203a 7274 7970  ename:.    :rtyp
-000147e0: 653a 206c 6973 745b 666c 6f61 745d 0a20  e: list[float]. 
-000147f0: 2020 2022 2222 0a20 2020 2072 6574 7572     """.    retur
-00014800: 6e20 5b66 6c6f 6174 286c 696e 6529 2066  n [float(line) f
-00014810: 6f72 206c 696e 6520 696e 206f 7065 6e28  or line in open(
-00014820: 6669 6c65 6e61 6d65 292e 7265 6164 2829  filename).read()
-00014830: 2e73 706c 6974 6c69 6e65 7328 2920 6966  .splitlines() if
-00014840: 206c 696e 6520 616e 6420 6e6f 7420 6c69   line and not li
-00014850: 6e65 2e73 7461 7274 7377 6974 6828 223c  ne.startswith("<
-00014860: 2229 5d0a 0a0a 636c 6173 7320 436f 6c6c  ")]...class Coll
-00014870: 6563 7469 6f6e 5265 6164 4368 6563 6b43  ectionReadCheckC
-00014880: 6f76 6572 6564 3a0a 2020 2020 2222 220a  overed:.    """.
-00014890: 2020 2020 5772 6170 7320 6172 6f75 6e64      Wraps around
-000148a0: 2061 2064 6963 742e 2049 7420 6b65 6570   a dict. It keep
-000148b0: 7320 7472 6163 6b20 6162 6f75 7420 616c  s track about al
-000148c0: 6c20 7468 6520 6b65 7973 2077 6869 6368  l the keys which
-000148d0: 2077 6572 6520 7265 6164 2066 726f 6d20   were read from 
-000148e0: 7468 6520 6469 6374 2e0a 2020 2020 5669  the dict..    Vi
-000148f0: 6120 3a66 756e 633a 6061 7373 6572 745f  a :func:`assert_
-00014900: 616c 6c5f 7265 6164 602c 2079 6f75 2063  all_read`, you c
-00014910: 616e 2063 6865 636b 2074 6861 7420 7468  an check that th
-00014920: 6572 6520 6172 6520 6e6f 206b 6579 7320  ere are no keys 
-00014930: 696e 2074 6865 2064 6963 7420 7768 6963  in the dict whic
-00014940: 6820 7765 7265 206e 6f74 2072 6561 642e  h were not read.
-00014950: 0a20 2020 2054 6865 2075 7361 6765 2069  .    The usage i
-00014960: 7320 666f 7220 636f 6e66 6967 2064 6963  s for config dic
-00014970: 7420 6f70 7469 6f6e 732c 2077 6865 7265  t options, where
-00014980: 2074 6865 2075 7365 7220 6861 7320 7370   the user has sp
-00014990: 6563 6966 6965 6420 6120 7261 6e67 6520  ecified a range 
-000149a0: 6f66 206f 7074 696f 6e73 2c0a 2020 2020  of options,.    
-000149b0: 616e 6420 7768 6572 6520 696e 2074 6865  and where in the
-000149c0: 2063 6f64 6520 7468 6572 6520 6973 2075   code there is u
-000149d0: 7375 616c 6c79 2061 2064 6566 6175 6c74  sually a default
-000149e0: 2066 6f72 2065 7665 7279 206e 6f6e 2d73   for every non-s
-000149f0: 7065 6369 6669 6564 206f 7074 696f 6e2c  pecified option,
-00014a00: 0a20 2020 2074 6f20 6368 6563 6b20 7768  .    to check wh
-00014a10: 6574 6865 7220 616c 6c20 7468 6520 7573  ether all the us
-00014a20: 6572 2d73 7065 6369 6669 6564 206f 7074  er-specified opt
-00014a30: 696f 6e73 2061 7265 2061 6c73 6f20 7573  ions are also us
-00014a40: 6564 2028 6d61 7962 6520 7468 6520 7573  ed (maybe the us
-00014a50: 6572 206d 6164 6520 6120 7479 706f 292e  er made a typo).
-00014a60: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-00014a70: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00014a80: 2063 6f6c 6c65 6374 696f 6e3a 2044 6963   collection: Dic
-00014a90: 745b 7374 722c 2041 6e79 5d2c 2074 7275  t[str, Any], tru
-00014aa0: 7468 5f76 616c 7565 3a20 4f70 7469 6f6e  th_value: Option
-00014ab0: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 6529  al[bool] = None)
-00014ac0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00014ad0: 2020 2020 2020 3a70 6172 616d 2063 6f6c        :param col
-00014ae0: 6c65 6374 696f 6e3a 0a20 2020 2020 2020  lection:.       
-00014af0: 203a 7061 7261 6d20 7472 7574 685f 7661   :param truth_va
-00014b00: 6c75 653a 206e 6f74 653a 2063 6865 636b  lue: note: check
-00014b10: 2065 7870 6c69 6369 746c 7920 666f 7220   explicitly for 
-00014b20: 7365 6c66 2e74 7275 7468 5f76 616c 7565  self.truth_value
-00014b30: 2c20 626f 6f6c 2873 656c 6629 2069 7320  , bool(self) is 
-00014b40: 6e6f 7420 7468 6520 7361 6d65 210a 2020  not the same!.  
-00014b50: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00014b60: 2020 7365 6c66 2e63 6f6c 6c65 6374 696f    self.collectio
-00014b70: 6e20 3d20 636f 6c6c 6563 7469 6f6e 0a20  n = collection. 
-00014b80: 2020 2020 2020 2069 6620 7472 7574 685f         if truth_
-00014b90: 7661 6c75 6520 6973 204e 6f6e 653a 0a20  value is None:. 
-00014ba0: 2020 2020 2020 2020 2020 2074 7275 7468             truth
-00014bb0: 5f76 616c 7565 203d 2062 6f6f 6c28 7365  _value = bool(se
-00014bc0: 6c66 2e63 6f6c 6c65 6374 696f 6e29 0a20  lf.collection). 
-00014bd0: 2020 2020 2020 2073 656c 662e 7472 7574         self.trut
-00014be0: 685f 7661 6c75 6520 3d20 7472 7574 685f  h_value = truth_
-00014bf0: 7661 6c75 650a 2020 2020 2020 2020 7365  value.        se
-00014c00: 6c66 2e67 6f74 5f69 7465 6d73 203d 2073  lf.got_items = s
-00014c10: 6574 2829 0a0a 2020 2020 6465 6620 5f5f  et()..    def __
-00014c20: 7265 7072 5f5f 2873 656c 6629 3a0a 2020  repr__(self):.  
-00014c30: 2020 2020 2020 7265 7475 726e 2022 2573        return "%s
-00014c40: 2825 722c 2074 7275 7468 5f76 616c 7565  (%r, truth_value
-00014c50: 3d25 7229 2220 2520 2873 656c 662e 5f5f  =%r)" % (self.__
-00014c60: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-00014c70: 2c20 7365 6c66 2e63 6f6c 6c65 6374 696f  , self.collectio
-00014c80: 6e2c 2073 656c 662e 7472 7574 685f 7661  n, self.truth_va
-00014c90: 6c75 6529 0a0a 2020 2020 4063 6c61 7373  lue)..    @class
-00014ca0: 6d65 7468 6f64 0a20 2020 2064 6566 2066  method.    def f
-00014cb0: 726f 6d5f 626f 6f6c 5f6f 725f 6469 6374  rom_bool_or_dict
-00014cc0: 2863 6c73 2c20 7661 6c75 653a 2055 6e69  (cls, value: Uni
-00014cd0: 6f6e 5b62 6f6f 6c2c 2044 6963 745b 7374  on[bool, Dict[st
-00014ce0: 722c 2041 6e79 5d5d 2920 2d3e 2043 6f6c  r, Any]]) -> Col
-00014cf0: 6c65 6374 696f 6e52 6561 6443 6865 636b  lectionReadCheck
-00014d00: 436f 7665 7265 643a 0a20 2020 2020 2020  Covered:.       
-00014d10: 2022 2222 0a20 2020 2020 2020 203a 7061   """.        :pa
-00014d20: 7261 6d20 7661 6c75 653a 0a20 2020 2020  ram value:.     
-00014d30: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00014d40: 6620 6973 696e 7374 616e 6365 2876 616c  f isinstance(val
-00014d50: 7565 2c20 626f 6f6c 293a 0a20 2020 2020  ue, bool):.     
-00014d60: 2020 2020 2020 2072 6574 7572 6e20 636c         return cl
-00014d70: 7328 636f 6c6c 6563 7469 6f6e 3d7b 7d2c  s(collection={},
-00014d80: 2074 7275 7468 5f76 616c 7565 3d76 616c   truth_value=val
-00014d90: 7565 290a 2020 2020 2020 2020 6966 2069  ue).        if i
-00014da0: 7369 6e73 7461 6e63 6528 7661 6c75 652c  sinstance(value,
-00014db0: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
-00014dc0: 2020 2020 7265 7475 726e 2063 6c73 2863      return cls(c
-00014dd0: 6f6c 6c65 6374 696f 6e3d 7661 6c75 6529  ollection=value)
-00014de0: 0a20 2020 2020 2020 2072 6169 7365 2054  .        raise T
-00014df0: 7970 6545 7272 6f72 2822 696e 7661 6c69  ypeError("invali
-00014e00: 6420 7479 7065 3a20 2573 2220 2520 7479  d type: %s" % ty
-00014e10: 7065 2876 616c 7565 2929 0a0a 2020 2020  pe(value))..    
-00014e20: 6465 6620 5f5f 6765 7469 7465 6d5f 5f28  def __getitem__(
-00014e30: 7365 6c66 2c20 6974 656d 293a 0a20 2020  self, item):.   
-00014e40: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
-00014e50: 636f 6c6c 6563 7469 6f6e 5b69 7465 6d5d  collection[item]
-00014e60: 0a20 2020 2020 2020 2073 656c 662e 676f  .        self.go
-00014e70: 745f 6974 656d 732e 6164 6428 6974 656d  t_items.add(item
-00014e80: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00014e90: 2072 6573 0a0a 2020 2020 6465 6620 6765   res..    def ge
-00014ea0: 7428 7365 6c66 2c20 6974 656d 2c20 6465  t(self, item, de
-00014eb0: 6661 756c 743d 4e6f 6e65 293a 0a20 2020  fault=None):.   
-00014ec0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00014ed0: 203a 7061 7261 6d20 7374 7220 6974 656d   :param str item
-00014ee0: 3a0a 2020 2020 2020 2020 3a70 6172 616d  :.        :param
-00014ef0: 2054 2064 6566 6175 6c74 3a0a 2020 2020   T default:.    
-00014f00: 2020 2020 3a72 7479 7065 3a20 547c 7479      :rtype: T|ty
-00014f10: 7069 6e67 2e41 6e79 7c4e 6f6e 650a 2020  ping.Any|None.  
-00014f20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00014f30: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00014f40: 2020 2072 6574 7572 6e20 7365 6c66 5b69     return self[i
-00014f50: 7465 6d5d 0a20 2020 2020 2020 2065 7863  tem].        exc
-00014f60: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-00014f70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00014f80: 2064 6566 6175 6c74 0a0a 2020 2020 6465   default..    de
-00014f90: 6620 5f5f 626f 6f6c 5f5f 2873 656c 6629  f __bool__(self)
-00014fa0: 202d 3e20 626f 6f6c 3a20 2023 2050 7974   -> bool:  # Pyt
-00014fb0: 686f 6e20 330a 2020 2020 2020 2020 7265  hon 3.        re
-00014fc0: 7475 726e 2073 656c 662e 7472 7574 685f  turn self.truth_
-00014fd0: 7661 6c75 650a 0a20 2020 205f 5f6e 6f6e  value..    __non
-00014fe0: 7a65 726f 5f5f 203d 205f 5f62 6f6f 6c5f  zero__ = __bool_
-00014ff0: 5f20 2023 2050 7974 686f 6e20 320a 0a20  _  # Python 2.. 
-00015000: 2020 2064 6566 205f 5f6c 656e 5f5f 2873     def __len__(s
-00015010: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-00015020: 7475 726e 206c 656e 2873 656c 662e 636f  turn len(self.co
-00015030: 6c6c 6563 7469 6f6e 290a 0a20 2020 2064  llection)..    d
-00015040: 6566 205f 5f69 7465 725f 5f28 7365 6c66  ef __iter__(self
-00015050: 293a 0a20 2020 2020 2020 2066 6f72 206b  ):.        for k
-00015060: 2069 6e20 7365 6c66 2e63 6f6c 6c65 6374   in self.collect
-00015070: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-00015080: 2079 6965 6c64 2073 656c 665b 6b5d 0a0a   yield self[k]..
-00015090: 2020 2020 6465 6620 6173 7365 7274 5f61      def assert_a
-000150a0: 6c6c 5f72 6561 6428 7365 6c66 293a 0a20  ll_read(self):. 
-000150b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000150c0: 2020 2041 7373 6572 7473 2074 6861 7420     Asserts that 
-000150d0: 616c 6c20 6974 656d 7320 6861 7665 2062  all items have b
-000150e0: 6565 6e20 7265 6164 2e0a 2020 2020 2020  een read..      
-000150f0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-00015100: 6d61 696e 696e 6720 3d20 7365 7428 7365  maining = set(se
-00015110: 6c66 2e63 6f6c 6c65 6374 696f 6e29 2e64  lf.collection).d
-00015120: 6966 6665 7265 6e63 6528 7365 6c66 2e67  ifference(self.g
-00015130: 6f74 5f69 7465 6d73 290a 2020 2020 2020  ot_items).      
-00015140: 2020 6173 7365 7274 206e 6f74 2072 656d    assert not rem
-00015150: 6169 6e69 6e67 2c20 2254 6865 206b 6579  aining, "The key
-00015160: 7320 2572 2077 6572 6520 6e6f 7420 7265  s %r were not re
-00015170: 6164 2069 6e20 7468 6520 636f 6c6c 6563  ad in the collec
-00015180: 7469 6f6e 2025 722e 2220 2520 2872 656d  tion %r." % (rem
-00015190: 6169 6e69 6e67 2c20 7365 6c66 2e63 6f6c  aining, self.col
-000151a0: 6c65 6374 696f 6e29 0a0a 0a64 6566 2077  lection)...def w
-000151b0: 6869 6368 2870 726f 6772 616d 3a20 7374  hich(program: st
-000151c0: 7229 202d 3e20 4f70 7469 6f6e 616c 5b73  r) -> Optional[s
-000151d0: 7472 5d3a 0a20 2020 2022 2222 0a20 2020  tr]:.    """.   
-000151e0: 2046 696e 6473 2060 7072 6f67 7261 6d60   Finds `program`
-000151f0: 2069 6e20 736f 6d65 206f 6620 7468 6520   in some of the 
-00015200: 6469 7273 206f 6620 7468 6520 5041 5448  dirs of the PATH
-00015210: 2065 6e76 2076 6172 2e0a 0a20 2020 203a   env var...    :
-00015220: 7061 7261 6d20 7072 6f67 7261 6d3a 2065  param program: e
-00015230: 2e67 2e20 2270 7974 686f 6e22 0a20 2020  .g. "python".   
-00015240: 203a 7265 7475 726e 3a20 6675 6c6c 2070   :return: full p
-00015250: 6174 682c 2065 2e67 2e20 222f 7573 722f  ath, e.g. "/usr/
-00015260: 6269 6e2f 7079 7468 6f6e 222c 206f 7220  bin/python", or 
-00015270: 4e6f 6e65 0a20 2020 2022 2222 0a0a 2020  None.    """..  
-00015280: 2020 2320 6e6f 696e 7370 6563 7469 6f6e    # noinspection
-00015290: 2050 7953 6861 646f 7769 6e67 4e61 6d65   PyShadowingName
-000152a0: 730a 2020 2020 6465 6620 6973 5f65 7865  s.    def is_exe
-000152b0: 2870 6174 6829 3a0a 2020 2020 2020 2020  (path):.        
-000152c0: 2222 220a 2020 2020 2020 2020 3a70 6172  """.        :par
-000152d0: 616d 2073 7472 2070 6174 683a 0a20 2020  am str path:.   
-000152e0: 2020 2020 203a 7274 7970 653a 2073 7472       :rtype: str
-000152f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00015300: 2020 2020 2072 6574 7572 6e20 6f73 2e70       return os.p
-00015310: 6174 682e 6973 6669 6c65 2870 6174 6829  ath.isfile(path)
-00015320: 2061 6e64 206f 732e 6163 6365 7373 2870   and os.access(p
-00015330: 6174 682c 206f 732e 585f 4f4b 290a 0a20  ath, os.X_OK).. 
-00015340: 2020 2066 7061 7468 2c20 666e 616d 6520     fpath, fname 
-00015350: 3d20 6f73 2e70 6174 682e 7370 6c69 7428  = os.path.split(
-00015360: 7072 6f67 7261 6d29 0a20 2020 2069 6620  program).    if 
-00015370: 6670 6174 683a 0a20 2020 2020 2020 2069  fpath:.        i
-00015380: 6620 6973 5f65 7865 2870 726f 6772 616d  f is_exe(program
-00015390: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000153a0: 6574 7572 6e20 7072 6f67 7261 6d0a 2020  eturn program.  
-000153b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000153c0: 666f 7220 7061 7468 2069 6e20 6f73 2e65  for path in os.e
-000153d0: 6e76 6972 6f6e 5b22 5041 5448 225d 2e73  nviron["PATH"].s
-000153e0: 706c 6974 286f 732e 7061 7468 7365 7029  plit(os.pathsep)
-000153f0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-00015400: 7468 203d 2070 6174 682e 7374 7269 7028  th = path.strip(
-00015410: 2722 2729 0a20 2020 2020 2020 2020 2020  '"').           
-00015420: 2065 7865 5f66 696c 6520 3d20 6f73 2e70   exe_file = os.p
-00015430: 6174 682e 6a6f 696e 2870 6174 682c 2070  ath.join(path, p
-00015440: 726f 6772 616d 290a 2020 2020 2020 2020  rogram).        
-00015450: 2020 2020 6966 2069 735f 6578 6528 6578      if is_exe(ex
-00015460: 655f 6669 6c65 293a 0a20 2020 2020 2020  e_file):.       
-00015470: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00015480: 6578 655f 6669 6c65 0a0a 2020 2020 7265  exe_file..    re
-00015490: 7475 726e 204e 6f6e 650a 0a0a 6465 6620  turn None...def 
-000154a0: 7768 6963 685f 7069 7028 293a 0a20 2020  which_pip():.   
-000154b0: 2022 2222 0a20 2020 203a 7274 7970 653a   """.    :rtype:
-000154c0: 2073 7472 0a20 2020 203a 7265 7475 726e   str.    :return
-000154d0: 3a20 7061 7468 2074 6f20 7069 7020 666f  : path to pip fo
-000154e0: 7220 7468 6520 6375 7272 656e 7420 5079  r the current Py
-000154f0: 7468 6f6e 2065 6e76 0a20 2020 2022 2222  thon env.    """
-00015500: 0a20 2020 2023 2042 6566 6f72 6520 7765  .    # Before we
-00015510: 206c 6f6f 6b20 616e 7977 6865 7265 2069   look anywhere i
-00015520: 6e20 5041 5448 2c20 6368 6563 6b20 6966  n PATH, check if
-00015530: 2074 6865 7265 2069 7320 736f 6d65 2070   there is some p
-00015540: 6970 2061 6c6f 6e67 7369 6465 2074 6f20  ip alongside to 
-00015550: 7468 6520 5079 7468 6f6e 2065 7865 6375  the Python execu
-00015560: 7461 626c 652e 0a20 2020 2023 2054 6869  table..    # Thi
-00015570: 7320 6d69 6768 7420 6265 206d 6f72 6520  s might be more 
-00015580: 7265 6c69 6162 6c65 2e0a 2020 2020 7079  reliable..    py
-00015590: 203d 2073 7973 2e65 7865 6375 7461 626c   = sys.executabl
-000155a0: 650a 2020 2020 6469 725f 6e61 6d65 2c20  e.    dir_name, 
-000155b0: 6261 7365 6e61 6d65 203d 2070 792e 7273  basename = py.rs
-000155c0: 706c 6974 2822 2f22 2c20 3129 0a20 2020  plit("/", 1).   
-000155d0: 2069 6620 6261 7365 6e61 6d65 2e73 7461   if basename.sta
-000155e0: 7274 7377 6974 6828 2270 7974 686f 6e22  rtswith("python"
-000155f0: 293a 0a20 2020 2020 2020 2070 6f73 7466  ):.        postf
-00015600: 6978 203d 2062 6173 656e 616d 655b 6c65  ix = basename[le
-00015610: 6e28 2270 7974 686f 6e22 2920 3a5d 0a20  n("python") :]. 
-00015620: 2020 2020 2020 2070 6970 5f70 6174 6820         pip_path 
-00015630: 3d20 2225 732f 7069 7025 7322 2025 2028  = "%s/pip%s" % (
-00015640: 6469 725f 6e61 6d65 2c20 706f 7374 6669  dir_name, postfi
-00015650: 7829 0a20 2020 2020 2020 2069 6620 6f73  x).        if os
-00015660: 2e70 6174 682e 6578 6973 7473 2870 6970  .path.exists(pip
-00015670: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-00015680: 2020 2020 7265 7475 726e 2070 6970 5f70      return pip_p
-00015690: 6174 680a 2020 2020 2320 4765 6e65 7269  ath.    # Generi
-000156a0: 6320 6661 6c6c 6261 636b 2e0a 2020 2020  c fallback..    
-000156b0: 7069 705f 7061 7468 203d 2077 6869 6368  pip_path = which
-000156c0: 2822 7069 7022 290a 2020 2020 7265 7475  ("pip").    retu
-000156d0: 726e 2070 6970 5f70 6174 680a 0a0a 6465  rn pip_path...de
-000156e0: 6620 7069 705f 696e 7374 616c 6c28 2a70  f pip_install(*p
-000156f0: 6b67 5f6e 616d 6573 293a 0a20 2020 2022  kg_names):.    "
-00015700: 2222 0a20 2020 2049 6e73 7461 6c6c 2070  "".    Install p
-00015710: 6163 6b61 6765 7320 7669 6120 7069 7020  ackages via pip 
-00015720: 666f 7220 7468 6520 6375 7272 656e 7420  for the current 
-00015730: 5079 7468 6f6e 2065 6e76 2e0a 0a20 2020  Python env...   
-00015740: 203a 7061 7261 6d20 7374 7220 706b 675f   :param str pkg_
-00015750: 6e61 6d65 733a 0a20 2020 2022 2222 0a20  names:.    """. 
-00015760: 2020 2070 7920 3d20 7379 732e 6578 6563     py = sys.exec
-00015770: 7574 6162 6c65 0a20 2020 2070 6970 5f70  utable.    pip_p
-00015780: 6174 6820 3d20 7768 6963 685f 7069 7028  ath = which_pip(
-00015790: 290a 2020 2020 7072 696e 7428 2250 6970  ).    print("Pip
-000157a0: 2069 6e73 7461 6c6c 222c 202a 706b 675f   install", *pkg_
-000157b0: 6e61 6d65 7329 0a20 2020 2069 6e5f 7669  names).    in_vi
-000157c0: 7274 7561 6c5f 656e 7620 3d20 6861 7361  rtual_env = hasa
-000157d0: 7474 7228 7379 732c 2022 7265 616c 5f70  ttr(sys, "real_p
-000157e0: 7265 6669 7822 2920 2023 2068 7474 7073  refix")  # https
-000157f0: 3a2f 2f73 7461 636b 6f76 6572 666c 6f77  ://stackoverflow
-00015800: 2e63 6f6d 2f71 7565 7374 696f 6e73 2f31  .com/questions/1
-00015810: 3837 3135 3439 2f0a 2020 2020 636d 6420  871549/.    cmd 
-00015820: 3d20 5b70 792c 2070 6970 5f70 6174 682c  = [py, pip_path,
-00015830: 2022 696e 7374 616c 6c22 5d0a 2020 2020   "install"].    
-00015840: 6966 206e 6f74 2069 6e5f 7669 7274 7561  if not in_virtua
-00015850: 6c5f 656e 763a 0a20 2020 2020 2020 2063  l_env:.        c
-00015860: 6d64 202b 3d20 5b22 2d2d 7573 6572 225d  md += ["--user"]
-00015870: 0a20 2020 2063 6d64 202b 3d20 6c69 7374  .    cmd += list
-00015880: 2870 6b67 5f6e 616d 6573 290a 2020 2020  (pkg_names).    
-00015890: 7072 696e 7428 2224 2025 7322 2025 2022  print("$ %s" % "
-000158a0: 2022 2e6a 6f69 6e28 636d 6429 290a 2020   ".join(cmd)).  
-000158b0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-000158c0: 636b 5f63 616c 6c28 636d 642c 2063 7764  ck_call(cmd, cwd
-000158d0: 3d22 2f22 290a 2020 2020 5f70 6970 5f69  ="/").    _pip_i
-000158e0: 6e73 7461 6c6c 6564 5f70 6163 6b61 6765  nstalled_package
-000158f0: 732e 636c 6561 7228 2920 2023 2066 6f72  s.clear()  # for
-00015900: 6365 2072 656c 6f61 640a 0a0a 5f70 6970  ce reload..._pip
-00015910: 5f69 6e73 7461 6c6c 6564 5f70 6163 6b61  _installed_packa
-00015920: 6765 7320 3d20 7365 7428 290a 0a0a 6465  ges = set()...de
-00015930: 6620 7069 705f 6368 6563 6b5f 6973 5f69  f pip_check_is_i
-00015940: 6e73 7461 6c6c 6564 2870 6b67 5f6e 616d  nstalled(pkg_nam
-00015950: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00015960: 3a70 6172 616d 2073 7472 2070 6b67 5f6e  :param str pkg_n
-00015970: 616d 653a 2077 6974 686f 7574 2076 6572  ame: without ver
-00015980: 7369 6f6e 2c20 652e 672e 206a 7573 7420  sion, e.g. just 
-00015990: 2274 656e 736f 7266 6c6f 7722 2c20 6f72  "tensorflow", or
-000159a0: 2077 6974 6820 7665 7273 696f 6e2c 2065   with version, e
-000159b0: 2e67 2e20 2274 656e 736f 7266 6c6f 773d  .g. "tensorflow=
-000159c0: 3d31 2e32 2e33 220a 2020 2020 3a72 7479  =1.2.3".    :rty
-000159d0: 7065 3a20 626f 6f6c 0a20 2020 2022 2222  pe: bool.    """
-000159e0: 0a20 2020 2069 6620 6e6f 7420 5f70 6970  .    if not _pip
-000159f0: 5f69 6e73 7461 6c6c 6564 5f70 6163 6b61  _installed_packa
-00015a00: 6765 733a 0a20 2020 2020 2020 2070 7920  ges:.        py 
-00015a10: 3d20 7379 732e 6578 6563 7574 6162 6c65  = sys.executable
-00015a20: 0a20 2020 2020 2020 2070 6970 5f70 6174  .        pip_pat
-00015a30: 6820 3d20 7768 6963 685f 7069 7028 290a  h = which_pip().
-00015a40: 2020 2020 2020 2020 636d 6420 3d20 5b70          cmd = [p
-00015a50: 792c 2070 6970 5f70 6174 682c 2022 6672  y, pip_path, "fr
-00015a60: 6565 7a65 225d 0a20 2020 2020 2020 2066  eeze"].        f
-00015a70: 6f72 206c 696e 6520 696e 2073 7973 5f65  or line in sys_e
-00015a80: 7865 635f 6f75 7428 2a63 6d64 292e 7370  xec_out(*cmd).sp
-00015a90: 6c69 746c 696e 6573 2829 3a0a 2020 2020  litlines():.    
-00015aa0: 2020 2020 2020 2020 6966 206c 696e 6520          if line 
-00015ab0: 616e 6420 223d 3d22 2069 6e20 6c69 6e65  and "==" in line
-00015ac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015ad0: 2020 6966 2022 3d3d 2220 6e6f 7420 696e    if "==" not in
-00015ae0: 2070 6b67 5f6e 616d 653a 0a20 2020 2020   pkg_name:.     
-00015af0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00015b00: 696e 6520 3d20 6c69 6e65 5b3a 206c 696e  ine = line[: lin
-00015b10: 652e 696e 6465 7828 223d 3d22 295d 0a20  e.index("==")]. 
-00015b20: 2020 2020 2020 2020 2020 2020 2020 205f                 _
-00015b30: 7069 705f 696e 7374 616c 6c65 645f 7061  pip_installed_pa
-00015b40: 636b 6167 6573 2e61 6464 286c 696e 6529  ckages.add(line)
-00015b50: 0a20 2020 2072 6574 7572 6e20 706b 675f  .    return pkg_
-00015b60: 6e61 6d65 2069 6e20 5f70 6970 5f69 6e73  name in _pip_ins
-00015b70: 7461 6c6c 6564 5f70 6163 6b61 6765 730a  talled_packages.
-00015b80: 0a0a 5f6f 7269 6769 6e61 6c5f 6578 6563  .._original_exec
-00015b90: 7620 3d20 4e6f 6e65 0a5f 6f72 6967 696e  v = None._origin
-00015ba0: 616c 5f65 7865 6376 6520 3d20 4e6f 6e65  al_execve = None
-00015bb0: 0a5f 6f72 6967 696e 616c 5f65 7865 6376  ._original_execv
-00015bc0: 7065 203d 204e 6f6e 650a 0a0a 6465 6620  pe = None...def 
-00015bd0: 6f76 6572 7772 6974 655f 6f73 5f65 7865  overwrite_os_exe
-00015be0: 6328 7072 6566 6978 5f61 7267 7329 3a0a  c(prefix_args):.
-00015bf0: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
-00015c00: 616d 206c 6973 745b 7374 725d 2070 7265  am list[str] pre
-00015c10: 6669 785f 6172 6773 3a0a 2020 2020 2222  fix_args:.    ""
-00015c20: 220a 2020 2020 676c 6f62 616c 205f 6f72  ".    global _or
-00015c30: 6967 696e 616c 5f65 7865 6376 2c20 5f6f  iginal_execv, _o
-00015c40: 7269 6769 6e61 6c5f 6578 6563 7665 2c20  riginal_execve, 
-00015c50: 5f6f 7269 6769 6e61 6c5f 6578 6563 7670  _original_execvp
-00015c60: 650a 2020 2020 6966 206e 6f74 205f 6f72  e.    if not _or
-00015c70: 6967 696e 616c 5f65 7865 6376 3a0a 2020  iginal_execv:.  
-00015c80: 2020 2020 2020 5f6f 7269 6769 6e61 6c5f        _original_
-00015c90: 6578 6563 7620 3d20 6f73 2e65 7865 6376  execv = os.execv
-00015ca0: 0a20 2020 2069 6620 6e6f 7420 5f6f 7269  .    if not _ori
-00015cb0: 6769 6e61 6c5f 6578 6563 7665 3a0a 2020  ginal_execve:.  
-00015cc0: 2020 2020 2020 5f6f 7269 6769 6e61 6c5f        _original_
-00015cd0: 6578 6563 7665 203d 206f 732e 6578 6563  execve = os.exec
-00015ce0: 7665 0a20 2020 2069 6620 6e6f 7420 5f6f  ve.    if not _o
-00015cf0: 7269 6769 6e61 6c5f 6578 6563 7670 653a  riginal_execvpe:
-00015d00: 0a20 2020 2020 2020 2023 206e 6f69 6e73  .        # noins
-00015d10: 7065 6374 696f 6e20 5079 5072 6f74 6563  pection PyProtec
-00015d20: 7465 644d 656d 6265 722c 5079 556e 7265  tedMember,PyUnre
-00015d30: 736f 6c76 6564 5265 6665 7265 6e63 6573  solvedReferences
-00015d40: 0a20 2020 2020 2020 205f 6f72 6967 696e  .        _origin
-00015d50: 616c 5f65 7865 6376 7065 203d 206f 732e  al_execvpe = os.
-00015d60: 5f65 7865 6376 7065 0a0a 2020 2020 2320  _execvpe..    # 
-00015d70: 6e6f 696e 7370 6563 7469 6f6e 2050 7955  noinspection PyU
-00015d80: 6e75 7365 644c 6f63 616c 0a20 2020 2064  nusedLocal.    d
-00015d90: 6566 2077 7261 7070 6564 5f65 7865 6376  ef wrapped_execv
-00015da0: 7065 2866 696c 652c 2061 7267 732c 2065  pe(file, args, e
-00015db0: 6e76 3d4e 6f6e 6529 3a0a 2020 2020 2020  nv=None):.      
-00015dc0: 2020 2222 220a 2020 2020 2020 2020 3a70    """.        :p
-00015dd0: 6172 616d 2066 696c 653a 0a20 2020 2020  aram file:.     
-00015de0: 2020 203a 7061 7261 6d20 6c69 7374 5b73     :param list[s
-00015df0: 7472 5d7c 7475 706c 655b 7374 725d 2061  tr]|tuple[str] a
-00015e00: 7267 733a 0a20 2020 2020 2020 203a 7061  rgs:.        :pa
-00015e10: 7261 6d20 6469 6374 5b73 7472 5d20 656e  ram dict[str] en
-00015e20: 763a 0a20 2020 2020 2020 2022 2222 0a20  v:.        """. 
-00015e30: 2020 2020 2020 206e 6577 5f61 7267 7320         new_args 
-00015e40: 3d20 7072 6566 6978 5f61 7267 7320 2b20  = prefix_args + 
-00015e50: 5b77 6869 6368 2861 7267 735b 305d 295d  [which(args[0])]
-00015e60: 202b 2061 7267 735b 313a 5d0a 2020 2020   + args[1:].    
-00015e70: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-00015e80: 7269 7465 2822 2420 2573 5c6e 2220 2520  rite("$ %s\n" % 
-00015e90: 2220 222e 6a6f 696e 286e 6577 5f61 7267  " ".join(new_arg
-00015ea0: 7329 290a 2020 2020 2020 2020 7379 732e  s)).        sys.
-00015eb0: 7374 6465 7272 2e66 6c75 7368 2829 0a20  stderr.flush(). 
-00015ec0: 2020 2020 2020 205f 6f72 6967 696e 616c         _original
-00015ed0: 5f65 7865 6376 7065 2866 696c 653d 7072  _execvpe(file=pr
-00015ee0: 6566 6978 5f61 7267 735b 305d 2c20 6172  efix_args[0], ar
-00015ef0: 6773 3d6e 6577 5f61 7267 732c 2065 6e76  gs=new_args, env
-00015f00: 3d65 6e76 290a 0a20 2020 2064 6566 2065  =env)..    def e
-00015f10: 7865 6376 2870 6174 682c 2061 7267 7329  xecv(path, args)
-00015f20: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00015f30: 2020 2020 2020 3a70 6172 616d 2073 7472        :param str
-00015f40: 2070 6174 683a 0a20 2020 2020 2020 203a   path:.        :
-00015f50: 7061 7261 6d20 6c69 7374 5b73 7472 5d7c  param list[str]|
-00015f60: 7475 706c 655b 7374 725d 2061 7267 733a  tuple[str] args:
-00015f70: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00015f80: 2020 2020 2069 6620 6172 6773 5b3a 206c       if args[: l
-00015f90: 656e 2870 7265 6669 785f 6172 6773 295d  en(prefix_args)]
-00015fa0: 203d 3d20 7072 6566 6978 5f61 7267 733a   == prefix_args:
-00015fb0: 0a20 2020 2020 2020 2020 2020 205f 6f72  .            _or
-00015fc0: 6967 696e 616c 5f65 7865 6376 2870 6174  iginal_execv(pat
-00015fd0: 682c 2061 7267 7329 0a20 2020 2020 2020  h, args).       
-00015fe0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00015ff0: 2020 2077 7261 7070 6564 5f65 7865 6376     wrapped_execv
-00016000: 7065 2870 6174 682c 2061 7267 7329 0a0a  pe(path, args)..
-00016010: 2020 2020 6465 6620 6578 6563 7665 2870      def execve(p
-00016020: 6174 682c 2061 7267 732c 2065 6e76 293a  ath, args, env):
-00016030: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00016040: 2020 2020 203a 7061 7261 6d20 7374 7220       :param str 
-00016050: 7061 7468 3a0a 2020 2020 2020 2020 3a70  path:.        :p
-00016060: 6172 616d 206c 6973 745b 7374 725d 7c74  aram list[str]|t
-00016070: 7570 6c65 5b73 7472 5d20 6172 6773 3a0a  uple[str] args:.
-00016080: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-00016090: 6963 745b 7374 725d 2065 6e76 3a0a 2020  ict[str] env:.  
-000160a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000160b0: 2020 6966 2061 7267 735b 3a20 6c65 6e28    if args[: len(
-000160c0: 7072 6566 6978 5f61 7267 7329 5d20 3d3d  prefix_args)] ==
-000160d0: 2070 7265 6669 785f 6172 6773 3a0a 2020   prefix_args:.  
-000160e0: 2020 2020 2020 2020 2020 5f6f 7269 6769            _origi
-000160f0: 6e61 6c5f 6578 6563 7665 2870 6174 682c  nal_execve(path,
-00016100: 2061 7267 732c 2065 6e76 290a 2020 2020   args, env).    
-00016110: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00016120: 2020 2020 2020 7772 6170 7065 645f 6578        wrapped_ex
-00016130: 6563 7670 6528 7061 7468 2c20 6172 6773  ecvpe(path, args
-00016140: 2c20 656e 7629 0a0a 2020 2020 6465 6620  , env)..    def 
-00016150: 6578 6563 6c28 6669 6c65 2c20 2a61 7267  execl(file, *arg
-00016160: 7329 3a0a 2020 2020 2020 2020 2222 2265  s):.        """e
-00016170: 7865 636c 2866 696c 652c 202a 6172 6773  xecl(file, *args
-00016180: 290a 0a20 2020 2020 2020 2045 7865 6375  )..        Execu
-00016190: 7465 2074 6865 2065 7865 6375 7461 626c  te the executabl
-000161a0: 6520 6669 6c65 2077 6974 6820 6172 6775  e file with argu
-000161b0: 6d65 6e74 206c 6973 7420 6172 6773 2c20  ment list args, 
-000161c0: 7265 706c 6163 696e 6720 7468 650a 2020  replacing the.  
-000161d0: 2020 2020 2020 6375 7272 656e 7420 7072        current pr
-000161e0: 6f63 6573 732e 2222 220a 2020 2020 2020  ocess.""".      
-000161f0: 2020 6f73 2e65 7865 6376 2866 696c 652c    os.execv(file,
-00016200: 2061 7267 7329 0a0a 2020 2020 6465 6620   args)..    def 
-00016210: 6578 6563 6c65 2866 696c 652c 202a 6172  execle(file, *ar
-00016220: 6773 293a 0a20 2020 2020 2020 2022 2222  gs):.        """
-00016230: 6578 6563 6c65 2866 696c 652c 202a 6172  execle(file, *ar
-00016240: 6773 2c20 656e 7629 0a0a 2020 2020 2020  gs, env)..      
-00016250: 2020 4578 6563 7574 6520 7468 6520 6578    Execute the ex
-00016260: 6563 7574 6162 6c65 2066 696c 6520 7769  ecutable file wi
-00016270: 7468 2061 7267 756d 656e 7420 6c69 7374  th argument list
-00016280: 2061 7267 7320 616e 640a 2020 2020 2020   args and.      
-00016290: 2020 656e 7669 726f 6e6d 656e 7420 656e    environment en
-000162a0: 762c 2072 6570 6c61 6369 6e67 2074 6865  v, replacing the
-000162b0: 2063 7572 7265 6e74 2070 726f 6365 7373   current process
-000162c0: 2e22 2222 0a20 2020 2020 2020 2065 6e76  .""".        env
-000162d0: 203d 2061 7267 735b 2d31 5d0a 2020 2020   = args[-1].    
-000162e0: 2020 2020 6f73 2e65 7865 6376 6528 6669      os.execve(fi
-000162f0: 6c65 2c20 6172 6773 5b3a 2d31 5d2c 2065  le, args[:-1], e
-00016300: 6e76 290a 0a20 2020 2064 6566 2065 7865  nv)..    def exe
-00016310: 636c 7028 6669 6c65 2c20 2a61 7267 7329  clp(file, *args)
-00016320: 3a0a 2020 2020 2020 2020 2222 2265 7865  :.        """exe
-00016330: 636c 7028 6669 6c65 2c20 2a61 7267 7329  clp(file, *args)
-00016340: 0a0a 2020 2020 2020 2020 4578 6563 7574  ..        Execut
-00016350: 6520 7468 6520 6578 6563 7574 6162 6c65  e the executable
-00016360: 2066 696c 6520 2877 6869 6368 2069 7320   file (which is 
-00016370: 7365 6172 6368 6564 2066 6f72 2061 6c6f  searched for alo
-00016380: 6e67 2024 5041 5448 290a 2020 2020 2020  ng $PATH).      
-00016390: 2020 7769 7468 2061 7267 756d 656e 7420    with argument 
-000163a0: 6c69 7374 2061 7267 732c 2072 6570 6c61  list args, repla
-000163b0: 6369 6e67 2074 6865 2063 7572 7265 6e74  cing the current
-000163c0: 2070 726f 6365 7373 2e22 2222 0a20 2020   process.""".   
-000163d0: 2020 2020 206f 732e 6578 6563 7670 2866       os.execvp(f
-000163e0: 696c 652c 2061 7267 7329 0a0a 2020 2020  ile, args)..    
-000163f0: 6465 6620 6578 6563 6c70 6528 6669 6c65  def execlpe(file
-00016400: 2c20 2a61 7267 7329 3a0a 2020 2020 2020  , *args):.      
-00016410: 2020 2222 2265 7865 636c 7065 2866 696c    """execlpe(fil
-00016420: 652c 202a 6172 6773 2c20 656e 7629 0a0a  e, *args, env)..
-00016430: 2020 2020 2020 2020 4578 6563 7574 6520          Execute 
-00016440: 7468 6520 6578 6563 7574 6162 6c65 2066  the executable f
-00016450: 696c 6520 2877 6869 6368 2069 7320 7365  ile (which is se
-00016460: 6172 6368 6564 2066 6f72 2061 6c6f 6e67  arched for along
-00016470: 2024 5041 5448 290a 2020 2020 2020 2020   $PATH).        
-00016480: 7769 7468 2061 7267 756d 656e 7420 6c69  with argument li
-00016490: 7374 2061 7267 7320 616e 6420 656e 7669  st args and envi
-000164a0: 726f 6e6d 656e 7420 656e 762c 2072 6570  ronment env, rep
-000164b0: 6c61 6369 6e67 2074 6865 2063 7572 7265  lacing the curre
-000164c0: 6e74 0a20 2020 2020 2020 2070 726f 6365  nt.        proce
-000164d0: 7373 2e22 2222 0a20 2020 2020 2020 2065  ss.""".        e
-000164e0: 6e76 203d 2061 7267 735b 2d31 5d0a 2020  nv = args[-1].  
-000164f0: 2020 2020 2020 6f73 2e65 7865 6376 7065        os.execvpe
-00016500: 2866 696c 652c 2061 7267 735b 3a2d 315d  (file, args[:-1]
-00016510: 2c20 656e 7629 0a0a 2020 2020 6465 6620  , env)..    def 
-00016520: 6578 6563 7670 2866 696c 652c 2061 7267  execvp(file, arg
-00016530: 7329 3a0a 2020 2020 2020 2020 2222 2265  s):.        """e
-00016540: 7865 6376 7028 6669 6c65 2c20 6172 6773  xecvp(file, args
-00016550: 290a 0a20 2020 2020 2020 2045 7865 6375  )..        Execu
-00016560: 7465 2074 6865 2065 7865 6375 7461 626c  te the executabl
-00016570: 6520 6669 6c65 2028 7768 6963 6820 6973  e file (which is
-00016580: 2073 6561 7263 6865 6420 666f 7220 616c   searched for al
-00016590: 6f6e 6720 2450 4154 4829 0a20 2020 2020  ong $PATH).     
-000165a0: 2020 2077 6974 6820 6172 6775 6d65 6e74     with argument
-000165b0: 206c 6973 7420 6172 6773 2c20 7265 706c   list args, repl
-000165c0: 6163 696e 6720 7468 6520 6375 7272 656e  acing the curren
-000165d0: 7420 7072 6f63 6573 732e 0a20 2020 2020  t process..     
-000165e0: 2020 2061 7267 7320 6d61 7920 6265 2061     args may be a
-000165f0: 206c 6973 7420 6f72 2074 7570 6c65 206f   list or tuple o
-00016600: 6620 7374 7269 6e67 732e 2222 220a 2020  f strings.""".  
-00016610: 2020 2020 2020 7772 6170 7065 645f 6578        wrapped_ex
-00016620: 6563 7670 6528 6669 6c65 2c20 6172 6773  ecvpe(file, args
-00016630: 290a 0a20 2020 2064 6566 2065 7865 6376  )..    def execv
-00016640: 7065 2866 696c 652c 2061 7267 732c 2065  pe(file, args, e
-00016650: 6e76 293a 0a20 2020 2020 2020 2022 2222  nv):.        """
-00016660: 6578 6563 7670 6528 6669 6c65 2c20 6172  execvpe(file, ar
-00016670: 6773 2c20 656e 7629 0a0a 2020 2020 2020  gs, env)..      
-00016680: 2020 4578 6563 7574 6520 7468 6520 6578    Execute the ex
-00016690: 6563 7574 6162 6c65 2066 696c 6520 2877  ecutable file (w
-000166a0: 6869 6368 2069 7320 7365 6172 6368 6564  hich is searched
-000166b0: 2066 6f72 2061 6c6f 6e67 2024 5041 5448   for along $PATH
-000166c0: 290a 2020 2020 2020 2020 7769 7468 2061  ).        with a
-000166d0: 7267 756d 656e 7420 6c69 7374 2061 7267  rgument list arg
-000166e0: 7320 616e 6420 656e 7669 726f 6e6d 656e  s and environmen
-000166f0: 7420 656e 7620 2c20 7265 706c 6163 696e  t env , replacin
-00016700: 6720 7468 650a 2020 2020 2020 2020 6375  g the.        cu
-00016710: 7272 656e 7420 7072 6f63 6573 732e 0a20  rrent process.. 
-00016720: 2020 2020 2020 2061 7267 7320 6d61 7920         args may 
-00016730: 6265 2061 206c 6973 7420 6f72 2074 7570  be a list or tup
-00016740: 6c65 206f 6620 7374 7269 6e67 732e 2222  le of strings.""
-00016750: 220a 2020 2020 2020 2020 7772 6170 7065  ".        wrappe
-00016760: 645f 6578 6563 7670 6528 6669 6c65 2c20  d_execvpe(file, 
-00016770: 6172 6773 2c20 656e 7629 0a0a 2020 2020  args, env)..    
-00016780: 6f73 2e65 7865 6376 203d 2065 7865 6376  os.execv = execv
-00016790: 0a20 2020 206f 732e 6578 6563 7665 203d  .    os.execve =
-000167a0: 2065 7865 6376 650a 2020 2020 6f73 2e65   execve.    os.e
-000167b0: 7865 636c 203d 2065 7865 636c 0a20 2020  xecl = execl.   
-000167c0: 206f 732e 6578 6563 6c65 203d 2065 7865   os.execle = exe
-000167d0: 636c 650a 2020 2020 6f73 2e65 7865 636c  cle.    os.execl
-000167e0: 7020 3d20 6578 6563 6c70 0a20 2020 206f  p = execlp.    o
-000167f0: 732e 6578 6563 6c70 6520 3d20 6578 6563  s.execlpe = exec
-00016800: 6c70 650a 2020 2020 6f73 2e65 7865 6376  lpe.    os.execv
-00016810: 7020 3d20 6578 6563 7670 0a20 2020 206f  p = execvp.    o
-00016820: 732e 6578 6563 7670 6520 3d20 6578 6563  s.execvpe = exec
-00016830: 7670 650a 2020 2020 6f73 2e5f 6578 6563  vpe.    os._exec
-00016840: 7670 6520 3d20 7772 6170 7065 645f 6578  vpe = wrapped_ex
-00016850: 6563 7670 650a 0a0a 6465 6620 6765 745f  ecvpe...def get_
-00016860: 6c73 625f 7265 6c65 6173 6528 293a 0a20  lsb_release():. 
-00016870: 2020 2022 2222 0a20 2020 203a 7265 7475     """.    :retu
-00016880: 726e 3a20 6060 2f65 7463 2f6c 7362 2d72  rn: ``/etc/lsb-r
-00016890: 656c 6561 7365 6060 2070 6172 7365 6420  elease`` parsed 
-000168a0: 6173 2061 2064 6963 740a 2020 2020 3a72  as a dict.    :r
-000168b0: 7479 7065 3a20 6469 6374 5b73 7472 2c73  type: dict[str,s
-000168c0: 7472 5d0a 2020 2020 2222 220a 2020 2020  tr].    """.    
-000168d0: 6420 3d20 7b7d 0a20 2020 2066 6f72 206c  d = {}.    for l
-000168e0: 696e 6520 696e 206f 7065 6e28 222f 6574  ine in open("/et
-000168f0: 632f 6c73 622d 7265 6c65 6173 6522 292e  c/lsb-release").
-00016900: 7265 6164 2829 2e73 706c 6974 6c69 6e65  read().splitline
-00016910: 7328 293a 0a20 2020 2020 2020 206b 2c20  s():.        k, 
-00016920: 7620 3d20 6c69 6e65 2e73 706c 6974 2822  v = line.split("
-00016930: 3d22 2c20 3129 0a20 2020 2020 2020 2069  =", 1).        i
-00016940: 6620 765b 305d 203d 3d20 765b 2d31 5d20  f v[0] == v[-1] 
-00016950: 3d3d 2027 2227 3a0a 2020 2020 2020 2020  == '"':.        
-00016960: 2020 2020 7620 3d20 765b 313a 2d31 5d0a      v = v[1:-1].
-00016970: 2020 2020 2020 2020 645b 6b5d 203d 2076          d[k] = v
-00016980: 0a20 2020 2072 6574 7572 6e20 640a 0a0a  .    return d...
-00016990: 6465 6620 6765 745f 7562 756e 7475 5f6d  def get_ubuntu_m
-000169a0: 616a 6f72 5f76 6572 7369 6f6e 2829 3a0a  ajor_version():.
-000169b0: 2020 2020 2222 220a 2020 2020 3a72 7479      """.    :rty
-000169c0: 7065 3a20 696e 747c 4e6f 6e65 0a20 2020  pe: int|None.   
-000169d0: 2022 2222 0a20 2020 2064 203d 2067 6574   """.    d = get
-000169e0: 5f6c 7362 5f72 656c 6561 7365 2829 0a20  _lsb_release(). 
-000169f0: 2020 2069 6620 645b 2244 4953 5452 4942     if d["DISTRIB
-00016a00: 5f49 4422 5d20 213d 2022 5562 756e 7475  _ID"] != "Ubuntu
-00016a10: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
-00016a20: 6e20 4e6f 6e65 0a20 2020 2072 6574 7572  n None.    retur
-00016a30: 6e20 696e 7428 666c 6f61 7428 645b 2244  n int(float(d["D
-00016a40: 4953 5452 4942 5f52 454c 4541 5345 225d  ISTRIB_RELEASE"]
-00016a50: 2929 0a0a 0a64 6566 2061 7574 6f5f 7072  ))...def auto_pr
-00016a60: 6566 6978 5f6f 735f 6578 6563 5f70 7265  efix_os_exec_pre
-00016a70: 6669 785f 7562 756e 7475 2870 7265 6669  fix_ubuntu(prefi
-00016a80: 785f 6172 6773 2c20 7562 756e 7475 5f6d  x_args, ubuntu_m
-00016a90: 696e 5f76 6572 7369 6f6e 3d31 3629 3a0a  in_version=16):.
-00016aa0: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
-00016ab0: 616d 206c 6973 745b 7374 725d 2070 7265  am list[str] pre
-00016ac0: 6669 785f 6172 6773 3a0a 2020 2020 3a70  fix_args:.    :p
-00016ad0: 6172 616d 2069 6e74 2075 6275 6e74 755f  aram int ubuntu_
-00016ae0: 6d69 6e5f 7665 7273 696f 6e3a 0a0a 2020  min_version:..  
-00016af0: 2020 4578 616d 706c 6520 7573 6167 653a    Example usage:
-00016b00: 0a20 2020 2020 2061 7574 6f5f 7072 6566  .      auto_pref
-00016b10: 6978 5f6f 735f 6578 6563 5f70 7265 6669  ix_os_exec_prefi
-00016b20: 785f 7562 756e 7475 285b 222f 752f 7a65  x_ubuntu(["/u/ze
-00016b30: 7965 722f 746f 6f6c 732f 676c 6962 6332  yer/tools/glibc2
-00016b40: 3137 2f6c 642d 6c69 6e75 782d 7838 362d  17/ld-linux-x86-
-00016b50: 3634 2e73 6f2e 3222 5d29 0a20 2020 2022  64.so.2"]).    "
-00016b60: 2222 0a20 2020 2075 6275 6e74 755f 7665  "".    ubuntu_ve
-00016b70: 7273 696f 6e20 3d20 6765 745f 7562 756e  rsion = get_ubun
-00016b80: 7475 5f6d 616a 6f72 5f76 6572 7369 6f6e  tu_major_version
-00016b90: 2829 0a20 2020 2069 6620 7562 756e 7475  ().    if ubuntu
-00016ba0: 5f76 6572 7369 6f6e 2069 7320 4e6f 6e65  _version is None
-00016bb0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00016bc0: 0a20 2020 2069 6620 7562 756e 7475 5f76  .    if ubuntu_v
-00016bd0: 6572 7369 6f6e 203e 3d20 7562 756e 7475  ersion >= ubuntu
-00016be0: 5f6d 696e 5f76 6572 7369 6f6e 3a0a 2020  _min_version:.  
-00016bf0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00016c00: 2070 7269 6e74 2822 596f 7520 6172 6520   print("You are 
-00016c10: 7275 6e6e 696e 6720 5562 756e 7475 2025  running Ubuntu %
-00016c20: 692c 2074 6875 7320 7765 2070 7265 6669  i, thus we prefi
-00016c30: 7820 616c 6c20 6f73 2e65 7865 6320 7769  x all os.exec wi
-00016c40: 7468 2025 732e 2220 2520 2875 6275 6e74  th %s." % (ubunt
-00016c50: 755f 7665 7273 696f 6e2c 2070 7265 6669  u_version, prefi
-00016c60: 785f 6172 6773 2929 0a20 2020 2061 7373  x_args)).    ass
-00016c70: 6572 7420 6f73 2e70 6174 682e 6578 6973  ert os.path.exis
-00016c80: 7473 2870 7265 6669 785f 6172 6773 5b30  ts(prefix_args[0
-00016c90: 5d29 0a20 2020 206f 7665 7277 7269 7465  ]).    overwrite
-00016ca0: 5f6f 735f 6578 6563 2870 7265 6669 785f  _os_exec(prefix_
-00016cb0: 6172 6773 3d70 7265 6669 785f 6172 6773  args=prefix_args
-00016cc0: 290a 0a0a 6465 6620 636c 6561 6e75 705f  )...def cleanup_
-00016cd0: 656e 765f 7661 725f 7061 7468 2865 6e76  env_var_path(env
-00016ce0: 5f76 6172 2c20 7061 7468 5f70 7265 6669  _var, path_prefi
-00016cf0: 7829 3a0a 2020 2020 2222 220a 2020 2020  x):.    """.    
-00016d00: 3a70 6172 616d 2073 7472 2065 6e76 5f76  :param str env_v
-00016d10: 6172 3a20 652e 672e 2022 4c44 5f4c 4942  ar: e.g. "LD_LIB
-00016d20: 5241 5259 5f50 4154 4822 0a20 2020 203a  RARY_PATH".    :
-00016d30: 7061 7261 6d20 7374 7220 7061 7468 5f70  param str path_p
-00016d40: 7265 6669 783a 0a0a 2020 2020 5769 6c6c  refix:..    Will
-00016d50: 2072 656d 6f76 6520 616c 6c20 7061 7468   remove all path
-00016d60: 7320 696e 206f 732e 656e 7669 726f 6e5b  s in os.environ[
-00016d70: 656e 765f 7661 725d 2077 6869 6368 2061  env_var] which a
-00016d80: 7265 2070 7265 6669 7865 6420 7769 7468  re prefixed with
-00016d90: 2070 6174 685f 7072 6566 6978 2e0a 2020   path_prefix..  
-00016da0: 2020 2222 220a 2020 2020 6966 2065 6e76    """.    if env
-00016db0: 5f76 6172 206e 6f74 2069 6e20 6f73 2e65  _var not in os.e
-00016dc0: 6e76 6972 6f6e 3a0a 2020 2020 2020 2020  nviron:.        
-00016dd0: 7265 7475 726e 0a20 2020 2070 7320 3d20  return.    ps = 
-00016de0: 6f73 2e65 6e76 6972 6f6e 5b65 6e76 5f76  os.environ[env_v
-00016df0: 6172 5d2e 7370 6c69 7428 223a 2229 0a0a  ar].split(":")..
-00016e00: 2020 2020 6465 6620 6628 7029 3a0a 2020      def f(p):.  
-00016e10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00016e20: 2020 3a70 6172 616d 2073 7472 2070 3a0a    :param str p:.
-00016e30: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
-00016e40: 626f 6f6c 0a20 2020 2020 2020 2022 2222  bool.        """
-00016e50: 0a20 2020 2020 2020 2069 6620 7020 3d3d  .        if p ==
-00016e60: 2070 6174 685f 7072 6566 6978 206f 7220   path_prefix or 
-00016e70: 702e 7374 6172 7473 7769 7468 2870 6174  p.startswith(pat
-00016e80: 685f 7072 6566 6978 202b 2022 2f22 293a  h_prefix + "/"):
-00016e90: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00016ea0: 6e74 2822 5265 6d6f 7669 6e67 2025 7320  nt("Removing %s 
-00016eb0: 6672 6f6d 2025 732e 2220 2520 2870 2c20  from %s." % (p, 
-00016ec0: 656e 765f 7661 7229 290a 2020 2020 2020  env_var)).      
-00016ed0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-00016ee0: 7365 0a20 2020 2020 2020 2072 6574 7572  se.        retur
-00016ef0: 6e20 5472 7565 0a0a 2020 2020 7073 203d  n True..    ps =
-00016f00: 2066 696c 7465 7228 662c 2070 7329 0a20   filter(f, ps). 
-00016f10: 2020 206f 732e 656e 7669 726f 6e5b 656e     os.environ[en
-00016f20: 765f 7661 725d 203d 2022 3a22 2e6a 6f69  v_var] = ":".joi
-00016f30: 6e28 7073 290a 0a0a 6465 6620 6765 745f  n(ps)...def get_
-00016f40: 6c6f 6769 6e5f 7573 6572 6e61 6d65 2829  login_username()
-00016f50: 3a0a 2020 2020 2222 220a 2020 2020 3a72  :.    """.    :r
-00016f60: 7479 7065 3a20 7374 720a 2020 2020 3a72  type: str.    :r
-00016f70: 6574 7572 6e3a 2074 6865 2075 7365 726e  eturn: the usern
-00016f80: 616d 6520 6f66 2074 6865 2063 7572 7265  ame of the curre
-00016f90: 6e74 2075 7365 722e 0a20 2020 2055 7365  nt user..    Use
-00016fa0: 2074 6869 7320 6173 2061 2072 6570 6c61   this as a repla
-00016fb0: 6365 6d65 6e74 2066 6f72 206f 732e 6765  cement for os.ge
-00016fc0: 746c 6f67 696e 2829 2e0a 2020 2020 2222  tlogin()..    ""
-00016fd0: 220a 2020 2020 696d 706f 7274 206f 730a  ".    import os.
-00016fe0: 0a20 2020 2069 6620 7379 732e 706c 6174  .    if sys.plat
-00016ff0: 666f 726d 203d 3d20 2277 696e 3332 223a  form == "win32":
-00017000: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00017010: 6f73 2e67 6574 6c6f 6769 6e28 290a 2020  os.getlogin().  
-00017020: 2020 696d 706f 7274 2070 7764 0a0a 2020    import pwd..  
-00017030: 2020 7472 793a 0a20 2020 2020 2020 2072    try:.        r
-00017040: 6574 7572 6e20 7077 642e 6765 7470 7775  eturn pwd.getpwu
-00017050: 6964 286f 732e 6765 7475 6964 2829 295b  id(os.getuid())[
-00017060: 305d 0a20 2020 2065 7863 6570 7420 4b65  0].    except Ke
-00017070: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-00017080: 2320 7077 642e 6765 7470 7775 6964 2829  # pwd.getpwuid()
-00017090: 2063 616e 2074 6872 6f77 204b 6579 4572   can throw KeyEr
-000170a0: 726f 723a 2027 6765 7470 7775 6964 2829  ror: 'getpwuid()
-000170b0: 3a20 7569 6420 6e6f 7420 666f 756e 643a  : uid not found:
-000170c0: 2031 3233 3435 270a 2020 2020 2020 2020   12345'.        
-000170d0: 2320 7468 6973 2063 616e 2068 6170 7065  # this can happe
-000170e0: 6e20 652e 672e 2069 6e20 6120 646f 636b  n e.g. in a dock
-000170f0: 6572 2065 6e76 6972 6f6e 6d65 6e74 2077  er environment w
-00017100: 6974 6820 6d61 7070 6564 2075 6964 7320  ith mapped uids 
-00017110: 756e 6b6e 6f77 6e20 746f 2074 6865 2064  unknown to the d
-00017120: 6f63 6b65 7220 4f53 0a20 2020 2020 2020  ocker OS.       
-00017130: 2072 6574 7572 6e20 7374 7228 6f73 2e67   return str(os.g
-00017140: 6574 7569 6428 2929 0a0a 0a64 6566 2067  etuid())...def g
-00017150: 6574 5f74 656d 705f 6469 7228 293a 0a20  et_temp_dir():. 
-00017160: 2020 2022 2222 0a20 2020 203a 7274 7970     """.    :rtyp
-00017170: 653a 2073 7472 0a20 2020 203a 7265 7475  e: str.    :retu
-00017180: 726e 3a20 652e 672e 2022 2f74 6d70 2f24  rn: e.g. "/tmp/$
-00017190: 5553 4552 4e41 4d45 220a 2020 2020 2222  USERNAME".    ""
-000171a0: 220a 2020 2020 7573 6572 6e61 6d65 203d  ".    username =
-000171b0: 2067 6574 5f6c 6f67 696e 5f75 7365 726e   get_login_usern
-000171c0: 616d 6528 290a 2020 2020 666f 7220 656e  ame().    for en
-000171d0: 766e 616d 6520 696e 205b 2254 4d50 4449  vname in ["TMPDI
-000171e0: 5222 2c20 2254 454d 5022 2c20 2254 4d50  R", "TEMP", "TMP
-000171f0: 225d 3a0a 2020 2020 2020 2020 6469 726e  "]:.        dirn
-00017200: 616d 6520 3d20 6f73 2e67 6574 656e 7628  ame = os.getenv(
-00017210: 656e 766e 616d 6529 0a20 2020 2020 2020  envname).       
-00017220: 2069 6620 6469 726e 616d 653a 0a20 2020   if dirname:.   
-00017230: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00017240: 2225 732f 2573 2220 2520 2864 6972 6e61  "%s/%s" % (dirna
-00017250: 6d65 2c20 7573 6572 6e61 6d65 290a 2020  me, username).  
-00017260: 2020 2320 2f76 6172 2f74 6d70 2073 686f    # /var/tmp sho
-00017270: 756c 6420 6265 206d 6f72 6520 7065 7273  uld be more pers
-00017280: 6973 7465 6e74 2074 6861 6e20 2f74 6d70  istent than /tmp
-00017290: 2075 7375 616c 6c79 2e0a 2020 2020 6966   usually..    if
-000172a0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-000172b0: 222f 7661 722f 746d 7022 293a 0a20 2020  "/var/tmp"):.   
-000172c0: 2020 2020 2072 6574 7572 6e20 222f 7661       return "/va
-000172d0: 722f 746d 702f 2573 2220 2520 7573 6572  r/tmp/%s" % user
-000172e0: 6e61 6d65 0a20 2020 2072 6574 7572 6e20  name.    return 
-000172f0: 222f 746d 702f 2573 2220 2520 7573 6572  "/tmp/%s" % user
-00017300: 6e61 6d65 0a0a 0a64 6566 2067 6574 5f63  name...def get_c
-00017310: 6163 6865 5f64 6972 2829 3a0a 2020 2020  ache_dir():.    
-00017320: 2222 220a 2020 2020 3a72 6574 7572 6e3a  """.    :return:
-00017330: 2075 7365 6420 746f 2063 6163 6865 206e   used to cache n
-00017340: 6f6e 2d63 7269 7469 6361 6c20 7468 696e  on-critical thin
-00017350: 6773 2e20 6279 2064 6566 6175 6c74 2067  gs. by default g
-00017360: 6574 5f74 656d 705f 6469 722e 2075 6e6c  et_temp_dir. unl
-00017370: 6573 7320 796f 7520 6465 6669 6e65 2065  ess you define e
-00017380: 6e76 2052 4554 5552 4e4e 5f43 4143 4845  nv RETURNN_CACHE
-00017390: 5f44 4952 0a20 2020 203a 7274 7970 653a  _DIR.    :rtype:
-000173a0: 2073 7472 0a20 2020 2022 2222 0a20 2020   str.    """.   
-000173b0: 2069 6620 2252 4554 5552 4e4e 5f43 4143   if "RETURNN_CAC
-000173c0: 4845 5f44 4952 2220 696e 206f 732e 656e  HE_DIR" in os.en
-000173d0: 7669 726f 6e3a 0a20 2020 2020 2020 2072  viron:.        r
-000173e0: 6574 7572 6e20 6f73 2e65 6e76 6972 6f6e  eturn os.environ
-000173f0: 5b22 5245 5455 524e 4e5f 4341 4348 455f  ["RETURNN_CACHE_
-00017400: 4449 5222 5d0a 2020 2020 7265 7475 726e  DIR"].    return
-00017410: 2067 6574 5f74 656d 705f 6469 7228 290a   get_temp_dir().
-00017420: 0a0a 636c 6173 7320 4c6f 636b 4669 6c65  ..class LockFile
-00017430: 286f 626a 6563 7429 3a0a 2020 2020 2222  (object):.    ""
-00017440: 220a 2020 2020 5369 6d70 6c65 206c 6f63  ".    Simple loc
-00017450: 6b20 6669 6c65 2e0a 2020 2020 2222 220a  k file..    """.
-00017460: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00017470: 5f28 7365 6c66 2c20 6469 7265 6374 6f72  _(self, director
-00017480: 792c 206e 616d 653d 226c 6f63 6b5f 6669  y, name="lock_fi
-00017490: 6c65 222c 206c 6f63 6b5f 7469 6d65 6f75  le", lock_timeou
-000174a0: 743d 3120 2a20 3630 202a 2036 3029 3a0a  t=1 * 60 * 60):.
-000174b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000174c0: 2020 2020 3a70 6172 616d 2073 7472 2064      :param str d
-000174d0: 6972 6563 746f 7279 3a0a 2020 2020 2020  irectory:.      
-000174e0: 2020 3a70 6172 616d 2069 6e74 7c66 6c6f    :param int|flo
-000174f0: 6174 206c 6f63 6b5f 7469 6d65 6f75 743a  at lock_timeout:
-00017500: 2069 6e20 7365 636f 6e64 730a 2020 2020   in seconds.    
-00017510: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00017520: 7365 6c66 2e64 6972 6563 746f 7279 203d  self.directory =
-00017530: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
-00017540: 2020 2073 656c 662e 6e61 6d65 203d 206e     self.name = n
-00017550: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
-00017560: 2e66 6420 3d20 4e6f 6e65 0a20 2020 2020  .fd = None.     
-00017570: 2020 2073 656c 662e 6c6f 636b 5f74 696d     self.lock_tim
-00017580: 656f 7574 203d 206c 6f63 6b5f 7469 6d65  eout = lock_time
-00017590: 6f75 740a 2020 2020 2020 2020 7365 6c66  out.        self
-000175a0: 2e6c 6f63 6b66 696c 6520 3d20 2225 732f  .lockfile = "%s/
-000175b0: 2573 2220 2520 2864 6972 6563 746f 7279  %s" % (directory
-000175c0: 2c20 6e61 6d65 290a 0a20 2020 2064 6566  , name)..    def
-000175d0: 2069 735f 6f6c 645f 6c6f 636b 6669 6c65   is_old_lockfile
-000175e0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000175f0: 2222 220a 2020 2020 2020 2020 3a72 6574  """.        :ret
-00017600: 7572 6e3a 2057 6865 7468 6572 2074 6865  urn: Whether the
-00017610: 7265 2069 7320 616e 2065 7869 7374 696e  re is an existin
-00017620: 6720 6c6f 636b 2066 696c 6520 616e 6420  g lock file and 
-00017630: 7468 6520 6578 6973 7469 6e67 206c 6f63  the existing loc
-00017640: 6b20 6669 6c65 2069 7320 6f6c 642e 0a20  k file is old.. 
-00017650: 2020 2020 2020 203a 7274 7970 653a 2062         :rtype: b
-00017660: 6f6f 6c0a 2020 2020 2020 2020 2222 220a  ool.        """.
-00017670: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00017680: 2020 2020 2020 2020 206d 7469 6d65 203d           mtime =
-00017690: 206f 732e 7061 7468 2e67 6574 6d74 696d   os.path.getmtim
-000176a0: 6528 7365 6c66 2e6c 6f63 6b66 696c 6529  e(self.lockfile)
-000176b0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-000176c0: 4f53 4572 726f 723a 0a20 2020 2020 2020  OSError:.       
-000176d0: 2020 2020 206d 7469 6d65 203d 204e 6f6e       mtime = Non
-000176e0: 650a 2020 2020 2020 2020 6966 206d 7469  e.        if mti
-000176f0: 6d65 2061 6e64 2028 6162 7328 7469 6d65  me and (abs(time
-00017700: 2e74 696d 6528 2920 2d20 6d74 696d 6529  .time() - mtime)
-00017710: 203e 2073 656c 662e 6c6f 636b 5f74 696d   > self.lock_tim
-00017720: 656f 7574 293a 0a20 2020 2020 2020 2020  eout):.         
-00017730: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
-00017740: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
-00017750: 6c73 650a 0a20 2020 2064 6566 206d 6179  lse..    def may
-00017760: 6265 5f72 656d 6f76 655f 6f6c 645f 6c6f  be_remove_old_lo
-00017770: 636b 6669 6c65 2873 656c 6629 3a0a 2020  ckfile(self):.  
-00017780: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00017790: 2020 5265 6d6f 7665 7320 616e 2065 7869    Removes an exi
-000177a0: 7374 696e 6720 6f6c 6420 6c6f 636b 6669  sting old lockfi
-000177b0: 6c65 2c20 6966 2074 6865 7265 2069 7320  le, if there is 
-000177c0: 6f6e 652e 0a20 2020 2020 2020 2022 2222  one..        """
-000177d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000177e0: 7365 6c66 2e69 735f 6f6c 645f 6c6f 636b  self.is_old_lock
-000177f0: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
-00017800: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-00017810: 2020 2070 7269 6e74 2822 5265 6d6f 7669     print("Removi
-00017820: 6e67 206f 6c64 206c 6f63 6b66 696c 6520  ng old lockfile 
-00017830: 2572 2028 7072 6f62 6162 6c79 2063 7261  %r (probably cra
-00017840: 7368 6564 2070 726f 6329 2e22 2025 2073  shed proc)." % s
-00017850: 656c 662e 6c6f 636b 6669 6c65 290a 2020  elf.lockfile).  
-00017860: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00017870: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
-00017880: 2873 656c 662e 6c6f 636b 6669 6c65 290a  (self.lockfile).
-00017890: 2020 2020 2020 2020 6578 6365 7074 204f          except O
-000178a0: 5345 7272 6f72 2061 7320 6578 633a 0a20  SError as exc:. 
-000178b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000178c0: 2822 5265 6d6f 7665 206c 6f63 6b66 696c  ("Remove lockfil
-000178d0: 6520 6578 6365 7074 696f 6e20 2572 2e20  e exception %r. 
-000178e0: 4967 6e6f 7269 6e67 2069 742e 2220 2520  Ignoring it." % 
-000178f0: 6578 6329 0a0a 2020 2020 6465 6620 6973  exc)..    def is
-00017900: 5f6c 6f63 6b65 6428 7365 6c66 293a 0a20  _locked(self):. 
-00017910: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00017920: 2020 203a 7265 7475 726e 3a20 7768 6574     :return: whet
-00017930: 6865 7220 7468 6572 6520 6973 2061 6e20  her there is an 
-00017940: 6163 7469 7665 2028 6e6f 7420 6f6c 6429  active (not old)
-00017950: 206c 6f63 6b66 696c 650a 2020 2020 2020   lockfile.      
-00017960: 2020 3a72 7479 7065 3a20 626f 6f6c 0a20    :rtype: bool. 
-00017970: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00017980: 2020 2069 6620 7365 6c66 2e69 735f 6f6c     if self.is_ol
-00017990: 645f 6c6f 636b 6669 6c65 2829 3a0a 2020  d_lockfile():.  
-000179a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000179b0: 2046 616c 7365 0a20 2020 2020 2020 2074   False.        t
-000179c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000179d0: 7265 7475 726e 206f 732e 7061 7468 2e65  return os.path.e
-000179e0: 7869 7374 7328 7365 6c66 2e6c 6f63 6b66  xists(self.lockf
-000179f0: 696c 6529 0a20 2020 2020 2020 2065 7863  ile).        exc
-00017a00: 6570 7420 4f53 4572 726f 723a 0a20 2020  ept OSError:.   
-00017a10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00017a20: 4661 6c73 650a 0a20 2020 2064 6566 206c  False..    def l
-00017a30: 6f63 6b28 7365 6c66 293a 0a20 2020 2020  ock(self):.     
-00017a40: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
-00017a50: 6371 7569 7265 7320 7468 6520 6c6f 636b  cquires the lock
-00017a60: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00017a70: 2020 2020 2020 696d 706f 7274 2074 696d        import tim
-00017a80: 650a 2020 2020 2020 2020 696d 706f 7274  e.        import
-00017a90: 2065 7272 6e6f 0a0a 2020 2020 2020 2020   errno..        
-00017aa0: 7761 6974 5f63 6f75 6e74 203d 2030 0a20  wait_count = 0. 
-00017ab0: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
-00017ac0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00017ad0: 2054 7279 2074 6f20 6372 6561 7465 2064   Try to create d
-00017ae0: 6972 6563 746f 7279 2069 6620 6974 2064  irectory if it d
-00017af0: 6f65 7320 6e6f 7420 6578 6973 742e 0a20  oes not exist.. 
-00017b00: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00017b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b20: 6f73 2e6d 616b 6564 6972 7328 7365 6c66  os.makedirs(self
-00017b30: 2e64 6972 6563 746f 7279 290a 2020 2020  .directory).    
-00017b40: 2020 2020 2020 2020 6578 6365 7074 204f          except O
-00017b50: 5345 7272 6f72 2061 7320 6578 633a 0a20  SError as exc:. 
-00017b60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00017b70: 2050 6f73 7369 626c 6520 6572 726f 7273   Possible errors
-00017b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017b90: 2020 2320 454e 4f45 4e54 2028 4e6f 2073    # ENOENT (No s
-00017ba0: 7563 6820 6669 6c65 206f 7220 6469 7265  uch file or dire
-00017bb0: 6374 6f72 7929 2c20 652e 672e 2069 6620  ctory), e.g. if 
-00017bc0: 736f 6d65 2070 6172 656e 7420 6469 7265  some parent dire
-00017bd0: 6374 6f72 7920 7761 7320 6465 6c65 7465  ctory was delete
-00017be0: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-00017bf0: 2020 2023 2045 4558 4953 5420 2846 696c     # EEXIST (Fil
-00017c00: 6520 6578 6973 7473 292c 2069 6620 7468  e exists), if th
-00017c10: 6520 6469 7220 616c 7265 6164 7920 6578  e dir already ex
-00017c20: 6973 7473 2e0a 2020 2020 2020 2020 2020  ists..          
-00017c30: 2020 2020 2020 6966 2065 7863 2e65 7272        if exc.err
-00017c40: 6e6f 206e 6f74 2069 6e20 5b65 7272 6e6f  no not in [errno
-00017c50: 2e45 4e4f 454e 542c 2065 7272 6e6f 2e45  .ENOENT, errno.E
-00017c60: 4558 4953 545d 3a0a 2020 2020 2020 2020  EXIST]:.        
-00017c70: 2020 2020 2020 2020 2020 2020 2320 4f74              # Ot
-00017c80: 6865 7220 6572 726f 722c 2073 6f20 7265  her error, so re
-00017c90: 7261 6973 652e 0a20 2020 2020 2020 2020  raise..         
-00017ca0: 2020 2020 2020 2020 2020 2023 2043 6f6d             # Com
-00017cb0: 6d6f 6e20 6f6e 6573 2061 7265 2065 2e67  mon ones are e.g
-00017cc0: 2e3a 0a20 2020 2020 2020 2020 2020 2020  .:.             
-00017cd0: 2020 2020 2020 2023 2045 4e4f 5350 4320         # ENOSPC 
-00017ce0: 284e 6f20 7370 6163 6520 6c65 6674 206f  (No space left o
-00017cf0: 6e20 6465 7669 6365 290a 2020 2020 2020  n device).      
-00017d00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017d10: 4541 4343 4553 2028 5065 726d 6973 7369  EACCES (Permissi
-00017d20: 6f6e 2064 656e 6965 6429 0a20 2020 2020  on denied).     
-00017d30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00017d40: 6169 7365 0a20 2020 2020 2020 2020 2020  aise.           
-00017d50: 2020 2020 2023 2049 676e 6f72 6520 7468       # Ignore th
-00017d60: 6f73 6520 6572 726f 7273 2e0a 2020 2020  ose errors..    
-00017d70: 2020 2020 2020 2020 2320 4e6f 7720 7472          # Now tr
-00017d80: 7920 746f 2063 7265 6174 6520 7468 6520  y to create the 
-00017d90: 6c6f 636b 2e0a 2020 2020 2020 2020 2020  lock..          
-00017da0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00017db0: 2020 2020 2020 2073 656c 662e 6664 203d         self.fd =
-00017dc0: 206f 732e 6f70 656e 2873 656c 662e 6c6f   os.open(self.lo
-00017dd0: 636b 6669 6c65 2c20 6f73 2e4f 5f43 5245  ckfile, os.O_CRE
-00017de0: 4154 207c 206f 732e 4f5f 4558 434c 207c  AT | os.O_EXCL |
-00017df0: 206f 732e 4f5f 5244 5752 290a 2020 2020   os.O_RDWR).    
-00017e00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017e10: 726e 0a20 2020 2020 2020 2020 2020 2065  rn.            e
-00017e20: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-00017e30: 2065 7863 3a0a 2020 2020 2020 2020 2020   exc:.          
-00017e40: 2020 2020 2020 2320 506f 7373 6962 6c65        # Possible
-00017e50: 2065 7272 6f72 733a 0a20 2020 2020 2020   errors:.       
-00017e60: 2020 2020 2020 2020 2023 2045 4e4f 454e           # ENOEN
-00017e70: 5420 284e 6f20 7375 6368 2066 696c 6520  T (No such file 
-00017e80: 6f72 2064 6972 6563 746f 7279 292c 2065  or directory), e
-00017e90: 2e67 2e20 6966 2074 6865 2064 6972 6563  .g. if the direc
-00017ea0: 746f 7279 2077 6173 2064 656c 6574 6564  tory was deleted
-00017eb0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00017ec0: 2020 2320 4545 5849 5354 2028 4669 6c65    # EEXIST (File
-00017ed0: 2065 7869 7374 7329 2c20 6966 2074 6865   exists), if the
-00017ee0: 206c 6f63 6b20 616c 7265 6164 7920 6578   lock already ex
-00017ef0: 6973 7473 2e0a 2020 2020 2020 2020 2020  ists..          
-00017f00: 2020 2020 2020 6966 2065 7863 2e65 7272        if exc.err
-00017f10: 6e6f 206e 6f74 2069 6e20 5b65 7272 6e6f  no not in [errno
-00017f20: 2e45 4e4f 454e 542c 2065 7272 6e6f 2e45  .ENOENT, errno.E
-00017f30: 4558 4953 545d 3a0a 2020 2020 2020 2020  EXIST]:.        
-00017f40: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00017f50: 6520 2023 204f 7468 6572 2065 7272 6f72  e  # Other error
-00017f60: 2c20 736f 2072 6572 6169 7365 2e0a 2020  , so reraise..  
-00017f70: 2020 2020 2020 2020 2020 2320 5765 2064            # We d
-00017f80: 6964 206e 6f74 2067 6574 2074 6865 206c  id not get the l
-00017f90: 6f63 6b2e 0a20 2020 2020 2020 2020 2020  ock..           
-00017fa0: 2023 2043 6865 636b 2069 6620 6974 2069   # Check if it i
-00017fb0: 7320 6120 7265 616c 6c79 206f 6c64 206f  s a really old o
-00017fc0: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
-00017fd0: 7365 6c66 2e6d 6179 6265 5f72 656d 6f76  self.maybe_remov
-00017fe0: 655f 6f6c 645f 6c6f 636b 6669 6c65 2829  e_old_lockfile()
-00017ff0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-00018000: 6169 7420 6120 6269 742c 2061 6e64 2074  ait a bit, and t
-00018010: 6865 6e20 7265 7472 792e 0a20 2020 2020  hen retry..     
-00018020: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-00018030: 7028 3129 0a20 2020 2020 2020 2020 2020  p(1).           
-00018040: 2077 6169 745f 636f 756e 7420 2b3d 2031   wait_count += 1
-00018050: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00018060: 7761 6974 5f63 6f75 6e74 203d 3d20 3130  wait_count == 10
-00018070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018080: 2020 7072 696e 7428 2257 6169 7469 6e67    print("Waiting
-00018090: 2066 6f72 206c 6f63 6b2d 6669 6c65 3a20   for lock-file: 
-000180a0: 2573 2220 2520 7365 6c66 2e6c 6f63 6b66  %s" % self.lockf
-000180b0: 696c 6529 0a0a 2020 2020 6465 6620 756e  ile)..    def un
-000180c0: 6c6f 636b 2873 656c 6629 3a0a 2020 2020  lock(self):.    
-000180d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000180e0: 5265 6c65 6173 6573 2074 6865 206c 6f63  Releases the loc
-000180f0: 6b2e 0a20 2020 2020 2020 2022 2222 0a20  k..        """. 
-00018100: 2020 2020 2020 206f 732e 636c 6f73 6528         os.close(
-00018110: 7365 6c66 2e66 6429 0a20 2020 2020 2020  self.fd).       
-00018120: 206f 732e 7265 6d6f 7665 2873 656c 662e   os.remove(self.
-00018130: 6c6f 636b 6669 6c65 290a 0a20 2020 2064  lockfile)..    d
-00018140: 6566 205f 5f65 6e74 6572 5f5f 2873 656c  ef __enter__(sel
-00018150: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
-00018160: 2e6c 6f63 6b28 290a 0a20 2020 2064 6566  .lock()..    def
-00018170: 205f 5f65 7869 745f 5f28 7365 6c66 2c20   __exit__(self, 
-00018180: 6578 635f 7479 7065 2c20 6578 635f 7661  exc_type, exc_va
-00018190: 6c2c 2065 7863 5f74 6229 3a0a 2020 2020  l, exc_tb):.    
-000181a0: 2020 2020 7365 6c66 2e75 6e6c 6f63 6b28      self.unlock(
-000181b0: 290a 0a0a 6465 6620 7374 725f 6973 5f6e  )...def str_is_n
-000181c0: 756d 6265 7228 7329 3a0a 2020 2020 2222  umber(s):.    ""
-000181d0: 220a 2020 2020 3a70 6172 616d 2073 7472  ".    :param str
-000181e0: 2073 3a20 652e 672e 2022 3122 2c20 222e   s: e.g. "1", ".
-000181f0: 3322 206f 7220 2278 220a 2020 2020 3a72  3" or "x".    :r
-00018200: 6574 7572 6e3a 2077 6865 7468 6572 2073  eturn: whether s
-00018210: 2063 616e 2062 6520 6361 7374 6564 2074   can be casted t
-00018220: 6f20 666c 6f61 7420 6f72 2069 6e74 0a20  o float or int. 
-00018230: 2020 203a 7274 7970 653a 2062 6f6f 6c0a     :rtype: bool.
-00018240: 2020 2020 2222 220a 2020 2020 7472 793a      """.    try:
-00018250: 0a20 2020 2020 2020 2066 6c6f 6174 2873  .        float(s
-00018260: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00018270: 2054 7275 650a 2020 2020 6578 6365 7074   True.    except
-00018280: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
-00018290: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-000182a0: 650a 0a0a 6465 6620 736f 7274 6564 5f76  e...def sorted_v
-000182b0: 616c 7565 735f 6672 6f6d 5f64 6963 7428  alues_from_dict(
-000182c0: 6429 3a0a 2020 2020 2222 220a 2020 2020  d):.    """.    
-000182d0: 3a70 6172 616d 2064 6963 745b 542c 565d  :param dict[T,V]
-000182e0: 2064 3a0a 2020 2020 3a72 7479 7065 3a20   d:.    :rtype: 
-000182f0: 6c69 7374 5b56 5d0a 2020 2020 2222 220a  list[V].    """.
-00018300: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00018310: 7461 6e63 6528 642c 2064 6963 7429 0a20  tance(d, dict). 
-00018320: 2020 2072 6574 7572 6e20 5b76 2066 6f72     return [v for
-00018330: 2028 6b2c 2076 2920 696e 2073 6f72 7465   (k, v) in sorte
-00018340: 6428 642e 6974 656d 7328 2929 5d0a 0a0a  d(d.items())]...
-00018350: 6465 6620 6469 6374 5f7a 6970 286b 6579  def dict_zip(key
-00018360: 732c 2076 616c 7565 7329 3a0a 2020 2020  s, values):.    
-00018370: 2222 220a 2020 2020 3a70 6172 616d 206c  """.    :param l
-00018380: 6973 745b 545d 206b 6579 733a 0a20 2020  ist[T] keys:.   
-00018390: 203a 7061 7261 6d20 6c69 7374 5b56 5d20   :param list[V] 
-000183a0: 7661 6c75 6573 3a0a 2020 2020 3a72 7479  values:.    :rty
-000183b0: 7065 3a20 6469 6374 5b54 2c56 5d0a 2020  pe: dict[T,V].  
-000183c0: 2020 2222 220a 2020 2020 6173 7365 7274    """.    assert
-000183d0: 206c 656e 286b 6579 7329 203d 3d20 6c65   len(keys) == le
-000183e0: 6e28 7661 6c75 6573 290a 2020 2020 7265  n(values).    re
-000183f0: 7475 726e 2064 6963 7428 7a69 7028 6b65  turn dict(zip(ke
-00018400: 7973 2c20 7661 6c75 6573 2929 0a0a 0a64  ys, values))...d
-00018410: 6566 2070 6172 7365 5f6c 645f 636f 6e66  ef parse_ld_conf
-00018420: 5f66 696c 6528 666e 293a 0a20 2020 2022  _file(fn):.    "
-00018430: 2222 0a20 2020 2056 6961 2068 7474 7073  "".    Via https
-00018440: 3a2f 2f67 6974 6875 622e 636f 6d2f 616c  ://github.com/al
-00018450: 6265 7274 7a2f 7379 7374 656d 2d74 6f6f  bertz/system-too
-00018460: 6c73 2f62 6c6f 622f 6d61 7374 6572 2f62  ls/blob/master/b
-00018470: 696e 2f66 696e 642d 6c69 622d 696e 2d70  in/find-lib-in-p
-00018480: 6174 682e 7079 2e0a 0a20 2020 203a 7061  ath.py...    :pa
-00018490: 7261 6d20 7374 7220 666e 3a20 652e 672e  ram str fn: e.g.
-000184a0: 2022 2f65 7463 2f6c 642e 736f 2e63 6f6e   "/etc/ld.so.con
-000184b0: 6622 0a20 2020 203a 7265 7475 726e 3a20  f".    :return: 
-000184c0: 6c69 7374 206f 6620 7061 7468 7320 666f  list of paths fo
-000184d0: 7220 6c69 6273 0a20 2020 203a 7274 7970  r libs.    :rtyp
-000184e0: 653a 206c 6973 745b 7374 725d 0a20 2020  e: list[str].   
-000184f0: 2022 2222 0a20 2020 2066 726f 6d20 676c   """.    from gl
-00018500: 6f62 2069 6d70 6f72 7420 676c 6f62 0a0a  ob import glob..
-00018510: 2020 2020 7061 7468 7320 3d20 5b5d 0a20      paths = []. 
-00018520: 2020 2066 6f72 206c 696e 6520 696e 206f     for line in o
-00018530: 7065 6e28 666e 292e 7265 6164 2829 2e73  pen(fn).read().s
-00018540: 706c 6974 6c69 6e65 7328 293a 0a20 2020  plitlines():.   
-00018550: 2020 2020 206c 696e 6520 3d20 6c69 6e65       line = line
-00018560: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
-00018570: 2069 6620 6e6f 7420 6c69 6e65 3a0a 2020   if not line:.  
-00018580: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00018590: 7565 0a20 2020 2020 2020 2069 6620 6c69  ue.        if li
-000185a0: 6e65 2e73 7461 7274 7377 6974 6828 2223  ne.startswith("#
-000185b0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-000185c0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-000185d0: 2069 6620 6c69 6e65 2e73 7461 7274 7377   if line.startsw
-000185e0: 6974 6828 2269 6e63 6c75 6465 2022 293a  ith("include "):
-000185f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00018600: 2073 7562 5f66 6e20 696e 2067 6c6f 6228   sub_fn in glob(
-00018610: 6c69 6e65 5b6c 656e 2822 696e 636c 7564  line[len("includ
-00018620: 6520 2229 203a 5d29 3a0a 2020 2020 2020  e ") :]):.      
-00018630: 2020 2020 2020 2020 2020 7061 7468 732e            paths.
-00018640: 6578 7465 6e64 2870 6172 7365 5f6c 645f  extend(parse_ld_
-00018650: 636f 6e66 5f66 696c 6528 7375 625f 666e  conf_file(sub_fn
-00018660: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
-00018670: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00018680: 7061 7468 732e 6170 7065 6e64 286c 696e  paths.append(lin
-00018690: 6529 0a20 2020 2072 6574 7572 6e20 7061  e).    return pa
-000186a0: 7468 730a 0a0a 6465 6620 6765 745f 6c64  ths...def get_ld
-000186b0: 5f70 6174 6873 2829 3a0a 2020 2020 2222  _paths():.    ""
-000186c0: 220a 2020 2020 546f 2062 6520 7665 7279  ".    To be very
-000186d0: 2063 6f72 7265 6374 2c20 7365 6520 6d61   correct, see ma
-000186e0: 6e2d 7061 6765 206f 6620 6c64 2e73 6f2e  n-page of ld.so.
-000186f0: 0a20 2020 2041 6e64 2068 6572 653a 2068  .    And here: h
-00018700: 7474 7073 3a2f 2f75 6e69 782e 7374 6163  ttps://unix.stac
-00018710: 6b65 7863 6861 6e67 652e 636f 6d2f 7175  kexchange.com/qu
-00018720: 6573 7469 6f6e 732f 3335 3432 3935 2f77  estions/354295/w
-00018730: 6861 742d 6973 2d74 6865 2d64 6566 6175  hat-is-the-defau
-00018740: 6c74 2d76 616c 7565 2d6f 662d 6c64 2d6c  lt-value-of-ld-l
-00018750: 6962 7261 7279 2d70 6174 682f 3335 3432  ibrary-path/3542
-00018760: 3936 0a20 2020 2053 686f 7274 2076 6572  96.    Short ver
-00018770: 7369 6f6e 2c20 6e6f 7420 7370 6563 6966  sion, not specif
-00018780: 6963 2074 6f20 616e 2065 7865 6375 7461  ic to an executa
-00018790: 626c 652c 2069 6e20 7468 6973 206f 7264  ble, in this ord
-000187a0: 6572 3a0a 2020 2020 2d20 4c44 5f4c 4942  er:.    - LD_LIB
-000187b0: 5241 5259 5f50 4154 480a 2020 2020 2d20  RARY_PATH.    - 
-000187c0: 2f65 7463 2f6c 642e 736f 2e63 6163 6865  /etc/ld.so.cache
-000187d0: 2028 696e 7374 6561 6420 7765 2077 696c   (instead we wil
-000187e0: 6c20 7061 7273 6520 2f65 7463 2f6c 642e  l parse /etc/ld.
-000187f0: 736f 2e63 6f6e 6629 0a20 2020 202d 202f  so.conf).    - /
-00018800: 6c69 622c 202f 7573 722f 6c69 6220 286f  lib, /usr/lib (o
-00018810: 7220 6d61 7962 6520 2f6c 6962 3634 2c20  r maybe /lib64, 
-00018820: 2f75 7372 2f6c 6962 3634 290a 2020 2020  /usr/lib64).    
-00018830: 5669 6120 6874 7470 733a 2f2f 6769 7468  Via https://gith
-00018840: 7562 2e63 6f6d 2f61 6c62 6572 747a 2f73  ub.com/albertz/s
-00018850: 7973 7465 6d2d 746f 6f6c 732f 626c 6f62  ystem-tools/blob
-00018860: 2f6d 6173 7465 722f 6269 6e2f 6669 6e64  /master/bin/find
-00018870: 2d6c 6962 2d69 6e2d 7061 7468 2e70 792e  -lib-in-path.py.
-00018880: 0a0a 2020 2020 3a72 7479 7065 3a20 6c69  ..    :rtype: li
-00018890: 7374 5b73 7472 5d0a 2020 2020 3a72 6574  st[str].    :ret
-000188a0: 7572 6e3a 206c 6973 7420 6f66 2070 6174  urn: list of pat
-000188b0: 6873 2074 6f20 7365 6172 6368 2066 6f72  hs to search for
-000188c0: 206c 6962 7320 282a 2e73 6f20 6669 6c65   libs (*.so file
-000188d0: 7329 0a20 2020 2022 2222 0a20 2020 2070  s).    """.    p
-000188e0: 6174 6873 203d 205b 5d0a 2020 2020 6966  aths = [].    if
-000188f0: 2022 4c44 5f4c 4942 5241 5259 5f50 4154   "LD_LIBRARY_PAT
-00018900: 4822 2069 6e20 6f73 2e65 6e76 6972 6f6e  H" in os.environ
-00018910: 3a0a 2020 2020 2020 2020 7061 7468 732e  :.        paths.
-00018920: 6578 7465 6e64 286f 732e 656e 7669 726f  extend(os.enviro
-00018930: 6e5b 224c 445f 4c49 4252 4152 595f 5041  n["LD_LIBRARY_PA
-00018940: 5448 225d 2e73 706c 6974 2822 3a22 2929  TH"].split(":"))
-00018950: 0a20 2020 2069 6620 6f73 2e70 6174 682e  .    if os.path.
-00018960: 6578 6973 7473 2822 2f65 7463 2f6c 642e  exists("/etc/ld.
-00018970: 736f 2e63 6f6e 6622 293a 0a20 2020 2020  so.conf"):.     
-00018980: 2020 2070 6174 6873 2e65 7874 656e 6428     paths.extend(
-00018990: 7061 7273 655f 6c64 5f63 6f6e 665f 6669  parse_ld_conf_fi
-000189a0: 6c65 2822 2f65 7463 2f6c 642e 736f 2e63  le("/etc/ld.so.c
-000189b0: 6f6e 6622 2929 0a20 2020 2070 6174 6873  onf")).    paths
-000189c0: 2e65 7874 656e 6428 5b22 2f6c 6962 222c  .extend(["/lib",
-000189d0: 2022 2f75 7372 2f6c 6962 222c 2022 2f6c   "/usr/lib", "/l
-000189e0: 6962 3634 222c 2022 2f75 7372 2f6c 6962  ib64", "/usr/lib
-000189f0: 3634 225d 290a 2020 2020 7265 7475 726e  64"]).    return
-00018a00: 2070 6174 6873 0a0a 0a64 6566 2066 696e   paths...def fin
-00018a10: 645f 6c69 6228 6c69 625f 6e61 6d65 293a  d_lib(lib_name):
-00018a20: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
-00018a30: 7261 6d20 7374 7220 6c69 625f 6e61 6d65  ram str lib_name
-00018a40: 3a20 7769 7468 6f75 7420 706f 7374 6669  : without postfi
-00018a50: 782f 7072 6566 6978 2c20 652e 672e 2022  x/prefix, e.g. "
-00018a60: 6375 6461 7274 2220 6f72 2022 626c 6173  cudart" or "blas
-00018a70: 220a 2020 2020 3a72 6574 7572 6e3a 2072  ".    :return: r
-00018a80: 6574 7572 6e73 2066 756c 6c20 7061 7468  eturns full path
-00018a90: 2074 6f20 6c69 6220 6f72 204e 6f6e 650a   to lib or None.
-00018aa0: 2020 2020 3a72 7479 7065 3a20 7374 727c      :rtype: str|
-00018ab0: 4e6f 6e65 0a20 2020 2022 2222 0a20 2020  None.    """.   
-00018ac0: 2069 6620 7379 732e 706c 6174 666f 726d   if sys.platform
-00018ad0: 203d 3d20 2264 6172 7769 6e22 3a0a 2020   == "darwin":.  
-00018ae0: 2020 2020 2020 7072 6566 6978 203d 2022        prefix = "
-00018af0: 6c69 6222 0a20 2020 2020 2020 2070 6f73  lib".        pos
-00018b00: 7466 6978 203d 2022 2e64 796c 6962 220a  tfix = ".dylib".
-00018b10: 2020 2020 656c 6966 2073 7973 2e70 6c61      elif sys.pla
-00018b20: 7466 6f72 6d20 3d3d 2022 7769 6e33 3222  tform == "win32"
-00018b30: 3a0a 2020 2020 2020 2020 7072 6566 6978  :.        prefix
-00018b40: 203d 2022 220a 2020 2020 2020 2020 706f   = "".        po
-00018b50: 7374 6669 7820 3d20 222e 646c 6c22 0a20  stfix = ".dll". 
-00018b60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00018b70: 2070 7265 6669 7820 3d20 226c 6962 220a   prefix = "lib".
-00018b80: 2020 2020 2020 2020 706f 7374 6669 7820          postfix 
-00018b90: 3d20 222e 736f 220a 2020 2020 666f 7220  = ".so".    for 
-00018ba0: 7061 7468 2069 6e20 6765 745f 6c64 5f70  path in get_ld_p
-00018bb0: 6174 6873 2829 3a0a 2020 2020 2020 2020  aths():.        
-00018bc0: 666e 203d 2022 2573 2f25 7325 7325 7322  fn = "%s/%s%s%s"
-00018bd0: 2025 2028 7061 7468 2c20 7072 6566 6978   % (path, prefix
-00018be0: 2c20 6c69 625f 6e61 6d65 2c20 706f 7374  , lib_name, post
-00018bf0: 6669 7829 0a20 2020 2020 2020 2069 6620  fix).        if 
-00018c00: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
-00018c10: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
-00018c20: 7265 7475 726e 2066 6e0a 2020 2020 7265  return fn.    re
-00018c30: 7475 726e 204e 6f6e 650a 0a0a 6465 6620  turn None...def 
-00018c40: 7265 6164 5f73 6765 5f6e 756d 5f70 726f  read_sge_num_pro
-00018c50: 6373 286a 6f62 5f69 643d 4e6f 6e65 293a  cs(job_id=None):
-00018c60: 0a20 2020 2022 2222 0a20 2020 2046 726f  .    """.    Fro
-00018c70: 6d20 7468 6520 5375 6e20 4772 6964 2045  m the Sun Grid E
-00018c80: 6e67 696e 6520 2853 4745 292c 2072 6561  ngine (SGE), rea
-00018c90: 6473 2074 6865 206e 756d 5f70 726f 6320  ds the num_proc 
-00018ca0: 7365 7474 696e 6720 666f 7220 6120 7061  setting for a pa
-00018cb0: 7274 6963 756c 6172 206a 6f62 2e0a 2020  rticular job..  
-00018cc0: 2020 4966 206a 6f62 5f69 6420 6973 206e    If job_id is n
-00018cd0: 6f74 2070 726f 7669 6465 6420 616e 6420  ot provided and 
-00018ce0: 7468 6520 4a4f 425f 4944 2065 6e76 2069  the JOB_ID env i
-00018cf0: 7320 7365 742c 2069 7420 7769 6c6c 2075  s set, it will u
-00018d00: 7365 2074 6861 7420 696e 7374 6561 6420  se that instead 
-00018d10: 2869 2e65 2e20 6974 2075 7365 7320 7468  (i.e. it uses th
-00018d20: 6520 6375 7272 656e 7420 6a6f 6229 2e0a  e current job)..
-00018d30: 2020 2020 5468 6973 2063 616c 6c73 2071      This calls q
-00018d40: 7374 6174 2074 6f20 6669 6775 7265 206f  stat to figure o
-00018d50: 7574 2074 6869 7320 7365 7474 696e 672e  ut this setting.
-00018d60: 2054 6865 7265 2061 7265 206d 756c 7469   There are multi
-00018d70: 706c 6520 7761 7973 2074 6869 7320 6361  ple ways this ca
-00018d80: 6e20 676f 2077 726f 6e67 2c0a 2020 2020  n go wrong,.    
-00018d90: 736f 2062 6574 7465 7220 6361 7463 6820  so better catch 
-00018da0: 616e 7920 6578 6365 7074 696f 6e2e 0a0a  any exception...
-00018db0: 2020 2020 3a70 6172 616d 2069 6e74 7c4e      :param int|N
-00018dc0: 6f6e 6520 6a6f 625f 6964 3a0a 2020 2020  one job_id:.    
-00018dd0: 3a72 6574 7572 6e3a 206e 756d 5f70 726f  :return: num_pro
-00018de0: 630a 2020 2020 3a72 7479 7065 3a20 696e  c.    :rtype: in
-00018df0: 747c 4e6f 6e65 0a20 2020 2022 2222 0a20  t|None.    """. 
-00018e00: 2020 2069 6620 6e6f 7420 6a6f 625f 6964     if not job_id
-00018e10: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00018e20: 206f 732e 656e 7669 726f 6e2e 6765 7428   os.environ.get(
-00018e30: 2253 4745 5f52 4f4f 5422 293a 0a20 2020  "SGE_ROOT"):.   
-00018e40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00018e50: 4e6f 6e65 0a20 2020 2020 2020 2074 7279  None.        try
-00018e60: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00018e70: 7169 6e74 2e70 7920 6d69 6768 7420 6f76  qint.py might ov
-00018e80: 6572 7772 6974 6520 4a4f 425f 4944 2062  erwrite JOB_ID b
-00018e90: 7574 2073 6574 7320 5347 455f 4a4f 425f  ut sets SGE_JOB_
-00018ea0: 4944 2069 6e73 7465 6164 2e0a 2020 2020  ID instead..    
-00018eb0: 2020 2020 2020 2020 6a6f 625f 6964 203d          job_id =
-00018ec0: 2069 6e74 286f 732e 656e 7669 726f 6e2e   int(os.environ.
-00018ed0: 6765 7428 2253 4745 5f4a 4f42 5f49 4422  get("SGE_JOB_ID"
-00018ee0: 2920 6f72 206f 732e 656e 7669 726f 6e2e  ) or os.environ.
-00018ef0: 6765 7428 224a 4f42 5f49 4422 2920 6f72  get("JOB_ID") or
-00018f00: 2030 290a 2020 2020 2020 2020 6578 6365   0).        exce
-00018f10: 7074 2056 616c 7565 4572 726f 7220 6173  pt ValueError as
-00018f20: 2065 7863 3a0a 2020 2020 2020 2020 2020   exc:.          
-00018f30: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00018f40: 6e28 2272 6561 645f 7367 655f 6e75 6d5f  n("read_sge_num_
-00018f50: 7072 6f63 733a 2025 722c 2069 6e76 616c  procs: %r, inval
-00018f60: 6964 204a 4f42 5f49 443a 2025 7222 2025  id JOB_ID: %r" %
-00018f70: 2028 6578 632c 206f 732e 656e 7669 726f   (exc, os.enviro
-00018f80: 6e2e 6765 7428 224a 4f42 5f49 4422 2929  n.get("JOB_ID"))
-00018f90: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00018fa0: 206a 6f62 5f69 643a 0a20 2020 2020 2020   job_id:.       
-00018fb0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00018fc0: 0a20 2020 2066 726f 6d20 7375 6270 726f  .    from subpro
-00018fd0: 6365 7373 2069 6d70 6f72 7420 506f 7065  cess import Pope
-00018fe0: 6e2c 2050 4950 452c 2043 616c 6c65 6450  n, PIPE, CalledP
-00018ff0: 726f 6365 7373 4572 726f 720a 0a20 2020  rocessError..   
-00019000: 2073 6765 5f63 6d64 203d 205b 2271 7374   sge_cmd = ["qst
-00019010: 6174 222c 2022 2d6a 222c 2073 7472 286a  at", "-j", str(j
-00019020: 6f62 5f69 6429 5d0a 2020 2020 7072 6f63  ob_id)].    proc
-00019030: 203d 2050 6f70 656e 2873 6765 5f63 6d64   = Popen(sge_cmd
-00019040: 2c20 7374 646f 7574 3d50 4950 4529 0a20  , stdout=PIPE). 
-00019050: 2020 2073 7464 6f75 742c 205f 203d 2070     stdout, _ = p
-00019060: 726f 632e 636f 6d6d 756e 6963 6174 6528  roc.communicate(
-00019070: 290a 2020 2020 6966 2070 726f 632e 7265  ).    if proc.re
-00019080: 7475 726e 636f 6465 3a0a 2020 2020 2020  turncode:.      
-00019090: 2020 7261 6973 6520 4361 6c6c 6564 5072    raise CalledPr
-000190a0: 6f63 6573 7345 7272 6f72 2870 726f 632e  ocessError(proc.
-000190b0: 7265 7475 726e 636f 6465 2c20 7367 655f  returncode, sge_
-000190c0: 636d 642c 2073 7464 6f75 7429 0a20 2020  cmd, stdout).   
-000190d0: 2073 7464 6f75 7420 3d20 7374 646f 7574   stdout = stdout
-000190e0: 2e64 6563 6f64 6528 2275 7466 3822 290a  .decode("utf8").
-000190f0: 2020 2020 6c73 203d 205b 0a20 2020 2020      ls = [.     
-00019100: 2020 206c 696e 655b 6c65 6e28 2268 6172     line[len("har
-00019110: 6420 7265 736f 7572 6365 5f6c 6973 743a  d resource_list:
-00019120: 2229 203a 5d2e 7374 7269 7028 290a 2020  ") :].strip().  
-00019130: 2020 2020 2020 666f 7220 6c69 6e65 2069        for line i
-00019140: 6e20 7374 646f 7574 2e73 706c 6974 6c69  n stdout.splitli
-00019150: 6e65 7328 290a 2020 2020 2020 2020 6966  nes().        if
-00019160: 206c 696e 652e 7374 6172 7473 7769 7468   line.startswith
-00019170: 2822 6861 7264 2072 6573 6f75 7263 655f  ("hard resource_
-00019180: 6c69 7374 3a22 290a 2020 2020 5d0a 2020  list:").    ].  
-00019190: 2020 6173 7365 7274 206c 656e 286c 7329    assert len(ls)
-000191a0: 203d 3d20 310a 2020 2020 6f70 7473 203d   == 1.    opts =
-000191b0: 2064 6963 7428 5b6f 7074 2e73 706c 6974   dict([opt.split
-000191c0: 2822 3d22 2c20 3129 2066 6f72 206f 7074  ("=", 1) for opt
-000191d0: 2069 6e20 6c73 5b30 5d2e 7370 6c69 7428   in ls[0].split(
-000191e0: 222c 2229 5d29 2020 2320 6e6f 7161 0a20  ",")])  # noqa. 
-000191f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00019200: 7265 7475 726e 2069 6e74 286f 7074 735b  return int(opts[
-00019210: 226e 756d 5f70 726f 6322 5d29 0a20 2020  "num_proc"]).   
-00019220: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
-00019230: 6f72 2061 7320 6578 633a 0a20 2020 2020  or as exc:.     
-00019240: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00019250: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-00019260: 2272 6561 645f 7367 655f 6e75 6d5f 7072  "read_sge_num_pr
-00019270: 6f63 733a 2025 722c 2069 6e76 616c 6964  ocs: %r, invalid
-00019280: 206e 756d 5f70 726f 6320 2572 2066 6f72   num_proc %r for
-00019290: 206a 6f62 2069 6420 2569 2e5c 6e6c 696e   job id %i.\nlin
-000192a0: 653a 2025 7222 0a20 2020 2020 2020 2020  e: %r".         
-000192b0: 2020 2025 2028 6578 632c 206f 7074 735b     % (exc, opts[
-000192c0: 226e 756d 5f70 726f 6322 5d2c 206a 6f62  "num_proc"], job
-000192d0: 5f69 642c 206c 735b 305d 290a 2020 2020  _id, ls[0]).    
-000192e0: 2020 2020 290a 0a0a 6465 6620 6765 745f      )...def get_
-000192f0: 6e75 6d62 6572 5f61 7661 696c 6162 6c65  number_available
-00019300: 5f63 7075 7328 293a 0a20 2020 2022 2222  _cpus():.    """
-00019310: 0a20 2020 203a 7265 7475 726e 3a20 6e75  .    :return: nu
-00019320: 6d62 6572 206f 6620 6176 6169 6c61 626c  mber of availabl
-00019330: 6520 4350 5573 2c20 6966 2077 6520 6361  e CPUs, if we ca
-00019340: 6e20 6669 6775 7265 2069 7420 6f75 740a  n figure it out.
-00019350: 2020 2020 3a72 7479 7065 3a20 696e 747c      :rtype: int|
-00019360: 4e6f 6e65 0a20 2020 2022 2222 0a20 2020  None.    """.   
-00019370: 2069 6620 6861 7361 7474 7228 6f73 2c20   if hasattr(os, 
-00019380: 2273 6368 6564 5f67 6574 6166 6669 6e69  "sched_getaffini
-00019390: 7479 2229 3a20 2023 2050 7974 686f 6e20  ty"):  # Python 
-000193a0: 3e3d 332e 340a 2020 2020 2020 2020 7265  >=3.4.        re
-000193b0: 7475 726e 206c 656e 286f 732e 7363 6865  turn len(os.sche
-000193c0: 645f 6765 7461 6666 696e 6974 7928 3029  d_getaffinity(0)
-000193d0: 290a 2020 2020 7472 793a 0a20 2020 2020  ).    try:.     
-000193e0: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
-000193f0: 6e20 5079 5061 636b 6167 6552 6571 7569  n PyPackageRequi
-00019400: 7265 6d65 6e74 732c 5079 556e 7265 736f  rements,PyUnreso
-00019410: 6c76 6564 5265 6665 7265 6e63 6573 0a20  lvedReferences. 
-00019420: 2020 2020 2020 2069 6d70 6f72 7420 7073         import ps
-00019430: 7574 696c 0a0a 2020 2020 2020 2020 7072  util..        pr
-00019440: 6f63 203d 2070 7375 7469 6c2e 5072 6f63  oc = psutil.Proc
-00019450: 6573 7328 290a 2020 2020 2020 2020 6966  ess().        if
-00019460: 2068 6173 6174 7472 2870 726f 632c 2022   hasattr(proc, "
-00019470: 6370 755f 6166 6669 6e69 7479 2229 3a0a  cpu_affinity"):.
-00019480: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00019490: 726e 206c 656e 2870 726f 632e 6370 755f  rn len(proc.cpu_
-000194a0: 6166 6669 6e69 7479 2829 290a 2020 2020  affinity()).    
-000194b0: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
-000194c0: 6f72 3a0a 2020 2020 2020 2020 7061 7373  or:.        pass
-000194d0: 0a20 2020 2069 6620 6861 7361 7474 7228  .    if hasattr(
-000194e0: 6f73 2c20 2273 7973 636f 6e66 2229 2061  os, "sysconf") a
-000194f0: 6e64 2022 5343 5f4e 5052 4f43 4553 534f  nd "SC_NPROCESSO
-00019500: 5253 5f4f 4e4c 4e22 2069 6e20 6f73 2e73  RS_ONLN" in os.s
-00019510: 7973 636f 6e66 5f6e 616d 6573 3a0a 2020  ysconf_names:.  
-00019520: 2020 2020 2020 7265 7475 726e 206f 732e        return os.
-00019530: 7379 7363 6f6e 6628 2253 435f 4e50 524f  sysconf("SC_NPRO
-00019540: 4345 5353 4f52 535f 4f4e 4c4e 2229 0a20  CESSORS_ONLN"). 
-00019550: 2020 2069 6620 6861 7361 7474 7228 6f73     if hasattr(os
-00019560: 2c20 2263 7075 5f63 6f75 6e74 2229 3a20  , "cpu_count"): 
-00019570: 2023 2050 7974 686f 6e20 3e3d 332e 340a   # Python >=3.4.
-00019580: 2020 2020 2020 2020 7265 7475 726e 206f          return o
-00019590: 732e 6370 755f 636f 756e 7428 2920 2023  s.cpu_count()  #
-000195a0: 206e 6f74 2071 7569 7465 2063 6f72 7265   not quite corre
-000195b0: 6374 3b20 7468 6174 2061 7265 2061 6c6c  ct; that are all
-000195c0: 2069 6e20 7468 6520 7379 7374 656d 0a20   in the system. 
-000195d0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-000195e0: 0a64 6566 2067 7565 7373 5f72 6571 7565  .def guess_reque
-000195f0: 7374 6564 5f6d 6178 5f6e 756d 5f74 6872  sted_max_num_thr
-00019600: 6561 6473 286c 6f67 5f66 696c 653d 4e6f  eads(log_file=No
-00019610: 6e65 2c20 6661 6c6c 6261 636b 5f6e 756d  ne, fallback_num
-00019620: 5f63 7075 733d 5472 7565 293a 0a20 2020  _cpus=True):.   
-00019630: 2022 2222 0a20 2020 203a 7061 7261 6d20   """.    :param 
-00019640: 696f 2e46 696c 6520 6c6f 675f 6669 6c65  io.File log_file
-00019650: 3a0a 2020 2020 3a70 6172 616d 2062 6f6f  :.    :param boo
-00019660: 6c20 6661 6c6c 6261 636b 5f6e 756d 5f63  l fallback_num_c
-00019670: 7075 733a 0a20 2020 203a 7274 7970 653a  pus:.    :rtype:
-00019680: 2069 6e74 7c4e 6f6e 650a 2020 2020 2222   int|None.    ""
-00019690: 220a 2020 2020 7472 793a 0a20 2020 2020  ".    try:.     
-000196a0: 2020 2073 6765 5f6e 756d 5f70 726f 6373     sge_num_procs
-000196b0: 203d 2072 6561 645f 7367 655f 6e75 6d5f   = read_sge_num_
-000196c0: 7072 6f63 7328 290a 2020 2020 6578 6365  procs().    exce
-000196d0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-000196e0: 6578 633a 0a20 2020 2020 2020 2069 6620  exc:.        if 
-000196f0: 6c6f 675f 6669 6c65 3a0a 2020 2020 2020  log_file:.      
-00019700: 2020 2020 2020 7072 696e 7428 2245 7272        print("Err
-00019710: 6f72 2077 6869 6c65 2067 6574 7469 6e67  or while getting
-00019720: 2053 4745 206e 756d 5f70 726f 633a 2025   SGE num_proc: %
-00019730: 7222 2025 2065 7863 2c20 6669 6c65 3d6c  r" % exc, file=l
-00019740: 6f67 5f66 696c 6529 0a20 2020 2065 6c73  og_file).    els
-00019750: 653a 0a20 2020 2020 2020 2069 6620 7367  e:.        if sg
-00019760: 655f 6e75 6d5f 7072 6f63 733a 0a20 2020  e_num_procs:.   
-00019770: 2020 2020 2020 2020 2069 6620 6c6f 675f           if log_
-00019780: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-00019790: 2020 2020 2020 7072 696e 7428 2255 7365        print("Use
-000197a0: 206e 756d 5f74 6872 6561 6473 3d25 6920   num_threads=%i 
-000197b0: 2862 7574 206d 696e 2032 2920 7669 6120  (but min 2) via 
-000197c0: 5347 4520 6e75 6d5f 7072 6f63 2e22 2025  SGE num_proc." %
-000197d0: 2073 6765 5f6e 756d 5f70 726f 6373 2c20   sge_num_procs, 
-000197e0: 6669 6c65 3d6c 6f67 5f66 696c 6529 0a20  file=log_file). 
-000197f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00019800: 6e20 6d61 7828 7367 655f 6e75 6d5f 7072  n max(sge_num_pr
-00019810: 6f63 732c 2032 290a 2020 2020 6f6d 705f  ocs, 2).    omp_
-00019820: 6e75 6d5f 7468 7265 6164 7320 3d20 696e  num_threads = in
-00019830: 7428 6f73 2e65 6e76 6972 6f6e 2e67 6574  t(os.environ.get
-00019840: 2822 4f4d 505f 4e55 4d5f 5448 5245 4144  ("OMP_NUM_THREAD
-00019850: 5322 2920 6f72 2030 290a 2020 2020 6966  S") or 0).    if
-00019860: 206f 6d70 5f6e 756d 5f74 6872 6561 6473   omp_num_threads
-00019870: 3a0a 2020 2020 2020 2020 2320 4d69 6e69  :.        # Mini
-00019880: 6d75 6d20 6f66 2032 2074 6872 6561 6473  mum of 2 threads
-00019890: 2c20 7368 6f75 6c64 206e 6f74 2068 7572  , should not hur
-000198a0: 742e 0a20 2020 2020 2020 2069 6620 6c6f  t..        if lo
-000198b0: 675f 6669 6c65 3a0a 2020 2020 2020 2020  g_file:.        
-000198c0: 2020 2020 7072 696e 7428 2255 7365 206e      print("Use n
-000198d0: 756d 5f74 6872 6561 6473 3d25 6920 2862  um_threads=%i (b
-000198e0: 7574 206d 696e 2032 2920 7669 6120 4f4d  ut min 2) via OM
-000198f0: 505f 4e55 4d5f 5448 5245 4144 532e 2220  P_NUM_THREADS." 
-00019900: 2520 6f6d 705f 6e75 6d5f 7468 7265 6164  % omp_num_thread
-00019910: 732c 2066 696c 653d 6c6f 675f 6669 6c65  s, file=log_file
-00019920: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00019930: 206d 6178 286f 6d70 5f6e 756d 5f74 6872   max(omp_num_thr
-00019940: 6561 6473 2c20 3229 0a20 2020 2069 6620  eads, 2).    if 
-00019950: 6661 6c6c 6261 636b 5f6e 756d 5f63 7075  fallback_num_cpu
-00019960: 733a 0a20 2020 2020 2020 2072 6574 7572  s:.        retur
-00019970: 6e20 6765 745f 6e75 6d62 6572 5f61 7661  n get_number_ava
-00019980: 696c 6162 6c65 5f63 7075 7328 290a 2020  ilable_cpus().  
-00019990: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-000199a0: 5468 6561 6e6f 466c 6167 7320 3d20 7b0a  TheanoFlags = {.
-000199b0: 2020 2020 6b65 793a 2076 616c 7565 2066      key: value f
-000199c0: 6f72 2028 6b65 792c 2076 616c 7565 2920  or (key, value) 
-000199d0: 696e 205b 732e 7370 6c69 7428 223d 222c  in [s.split("=",
-000199e0: 2031 2920 666f 7220 7320 696e 206f 732e   1) for s in os.
-000199f0: 656e 7669 726f 6e2e 6765 7428 2254 4845  environ.get("THE
-00019a00: 414e 4f5f 464c 4147 5322 2c20 2222 292e  ANO_FLAGS", "").
-00019a10: 7370 6c69 7428 222c 2229 2069 6620 735d  split(",") if s]
-00019a20: 0a7d 0a0a 0a64 6566 205f 636f 6e73 6964  .}...def _consid
-00019a30: 6572 5f63 6865 636b 5f66 6f72 5f67 7075  er_check_for_gpu
-00019a40: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
-00019a50: 5468 6572 6520 6172 6520 6361 7365 7320  There are cases 
-00019a60: 7768 6572 6520 6e76 6964 6961 2d73 6d69  where nvidia-smi
-00019a70: 2063 6f75 6c64 2068 616e 672e 0a20 2020   could hang..   
-00019a80: 2028 416e 7920 7265 6164 206f 6620 2f70   (Any read of /p
-00019a90: 726f 632f 6d6f 6475 6c65 7320 6d69 6768  roc/modules migh
-00019aa0: 7420 6861 6e67 2069 6e20 7468 6174 2063  t hang in that c
-00019ab0: 6173 652c 206d 6179 6265 2063 6175 7365  ase, maybe cause
-00019ac0: 640a 2020 2020 2062 7920 7472 7969 6e67  d.     by trying
-00019ad0: 2074 6f20 606d 6f64 7072 6f62 6520 6e76   to `modprobe nv
-00019ae0: 6964 6961 6020 746f 2063 6865 636b 2069  idia` to check i
-00019af0: 6620 7468 6572 6520 6973 2061 204e 7669  f there is a Nvi
-00019b00: 6469 6120 6361 7264 2e29 0a20 2020 2054  dia card.).    T
-00019b10: 6869 7320 736f 6d65 7469 6d65 7320 6861  his sometimes ha
-00019b20: 7070 656e 7320 696e 206f 7572 2053 4745  ppens in our SGE
-00019b30: 2063 6c75 7374 6572 206f 6e20 6e6f 6465   cluster on node
-00019b40: 7320 7769 7468 6f75 7420 4e76 6964 6961  s without Nvidia
-00019b50: 2063 6172 6473 2e0a 2020 2020 4d61 7962   cards..    Mayb
-00019b60: 6520 6974 2773 2061 6c73 6f20 6120 4c69  e it's also a Li
-00019b70: 6e75 7820 4b65 726e 656c 2062 7567 2e0a  nux Kernel bug..
-00019b80: 2020 2020 416e 7977 6179 2c20 6a75 7374      Anyway, just
-00019b90: 2061 766f 6964 2061 6e79 2073 7563 6820   avoid any such 
-00019ba0: 6368 6563 6b20 6966 2077 6520 646f 6e27  check if we don'
-00019bb0: 7420 6173 6b65 6420 666f 7220 6120 4750  t asked for a GP
-00019bc0: 552e 0a0a 2020 2020 3a72 7479 7065 3a20  U...    :rtype: 
-00019bd0: 626f 6f6c 0a20 2020 2022 2222 0a20 2020  bool.    """.   
-00019be0: 2069 6620 2264 6576 6963 6522 2069 6e20   if "device" in 
-00019bf0: 5468 6561 6e6f 466c 6167 733a 0a20 2020  TheanoFlags:.   
-00019c00: 2020 2020 2064 6576 203d 2054 6865 616e       dev = Thean
-00019c10: 6f46 6c61 6773 5b22 6465 7669 6365 225d  oFlags["device"]
-00019c20: 0a20 2020 2020 2020 2069 6620 6465 762e  .        if dev.
-00019c30: 7374 6172 7473 7769 7468 2822 6770 7522  startswith("gpu"
-00019c40: 2920 6f72 2064 6576 2e73 7461 7274 7377  ) or dev.startsw
-00019c50: 6974 6828 2263 7564 6122 293a 0a20 2020  ith("cuda"):.   
-00019c60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00019c70: 5472 7565 0a20 2020 2020 2020 2023 2054  True.        # T
-00019c80: 4845 414e 4f5f 464c 4147 5320 7769 6c6c  HEANO_FLAGS will
-00019c90: 206f 7665 7277 7269 7465 2074 6869 7320   overwrite this 
-00019ca0: 636f 6e66 6967 206f 7074 696f 6e2e 2053  config option. S
-00019cb0: 6565 2072 6e6e 2e69 6e69 7444 6576 6963  ee rnn.initDevic
-00019cc0: 6573 2829 2e0a 2020 2020 2020 2020 7265  es()..        re
-00019cd0: 7475 726e 2046 616c 7365 0a20 2020 2023  turn False.    #
-00019ce0: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
-00019cf0: 4272 6f61 6445 7863 6570 7469 6f6e 0a20  BroadException. 
-00019d00: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00019d10: 6672 6f6d 2072 6574 7572 6e6e 2e63 6f6e  from returnn.con
-00019d20: 6669 6720 696d 706f 7274 2067 6574 5f67  fig import get_g
-00019d30: 6c6f 6261 6c5f 636f 6e66 6967 0a0a 2020  lobal_config..  
-00019d40: 2020 2020 2020 636f 6e66 6967 203d 2067        config = g
-00019d50: 6574 5f67 6c6f 6261 6c5f 636f 6e66 6967  et_global_config
-00019d60: 2829 0a20 2020 2065 7863 6570 7420 4578  ().    except Ex
-00019d70: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-00019d80: 2063 6f6e 6669 6720 3d20 4e6f 6e65 0a20   config = None. 
-00019d90: 2020 2069 6620 636f 6e66 6967 3a0a 2020     if config:.  
-00019da0: 2020 2020 2020 666f 7220 6465 7620 696e        for dev in
-00019db0: 2063 6f6e 6669 672e 6c69 7374 2822 6465   config.list("de
-00019dc0: 7669 6365 222c 205b 5d29 3a0a 2020 2020  vice", []):.    
-00019dd0: 2020 2020 2020 2020 6966 2064 6576 2e73          if dev.s
-00019de0: 7461 7274 7377 6974 6828 2267 7075 2229  tartswith("gpu")
-00019df0: 206f 7220 6465 762e 7374 6172 7473 7769   or dev.startswi
-00019e00: 7468 2822 6375 6461 2229 3a0a 2020 2020  th("cuda"):.    
-00019e10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00019e20: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
-00019e30: 2020 2020 6966 2064 6576 203d 3d20 2261      if dev == "a
-00019e40: 6c6c 223a 0a20 2020 2020 2020 2020 2020  ll":.           
-00019e50: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00019e60: 0a20 2020 2072 6574 7572 6e20 4661 6c73  .    return Fals
-00019e70: 650a 0a0a 6465 6620 6765 745f 6770 755f  e...def get_gpu_
-00019e80: 6e61 6d65 7328 293a 0a20 2020 2022 2222  names():.    """
-00019e90: 0a20 2020 203a 7274 7970 653a 206c 6973  .    :rtype: lis
-00019ea0: 745b 7374 725d 0a20 2020 2022 2222 0a20  t[str].    """. 
-00019eb0: 2020 2069 6620 6e6f 7420 5f63 6f6e 7369     if not _consi
-00019ec0: 6465 725f 6368 6563 6b5f 666f 725f 6770  der_check_for_gp
-00019ed0: 7528 293a 0a20 2020 2020 2020 2072 6574  u():.        ret
-00019ee0: 7572 6e20 5b5d 0a20 2020 2069 6620 6f73  urn [].    if os
-00019ef0: 2e6e 616d 6520 3d3d 2022 6e74 223a 0a20  .name == "nt":. 
-00019f00: 2020 2020 2020 2072 6574 7572 6e20 2247         return "G
-00019f10: 6546 6f72 6365 2047 5458 2037 3730 2220  eForce GTX 770" 
-00019f20: 2023 2054 4f44 4f0a 2020 2020 656c 6966   # TODO.    elif
-00019f30: 2073 7973 2e70 6c61 7466 6f72 6d20 3d3d   sys.platform ==
-00019f40: 2022 6461 7277 696e 223a 0a20 2020 2020   "darwin":.     
-00019f50: 2020 2023 2054 4f44 4f20 7061 7273 6520     # TODO parse 
-00019f60: 7669 6120 786d 6c20 6f75 7470 7574 0a20  via xml output. 
-00019f70: 2020 2020 2020 2072 6574 7572 6e20 7379         return sy
-00019f80: 735f 636d 645f 6f75 745f 6c69 6e65 7328  s_cmd_out_lines(
-00019f90: 0a20 2020 2020 2020 2020 2020 2022 7379  .            "sy
-00019fa0: 7374 656d 5f70 726f 6669 6c65 7220 5350  stem_profiler SP
-00019fb0: 4469 7370 6c61 7973 4461 7461 5479 7065  DisplaysDataType
-00019fc0: 207c 2022 0a20 2020 2020 2020 2020 2020   | ".           
-00019fd0: 2022 6772 6570 2027 4368 6970 7365 7420   "grep 'Chipset 
-00019fe0: 4d6f 6465 6c3a 204e 5649 4449 4127 207c  Model: NVIDIA' |
-00019ff0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-0001a000: 7365 6420 2773 2f2e 2a43 6869 7073 6574  sed 's/.*Chipset
-0001a010: 204d 6f64 656c 3a20 4e56 4944 4941 202a   Model: NVIDIA *
-0001a020: 2f2f 3b73 2f20 2a24 2f2f 2722 0a20 2020  //;s/ *$//'".   
-0001a030: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
-0001a040: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0001a050: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001a060: 2073 7973 5f63 6d64 5f6f 7574 5f6c 696e   sys_cmd_out_lin
-0001a070: 6573 2822 6e76 6964 6961 2d73 6d69 202d  es("nvidia-smi -
-0001a080: 4c20 7c20 6375 7420 2d64 2027 2827 202d  L | cut -d '(' -
-0001a090: 6620 3120 7c20 6375 7420 2d64 2027 2027  f 1 | cut -d ' '
-0001a0a0: 202d 6620 332d 207c 2073 6564 202d 6520   -f 3- | sed -e 
-0001a0b0: 2773 2f5c 5c20 242f 2f27 2229 0a20 2020  's/\\ $//'").   
-0001a0c0: 2020 2020 2065 7863 6570 7420 4361 6c6c       except Call
-0001a0d0: 6564 5072 6f63 6573 7345 7272 6f72 3a0a  edProcessError:.
-0001a0e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001a0f0: 726e 205b 5d0a 0a0a 6465 6620 5f67 6574  rn []...def _get
-0001a100: 5f6e 756d 5f67 7075 5f64 6576 6963 6573  _num_gpu_devices
-0001a110: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
-0001a120: 3a72 6574 7572 6e3a 2063 7075 2c67 7075  :return: cpu,gpu
-0001a130: 0a20 2020 203a 7274 7970 653a 2028 696e  .    :rtype: (in
-0001a140: 742c 696e 7429 0a20 2020 2022 2222 0a20  t,int).    """. 
-0001a150: 2020 2069 6620 6f73 2e6e 616d 6520 3d3d     if os.name ==
-0001a160: 2022 6e74 223a 0a20 2020 2020 2020 2072   "nt":.        r
-0001a170: 6574 7572 6e20 312c 2031 2020 2320 544f  eturn 1, 1  # TO
-0001a180: 444f 0a20 2020 2065 6c69 6620 7379 732e  DO.    elif sys.
-0001a190: 706c 6174 666f 726d 203d 3d20 2264 6172  platform == "dar
-0001a1a0: 7769 6e22 3a0a 2020 2020 2020 2020 7265  win":.        re
-0001a1b0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-0001a1c0: 2020 2069 6e74 2873 7973 5f63 6d64 5f6f     int(sys_cmd_o
-0001a1d0: 7574 5f6c 696e 6573 2822 7379 7363 746c  ut_lines("sysctl
-0001a1e0: 202d 6120 7c20 6772 6570 206d 6163 6864   -a | grep machd
-0001a1f0: 6570 2e63 7075 2e63 6f72 655f 636f 756e  ep.cpu.core_coun
-0001a200: 7420 7c20 6177 6b20 277b 7072 696e 7420  t | awk '{print 
-0001a210: 2432 7d27 2229 5b30 5d29 2c0a 2020 2020  $2}'")[0]),.    
-0001a220: 2020 2020 2020 2020 6c65 6e28 7379 735f          len(sys_
-0001a230: 636d 645f 6f75 745f 6c69 6e65 7328 2273  cmd_out_lines("s
-0001a240: 7973 7465 6d5f 7072 6f66 696c 6572 2053  ystem_profiler S
-0001a250: 5044 6973 706c 6179 7344 6174 6154 7970  PDisplaysDataTyp
-0001a260: 6520 7c20 6772 6570 2027 4368 6970 7365  e | grep 'Chipse
-0001a270: 7420 4d6f 6465 6c3a 204e 5649 4449 4127  t Model: NVIDIA'
-0001a280: 207c 2063 6174 2229 292c 0a20 2020 2020   | cat")),.     
-0001a290: 2020 2029 0a20 2020 2065 6c73 653a 0a20     ).    else:. 
-0001a2a0: 2020 2020 2020 206e 756d 5f63 7075 7320         num_cpus 
-0001a2b0: 3d20 6c65 6e28 7379 735f 636d 645f 6f75  = len(sys_cmd_ou
-0001a2c0: 745f 6c69 6e65 7328 2263 6174 202f 7072  t_lines("cat /pr
-0001a2d0: 6f63 2f63 7075 696e 666f 207c 2067 7265  oc/cpuinfo | gre
-0001a2e0: 7020 7072 6f63 6573 736f 7222 2929 206f  p processor")) o
-0001a2f0: 7220 310a 2020 2020 2020 2020 6e75 6d5f  r 1.        num_
-0001a300: 6770 7573 203d 2030 0a20 2020 2020 2020  gpus = 0.       
-0001a310: 2069 6620 5f63 6f6e 7369 6465 725f 6368   if _consider_ch
-0001a320: 6563 6b5f 666f 725f 6770 7528 293a 0a20  eck_for_gpu():. 
-0001a330: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0001a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a350: 6e75 6d5f 6770 7573 203d 206c 656e 2873  num_gpus = len(s
-0001a360: 7973 5f63 6d64 5f6f 7574 5f6c 696e 6573  ys_cmd_out_lines
-0001a370: 2822 6e76 6964 6961 2d73 6d69 202d 4c22  ("nvidia-smi -L"
-0001a380: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-0001a390: 7863 6570 7420 4361 6c6c 6564 5072 6f63  xcept CalledProc
-0001a3a0: 6573 7345 7272 6f72 3a0a 2020 2020 2020  essError:.      
-0001a3b0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-0001a3c0: 2020 2020 2020 2072 6574 7572 6e20 6e75         return nu
-0001a3d0: 6d5f 6370 7573 2c20 6e75 6d5f 6770 7573  m_cpus, num_gpus
-0001a3e0: 0a0a 0a5f 6e75 6d5f 6465 7669 6365 7320  ..._num_devices 
-0001a3f0: 3d20 4e6f 6e65 0a0a 0a64 6566 2067 6574  = None...def get
-0001a400: 5f6e 756d 5f67 7075 5f64 6576 6963 6573  _num_gpu_devices
-0001a410: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
-0001a420: 3a72 6574 7572 6e3a 2028 6370 7520 636f  :return: (cpu co
-0001a430: 756e 742c 2067 7075 2063 6f75 6e74 290a  unt, gpu count).
-0001a440: 2020 2020 3a72 7479 7065 3a20 2869 6e74      :rtype: (int
-0001a450: 2c20 696e 7429 0a20 2020 2022 2222 0a20  , int).    """. 
-0001a460: 2020 2067 6c6f 6261 6c20 5f6e 756d 5f64     global _num_d
-0001a470: 6576 6963 6573 0a20 2020 2069 6620 5f6e  evices.    if _n
-0001a480: 756d 5f64 6576 6963 6573 2069 7320 6e6f  um_devices is no
-0001a490: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0001a4a0: 7265 7475 726e 205f 6e75 6d5f 6465 7669  return _num_devi
-0001a4b0: 6365 730a 2020 2020 5f6e 756d 5f64 6576  ces.    _num_dev
-0001a4c0: 6963 6573 203d 205f 6765 745f 6e75 6d5f  ices = _get_num_
-0001a4d0: 6770 755f 6465 7669 6365 7328 290a 2020  gpu_devices().  
-0001a4e0: 2020 7265 7475 726e 205f 6e75 6d5f 6465    return _num_de
-0001a4f0: 7669 6365 730a 0a0a 6465 6620 6861 7665  vices...def have
-0001a500: 5f67 7075 2829 3a0a 2020 2020 2222 220a  _gpu():.    """.
-0001a510: 2020 2020 3a72 7479 7065 3a20 626f 6f6c      :rtype: bool
-0001a520: 0a20 2020 2022 2222 0a20 2020 2063 7075  .    """.    cpu
-0001a530: 732c 2067 7075 7320 3d20 6765 745f 6e75  s, gpus = get_nu
-0001a540: 6d5f 6770 755f 6465 7669 6365 7328 290a  m_gpu_devices().
-0001a550: 2020 2020 7265 7475 726e 2067 7075 7320      return gpus 
-0001a560: 3e20 300a 0a0a 6465 6620 7472 795f 616e  > 0...def try_an
-0001a570: 645f 6967 6e6f 7265 5f65 7863 6570 7469  d_ignore_excepti
-0001a580: 6f6e 2866 293a 0a20 2020 2022 2222 0a20  on(f):.    """. 
-0001a590: 2020 2043 616c 6c73 2060 6066 6060 2c20     Calls ``f``, 
-0001a5a0: 616e 6420 6967 6e6f 7265 7320 616e 7920  and ignores any 
-0001a5b0: 6578 6365 7074 696f 6e2e 0a0a 2020 2020  exception...    
-0001a5c0: 3a70 6172 616d 2028 292d 3e54 2066 3a0a  :param ()->T f:.
-0001a5d0: 2020 2020 3a72 6574 7572 6e3a 2077 6861      :return: wha
-0001a5e0: 7465 7665 7220 6060 6660 6020 7265 7475  tever ``f`` retu
-0001a5f0: 726e 732c 206f 7220 4e6f 6e65 0a20 2020  rns, or None.   
-0001a600: 203a 7274 7970 653a 2054 7c4e 6f6e 650a   :rtype: T|None.
-0001a610: 2020 2020 2222 220a 2020 2020 7472 793a      """.    try:
-0001a620: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001a630: 6628 290a 2020 2020 6578 6365 7074 2045  f().    except E
-0001a640: 7863 6570 7469 6f6e 2061 7320 6578 633a  xception as exc:
-0001a650: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-0001a660: 7472 795f 616e 645f 6967 6e6f 7265 5f65  try_and_ignore_e
-0001a670: 7863 6570 7469 6f6e 3a20 2572 2066 6169  xception: %r fai
-0001a680: 6c65 643a 2025 7322 2025 2028 662c 2065  led: %s" % (f, e
-0001a690: 7863 2929 0a20 2020 2020 2020 2073 7973  xc)).        sys
-0001a6a0: 2e65 7863 6570 7468 6f6f 6b28 2a73 7973  .excepthook(*sys
-0001a6b0: 2e65 7863 5f69 6e66 6f28 2929 0a20 2020  .exc_info()).   
-0001a6c0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0001a6d0: 0a0a 0a64 6566 2074 7279 5f67 6574 5f73  ...def try_get_s
-0001a6e0: 7461 636b 5f66 7261 6d65 2864 6570 7468  tack_frame(depth
-0001a6f0: 3d31 293a 0a20 2020 2022 2222 0a20 2020  =1):.    """.   
-0001a700: 203a 7061 7261 6d20 696e 7420 6465 7074   :param int dept
-0001a710: 683a 0a20 2020 203a 7274 7970 653a 2074  h:.    :rtype: t
-0001a720: 7970 6573 2e46 7261 6d65 5479 7065 7c4e  ypes.FrameType|N
-0001a730: 6f6e 650a 2020 2020 3a72 6574 7572 6e3a  one.    :return:
-0001a740: 2063 616c 6c65 7220 6675 6e63 7469 6f6e   caller function
-0001a750: 206e 616d 652e 2074 6869 7320 6973 206a   name. this is j
-0001a760: 7573 7420 666f 7220 6465 6275 6767 696e  ust for debuggin
-0001a770: 670a 2020 2020 2222 220a 2020 2020 2320  g.    """.    # 
-0001a780: 6e6f 696e 7370 6563 7469 6f6e 2050 7942  noinspection PyB
-0001a790: 726f 6164 4578 6365 7074 696f 6e0a 2020  roadException.  
-0001a7a0: 2020 7472 793a 0a20 2020 2020 2020 2023    try:.        #
-0001a7b0: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
-0001a7c0: 5072 6f74 6563 7465 644d 656d 6265 722c  ProtectedMember,
-0001a7d0: 5079 556e 7265 736f 6c76 6564 5265 6665  PyUnresolvedRefe
-0001a7e0: 7265 6e63 6573 0a20 2020 2020 2020 2066  rences.        f
-0001a7f0: 7261 6d65 203d 2073 7973 2e5f 6765 7466  rame = sys._getf
-0001a800: 7261 6d65 2864 6570 7468 202b 2031 2920  rame(depth + 1) 
-0001a810: 2023 206f 6e65 206d 6f72 6520 746f 2063   # one more to c
-0001a820: 6f75 6e74 206f 7572 7365 6c76 6573 0a20  ount ourselves. 
-0001a830: 2020 2020 2020 2072 6574 7572 6e20 6672         return fr
-0001a840: 616d 650a 2020 2020 6578 6365 7074 2045  ame.    except E
-0001a850: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
-0001a860: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-0001a870: 6465 6620 7472 795f 6765 745f 6361 6c6c  def try_get_call
-0001a880: 6572 5f6e 616d 6528 6465 7074 683d 312c  er_name(depth=1,
-0001a890: 2066 616c 6c62 6163 6b3d 4e6f 6e65 293a   fallback=None):
-0001a8a0: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
-0001a8b0: 7261 6d20 696e 7420 6465 7074 683a 0a20  ram int depth:. 
-0001a8c0: 2020 203a 7061 7261 6d20 7374 727c 4e6f     :param str|No
-0001a8d0: 6e65 2066 616c 6c62 6163 6b3a 2074 6869  ne fallback: thi
-0001a8e0: 7320 6973 2072 6574 7572 6e65 6420 6966  s is returned if
-0001a8f0: 2077 6520 6661 696c 2066 6f72 2073 6f6d   we fail for som
-0001a900: 6520 7265 6173 6f6e 0a20 2020 203a 7274  e reason.    :rt
-0001a910: 7970 653a 2073 7472 7c4e 6f6e 650a 2020  ype: str|None.  
-0001a920: 2020 3a72 6574 7572 6e3a 2063 616c 6c65    :return: calle
-0001a930: 7220 6675 6e63 7469 6f6e 206e 616d 652e  r function name.
-0001a940: 2074 6869 7320 6973 206a 7573 7420 666f   this is just fo
-0001a950: 7220 6465 6275 6767 696e 670a 2020 2020  r debugging.    
-0001a960: 2222 220a 2020 2020 6672 616d 6520 3d20  """.    frame = 
-0001a970: 7472 795f 6765 745f 7374 6163 6b5f 6672  try_get_stack_fr
-0001a980: 616d 6528 6465 7074 6820 2b20 3129 2020  ame(depth + 1)  
-0001a990: 2320 6f6e 6520 6d6f 7265 2074 6f20 636f  # one more to co
-0001a9a0: 756e 7420 6f75 7273 656c 7665 730a 2020  unt ourselves.  
-0001a9b0: 2020 6966 2066 7261 6d65 3a0a 2020 2020    if frame:.    
-0001a9c0: 2020 2020 6672 6f6d 202e 6265 7474 6572      from .better
-0001a9d0: 5f65 7863 686f 6f6b 2069 6d70 6f72 7420  _exchook import 
-0001a9e0: 6765 745f 6675 6e63 5f73 7472 5f66 726f  get_func_str_fro
-0001a9f0: 6d5f 636f 6465 5f6f 626a 6563 740a 0a20  m_code_object.. 
-0001aa00: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
-0001aa10: 745f 6675 6e63 5f73 7472 5f66 726f 6d5f  t_func_str_from_
-0001aa20: 636f 6465 5f6f 626a 6563 7428 6672 616d  code_object(fram
-0001aa30: 652e 665f 636f 6465 2c20 6672 616d 653d  e.f_code, frame=
-0001aa40: 6672 616d 6529 0a20 2020 2072 6574 7572  frame).    retur
-0001aa50: 6e20 6661 6c6c 6261 636b 0a0a 0a64 6566  n fallback...def
-0001aa60: 2074 7261 6365 6261 636b 5f63 6c65 6172   traceback_clear
-0001aa70: 5f66 7261 6d65 7328 7462 293a 0a20 2020  _frames(tb):.   
-0001aa80: 2022 2222 0a20 2020 2043 6c65 6172 2074   """.    Clear t
-0001aa90: 7261 6365 6261 636b 2066 7261 6d65 206c  raceback frame l
-0001aaa0: 6f63 616c 732e 0a0a 2020 2020 4a75 7374  ocals...    Just
-0001aab0: 206c 696b 6520 3a66 756e 633a 6074 7261   like :func:`tra
-0001aac0: 6365 6261 636b 2e63 6c65 6172 5f66 7261  ceback.clear_fra
-0001aad0: 6d65 7360 2c20 6275 7420 6861 7320 616e  mes`, but has an
-0001aae0: 2061 6464 6974 696f 6e61 6c20 6669 780a   additional fix.
-0001aaf0: 2020 2020 2868 7474 7073 3a2f 2f67 6974      (https://git
-0001ab00: 6875 622e 636f 6d2f 7079 7468 6f6e 2f63  hub.com/python/c
-0001ab10: 7079 7468 6f6e 2f69 7373 7565 732f 3131  python/issues/11
-0001ab20: 3339 3339 292e 0a0a 2020 2020 3a70 6172  3939)...    :par
-0001ab30: 616d 2074 7970 6573 2e54 7261 6365 6261  am types.Traceba
-0001ab40: 636b 5479 7065 2074 623a 0a20 2020 2022  ckType tb:.    "
-0001ab50: 2222 0a20 2020 2077 6869 6c65 2074 623a  "".    while tb:
-0001ab60: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0001ab70: 2020 2020 2020 2020 2020 7462 2e74 625f            tb.tb_
-0001ab80: 6672 616d 652e 636c 6561 7228 290a 2020  frame.clear().  
-0001ab90: 2020 2020 2020 6578 6365 7074 2052 756e        except Run
-0001aba0: 7469 6d65 4572 726f 723a 0a20 2020 2020  timeError:.     
-0001abb0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0001abc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001abd0: 2020 2020 2020 2320 5573 696e 6720 7468        # Using th
-0001abe0: 6973 2063 6f64 6520 7472 6967 6765 7273  is code triggers
-0001abf0: 2074 6861 7420 7468 6520 7265 6620 6163   that the ref ac
-0001ac00: 7475 616c 6c79 2067 6f65 7320 6f75 7420  tually goes out 
-0001ac10: 6f66 2073 636f 7065 2c20 6f74 6865 7277  of scope, otherw
-0001ac20: 6973 6520 6974 2064 6f65 7320 6e6f 7421  ise it does not!
-0001ac30: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
-0001ac40: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-0001ac50: 6d2f 7079 7468 6f6e 2f63 7079 7468 6f6e  m/python/cpython
-0001ac60: 2f69 7373 7565 732f 3131 3339 3339 0a20  /issues/113939. 
-0001ac70: 2020 2020 2020 2020 2020 2074 622e 7462             tb.tb
-0001ac80: 5f66 7261 6d65 2e66 5f6c 6f63 616c 7320  _frame.f_locals 
-0001ac90: 2023 206e 6f71 610a 2020 2020 2020 2020   # noqa.        
-0001aca0: 7462 203d 2074 622e 7462 5f6e 6578 740a  tb = tb.tb_next.
-0001acb0: 0a0a 636c 6173 7320 496e 6669 6e69 7465  ..class Infinite
-0001acc0: 5265 6375 7273 696f 6e44 6574 6563 7465  RecursionDetecte
-0001acd0: 6428 4578 6365 7074 696f 6e29 3a0a 2020  d(Exception):.  
-0001ace0: 2020 2222 220a 2020 2020 5261 6973 6564    """.    Raised
-0001acf0: 2077 6865 6e20 616e 2069 6e66 696e 6974   when an infinit
-0001ad00: 6520 7265 6375 7273 696f 6e20 6973 2064  e recursion is d
-0001ad10: 6574 6563 7465 642c 2062 7920 6775 6172  etected, by guar
-0001ad20: 645f 696e 6669 6e69 7465 5f72 6563 7572  d_infinite_recur
-0001ad30: 7369 6f6e 2e0a 2020 2020 2222 220a 0a0a  sion..    """...
-0001ad40: 5f67 7561 7264 5f69 6e66 696e 6974 655f  _guard_infinite_
-0001ad50: 7265 6375 7273 696f 6e5f 6361 6368 6520  recursion_cache 
-0001ad60: 3d20 7468 7265 6164 696e 672e 6c6f 6361  = threading.loca
-0001ad70: 6c28 290a 0a0a 4063 6f6e 7465 7874 6c69  l()...@contextli
-0001ad80: 622e 636f 6e74 6578 746d 616e 6167 6572  b.contextmanager
-0001ad90: 0a64 6566 2067 7561 7264 5f69 6e66 696e  .def guard_infin
-0001ada0: 6974 655f 7265 6375 7273 696f 6e28 2a61  ite_recursion(*a
-0001adb0: 7267 7329 3a0a 2020 2020 2222 220a 2020  rgs):.    """.  
-0001adc0: 2020 5265 6769 7374 6572 7320 6172 6773    Registers args
-0001add0: 2028 636f 756c 6420 6265 2066 756e 6320   (could be func 
-0001ade0: 2b20 6172 6773 2920 696e 2073 6f6d 6520  + args) in some 
-0001adf0: 6361 6368 652e 0a20 2020 2049 6620 7468  cache..    If th
-0001ae00: 6f73 6520 6172 6773 2061 7265 2061 6c72  ose args are alr
-0001ae10: 6561 6479 2069 6e20 7468 6520 6361 6368  eady in the cach
-0001ae20: 652c 2069 7420 7769 6c6c 2072 6169 7365  e, it will raise
-0001ae30: 2061 6e20 6578 6365 7074 696f 6e2e 0a0a   an exception...
-0001ae40: 2020 2020 4974 2077 696c 6c20 7573 6520      It will use 
-0001ae50: 7468 6520 6964 206f 6620 7468 6520 6172  the id of the ar
-0001ae60: 6773 2061 7320 6b65 7920 616e 6420 6e6f  gs as key and no
-0001ae70: 7420 7573 6520 616e 7920 6861 7368 696e  t use any hashin
-0001ae80: 670a 2020 2020 746f 2061 6c6c 6f77 2074  g.    to allow t
-0001ae90: 6861 7420 6775 6172 645f 696e 6669 6e69  hat guard_infini
-0001aea0: 7465 5f72 6563 7572 7369 6f6e 2063 616e  te_recursion can
-0001aeb0: 2062 6520 7573 6564 0a20 2020 2074 6f20   be used.    to 
-0001aec0: 6775 6172 6420 6375 7374 6f6d 205f 5f68  guard custom __h
-0001aed0: 6173 685f 5f20 696d 706c 656d 656e 7461  ash__ implementa
-0001aee0: 7469 6f6e 7320 6173 2077 656c 6c2e 0a20  tions as well.. 
-0001aef0: 2020 2022 2222 0a20 2020 2069 6620 6e6f     """.    if no
-0001af00: 7420 6172 6773 3a0a 2020 2020 2020 2020  t args:.        
-0001af10: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0001af20: 2822 6775 6172 645f 696e 6669 6e69 7465  ("guard_infinite
-0001af30: 5f72 6563 7572 7369 6f6e 206e 6565 6473  _recursion needs
-0001af40: 2061 7420 6c65 6173 7420 6f6e 6520 6172   at least one ar
-0001af50: 6722 290a 2020 2020 6b65 7920 3d20 7475  g").    key = tu
-0001af60: 706c 6528 6964 2861 7267 2920 666f 7220  ple(id(arg) for 
-0001af70: 6172 6720 696e 2061 7267 7329 0a20 2020  arg in args).   
-0001af80: 2069 6620 6e6f 7420 6861 7361 7474 7228   if not hasattr(
-0001af90: 5f67 7561 7264 5f69 6e66 696e 6974 655f  _guard_infinite_
-0001afa0: 7265 6375 7273 696f 6e5f 6361 6368 652c  recursion_cache,
-0001afb0: 2022 6361 6368 6522 293a 0a20 2020 2020   "cache"):.     
-0001afc0: 2020 205f 6775 6172 645f 696e 6669 6e69     _guard_infini
-0001afd0: 7465 5f72 6563 7572 7369 6f6e 5f63 6163  te_recursion_cac
-0001afe0: 6865 2e63 6163 6865 203d 2073 6574 2829  he.cache = set()
-0001aff0: 0a20 2020 2069 6620 6b65 7920 696e 205f  .    if key in _
-0001b000: 6775 6172 645f 696e 6669 6e69 7465 5f72  guard_infinite_r
-0001b010: 6563 7572 7369 6f6e 5f63 6163 6865 2e63  ecursion_cache.c
-0001b020: 6163 6865 3a0a 2020 2020 2020 2020 7261  ache:.        ra
-0001b030: 6973 6520 496e 6669 6e69 7465 5265 6375  ise InfiniteRecu
-0001b040: 7273 696f 6e44 6574 6563 7465 6428 2269  rsionDetected("i
-0001b050: 6e66 696e 6974 6520 7265 6375 7273 696f  nfinite recursio
-0001b060: 6e20 6465 7465 6374 6564 2229 0a20 2020  n detected").   
-0001b070: 205f 6775 6172 645f 696e 6669 6e69 7465   _guard_infinite
-0001b080: 5f72 6563 7572 7369 6f6e 5f63 6163 6865  _recursion_cache
-0001b090: 2e63 6163 6865 2e61 6464 286b 6579 290a  .cache.add(key).
-0001b0a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001b0b0: 2079 6965 6c64 0a20 2020 2066 696e 616c   yield.    final
-0001b0c0: 6c79 3a0a 2020 2020 2020 2020 5f67 7561  ly:.        _gua
-0001b0d0: 7264 5f69 6e66 696e 6974 655f 7265 6375  rd_infinite_recu
-0001b0e0: 7273 696f 6e5f 6361 6368 652e 6361 6368  rsion_cache.cach
-0001b0f0: 652e 7265 6d6f 7665 286b 6579 290a 0a0a  e.remove(key)...
-0001b100: 6465 6620 6361 6d65 6c5f 6361 7365 5f74  def camel_case_t
-0001b110: 6f5f 736e 616b 655f 6361 7365 286e 616d  o_snake_case(nam
-0001b120: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-0001b130: 3a70 6172 616d 2073 7472 206e 616d 653a  :param str name:
-0001b140: 2065 2e67 2e20 2243 616d 656c 4361 7365   e.g. "CamelCase
-0001b150: 220a 2020 2020 3a72 6574 7572 6e3a 2065  ".    :return: e
-0001b160: 2e67 2e20 2263 616d 656c 5f63 6173 6522  .g. "camel_case"
-0001b170: 0a20 2020 203a 7274 7970 653a 2073 7472  .    :rtype: str
-0001b180: 0a20 2020 2022 2222 0a20 2020 2073 3120  .    """.    s1 
-0001b190: 3d20 7265 2e73 7562 2822 282e 2928 5b41  = re.sub("(.)([A
-0001b1a0: 2d5a 5d5b 612d 7a5d 2b29 222c 2072 225c  -Z][a-z]+)", r"\
-0001b1b0: 315f 5c32 222c 206e 616d 6529 0a20 2020  1_\2", name).   
-0001b1c0: 2072 6574 7572 6e20 7265 2e73 7562 2822   return re.sub("
-0001b1d0: 285b 612d 7a30 2d39 5d29 285b 412d 5a5d  ([a-z0-9])([A-Z]
-0001b1e0: 2922 2c20 7222 5c31 5f5c 3222 2c20 7331  )", r"\1_\2", s1
-0001b1f0: 292e 6c6f 7765 7228 290a 0a0a 6465 6620  ).lower()...def 
-0001b200: 6765 745f 686f 7374 6e61 6d65 2829 3a0a  get_hostname():.
-0001b210: 2020 2020 2222 220a 2020 2020 3a72 6574      """.    :ret
-0001b220: 7572 6e3a 2065 2e67 2e20 2263 6c75 7374  urn: e.g. "clust
-0001b230: 6572 2d63 6e2d 3231 3122 0a20 2020 203a  er-cn-211".    :
-0001b240: 7274 7970 653a 2073 7472 0a20 2020 2022  rtype: str.    "
-0001b250: 2222 0a20 2020 2023 2063 6865 636b 5f6f  "".    # check_o
-0001b260: 7574 7075 7428 5b22 686f 7374 6e61 6d65  utput(["hostname
-0001b270: 225d 292e 7374 7269 7028 292e 6465 636f  "]).strip().deco
-0001b280: 6465 2822 7574 6638 2229 0a20 2020 2069  de("utf8").    i
-0001b290: 6d70 6f72 7420 736f 636b 6574 0a0a 2020  mport socket..  
-0001b2a0: 2020 7265 7475 726e 2073 6f63 6b65 742e    return socket.
-0001b2b0: 6765 7468 6f73 746e 616d 6528 290a 0a0a  gethostname()...
-0001b2c0: 6465 6620 6973 5f72 756e 6e69 6e67 5f6f  def is_running_o
-0001b2d0: 6e5f 636c 7573 7465 7228 293a 0a20 2020  n_cluster():.   
-0001b2e0: 2022 2222 0a20 2020 203a 7265 7475 726e   """.    :return
-0001b2f0: 3a20 6936 2073 7065 6369 6669 632e 2057  : i6 specific. W
-0001b300: 6865 7468 6572 2077 6520 7275 6e20 6f6e  hether we run on
-0001b310: 2073 6f6d 6520 6f66 2074 6865 2063 6c75   some of the clu
-0001b320: 7374 6572 206e 6f64 6573 2e0a 2020 2020  ster nodes..    
-0001b330: 3a72 7479 7065 3a20 626f 6f6c 0a20 2020  :rtype: bool.   
-0001b340: 2022 2222 0a20 2020 2072 6574 7572 6e20   """.    return 
-0001b350: 6765 745f 686f 7374 6e61 6d65 2829 2e73  get_hostname().s
-0001b360: 7461 7274 7377 6974 6828 2263 6c75 7374  tartswith("clust
-0001b370: 6572 2d63 6e2d 2229 206f 7220 6765 745f  er-cn-") or get_
-0001b380: 686f 7374 6e61 6d65 2829 2e73 7461 7274  hostname().start
-0001b390: 7377 6974 6828 2263 6e2d 2229 0a0a 0a73  swith("cn-")...s
-0001b3a0: 7461 7274 5f74 696d 6520 3d20 7469 6d65  tart_time = time
-0001b3b0: 2e74 696d 6528 290a 0a0a 6465 6620 6765  .time()...def ge
-0001b3c0: 745f 7574 635f 7374 6172 745f 7469 6d65  t_utc_start_time
-0001b3d0: 5f66 696c 656e 616d 655f 7061 7274 2829  _filename_part()
-0001b3e0: 3a0a 2020 2020 2222 220a 2020 2020 3a72  :.    """.    :r
-0001b3f0: 6574 7572 6e3a 2073 7472 696e 6720 7768  eturn: string wh
-0001b400: 6963 6820 6361 6e20 6265 2075 7365 6420  ich can be used 
-0001b410: 6173 2070 6172 7420 6f66 2061 2066 696c  as part of a fil
-0001b420: 656e 616d 652c 2077 6869 6368 2072 6570  ename, which rep
-0001b430: 7265 7365 6e74 7320 7468 6520 7374 6172  resents the star
-0001b440: 7420 7469 6d65 206f 6620 5245 5455 524e  t time of RETURN
-0001b450: 4e20 696e 2055 5443 0a20 2020 203a 7274  N in UTC.    :rt
-0001b460: 7970 653a 2073 7472 0a20 2020 2022 2222  ype: str.    """
-0001b470: 0a20 2020 2072 6574 7572 6e20 7469 6d65  .    return time
-0001b480: 2e73 7472 6674 696d 6528 2225 592d 256d  .strftime("%Y-%m
-0001b490: 2d25 642d 2548 2d25 4d2d 2553 222c 2074  -%d-%H-%M-%S", t
-0001b4a0: 696d 652e 676d 7469 6d65 2873 7461 7274  ime.gmtime(start
-0001b4b0: 5f74 696d 6529 290a 0a0a 6465 6620 6d61  _time))...def ma
-0001b4c0: 7962 655f 6d61 6b65 5f64 6972 7328 6469  ybe_make_dirs(di
-0001b4d0: 726e 616d 6529 3a0a 2020 2020 2222 220a  rname):.    """.
-0001b4e0: 2020 2020 4372 6561 7465 7320 7468 6520      Creates the 
-0001b4f0: 6469 7265 6374 6f72 7920 6966 2069 7420  directory if it 
-0001b500: 646f 6573 206e 6f74 2079 6574 2065 7869  does not yet exi
-0001b510: 7374 2e0a 0a20 2020 203a 7061 7261 6d20  st...    :param 
-0001b520: 7374 7220 6469 726e 616d 653a 2054 6865  str dirname: The
-0001b530: 2070 6174 6820 6f66 2074 6865 2064 6972   path of the dir
-0001b540: 6563 746f 7279 0a20 2020 2022 2222 0a20  ectory.    """. 
-0001b550: 2020 2069 6d70 6f72 7420 6f73 0a0a 2020     import os..  
-0001b560: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
-0001b570: 2e65 7869 7374 7328 6469 726e 616d 6529  .exists(dirname)
-0001b580: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0001b590: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
-0001b5a0: 6b65 6469 7273 2864 6972 6e61 6d65 290a  kedirs(dirname).
-0001b5b0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0001b5c0: 7863 6570 7469 6f6e 2061 7320 6578 633a  xception as exc:
-0001b5d0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0001b5e0: 6e74 2822 6d61 7962 655f 6372 6561 7465  nt("maybe_create
-0001b5f0: 5f66 6f6c 6465 723a 2065 7863 6570 7469  _folder: excepti
-0001b600: 6f6e 2063 7265 6174 696e 6720 6469 723a  on creating dir:
-0001b610: 222c 2065 7863 290a 2020 2020 2020 2020  ", exc).        
-0001b620: 2020 2020 2320 4d61 7962 6520 6120 636f      # Maybe a co
-0001b630: 6e63 7572 7265 6e74 2070 726f 6365 7373  ncurrent process
-0001b640: 2c20 652e 672e 2074 662e 636f 6d70 6174  , e.g. tf.compat
-0001b650: 2e76 312e 7375 6d6d 6172 792e 4669 6c65  .v1.summary.File
-0001b660: 5772 6974 6572 2063 7265 6174 6564 2069  Writer created i
-0001b670: 7420 696e 2074 6865 206d 6561 6e2d 7768  t in the mean-wh
-0001b680: 696c 652c 0a20 2020 2020 2020 2020 2020  ile,.           
-0001b690: 2023 2073 6f20 7468 656e 2069 7420 776f   # so then it wo
-0001b6a0: 756c 6420 6265 206f 6b20 6e6f 7720 6966  uld be ok now if
-0001b6b0: 2069 7420 6578 6973 7473 2c20 6275 7420   it exists, but 
-0001b6c0: 6661 696c 2069 6620 6974 2064 6f65 7320  fail if it does 
-0001b6d0: 6e6f 7420 6578 6973 742e 0a20 2020 2020  not exist..     
-0001b6e0: 2020 2020 2020 2061 7373 6572 7420 6f73         assert os
-0001b6f0: 2e70 6174 682e 6578 6973 7473 2864 6972  .path.exists(dir
-0001b700: 6e61 6d65 290a 0a0a 6465 6620 6c6f 675f  name)...def log_
-0001b710: 7275 6e74 696d 655f 696e 666f 5f74 6f5f  runtime_info_to_
-0001b720: 6469 7228 7061 7468 2c20 636f 6e66 6967  dir(path, config
-0001b730: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-0001b740: 6869 7320 7769 6c6c 2077 7269 7465 206d  his will write m
-0001b750: 756c 7469 706c 6520 6c6f 6767 696e 6720  ultiple logging 
-0001b760: 696e 666f 726d 6174 696f 6e20 696e 746f  information into
-0001b770: 2074 6865 2070 6174 682e 0a20 2020 2049   the path..    I
-0001b780: 7420 7769 6c6c 2063 7265 6174 6520 7265  t will create re
-0001b790: 7475 726e 6e2e 2a2e 6c6f 6720 7769 7468  turnn.*.log with
-0001b7a0: 2073 6f6d 6520 6d65 7461 2069 6e66 6f72   some meta infor
-0001b7b0: 6d61 7469 6f6e 2c0a 2020 2020 6173 2077  mation,.    as w
-0001b7c0: 656c 6c20 6173 2063 6f70 7920 7468 6520  ell as copy the 
-0001b7d0: 7573 6564 2063 6f6e 6669 6720 6669 6c65  used config file
-0001b7e0: 2e0a 0a20 2020 203a 7061 7261 6d20 7374  ...    :param st
-0001b7f0: 7220 7061 7468 3a20 6469 7265 6374 6f72  r path: director
-0001b800: 7920 7061 7468 0a20 2020 203a 7061 7261  y path.    :para
-0001b810: 6d20 7265 7475 726e 6e2e 636f 6e66 6967  m returnn.config
-0001b820: 2e43 6f6e 6669 6720 636f 6e66 6967 3a0a  .Config config:.
-0001b830: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
-0001b840: 7274 206f 730a 2020 2020 696d 706f 7274  rt os.    import
-0001b850: 2073 7973 0a20 2020 2069 6d70 6f72 7420   sys.    import 
-0001b860: 7368 7574 696c 0a20 2020 2066 726f 6d20  shutil.    from 
-0001b870: 7265 7475 726e 6e2e 636f 6e66 6967 2069  returnn.config i
-0001b880: 6d70 6f72 7420 436f 6e66 6967 0a0a 2020  mport Config..  
-0001b890: 2020 7472 793a 0a20 2020 2020 2020 2068    try:.        h
-0001b8a0: 6f73 746e 616d 6520 3d20 6765 745f 686f  ostname = get_ho
-0001b8b0: 7374 6e61 6d65 2829 0a20 2020 2020 2020  stname().       
-0001b8c0: 2063 6f6e 7465 6e74 203d 205b 0a20 2020   content = [.   
-0001b8d0: 2020 2020 2020 2020 2022 5469 6d65 3a20           "Time: 
-0001b8e0: 2573 2220 2520 7469 6d65 2e73 7472 6674  %s" % time.strft
-0001b8f0: 696d 6528 2225 592d 256d 2d25 6420 2548  ime("%Y-%m-%d %H
-0001b900: 3a25 4d3a 2553 222c 2074 696d 652e 676d  :%M:%S", time.gm
-0001b910: 7469 6d65 2873 7461 7274 5f74 696d 6529  time(start_time)
-0001b920: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
-0001b930: 4361 6c6c 3a20 2573 2220 2520 2873 7973  Call: %s" % (sys
-0001b940: 2e61 7267 762c 292c 0a20 2020 2020 2020  .argv,),.       
-0001b950: 2020 2020 2022 5061 7468 3a20 2573 2220       "Path: %s" 
-0001b960: 2520 286f 732e 6765 7463 7764 2829 2c29  % (os.getcwd(),)
-0001b970: 2c0a 2020 2020 2020 2020 2020 2020 2248  ,.            "H
-0001b980: 6f73 746e 616d 653a 2025 7322 2025 2067  ostname: %s" % g
-0001b990: 6574 5f68 6f73 746e 616d 6528 292c 0a20  et_hostname(),. 
-0001b9a0: 2020 2020 2020 2020 2020 2022 5049 443a             "PID:
-0001b9b0: 2025 6922 2025 206f 732e 6765 7470 6964   %i" % os.getpid
-0001b9c0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0001b9d0: 2252 6574 7572 6e6e 3a20 2573 2220 2520  "Returnn: %s" % 
-0001b9e0: 2864 6573 6372 6962 655f 7265 7475 726e  (describe_return
-0001b9f0: 6e5f 7665 7273 696f 6e28 292c 292c 0a20  n_version(),),. 
-0001ba00: 2020 2020 2020 2020 2020 2022 5465 6e73             "Tens
-0001ba10: 6f72 466c 6f77 3a20 2573 2220 2520 2864  orFlow: %s" % (d
-0001ba20: 6573 6372 6962 655f 7465 6e73 6f72 666c  escribe_tensorfl
-0001ba30: 6f77 5f76 6572 7369 6f6e 2829 2c29 2c0a  ow_version(),),.
-0001ba40: 2020 2020 2020 2020 2020 2020 2243 6f6e              "Con
-0001ba50: 6669 6720 6669 6c65 733a 2025 7322 2025  fig files: %s" %
-0001ba60: 2028 636f 6e66 6967 2e66 696c 6573 2c29   (config.files,)
-0001ba70: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
-0001ba80: 2020 2020 6d61 7962 655f 6d61 6b65 5f64      maybe_make_d
-0001ba90: 6972 7328 7061 7468 290a 2020 2020 2020  irs(path).      
-0001baa0: 2020 6c6f 675f 666e 203d 2022 2573 2f72    log_fn = "%s/r
-0001bab0: 6574 7572 6e6e 2e25 732e 2573 2e25 692e  eturnn.%s.%s.%i.
-0001bac0: 6c6f 6722 2025 2028 7061 7468 2c20 6765  log" % (path, ge
-0001bad0: 745f 7574 635f 7374 6172 745f 7469 6d65  t_utc_start_time
-0001bae0: 5f66 696c 656e 616d 655f 7061 7274 2829  _filename_part()
-0001baf0: 2c20 686f 7374 6e61 6d65 2c20 6f73 2e67  , hostname, os.g
-0001bb00: 6574 7069 6428 2929 0a20 2020 2020 2020  etpid()).       
-0001bb10: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
-0001bb20: 6578 6973 7473 286c 6f67 5f66 6e29 3a0a  exists(log_fn):.
-0001bb30: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0001bb40: 206f 7065 6e28 6c6f 675f 666e 2c20 2277   open(log_fn, "w
-0001bb50: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
-0001bb60: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
-0001bb70: 2822 5265 7475 726e 6e20 6c6f 6720 6669  ("Returnn log fi
-0001bb80: 6c65 3a5c 6e22 202b 2022 222e 6a6f 696e  le:\n" + "".join
-0001bb90: 285b 2225 735c 6e22 2025 2073 2066 6f72  (["%s\n" % s for
-0001bba0: 2073 2069 6e20 636f 6e74 656e 745d 2920   s in content]) 
-0001bbb0: 2b20 225c 6e22 290a 2020 2020 2020 2020  + "\n").        
-0001bbc0: 666f 7220 666e 2069 6e20 636f 6e66 6967  for fn in config
-0001bbd0: 2e66 696c 6573 3a0a 2020 2020 2020 2020  .files:.        
-0001bbe0: 2020 2020 6261 7365 5f66 6e20 3d20 6f73      base_fn = os
-0001bbf0: 2e70 6174 682e 6261 7365 6e61 6d65 2866  .path.basename(f
-0001bc00: 6e29 0a20 2020 2020 2020 2020 2020 2074  n).            t
-0001bc10: 6172 6765 745f 666e 203d 2022 2573 2f25  arget_fn = "%s/%
-0001bc20: 7322 2025 2028 7061 7468 2c20 6261 7365  s" % (path, base
-0001bc30: 5f66 6e29 0a20 2020 2020 2020 2020 2020  _fn).           
-0001bc40: 2069 6620 6f73 2e70 6174 682e 6578 6973   if os.path.exis
-0001bc50: 7473 2874 6172 6765 745f 666e 293a 0a20  ts(target_fn):. 
-0001bc60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001bc70: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-0001bc80: 2020 2020 7368 7574 696c 2e63 6f70 7928      shutil.copy(
-0001bc90: 666e 2c20 7461 7267 6574 5f66 6e29 0a20  fn, target_fn). 
-0001bca0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-0001bcb0: 675f 7479 7065 203d 2043 6f6e 6669 672e  g_type = Config.
-0001bcc0: 6765 745f 636f 6e66 6967 5f66 696c 655f  get_config_file_
-0001bcd0: 7479 7065 2866 6e29 0a20 2020 2020 2020  type(fn).       
-0001bce0: 2020 2020 2063 6f6d 6d65 6e74 5f70 7265       comment_pre
-0001bcf0: 6669 7820 3d20 2223 220a 2020 2020 2020  fix = "#".      
-0001bd00: 2020 2020 2020 6966 2063 6f6e 6669 675f        if config_
-0001bd10: 7479 7065 203d 3d20 226a 7322 3a0a 2020  type == "js":.  
-0001bd20: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001bd30: 6d6d 656e 745f 7072 6566 6978 203d 2022  mment_prefix = "
-0001bd40: 2f2f 220a 2020 2020 2020 2020 2020 2020  //".            
-0001bd50: 7769 7468 206f 7065 6e28 7461 7267 6574  with open(target
-0001bd60: 5f66 6e2c 2022 6122 2920 6173 2066 3a0a  _fn, "a") as f:.
-0001bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd80: 662e 7772 6974 6528 0a20 2020 2020 2020  f.write(.       
-0001bd90: 2020 2020 2020 2020 2020 2020 2022 5c6e               "\n
-0001bda0: 5c6e 5c6e 220a 2020 2020 2020 2020 2020  \n\n".          
-0001bdb0: 2020 2020 2020 2020 2020 2b20 2222 2e6a            + "".j
-0001bdc0: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
-0001bdd0: 2020 2020 2020 2020 2020 2020 205b 2225               ["%
-0001bde0: 7320 436f 6e66 6967 2d66 696c 6520 636f  s Config-file co
-0001bdf0: 7069 6564 2066 6f72 206c 6f67 6769 6e67  pied for logging
-0001be00: 2070 7572 706f 7365 2062 7920 5265 7475   purpose by Retu
-0001be10: 726e 6e2e 5c6e 2220 2520 636f 6d6d 656e  rnn.\n" % commen
-0001be20: 745f 7072 6566 6978 5d0a 2020 2020 2020  t_prefix].      
-0001be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be40: 2020 2b20 5b22 2573 2025 735c 6e22 2025    + ["%s %s\n" %
-0001be50: 2028 636f 6d6d 656e 745f 7072 6566 6978   (comment_prefix
-0001be60: 2c20 7329 2066 6f72 2073 2069 6e20 636f  , s) for s in co
-0001be70: 6e74 656e 745d 0a20 2020 2020 2020 2020  ntent].         
-0001be80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bea0: 202b 2022 5c6e 220a 2020 2020 2020 2020   + "\n".        
-0001beb0: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
-0001bec0: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
-0001bed0: 6578 633a 0a20 2020 2020 2020 2069 6620  exc:.        if 
-0001bee0: 2244 6973 6b20 7175 6f74 6122 2069 6e20  "Disk quota" in 
-0001bef0: 7374 7228 6578 6329 3a0a 2020 2020 2020  str(exc):.      
-0001bf00: 2020 2020 2020 7072 696e 7428 226c 6f67        print("log
-0001bf10: 5f72 756e 7469 6d65 5f69 6e66 6f5f 746f  _runtime_info_to
-0001bf20: 5f64 6972 3a20 4572 726f 722c 2063 616e  _dir: Error, can
-0001bf30: 6e6f 7420 7772 6974 653a 2025 7322 2025  not write: %s" %
-0001bf40: 2065 7863 290a 2020 2020 2020 2020 656c   exc).        el
-0001bf50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001bf60: 7261 6973 650a 0a0a 6465 6620 7368 6f75  raise...def shou
-0001bf70: 6c64 5f77 7269 7465 5f74 6f5f 6469 736b  ld_write_to_disk
-0001bf80: 2863 6f6e 6669 6729 3a0a 2020 2020 2222  (config):.    ""
-0001bf90: 220a 2020 2020 3a70 6172 616d 2072 6574  ".    :param ret
-0001bfa0: 7572 6e6e 2e63 6f6e 6669 672e 436f 6e66  urnn.config.Conf
-0001bfb0: 6967 2063 6f6e 6669 673a 0a20 2020 203a  ig config:.    :
-0001bfc0: 7274 7970 653a 2062 6f6f 6c0a 2020 2020  rtype: bool.    
-0001bfd0: 2222 220a 2020 2020 6966 2063 6f6e 6669  """.    if confi
-0001bfe0: 672e 7479 7065 645f 7661 6c75 6528 2274  g.typed_value("t
-0001bff0: 6f72 6368 5f64 6973 7472 6962 7574 6564  orch_distributed
-0001c000: 2229 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ") is not None:.
-0001c010: 2020 2020 2020 2020 6173 7365 7274 2042          assert B
-0001c020: 6163 6b65 6e64 456e 6769 6e65 2e69 735f  ackendEngine.is_
-0001c030: 746f 7263 685f 7365 6c65 6374 6564 2829  torch_selected()
-0001c040: 2c20 2274 6f72 6368 5f64 6973 7472 6962  , "torch_distrib
-0001c050: 7574 6564 2061 7373 756d 6573 2050 7954  uted assumes PyT
-0001c060: 6f72 6368 220a 0a20 2020 2020 2020 2069  orch"..        i
-0001c070: 6d70 6f72 7420 746f 7263 682e 6469 7374  mport torch.dist
-0001c080: 7269 6275 7465 640a 0a20 2020 2020 2020  ributed..       
-0001c090: 2069 6620 746f 7263 682e 6469 7374 7269   if torch.distri
-0001c0a0: 6275 7465 642e 6765 745f 7261 6e6b 2829  buted.get_rank()
-0001c0b0: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
-0001c0c0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0001c0d0: 2020 2020 656c 6966 2063 6f6e 6669 672e      elif config.
-0001c0e0: 6973 5f74 7275 6528 2275 7365 5f68 6f72  is_true("use_hor
-0001c0f0: 6f76 6f64 2229 3a0a 2020 2020 2020 2020  ovod"):.        
-0001c100: 6173 7365 7274 2042 6163 6b65 6e64 456e  assert BackendEn
-0001c110: 6769 6e65 2e69 735f 7465 6e73 6f72 666c  gine.is_tensorfl
-0001c120: 6f77 5f73 656c 6563 7465 6428 292c 2022  ow_selected(), "
-0001c130: 7573 655f 686f 726f 766f 6420 6375 7272  use_horovod curr
-0001c140: 656e 746c 7920 6173 7375 6d65 7320 5465  ently assumes Te
-0001c150: 6e73 6f72 466c 6f77 220a 0a20 2020 2020  nsorFlow"..     
-0001c160: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
-0001c170: 6e20 5079 5061 636b 6167 6552 6571 7569  n PyPackageRequi
-0001c180: 7265 6d65 6e74 732c 5079 556e 7265 736f  rements,PyUnreso
-0001c190: 6c76 6564 5265 6665 7265 6e63 6573 0a20  lvedReferences. 
-0001c1a0: 2020 2020 2020 2069 6d70 6f72 7420 686f         import ho
-0001c1b0: 726f 766f 642e 7465 6e73 6f72 666c 6f77  rovod.tensorflow
-0001c1c0: 2061 7320 6876 640a 0a20 2020 2020 2020   as hvd..       
-0001c1d0: 2069 6620 6876 642e 7261 6e6b 2829 2021   if hvd.rank() !
-0001c1e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0001c1f0: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
-0001c200: 2020 6966 2063 6f6e 6669 672e 6973 5f74    if config.is_t
-0001c210: 7275 6528 2264 7279 5f72 756e 2229 3a0a  rue("dry_run"):.
-0001c220: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-0001c230: 616c 7365 0a20 2020 2072 6574 7572 6e20  alse.    return 
-0001c240: 5472 7565 0a0a 0a5f 6465 6661 756c 745f  True..._default_
-0001c250: 676c 6f62 616c 5f69 6e66 5f76 616c 7565  global_inf_value
-0001c260: 203d 2066 6c6f 6174 2822 696e 6622 290a   = float("inf").
-0001c270: 0a0a 6465 6620 6765 745f 676c 6f62 616c  ..def get_global
-0001c280: 5f69 6e66 5f76 616c 7565 2829 202d 3e20  _inf_value() -> 
-0001c290: 666c 6f61 743a 0a20 2020 2022 2222 0a20  float:.    """. 
-0001c2a0: 2020 203a 7265 7475 726e 3a20 666c 6f61     :return: floa
-0001c2b0: 7428 2269 6e66 2229 2062 7920 6465 6661  t("inf") by defa
-0001c2c0: 756c 742c 2062 7574 2074 7269 6573 2074  ult, but tries t
-0001c2d0: 6f20 7265 6164 2060 696e 665f 7661 6c75  o read `inf_valu
-0001c2e0: 6560 2066 726f 6d20 7468 6520 676c 6f62  e` from the glob
-0001c2f0: 616c 2063 6f6e 6669 670a 2020 2020 2222  al config.    ""
-0001c300: 220a 2020 2020 6672 6f6d 2072 6574 7572  ".    from retur
-0001c310: 6e6e 2e63 6f6e 6669 6720 696d 706f 7274  nn.config import
-0001c320: 2067 6574 5f67 6c6f 6261 6c5f 636f 6e66   get_global_conf
-0001c330: 6967 0a0a 2020 2020 636f 6e66 6967 203d  ig..    config =
-0001c340: 2067 6574 5f67 6c6f 6261 6c5f 636f 6e66   get_global_conf
-0001c350: 6967 2872 6169 7365 5f65 7863 6570 7469  ig(raise_excepti
-0001c360: 6f6e 3d46 616c 7365 290a 2020 2020 6966  on=False).    if
-0001c370: 206e 6f74 2063 6f6e 6669 673a 0a20 2020   not config:.   
-0001c380: 2020 2020 2072 6574 7572 6e20 5f64 6566       return _def
-0001c390: 6175 6c74 5f67 6c6f 6261 6c5f 696e 665f  ault_global_inf_
-0001c3a0: 7661 6c75 650a 2020 2020 7265 7475 726e  value.    return
-0001c3b0: 2063 6f6e 6669 672e 666c 6f61 7428 2269   config.float("i
-0001c3c0: 6e66 5f76 616c 7565 222c 205f 6465 6661  nf_value", _defa
-0001c3d0: 756c 745f 676c 6f62 616c 5f69 6e66 5f76  ult_global_inf_v
-0001c3e0: 616c 7565 290a 0a0a 6465 6620 6973 5f6f  alue)...def is_o
-0001c3f0: 6e6e 785f 6578 706f 7274 5f67 6c6f 6261  nnx_export_globa
-0001c400: 6c28 2920 2d3e 2062 6f6f 6c3a 0a20 2020  l() -> bool:.   
-0001c410: 2022 2222 0a20 2020 203a 7265 7475 726e   """.    :return
-0001c420: 3a20 4661 6c73 6520 6279 2064 6566 6175  : False by defau
-0001c430: 6c74 2e20 4966 2027 6f6e 6e78 5f65 7870  lt. If 'onnx_exp
-0001c440: 6f72 7427 2069 7320 7365 7420 696e 2074  ort' is set in t
-0001c450: 6865 2063 6f6e 6669 672c 2074 6861 7420  he config, that 
-0001c460: 7661 6c75 6520 6973 2075 7365 642e 0a20  value is used.. 
-0001c470: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
-0001c480: 7265 7475 726e 6e2e 636f 6e66 6967 2069  returnn.config i
-0001c490: 6d70 6f72 7420 6765 745f 676c 6f62 616c  mport get_global
-0001c4a0: 5f63 6f6e 6669 670a 0a20 2020 2063 6f6e  _config..    con
-0001c4b0: 6669 6720 3d20 6765 745f 676c 6f62 616c  fig = get_global
-0001c4c0: 5f63 6f6e 6669 6728 7261 6973 655f 6578  _config(raise_ex
-0001c4d0: 6365 7074 696f 6e3d 4661 6c73 6529 0a20  ception=False). 
-0001c4e0: 2020 2069 6620 6e6f 7420 636f 6e66 6967     if not config
-0001c4f0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001c500: 2046 616c 7365 0a20 2020 2072 6574 7572   False.    retur
-0001c510: 6e20 636f 6e66 6967 2e62 6f6f 6c28 226f  n config.bool("o
-0001c520: 6e6e 785f 6578 706f 7274 222c 2046 616c  nnx_export", Fal
-0001c530: 7365 290a 0a0a 2320 5365 6520 3a66 756e  se)...# See :fun
-0001c540: 633a 606d 6179 6265 5f72 6573 7461 7274  c:`maybe_restart
-0001c550: 5f72 6574 7572 6e6e 5f77 6974 685f 6174  _returnn_with_at
-0001c560: 666f 726b 5f70 6174 6368 6020 6265 6c6f  fork_patch` belo
-0001c570: 7720 666f 7220 7768 7920 796f 7520 6d69  w for why you mi
-0001c580: 6768 7420 7761 6e74 2074 6f20 7573 6520  ght want to use 
-0001c590: 7468 6973 2e0a 5f63 5f63 6f64 655f 7061  this.._c_code_pa
-0001c5a0: 7463 685f 6174 666f 726b 203d 2022 2222  tch_atfork = """
-0001c5b0: 0a23 6465 6669 6e65 205f 474e 555f 534f  .#define _GNU_SO
-0001c5c0: 5552 4345 0a23 696e 636c 7564 6520 3c73  URCE.#include <s
-0001c5d0: 6368 6564 2e68 3e0a 2369 6e63 6c75 6465  ched.h>.#include
-0001c5e0: 203c 7369 676e 616c 2e68 3e0a 2369 6e63   <signal.h>.#inc
-0001c5f0: 6c75 6465 203c 7379 732f 7379 7363 616c  lude <sys/syscal
-0001c600: 6c2e 683e 0a23 696e 636c 7564 6520 3c73  l.h>.#include <s
-0001c610: 7464 696f 2e68 3e0a 2369 6e63 6c75 6465  tdio.h>.#include
-0001c620: 203c 7374 646c 6962 2e68 3e0a 2369 6e63   <stdlib.h>.#inc
-0001c630: 6c75 6465 203c 756e 6973 7464 2e68 3e0a  lude <unistd.h>.
-0001c640: 0a2f 2f20 6874 7470 733a 2f2f 7374 6163  .// https://stac
-0001c650: 6b6f 7665 7266 6c6f 772e 636f 6d2f 7175  koverflow.com/qu
-0001c660: 6573 7469 6f6e 732f 3436 3834 3534 3936  estions/46845496
-0001c670: 2f6c 642d 7072 656c 6f61 642d 616e 642d  /ld-preload-and-
-0001c680: 6c69 6e6b 6167 650a 2f2f 2068 7474 7073  linkage.// https
-0001c690: 3a2f 2f73 7461 636b 6f76 6572 666c 6f77  ://stackoverflow
-0001c6a0: 2e63 6f6d 2f71 7565 7374 696f 6e73 2f34  .com/questions/4
-0001c6b0: 3638 3130 3539 372f 666f 726b 6578 6563  6810597/forkexec
-0001c6c0: 2d77 6974 686f 7574 2d61 7466 6f72 6b2d  -without-atfork-
-0001c6d0: 6861 6e64 6c65 7273 0a0a 696e 7420 7074  handlers..int pt
-0001c6e0: 6872 6561 645f 6174 666f 726b 2876 6f69  hread_atfork(voi
-0001c6f0: 6420 282a 7072 6570 6172 6529 2876 6f69  d (*prepare)(voi
-0001c700: 6429 2c20 766f 6964 2028 2a70 6172 656e  d), void (*paren
-0001c710: 7429 2876 6f69 6429 2c20 766f 6964 2028  t)(void), void (
-0001c720: 2a63 6869 6c64 2928 766f 6964 2929 207b  *child)(void)) {
-0001c730: 0a20 2070 7269 6e74 6628 2249 676e 6f72  .  printf("Ignor
-0001c740: 696e 6720 7074 6872 6561 645f 6174 666f  ing pthread_atfo
-0001c750: 726b 2063 616c 6c21 5c5c 6e22 293b 0a20  rk call!\\n");. 
-0001c760: 2066 666c 7573 6828 7374 646f 7574 293b   fflush(stdout);
-0001c770: 0a20 2072 6574 7572 6e20 303b 0a7d 0a0a  .  return 0;.}..
-0001c780: 696e 7420 5f5f 7265 6769 7374 6572 5f61  int __register_a
-0001c790: 7466 6f72 6b28 766f 6964 2028 2a70 7265  tfork(void (*pre
-0001c7a0: 7061 7265 2928 766f 6964 292c 2076 6f69  pare)(void), voi
-0001c7b0: 6420 282a 7061 7265 6e74 2928 766f 6964  d (*parent)(void
-0001c7c0: 292c 2076 6f69 6420 282a 6368 696c 6429  ), void (*child)
-0001c7d0: 2876 6f69 6429 2920 7b0a 2020 7072 696e  (void)) {.  prin
-0001c7e0: 7466 2822 4967 6e6f 7269 6e67 205f 5f72  tf("Ignoring __r
-0001c7f0: 6567 6973 7465 725f 6174 666f 726b 2063  egister_atfork c
-0001c800: 616c 6c21 5c5c 6e22 293b 0a20 2066 666c  all!\\n");.  ffl
-0001c810: 7573 6828 7374 646f 7574 293b 0a20 2072  ush(stdout);.  r
-0001c820: 6574 7572 6e20 303b 0a7d 0a0a 2f2f 2041  eturn 0;.}..// A
-0001c830: 6e6f 7468 6572 2077 6179 2074 6f20 6967  nother way to ig
-0001c840: 6e6f 7265 2061 7466 6f72 6b20 6861 6e64  nore atfork hand
-0001c850: 6c65 7273 3a20 4f76 6572 7269 6465 2066  lers: Override f
-0001c860: 6f72 6b2e 0a23 6966 6465 6620 5f5f 6c69  ork..#ifdef __li
-0001c870: 6e75 785f 5f20 2f2f 206f 6e6c 7920 776f  nux__ // only wo
-0001c880: 726b 7320 6f6e 204c 696e 7578 2063 7572  rks on Linux cur
-0001c890: 7265 6e74 6c79 0a70 6964 5f74 2066 6f72  rently.pid_t for
-0001c8a0: 6b28 766f 6964 2920 7b0a 2020 7265 7475  k(void) {.  retu
-0001c8b0: 726e 2073 7973 6361 6c6c 2853 5953 5f63  rn syscall(SYS_c
-0001c8c0: 6c6f 6e65 2c20 5349 4743 484c 442c 2030  lone, SIGCHLD, 0
-0001c8d0: 293b 0a7d 0a23 656e 6469 660a 0a5f 5f61  );.}.#endif..__a
-0001c8e0: 7474 7269 6275 7465 5f5f 2828 636f 6e73  ttribute__((cons
-0001c8f0: 7472 7563 746f 7229 290a 766f 6964 2070  tructor)).void p
-0001c900: 6174 6368 5f61 7466 6f72 6b5f 696e 6974  atch_atfork_init
-0001c910: 2829 207b 0a20 2073 6574 656e 7628 225f  () {.  setenv("_
-0001c920: 5f52 4554 5552 4e4e 5f41 5446 4f52 4b5f  _RETURNN_ATFORK_
-0001c930: 5041 5443 4845 4422 2c20 2231 222c 2031  PATCHED", "1", 1
-0001c940: 293b 0a7d 0a22 2222 0a0a 0a64 6566 2067  );.}."""...def g
-0001c950: 6574 5f70 6174 6368 5f61 7466 6f72 6b5f  et_patch_atfork_
-0001c960: 6c69 6228 293a 0a20 2020 2022 2222 0a20  lib():.    """. 
-0001c970: 2020 203a 7265 7475 726e 3a20 7061 7468     :return: path
-0001c980: 2074 6f20 6f75 7220 7061 7463 685f 6174   to our patch_at
-0001c990: 666f 726b 206c 6962 2e20 7365 6520 3a66  fork lib. see :f
-0001c9a0: 756e 633a 606d 6179 6265 5f72 6573 7461  unc:`maybe_resta
-0001c9b0: 7274 5f72 6574 7572 6e6e 5f77 6974 685f  rt_returnn_with_
-0001c9c0: 6174 666f 726b 5f70 6174 6368 600a 2020  atfork_patch`.  
-0001c9d0: 2020 3a72 7479 7065 3a20 7374 720a 2020    :rtype: str.  
-0001c9e0: 2020 2222 220a 2020 2020 6e61 7469 7665    """.    native
-0001c9f0: 203d 204e 6174 6976 6543 6f64 6543 6f6d   = NativeCodeCom
-0001ca00: 7069 6c65 7228 6261 7365 5f6e 616d 653d  piler(base_name=
-0001ca10: 2270 6174 6368 5f61 7466 6f72 6b22 2c20  "patch_atfork", 
-0001ca20: 636f 6465 5f76 6572 7369 6f6e 3d32 2c20  code_version=2, 
-0001ca30: 636f 6465 3d5f 635f 636f 6465 5f70 6174  code=_c_code_pat
-0001ca40: 6368 5f61 7466 6f72 6b2c 2069 735f 6370  ch_atfork, is_cp
-0001ca50: 703d 4661 6c73 6529 0a20 2020 2066 6e20  p=False).    fn 
-0001ca60: 3d20 6e61 7469 7665 2e67 6574 5f6c 6962  = native.get_lib
-0001ca70: 5f66 696c 656e 616d 6528 290a 2020 2020  _filename().    
-0001ca80: 7265 7475 726e 2066 6e0a 0a0a 6465 6620  return fn...def 
-0001ca90: 7265 7374 6172 745f 7265 7475 726e 6e28  restart_returnn(
-0001caa0: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
-0001cab0: 6573 7461 7274 7320 5245 5455 524e 4e2e  estarts RETURNN.
-0001cac0: 0a20 2020 2022 2222 0a20 2020 206c 6f67  .    """.    log
-0001cad0: 2e66 6c75 7368 2829 0a20 2020 2073 7973  .flush().    sys
-0001cae0: 2e73 7464 6f75 742e 666c 7573 6828 290a  .stdout.flush().
-0001caf0: 2020 2020 7379 732e 7374 6465 7272 2e66      sys.stderr.f
-0001cb00: 6c75 7368 2829 0a20 2020 2023 2068 7474  lush().    # htt
-0001cb10: 7073 3a2f 2f73 7461 636b 6f76 6572 666c  ps://stackoverfl
-0001cb20: 6f77 2e63 6f6d 2f71 7565 7374 696f 6e73  ow.com/questions
-0001cb30: 2f37 3233 3335 3930 342f 7369 6d70 6c65  /72335904/simple
-0001cb40: 2d77 6179 2d74 6f2d 7265 7374 6172 742d  -way-to-restart-
-0001cb50: 6170 706c 6963 6174 696f 6e0a 2020 2020  application.    
-0001cb60: 636c 6f73 655f 616c 6c5f 6664 735f 6578  close_all_fds_ex
-0001cb70: 6365 7074 287b 302c 2031 2c20 327d 290a  cept({0, 1, 2}).
-0001cb80: 2020 2020 6f73 2e65 7865 6376 2873 7973      os.execv(sys
-0001cb90: 2e65 7865 6375 7461 626c 652c 205b 7379  .executable, [sy
-0001cba0: 732e 6578 6563 7574 6162 6c65 5d20 2b20  s.executable] + 
-0001cbb0: 7379 732e 6172 6776 290a 2020 2020 7261  sys.argv).    ra
-0001cbc0: 6973 6520 4578 6365 7074 696f 6e28 2272  ise Exception("r
-0001cbd0: 6573 7461 7274 5f72 6574 7572 6e6e 3a20  estart_returnn: 
-0001cbe0: 6578 6563 7620 6661 696c 6564 2229 0a0a  execv failed")..
-0001cbf0: 0a64 6566 206d 6179 6265 5f72 6573 7461  .def maybe_resta
-0001cc00: 7274 5f72 6574 7572 6e6e 5f77 6974 685f  rt_returnn_with_
-0001cc10: 6174 666f 726b 5f70 6174 6368 2829 3a0a  atfork_patch():.
-0001cc20: 2020 2020 2222 220a 2020 2020 5768 6174      """.    What
-0001cc30: 2077 6520 7761 6e74 3a20 7375 6270 726f   we want: subpro
-0001cc40: 6365 7373 2e50 6f70 656e 2074 6f20 616c  cess.Popen to al
-0001cc50: 7761 7973 2077 6f72 6b2e 0a20 2020 2050  ways work..    P
-0001cc60: 726f 626c 656d 3a20 4974 2075 7365 7320  roblem: It uses 
-0001cc70: 666f 726b 2b65 7865 6320 696e 7465 726e  fork+exec intern
-0001cc80: 616c 6c79 2069 6e20 7375 6270 726f 6365  ally in subproce
-0001cc90: 7373 5f66 6f72 6b5f 6578 6563 2c20 7669  ss_fork_exec, vi
-0001cca0: 6120 5f70 6f73 6978 7375 6270 726f 6365  a _posixsubproce
-0001ccb0: 7373 2e66 6f72 6b5f 6578 6563 2e0a 2020  ss.fork_exec..  
-0001ccc0: 2020 5468 6174 2069 7320 6120 7072 6f62    That is a prob
-0001ccd0: 6c65 6d20 6265 6361 7573 6520 666f 726b  lem because fork
-0001cce0: 2063 616e 2074 7269 6767 6572 2061 6e79   can trigger any
-0001ccf0: 2061 7466 6f72 6b20 6861 6e64 6c65 7273   atfork handlers
-0001cd00: 2072 6567 6973 7465 7265 6420 7669 6120   registered via 
-0001cd10: 7074 6872 6561 645f 6174 666f 726b 2c0a  pthread_atfork,.
-0001cd20: 2020 2020 616e 6420 7468 6f73 6520 6361      and those ca
-0001cd30: 6e20 6372 6173 682f 6465 6164 6c6f 636b  n crash/deadlock
-0001cd40: 2069 6e20 736f 6d65 2063 6173 6573 2e0a   in some cases..
-0001cd50: 0a20 2020 2068 7474 7073 3a2f 2f67 6974  .    https://git
-0001cd60: 6875 622e 636f 6d2f 7465 6e73 6f72 666c  hub.com/tensorfl
-0001cd70: 6f77 2f74 656e 736f 7266 6c6f 772f 6973  ow/tensorflow/is
-0001cd80: 7375 6573 2f31 3338 3032 0a20 2020 2068  sues/13802.    h
-0001cd90: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-0001cda0: 6d2f 7869 616e 7969 2f4f 7065 6e42 4c41  m/xianyi/OpenBLA
-0001cdb0: 532f 6973 7375 6573 2f32 3430 0a20 2020  S/issues/240.   
-0001cdc0: 2068 7474 7073 3a2f 2f74 7261 632e 7361   https://trac.sa
-0001cdd0: 6765 6d61 7468 2e6f 7267 2f74 6963 6b65  gemath.org/ticke
-0001cde0: 742f 3232 3032 310a 2020 2020 6874 7470  t/22021.    http
-0001cdf0: 733a 2f2f 6275 6773 2e70 7974 686f 6e2e  s://bugs.python.
-0001ce00: 6f72 672f 6973 7375 6533 3138 3134 0a20  org/issue31814. 
-0001ce10: 2020 2068 7474 7073 3a2f 2f73 7461 636b     https://stack
-0001ce20: 6f76 6572 666c 6f77 2e63 6f6d 2f71 7565  overflow.com/que
-0001ce30: 7374 696f 6e73 2f34 3638 3435 3439 362f  stions/46845496/
-0001ce40: 6c64 2d70 7265 6c6f 6164 2d61 6e64 2d6c  ld-preload-and-l
-0001ce50: 696e 6b61 6765 0a20 2020 2068 7474 7073  inkage.    https
-0001ce60: 3a2f 2f73 7461 636b 6f76 6572 666c 6f77  ://stackoverflow
-0001ce70: 2e63 6f6d 2f71 7565 7374 696f 6e73 2f34  .com/questions/4
-0001ce80: 3638 3130 3539 372f 666f 726b 6578 6563  6810597/forkexec
-0001ce90: 2d77 6974 686f 7574 2d61 7466 6f72 6b2d  -without-atfork-
-0001cea0: 6861 6e64 6c65 7273 0a0a 2020 2020 5468  handlers..    Th
-0001ceb0: 6520 736f 6c75 7469 6f6e 2068 6572 653a  e solution here:
-0001cec0: 204a 7573 7420 6f76 6572 7269 6465 2070   Just override p
-0001ced0: 7468 7265 6164 5f61 7466 6f72 6b2c 2076  thread_atfork, v
-0001cee0: 6961 204c 445f 5052 454c 4f41 442e 0a20  ia LD_PRELOAD.. 
-0001cef0: 2020 204e 6f74 6520 7468 6174 2069 6e20     Note that in 
-0001cf00: 736f 6d65 2063 6173 6573 2c20 7468 6973  some cases, this
-0001cf10: 2069 7320 6e6f 7420 656e 6f75 6768 2028   is not enough (
-0001cf20: 7365 6520 7468 6520 534f 2064 6973 6375  see the SO discu
-0001cf30: 7373 696f 6e29 2c0a 2020 2020 736f 2077  ssion),.    so w
-0001cf40: 6520 616c 736f 206f 7665 7277 7269 7465  e also overwrite
-0001cf50: 2066 6f72 6b20 6974 7365 6c66 2e0a 2020   fork itself..  
-0001cf60: 2020 5365 6520 616c 736f 2074 6573 7473    See also tests
-0001cf70: 2f74 6573 745f 666f 726b 5f65 7865 632e  /test_fork_exec.
-0001cf80: 7079 2066 6f72 2061 2064 656d 6f2e 0a20  py for a demo.. 
-0001cf90: 2020 2022 2222 0a20 2020 2069 6620 6f73     """.    if os
-0001cfa0: 2e65 6e76 6972 6f6e 2e67 6574 2822 5f5f  .environ.get("__
-0001cfb0: 5245 5455 524e 4e5f 4154 464f 524b 5f50  RETURNN_ATFORK_P
-0001cfc0: 4154 4348 4544 2229 203d 3d20 2231 223a  ATCHED") == "1":
-0001cfd0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-0001cfe0: 5275 6e6e 696e 6720 7769 7468 2070 6174  Running with pat
-0001cff0: 6368 6564 2061 7466 6f72 6b2e 2229 0a20  ched atfork."). 
-0001d000: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0001d010: 2020 6966 206f 732e 656e 7669 726f 6e2e    if os.environ.
-0001d020: 6765 7428 225f 5f52 4554 5552 4e4e 5f54  get("__RETURNN_T
-0001d030: 5259 5f41 5446 4f52 4b5f 5041 5443 4845  RY_ATFORK_PATCHE
-0001d040: 4422 2920 3d3d 2022 3122 3a0a 2020 2020  D") == "1":.    
-0001d050: 2020 2020 7072 696e 7428 2250 6174 6368      print("Patch
-0001d060: 696e 6720 6174 666f 726b 2064 6964 206e  ing atfork did n
-0001d070: 6f74 2077 6f72 6b21 2057 696c 6c20 636f  ot work! Will co
-0001d080: 6e74 696e 7565 2061 6e79 7761 792e 2229  ntinue anyway.")
-0001d090: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-0001d0a0: 2020 2020 6c69 6220 3d20 6765 745f 7061      lib = get_pa
-0001d0b0: 7463 685f 6174 666f 726b 5f6c 6962 2829  tch_atfork_lib()
-0001d0c0: 0a20 2020 2065 6e76 203d 206f 732e 656e  .    env = os.en
-0001d0d0: 7669 726f 6e2e 636f 7079 2829 0a20 2020  viron.copy().   
-0001d0e0: 2065 6e76 5b22 4459 4c44 5f49 4e53 4552   env["DYLD_INSER
-0001d0f0: 545f 4c49 4252 4152 4945 5322 2069 6620  T_LIBRARIES" if 
-0001d100: 7379 732e 706c 6174 666f 726d 203d 3d20  sys.platform == 
-0001d110: 2264 6172 7769 6e22 2065 6c73 6520 224c  "darwin" else "L
-0001d120: 445f 5052 454c 4f41 4422 5d20 3d20 6c69  D_PRELOAD"] = li
-0001d130: 620a 2020 2020 656e 765b 225f 5f52 4554  b.    env["__RET
-0001d140: 5552 4e4e 5f54 5259 5f41 5446 4f52 4b5f  URNN_TRY_ATFORK_
-0001d150: 5041 5443 4845 4422 5d20 3d20 2231 220a  PATCHED"] = "1".
-0001d160: 2020 2020 7072 696e 7428 2252 6573 7461      print("Resta
-0001d170: 7274 696e 6720 5265 7475 726e 6e20 7769  rting Returnn wi
-0001d180: 7468 2061 7466 6f72 6b20 7061 7463 682e  th atfork patch.
-0001d190: 2e2e 222c 2073 7973 2e65 7865 6375 7461  ..", sys.executa
-0001d1a0: 626c 652c 2073 7973 2e61 7267 7629 0a20  ble, sys.argv). 
-0001d1b0: 2020 2073 7973 2e73 7464 6f75 742e 666c     sys.stdout.fl
-0001d1c0: 7573 6828 290a 2020 2020 6f73 2e65 7865  ush().    os.exe
-0001d1d0: 6376 7065 2873 7973 2e65 7865 6375 7461  cvpe(sys.executa
-0001d1e0: 626c 652c 205b 7379 732e 6578 6563 7574  ble, [sys.execut
-0001d1f0: 6162 6c65 5d20 2b20 7379 732e 6172 6776  able] + sys.argv
-0001d200: 2c20 656e 7629 0a20 2020 2070 7269 6e74  , env).    print
-0001d210: 2822 6578 6563 7670 6520 6469 6420 6e6f  ("execvpe did no
-0001d220: 7420 776f 726b 3f22 290a 0a0a 6465 6620  t work?")...def 
-0001d230: 636c 6f73 655f 616c 6c5f 6664 735f 6578  close_all_fds_ex
-0001d240: 6365 7074 2865 7863 6570 745f 6664 7329  cept(except_fds)
-0001d250: 3a0a 2020 2020 2222 220a 2020 2020 4361  :.    """.    Ca
-0001d260: 6c6c 7320 6f73 2e63 6c6f 7365 7261 6e67  lls os.closerang
-0001d270: 6520 6578 6365 7074 2066 6f72 2074 6865  e except for the
-0001d280: 2067 6976 656e 2066 6473 2e0a 2020 2020   given fds..    
-0001d290: 436f 6465 2061 646f 7074 6564 2061 6e64  Code adopted and
-0001d2a0: 2065 7874 656e 6465 6420 6672 6f6d 206d   extended from m
-0001d2b0: 756c 7469 7072 6f63 6573 7369 6e67 2e75  ultiprocessing.u
-0001d2c0: 7469 6c2e 636c 6f73 655f 616c 6c5f 6664  til.close_all_fd
-0001d2d0: 735f 6578 6365 7074 2e0a 0a20 2020 203a  s_except...    :
-0001d2e0: 7061 7261 6d20 7479 7069 6e67 2e43 6f6c  param typing.Col
-0001d2f0: 6c65 6374 696f 6e5b 696e 745d 2065 7863  lection[int] exc
-0001d300: 6570 745f 6664 733a 2075 7375 616c 6c79  ept_fds: usually
-0001d310: 2061 7420 6c65 6173 7420 7b30 2c31 2c32   at least {0,1,2
-0001d320: 7d0a 2020 2020 2222 220a 2020 2020 2320  }.    """.    # 
-0001d330: 6e6f 696e 7370 6563 7469 6f6e 2050 7942  noinspection PyB
-0001d340: 726f 6164 4578 6365 7074 696f 6e0a 2020  roadException.  
-0001d350: 2020 7472 793a 0a20 2020 2020 2020 206d    try:.        m
-0001d360: 6178 5f66 6420 3d20 6f73 2e73 7973 636f  ax_fd = os.sysco
-0001d370: 6e66 2822 5343 5f4f 5045 4e5f 4d41 5822  nf("SC_OPEN_MAX"
-0001d380: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-0001d390: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0001d3a0: 6d61 785f 6664 203d 2032 3536 0a0a 2020  max_fd = 256..  
-0001d3b0: 2020 6578 6365 7074 5f66 6473 203d 2073    except_fds = s
-0001d3c0: 6f72 7465 6428 6c69 7374 2865 7863 6570  orted(list(excep
-0001d3d0: 745f 6664 7329 202b 205b 2d31 2c20 6d61  t_fds) + [-1, ma
-0001d3e0: 785f 6664 5d29 0a20 2020 2061 7373 6572  x_fd]).    asser
-0001d3f0: 7420 6578 6365 7074 5f66 6473 5b30 5d20  t except_fds[0] 
-0001d400: 3d3d 202d 3120 616e 6420 6578 6365 7074  == -1 and except
-0001d410: 5f66 6473 5b2d 315d 203d 3d20 6d61 785f  _fds[-1] == max_
-0001d420: 6664 2c20 2266 6420 696e 7661 6c69 6422  fd, "fd invalid"
-0001d430: 0a0a 2020 2020 666f 7220 6920 696e 2072  ..    for i in r
-0001d440: 616e 6765 286c 656e 2865 7863 6570 745f  ange(len(except_
-0001d450: 6664 7329 202d 2031 293a 0a20 2020 2020  fds) - 1):.     
-0001d460: 2020 2069 6620 6578 6365 7074 5f66 6473     if except_fds
-0001d470: 5b69 5d20 2b20 3120 3c20 6578 6365 7074  [i] + 1 < except
-0001d480: 5f66 6473 5b69 202b 2031 5d3a 0a20 2020  _fds[i + 1]:.   
-0001d490: 2020 2020 2020 2020 206f 732e 636c 6f73           os.clos
-0001d4a0: 6572 616e 6765 2865 7863 6570 745f 6664  erange(except_fd
-0001d4b0: 735b 695d 202b 2031 2c20 6578 6365 7074  s[i] + 1, except
-0001d4c0: 5f66 6473 5b69 202b 2031 5d29 0a0a 0a63  _fds[i + 1])...c
-0001d4d0: 6c61 7373 2053 7461 7473 3a0a 2020 2020  lass Stats:.    
-0001d4e0: 2222 220a 2020 2020 436f 6c6c 6563 7473  """.    Collects
-0001d4f0: 206d 6561 6e20 616e 6420 7661 7269 616e   mean and varian
-0001d500: 6365 2c20 7275 6e6e 696e 6720 6176 6572  ce, running aver
-0001d510: 6167 652e 0a0a 2020 2020 6874 7470 733a  age...    https:
-0001d520: 2f2f 656e 2e77 696b 6970 6564 6961 2e6f  //en.wikipedia.o
-0001d530: 7267 2f77 696b 692f 416c 676f 7269 7468  rg/wiki/Algorith
-0001d540: 6d73 5f66 6f72 5f63 616c 6375 6c61 7469  ms_for_calculati
-0001d550: 6e67 5f76 6172 6961 6e63 650a 2020 2020  ng_variance.    
-0001d560: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-0001d570: 6e69 745f 5f28 7365 6c66 2c20 666f 726d  nit__(self, form
-0001d580: 6174 5f73 7472 3d4e 6f6e 6529 3a0a 2020  at_str=None):.  
-0001d590: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001d5a0: 2020 3a70 6172 616d 204e 6f6e 657c 2828    :param None|((
-0001d5b0: 666c 6f61 747c 6e75 6d70 792e 6e64 6172  float|numpy.ndar
-0001d5c0: 7261 7929 2d3e 7374 7229 2066 6f72 6d61  ray)->str) forma
-0001d5d0: 745f 7374 723a 0a20 2020 2020 2020 2022  t_str:.        "
-0001d5e0: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
-0001d5f0: 666f 726d 6174 5f73 7472 203d 2066 6f72  format_str = for
-0001d600: 6d61 745f 7374 7220 6f72 2073 7472 0a20  mat_str or str. 
-0001d610: 2020 2020 2020 2073 656c 662e 6d65 616e         self.mean
-0001d620: 203d 2030 2e30 0a20 2020 2020 2020 2073   = 0.0.        s
-0001d630: 656c 662e 6d65 616e 5f73 7120 3d20 302e  elf.mean_sq = 0.
-0001d640: 300a 2020 2020 2020 2020 7365 6c66 2e76  0.        self.v
-0001d650: 6172 203d 2030 2e30 0a20 2020 2020 2020  ar = 0.0.       
-0001d660: 2073 656c 662e 6d69 6e20 3d20 4e6f 6e65   self.min = None
-0001d670: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
-0001d680: 7820 3d20 4e6f 6e65 0a20 2020 2020 2020  x = None.       
-0001d690: 2073 656c 662e 746f 7461 6c5f 6461 7461   self.total_data
-0001d6a0: 5f6c 656e 203d 2030 0a20 2020 2020 2020  _len = 0.       
-0001d6b0: 2073 656c 662e 6e75 6d5f 7365 7173 203d   self.num_seqs =
-0001d6c0: 2030 0a0a 2020 2020 6465 6620 5f5f 7374   0..    def __st
-0001d6d0: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
-0001d6e0: 2020 2069 6620 7365 6c66 2e6e 756d 5f73     if self.num_s
-0001d6f0: 6571 7320 3e20 303a 0a20 2020 2020 2020  eqs > 0:.       
-0001d700: 2020 2020 2069 6620 7365 6c66 2e6e 756d       if self.num
-0001d710: 5f73 6571 7320 3d3d 2073 656c 662e 746f  _seqs == self.to
-0001d720: 7461 6c5f 6461 7461 5f6c 656e 3a0a 2020  tal_data_len:.  
-0001d730: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0001d740: 7472 615f 7374 7220 3d20 2261 7667 5f64  tra_str = "avg_d
-0001d750: 6174 615f 6c65 6e3d 3122 0a20 2020 2020  ata_len=1".     
-0001d760: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001d770: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-0001d780: 7261 5f73 7472 203d 2022 746f 7461 6c5f  ra_str = "total_
-0001d790: 6461 7461 5f6c 656e 3d25 692c 2061 7667  data_len=%i, avg
-0001d7a0: 5f64 6174 615f 6c65 6e3d 2566 2220 2520  _data_len=%f" % 
-0001d7b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001d7c0: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
-0001d7d0: 5f64 6174 615f 6c65 6e2c 0a20 2020 2020  _data_len,.     
-0001d7e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001d7f0: 6c6f 6174 2873 656c 662e 746f 7461 6c5f  loat(self.total_
-0001d800: 6461 7461 5f6c 656e 2920 2f20 7365 6c66  data_len) / self
-0001d810: 2e6e 756d 5f73 6571 732c 0a20 2020 2020  .num_seqs,.     
-0001d820: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d830: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d840: 2253 7461 7473 286d 6561 6e3d 2573 2c20  "Stats(mean=%s, 
-0001d850: 7374 645f 6465 763d 2573 2c20 6d69 6e3d  std_dev=%s, min=
-0001d860: 2573 2c20 6d61 783d 2573 2c20 6e75 6d5f  %s, max=%s, num_
-0001d870: 7365 7173 3d25 692c 2025 7329 2220 2520  seqs=%i, %s)" % 
-0001d880: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001d890: 2020 7365 6c66 2e66 6f72 6d61 745f 7374    self.format_st
-0001d8a0: 7228 7365 6c66 2e67 6574 5f6d 6561 6e28  r(self.get_mean(
-0001d8b0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0001d8c0: 2020 2020 7365 6c66 2e66 6f72 6d61 745f      self.format_
-0001d8d0: 7374 7228 7365 6c66 2e67 6574 5f73 7464  str(self.get_std
-0001d8e0: 5f64 6576 2829 292c 0a20 2020 2020 2020  _dev()),.       
-0001d8f0: 2020 2020 2020 2020 2073 656c 662e 666f           self.fo
-0001d900: 726d 6174 5f73 7472 2873 656c 662e 6d69  rmat_str(self.mi
-0001d910: 6e29 2c0a 2020 2020 2020 2020 2020 2020  n),.            
-0001d920: 2020 2020 7365 6c66 2e66 6f72 6d61 745f      self.format_
-0001d930: 7374 7228 7365 6c66 2e6d 6178 292c 0a20  str(self.max),. 
-0001d940: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001d950: 656c 662e 6e75 6d5f 7365 7173 2c0a 2020  elf.num_seqs,.  
-0001d960: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0001d970: 7472 615f 7374 722c 0a20 2020 2020 2020  tra_str,.       
-0001d980: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-0001d990: 6574 7572 6e20 2253 7461 7473 286e 756d  eturn "Stats(num
-0001d9a0: 5f73 6571 733d 3029 220a 0a20 2020 2064  _seqs=0)"..    d
-0001d9b0: 6566 2063 6f6c 6c65 6374 2873 656c 662c  ef collect(self,
-0001d9c0: 2064 6174 6129 3a0a 2020 2020 2020 2020   data):.        
-0001d9d0: 2222 220a 2020 2020 2020 2020 3a70 6172  """.        :par
-0001d9e0: 616d 206e 756d 7079 2e6e 6461 7272 6179  am numpy.ndarray
-0001d9f0: 7c6c 6973 745b 696e 745d 7c6c 6973 745b  |list[int]|list[
-0001da00: 666c 6f61 745d 2064 6174 613a 2073 6861  float] data: sha
-0001da10: 7065 2028 7469 6d65 2c20 6469 6d29 206f  pe (time, dim) o
-0001da20: 7220 2874 696d 652c 290a 2020 2020 2020  r (time,).      
-0001da30: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
-0001da40: 706f 7274 206e 756d 7079 0a0a 2020 2020  port numpy..    
-0001da50: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0001da60: 6528 6461 7461 2c20 286c 6973 742c 2074  e(data, (list, t
-0001da70: 7570 6c65 2929 3a0a 2020 2020 2020 2020  uple)):.        
-0001da80: 2020 2020 6461 7461 203d 206e 756d 7079      data = numpy
-0001da90: 2e61 7272 6179 2864 6174 6129 0a20 2020  .array(data).   
-0001daa0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0001dab0: 7374 616e 6365 2864 6174 612c 206e 756d  stance(data, num
-0001dac0: 7079 2e6e 6461 7272 6179 290a 2020 2020  py.ndarray).    
-0001dad0: 2020 2020 6173 7365 7274 2064 6174 612e      assert data.
-0001dae0: 6e64 696d 203e 3d20 310a 2020 2020 2020  ndim >= 1.      
-0001daf0: 2020 6966 2064 6174 612e 7368 6170 655b    if data.shape[
-0001db00: 305d 203d 3d20 303a 0a20 2020 2020 2020  0] == 0:.       
-0001db10: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0001db20: 2020 2020 7365 6c66 2e6e 756d 5f73 6571      self.num_seq
-0001db30: 7320 2b3d 2031 0a20 2020 2020 2020 2064  s += 1.        d
-0001db40: 6174 615f 6d69 6e20 3d20 6e75 6d70 792e  ata_min = numpy.
-0001db50: 6d69 6e28 6461 7461 2c20 6178 6973 3d30  min(data, axis=0
-0001db60: 290a 2020 2020 2020 2020 6461 7461 5f6d  ).        data_m
-0001db70: 6178 203d 206e 756d 7079 2e6d 6178 2864  ax = numpy.max(d
-0001db80: 6174 612c 2061 7869 733d 3029 0a20 2020  ata, axis=0).   
-0001db90: 2020 2020 2069 6620 7365 6c66 2e6d 696e       if self.min
-0001dba0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001dbb0: 2020 2020 2020 7365 6c66 2e6d 696e 203d        self.min =
-0001dbc0: 2064 6174 615f 6d69 6e0a 2020 2020 2020   data_min.      
-0001dbd0: 2020 2020 2020 7365 6c66 2e6d 6178 203d        self.max =
-0001dbe0: 2064 6174 615f 6d61 780a 2020 2020 2020   data_max.      
-0001dbf0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001dc00: 2020 2020 7365 6c66 2e6d 696e 203d 206e      self.min = n
-0001dc10: 756d 7079 2e6d 696e 696d 756d 2873 656c  umpy.minimum(sel
-0001dc20: 662e 6d69 6e2c 2064 6174 615f 6d69 6e29  f.min, data_min)
-0001dc30: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001dc40: 662e 6d61 7820 3d20 6e75 6d70 792e 6d61  f.max = numpy.ma
-0001dc50: 7869 6d75 6d28 7365 6c66 2e6d 6178 2c20  ximum(self.max, 
-0001dc60: 6461 7461 5f6d 6178 290a 2020 2020 2020  data_max).      
-0001dc70: 2020 6e65 775f 746f 7461 6c5f 6461 7461    new_total_data
-0001dc80: 5f6c 656e 203d 2073 656c 662e 746f 7461  _len = self.tota
-0001dc90: 6c5f 6461 7461 5f6c 656e 202b 2064 6174  l_data_len + dat
-0001dca0: 612e 7368 6170 655b 305d 0a20 2020 2020  a.shape[0].     
-0001dcb0: 2020 206d 6561 6e5f 6469 6666 203d 206e     mean_diff = n
-0001dcc0: 756d 7079 2e6d 6561 6e28 6461 7461 2c20  umpy.mean(data, 
-0001dcd0: 6178 6973 3d30 2920 2d20 7365 6c66 2e6d  axis=0) - self.m
-0001dce0: 6561 6e0a 2020 2020 2020 2020 6d5f 6120  ean.        m_a 
-0001dcf0: 3d20 7365 6c66 2e76 6172 202a 2073 656c  = self.var * sel
-0001dd00: 662e 746f 7461 6c5f 6461 7461 5f6c 656e  f.total_data_len
-0001dd10: 0a20 2020 2020 2020 206d 5f62 203d 206e  .        m_b = n
-0001dd20: 756d 7079 2e76 6172 2864 6174 612c 2061  umpy.var(data, a
-0001dd30: 7869 733d 3029 202a 2064 6174 612e 7368  xis=0) * data.sh
-0001dd40: 6170 655b 305d 0a20 2020 2020 2020 206d  ape[0].        m
-0001dd50: 3220 3d20 6d5f 6120 2b20 6d5f 6220 2b20  2 = m_a + m_b + 
-0001dd60: 6d65 616e 5f64 6966 662a 2a32 202a 2073  mean_diff**2 * s
-0001dd70: 656c 662e 746f 7461 6c5f 6461 7461 5f6c  elf.total_data_l
-0001dd80: 656e 202a 2064 6174 612e 7368 6170 655b  en * data.shape[
-0001dd90: 305d 202f 206e 6577 5f74 6f74 616c 5f64  0] / new_total_d
-0001dda0: 6174 615f 6c65 6e0a 2020 2020 2020 2020  ata_len.        
-0001ddb0: 7365 6c66 2e76 6172 203d 206d 3220 2f20  self.var = m2 / 
-0001ddc0: 6e65 775f 746f 7461 6c5f 6461 7461 5f6c  new_total_data_l
-0001ddd0: 656e 0a20 2020 2020 2020 2064 6174 615f  en.        data_
-0001dde0: 7375 6d20 3d20 6e75 6d70 792e 7375 6d28  sum = numpy.sum(
-0001ddf0: 6461 7461 2c20 6178 6973 3d30 290a 2020  data, axis=0).  
-0001de00: 2020 2020 2020 6465 6c74 6120 3d20 6461        delta = da
-0001de10: 7461 5f73 756d 202d 2073 656c 662e 6d65  ta_sum - self.me
-0001de20: 616e 202a 2064 6174 612e 7368 6170 655b  an * data.shape[
-0001de30: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
-0001de40: 6d65 616e 202b 3d20 6465 6c74 6120 2f20  mean += delta / 
-0001de50: 6e65 775f 746f 7461 6c5f 6461 7461 5f6c  new_total_data_l
-0001de60: 656e 0a20 2020 2020 2020 2064 656c 7461  en.        delta
-0001de70: 5f73 7120 3d20 6e75 6d70 792e 7375 6d28  _sq = numpy.sum(
-0001de80: 6461 7461 202a 2064 6174 612c 2061 7869  data * data, axi
-0001de90: 733d 3029 202d 2073 656c 662e 6d65 616e  s=0) - self.mean
-0001dea0: 5f73 7120 2a20 6461 7461 2e73 6861 7065  _sq * data.shape
-0001deb0: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-0001dec0: 2e6d 6561 6e5f 7371 202b 3d20 6465 6c74  .mean_sq += delt
-0001ded0: 615f 7371 202f 206e 6577 5f74 6f74 616c  a_sq / new_total
-0001dee0: 5f64 6174 615f 6c65 6e0a 2020 2020 2020  _data_len.      
-0001def0: 2020 7365 6c66 2e74 6f74 616c 5f64 6174    self.total_dat
-0001df00: 615f 6c65 6e20 3d20 6e65 775f 746f 7461  a_len = new_tota
-0001df10: 6c5f 6461 7461 5f6c 656e 0a0a 2020 2020  l_data_len..    
-0001df20: 6465 6620 6765 745f 6d65 616e 2873 656c  def get_mean(sel
-0001df30: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-0001df40: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0001df50: 206d 6561 6e2c 2073 6861 7065 2028 6469   mean, shape (di
-0001df60: 6d2c 290a 2020 2020 2020 2020 3a72 7479  m,).        :rty
-0001df70: 7065 3a20 6e75 6d70 792e 6e64 6172 7261  pe: numpy.ndarra
-0001df80: 790a 2020 2020 2020 2020 2222 220a 2020  y.        """.  
-0001df90: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0001dfa0: 662e 6e75 6d5f 7365 7173 203e 2030 0a20  f.num_seqs > 0. 
-0001dfb0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001dfc0: 6c66 2e6d 6561 6e0a 0a20 2020 2064 6566  lf.mean..    def
-0001dfd0: 2067 6574 5f73 7464 5f64 6576 2873 656c   get_std_dev(sel
-0001dfe0: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-0001dff0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0001e000: 2073 7464 2064 6576 2c20 7368 6170 6520   std dev, shape 
-0001e010: 2864 696d 2c29 0a20 2020 2020 2020 203a  (dim,).        :
-0001e020: 7274 7970 653a 206e 756d 7079 2e6e 6461  rtype: numpy.nda
-0001e030: 7272 6179 0a20 2020 2020 2020 2022 2222  rray.        """
-0001e040: 0a20 2020 2020 2020 2069 6d70 6f72 7420  .        import 
-0001e050: 6e75 6d70 790a 0a20 2020 2020 2020 2061  numpy..        a
-0001e060: 7373 6572 7420 7365 6c66 2e6e 756d 5f73  ssert self.num_s
-0001e070: 6571 7320 3e20 300a 2020 2020 2020 2020  eqs > 0.        
-0001e080: 7265 7475 726e 206e 756d 7079 2e73 7172  return numpy.sqr
-0001e090: 7428 7365 6c66 2e76 6172 290a 2020 2020  t(self.var).    
-0001e0a0: 2020 2020 2320 7265 7475 726e 206e 756d      # return num
-0001e0b0: 7079 2e73 7172 7428 7365 6c66 2e6d 6561  py.sqrt(self.mea
-0001e0c0: 6e5f 7371 202d 2073 656c 662e 6d65 616e  n_sq - self.mean
-0001e0d0: 202a 2073 656c 662e 6d65 616e 290a 0a20   * self.mean).. 
-0001e0e0: 2020 2064 6566 2064 756d 7028 7365 6c66     def dump(self
-0001e0f0: 2c20 6f75 7470 7574 5f66 696c 655f 7072  , output_file_pr
-0001e100: 6566 6978 3d4e 6f6e 652c 2073 7472 6561  efix=None, strea
-0001e110: 6d3d 4e6f 6e65 2c20 7374 7265 616d 5f70  m=None, stream_p
-0001e120: 7265 6669 783d 2222 293a 0a20 2020 2020  refix=""):.     
-0001e130: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
-0001e140: 7061 7261 6d20 7374 727c 4e6f 6e65 206f  param str|None o
-0001e150: 7574 7075 745f 6669 6c65 5f70 7265 6669  utput_file_prefi
-0001e160: 783a 2069 6620 6769 7665 6e2c 2077 696c  x: if given, wil
-0001e170: 6c20 6e75 6d70 792e 7361 7665 7478 7420  l numpy.savetxt 
-0001e180: 6d65 616e 7c73 7464 5f64 6576 2074 6f20  mean|std_dev to 
-0001e190: 6469 736b 0a20 2020 2020 2020 203a 7061  disk.        :pa
-0001e1a0: 7261 6d20 7374 7220 7374 7265 616d 5f70  ram str stream_p
-0001e1b0: 7265 6669 783a 0a20 2020 2020 2020 203a  refix:.        :
-0001e1c0: 7061 7261 6d20 696f 2e54 6578 7449 4f42  param io.TextIOB
-0001e1d0: 6173 6520 7374 7265 616d 3a20 7379 732e  ase stream: sys.
-0001e1e0: 7374 646f 7574 2062 7920 6465 6661 756c  stdout by defaul
-0001e1f0: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
-0001e200: 2020 2020 2020 6966 2073 7472 6561 6d20        if stream 
-0001e210: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001e220: 2020 2020 2073 7472 6561 6d20 3d20 7379       stream = sy
-0001e230: 732e 7374 646f 7574 0a20 2020 2020 2020  s.stdout.       
-0001e240: 2069 6d70 6f72 7420 6e75 6d70 790a 0a20   import numpy.. 
-0001e250: 2020 2020 2020 2070 7269 6e74 2822 2573         print("%s
-0001e260: 5374 6174 733a 2220 2520 7374 7265 616d  Stats:" % stream
-0001e270: 5f70 7265 6669 782c 2066 696c 653d 7374  _prefix, file=st
-0001e280: 7265 616d 290a 2020 2020 2020 2020 6966  ream).        if
-0001e290: 2073 656c 662e 6e75 6d5f 7365 7173 2021   self.num_seqs !
-0001e2a0: 3d20 7365 6c66 2e74 6f74 616c 5f64 6174  = self.total_dat
-0001e2b0: 615f 6c65 6e3a 0a20 2020 2020 2020 2020  a_len:.         
-0001e2c0: 2020 2070 7269 6e74 280a 2020 2020 2020     print(.      
-0001e2d0: 2020 2020 2020 2020 2020 2220 2025 6920            "  %i 
-0001e2e0: 7365 7173 2c20 2569 2074 6f74 616c 2066  seqs, %i total f
-0001e2f0: 7261 6d65 732c 2025 6620 6176 6572 6167  rames, %f averag
-0001e300: 6520 6672 616d 6573 220a 2020 2020 2020  e frames".      
-0001e310: 2020 2020 2020 2020 2020 2520 2873 656c            % (sel
-0001e320: 662e 6e75 6d5f 7365 7173 2c20 7365 6c66  f.num_seqs, self
-0001e330: 2e74 6f74 616c 5f64 6174 615f 6c65 6e2c  .total_data_len,
-0001e340: 2073 656c 662e 746f 7461 6c5f 6461 7461   self.total_data
-0001e350: 5f6c 656e 202f 2066 6c6f 6174 2873 656c  _len / float(sel
-0001e360: 662e 6e75 6d5f 7365 7173 2929 2c0a 2020  f.num_seqs)),.  
-0001e370: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0001e380: 6c65 3d73 7472 6561 6d2c 0a20 2020 2020  le=stream,.     
-0001e390: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001e3a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001e3b0: 2020 2070 7269 6e74 2822 2020 2569 2073     print("  %i s
-0001e3c0: 6571 7322 2025 2028 7365 6c66 2e6e 756d  eqs" % (self.num
-0001e3d0: 5f73 6571 732c 292c 2066 696c 653d 7374  _seqs,), file=st
-0001e3e0: 7265 616d 290a 2020 2020 2020 2020 6966  ream).        if
-0001e3f0: 2073 656c 662e 6e75 6d5f 7365 7173 203e   self.num_seqs >
-0001e400: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0001e410: 7072 696e 7428 2220 204d 6561 6e3a 2025  print("  Mean: %
-0001e420: 7322 2025 2028 7365 6c66 2e66 6f72 6d61  s" % (self.forma
-0001e430: 745f 7374 7228 7365 6c66 2e67 6574 5f6d  t_str(self.get_m
-0001e440: 6561 6e28 2929 2c29 2c20 6669 6c65 3d73  ean()),), file=s
-0001e450: 7472 6561 6d29 0a20 2020 2020 2020 2020  tream).         
-0001e460: 2020 2070 7269 6e74 2822 2020 5374 6420     print("  Std 
-0001e470: 6465 763a 2025 7322 2025 2028 7365 6c66  dev: %s" % (self
-0001e480: 2e66 6f72 6d61 745f 7374 7228 7365 6c66  .format_str(self
-0001e490: 2e67 6574 5f73 7464 5f64 6576 2829 292c  .get_std_dev()),
-0001e4a0: 292c 2066 696c 653d 7374 7265 616d 290a  ), file=stream).
-0001e4b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0001e4c0: 7428 2220 204d 696e 2f6d 6178 3a20 2573  t("  Min/max: %s
-0001e4d0: 202f 2025 7322 2025 2028 7365 6c66 2e66   / %s" % (self.f
-0001e4e0: 6f72 6d61 745f 7374 7228 7365 6c66 2e6d  ormat_str(self.m
-0001e4f0: 696e 292c 2073 656c 662e 666f 726d 6174  in), self.format
-0001e500: 5f73 7472 2873 656c 662e 6d61 7829 292c  _str(self.max)),
-0001e510: 2066 696c 653d 7374 7265 616d 290a 2020   file=stream).  
-0001e520: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-0001e530: 7428 2253 7464 2064 6576 2028 6e61 6976  t("Std dev (naiv
-0001e540: 6529 3a20 2573 2220 2520 6e75 6d70 792e  e): %s" % numpy.
-0001e550: 7371 7274 2873 656c 662e 6d65 616e 5f73  sqrt(self.mean_s
-0001e560: 7120 2d20 7365 6c66 2e6d 6561 6e20 2a20  q - self.mean * 
-0001e570: 7365 6c66 2e6d 6561 6e29 2c20 6669 6c65  self.mean), file
-0001e580: 3d73 7472 6561 6d29 0a20 2020 2020 2020  =stream).       
-0001e590: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001e5a0: 2020 2070 7269 6e74 2822 2020 284e 6f20     print("  (No 
-0001e5b0: 6461 7461 2922 2c20 6669 6c65 3d73 7472  data)", file=str
-0001e5c0: 6561 6d29 0a20 2020 2020 2020 2069 6620  eam).        if 
-0001e5d0: 6f75 7470 7574 5f66 696c 655f 7072 6566  output_file_pref
-0001e5e0: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-0001e5f0: 6173 7365 7274 2073 656c 662e 6e75 6d5f  assert self.num_
-0001e600: 7365 7173 203e 2030 2c20 2263 616e 6e6f  seqs > 0, "canno
-0001e610: 7420 6475 6d70 2073 7461 7473 2077 6974  t dump stats wit
-0001e620: 686f 7574 2061 6e79 2064 6174 6122 0a20  hout any data". 
-0001e630: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0001e640: 2822 2020 5772 6974 6520 6d65 616e 2f73  ("  Write mean/s
-0001e650: 7464 2d64 6576 2074 6f20 2573 2e28 6d65  td-dev to %s.(me
-0001e660: 616e 7c73 7464 5f64 6576 292e 7478 742e  an|std_dev).txt.
-0001e670: 2220 2520 286f 7574 7075 745f 6669 6c65  " % (output_file
-0001e680: 5f70 7265 6669 782c 292c 2066 696c 653d  _prefix,), file=
-0001e690: 7374 7265 616d 290a 2020 2020 2020 2020  stream).        
-0001e6a0: 2020 2020 6e75 6d70 792e 7361 7665 7478      numpy.savetx
-0001e6b0: 7428 2225 732e 6d65 616e 2e74 7874 2220  t("%s.mean.txt" 
-0001e6c0: 2520 6f75 7470 7574 5f66 696c 655f 7072  % output_file_pr
-0001e6d0: 6566 6978 2c20 7365 6c66 2e67 6574 5f6d  efix, self.get_m
-0001e6e0: 6561 6e28 2929 0a20 2020 2020 2020 2020  ean()).         
-0001e6f0: 2020 206e 756d 7079 2e73 6176 6574 7874     numpy.savetxt
-0001e700: 2822 2573 2e73 7464 5f64 6576 2e74 7874  ("%s.std_dev.txt
-0001e710: 2220 2520 6f75 7470 7574 5f66 696c 655f  " % output_file_
-0001e720: 7072 6566 6978 2c20 7365 6c66 2e67 6574  prefix, self.get
-0001e730: 5f73 7464 5f64 6576 2829 290a 0a0a 6465  _std_dev())...de
-0001e740: 6620 6973 5f6e 616d 6564 7475 706c 6528  f is_namedtuple(
-0001e750: 636c 7329 3a0a 2020 2020 2222 220a 2020  cls):.    """.  
-0001e760: 2020 3a70 6172 616d 2054 2063 6c73 3a20    :param T cls: 
-0001e770: 7475 706c 652c 206c 6973 7420 6f72 206e  tuple, list or n
-0001e780: 616d 6564 7475 706c 6520 7479 7065 0a20  amedtuple type. 
-0001e790: 2020 203a 7265 7475 726e 3a20 7768 6574     :return: whet
-0001e7a0: 6865 7220 636c 7320 6973 2061 206e 616d  her cls is a nam
-0001e7b0: 6564 7475 706c 6520 7479 7065 0a20 2020  edtuple type.   
-0001e7c0: 203a 7274 7970 653a 2062 6f6f 6c0a 2020   :rtype: bool.  
-0001e7d0: 2020 2222 220a 2020 2020 7265 7475 726e    """.    return
-0001e7e0: 2069 7373 7562 636c 6173 7328 636c 732c   issubclass(cls,
-0001e7f0: 2074 7570 6c65 2920 616e 6420 636c 7320   tuple) and cls 
-0001e800: 6973 206e 6f74 2074 7570 6c65 0a0a 0a64  is not tuple...d
-0001e810: 6566 206d 616b 655f 7365 715f 6f66 5f74  ef make_seq_of_t
-0001e820: 7970 6528 636c 732c 2073 6571 293a 0a20  ype(cls, seq):. 
-0001e830: 2020 2022 2222 0a20 2020 203a 7061 7261     """.    :para
-0001e840: 6d20 7479 7065 5b54 5d20 636c 733a 2065  m type[T] cls: e
-0001e850: 2e67 2e20 7475 706c 652c 206c 6973 7420  .g. tuple, list 
-0001e860: 6f72 206e 616d 6564 7475 706c 650a 2020  or namedtuple.  
-0001e870: 2020 3a70 6172 616d 206c 6973 747c 7475    :param list|tu
-0001e880: 706c 657c 5420 7365 713a 0a20 2020 203a  ple|T seq:.    :
-0001e890: 7265 7475 726e 3a20 636c 7328 7365 7129  return: cls(seq)
-0001e8a0: 206f 7220 636c 7328 2a73 6571 290a 2020   or cls(*seq).  
-0001e8b0: 2020 3a72 7479 7065 3a20 547c 6c69 7374    :rtype: T|list
-0001e8c0: 7c74 7570 6c65 0a20 2020 2022 2222 0a20  |tuple.    """. 
-0001e8d0: 2020 2061 7373 6572 7420 6973 7375 6263     assert issubc
-0001e8e0: 6c61 7373 2863 6c73 2c20 286c 6973 742c  lass(cls, (list,
-0001e8f0: 2074 7570 6c65 2929 0a20 2020 2069 6620   tuple)).    if 
-0001e900: 6973 5f6e 616d 6564 7475 706c 6528 636c  is_namedtuple(cl
-0001e910: 7329 3a0a 2020 2020 2020 2020 7265 7475  s):.        retu
-0001e920: 726e 2063 6c73 282a 7365 7129 2020 2320  rn cls(*seq)  # 
-0001e930: 6e6f 7161 0a20 2020 2072 6574 7572 6e20  noqa.    return 
-0001e940: 636c 7328 7365 7129 2020 2320 6e6f 7161  cls(seq)  # noqa
-0001e950: 0a0a 0a64 6566 2065 6e73 7572 655f 6c69  ...def ensure_li
-0001e960: 7374 5f6f 665f 7479 7065 286c 732c 2074  st_of_type(ls, t
-0001e970: 7970 655f 293a 0a20 2020 2022 2222 0a20  ype_):.    """. 
-0001e980: 2020 203a 7061 7261 6d20 6c69 7374 206c     :param list l
-0001e990: 733a 0a20 2020 203a 7061 7261 6d20 2828  s:.    :param ((
-0001e9a0: 292d 3e54 297c 7479 7065 5b54 5d20 7479  )->T)|type[T] ty
-0001e9b0: 7065 5f3a 2074 7970 6520 6f66 2069 6e73  pe_: type of ins
-0001e9c0: 7461 6e63 6573 206f 6620 606c 7360 2e0a  tances of `ls`..
-0001e9d0: 2020 2020 2020 4e6f 7465 2074 6865 2073        Note the s
-0001e9e0: 7472 616e 6765 2074 7970 6520 6865 7265  trange type here
-0001e9f0: 2069 6e20 7468 6520 646f 6373 7472 696e   in the docstrin
-0001ea00: 6720 6973 2064 7565 2074 6f20 736f 6d65  g is due to some
-0001ea10: 2050 7943 6861 726d 2074 7970 6520 696e   PyCharm type in
-0001ea20: 6665 7265 6e63 6520 7072 6f62 6c65 6d73  ference problems
-0001ea30: 0a20 2020 2020 2028 6874 7470 733a 2f2f  .      (https://
-0001ea40: 796f 7574 7261 636b 2e6a 6574 6272 6169  youtrack.jetbrai
-0001ea50: 6e73 2e63 6f6d 2f69 7373 7565 2f50 592d  ns.com/issue/PY-
-0001ea60: 3530 3832 3829 2e0a 2020 2020 3a72 7479  50828)..    :rty
-0001ea70: 7065 3a20 6c69 7374 5b54 5d0a 2020 2020  pe: list[T].    
-0001ea80: 2222 220a 2020 2020 6173 7365 7274 2061  """.    assert a
-0001ea90: 6c6c 2869 7369 6e73 7461 6e63 6528 656c  ll(isinstance(el
-0001eaa0: 656d 2c20 7479 7065 5f29 2066 6f72 2065  em, type_) for e
-0001eab0: 6c65 6d20 696e 206c 7329 0a20 2020 2072  lem in ls).    r
-0001eac0: 6574 7572 6e20 6c73 0a0a 0a64 6566 205f  eturn ls...def _
-0001ead0: 6765 745f 6e67 7261 6d73 2873 6567 6d65  get_ngrams(segme
-0001eae0: 6e74 2c20 6d61 785f 6f72 6465 7229 3a0a  nt, max_order):.
-0001eaf0: 2020 2020 2222 2245 7874 7261 6374 7320      """Extracts 
-0001eb00: 616c 6c20 6e2d 6772 616d 7320 7570 746f  all n-grams upto
-0001eb10: 2061 2067 6976 656e 206d 6178 696d 756d   a given maximum
-0001eb20: 206f 7264 6572 2066 726f 6d20 616e 2069   order from an i
-0001eb30: 6e70 7574 2073 6567 6d65 6e74 2e0a 2020  nput segment..  
-0001eb40: 2020 436f 6465 2061 6461 7074 6564 2066    Code adapted f
-0001eb50: 726f 6d20 476f 6f67 6c65 2054 656e 736f  rom Google Tenso
-0001eb60: 7232 5465 6e73 6f72 2e0a 0a20 2020 2041  r2Tensor...    A
-0001eb70: 7267 733a 0a20 2020 2020 2073 6567 6d65  rgs:.      segme
-0001eb80: 6e74 2028 6c69 7374 5b69 6e74 5d7c 6c69  nt (list[int]|li
-0001eb90: 7374 5b73 7472 5d29 3a20 7465 7874 2073  st[str]): text s
-0001eba0: 6567 6d65 6e74 2066 726f 6d20 7768 6963  egment from whic
-0001ebb0: 6820 6e2d 6772 616d 7320 7769 6c6c 2062  h n-grams will b
-0001ebc0: 6520 6578 7472 6163 7465 642e 0a20 2020  e extracted..   
-0001ebd0: 2020 206d 6178 5f6f 7264 6572 2028 696e     max_order (in
-0001ebe0: 7429 3a20 6d61 7869 6d75 6d20 6c65 6e67  t): maximum leng
-0001ebf0: 7468 2069 6e20 746f 6b65 6e73 206f 6620  th in tokens of 
-0001ec00: 7468 6520 6e2d 6772 616d 7320 7265 7475  the n-grams retu
-0001ec10: 726e 6564 2062 7920 7468 6973 0a20 2020  rned by this.   
-0001ec20: 2020 2020 2020 206d 6574 686f 6473 2e0a         methods..
-0001ec30: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0001ec40: 2020 2020 5468 6520 436f 756e 7465 7220      The Counter 
-0001ec50: 636f 6e74 6169 6e69 6e67 2061 6c6c 206e  containing all n
-0001ec60: 2d67 7261 6d73 2075 7074 6f20 6d61 785f  -grams upto max_
-0001ec70: 6f72 6465 7220 696e 2073 6567 6d65 6e74  order in segment
-0001ec80: 0a20 2020 2020 2077 6974 6820 6120 636f  .      with a co
-0001ec90: 756e 7420 6f66 2068 6f77 206d 616e 7920  unt of how many 
-0001eca0: 7469 6d65 7320 6561 6368 206e 2d67 7261  times each n-gra
-0001ecb0: 6d20 6f63 6375 7272 6564 2e0a 2020 2020  m occurred..    
-0001ecc0: 2222 220a 2020 2020 696d 706f 7274 2063  """.    import c
-0001ecd0: 6f6c 6c65 6374 696f 6e73 0a0a 2020 2020  ollections..    
-0001ece0: 6e67 7261 6d5f 636f 756e 7473 203d 2063  ngram_counts = c
-0001ecf0: 6f6c 6c65 6374 696f 6e73 2e43 6f75 6e74  ollections.Count
-0001ed00: 6572 2829 0a20 2020 2066 6f72 206f 7264  er().    for ord
-0001ed10: 6572 2069 6e20 7261 6e67 6528 312c 206d  er in range(1, m
-0001ed20: 6178 5f6f 7264 6572 202b 2031 293a 0a20  ax_order + 1):. 
-0001ed30: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0001ed40: 7261 6e67 6528 302c 206c 656e 2873 6567  range(0, len(seg
-0001ed50: 6d65 6e74 2920 2d20 6f72 6465 7220 2b20  ment) - order + 
-0001ed60: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
-0001ed70: 6e67 7261 6d20 3d20 7475 706c 6528 7365  ngram = tuple(se
-0001ed80: 676d 656e 745b 6920 3a20 6920 2b20 6f72  gment[i : i + or
-0001ed90: 6465 725d 290a 2020 2020 2020 2020 2020  der]).          
-0001eda0: 2020 6e67 7261 6d5f 636f 756e 7473 5b6e    ngram_counts[n
-0001edb0: 6772 616d 5d20 2b3d 2031 0a20 2020 2072  gram] += 1.    r
-0001edc0: 6574 7572 6e20 6e67 7261 6d5f 636f 756e  eturn ngram_coun
-0001edd0: 7473 0a0a 0a64 6566 2063 6f6d 7075 7465  ts...def compute
-0001ede0: 5f62 6c65 7528 7265 6665 7265 6e63 655f  _bleu(reference_
-0001edf0: 636f 7270 7573 2c20 7472 616e 736c 6174  corpus, translat
-0001ee00: 696f 6e5f 636f 7270 7573 2c20 6d61 785f  ion_corpus, max_
-0001ee10: 6f72 6465 723d 342c 2075 7365 5f62 703d  order=4, use_bp=
-0001ee20: 5472 7565 293a 0a20 2020 2022 2222 436f  True):.    """Co
-0001ee30: 6d70 7574 6573 2042 4c45 5520 7363 6f72  mputes BLEU scor
-0001ee40: 6520 6f66 2074 7261 6e73 6c61 7465 6420  e of translated 
-0001ee50: 7365 676d 656e 7473 2061 6761 696e 7374  segments against
-0001ee60: 206f 6e65 206f 7220 6d6f 7265 2072 6566   one or more ref
-0001ee70: 6572 656e 6365 732e 0a20 2020 2043 6f64  erences..    Cod
-0001ee80: 6520 6164 6170 7465 6420 6672 6f6d 2047  e adapted from G
-0001ee90: 6f6f 676c 6520 5465 6e73 6f72 3254 656e  oogle Tensor2Ten
-0001eea0: 736f 722e 0a0a 2020 2020 4172 6773 3a0a  sor...    Args:.
-0001eeb0: 2020 2020 2020 7265 6665 7265 6e63 655f        reference_
-0001eec0: 636f 7270 7573 2028 6c69 7374 5b6c 6973  corpus (list[lis
-0001eed0: 745b 696e 745d 7c6c 6973 745b 7374 725d  t[int]|list[str]
-0001eee0: 5d29 3a20 6c69 7374 206f 6620 7265 6665  ]): list of refe
-0001eef0: 7265 6e63 6573 2066 6f72 2065 6163 6820  rences for each 
-0001ef00: 7472 616e 736c 6174 696f 6e2e 2045 6163  translation. Eac
-0001ef10: 680a 2020 2020 2020 2020 2020 7265 6665  h.          refe
-0001ef20: 7265 6e63 6520 7368 6f75 6c64 2062 6520  rence should be 
-0001ef30: 746f 6b65 6e69 7a65 6420 696e 746f 2061  tokenized into a
-0001ef40: 206c 6973 7420 6f66 2074 6f6b 656e 732e   list of tokens.
-0001ef50: 0a20 2020 2020 2074 7261 6e73 6c61 7469  .      translati
-0001ef60: 6f6e 5f63 6f72 7075 7320 286c 6973 745b  on_corpus (list[
-0001ef70: 6c69 7374 5b69 6e74 5d7c 6c69 7374 5b73  list[int]|list[s
-0001ef80: 7472 5d5d 293a 206c 6973 7420 6f66 2074  tr]]): list of t
-0001ef90: 7261 6e73 6c61 7469 6f6e 7320 746f 2073  ranslations to s
-0001efa0: 636f 7265 2e20 4561 6368 2074 7261 6e73  core. Each trans
-0001efb0: 6c61 7469 6f6e 0a20 2020 2020 2020 2020  lation.         
-0001efc0: 2073 686f 756c 6420 6265 2074 6f6b 656e   should be token
-0001efd0: 697a 6564 2069 6e74 6f20 6120 6c69 7374  ized into a list
-0001efe0: 206f 6620 746f 6b65 6e73 2e0a 2020 2020   of tokens..    
-0001eff0: 2020 6d61 785f 6f72 6465 7220 2869 6e74    max_order (int
-0001f000: 293a 204d 6178 696d 756d 206e 2d67 7261  ): Maximum n-gra
-0001f010: 6d20 6f72 6465 7220 746f 2075 7365 2077  m order to use w
-0001f020: 6865 6e20 636f 6d70 7574 696e 6720 424c  hen computing BL
-0001f030: 4555 2073 636f 7265 2e0a 2020 2020 2020  EU score..      
-0001f040: 7573 655f 6270 2028 626f 6f6c 293a 2062  use_bp (bool): b
-0001f050: 6f6f 6c65 616e 2c20 7768 6574 6865 7220  oolean, whether 
-0001f060: 746f 2061 7070 6c79 2062 7265 7669 7479  to apply brevity
-0001f070: 2070 656e 616c 7479 2e0a 0a20 2020 2052   penalty...    R
-0001f080: 6574 7572 6e73 3a0a 2020 2020 2020 424c  eturns:.      BL
-0001f090: 4555 2073 636f 7265 2e0a 2020 2020 2222  EU score..    ""
-0001f0a0: 220a 2020 2020 696d 706f 7274 206d 6174  ".    import mat
-0001f0b0: 680a 0a20 2020 2072 6566 6572 656e 6365  h..    reference
-0001f0c0: 5f6c 656e 6774 6820 3d20 300a 2020 2020  _length = 0.    
-0001f0d0: 7472 616e 736c 6174 696f 6e5f 6c65 6e67  translation_leng
-0001f0e0: 7468 203d 2030 0a20 2020 2062 7020 3d20  th = 0.    bp = 
-0001f0f0: 312e 300a 2020 2020 6765 6f5f 6d65 616e  1.0.    geo_mean
-0001f100: 203d 2030 0a0a 2020 2020 6d61 7463 6865   = 0..    matche
-0001f110: 735f 6279 5f6f 7264 6572 203d 205b 305d  s_by_order = [0]
-0001f120: 202a 206d 6178 5f6f 7264 6572 0a20 2020   * max_order.   
-0001f130: 2070 6f73 7369 626c 655f 6d61 7463 6865   possible_matche
-0001f140: 735f 6279 5f6f 7264 6572 203d 205b 305d  s_by_order = [0]
-0001f150: 202a 206d 6178 5f6f 7264 6572 0a0a 2020   * max_order..  
-0001f160: 2020 666f 7220 7265 6665 7265 6e63 6573    for references
-0001f170: 2c20 7472 616e 736c 6174 696f 6e73 2069  , translations i
-0001f180: 6e20 7a69 7028 7265 6665 7265 6e63 655f  n zip(reference_
-0001f190: 636f 7270 7573 2c20 7472 616e 736c 6174  corpus, translat
-0001f1a0: 696f 6e5f 636f 7270 7573 293a 0a20 2020  ion_corpus):.   
-0001f1b0: 2020 2020 2072 6566 6572 656e 6365 5f6c       reference_l
-0001f1c0: 656e 6774 6820 2b3d 206c 656e 2872 6566  ength += len(ref
-0001f1d0: 6572 656e 6365 7329 0a20 2020 2020 2020  erences).       
-0001f1e0: 2074 7261 6e73 6c61 7469 6f6e 5f6c 656e   translation_len
-0001f1f0: 6774 6820 2b3d 206c 656e 2874 7261 6e73  gth += len(trans
-0001f200: 6c61 7469 6f6e 7329 0a20 2020 2020 2020  lations).       
-0001f210: 2072 6566 5f6e 6772 616d 5f63 6f75 6e74   ref_ngram_count
-0001f220: 7320 3d20 5f67 6574 5f6e 6772 616d 7328  s = _get_ngrams(
-0001f230: 7265 6665 7265 6e63 6573 2c20 6d61 785f  references, max_
-0001f240: 6f72 6465 7229 0a20 2020 2020 2020 2074  order).        t
-0001f250: 7261 6e73 6c61 7469 6f6e 5f6e 6772 616d  ranslation_ngram
-0001f260: 5f63 6f75 6e74 7320 3d20 5f67 6574 5f6e  _counts = _get_n
-0001f270: 6772 616d 7328 7472 616e 736c 6174 696f  grams(translatio
-0001f280: 6e73 2c20 6d61 785f 6f72 6465 7229 0a0a  ns, max_order)..
-0001f290: 2020 2020 2020 2020 6f76 6572 6c61 7020          overlap 
-0001f2a0: 3d20 7b6e 6772 616d 3a20 6d69 6e28 636f  = {ngram: min(co
-0001f2b0: 756e 742c 2074 7261 6e73 6c61 7469 6f6e  unt, translation
-0001f2c0: 5f6e 6772 616d 5f63 6f75 6e74 735b 6e67  _ngram_counts[ng
-0001f2d0: 7261 6d5d 2920 666f 7220 6e67 7261 6d2c  ram]) for ngram,
-0001f2e0: 2063 6f75 6e74 2069 6e20 7265 665f 6e67   count in ref_ng
-0001f2f0: 7261 6d5f 636f 756e 7473 2e69 7465 6d73  ram_counts.items
-0001f300: 2829 7d0a 0a20 2020 2020 2020 2066 6f72  ()}..        for
-0001f310: 206e 6772 616d 2069 6e20 6f76 6572 6c61   ngram in overla
-0001f320: 703a 0a20 2020 2020 2020 2020 2020 206d  p:.            m
-0001f330: 6174 6368 6573 5f62 795f 6f72 6465 725b  atches_by_order[
-0001f340: 6c65 6e28 6e67 7261 6d29 202d 2031 5d20  len(ngram) - 1] 
-0001f350: 2b3d 206f 7665 726c 6170 5b6e 6772 616d  += overlap[ngram
-0001f360: 5d0a 2020 2020 2020 2020 666f 7220 6e67  ].        for ng
-0001f370: 7261 6d20 696e 2074 7261 6e73 6c61 7469  ram in translati
-0001f380: 6f6e 5f6e 6772 616d 5f63 6f75 6e74 733a  on_ngram_counts:
-0001f390: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
-0001f3a0: 7369 626c 655f 6d61 7463 6865 735f 6279  sible_matches_by
-0001f3b0: 5f6f 7264 6572 5b6c 656e 286e 6772 616d  _order[len(ngram
-0001f3c0: 2920 2d20 315d 202b 3d20 7472 616e 736c  ) - 1] += transl
-0001f3d0: 6174 696f 6e5f 6e67 7261 6d5f 636f 756e  ation_ngram_coun
-0001f3e0: 7473 5b6e 6772 616d 5d0a 0a20 2020 2070  ts[ngram]..    p
-0001f3f0: 7265 6369 7369 6f6e 7320 3d20 5b30 2e30  recisions = [0.0
-0001f400: 5d20 2a20 6d61 785f 6f72 6465 720a 2020  ] * max_order.  
-0001f410: 2020 736d 6f6f 7468 203d 2031 2e30 0a20    smooth = 1.0. 
-0001f420: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0001f430: 6528 302c 206d 6178 5f6f 7264 6572 293a  e(0, max_order):
-0001f440: 0a20 2020 2020 2020 2069 6620 706f 7373  .        if poss
-0001f450: 6962 6c65 5f6d 6174 6368 6573 5f62 795f  ible_matches_by_
-0001f460: 6f72 6465 725b 695d 203e 2030 3a0a 2020  order[i] > 0:.  
-0001f470: 2020 2020 2020 2020 2020 7072 6563 6973            precis
-0001f480: 696f 6e73 5b69 5d20 3d20 6d61 7463 6865  ions[i] = matche
-0001f490: 735f 6279 5f6f 7264 6572 5b69 5d20 2f20  s_by_order[i] / 
-0001f4a0: 706f 7373 6962 6c65 5f6d 6174 6368 6573  possible_matches
-0001f4b0: 5f62 795f 6f72 6465 725b 695d 0a20 2020  _by_order[i].   
-0001f4c0: 2020 2020 2020 2020 2069 6620 6d61 7463           if matc
-0001f4d0: 6865 735f 6279 5f6f 7264 6572 5b69 5d20  hes_by_order[i] 
-0001f4e0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0001f4f0: 2020 2020 2070 7265 6369 7369 6f6e 735b       precisions[
-0001f500: 695d 203d 206d 6174 6368 6573 5f62 795f  i] = matches_by_
-0001f510: 6f72 6465 725b 695d 202f 2070 6f73 7369  order[i] / possi
-0001f520: 626c 655f 6d61 7463 6865 735f 6279 5f6f  ble_matches_by_o
-0001f530: 7264 6572 5b69 5d0a 2020 2020 2020 2020  rder[i].        
-0001f540: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001f550: 2020 2020 2020 2020 2020 736d 6f6f 7468            smooth
-0001f560: 202a 3d20 320a 2020 2020 2020 2020 2020   *= 2.          
-0001f570: 2020 2020 2020 7072 6563 6973 696f 6e73        precisions
-0001f580: 5b69 5d20 3d20 312e 3020 2f20 2873 6d6f  [i] = 1.0 / (smo
-0001f590: 6f74 6820 2a20 706f 7373 6962 6c65 5f6d  oth * possible_m
-0001f5a0: 6174 6368 6573 5f62 795f 6f72 6465 725b  atches_by_order[
-0001f5b0: 695d 290a 2020 2020 2020 2020 656c 7365  i]).        else
-0001f5c0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0001f5d0: 6563 6973 696f 6e73 5b69 5d20 3d20 302e  ecisions[i] = 0.
-0001f5e0: 300a 0a20 2020 2069 6620 6d61 7828 7072  0..    if max(pr
-0001f5f0: 6563 6973 696f 6e73 2920 3e20 303a 0a20  ecisions) > 0:. 
-0001f600: 2020 2020 2020 2070 5f6c 6f67 5f73 756d         p_log_sum
-0001f610: 203d 2073 756d 286d 6174 682e 6c6f 6728   = sum(math.log(
-0001f620: 7029 2066 6f72 2070 2069 6e20 7072 6563  p) for p in prec
-0001f630: 6973 696f 6e73 2069 6620 7029 0a20 2020  isions if p).   
-0001f640: 2020 2020 2067 656f 5f6d 6561 6e20 3d20       geo_mean = 
-0001f650: 6d61 7468 2e65 7870 2870 5f6c 6f67 5f73  math.exp(p_log_s
-0001f660: 756d 202f 206d 6178 5f6f 7264 6572 290a  um / max_order).
-0001f670: 0a20 2020 2069 6620 7573 655f 6270 3a0a  .    if use_bp:.
-0001f680: 2020 2020 2020 2020 7261 7469 6f20 3d20          ratio = 
-0001f690: 7472 616e 736c 6174 696f 6e5f 6c65 6e67  translation_leng
-0001f6a0: 7468 202f 2072 6566 6572 656e 6365 5f6c  th / reference_l
-0001f6b0: 656e 6774 680a 2020 2020 2020 2020 6966  ength.        if
-0001f6c0: 2072 6174 696f 203c 2031 652d 3330 3a0a   ratio < 1e-30:.
-0001f6d0: 2020 2020 2020 2020 2020 2020 6270 203d              bp =
-0001f6e0: 2030 2e30 0a20 2020 2020 2020 2065 6c69   0.0.        eli
-0001f6f0: 6620 7261 7469 6f20 3c20 312e 303a 0a20  f ratio < 1.0:. 
-0001f700: 2020 2020 2020 2020 2020 2062 7020 3d20             bp = 
-0001f710: 6d61 7468 2e65 7870 2831 202d 2031 2e30  math.exp(1 - 1.0
-0001f720: 202f 2072 6174 696f 290a 2020 2020 2020   / ratio).      
-0001f730: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001f740: 2020 2020 6270 203d 2031 2e30 0a20 2020      bp = 1.0.   
-0001f750: 2062 6c65 7520 3d20 6765 6f5f 6d65 616e   bleu = geo_mean
-0001f760: 202a 2062 700a 2020 2020 7265 7475 726e   * bp.    return
-0001f770: 206e 702e 666c 6f61 7433 3228 626c 6575   np.float32(bleu
-0001f780: 290a 0a0a 2320 6e6f 696e 7370 6563 7469  )...# noinspecti
-0001f790: 6f6e 2050 7950 6163 6b61 6765 5265 7175  on PyPackageRequ
-0001f7a0: 6972 656d 656e 7473 0a64 6566 206d 6f6e  irements.def mon
-0001f7b0: 6b65 7966 6978 5f67 6c69 6228 293a 0a20  keyfix_glib():. 
-0001f7c0: 2020 2022 2222 0a20 2020 2046 6978 6573     """.    Fixes
-0001f7d0: 2073 6f6d 6520 7374 7570 6964 2062 7567   some stupid bug
-0001f7e0: 7320 7375 6368 2074 6861 7420 5349 4749  s such that SIGI
-0001f7f0: 4e54 2069 7320 6e6f 7420 776f 726b 696e  NT is not workin
-0001f800: 672e 0a20 2020 2054 6869 7320 6973 2075  g..    This is u
-0001f810: 7365 6420 6279 2061 7564 696f 7265 6164  sed by audioread
-0001f820: 2c20 616e 6420 696e 6469 7265 6374 6c79  , and indirectly
-0001f830: 2062 7920 6c69 6272 6f73 6120 666f 7220   by librosa for 
-0001f840: 6c6f 6164 696e 6720 6175 6469 6f2e 0a20  loading audio.. 
-0001f850: 2020 2068 7474 7073 3a2f 2f73 7461 636b     https://stack
-0001f860: 6f76 6572 666c 6f77 2e63 6f6d 2f71 7565  overflow.com/que
-0001f870: 7374 696f 6e73 2f31 3634 3130 3835 322f  stions/16410852/
-0001f880: 0a20 2020 2053 6565 2061 6c73 6f20 3a66  .    See also :f
-0001f890: 756e 633a 606d 6f6e 6b65 7970 6174 6368  unc:`monkeypatch
-0001f8a0: 5f61 7564 696f 7265 6164 602e 0a20 2020  _audioread`..   
-0001f8b0: 2022 2222 0a20 2020 2074 7279 3a0a 2020   """.    try:.  
-0001f8c0: 2020 2020 2020 696d 706f 7274 2067 690a        import gi.
-0001f8d0: 2020 2020 6578 6365 7074 2049 6d70 6f72      except Impor
-0001f8e0: 7445 7272 6f72 3a0a 2020 2020 2020 2020  tError:.        
-0001f8f0: 7265 7475 726e 0a20 2020 2074 7279 3a0a  return.    try:.
-0001f900: 2020 2020 2020 2020 6672 6f6d 2067 692e          from gi.
-0001f910: 7265 706f 7369 746f 7279 2069 6d70 6f72  repository impor
-0001f920: 7420 474c 6962 0a20 2020 2065 7863 6570  t GLib.    excep
-0001f930: 7420 496d 706f 7274 4572 726f 723a 0a20  t ImportError:. 
-0001f940: 2020 2020 2020 2023 206e 6f69 6e73 7065         # noinspe
-0001f950: 6374 696f 6e20 5079 556e 7265 736f 6c76  ction PyUnresolv
-0001f960: 6564 5265 6665 7265 6e63 6573 0a20 2020  edReferences.   
-0001f970: 2020 2020 2066 726f 6d20 6769 2e6f 7665       from gi.ove
-0001f980: 7272 6964 6573 2069 6d70 6f72 7420 474c  rrides import GL
-0001f990: 6962 0a20 2020 2023 2044 6f20 6e6f 7468  ib.    # Do noth
-0001f9a0: 696e 672e 0a20 2020 2023 2054 6865 206f  ing..    # The o
-0001f9b0: 7269 6769 6e61 6c20 6265 6861 7669 6f72  riginal behavior
-0001f9c0: 2077 6f75 6c64 2069 6e73 7461 6c6c 2061   would install a
-0001f9d0: 2053 4947 494e 5420 6861 6e64 6c65 7220   SIGINT handler 
-0001f9e0: 7768 6963 6820 6361 6c6c 7320 474c 6962  which calls GLib
-0001f9f0: 2e4d 6169 6e4c 6f6f 702e 7175 6974 2829  .MainLoop.quit()
-0001fa00: 2c0a 2020 2020 2320 616e 6420 7468 656e  ,.    # and then
-0001fa10: 2072 6572 6169 7365 2061 204b 6579 626f   reraise a Keybo
-0001fa20: 6172 6449 6e74 6572 7275 7074 2069 6e20  ardInterrupt in 
-0001fa30: 7468 6174 2074 6872 6561 642e 0a20 2020  that thread..   
-0001fa40: 2023 2048 6f77 6576 6572 2c20 7765 2077   # However, we w
-0001fa50: 616e 7420 616e 6420 6578 7065 6374 2074  ant and expect t
-0001fa60: 6f20 6765 7420 7468 6520 4b65 7962 6f61  o get the Keyboa
-0001fa70: 7264 496e 7465 7272 7570 7420 696e 2074  rdInterrupt in t
-0001fa80: 6865 206d 6169 6e20 7468 7265 6164 2e0a  he main thread..
-0001fa90: 2020 2020 474c 6962 2e4d 6169 6e4c 6f6f      GLib.MainLoo
-0001faa0: 702e 5f5f 696e 6974 5f5f 203d 206c 616d  p.__init__ = lam
-0001fab0: 6264 6120 2a61 7267 732c 202a 2a6b 7761  bda *args, **kwa
-0001fac0: 7267 733a 204e 6f6e 650a 0a0a 6465 6620  rgs: None...def 
-0001fad0: 6d6f 6e6b 6579 7061 7463 685f 6175 6469  monkeypatch_audi
-0001fae0: 6f72 6561 6428 293a 0a20 2020 2022 2222  oread():.    """
-0001faf0: 0a20 2020 2061 7564 696f 7265 6164 2064  .    audioread d
-0001fb00: 6f65 7320 6e6f 7420 6265 6861 7665 206f  oes not behave o
-0001fb10: 7074 696d 616c 2069 6e20 736f 6d65 2063  ptimal in some c
-0001fb20: 6173 6573 2e0a 2020 2020 452e 672e 2065  ases..    E.g. e
-0001fb30: 6163 6820 6361 6c6c 2074 6f20 5f63 615f  ach call to _ca_
-0001fb40: 6176 6169 6c61 626c 6528 2920 7461 6b65  available() take
-0001fb50: 7320 7175 6974 6520 6c6f 6e67 2062 6563  s quite long bec
-0001fb60: 6175 7365 206f 6620 7468 6520 6374 7970  ause of the ctyp
-0001fb70: 6573 2e75 7469 6c2e 6669 6e64 5f6c 6962  es.util.find_lib
-0001fb80: 7261 7279 2075 7361 6765 2e0a 2020 2020  rary usage..    
-0001fb90: 5765 2077 696c 6c20 7061 7463 6820 7468  We will patch th
-0001fba0: 6973 2e0a 0a20 2020 2048 6f77 6576 6572  is...    However
-0001fbb0: 2c20 7468 6520 7265 636f 6d6d 656e 6461  , the recommenda
-0001fbc0: 7469 6f6e 2077 6f75 6c64 2062 6520 746f  tion would be to
-0001fbd0: 206e 6f74 2075 7365 2061 7564 696f 7265   not use audiore
-0001fbe0: 6164 2028 6c69 6272 6f73 612e 6c6f 6164  ad (librosa.load
-0001fbf0: 292e 0a20 2020 2061 7564 696f 7265 6164  )..    audioread
-0001fc00: 2075 7365 7320 4773 7472 6561 6d65 7220   uses Gstreamer 
-0001fc10: 6173 2061 2062 6163 6b65 6e64 2062 7920  as a backend by 
-0001fc20: 6465 6661 756c 7420 6375 7272 656e 746c  default currentl
-0001fc30: 7920 286f 6e20 4c69 6e75 7829 2e0a 2020  y (on Linux)..  
-0001fc40: 2020 4773 7472 6561 6d65 7220 6861 7320    Gstreamer has 
-0001fc50: 6d75 6c74 6970 6c65 2069 7373 7565 732e  multiple issues.
-0001fc60: 2053 6565 2061 6c73 6f20 3a66 756e 633a   See also :func:
-0001fc70: 606d 6f6e 6b65 7966 6978 5f67 6c69 6260  `monkeyfix_glib`
-0001fc80: 2c20 616e 6420 6865 7265 2066 6f72 2064  , and here for d
-0001fc90: 6973 6375 7373 696f 6e3a 0a20 2020 2068  iscussion:.    h
-0001fca0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
-0001fcb0: 6d2f 6265 6574 626f 782f 6175 6469 6f72  m/beetbox/audior
-0001fcc0: 6561 642f 6973 7375 6573 2f36 320a 2020  ead/issues/62.  
-0001fcd0: 2020 6874 7470 733a 2f2f 6769 7468 7562    https://github
-0001fce0: 2e63 6f6d 2f62 6565 7462 6f78 2f61 7564  .com/beetbox/aud
-0001fcf0: 696f 7265 6164 2f69 7373 7565 732f 3633  ioread/issues/63
-0001fd00: 0a0a 2020 2020 496e 7374 6561 642c 2075  ..    Instead, u
-0001fd10: 7365 2050 7953 6f75 6e64 4669 6c65 2c20  se PySoundFile, 
-0001fd20: 7768 6963 6820 6973 2061 6c73 6f20 6661  which is also fa
-0001fd30: 7374 6572 2e20 5365 6520 6865 7265 2066  ster. See here f
-0001fd40: 6f72 2064 6973 6375 7373 696f 6e73 3a0a  or discussions:.
-0001fd50: 2020 2020 6874 7470 733a 2f2f 6769 7468      https://gith
-0001fd60: 7562 2e63 6f6d 2f62 6565 7462 6f78 2f61  ub.com/beetbox/a
-0001fd70: 7564 696f 7265 6164 2f69 7373 7565 732f  udioread/issues/
-0001fd80: 3634 0a20 2020 2068 7474 7073 3a2f 2f67  64.    https://g
-0001fd90: 6974 6875 622e 636f 6d2f 6c69 6272 6f73  ithub.com/libros
-0001fda0: 612f 6c69 6272 6f73 612f 6973 7375 6573  a/librosa/issues
-0001fdb0: 2f36 3831 0a20 2020 2022 2222 0a20 2020  /681.    """.   
-0001fdc0: 2074 7279 3a0a 2020 2020 2020 2020 2320   try:.        # 
-0001fdd0: 6e6f 696e 7370 6563 7469 6f6e 2050 7950  noinspection PyP
-0001fde0: 6163 6b61 6765 5265 7175 6972 656d 656e  ackageRequiremen
-0001fdf0: 7473 0a20 2020 2020 2020 2069 6d70 6f72  ts.        impor
-0001fe00: 7420 6175 6469 6f72 6561 640a 2020 2020  t audioread.    
-0001fe10: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
-0001fe20: 6f72 3a0a 2020 2020 2020 2020 7265 7475  or:.        retu
-0001fe30: 726e 0a20 2020 2023 206e 6f69 6e73 7065  rn.    # noinspe
-0001fe40: 6374 696f 6e20 5079 5072 6f74 6563 7465  ction PyProtecte
-0001fe50: 644d 656d 6265 720a 2020 2020 7265 7320  dMember.    res 
-0001fe60: 3d20 6175 6469 6f72 6561 642e 5f63 615f  = audioread._ca_
-0001fe70: 6176 6169 6c61 626c 6528 290a 2020 2020  available().    
-0001fe80: 6175 6469 6f72 6561 642e 5f63 615f 6176  audioread._ca_av
-0001fe90: 6169 6c61 626c 6520 3d20 6c61 6d62 6461  ailable = lambda
-0001fea0: 3a20 7265 730a 0a0a 5f63 665f 6361 6368  : res..._cf_cach
-0001feb0: 6520 3d20 7b7d 0a5f 6366 5f6d 7367 5f70  e = {}._cf_msg_p
-0001fec0: 7269 6e74 6564 203d 2046 616c 7365 0a0a  rinted = False..
-0001fed0: 0a64 6566 2063 6628 6669 6c65 6e61 6d65  .def cf(filename
-0001fee0: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
-0001fef0: 6163 6865 206d 616e 6167 6572 2e20 6936  ache manager. i6
-0001ff00: 2073 7065 6369 6669 632e 0a0a 2020 2020   specific...    
-0001ff10: 3a72 6574 7572 6e3a 2066 696c 656e 616d  :return: filenam
-0001ff20: 650a 2020 2020 3a72 7479 7065 3a20 7374  e.    :rtype: st
-0001ff30: 720a 2020 2020 2222 220a 2020 2020 676c  r.    """.    gl
-0001ff40: 6f62 616c 205f 6366 5f6d 7367 5f70 7269  obal _cf_msg_pri
-0001ff50: 6e74 6564 0a20 2020 2069 6d70 6f72 7420  nted.    import 
-0001ff60: 6f73 0a20 2020 2066 726f 6d20 7375 6270  os.    from subp
-0001ff70: 726f 6365 7373 2069 6d70 6f72 7420 6368  rocess import ch
-0001ff80: 6563 6b5f 6f75 7470 7574 0a0a 2020 2020  eck_output..    
-0001ff90: 6966 2066 696c 656e 616d 6520 696e 205f  if filename in _
-0001ffa0: 6366 5f63 6163 6865 3a0a 2020 2020 2020  cf_cache:.      
-0001ffb0: 2020 7265 7475 726e 205f 6366 5f63 6163    return _cf_cac
-0001ffc0: 6865 5b66 696c 656e 616d 655d 0a20 2020  he[filename].   
-0001ffd0: 2064 6562 7567 5f6d 6f64 6520 3d20 696e   debug_mode = in
-0001ffe0: 7428 6f73 2e65 6e76 6972 6f6e 2e67 6574  t(os.environ.get
-0001fff0: 2822 4445 4255 4722 2c20 3029 290a 2020  ("DEBUG", 0)).  
-00020000: 2020 6966 2064 6562 7567 5f6d 6f64 6520    if debug_mode 
-00020010: 6f72 2067 6574 5f68 6f73 746e 616d 6528  or get_hostname(
-00020020: 2920 3d3d 2022 636c 7573 7465 722d 636e  ) == "cluster-cn
-00020030: 2d32 3131 2220 6f72 206e 6f74 2069 735f  -211" or not is_
-00020040: 7275 6e6e 696e 675f 6f6e 5f63 6c75 7374  running_on_clust
-00020050: 6572 2829 3a0a 2020 2020 2020 2020 6966  er():.        if
-00020060: 206e 6f74 205f 6366 5f6d 7367 5f70 7269   not _cf_msg_pri
-00020070: 6e74 6564 3a0a 2020 2020 2020 2020 2020  nted:.          
-00020080: 2020 7072 696e 7428 2243 6163 6865 206d    print("Cache m
-00020090: 616e 6167 6572 3a20 6e6f 7420 7573 6564  anager: not used
-000200a0: 2c20 7573 6520 6c6f 6361 6c20 6669 6c65  , use local file
-000200b0: 3a20 2573 2028 6469 7363 6172 6420 6675  : %s (discard fu
-000200c0: 7274 6865 7220 6d65 7373 6167 6573 2922  rther messages)"
-000200d0: 2025 2066 696c 656e 616d 6529 0a20 2020   % filename).   
-000200e0: 2020 2020 2020 2020 205f 6366 5f6d 7367           _cf_msg
-000200f0: 5f70 7269 6e74 6564 203d 2054 7275 650a  _printed = True.
-00020100: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00020110: 696c 656e 616d 6520 2023 2066 6f72 2064  ilename  # for d
-00020120: 6562 7567 6769 6e67 0a20 2020 2074 7279  ebugging.    try
-00020130: 3a0a 2020 2020 2020 2020 6361 6368 6564  :.        cached
-00020140: 5f66 6e20 3d20 6368 6563 6b5f 6f75 7470  _fn = check_outp
-00020150: 7574 285b 2263 6622 2c20 6669 6c65 6e61  ut(["cf", filena
-00020160: 6d65 5d29 2e73 7472 6970 2829 2e64 6563  me]).strip().dec
-00020170: 6f64 6528 2275 7466 3822 290a 2020 2020  ode("utf8").    
-00020180: 6578 6365 7074 2043 616c 6c65 6450 726f  except CalledPro
-00020190: 6365 7373 4572 726f 723a 0a20 2020 2020  cessError:.     
-000201a0: 2020 2069 6620 6e6f 7420 5f63 665f 6d73     if not _cf_ms
-000201b0: 675f 7072 696e 7465 643a 0a20 2020 2020  g_printed:.     
-000201c0: 2020 2020 2020 2070 7269 6e74 2822 4361         print("Ca
-000201d0: 6368 6520 6d61 6e61 6765 723a 2045 7272  che manager: Err
-000201e0: 6f72 206f 6363 7572 7265 642c 2075 7369  or occurred, usi
-000201f0: 6e67 206c 6f63 616c 2066 696c 6522 290a  ng local file").
-00020200: 2020 2020 2020 2020 2020 2020 5f63 665f              _cf_
-00020210: 6d73 675f 7072 696e 7465 6420 3d20 5472  msg_printed = Tr
-00020220: 7565 0a20 2020 2020 2020 2072 6574 7572  ue.        retur
-00020230: 6e20 6669 6c65 6e61 6d65 0a20 2020 2061  n filename.    a
-00020240: 7373 6572 7420 6f73 2e70 6174 682e 6578  ssert os.path.ex
-00020250: 6973 7473 2863 6163 6865 645f 666e 290a  ists(cached_fn).
-00020260: 2020 2020 5f63 665f 6361 6368 655b 6669      _cf_cache[fi
-00020270: 6c65 6e61 6d65 5d20 3d20 6361 6368 6564  lename] = cached
-00020280: 5f66 6e0a 2020 2020 7265 7475 726e 2063  _fn.    return c
-00020290: 6163 6865 645f 666e 0a0a 0a64 6566 2062  ached_fn...def b
-000202a0: 696e 6172 795f 7365 6172 6368 5f61 6e79  inary_search_any
-000202b0: 2863 6d70 2c20 6c6f 772c 2068 6967 6829  (cmp, low, high)
-000202c0: 3a0a 2020 2020 2222 220a 2020 2020 4269  :.    """.    Bi
-000202d0: 6e61 7279 2073 6561 7263 6820 666f 7220  nary search for 
-000202e0: 6120 6375 7374 6f6d 2063 6f6d 7061 7265  a custom compare
-000202f0: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
-00020300: 3a70 6172 616d 2028 696e 7429 2d3e 696e  :param (int)->in
-00020310: 7420 636d 703a 2065 2e67 2e20 636d 7028  t cmp: e.g. cmp(
-00020320: 6964 7829 203d 3d20 636f 6d70 6172 6528  idx) == compare(
-00020330: 6172 7261 795b 6964 785d 2c20 6b65 7929  array[idx], key)
-00020340: 0a20 2020 203a 7061 7261 6d20 696e 7420  .    :param int 
-00020350: 6c6f 773a 2069 6e63 6c75 7369 7665 0a20  low: inclusive. 
-00020360: 2020 203a 7061 7261 6d20 696e 7420 6869     :param int hi
-00020370: 6768 3a20 6578 636c 7573 6976 650a 2020  gh: exclusive.  
-00020380: 2020 3a72 7479 7065 3a20 696e 747c 4e6f    :rtype: int|No
-00020390: 6e65 0a20 2020 2022 2222 0a20 2020 2077  ne.    """.    w
-000203a0: 6869 6c65 206c 6f77 203c 2068 6967 683a  hile low < high:
-000203b0: 0a20 2020 2020 2020 206d 6964 203d 2028  .        mid = (
-000203c0: 6c6f 7720 2b20 6869 6768 2920 2f2f 2032  low + high) // 2
-000203d0: 0a20 2020 2020 2020 2072 203d 2063 6d70  .        r = cmp
-000203e0: 286d 6964 290a 2020 2020 2020 2020 6966  (mid).        if
-000203f0: 2072 203c 2030 3a0a 2020 2020 2020 2020   r < 0:.        
-00020400: 2020 2020 6c6f 7720 3d20 6d69 6420 2b20      low = mid + 
-00020410: 310a 2020 2020 2020 2020 656c 6966 2072  1.        elif r
-00020420: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00020430: 2020 6869 6768 203d 206d 6964 0a20 2020    high = mid.   
-00020440: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00020450: 2020 2020 2020 2072 6574 7572 6e20 6d69         return mi
-00020460: 640a 2020 2020 7265 7475 726e 206c 6f77  d.    return low
-00020470: 0a0a 0a64 6566 2067 656e 6572 6963 5f69  ...def generic_i
-00020480: 6d70 6f72 745f 6d6f 6475 6c65 2866 696c  mport_module(fil
-00020490: 656e 616d 6529 3a0a 2020 2020 2222 220a  ename):.    """.
-000204a0: 2020 2020 3a70 6172 616d 2073 7472 2066      :param str f
-000204b0: 696c 656e 616d 653a 0a20 2020 2020 2057  ilename:.      W
-000204c0: 6520 7472 7920 746f 2062 6520 636c 6576  e try to be clev
-000204d0: 6572 2061 626f 7574 2066 696c 656e 616d  er about filenam
-000204e0: 652e 0a20 2020 2020 2049 6620 6974 206c  e..      If it l
-000204f0: 6f6f 6b73 206c 696b 6520 6120 6d6f 6475  ooks like a modu
-00020500: 6c65 206e 616d 652c 206a 7573 7420 646f  le name, just do
-00020510: 2069 6d70 6f72 746c 6962 2e69 6d70 6f72   importlib.impor
-00020520: 745f 6d6f 6475 6c65 2e0a 2020 2020 2020  t_module..      
-00020530: 4966 2069 7420 6c6f 6f6b 7320 6c69 6b65  If it looks like
-00020540: 2061 2066 696c 656e 616d 652c 2073 6561   a filename, sea
-00020550: 7263 6820 666f 7220 6120 6261 7365 2070  rch for a base p
-00020560: 6174 6820 2877 6869 6368 2064 6f65 7320  ath (which does 
-00020570: 6e6f 7420 6861 7665 205f 5f69 6e69 745f  not have __init_
-00020580: 5f2e 7079 292c 0a20 2020 2020 2061 6464  _.py),.      add
-00020590: 2074 6861 7420 7061 7468 2074 6f20 7379   that path to sy
-000205a0: 732e 7061 7468 2069 6620 6e65 6564 6564  s.path if needed
-000205b0: 2c20 616e 6420 696d 706f 7274 2074 6865  , and import the
-000205c0: 2072 656d 6169 6e69 6e67 2077 6865 7265   remaining where
-000205d0: 2022 2f22 2069 7320 7265 706c 6163 6564   "/" is replaced
-000205e0: 2062 7920 222e 220a 2020 2020 2020 616e   by ".".      an
-000205f0: 6420 7468 6520 6669 6c65 2065 7874 656e  d the file exten
-00020600: 7369 6f6e 2069 7320 7265 6d6f 7665 642e  sion is removed.
-00020610: 0a20 2020 203a 7265 7475 726e 3a20 7468  .    :return: th
-00020620: 6520 6d6f 6475 6c65 0a20 2020 203a 7274  e module.    :rt
-00020630: 7970 653a 2074 7970 6573 2e4d 6f64 756c  ype: types.Modul
-00020640: 6554 7970 650a 2020 2020 2222 220a 2020  eType.    """.  
-00020650: 2020 6173 7365 7274 2066 696c 656e 616d    assert filenam
-00020660: 650a 2020 2020 696d 706f 7274 2069 6d70  e.    import imp
-00020670: 6f72 746c 6962 0a0a 2020 2020 6966 2022  ortlib..    if "
-00020680: 2f22 206e 6f74 2069 6e20 6669 6c65 6e61  /" not in filena
-00020690: 6d65 3a0a 2020 2020 2020 2020 7265 7475  me:.        retu
-000206a0: 726e 2069 6d70 6f72 746c 6962 2e69 6d70  rn importlib.imp
-000206b0: 6f72 745f 6d6f 6475 6c65 2866 696c 656e  ort_module(filen
-000206c0: 616d 6529 0a20 2020 2070 7265 6669 785f  ame).    prefix_
-000206d0: 6469 7220 3d20 2222 0a20 2020 2069 6620  dir = "".    if 
-000206e0: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
-000206f0: 7473 2866 696c 656e 616d 6529 3a0a 2020  ts(filename):.  
-00020700: 2020 2020 2020 6173 7365 7274 2066 696c        assert fil
-00020710: 656e 616d 655b 305d 2021 3d20 222f 220a  ename[0] != "/".
-00020720: 2020 2020 2020 2020 2320 4d61 7962 6520          # Maybe 
-00020730: 7265 6c61 7469 7665 2074 6f20 5265 7475  relative to Retu
-00020740: 726e 6e3f 0a20 2020 2020 2020 2070 7265  rnn?.        pre
-00020750: 6669 785f 6469 7220 3d20 2225 732f 2220  fix_dir = "%s/" 
-00020760: 2520 7265 7475 726e 6e5f 726f 6f74 5f64  % returnn_root_d
-00020770: 6972 0a20 2020 2061 7373 6572 7420 6f73  ir.    assert os
-00020780: 2e70 6174 682e 6578 6973 7473 2870 7265  .path.exists(pre
-00020790: 6669 785f 6469 7220 2b20 6669 6c65 6e61  fix_dir + filena
-000207a0: 6d65 290a 2020 2020 6173 7365 7274 2066  me).    assert f
-000207b0: 696c 656e 616d 652e 656e 6473 7769 7468  ilename.endswith
-000207c0: 2822 2e70 7922 2920 6f72 206f 732e 7061  (".py") or os.pa
-000207d0: 7468 2e69 7364 6972 2870 7265 6669 785f  th.isdir(prefix_
-000207e0: 6469 7220 2b20 6669 6c65 6e61 6d65 290a  dir + filename).
-000207f0: 2020 2020 6469 7273 203d 2066 696c 656e      dirs = filen
-00020800: 616d 652e 7370 6c69 7428 222f 2229 0a20  ame.split("/"). 
-00020810: 2020 2064 6972 732c 2062 6173 655f 666e     dirs, base_fn
-00020820: 203d 2064 6972 735b 3a2d 315d 2c20 6469   = dirs[:-1], di
-00020830: 7273 5b2d 315d 0a20 2020 2061 7373 6572  rs[-1].    asser
-00020840: 7420 6c65 6e28 6469 7273 2920 3e3d 2031  t len(dirs) >= 1
-00020850: 0a20 2020 2066 6f72 2069 2069 6e20 7265  .    for i in re
-00020860: 7665 7273 6564 2872 616e 6765 286c 656e  versed(range(len
-00020870: 2864 6972 7329 2929 3a0a 2020 2020 2020  (dirs))):.      
-00020880: 2020 6420 3d20 7072 6566 6978 5f64 6972    d = prefix_dir
-00020890: 202b 2022 2f22 2e6a 6f69 6e28 6469 7273   + "/".join(dirs
-000208a0: 5b3a 2069 202b 2031 5d29 0a20 2020 2020  [: i + 1]).     
-000208b0: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
-000208c0: 682e 6973 6469 7228 6429 0a20 2020 2020  h.isdir(d).     
-000208d0: 2020 2069 6620 6f73 2e70 6174 682e 6578     if os.path.ex
-000208e0: 6973 7473 2822 2573 2f5f 5f69 6e69 745f  ists("%s/__init_
-000208f0: 5f2e 7079 2220 2520 6429 3a0a 2020 2020  _.py" % d):.    
-00020900: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00020910: 0a20 2020 2020 2020 2069 6620 6420 6e6f  .        if d no
-00020920: 7420 696e 2073 7973 2e70 6174 683a 0a20  t in sys.path:. 
-00020930: 2020 2020 2020 2020 2020 2073 7973 2e70             sys.p
-00020940: 6174 682e 6170 7065 6e64 2864 290a 2020  ath.append(d).  
-00020950: 2020 2020 2020 6d20 3d20 222e 222e 6a6f        m = ".".jo
-00020960: 696e 2864 6972 735b 6920 2b20 3120 3a5d  in(dirs[i + 1 :]
-00020970: 202b 205b 6261 7365 5f66 6e5d 290a 2020   + [base_fn]).  
-00020980: 2020 2020 2020 6966 2062 6173 655f 666e        if base_fn
-00020990: 2e65 6e64 7377 6974 6828 222e 7079 2229  .endswith(".py")
-000209a0: 3a0a 2020 2020 2020 2020 2020 2020 6d20  :.            m 
-000209b0: 3d20 6d5b 3a2d 335d 0a20 2020 2020 2020  = m[:-3].       
-000209c0: 2072 6574 7572 6e20 696d 706f 7274 6c69   return importli
-000209d0: 622e 696d 706f 7274 5f6d 6f64 756c 6528  b.import_module(
-000209e0: 6d29 0a20 2020 2072 6169 7365 2056 616c  m).    raise Val
-000209f0: 7565 4572 726f 7228 2263 616e 6e6f 7420  ueError("cannot 
-00020a00: 6669 6775 7265 206f 7574 2062 6173 6520  figure out base 
-00020a10: 6d6f 6475 6c65 2070 6174 6820 6672 6f6d  module path from
-00020a20: 2025 7222 2025 2066 696c 656e 616d 6529   %r" % filename)
-00020a30: 0a0a 0a64 6566 2073 6f66 746d 6178 2878  ...def softmax(x
-00020a40: 2c20 6178 6973 3d4e 6f6e 6529 3a0a 2020  , axis=None):.  
-00020a50: 2020 2222 220a 2020 2020 3a70 6172 616d    """.    :param
-00020a60: 206e 756d 7079 2e6e 6461 7272 6179 2078   numpy.ndarray x
-00020a70: 3a0a 2020 2020 3a70 6172 616d 2069 6e74  :.    :param int
-00020a80: 7c4e 6f6e 6520 6178 6973 3a0a 2020 2020  |None axis:.    
-00020a90: 3a72 7479 7065 3a20 6e75 6d70 792e 6e64  :rtype: numpy.nd
-00020aa0: 6172 7261 790a 2020 2020 2222 220a 2020  array.    """.  
-00020ab0: 2020 696d 706f 7274 206e 756d 7079 0a0a    import numpy..
-00020ac0: 2020 2020 655f 7820 3d20 6e75 6d70 792e      e_x = numpy.
-00020ad0: 6578 7028 7820 2d20 6e75 6d70 792e 6d61  exp(x - numpy.ma
-00020ae0: 7828 782c 2061 7869 733d 6178 6973 2c20  x(x, axis=axis, 
-00020af0: 6b65 6570 6469 6d73 3d54 7275 6529 290a  keepdims=True)).
-00020b00: 2020 2020 7265 7475 726e 2065 5f78 202f      return e_x /
-00020b10: 206e 756d 7079 2e73 756d 2865 5f78 2c20   numpy.sum(e_x, 
-00020b20: 6178 6973 3d61 7869 732c 206b 6565 7064  axis=axis, keepd
-00020b30: 696d 733d 5472 7565 290a 0a0a 6465 6620  ims=True)...def 
-00020b40: 636f 6c6c 6563 745f 7072 6f63 5f6d 6170  collect_proc_map
-00020b50: 735f 6578 6563 5f66 696c 6573 2829 3a0a  s_exec_files():.
-00020b60: 2020 2020 2222 220a 2020 2020 4375 7272      """.    Curr
-00020b70: 656e 746c 7920 6f6e 6c79 2077 6f72 6b73  ently only works
-00020b80: 206f 6e20 4c69 6e75 782e 2e2e 0a0a 2020   on Linux.....  
-00020b90: 2020 3a72 6574 7572 6e3a 206c 6973 7420    :return: list 
-00020ba0: 6f66 206d 6170 7065 6420 6578 6563 7574  of mapped execut
-00020bb0: 6162 6c65 7320 286c 6962 7329 0a20 2020  ables (libs).   
-00020bc0: 203a 7274 7970 653a 206c 6973 745b 7374   :rtype: list[st
-00020bd0: 725d 0a20 2020 2022 2222 0a20 2020 2069  r].    """.    i
-00020be0: 6d70 6f72 7420 7265 0a0a 2020 2020 7069  mport re..    pi
-00020bf0: 6420 3d20 6f73 2e67 6574 7069 6428 290a  d = os.getpid().
-00020c00: 2020 2020 666e 7320 3d20 5b5d 0a20 2020      fns = [].   
-00020c10: 2066 6f72 206c 696e 6520 696e 206f 7065   for line in ope
-00020c20: 6e28 222f 7072 6f63 2f25 692f 6d61 7073  n("/proc/%i/maps
-00020c30: 2220 2520 7069 642c 2022 7222 292e 7265  " % pid, "r").re
-00020c40: 6164 2829 2e73 706c 6974 6c69 6e65 7328  ad().splitlines(
-00020c50: 293a 2020 2320 666f 7220 6561 6368 206d  ):  # for each m
-00020c60: 6170 7065 6420 7265 6769 6f6e 0a20 2020  apped region.   
-00020c70: 2020 2020 2023 2068 7474 7073 3a2f 2f73       # https://s
-00020c80: 7461 636b 6f76 6572 666c 6f77 2e63 6f6d  tackoverflow.com
-00020c90: 2f71 7565 7374 696f 6e73 2f31 3430 3133  /questions/14013
-00020ca0: 3539 2f75 6e64 6572 7374 616e 6469 6e67  59/understanding
-00020cb0: 2d6c 696e 7578 2d70 726f 632d 6964 2d6d  -linux-proc-id-m
-00020cc0: 6170 730a 2020 2020 2020 2020 2320 6164  aps.        # ad
-00020cd0: 6472 6573 7320 2020 2020 2020 2020 2020  dress           
-00020ce0: 7065 726d 7320 6f66 6673 6574 2020 6465  perms offset  de
-00020cf0: 7620 2020 696e 6f64 6520 2020 7061 7468  v   inode   path
-00020d00: 6e61 6d65 0a20 2020 2020 2020 2023 2045  name.        # E
-00020d10: 2e67 2e3a 0a20 2020 2020 2020 2023 2037  .g.:.        # 7
-00020d20: 6666 3264 6539 3163 3030 302d 3766 6632  ff2de91c000-7ff2
-00020d30: 6465 3931 6530 3030 2072 772d 7020 3030  de91e000 rw-p 00
-00020d40: 3137 6330 3030 2030 383a 3032 2037 3934  17c000 08:02 794
-00020d50: 3834 3420 2020 2020 2020 2020 2020 2020  844             
-00020d60: 2020 2020 2020 2020 2f75 7372 2f6c 6962          /usr/lib
-00020d70: 2f78 3836 5f36 342d 6c69 6e75 782d 676e  /x86_64-linux-gn
-00020d80: 752f 6c69 6273 7464 632b 2e2e 2e0a 2020  u/libstdc+....  
-00020d90: 2020 2020 2020 6d20 3d20 7265 2e6d 6174        m = re.mat
-00020da0: 6368 280a 2020 2020 2020 2020 2020 2020  ch(.            
-00020db0: 7222 5e28 5b30 2d39 412d 4661 2d66 5d2b  r"^([0-9A-Fa-f]+
-00020dc0: 292d 285b 302d 3941 2d46 612d 665d 2b29  )-([0-9A-Fa-f]+)
-00020dd0: 5c73 2b28 5b72 7778 7073 5c2d 5d2b 295c  \s+([rwxps\-]+)\
-00020de0: 732b 285b 302d 3941 2d46 612d 665d 2b29  s+([0-9A-Fa-f]+)
-00020df0: 5c73 2b28 5b30 2d39 412d 4661 2d66 3a5d  \s+([0-9A-Fa-f:]
-00020e00: 2b29 5c73 2b28 5b30 2d39 5d2b 295c 732a  +)\s+([0-9]+)\s*
-00020e10: 282e 2a29 2422 2c20 6c69 6e65 0a20 2020  (.*)$", line.   
-00020e20: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-00020e30: 7373 6572 7420 6d2c 2022 6e6f 206d 6174  ssert m, "no mat
-00020e40: 6368 2066 6f72 2025 7222 2025 206c 696e  ch for %r" % lin
-00020e50: 650a 2020 2020 2020 2020 6164 6472 6573  e.        addres
-00020e60: 735f 7374 6172 742c 2061 6464 7265 7373  s_start, address
-00020e70: 5f65 6e64 2c20 7065 726d 732c 206f 6666  _end, perms, off
-00020e80: 7365 742c 2064 6576 2c20 695f 6e6f 6465  set, dev, i_node
-00020e90: 2c20 7061 7468 5f6e 616d 6520 3d20 6d2e  , path_name = m.
-00020ea0: 6772 6f75 7073 2829 0a20 2020 2020 2020  groups().       
-00020eb0: 2069 6620 2278 2220 6e6f 7420 696e 2070   if "x" not in p
-00020ec0: 6572 6d73 3a0a 2020 2020 2020 2020 2020  erms:.          
-00020ed0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00020ee0: 2020 2069 6620 6e6f 7420 7061 7468 5f6e     if not path_n
-00020ef0: 616d 6520 6f72 2070 6174 685f 6e61 6d65  ame or path_name
-00020f00: 2e73 7461 7274 7377 6974 6828 225b 2229  .startswith("[")
-00020f10: 206f 7220 2228 6465 6c65 7465 6429 2220   or "(deleted)" 
-00020f20: 696e 2070 6174 685f 6e61 6d65 3a0a 2020  in path_name:.  
-00020f30: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00020f40: 7565 0a20 2020 2020 2020 2069 6620 7061  ue.        if pa
-00020f50: 7468 5f6e 616d 6520 6e6f 7420 696e 2066  th_name not in f
-00020f60: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00020f70: 666e 732e 6170 7065 6e64 2870 6174 685f  fns.append(path_
-00020f80: 6e61 6d65 290a 2020 2020 7265 7475 726e  name).    return
-00020f90: 2066 6e73 0a0a 0a64 6566 2066 696e 645f   fns...def find_
-00020fa0: 7379 6d5f 696e 5f65 7865 6328 666e 2c20  sym_in_exec(fn, 
-00020fb0: 7379 6d29 3a0a 2020 2020 2222 220a 2020  sym):.    """.  
-00020fc0: 2020 5573 6573 2060 606f 626a 6475 6d70    Uses ``objdump
-00020fd0: 6060 2074 6f20 6c69 7374 2061 7661 696c  `` to list avail
-00020fe0: 6162 6c65 2073 796d 626f 6c73 2c20 616e  able symbols, an
-00020ff0: 6420 6669 6c74 6572 7320 7468 656d 2062  d filters them b
-00021000: 7920 7468 6520 6769 7665 6e20 6060 7379  y the given ``sy
-00021010: 6d60 602e 0a0a 2020 2020 3a70 6172 616d  m``...    :param
-00021020: 2073 7472 2066 6e3a 2070 6174 680a 2020   str fn: path.  
-00021030: 2020 3a70 6172 616d 2073 7472 2073 796d    :param str sym
-00021040: 3a0a 2020 2020 3a72 6574 7572 6e3a 206d  :.    :return: m
-00021050: 6174 6368 6564 206f 7574 2c20 6f72 204e  atched out, or N
-00021060: 6f6e 650a 2020 2020 3a72 7479 7065 3a20  one.    :rtype: 
-00021070: 7374 727c 4e6f 6e65 0a20 2020 2022 2222  str|None.    """
-00021080: 0a20 2020 2066 726f 6d20 7375 6270 726f  .    from subpro
-00021090: 6365 7373 2069 6d70 6f72 7420 4361 6c6c  cess import Call
-000210a0: 6564 5072 6f63 6573 7345 7272 6f72 0a0a  edProcessError..
-000210b0: 2020 2020 6f62 6a64 756d 7020 3d20 226f      objdump = "o
-000210c0: 626a 6475 6d70 202d 5422 0a20 2020 2069  bjdump -T".    i
-000210d0: 6620 7379 732e 706c 6174 666f 726d 203d  f sys.platform =
-000210e0: 3d20 2264 6172 7769 6e22 3a0a 2020 2020  = "darwin":.    
-000210f0: 2020 2020 6f62 6a64 756d 7020 3d20 226f      objdump = "o
-00021100: 746f 6f6c 202d 4948 4776 220a 2020 2020  tool -IHGv".    
-00021110: 7368 656c 6c5f 636d 6420 3d20 2225 7320  shell_cmd = "%s 
-00021120: 2573 207c 2067 7265 7020 2573 2220 2520  %s | grep %s" % 
-00021130: 286f 626a 6475 6d70 2c20 666e 2c20 7379  (objdump, fn, sy
-00021140: 6d29 0a20 2020 2074 7279 3a0a 2020 2020  m).    try:.    
-00021150: 2020 2020 6f75 7420 3d20 7379 735f 6578      out = sys_ex
-00021160: 6563 5f6f 7574 2873 6865 6c6c 5f63 6d64  ec_out(shell_cmd
-00021170: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-00021180: 2020 6578 6365 7074 2043 616c 6c65 6450    except CalledP
-00021190: 726f 6365 7373 4572 726f 723a 2020 2320  rocessError:  # 
-000211a0: 6e6f 6e65 2066 6f75 6e64 0a20 2020 2020  none found.     
-000211b0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
-000211c0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-000211d0: 616e 6365 286f 7574 2c20 2873 7472 2c20  ance(out, (str, 
-000211e0: 756e 6963 6f64 6529 290a 2020 2020 6f75  unicode)).    ou
-000211f0: 745f 6c6e 7320 3d20 6f75 742e 7370 6c69  t_lns = out.spli
-00021200: 746c 696e 6573 2829 0a20 2020 206f 7574  tlines().    out
-00021210: 5f6c 6e73 203d 205b 6c6e 2066 6f72 206c  _lns = [ln for l
-00021220: 6e20 696e 206f 7574 5f6c 6e73 2069 6620  n in out_lns if 
-00021230: 222e 7465 7874 2220 696e 206c 6e5d 2020  ".text" in ln]  
-00021240: 2320 7365 6520 6f62 6a64 756d 700a 2020  # see objdump.  
-00021250: 2020 6f75 745f 6c6e 7320 3d20 5b6c 6e20    out_lns = [ln 
-00021260: 666f 7220 6c6e 2069 6e20 6f75 745f 6c6e  for ln in out_ln
-00021270: 7320 6966 2073 796d 2069 6e20 6c6e 2e73  s if sym in ln.s
-00021280: 706c 6974 2829 5d0a 2020 2020 6966 206e  plit()].    if n
-00021290: 6f74 206f 7574 5f6c 6e73 3a0a 2020 2020  ot out_lns:.    
-000212a0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-000212b0: 2020 2020 7265 7475 726e 2022 466f 756e      return "Foun
-000212c0: 6420 2572 2069 6e20 2572 3a5c 6e25 7322  d %r in %r:\n%s"
-000212d0: 2025 2028 7379 6d2c 2066 6e2c 2022 5c6e   % (sym, fn, "\n
-000212e0: 222e 6a6f 696e 286f 7574 5f6c 6e73 2929  ".join(out_lns))
-000212f0: 0a0a 0a64 6566 2064 756d 6d79 5f6e 756d  ...def dummy_num
-00021300: 7079 5f67 656d 6d5f 6361 6c6c 2829 3a0a  py_gemm_call():.
-00021310: 2020 2020 2222 220a 2020 2020 4a75 7374      """.    Just
-00021320: 2070 6572 666f 726d 7320 736f 6d65 2047   performs some G
-00021330: 454d 4d20 6361 6c6c 2076 6961 204e 756d  EMM call via Num
-00021340: 7079 2e0a 2020 2020 5468 6973 206d 616b  py..    This mak
-00021350: 6573 2073 7572 6520 7468 6174 2074 6865  es sure that the
-00021360: 2042 4c41 5320 6c69 6272 6172 7920 6973   BLAS library is
-00021370: 206c 6f61 6465 642e 0a20 2020 2022 2222   loaded..    """
-00021380: 0a20 2020 2069 6d70 6f72 7420 6e75 6d70  .    import nump
-00021390: 790a 0a20 2020 2061 203d 206e 756d 7079  y..    a = numpy
-000213a0: 2e72 616e 646f 6d2e 7261 6e64 6e28 352c  .random.randn(5,
-000213b0: 2033 292e 6173 7479 7065 286e 756d 7079   3).astype(numpy
-000213c0: 2e66 6c6f 6174 3332 290a 2020 2020 6220  .float32).    b 
-000213d0: 3d20 6e75 6d70 792e 7261 6e64 6f6d 2e72  = numpy.random.r
-000213e0: 616e 646e 2833 2c20 3729 2e61 7374 7970  andn(3, 7).astyp
-000213f0: 6528 6e75 6d70 792e 666c 6f61 7433 3229  e(numpy.float32)
-00021400: 0a20 2020 2063 203d 206e 756d 7079 2e64  .    c = numpy.d
-00021410: 6f74 2861 2c20 6229 0a20 2020 2061 7373  ot(a, b).    ass
-00021420: 6572 7420 6e75 6d70 792e 6973 6669 6e69  ert numpy.isfini
-00021430: 7465 2863 292e 616c 6c28 290a 0a0a 5f66  te(c).all()..._f
-00021440: 696e 645f 7367 656d 6d5f 6c69 625f 6672  ind_sgemm_lib_fr
-00021450: 6f6d 5f72 756e 7469 6d65 5f63 6163 6865  om_runtime_cache
-00021460: 6420 3d20 4e6f 6e65 0a0a 0a64 6566 2066  d = None...def f
-00021470: 696e 645f 7367 656d 6d5f 6c69 6273 5f66  ind_sgemm_libs_f
-00021480: 726f 6d5f 7275 6e74 696d 6528 293a 0a20  rom_runtime():. 
-00021490: 2020 2022 2222 0a20 2020 204c 6f6f 6b73     """.    Looks
-000214a0: 2074 6872 6f75 6768 2061 6c6c 206c 6962   through all lib
-000214b0: 7320 7669 6120 3a66 756e 633a 6063 6f6c  s via :func:`col
-000214c0: 6c65 6374 5f70 726f 635f 6d61 7073 5f65  lect_proc_maps_e
-000214d0: 7865 635f 6669 6c65 7360 2c0a 2020 2020  xec_files`,.    
-000214e0: 616e 6420 7365 6172 6368 6573 2066 6f72  and searches for
-000214f0: 2061 6c6c 2077 6869 6368 2068 6176 6520   all which have 
-00021500: 7468 6520 6060 7367 656d 6d60 6020 7379  the ``sgemm`` sy
-00021510: 6d62 6f6c 2e0a 2020 2020 4375 7272 656e  mbol..    Curren
-00021520: 746c 7920 6f6e 6c79 2077 6f72 6b73 206f  tly only works o
-00021530: 6e20 4c69 6e75 7820 2862 6563 6175 7365  n Linux (because
-00021540: 2063 6f6c 6c65 6374 5f70 726f 635f 6d61   collect_proc_ma
-00021550: 7073 5f65 7865 635f 6669 6c65 7329 2e0a  ps_exec_files)..
-00021560: 0a20 2020 203a 7265 7475 726e 3a20 6c69  .    :return: li
-00021570: 7374 206f 6620 6c69 6273 2028 7468 6569  st of libs (thei
-00021580: 7220 7061 7468 290a 2020 2020 3a72 7479  r path).    :rty
-00021590: 7065 3a20 6c69 7374 5b73 7472 5d0a 2020  pe: list[str].  
-000215a0: 2020 2222 220a 2020 2020 6966 206e 6f74    """.    if not
-000215b0: 206f 732e 7061 7468 2e65 7869 7374 7328   os.path.exists(
-000215c0: 222f 7072 6f63 2229 3a0a 2020 2020 2020  "/proc"):.      
-000215d0: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
-000215e0: 2020 676c 6f62 616c 205f 6669 6e64 5f73    global _find_s
-000215f0: 6765 6d6d 5f6c 6962 5f66 726f 6d5f 7275  gemm_lib_from_ru
-00021600: 6e74 696d 655f 6361 6368 6564 0a20 2020  ntime_cached.   
-00021610: 2069 6620 5f66 696e 645f 7367 656d 6d5f   if _find_sgemm_
-00021620: 6c69 625f 6672 6f6d 5f72 756e 7469 6d65  lib_from_runtime
-00021630: 5f63 6163 6865 6420 6973 206e 6f74 204e  _cached is not N
-00021640: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
-00021650: 7572 6e20 5f66 696e 645f 7367 656d 6d5f  urn _find_sgemm_
-00021660: 6c69 625f 6672 6f6d 5f72 756e 7469 6d65  lib_from_runtime
-00021670: 5f63 6163 6865 640a 2020 2020 6475 6d6d  _cached.    dumm
-00021680: 795f 6e75 6d70 795f 6765 6d6d 5f63 616c  y_numpy_gemm_cal
-00021690: 6c28 2920 2023 206d 616b 6520 7375 7265  l()  # make sure
-000216a0: 2074 6861 7420 4e75 6d70 7920 6973 206c   that Numpy is l
-000216b0: 6f61 6465 6420 616e 6420 4e75 6d70 7920  oaded and Numpy 
-000216c0: 7367 656d 6d20 6973 2061 7661 696c 6162  sgemm is availab
-000216d0: 6c65 0a20 2020 2066 6e73 203d 2063 6f6c  le.    fns = col
-000216e0: 6c65 6374 5f70 726f 635f 6d61 7073 5f65  lect_proc_maps_e
-000216f0: 7865 635f 6669 6c65 7328 290a 2020 2020  xec_files().    
-00021700: 666e 735f 7769 7468 5f73 6765 6d6d 203d  fns_with_sgemm =
-00021710: 205b 5d0a 2020 2020 666f 7220 666e 2069   [].    for fn i
-00021720: 6e20 666e 733a 0a20 2020 2020 2020 206f  n fns:.        o
-00021730: 7574 203d 2066 696e 645f 7379 6d5f 696e  ut = find_sym_in
-00021740: 5f65 7865 6328 666e 2c20 2273 6765 6d6d  _exec(fn, "sgemm
-00021750: 5f22 290a 2020 2020 2020 2020 6966 206f  _").        if o
-00021760: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-00021770: 666e 735f 7769 7468 5f73 6765 6d6d 2e61  fns_with_sgemm.a
-00021780: 7070 656e 6428 666e 290a 2020 2020 5f66  ppend(fn).    _f
-00021790: 696e 645f 7367 656d 6d5f 6c69 625f 6672  ind_sgemm_lib_fr
-000217a0: 6f6d 5f72 756e 7469 6d65 5f63 6163 6865  om_runtime_cache
-000217b0: 6420 3d20 666e 735f 7769 7468 5f73 6765  d = fns_with_sge
-000217c0: 6d6d 0a20 2020 2072 6574 7572 6e20 666e  mm.    return fn
-000217d0: 735f 7769 7468 5f73 6765 6d6d 0a0a 0a5f  s_with_sgemm..._
-000217e0: 6669 6e64 5f6c 6962 6375 6461 7274 5f66  find_libcudart_f
-000217f0: 726f 6d5f 7275 6e74 696d 655f 6361 6368  rom_runtime_cach
-00021800: 6564 203d 204e 6f6e 650a 0a0a 6465 6620  ed = None...def 
-00021810: 6669 6e64 5f6c 6962 6375 6461 7274 5f66  find_libcudart_f
-00021820: 726f 6d5f 7275 6e74 696d 6528 293a 0a20  rom_runtime():. 
-00021830: 2020 2022 2222 0a20 2020 204c 6f6f 6b73     """.    Looks
-00021840: 2074 6872 6f75 6768 2061 6c6c 206c 6962   through all lib
-00021850: 7320 7669 6120 3a66 756e 633a 6063 6f6c  s via :func:`col
-00021860: 6c65 6374 5f70 726f 635f 6d61 7073 5f65  lect_proc_maps_e
-00021870: 7865 635f 6669 6c65 7360 2c0a 2020 2020  xec_files`,.    
-00021880: 616e 6420 7365 6172 6368 6573 2066 6f72  and searches for
-00021890: 2061 6c6c 2077 6869 6368 2068 6176 6520   all which have 
-000218a0: 7468 6520 6060 7367 656d 6d60 6020 7379  the ``sgemm`` sy
-000218b0: 6d62 6f6c 2e0a 2020 2020 4375 7272 656e  mbol..    Curren
-000218c0: 746c 7920 6f6e 6c79 2077 6f72 6b73 206f  tly only works o
-000218d0: 6e20 4c69 6e75 7820 2862 6563 6175 7365  n Linux (because
-000218e0: 2063 6f6c 6c65 6374 5f70 726f 635f 6d61   collect_proc_ma
-000218f0: 7073 5f65 7865 635f 6669 6c65 7329 2e0a  ps_exec_files)..
-00021900: 0a20 2020 203a 7265 7475 726e 3a20 6c69  .    :return: li
-00021910: 7374 206f 6620 6c69 6273 2028 7468 6569  st of libs (thei
-00021920: 7220 7061 7468 290a 2020 2020 3a72 7479  r path).    :rty
-00021930: 7065 3a20 7374 727c 4e6f 6e65 0a20 2020  pe: str|None.   
-00021940: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
-00021950: 6f73 2e70 6174 682e 6578 6973 7473 2822  os.path.exists("
-00021960: 2f70 726f 6322 293a 0a20 2020 2020 2020  /proc"):.       
-00021970: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-00021980: 2067 6c6f 6261 6c20 5f66 696e 645f 6c69   global _find_li
-00021990: 6263 7564 6172 745f 6672 6f6d 5f72 756e  bcudart_from_run
-000219a0: 7469 6d65 5f63 6163 6865 640a 2020 2020  time_cached.    
-000219b0: 6966 205f 6669 6e64 5f6c 6962 6375 6461  if _find_libcuda
-000219c0: 7274 5f66 726f 6d5f 7275 6e74 696d 655f  rt_from_runtime_
-000219d0: 6361 6368 6564 2069 7320 6e6f 7420 4e6f  cached is not No
-000219e0: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
-000219f0: 726e 205f 6669 6e64 5f6c 6962 6375 6461  rn _find_libcuda
-00021a00: 7274 5f66 726f 6d5f 7275 6e74 696d 655f  rt_from_runtime_
-00021a10: 6361 6368 6564 5b30 5d0a 2020 2020 666e  cached[0].    fn
-00021a20: 7320 3d20 636f 6c6c 6563 745f 7072 6f63  s = collect_proc
-00021a30: 5f6d 6170 735f 6578 6563 5f66 696c 6573  _maps_exec_files
-00021a40: 2829 0a20 2020 2066 6f72 2066 6e20 696e  ().    for fn in
-00021a50: 2066 6e73 3a0a 2020 2020 2020 2020 6966   fns:.        if
-00021a60: 2072 652e 6d61 7463 6828 222e 2a2f 6c69   re.match(".*/li
-00021a70: 6263 7564 6172 745c 5c2e 736f 285c 5c2e  bcudart\\.so(\\.
-00021a80: 2e2a 293f 222c 2066 6e29 3a0a 2020 2020  .*)?", fn):.    
-00021a90: 2020 2020 2020 2020 5f66 696e 645f 6c69          _find_li
-00021aa0: 6263 7564 6172 745f 6672 6f6d 5f72 756e  bcudart_from_run
-00021ab0: 7469 6d65 5f63 6163 6865 6420 3d20 5b66  time_cached = [f
-00021ac0: 6e5d 0a20 2020 2020 2020 2020 2020 2072  n].            r
-00021ad0: 6574 7572 6e20 666e 0a20 2020 205f 6669  eturn fn.    _fi
-00021ae0: 6e64 5f6c 6962 6375 6461 7274 5f66 726f  nd_libcudart_fro
-00021af0: 6d5f 7275 6e74 696d 655f 6361 6368 6564  m_runtime_cached
-00021b00: 203d 205b 4e6f 6e65 5d0a 2020 2020 7265   = [None].    re
-00021b10: 7475 726e 204e 6f6e 650a                 turn None.
+0000d270: 2020 2020 7265 7420 2b3d 205b 2222 5d0a      ret += [""].
+0000d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d290: 2020 2020 2020 2020 7265 745b 2d31 5d20          ret[-1] 
+0000d2a0: 2b3d 2063 0a20 2020 2020 2020 2020 2020  += c.           
+0000d2b0: 2020 2020 2065 6c73 653a 2020 2320 6e6f       else:  # no
+0000d2c0: 7420 776f 7264 5f62 6173 6564 0a20 2020  t word_based.   
+0000d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2e0: 2072 6574 202b 3d20 630a 2020 2020 7265   ret += c.    re
+0000d2f0: 7475 726e 2072 6574 0a0a 0a64 6566 2070  turn ret...def p
+0000d300: 6172 7365 5f6f 7274 686f 6772 6170 6879  arse_orthography
+0000d310: 280a 2020 2020 6f72 7468 6f67 7261 7068  (.    orthograph
+0000d320: 792c 2070 7265 6669 783d 2829 2c20 706f  y, prefix=(), po
+0000d330: 7374 6669 783d 2822 5b45 4e44 5d22 2c29  stfix=("[END]",)
+0000d340: 2c20 7265 6d6f 7665 5f63 6861 7273 3d22  , remove_chars="
+0000d350: 2829 7b7d 222c 2063 6f6c 6c61 7073 655f  (){}", collapse_
+0000d360: 7370 6163 6573 3d54 7275 652c 2066 696e  spaces=True, fin
+0000d370: 616c 5f73 7472 6970 3d54 7275 652c 202a  al_strip=True, *
+0000d380: 2a6b 7761 7267 730a 293a 0a20 2020 2022  *kwargs.):.    "
+0000d390: 2222 0a20 2020 2046 6f72 2053 7065 6563  "".    For Speec
+0000d3a0: 682e 2046 756c 6c20 7072 6f63 6573 7369  h. Full processi
+0000d3b0: 6e67 2e0a 2020 2020 4578 616d 706c 653a  ng..    Example:
+0000d3c0: 0a20 2020 2020 206f 7274 686f 6772 6170  .      orthograp
+0000d3d0: 6879 203d 2022 6865 6c6c 6f20 5b48 4553  hy = "hello [HES
+0000d3e0: 4954 4154 494f 4e5d 2074 6865 7265 2022  ITATION] there "
+0000d3f0: 0a20 2020 2020 2077 6974 6820 776f 7264  .      with word
+0000d400: 5f62 6173 6564 203d 3d20 4661 6c73 653a  _based == False:
+0000d410: 2072 6574 7572 6e73 206c 6973 7428 2268   returns list("h
+0000d420: 656c 6c6f 2022 2920 2b20 5b22 5b48 4553  ello ") + ["[HES
+0000d430: 4954 4154 494f 4e5d 225d 202b 206c 6973  ITATION]"] + lis
+0000d440: 7428 2220 7468 6572 6522 2920 2b20 5b22  t(" there") + ["
+0000d450: 5b45 4e44 5d22 5d0a 2020 2020 2020 7769  [END]"].      wi
+0000d460: 7468 2077 6f72 645f 6261 7365 6420 3d3d  th word_based ==
+0000d470: 2054 7275 653a 2072 6574 7572 6e73 205b   True: returns [
+0000d480: 2268 656c 6c6f 222c 2022 5b48 4553 4954  "hello", "[HESIT
+0000d490: 4154 494f 4e5d 222c 2022 7468 6572 6522  ATION]", "there"
+0000d4a0: 2c20 225b 454e 445d 225d 0a20 2020 2044  , "[END]"].    D
+0000d4b0: 6f65 7320 736f 6d65 2070 7265 7072 6f63  oes some preproc
+0000d4c0: 6573 7369 6e67 206f 6e20 6f72 7468 6f67  essing on orthog
+0000d4d0: 7261 7068 7920 616e 6420 7468 656e 2070  raphy and then p
+0000d4e0: 6173 7365 7320 6974 206f 6e20 746f 2070  asses it on to p
+0000d4f0: 6172 7365 5f6f 7274 686f 6772 6170 6879  arse_orthography
+0000d500: 5f69 6e74 6f5f 7379 6d62 6f6c 7328 292e  _into_symbols().
+0000d510: 0a0a 2020 2020 3a70 6172 616d 2073 7472  ..    :param str
+0000d520: 206f 7274 686f 6772 6170 6879 3a20 652e   orthography: e.
+0000d530: 672e 2022 6865 6c6c 6f20 5b48 4553 4954  g. "hello [HESIT
+0000d540: 4154 494f 4e5d 2074 6865 7265 2022 0a20  ATION] there ". 
+0000d550: 2020 203a 7061 7261 6d20 6c69 7374 5b73     :param list[s
+0000d560: 7472 5d20 7072 6566 6978 3a20 7769 6c6c  tr] prefix: will
+0000d570: 2061 6464 2074 6869 7320 7072 6566 6978   add this prefix
+0000d580: 0a20 2020 203a 7061 7261 6d20 6c69 7374  .    :param list
+0000d590: 5b73 7472 5d20 706f 7374 6669 783a 2077  [str] postfix: w
+0000d5a0: 696c 6c20 6164 6420 7468 6973 2070 6f73  ill add this pos
+0000d5b0: 7466 6978 0a20 2020 203a 7061 7261 6d20  tfix.    :param 
+0000d5c0: 7374 7220 7265 6d6f 7665 5f63 6861 7273  str remove_chars
+0000d5d0: 3a20 7468 6f73 6520 6368 6172 7320 7769  : those chars wi
+0000d5e0: 6c6c 206a 7573 7420 6265 2072 656d 6f76  ll just be remov
+0000d5f0: 6564 2061 7420 7468 6520 6265 6769 6e6e  ed at the beginn
+0000d600: 696e 670a 2020 2020 3a70 6172 616d 2062  ing.    :param b
+0000d610: 6f6f 6c20 636f 6c6c 6170 7365 5f73 7061  ool collapse_spa
+0000d620: 6365 733a 2077 6865 7468 6572 206d 756c  ces: whether mul
+0000d630: 7469 706c 6520 7370 6163 6573 2061 6e64  tiple spaces and
+0000d640: 2074 6162 7320 6172 6520 636f 6c6c 6170   tabs are collap
+0000d650: 7365 6420 696e 746f 2061 2073 696e 676c  sed into a singl
+0000d660: 6520 7370 6163 650a 2020 2020 3a70 6172  e space.    :par
+0000d670: 616d 2062 6f6f 6c20 6669 6e61 6c5f 7374  am bool final_st
+0000d680: 7269 703a 2077 6865 7468 6572 2077 6520  rip: whether we 
+0000d690: 7374 7269 7020 6c65 6674 2061 6e64 2072  strip left and r
+0000d6a0: 6967 6874 0a20 2020 203a 7061 7261 6d20  ight.    :param 
+0000d6b0: 6b77 6172 6773 3a20 7061 7373 6564 206f  kwargs: passed o
+0000d6c0: 6e20 746f 2070 6172 7365 5f6f 7274 686f  n to parse_ortho
+0000d6d0: 6772 6170 6879 5f69 6e74 6f5f 7379 6d62  graphy_into_symb
+0000d6e0: 6f6c 7328 290a 2020 2020 3a72 7479 7065  ols().    :rtype
+0000d6f0: 3a20 6c69 7374 5b73 7472 5d0a 2020 2020  : list[str].    
+0000d700: 2222 220a 2020 2020 666f 7220 6320 696e  """.    for c in
+0000d710: 2072 656d 6f76 655f 6368 6172 733a 0a20   remove_chars:. 
+0000d720: 2020 2020 2020 206f 7274 686f 6772 6170         orthograp
+0000d730: 6879 203d 206f 7274 686f 6772 6170 6879  hy = orthography
+0000d740: 2e72 6570 6c61 6365 2863 2c20 2222 290a  .replace(c, "").
+0000d750: 2020 2020 6966 2063 6f6c 6c61 7073 655f      if collapse_
+0000d760: 7370 6163 6573 3a0a 2020 2020 2020 2020  spaces:.        
+0000d770: 6f72 7468 6f67 7261 7068 7920 3d20 2220  orthography = " 
+0000d780: 222e 6a6f 696e 286f 7274 686f 6772 6170  ".join(orthograp
+0000d790: 6879 2e73 706c 6974 2829 290a 2020 2020  hy.split()).    
+0000d7a0: 6966 2066 696e 616c 5f73 7472 6970 3a0a  if final_strip:.
+0000d7b0: 2020 2020 2020 2020 6f72 7468 6f67 7261          orthogra
+0000d7c0: 7068 7920 3d20 6f72 7468 6f67 7261 7068  phy = orthograph
+0000d7d0: 792e 7374 7269 7028 290a 2020 2020 7265  y.strip().    re
+0000d7e0: 7475 726e 206c 6973 7428 7072 6566 6978  turn list(prefix
+0000d7f0: 2920 2b20 7061 7273 655f 6f72 7468 6f67  ) + parse_orthog
+0000d800: 7261 7068 795f 696e 746f 5f73 796d 626f  raphy_into_symbo
+0000d810: 6c73 286f 7274 686f 6772 6170 6879 2c20  ls(orthography, 
+0000d820: 2a2a 6b77 6172 6773 2920 2b20 6c69 7374  **kwargs) + list
+0000d830: 2870 6f73 7466 6978 290a 0a0a 6465 6620  (postfix)...def 
+0000d840: 6a73 6f6e 5f72 656d 6f76 655f 636f 6d6d  json_remove_comm
+0000d850: 656e 7473 2873 7472 696e 672c 2073 7472  ents(string, str
+0000d860: 6970 5f73 7061 6365 3d54 7275 6529 3a0a  ip_space=True):.
+0000d870: 2020 2020 2222 220a 2020 2020 3a74 7970      """.    :typ
+0000d880: 6520 7374 7269 6e67 3a20 7374 720a 2020  e string: str.  
+0000d890: 2020 3a70 6172 616d 2062 6f6f 6c20 7374    :param bool st
+0000d8a0: 7269 705f 7370 6163 653a 0a20 2020 203a  rip_space:.    :
+0000d8b0: 7274 7970 653a 2073 7472 0a0a 2020 2020  rtype: str..    
+0000d8c0: 7669 6120 6874 7470 733a 2f2f 6769 7468  via https://gith
+0000d8d0: 7562 2e63 6f6d 2f67 6574 6966 792f 4a53  ub.com/getify/JS
+0000d8e0: 4f4e 2e6d 696e 6966 792f 626c 6f62 2f6d  ON.minify/blob/m
+0000d8f0: 6173 7465 722f 6d69 6e69 6679 5f6a 736f  aster/minify_jso
+0000d900: 6e2e 7079 2c0a 2020 2020 6279 2047 6572  n.py,.    by Ger
+0000d910: 616c 6420 5374 6f72 6572 2c20 5072 6164  ald Storer, Prad
+0000d920: 7975 6e20 532e 2047 6564 616d 2c20 6d6f  yun S. Gedam, mo
+0000d930: 6469 6669 6564 2062 7920 7573 2e0a 2020  dified by us..  
+0000d940: 2020 2222 220a 2020 2020 746f 6b65 6e69    """.    tokeni
+0000d950: 7a65 7220 3d20 7265 2e63 6f6d 7069 6c65  zer = re.compile
+0000d960: 2827 227c 282f 5c5c 2a29 7c28 5c5c 2a2f  ('"|(/\\*)|(\\*/
+0000d970: 297c 282f 2f29 7c5c 6e7c 5c72 2729 0a20  )|(//)|\n|\r'). 
+0000d980: 2020 2065 6e64 5f73 6c61 7368 6573 5f72     end_slashes_r
+0000d990: 6520 3d20 7265 2e63 6f6d 7069 6c65 2872  e = re.compile(r
+0000d9a0: 2228 5c5c 292a 2422 290a 0a20 2020 2069  "(\\)*$")..    i
+0000d9b0: 6e5f 7374 7269 6e67 203d 2046 616c 7365  n_string = False
+0000d9c0: 0a20 2020 2069 6e5f 6d75 6c74 6920 3d20  .    in_multi = 
+0000d9d0: 4661 6c73 650a 2020 2020 696e 5f73 696e  False.    in_sin
+0000d9e0: 676c 6520 3d20 4661 6c73 650a 0a20 2020  gle = False..   
+0000d9f0: 206e 6577 5f73 7472 203d 205b 5d0a 2020   new_str = [].  
+0000da00: 2020 696e 6465 7820 3d20 300a 0a20 2020    index = 0..   
+0000da10: 2066 6f72 206d 6174 6368 2069 6e20 7265   for match in re
+0000da20: 2e66 696e 6469 7465 7228 746f 6b65 6e69  .finditer(tokeni
+0000da30: 7a65 722c 2073 7472 696e 6729 3a0a 0a20  zer, string):.. 
+0000da40: 2020 2020 2020 2069 6620 6e6f 7420 2869         if not (i
+0000da50: 6e5f 6d75 6c74 6920 6f72 2069 6e5f 7369  n_multi or in_si
+0000da60: 6e67 6c65 293a 0a20 2020 2020 2020 2020  ngle):.         
+0000da70: 2020 2074 6d70 203d 2073 7472 696e 675b     tmp = string[
+0000da80: 696e 6465 7820 3a20 6d61 7463 682e 7374  index : match.st
+0000da90: 6172 7428 295d 0a20 2020 2020 2020 2020  art()].         
+0000daa0: 2020 2069 6620 6e6f 7420 696e 5f73 7472     if not in_str
+0000dab0: 696e 6720 616e 6420 7374 7269 705f 7370  ing and strip_sp
+0000dac0: 6163 653a 0a20 2020 2020 2020 2020 2020  ace:.           
+0000dad0: 2020 2020 2023 2072 6570 6c61 6365 2077       # replace w
+0000dae0: 6869 7465 2073 7061 6365 2061 7320 6465  hite space as de
+0000daf0: 6669 6e65 6420 696e 2073 7461 6e64 6172  fined in standar
+0000db00: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0000db10: 2020 746d 7020 3d20 7265 2e73 7562 2822    tmp = re.sub("
+0000db20: 5b20 5c74 5c6e 5c72 5d2b 222c 2022 222c  [ \t\n\r]+", "",
+0000db30: 2074 6d70 290a 2020 2020 2020 2020 2020   tmp).          
+0000db40: 2020 6e65 775f 7374 722e 6170 7065 6e64    new_str.append
+0000db50: 2874 6d70 290a 0a20 2020 2020 2020 2069  (tmp)..        i
+0000db60: 6e64 6578 203d 206d 6174 6368 2e65 6e64  ndex = match.end
+0000db70: 2829 0a20 2020 2020 2020 2076 616c 203d  ().        val =
+0000db80: 206d 6174 6368 2e67 726f 7570 2829 0a0a   match.group()..
+0000db90: 2020 2020 2020 2020 6966 2076 616c 203d          if val =
+0000dba0: 3d20 2722 2720 616e 6420 6e6f 7420 2869  = '"' and not (i
+0000dbb0: 6e5f 6d75 6c74 6920 6f72 2069 6e5f 7369  n_multi or in_si
+0000dbc0: 6e67 6c65 293a 0a20 2020 2020 2020 2020  ngle):.         
+0000dbd0: 2020 2065 7363 6170 6564 203d 2065 6e64     escaped = end
+0000dbe0: 5f73 6c61 7368 6573 5f72 652e 7365 6172  _slashes_re.sear
+0000dbf0: 6368 2873 7472 696e 672c 2030 2c20 6d61  ch(string, 0, ma
+0000dc00: 7463 682e 7374 6172 7428 2929 0a0a 2020  tch.start())..  
+0000dc10: 2020 2020 2020 2020 2020 2320 7374 6172            # star
+0000dc20: 7420 6f66 2073 7472 696e 6720 6f72 2075  t of string or u
+0000dc30: 6e65 7363 6170 6564 2071 756f 7465 2063  nescaped quote c
+0000dc40: 6861 7261 6374 6572 2074 6f20 656e 6420  haracter to end 
+0000dc50: 7374 7269 6e67 0a20 2020 2020 2020 2020  string.         
+0000dc60: 2020 2069 6620 6e6f 7420 696e 5f73 7472     if not in_str
+0000dc70: 696e 6720 6f72 2028 6573 6361 7065 6420  ing or (escaped 
+0000dc80: 6973 204e 6f6e 6520 6f72 206c 656e 2865  is None or len(e
+0000dc90: 7363 6170 6564 2e67 726f 7570 2829 2920  scaped.group()) 
+0000dca0: 2520 3220 3d3d 2030 293a 0a20 2020 2020  % 2 == 0):.     
+0000dcb0: 2020 2020 2020 2020 2020 2069 6e5f 7374             in_st
+0000dcc0: 7269 6e67 203d 206e 6f74 2069 6e5f 7374  ring = not in_st
+0000dcd0: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
+0000dce0: 2069 6e64 6578 202d 3d20 3120 2023 2069   index -= 1  # i
+0000dcf0: 6e63 6c75 6465 2022 2063 6861 7261 6374  nclude " charact
+0000dd00: 6572 2069 6e20 6e65 7874 2063 6174 6368  er in next catch
+0000dd10: 0a20 2020 2020 2020 2065 6c69 6620 6e6f  .        elif no
+0000dd20: 7420 2869 6e5f 7374 7269 6e67 206f 7220  t (in_string or 
+0000dd30: 696e 5f6d 756c 7469 206f 7220 696e 5f73  in_multi or in_s
+0000dd40: 696e 676c 6529 3a0a 2020 2020 2020 2020  ingle):.        
+0000dd50: 2020 2020 6966 2076 616c 203d 3d20 222f      if val == "/
+0000dd60: 2a22 3a0a 2020 2020 2020 2020 2020 2020  *":.            
+0000dd70: 2020 2020 696e 5f6d 756c 7469 203d 2054      in_multi = T
+0000dd80: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0000dd90: 656c 6966 2076 616c 203d 3d20 222f 2f22  elif val == "//"
+0000dda0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ddb0: 2020 696e 5f73 696e 676c 6520 3d20 5472    in_single = Tr
+0000ddc0: 7565 0a20 2020 2020 2020 2065 6c69 6620  ue.        elif 
+0000ddd0: 7661 6c20 3d3d 2022 2a2f 2220 616e 6420  val == "*/" and 
+0000dde0: 696e 5f6d 756c 7469 2061 6e64 206e 6f74  in_multi and not
+0000ddf0: 2028 696e 5f73 7472 696e 6720 6f72 2069   (in_string or i
+0000de00: 6e5f 7369 6e67 6c65 293a 0a20 2020 2020  n_single):.     
+0000de10: 2020 2020 2020 2069 6e5f 6d75 6c74 6920         in_multi 
+0000de20: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0000de30: 656c 6966 2076 616c 2069 6e20 225c 725c  elif val in "\r\
+0000de40: 6e22 2061 6e64 206e 6f74 2028 696e 5f6d  n" and not (in_m
+0000de50: 756c 7469 206f 7220 696e 5f73 7472 696e  ulti or in_strin
+0000de60: 6729 2061 6e64 2069 6e5f 7369 6e67 6c65  g) and in_single
+0000de70: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
+0000de80: 5f73 696e 676c 6520 3d20 4661 6c73 650a  _single = False.
+0000de90: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
+0000dea0: 2028 2869 6e5f 6d75 6c74 6920 6f72 2069   ((in_multi or i
+0000deb0: 6e5f 7369 6e67 6c65 2920 6f72 2028 7661  n_single) or (va
+0000dec0: 6c20 696e 2022 205c 725c 6e5c 7422 2061  l in " \r\n\t" a
+0000ded0: 6e64 2073 7472 6970 5f73 7061 6365 2929  nd strip_space))
+0000dee0: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+0000def0: 775f 7374 722e 6170 7065 6e64 2876 616c  w_str.append(val
+0000df00: 290a 0a20 2020 206e 6577 5f73 7472 2e61  )..    new_str.a
+0000df10: 7070 656e 6428 7374 7269 6e67 5b69 6e64  ppend(string[ind
+0000df20: 6578 3a5d 290a 2020 2020 7265 7475 726e  ex:]).    return
+0000df30: 2022 222e 6a6f 696e 286e 6577 5f73 7472   "".join(new_str
+0000df40: 290a 0a0a 6465 6620 5f70 7932 5f75 6e69  )...def _py2_uni
+0000df50: 636f 6465 5f74 6f5f 7374 725f 7265 6375  code_to_str_recu
+0000df60: 7273 6976 6528 7329 3a0a 2020 2020 2222  rsive(s):.    ""
+0000df70: 220a 2020 2020 5468 6973 2069 7320 7375  ".    This is su
+0000df80: 7070 6f73 6564 2074 6f20 6265 2072 756e  pposed to be run
+0000df90: 2077 6974 6820 5079 7468 6f6e 2032 2e0a   with Python 2..
+0000dfa0: 2020 2020 416c 736f 2073 6565 203a 6675      Also see :fu
+0000dfb0: 6e63 3a60 6173 5f73 7472 6020 616e 6420  nc:`as_str` and 
+0000dfc0: 3a66 756e 633a 6070 7932 5f75 7466 385f  :func:`py2_utf8_
+0000dfd0: 7374 725f 746f 5f75 6e69 636f 6465 602e  str_to_unicode`.
+0000dfe0: 0a0a 2020 2020 3a70 6172 616d 2073 7472  ..    :param str
+0000dff0: 7c75 6e69 636f 6465 2073 3a20 6f72 2061  |unicode s: or a
+0000e000: 6e79 2072 6563 7572 7369 7665 2073 7472  ny recursive str
+0000e010: 7563 7475 7265 2073 7563 6820 6173 2064  ucture such as d
+0000e020: 6963 742c 206c 6973 742c 2074 7570 6c65  ict, list, tuple
+0000e030: 0a20 2020 203a 7265 7475 726e 3a20 5079  .    :return: Py
+0000e040: 7468 6f6e 2032 2073 7472 2028 6973 206c  thon 2 str (is l
+0000e050: 696b 6520 5079 7468 6f6e 2033 2055 5446  ike Python 3 UTF
+0000e060: 2d38 2066 6f72 6d61 7474 6564 2062 7974  -8 formatted byt
+0000e070: 6573 290a 2020 2020 3a72 7479 7065 3a20  es).    :rtype: 
+0000e080: 7374 720a 2020 2020 2222 220a 2020 2020  str.    """.    
+0000e090: 6966 2069 7369 6e73 7461 6e63 6528 732c  if isinstance(s,
+0000e0a0: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+0000e0b0: 7265 7475 726e 207b 5f70 7932 5f75 6e69  return {_py2_uni
+0000e0c0: 636f 6465 5f74 6f5f 7374 725f 7265 6375  code_to_str_recu
+0000e0d0: 7273 6976 6528 6b65 7929 3a20 5f70 7932  rsive(key): _py2
+0000e0e0: 5f75 6e69 636f 6465 5f74 6f5f 7374 725f  _unicode_to_str_
+0000e0f0: 7265 6375 7273 6976 6528 7661 6c75 6529  recursive(value)
+0000e100: 2066 6f72 206b 6579 2c20 7661 6c75 6520   for key, value 
+0000e110: 696e 2073 2e69 7465 6d73 2829 7d0a 2020  in s.items()}.  
+0000e120: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0000e130: 6528 732c 2028 6c69 7374 2c20 7475 706c  e(s, (list, tupl
+0000e140: 6529 293a 0a20 2020 2020 2020 2072 6574  e)):.        ret
+0000e150: 7572 6e20 6d61 6b65 5f73 6571 5f6f 665f  urn make_seq_of_
+0000e160: 7479 7065 2874 7970 6528 7329 2c20 5b5f  type(type(s), [_
+0000e170: 7079 325f 756e 6963 6f64 655f 746f 5f73  py2_unicode_to_s
+0000e180: 7472 5f72 6563 7572 7369 7665 2865 6c65  tr_recursive(ele
+0000e190: 6d65 6e74 2920 666f 7220 656c 656d 656e  ment) for elemen
+0000e1a0: 7420 696e 2073 5d29 0a20 2020 2065 6c69  t in s]).    eli
+0000e1b0: 6620 6973 696e 7374 616e 6365 2873 2c20  f isinstance(s, 
+0000e1c0: 756e 6963 6f64 6529 3a0a 2020 2020 2020  unicode):.      
+0000e1d0: 2020 7265 7475 726e 2073 2e65 6e63 6f64    return s.encod
+0000e1e0: 6528 2275 7466 2d38 2229 2020 2320 5079  e("utf-8")  # Py
+0000e1f0: 7468 6f6e 2032 2073 7472 2c20 5079 7468  thon 2 str, Pyth
+0000e200: 6f6e 2033 2062 7974 6573 0a20 2020 2065  on 3 bytes.    e
+0000e210: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
+0000e220: 7572 6e20 730a 0a0a 6465 6620 6c6f 6164  urn s...def load
+0000e230: 5f6a 736f 6e28 6669 6c65 6e61 6d65 3d4e  _json(filename=N
+0000e240: 6f6e 652c 2063 6f6e 7465 6e74 3d4e 6f6e  one, content=Non
+0000e250: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+0000e260: 3a70 6172 616d 2073 7472 7c4e 6f6e 6520  :param str|None 
+0000e270: 6669 6c65 6e61 6d65 3a0a 2020 2020 3a70  filename:.    :p
+0000e280: 6172 616d 2073 7472 7c4e 6f6e 6520 636f  aram str|None co
+0000e290: 6e74 656e 743a 0a20 2020 203a 7274 7970  ntent:.    :rtyp
+0000e2a0: 653a 2064 6963 745b 7374 725d 0a20 2020  e: dict[str].   
+0000e2b0: 2022 2222 0a20 2020 2069 6620 636f 6e74   """.    if cont
+0000e2c0: 656e 743a 0a20 2020 2020 2020 2061 7373  ent:.        ass
+0000e2d0: 6572 7420 6e6f 7420 6669 6c65 6e61 6d65  ert not filename
+0000e2e0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000e2f0: 2020 2063 6f6e 7465 6e74 203d 206f 7065     content = ope
+0000e300: 6e28 6669 6c65 6e61 6d65 292e 7265 6164  n(filename).read
+0000e310: 2829 0a20 2020 2069 6d70 6f72 7420 6a73  ().    import js
+0000e320: 6f6e 0a0a 2020 2020 636f 6e74 656e 7420  on..    content 
+0000e330: 3d20 6a73 6f6e 5f72 656d 6f76 655f 636f  = json_remove_co
+0000e340: 6d6d 656e 7473 2863 6f6e 7465 6e74 290a  mments(content).
+0000e350: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000e360: 206a 736f 6e5f 636f 6e74 656e 7420 3d20   json_content = 
+0000e370: 6a73 6f6e 2e6c 6f61 6473 2863 6f6e 7465  json.loads(conte
+0000e380: 6e74 290a 2020 2020 6578 6365 7074 2056  nt).    except V
+0000e390: 616c 7565 4572 726f 7220 6173 2065 3a0a  alueError as e:.
+0000e3a0: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0000e3b0: 6365 7074 696f 6e28 2263 6f6e 6669 6720  ception("config 
+0000e3c0: 6c6f 6f6b 7320 6c69 6b65 204a 534f 4e20  looks like JSON 
+0000e3d0: 6275 7420 696e 7661 6c69 6420 6a73 6f6e  but invalid json
+0000e3e0: 2063 6f6e 7465 6e74 2c20 2572 2220 2520   content, %r" % 
+0000e3f0: 6529 0a20 2020 2069 6620 6e6f 7420 5059  e).    if not PY
+0000e400: 333a 0a20 2020 2020 2020 206a 736f 6e5f  3:.        json_
+0000e410: 636f 6e74 656e 7420 3d20 5f70 7932 5f75  content = _py2_u
+0000e420: 6e69 636f 6465 5f74 6f5f 7374 725f 7265  nicode_to_str_re
+0000e430: 6375 7273 6976 6528 6a73 6f6e 5f63 6f6e  cursive(json_con
+0000e440: 7465 6e74 290a 2020 2020 7265 7475 726e  tent).    return
+0000e450: 206a 736f 6e5f 636f 6e74 656e 740a 0a0a   json_content...
+0000e460: 636c 6173 7320 4e75 6d62 6572 7344 6963  class NumbersDic
+0000e470: 743a 0a20 2020 2022 2222 0a20 2020 2049  t:.    """.    I
+0000e480: 7427 7320 6d6f 7374 6c79 206c 696b 6520  t's mostly like 
+0000e490: 6469 6374 5b73 7472 2c66 6c6f 6174 7c69  dict[str,float|i
+0000e4a0: 6e74 5d20 2620 736f 6d65 206f 7074 696f  nt] & some optio
+0000e4b0: 6e61 6c20 6272 6f61 6463 6173 7420 6465  nal broadcast de
+0000e4c0: 6661 756c 7420 7661 6c75 652e 0a20 2020  fault value..   
+0000e4d0: 2049 7420 696d 706c 656d 656e 7473 2074   It implements t
+0000e4e0: 6865 2073 7461 6e64 6172 6420 6d61 7468  he standard math
+0000e4f0: 2062 696e 206f 7073 2069 6e20 6120 7374   bin ops in a st
+0000e500: 7261 6967 6874 2d66 6f72 7761 7264 2077  raight-forward w
+0000e510: 6179 2e0a 2020 2020 2222 220a 0a20 2020  ay..    """..   
+0000e520: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000e530: 6c66 2c20 6175 746f 5f63 6f6e 7665 7274  lf, auto_convert
+0000e540: 3d4e 6f6e 652c 206e 756d 6265 7273 5f64  =None, numbers_d
+0000e550: 6963 743d 4e6f 6e65 2c20 6272 6f61 6463  ict=None, broadc
+0000e560: 6173 745f 7661 6c75 653d 4e6f 6e65 293a  ast_value=None):
+0000e570: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000e580: 2020 2020 203a 7061 7261 6d20 6469 6374       :param dict
+0000e590: 7c4e 756d 6265 7273 4469 6374 7c54 2061  |NumbersDict|T a
+0000e5a0: 7574 6f5f 636f 6e76 6572 743a 2066 6972  uto_convert: fir
+0000e5b0: 7374 2061 7267 756d 656e 742c 2073 6f20  st argument, so 
+0000e5c0: 7468 6174 2077 6520 6361 6e20 6175 746f  that we can auto
+0000e5d0: 6d61 7469 6361 6c6c 7920 636f 6e76 6572  matically conver
+0000e5e0: 742f 636f 7079 0a20 2020 2020 2020 203a  t/copy.        :
+0000e5f0: 7061 7261 6d20 6469 6374 206e 756d 6265  param dict numbe
+0000e600: 7273 5f64 6963 743a 0a20 2020 2020 2020  rs_dict:.       
+0000e610: 203a 7061 7261 6d20 5420 6272 6f61 6463   :param T broadc
+0000e620: 6173 745f 7661 6c75 653a 0a20 2020 2020  ast_value:.     
+0000e630: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0000e640: 6620 6175 746f 5f63 6f6e 7665 7274 2069  f auto_convert i
+0000e650: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0000e660: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+0000e670: 726f 6164 6361 7374 5f76 616c 7565 2069  roadcast_value i
+0000e680: 7320 4e6f 6e65 0a20 2020 2020 2020 2020  s None.         
+0000e690: 2020 2061 7373 6572 7420 6e75 6d62 6572     assert number
+0000e6a0: 735f 6469 6374 2069 7320 4e6f 6e65 0a20  s_dict is None. 
+0000e6b0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000e6c0: 696e 7374 616e 6365 2861 7574 6f5f 636f  instance(auto_co
+0000e6d0: 6e76 6572 742c 2064 6963 7429 3a0a 2020  nvert, dict):.  
+0000e6e0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
+0000e6f0: 6d62 6572 735f 6469 6374 203d 2061 7574  mbers_dict = aut
+0000e700: 6f5f 636f 6e76 6572 740a 2020 2020 2020  o_convert.      
+0000e710: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+0000e720: 7461 6e63 6528 6175 746f 5f63 6f6e 7665  tance(auto_conve
+0000e730: 7274 2c20 4e75 6d62 6572 7344 6963 7429  rt, NumbersDict)
+0000e740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e750: 2020 6e75 6d62 6572 735f 6469 6374 203d    numbers_dict =
+0000e760: 2061 7574 6f5f 636f 6e76 6572 742e 6469   auto_convert.di
+0000e770: 6374 0a20 2020 2020 2020 2020 2020 2020  ct.             
+0000e780: 2020 2062 726f 6164 6361 7374 5f76 616c     broadcast_val
+0000e790: 7565 203d 2061 7574 6f5f 636f 6e76 6572  ue = auto_conver
+0000e7a0: 742e 7661 6c75 650a 2020 2020 2020 2020  t.value.        
+0000e7b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000e7c0: 2020 2020 2020 2020 2020 6272 6f61 6463            broadc
+0000e7d0: 6173 745f 7661 6c75 6520 3d20 6175 746f  ast_value = auto
+0000e7e0: 5f63 6f6e 7665 7274 0a20 2020 2020 2020  _convert.       
+0000e7f0: 2069 6620 6e75 6d62 6572 735f 6469 6374   if numbers_dict
+0000e800: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000e810: 2020 2020 2020 6e75 6d62 6572 735f 6469        numbers_di
+0000e820: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
+0000e830: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000e840: 2020 6e75 6d62 6572 735f 6469 6374 203d    numbers_dict =
+0000e850: 2064 6963 7428 6e75 6d62 6572 735f 6469   dict(numbers_di
+0000e860: 6374 2920 2023 2066 6f72 6365 2063 6f70  ct)  # force cop
+0000e870: 790a 0a20 2020 2020 2020 2073 656c 662e  y..        self.
+0000e880: 6469 6374 203d 206e 756d 6265 7273 5f64  dict = numbers_d
+0000e890: 6963 740a 2020 2020 2020 2020 7365 6c66  ict.        self
+0000e8a0: 2e76 616c 7565 203d 2062 726f 6164 6361  .value = broadca
+0000e8b0: 7374 5f76 616c 7565 0a20 2020 2020 2020  st_value.       
+0000e8c0: 2073 656c 662e 6d61 7820 3d20 7365 6c66   self.max = self
+0000e8d0: 2e5f 6d61 785f 6572 726f 720a 0a20 2020  ._max_error..   
+0000e8e0: 2064 6566 2063 6f70 7928 7365 6c66 293a   def copy(self):
+0000e8f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000e900: 2020 2020 203a 7274 7970 653a 204e 756d       :rtype: Num
+0000e910: 6265 7273 4469 6374 0a20 2020 2020 2020  bersDict.       
+0000e920: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+0000e930: 7572 6e20 4e75 6d62 6572 7344 6963 7428  urn NumbersDict(
+0000e940: 7365 6c66 290a 0a20 2020 2040 636c 6173  self)..    @clas
+0000e950: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
+0000e960: 636f 6e73 7461 6e74 5f6c 696b 6528 636c  constant_like(cl
+0000e970: 732c 2063 6f6e 7374 5f6e 756d 6265 722c  s, const_number,
+0000e980: 206e 756d 6265 7273 5f64 6963 7429 3a0a   numbers_dict):.
+0000e990: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000e9a0: 2020 2020 3a70 6172 616d 2069 6e74 7c66      :param int|f
+0000e9b0: 6c6f 6174 7c6f 626a 6563 7420 636f 6e73  loat|object cons
+0000e9c0: 745f 6e75 6d62 6572 3a0a 2020 2020 2020  t_number:.      
+0000e9d0: 2020 3a70 6172 616d 204e 756d 6265 7273    :param Numbers
+0000e9e0: 4469 6374 206e 756d 6265 7273 5f64 6963  Dict numbers_dic
+0000e9f0: 743a 0a20 2020 2020 2020 203a 7265 7475  t:.        :retu
+0000ea00: 726e 3a20 4e75 6d62 6572 7344 6963 7420  rn: NumbersDict 
+0000ea10: 7769 7468 2073 616d 6520 6b65 7973 2061  with same keys a
+0000ea20: 7320 6e75 6d62 6572 735f 6469 6374 0a20  s numbers_dict. 
+0000ea30: 2020 2020 2020 203a 7274 7970 653a 204e         :rtype: N
+0000ea40: 756d 6265 7273 4469 6374 0a20 2020 2020  umbersDict.     
+0000ea50: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0000ea60: 6574 7572 6e20 4e75 6d62 6572 7344 6963  eturn NumbersDic
+0000ea70: 7428 0a20 2020 2020 2020 2020 2020 2062  t(.            b
+0000ea80: 726f 6164 6361 7374 5f76 616c 7565 3d63  roadcast_value=c
+0000ea90: 6f6e 7374 5f6e 756d 6265 7220 6966 2028  onst_number if (
+0000eaa0: 6e75 6d62 6572 735f 6469 6374 2e76 616c  numbers_dict.val
+0000eab0: 7565 2069 7320 6e6f 7420 4e6f 6e65 2920  ue is not None) 
+0000eac0: 656c 7365 204e 6f6e 652c 0a20 2020 2020  else None,.     
+0000ead0: 2020 2020 2020 206e 756d 6265 7273 5f64         numbers_d
+0000eae0: 6963 743d 7b6b 3a20 636f 6e73 745f 6e75  ict={k: const_nu
+0000eaf0: 6d62 6572 2066 6f72 206b 2069 6e20 6e75  mber for k in nu
+0000eb00: 6d62 6572 735f 6469 6374 2e64 6963 742e  mbers_dict.dict.
+0000eb10: 6b65 7973 2829 7d2c 0a20 2020 2020 2020  keys()},.       
+0000eb20: 2029 0a0a 2020 2020 6465 6620 636f 7079   )..    def copy
+0000eb30: 5f6c 696b 6528 7365 6c66 2c20 6e75 6d62  _like(self, numb
+0000eb40: 6572 735f 6469 6374 293a 0a20 2020 2020  ers_dict):.     
+0000eb50: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
+0000eb60: 7061 7261 6d20 4e75 6d62 6572 7344 6963  param NumbersDic
+0000eb70: 7420 6e75 6d62 6572 735f 6469 6374 3a0a  t numbers_dict:.
+0000eb80: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0000eb90: 2063 6f70 7920 6f66 2073 656c 6620 7769   copy of self wi
+0000eba0: 7468 2073 616d 6520 6b65 7973 2061 7320  th same keys as 
+0000ebb0: 6e75 6d62 6572 735f 6469 6374 2061 7320  numbers_dict as 
+0000ebc0: 6661 7220 6173 2077 6520 6861 7665 2074  far as we have t
+0000ebd0: 6865 6d0a 2020 2020 2020 2020 3a72 7479  hem.        :rty
+0000ebe0: 7065 3a20 4e75 6d62 6572 7344 6963 740a  pe: NumbersDict.
+0000ebf0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000ec00: 2020 2020 6966 2073 656c 662e 7661 6c75      if self.valu
+0000ec10: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+0000ec20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ec30: 6e20 4e75 6d62 6572 7344 6963 7428 0a20  n NumbersDict(. 
+0000ec40: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000ec50: 726f 6164 6361 7374 5f76 616c 7565 3d73  roadcast_value=s
+0000ec60: 656c 662e 7661 6c75 6520 6966 2028 6e75  elf.value if (nu
+0000ec70: 6d62 6572 735f 6469 6374 2e76 616c 7565  mbers_dict.value
+0000ec80: 2069 7320 6e6f 7420 4e6f 6e65 2920 656c   is not None) el
+0000ec90: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
+0000eca0: 2020 2020 2020 2020 206e 756d 6265 7273           numbers
+0000ecb0: 5f64 6963 743d 7b6b 3a20 7365 6c66 5b6b  _dict={k: self[k
+0000ecc0: 5d20 666f 7220 6b20 696e 206e 756d 6265  ] for k in numbe
+0000ecd0: 7273 5f64 6963 742e 6469 6374 2e6b 6579  rs_dict.dict.key
+0000ece0: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
+0000ecf0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+0000ed00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000ed10: 7475 726e 204e 756d 6265 7273 4469 6374  turn NumbersDict
+0000ed20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000ed30: 2020 6272 6f61 6463 6173 745f 7661 6c75    broadcast_valu
+0000ed40: 653d 4e6f 6e65 2c20 6e75 6d62 6572 735f  e=None, numbers_
+0000ed50: 6469 6374 3d7b 6b3a 2073 656c 665b 6b5d  dict={k: self[k]
+0000ed60: 2066 6f72 206b 2069 6e20 6e75 6d62 6572   for k in number
+0000ed70: 735f 6469 6374 2e64 6963 742e 6b65 7973  s_dict.dict.keys
+0000ed80: 2829 2069 6620 6b20 696e 2073 656c 662e  () if k in self.
+0000ed90: 6469 6374 7d0a 2020 2020 2020 2020 2020  dict}.          
+0000eda0: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
+0000edb0: 7479 0a20 2020 2064 6566 206b 6579 735f  ty.    def keys_
+0000edc0: 7365 7428 7365 6c66 293a 0a20 2020 2020  set(self):.     
+0000edd0: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
+0000ede0: 6c73 6f20 7365 6520 3a66 756e 633a 606b  lso see :func:`k
+0000edf0: 6579 735f 756e 696f 6e60 2069 6620 796f  eys_union` if yo
+0000ee00: 7520 7761 6e74 2074 6f20 6861 7665 2061  u want to have a
+0000ee10: 2064 6574 6572 6d69 6e69 7374 6963 206f   deterministic o
+0000ee20: 7264 6572 2e0a 0a20 2020 2020 2020 203a  rder...        :
+0000ee30: 7274 7970 653a 2073 6574 5b73 7472 5d0a  rtype: set[str].
+0000ee40: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000ee50: 2020 2020 7265 7475 726e 2073 6574 2873      return set(s
+0000ee60: 656c 662e 6469 6374 2e6b 6579 7328 2929  elf.dict.keys())
+0000ee70: 0a0a 2020 2020 6465 6620 6b65 7973 5f75  ..    def keys_u
+0000ee80: 6e69 6f6e 282a 6e75 6d62 6572 5f64 6963  nion(*number_dic
+0000ee90: 7473 3a20 4e75 6d62 6572 7344 6963 7429  ts: NumbersDict)
+0000eea0: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+0000eeb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000eec0: 2020 203a 7265 7475 726e 3a20 756e 696f     :return: unio
+0000eed0: 6e20 6f66 206b 6579 7320 6f76 6572 2073  n of keys over s
+0000eee0: 656c 6620 616e 6420 6f74 6865 722e 2054  elf and other. T
+0000eef0: 6865 206f 7264 6572 2077 696c 6c20 6265  he order will be
+0000ef00: 2064 6574 6572 6d69 6e69 7374 6963 2028   deterministic (
+0000ef10: 756e 6c69 6b65 203a 6675 6e63 3a60 6b65  unlike :func:`ke
+0000ef20: 7973 5f73 6574 6029 0a20 2020 2020 2020  ys_set`).       
+0000ef30: 2022 2222 0a20 2020 2020 2020 2073 6565   """.        see
+0000ef40: 6e20 3d20 7365 7428 290a 2020 2020 2020  n = set().      
+0000ef50: 2020 7265 7320 3d20 5b5d 0a20 2020 2020    res = [].     
+0000ef60: 2020 2066 6f72 206e 756d 6265 725f 6469     for number_di
+0000ef70: 6374 2069 6e20 6e75 6d62 6572 5f64 6963  ct in number_dic
+0000ef80: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0000ef90: 666f 7220 6b65 7920 696e 206e 756d 6265  for key in numbe
+0000efa0: 725f 6469 6374 2e64 6963 742e 6b65 7973  r_dict.dict.keys
+0000efb0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000efc0: 2020 2020 6966 206b 6579 206e 6f74 2069      if key not i
+0000efd0: 6e20 7365 656e 3a0a 2020 2020 2020 2020  n seen:.        
+0000efe0: 2020 2020 2020 2020 2020 2020 7365 656e              seen
+0000eff0: 2e61 6464 286b 6579 290a 2020 2020 2020  .add(key).      
+0000f000: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000f010: 732e 6170 7065 6e64 286b 6579 290a 2020  s.append(key).  
+0000f020: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+0000f030: 0a0a 2020 2020 6465 6620 5f5f 6765 7469  ..    def __geti
+0000f040: 7465 6d5f 5f28 7365 6c66 2c20 6b65 7929  tem__(self, key)
+0000f050: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+0000f060: 662e 7661 6c75 6520 6973 206e 6f74 204e  f.value is not N
+0000f070: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000f080: 2072 6574 7572 6e20 7365 6c66 2e64 6963   return self.dic
+0000f090: 742e 6765 7428 6b65 792c 2073 656c 662e  t.get(key, self.
+0000f0a0: 7661 6c75 6529 0a20 2020 2020 2020 2072  value).        r
+0000f0b0: 6574 7572 6e20 7365 6c66 2e64 6963 745b  eturn self.dict[
+0000f0c0: 6b65 795d 0a0a 2020 2020 6465 6620 5f5f  key]..    def __
+0000f0d0: 7365 7469 7465 6d5f 5f28 7365 6c66 2c20  setitem__(self, 
+0000f0e0: 6b65 792c 2076 616c 7565 293a 0a20 2020  key, value):.   
+0000f0f0: 2020 2020 2073 656c 662e 6469 6374 5b6b       self.dict[k
+0000f100: 6579 5d20 3d20 7661 6c75 650a 0a20 2020  ey] = value..   
+0000f110: 2064 6566 205f 5f64 656c 6974 656d 5f5f   def __delitem__
+0000f120: 2873 656c 662c 206b 6579 293a 0a20 2020  (self, key):.   
+0000f130: 2020 2020 2064 656c 2073 656c 662e 6469       del self.di
+0000f140: 6374 5b6b 6579 5d0a 0a20 2020 2064 6566  ct[key]..    def
+0000f150: 2067 6574 2873 656c 662c 206b 6579 2c20   get(self, key, 
+0000f160: 6465 6661 756c 743d 4e6f 6e65 293a 0a20  default=None):. 
+0000f170: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000f180: 2020 203a 7061 7261 6d20 7374 7220 6b65     :param str ke
+0000f190: 793a 0a20 2020 2020 2020 203a 7061 7261  y:.        :para
+0000f1a0: 6d20 5420 6465 6661 756c 743a 0a20 2020  m T default:.   
+0000f1b0: 2020 2020 203a 7274 7970 653a 206f 626a       :rtype: obj
+0000f1c0: 6563 747c 540a 2020 2020 2020 2020 2222  ect|T.        ""
+0000f1d0: 220a 2020 2020 2020 2020 2320 4b65 6570  ".        # Keep
+0000f1e0: 2063 6f6e 7369 7374 656e 7420 7769 7468   consistent with
+0000f1f0: 2073 656c 662e 5f5f 6765 745f 6974 656d   self.__get_item
+0000f200: 5f5f 2e20 4966 2073 656c 662e 7661 6c75  __. If self.valu
+0000f210: 6520 6973 2073 6574 2c20 7468 6973 2077  e is set, this w
+0000f220: 696c 6c20 616c 7761 7973 2062 6520 7468  ill always be th
+0000f230: 6520 6465 6661 756c 7420 7661 6c75 652e  e default value.
+0000f240: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f250: 7365 6c66 2e64 6963 742e 6765 7428 6b65  self.dict.get(ke
+0000f260: 792c 2073 656c 662e 7661 6c75 6520 6966  y, self.value if
+0000f270: 2073 656c 662e 7661 6c75 6520 6973 206e   self.value is n
+0000f280: 6f74 204e 6f6e 6520 656c 7365 2064 6566  ot None else def
+0000f290: 6175 6c74 290a 0a20 2020 2064 6566 2070  ault)..    def p
+0000f2a0: 6f70 2873 656c 662c 206b 6579 2c20 2a61  op(self, key, *a
+0000f2b0: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
+0000f2c0: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
+0000f2d0: 2073 7472 206b 6579 3a0a 2020 2020 2020   str key:.      
+0000f2e0: 2020 3a70 6172 616d 2054 2061 7267 733a    :param T args:
+0000f2f0: 2064 6566 6175 6c74 2c20 6f72 206e 6f74   default, or not
+0000f300: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+0000f310: 206f 626a 6563 747c 540a 2020 2020 2020   object|T.      
+0000f320: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+0000f330: 7475 726e 2073 656c 662e 6469 6374 2e70  turn self.dict.p
+0000f340: 6f70 286b 6579 2c20 2a61 7267 7329 0a0a  op(key, *args)..
+0000f350: 2020 2020 6465 6620 5f5f 6974 6572 5f5f      def __iter__
+0000f360: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000f370: 2320 5468 6973 2063 616e 2070 6f74 656e  # This can poten
+0000f380: 7469 616c 6c79 2063 6175 7365 2063 6f6e  tially cause con
+0000f390: 6675 7369 6f6e 2e20 536f 2065 6e66 6f72  fusion. So enfor
+0000f3a0: 6365 2065 7870 6c69 6369 746e 6573 732e  ce explicitness.
+0000f3b0: 0a20 2020 2020 2020 2023 2046 6f72 2061  .        # For a
+0000f3c0: 2064 6963 742c 2077 6520 776f 756c 6420   dict, we would 
+0000f3d0: 7265 7475 726e 2074 6865 2064 6963 7420  return the dict 
+0000f3e0: 6b65 7973 2068 6572 652e 0a20 2020 2020  keys here..     
+0000f3f0: 2020 2023 2041 6c73 6f2c 206d 6178 2873     # Also, max(s
+0000f400: 656c 6629 2077 6f75 6c64 2072 6573 756c  elf) would resul
+0000f410: 7420 696e 2061 2063 616c 6c20 746f 2073  t in a call to s
+0000f420: 656c 662e 5f5f 6974 6572 5f5f 2829 2c0a  elf.__iter__(),.
+0000f430: 2020 2020 2020 2020 2320 7768 6963 6820          # which 
+0000f440: 776f 756c 6420 6f6e 6c79 206d 616b 6520  would only make 
+0000f450: 7365 6e73 6520 666f 7220 6f75 7220 7661  sense for our va
+0000f460: 6c75 6573 2c20 6e6f 7420 7468 6520 6469  lues, not the di
+0000f470: 6374 206b 6579 732e 0a20 2020 2020 2020  ct keys..       
+0000f480: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+0000f490: 2822 2573 2e5f 5f69 7465 725f 5f20 6973  ("%s.__iter__ is
+0000f4a0: 2075 6e64 6566 696e 6564 2220 2520 7365   undefined" % se
+0000f4b0: 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  lf.__class__.__n
+0000f4c0: 616d 655f 5f29 0a0a 2020 2020 6465 6620  ame__)..    def 
+0000f4d0: 6b65 7973 2873 656c 6629 3a0a 2020 2020  keys(self):.    
+0000f4e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000f4f0: 3a72 7479 7065 3a20 7365 745b 7374 725d  :rtype: set[str]
+0000f500: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000f510: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000f520: 2e64 6963 742e 6b65 7973 2829 0a0a 2020  .dict.keys()..  
+0000f530: 2020 6465 6620 7661 6c75 6573 2873 656c    def values(sel
+0000f540: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+0000f550: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+0000f560: 6c69 7374 5b6f 626a 6563 745d 0a20 2020  list[object].   
+0000f570: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000f580: 2072 6574 7572 6e20 6c69 7374 2873 656c   return list(sel
+0000f590: 662e 6469 6374 2e76 616c 7565 7328 2929  f.dict.values())
+0000f5a0: 202b 2028 5b73 656c 662e 7661 6c75 655d   + ([self.value]
+0000f5b0: 2069 6620 7365 6c66 2e76 616c 7565 2069   if self.value i
+0000f5c0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+0000f5d0: 5b5d 290a 0a20 2020 2064 6566 2069 7465  [])..    def ite
+0000f5e0: 6d73 2873 656c 6629 3a0a 2020 2020 2020  ms(self):.      
+0000f5f0: 2020 2222 220a 2020 2020 2020 2020 3a72    """.        :r
+0000f600: 6574 7572 6e3a 2064 6963 7420 6974 656d  eturn: dict item
+0000f610: 732e 2074 6869 7320 6578 636c 7564 6573  s. this excludes
+0000f620: 2073 656c 662e 7661 6c75 650a 2020 2020   self.value.    
+0000f630: 2020 2020 3a72 7479 7065 3a20 7374 725b      :rtype: str[
+0000f640: 2873 7472 2c6f 626a 6563 7429 5d0a 2020  (str,object)].  
+0000f650: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000f660: 2020 7265 7475 726e 2073 656c 662e 6469    return self.di
+0000f670: 6374 2e69 7465 6d73 2829 0a0a 2020 2020  ct.items()..    
+0000f680: 6465 6620 6861 735f 7661 6c75 6573 2873  def has_values(s
+0000f690: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+0000f6a0: 220a 2020 2020 2020 2020 3a72 7479 7065  ".        :rtype
+0000f6b0: 3a20 626f 6f6c 0a20 2020 2020 2020 2022  : bool.        "
+0000f6c0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+0000f6d0: 6e20 626f 6f6c 2873 656c 662e 6469 6374  n bool(self.dict
+0000f6e0: 2920 6f72 2073 656c 662e 7661 6c75 6520  ) or self.value 
+0000f6f0: 6973 206e 6f74 204e 6f6e 650a 0a20 2020  is not None..   
+0000f700: 2064 6566 2075 6e61 7279 5f6f 7028 7365   def unary_op(se
+0000f710: 6c66 2c20 6f70 293a 0a20 2020 2020 2020  lf, op):.       
+0000f720: 2022 2222 0a20 2020 2020 2020 203a 7061   """.        :pa
+0000f730: 7261 6d20 2854 292d 3e54 3220 6f70 3a0a  ram (T)->T2 op:.
+0000f740: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0000f750: 206e 6577 204e 756d 6265 7273 4469 6374   new NumbersDict
+0000f760: 2c20 7768 6572 6520 6060 6f70 6060 2069  , where ``op`` i
+0000f770: 7320 6170 706c 6965 6420 6f6e 2061 6c6c  s applied on all
+0000f780: 2076 616c 7565 730a 2020 2020 2020 2020   values.        
+0000f790: 3a72 7479 7065 3a20 4e75 6d62 6572 7344  :rtype: NumbersD
+0000f7a0: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
+0000f7b0: 2020 2020 2020 2020 7265 7320 3d20 4e75          res = Nu
+0000f7c0: 6d62 6572 7344 6963 7428 290a 2020 2020  mbersDict().    
+0000f7d0: 2020 2020 6966 2073 656c 662e 7661 6c75      if self.valu
+0000f7e0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+0000f7f0: 2020 2020 2020 2020 2020 2072 6573 2e76             res.v
+0000f800: 616c 7565 203d 206f 7028 7365 6c66 2e76  alue = op(self.v
+0000f810: 616c 7565 290a 2020 2020 2020 2020 666f  alue).        fo
+0000f820: 7220 6b2c 2076 2069 6e20 7365 6c66 2e64  r k, v in self.d
+0000f830: 6963 742e 6974 656d 7328 293a 0a20 2020  ict.items():.   
+0000f840: 2020 2020 2020 2020 2072 6573 2e64 6963           res.dic
+0000f850: 745b 6b5d 203d 206f 7028 7629 0a20 2020  t[k] = op(v).   
+0000f860: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
+0000f870: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
+0000f880: 640a 2020 2020 6465 6620 6269 6e5f 6f70  d.    def bin_op
+0000f890: 5f73 6361 6c61 725f 6f70 7469 6f6e 616c  _scalar_optional
+0000f8a0: 2863 6c73 2c20 7365 6c66 2c20 6f74 6865  (cls, self, othe
+0000f8b0: 722c 207a 6572 6f2c 206f 7029 3a0a 2020  r, zero, op):.  
+0000f8c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000f8d0: 2020 3a70 6172 616d 2054 2073 656c 663a    :param T self:
+0000f8e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000f8f0: 5420 6f74 6865 723a 0a20 2020 2020 2020  T other:.       
+0000f900: 203a 7061 7261 6d20 5420 7a65 726f 3a0a   :param T zero:.
+0000f910: 2020 2020 2020 2020 3a70 6172 616d 2028          :param (
+0000f920: 542c 5429 2d3e 5420 6f70 3a0a 2020 2020  T,T)->T op:.    
+0000f930: 2020 2020 3a72 7479 7065 3a20 540a 2020      :rtype: T.  
+0000f940: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000f950: 2020 6966 2073 656c 6620 6973 204e 6f6e    if self is Non
+0000f960: 6520 616e 6420 6f74 6865 7220 6973 204e  e and other is N
+0000f970: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000f980: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
+0000f990: 2020 2020 2069 6620 7365 6c66 2069 7320       if self is 
+0000f9a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000f9b0: 2020 7365 6c66 203d 207a 6572 6f0a 2020    self = zero.  
+0000f9c0: 2020 2020 2020 6966 206f 7468 6572 2069        if other i
+0000f9d0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000f9e0: 2020 2020 6f74 6865 7220 3d20 7a65 726f      other = zero
+0000f9f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000fa00: 6f70 2873 656c 662c 206f 7468 6572 290a  op(self, other).
+0000fa10: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
+0000fa20: 640a 2020 2020 6465 6620 6269 6e5f 6f70  d.    def bin_op
+0000fa30: 2863 6c73 2c20 7365 6c66 2c20 6f74 6865  (cls, self, othe
+0000fa40: 722c 206f 702c 207a 6572 6f2c 2072 6573  r, op, zero, res
+0000fa50: 756c 743d 4e6f 6e65 293a 0a20 2020 2020  ult=None):.     
+0000fa60: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
+0000fa70: 7061 7261 6d20 4e75 6d62 6572 7344 6963  param NumbersDic
+0000fa80: 747c 696e 747c 666c 6f61 747c 5420 7365  t|int|float|T se
+0000fa90: 6c66 3a0a 2020 2020 2020 2020 3a70 6172  lf:.        :par
+0000faa0: 616d 204e 756d 6265 7273 4469 6374 7c69  am NumbersDict|i
+0000fab0: 6e74 7c66 6c6f 6174 7c54 206f 7468 6572  nt|float|T other
+0000fac0: 3a0a 2020 2020 2020 2020 3a70 6172 616d  :.        :param
+0000fad0: 2028 542c 5429 2d3e 5420 6f70 3a0a 2020   (T,T)->T op:.  
+0000fae0: 2020 2020 2020 3a70 6172 616d 2054 207a        :param T z
+0000faf0: 6572 6f3a 0a20 2020 2020 2020 203a 7061  ero:.        :pa
+0000fb00: 7261 6d20 4e75 6d62 6572 7344 6963 747c  ram NumbersDict|
+0000fb10: 4e6f 6e65 2072 6573 756c 743a 0a20 2020  None result:.   
+0000fb20: 2020 2020 203a 7274 7970 653a 204e 756d       :rtype: Num
+0000fb30: 6265 7273 4469 6374 0a20 2020 2020 2020  bersDict.       
+0000fb40: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0000fb50: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
+0000fb60: 656c 662c 204e 756d 6265 7273 4469 6374  elf, NumbersDict
+0000fb70: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0000fb80: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
+0000fb90: 6572 2c20 4e75 6d62 6572 7344 6963 7429  er, NumbersDict)
+0000fba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fbb0: 2020 7365 6c66 203d 204e 756d 6265 7273    self = Numbers
+0000fbc0: 4469 6374 2e63 6f6e 7374 616e 745f 6c69  Dict.constant_li
+0000fbd0: 6b65 2873 656c 662c 206e 756d 6265 7273  ke(self, numbers
+0000fbe0: 5f64 6963 743d 6f74 6865 7229 0a20 2020  _dict=other).   
+0000fbf0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000fc00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000fc10: 656c 6620 3d20 4e75 6d62 6572 7344 6963  elf = NumbersDic
+0000fc20: 7428 7365 6c66 290a 2020 2020 2020 2020  t(self).        
+0000fc30: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0000fc40: 6528 6f74 6865 722c 204e 756d 6265 7273  e(other, Numbers
+0000fc50: 4469 6374 293a 0a20 2020 2020 2020 2020  Dict):.         
+0000fc60: 2020 206f 7468 6572 203d 204e 756d 6265     other = Numbe
+0000fc70: 7273 4469 6374 2e63 6f6e 7374 616e 745f  rsDict.constant_
+0000fc80: 6c69 6b65 286f 7468 6572 2c20 6e75 6d62  like(other, numb
+0000fc90: 6572 735f 6469 6374 3d73 656c 6629 0a20  ers_dict=self). 
+0000fca0: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
+0000fcb0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000fcc0: 2020 2020 2020 7265 7375 6c74 203d 204e        result = N
+0000fcd0: 756d 6265 7273 4469 6374 2829 0a20 2020  umbersDict().   
+0000fce0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0000fcf0: 7374 616e 6365 2872 6573 756c 742c 204e  stance(result, N
+0000fd00: 756d 6265 7273 4469 6374 290a 2020 2020  umbersDict).    
+0000fd10: 2020 2020 666f 7220 6b20 696e 2073 656c      for k in sel
+0000fd20: 662e 6b65 7973 5f75 6e69 6f6e 286f 7468  f.keys_union(oth
+0000fd30: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
+0000fd40: 2072 6573 756c 745b 6b5d 203d 2063 6c73   result[k] = cls
+0000fd50: 2e62 696e 5f6f 705f 7363 616c 6172 5f6f  .bin_op_scalar_o
+0000fd60: 7074 696f 6e61 6c28 7365 6c66 2e67 6574  ptional(self.get
+0000fd70: 286b 2c20 4e6f 6e65 292c 206f 7468 6572  (k, None), other
+0000fd80: 2e67 6574 286b 2c20 4e6f 6e65 292c 207a  .get(k, None), z
+0000fd90: 6572 6f3d 7a65 726f 2c20 6f70 3d6f 7029  ero=zero, op=op)
+0000fda0: 0a20 2020 2020 2020 2072 6573 756c 742e  .        result.
+0000fdb0: 7661 6c75 6520 3d20 636c 732e 6269 6e5f  value = cls.bin_
+0000fdc0: 6f70 5f73 6361 6c61 725f 6f70 7469 6f6e  op_scalar_option
+0000fdd0: 616c 2873 656c 662e 7661 6c75 652c 206f  al(self.value, o
+0000fde0: 7468 6572 2e76 616c 7565 2c20 7a65 726f  ther.value, zero
+0000fdf0: 3d7a 6572 6f2c 206f 703d 6f70 290a 2020  =zero, op=op).  
+0000fe00: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+0000fe10: 756c 740a 0a20 2020 2064 6566 205f 5f61  ult..    def __a
+0000fe20: 6464 5f5f 2873 656c 662c 206f 7468 6572  dd__(self, other
+0000fe30: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000fe40: 6e20 7365 6c66 2e62 696e 5f6f 7028 7365  n self.bin_op(se
+0000fe50: 6c66 2c20 6f74 6865 722c 206f 703d 6c61  lf, other, op=la
+0000fe60: 6d62 6461 2061 2c20 623a 2061 202b 2062  mbda a, b: a + b
+0000fe70: 2c20 7a65 726f 3d30 290a 0a20 2020 205f  , zero=0)..    _
+0000fe80: 5f72 6164 645f 5f20 3d20 5f5f 6164 645f  _radd__ = __add_
+0000fe90: 5f0a 0a20 2020 2064 6566 205f 5f69 6164  _..    def __iad
+0000fea0: 645f 5f28 7365 6c66 2c20 6f74 6865 7229  d__(self, other)
+0000feb0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000fec0: 2073 656c 662e 6269 6e5f 6f70 2873 656c   self.bin_op(sel
+0000fed0: 662c 206f 7468 6572 2c20 6f70 3d6c 616d  f, other, op=lam
+0000fee0: 6264 6120 612c 2062 3a20 6120 2b20 622c  bda a, b: a + b,
+0000fef0: 207a 6572 6f3d 302c 2072 6573 756c 743d   zero=0, result=
+0000ff00: 7365 6c66 290a 0a20 2020 2064 6566 205f  self)..    def _
+0000ff10: 5f73 7562 5f5f 2873 656c 662c 206f 7468  _sub__(self, oth
+0000ff20: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
+0000ff30: 7572 6e20 7365 6c66 2e62 696e 5f6f 7028  urn self.bin_op(
+0000ff40: 7365 6c66 2c20 6f74 6865 722c 206f 703d  self, other, op=
+0000ff50: 6c61 6d62 6461 2061 2c20 623a 2061 202d  lambda a, b: a -
+0000ff60: 2062 2c20 7a65 726f 3d30 290a 0a20 2020   b, zero=0)..   
+0000ff70: 2064 6566 205f 5f72 7375 625f 5f28 7365   def __rsub__(se
+0000ff80: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+0000ff90: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000ffa0: 6269 6e5f 6f70 2873 656c 662c 206f 7468  bin_op(self, oth
+0000ffb0: 6572 2c20 6f70 3d6c 616d 6264 6120 612c  er, op=lambda a,
+0000ffc0: 2062 3a20 6220 2d20 612c 207a 6572 6f3d   b: b - a, zero=
+0000ffd0: 3029 0a0a 2020 2020 6465 6620 5f5f 6973  0)..    def __is
+0000ffe0: 7562 5f5f 2873 656c 662c 206f 7468 6572  ub__(self, other
+0000fff0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00010000: 6e20 7365 6c66 2e62 696e 5f6f 7028 7365  n self.bin_op(se
+00010010: 6c66 2c20 6f74 6865 722c 206f 703d 6c61  lf, other, op=la
+00010020: 6d62 6461 2061 2c20 623a 2061 202d 2062  mbda a, b: a - b
+00010030: 2c20 7a65 726f 3d30 2c20 7265 7375 6c74  , zero=0, result
+00010040: 3d73 656c 6629 0a0a 2020 2020 6465 6620  =self)..    def 
+00010050: 5f5f 6d75 6c5f 5f28 7365 6c66 2c20 6f74  __mul__(self, ot
+00010060: 6865 7229 3a0a 2020 2020 2020 2020 7265  her):.        re
+00010070: 7475 726e 2073 656c 662e 6269 6e5f 6f70  turn self.bin_op
+00010080: 2873 656c 662c 206f 7468 6572 2c20 6f70  (self, other, op
+00010090: 3d6c 616d 6264 6120 612c 2062 3a20 6120  =lambda a, b: a 
+000100a0: 2a20 622c 207a 6572 6f3d 3129 0a0a 2020  * b, zero=1)..  
+000100b0: 2020 5f5f 726d 756c 5f5f 203d 205f 5f6d    __rmul__ = __m
+000100c0: 756c 5f5f 0a0a 2020 2020 6465 6620 5f5f  ul__..    def __
+000100d0: 696d 756c 5f5f 2873 656c 662c 206f 7468  imul__(self, oth
+000100e0: 6572 293a 0a20 2020 2020 2020 2072 6574  er):.        ret
+000100f0: 7572 6e20 7365 6c66 2e62 696e 5f6f 7028  urn self.bin_op(
+00010100: 7365 6c66 2c20 6f74 6865 722c 206f 703d  self, other, op=
+00010110: 6c61 6d62 6461 2061 2c20 623a 2061 202a  lambda a, b: a *
+00010120: 2062 2c20 7a65 726f 3d31 2c20 7265 7375   b, zero=1, resu
+00010130: 6c74 3d73 656c 6629 0a0a 2020 2020 6465  lt=self)..    de
+00010140: 6620 5f5f 6469 765f 5f28 7365 6c66 2c20  f __div__(self, 
+00010150: 6f74 6865 7229 3a0a 2020 2020 2020 2020  other):.        
+00010160: 7265 7475 726e 2073 656c 662e 6269 6e5f  return self.bin_
+00010170: 6f70 2873 656c 662c 206f 7468 6572 2c20  op(self, other, 
+00010180: 6f70 3d6c 616d 6264 6120 612c 2062 3a20  op=lambda a, b: 
+00010190: 6120 2f20 622c 207a 6572 6f3d 3129 0a0a  a / b, zero=1)..
+000101a0: 2020 2020 5f5f 7264 6976 5f5f 203d 205f      __rdiv__ = _
+000101b0: 5f64 6976 5f5f 0a20 2020 205f 5f74 7275  _div__.    __tru
+000101c0: 6564 6976 5f5f 203d 205f 5f64 6976 5f5f  ediv__ = __div__
+000101d0: 0a0a 2020 2020 6465 6620 5f5f 6964 6976  ..    def __idiv
+000101e0: 5f5f 2873 656c 662c 206f 7468 6572 293a  __(self, other):
+000101f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010200: 7365 6c66 2e62 696e 5f6f 7028 7365 6c66  self.bin_op(self
+00010210: 2c20 6f74 6865 722c 206f 703d 6c61 6d62  , other, op=lamb
+00010220: 6461 2061 2c20 623a 2061 202f 2062 2c20  da a, b: a / b, 
+00010230: 7a65 726f 3d31 2c20 7265 7375 6c74 3d73  zero=1, result=s
+00010240: 656c 6629 0a0a 2020 2020 5f5f 6974 7275  elf)..    __itru
+00010250: 6564 6976 5f5f 203d 205f 5f69 6469 765f  ediv__ = __idiv_
+00010260: 5f0a 0a20 2020 2064 6566 205f 5f66 6c6f  _..    def __flo
+00010270: 6f72 6469 765f 5f28 7365 6c66 2c20 6f74  ordiv__(self, ot
+00010280: 6865 7229 3a0a 2020 2020 2020 2020 7265  her):.        re
+00010290: 7475 726e 2073 656c 662e 6269 6e5f 6f70  turn self.bin_op
+000102a0: 2873 656c 662c 206f 7468 6572 2c20 6f70  (self, other, op
+000102b0: 3d6c 616d 6264 6120 612c 2062 3a20 6120  =lambda a, b: a 
+000102c0: 2f2f 2062 2c20 7a65 726f 3d31 290a 0a20  // b, zero=1).. 
+000102d0: 2020 2064 6566 205f 5f69 666c 6f6f 7264     def __ifloord
+000102e0: 6976 5f5f 2873 656c 662c 206f 7468 6572  iv__(self, other
+000102f0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00010300: 6e20 7365 6c66 2e62 696e 5f6f 7028 7365  n self.bin_op(se
+00010310: 6c66 2c20 6f74 6865 722c 206f 703d 6c61  lf, other, op=la
+00010320: 6d62 6461 2061 2c20 623a 2061 202f 2f20  mbda a, b: a // 
+00010330: 622c 207a 6572 6f3d 312c 2072 6573 756c  b, zero=1, resul
+00010340: 743d 7365 6c66 290a 0a20 2020 2064 6566  t=self)..    def
+00010350: 205f 5f6e 6567 5f5f 2873 656c 6629 3a0a   __neg__(self):.
+00010360: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00010370: 656c 662e 756e 6172 795f 6f70 286f 703d  elf.unary_op(op=
+00010380: 6c61 6d62 6461 2061 3a20 2d61 290a 0a20  lambda a: -a).. 
+00010390: 2020 2064 6566 205f 5f62 6f6f 6c5f 5f28     def __bool__(
+000103a0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+000103b0: 6574 7572 6e20 616e 7928 7365 6c66 2e76  eturn any(self.v
+000103c0: 616c 7565 7328 2929 0a0a 2020 2020 5f5f  alues())..    __
+000103d0: 6e6f 6e7a 6572 6f5f 5f20 3d20 5f5f 626f  nonzero__ = __bo
+000103e0: 6f6c 5f5f 2020 2320 5079 7468 6f6e 2032  ol__  # Python 2
+000103f0: 0a0a 2020 2020 6465 6620 656c 656d 5f65  ..    def elem_e
+00010400: 7128 7365 6c66 2c20 6f74 6865 722c 2072  q(self, other, r
+00010410: 6573 756c 745f 7769 7468 5f64 6566 6175  esult_with_defau
+00010420: 6c74 3d54 7275 6529 3a0a 2020 2020 2020  lt=True):.      
+00010430: 2020 2222 220a 2020 2020 2020 2020 456c    """.        El
+00010440: 656d 656e 742d 7769 7365 2065 7175 616c  ement-wise equal
+00010450: 6974 7920 6368 6563 6b20 7769 7468 206f  ity check with o
+00010460: 7468 6572 2e0a 2020 2020 2020 2020 4e6f  ther..        No
+00010470: 7465 2061 626f 7574 2062 726f 6164 6361  te about broadca
+00010480: 7374 2064 6566 6175 6c74 2076 616c 7565  st default value
+00010490: 3a20 436f 6e73 6964 6572 2073 6f6d 6520  : Consider some 
+000104a0: 6b65 7920 7768 6963 6820 6973 206e 6569  key which is nei
+000104b0: 7468 6572 2069 6e20 7365 6c66 206e 6f72  ther in self nor
+000104c0: 2069 6e20 6f74 6865 722e 0a20 2020 2020   in other..     
+000104d0: 2020 2020 2054 6869 7320 6d65 616e 7320       This means 
+000104e0: 7468 6174 2073 656c 665b 6b65 795d 203d  that self[key] =
+000104f0: 3d20 7365 6c66 2e64 6566 6175 6c74 2c20  = self.default, 
+00010500: 6f74 6865 725b 6b65 795d 203d 3d20 6f74  other[key] == ot
+00010510: 6865 722e 6465 6661 756c 742e 0a20 2020  her.default..   
+00010520: 2020 2020 2020 2054 6875 732c 2069 6e20         Thus, in 
+00010530: 6361 7365 2074 6861 7420 7365 6c66 2e64  case that self.d
+00010540: 6566 6175 6c74 2021 3d20 6f74 6865 722e  efault != other.
+00010550: 6465 6661 756c 742c 2077 6520 6765 7420  default, we get 
+00010560: 7265 732e 6465 6661 756c 7420 3d3d 2046  res.default == F
+00010570: 616c 7365 2e0a 2020 2020 2020 2020 2020  alse..          
+00010580: 5468 656e 2c20 616c 6c28 7265 732e 7661  Then, all(res.va
+00010590: 6c75 6573 2829 2920 3d3d 2046 616c 7365  lues()) == False
+000105a0: 2c20 6576 656e 2077 6865 6e20 616c 6c20  , even when all 
+000105b0: 6f74 6865 7220 7661 6c75 6573 2061 7265  other values are
+000105c0: 2054 7275 652e 0a20 2020 2020 2020 2020   True..         
+000105d0: 2054 6869 7320 6973 2073 6f6d 6574 696d   This is sometim
+000105e0: 6573 206e 6f74 2077 6861 7420 7765 2077  es not what we w
+000105f0: 616e 742e 0a20 2020 2020 2020 2020 2059  ant..          Y
+00010600: 6f75 2063 616e 2063 6f6e 7472 6f6c 2074  ou can control t
+00010610: 6865 2062 6568 6176 696f 7220 7669 6120  he behavior via 
+00010620: 7265 7375 6c74 5f77 6974 685f 6465 6661  result_with_defa
+00010630: 756c 742e 0a0a 2020 2020 2020 2020 3a70  ult...        :p
+00010640: 6172 616d 204e 756d 6265 7273 4469 6374  aram NumbersDict
+00010650: 7c54 206f 7468 6572 3a0a 2020 2020 2020  |T other:.      
+00010660: 2020 3a70 6172 616d 2062 6f6f 6c20 7265    :param bool re
+00010670: 7375 6c74 5f77 6974 685f 6465 6661 756c  sult_with_defaul
+00010680: 743a 0a20 2020 2020 2020 203a 7274 7970  t:.        :rtyp
+00010690: 653a 204e 756d 6265 7273 4469 6374 0a20  e: NumbersDict. 
+000106a0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+000106b0: 2020 2020 6465 6620 6f70 2861 2c20 6229      def op(a, b)
+000106c0: 3a0a 2020 2020 2020 2020 2020 2020 2222  :.            ""
+000106d0: 220a 2020 2020 2020 2020 2020 2020 3a70  ".            :p
+000106e0: 6172 616d 2061 3a0a 2020 2020 2020 2020  aram a:.        
+000106f0: 2020 2020 3a70 6172 616d 2062 3a0a 2020      :param b:.  
+00010700: 2020 2020 2020 2020 2020 3a72 7479 7065            :rtype
+00010710: 3a20 626f 6f6c 7c4e 6f6e 650a 2020 2020  : bool|None.    
+00010720: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00010730: 2020 2020 2020 2020 6966 2061 2069 7320          if a is 
+00010740: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00010750: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00010760: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+00010770: 2062 2069 7320 4e6f 6e65 3a0a 2020 2020   b is None:.    
+00010780: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010790: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+000107a0: 2020 2020 7265 7475 726e 2061 203d 3d20      return a == 
+000107b0: 620a 0a20 2020 2020 2020 2072 6573 203d  b..        res =
+000107c0: 2073 656c 662e 6269 6e5f 6f70 2873 656c   self.bin_op(sel
+000107d0: 662c 206f 7468 6572 2c20 6f70 3d6f 702c  f, other, op=op,
+000107e0: 207a 6572 6f3d 4e6f 6e65 290a 2020 2020   zero=None).    
+000107f0: 2020 2020 6966 206e 6f74 2072 6573 756c      if not resul
+00010800: 745f 7769 7468 5f64 6566 6175 6c74 3a0a  t_with_default:.
+00010810: 2020 2020 2020 2020 2020 2020 7265 732e              res.
+00010820: 7661 6c75 6520 3d20 4e6f 6e65 0a20 2020  value = None.   
+00010830: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
+00010840: 0a20 2020 2064 6566 205f 5f65 715f 5f28  .    def __eq__(
+00010850: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+00010860: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00010870: 2020 3a70 6172 616d 204e 756d 6265 7273    :param Numbers
+00010880: 4469 6374 7c54 206f 7468 6572 3a0a 2020  Dict|T other:.  
+00010890: 2020 2020 2020 3a72 6574 7572 6e3a 2077        :return: w
+000108a0: 6865 7468 6572 2073 656c 6620 3d3d 206f  hether self == o
+000108b0: 7468 6572 2065 6c65 6d77 6973 652e 2073  ther elemwise. s
+000108c0: 6565 2073 656c 662e 656c 656d 5f65 710a  ee self.elem_eq.
+000108d0: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+000108e0: 626f 6f6c 0a20 2020 2020 2020 2022 2222  bool.        """
+000108f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010900: 616c 6c28 7365 6c66 2e65 6c65 6d5f 6571  all(self.elem_eq
+00010910: 286f 7468 6572 292e 7661 6c75 6573 2829  (other).values()
+00010920: 290a 0a20 2020 2064 6566 205f 5f6e 655f  )..    def __ne_
+00010930: 5f28 7365 6c66 2c20 6f74 6865 7229 3a0a  _(self, other):.
+00010940: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00010950: 2020 2020 3a70 6172 616d 204e 756d 6265      :param Numbe
+00010960: 7273 4469 6374 7c54 206f 7468 6572 3a0a  rsDict|T other:.
+00010970: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00010980: 206e 6f74 2028 7365 6c66 203d 3d20 6f74   not (self == ot
+00010990: 6865 7229 0a20 2020 2020 2020 203a 7274  her).        :rt
+000109a0: 7970 653a 2062 6f6f 6c0a 2020 2020 2020  ype: bool.      
+000109b0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+000109c0: 7475 726e 206e 6f74 2028 7365 6c66 203d  turn not (self =
+000109d0: 3d20 6f74 6865 7229 0a0a 2020 2020 6465  = other)..    de
+000109e0: 6620 5f5f 636d 705f 5f28 7365 6c66 2c20  f __cmp__(self, 
+000109f0: 6f74 6865 7229 3a0a 2020 2020 2020 2020  other):.        
+00010a00: 2320 5468 6572 6520 6973 206e 6f20 676f  # There is no go
+00010a10: 6f64 2073 7472 6169 6768 742d 666f 7277  od straight-forw
+00010a20: 6172 6420 696d 706c 656d 656e 7461 7469  ard implementati
+00010a30: 6f6e 0a20 2020 2020 2020 2023 2061 6e64  on.        # and
+00010a40: 2069 7420 776f 756c 6420 6a75 7374 2063   it would just c
+00010a50: 6f6e 6675 7365 2e0a 2020 2020 2020 2020  onfuse..        
+00010a60: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+00010a70: 2225 732e 5f5f 636d 705f 5f20 6973 2075  "%s.__cmp__ is u
+00010a80: 6e64 6566 696e 6564 2220 2520 7365 6c66  ndefined" % self
+00010a90: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+00010aa0: 655f 5f29 0a0a 2020 2020 6465 6620 616e  e__)..    def an
+00010ab0: 795f 636f 6d70 6172 6528 7365 6c66 2c20  y_compare(self, 
+00010ac0: 6f74 6865 722c 2063 6d70 293a 0a20 2020  other, cmp):.   
+00010ad0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00010ae0: 203a 7061 7261 6d20 4e75 6d62 6572 7344   :param NumbersD
+00010af0: 6963 7420 6f74 6865 723a 0a20 2020 2020  ict other:.     
+00010b00: 2020 203a 7061 7261 6d20 2828 6f62 6a65     :param ((obje
+00010b10: 6374 2c6f 626a 6563 7429 2d3e 5472 7565  ct,object)->True
+00010b20: 2920 636d 703a 0a20 2020 2020 2020 203a  ) cmp:.        :
+00010b30: 7274 7970 653a 2054 7275 650a 2020 2020  rtype: True.    
+00010b40: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00010b50: 666f 7220 6b65 7920 696e 2073 656c 662e  for key in self.
+00010b60: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+00010b70: 2020 2020 6966 206b 6579 2069 6e20 6f74      if key in ot
+00010b80: 6865 722e 6b65 7973 2829 3a0a 2020 2020  her.keys():.    
+00010b90: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00010ba0: 6d70 2873 656c 665b 6b65 795d 2c20 6f74  mp(self[key], ot
+00010bb0: 6865 725b 6b65 795d 293a 0a20 2020 2020  her[key]):.     
+00010bc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010bd0: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
+00010be0: 2020 2020 2020 2065 6c69 6620 6f74 6865         elif othe
+00010bf0: 722e 7661 6c75 6520 6973 206e 6f74 204e  r.value is not N
+00010c00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00010c10: 2020 2020 2069 6620 636d 7028 7365 6c66       if cmp(self
+00010c20: 5b6b 6579 5d2c 206f 7468 6572 2e76 616c  [key], other.val
+00010c30: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
+00010c40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00010c50: 5472 7565 0a20 2020 2020 2020 2069 6620  True.        if 
+00010c60: 7365 6c66 2e76 616c 7565 2069 7320 6e6f  self.value is no
+00010c70: 7420 4e6f 6e65 2061 6e64 206f 7468 6572  t None and other
+00010c80: 2e76 616c 7565 2069 7320 6e6f 7420 4e6f  .value is not No
+00010c90: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010ca0: 6966 2063 6d70 2873 656c 662e 7661 6c75  if cmp(self.valu
+00010cb0: 652c 206f 7468 6572 2e76 616c 7565 293a  e, other.value):
+00010cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010cd0: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
+00010ce0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00010cf0: 650a 0a20 2020 2040 7374 6174 6963 6d65  e..    @staticme
+00010d00: 7468 6f64 0a20 2020 2064 6566 205f 6d61  thod.    def _ma
+00010d10: 7828 2a61 7267 7329 3a0a 2020 2020 2020  x(*args):.      
+00010d20: 2020 6172 6773 203d 205b 6120 666f 7220    args = [a for 
+00010d30: 6120 696e 2061 7267 7320 6966 2061 2069  a in args if a i
+00010d40: 7320 6e6f 7420 4e6f 6e65 5d0a 2020 2020  s not None].    
+00010d50: 2020 2020 6966 206e 6f74 2061 7267 733a      if not args:
+00010d60: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010d70: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+00010d80: 2069 6620 6c65 6e28 6172 6773 2920 3d3d   if len(args) ==
+00010d90: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00010da0: 7265 7475 726e 2061 7267 735b 305d 0a20  return args[0]. 
+00010db0: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
+00010dc0: 7828 2a61 7267 7329 0a0a 2020 2020 4073  x(*args)..    @s
+00010dd0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00010de0: 6465 6620 5f6d 696e 282a 6172 6773 293a  def _min(*args):
+00010df0: 0a20 2020 2020 2020 2061 7267 7320 3d20  .        args = 
+00010e00: 5b61 2066 6f72 2061 2069 6e20 6172 6773  [a for a in args
+00010e10: 2069 6620 6120 6973 206e 6f74 204e 6f6e   if a is not Non
+00010e20: 655d 0a20 2020 2020 2020 2069 6620 6e6f  e].        if no
+00010e30: 7420 6172 6773 3a0a 2020 2020 2020 2020  t args:.        
+00010e40: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+00010e50: 2020 2020 2020 2020 6966 206c 656e 2861          if len(a
+00010e60: 7267 7329 203d 3d20 313a 0a20 2020 2020  rgs) == 1:.     
+00010e70: 2020 2020 2020 2072 6574 7572 6e20 6172         return ar
+00010e80: 6773 5b30 5d0a 2020 2020 2020 2020 7265  gs[0].        re
+00010e90: 7475 726e 206d 696e 282a 6172 6773 290a  turn min(*args).
+00010ea0: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
+00010eb0: 640a 2020 2020 6465 6620 6d61 7828 636c  d.    def max(cl
+00010ec0: 732c 2069 7465 6d73 293a 0a20 2020 2020  s, items):.     
+00010ed0: 2020 2022 2222 0a20 2020 2020 2020 2045     """.        E
+00010ee0: 6c65 6d65 6e74 2d77 6973 6520 6d61 7869  lement-wise maxi
+00010ef0: 6d75 6d20 666f 7220 6974 656d 2069 6e20  mum for item in 
+00010f00: 6974 656d 732e 0a20 2020 2020 2020 203a  items..        :
+00010f10: 7061 7261 6d20 6c69 7374 5b4e 756d 6265  param list[Numbe
+00010f20: 7273 4469 6374 7c69 6e74 7c66 6c6f 6174  rsDict|int|float
+00010f30: 5d20 6974 656d 733a 0a20 2020 2020 2020  ] items:.       
+00010f40: 203a 7274 7970 653a 204e 756d 6265 7273   :rtype: Numbers
+00010f50: 4469 6374 0a20 2020 2020 2020 2022 2222  Dict.        """
+00010f60: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00010f70: 6974 656d 730a 2020 2020 2020 2020 6966  items.        if
+00010f80: 206c 656e 2869 7465 6d73 2920 3d3d 2031   len(items) == 1
+00010f90: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00010fa0: 7475 726e 204e 756d 6265 7273 4469 6374  turn NumbersDict
+00010fb0: 2869 7465 6d73 5b30 5d29 0a20 2020 2020  (items[0]).     
+00010fc0: 2020 2069 6620 6c65 6e28 6974 656d 7329     if len(items)
+00010fd0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+00010fe0: 2020 2072 6574 7572 6e20 636c 732e 6269     return cls.bi
+00010ff0: 6e5f 6f70 2869 7465 6d73 5b30 5d2c 2069  n_op(items[0], i
+00011000: 7465 6d73 5b31 5d2c 206f 703d 636c 732e  tems[1], op=cls.
+00011010: 5f6d 6178 2c20 7a65 726f 3d4e 6f6e 6529  _max, zero=None)
+00011020: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011030: 636c 732e 6d61 7828 5b69 7465 6d73 5b30  cls.max([items[0
+00011040: 5d2c 2063 6c73 2e6d 6178 2869 7465 6d73  ], cls.max(items
+00011050: 5b31 3a5d 295d 290a 0a20 2020 2040 636c  [1:])])..    @cl
+00011060: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+00011070: 6620 6d69 6e28 636c 732c 2069 7465 6d73  f min(cls, items
+00011080: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00011090: 2020 2020 2020 2045 6c65 6d65 6e74 2d77         Element-w
+000110a0: 6973 6520 6d69 6e69 6d75 6d20 666f 7220  ise minimum for 
+000110b0: 6974 656d 2069 6e20 6974 656d 732e 0a20  item in items.. 
+000110c0: 2020 2020 2020 203a 7061 7261 6d20 6c69         :param li
+000110d0: 7374 5b4e 756d 6265 7273 4469 6374 7c69  st[NumbersDict|i
+000110e0: 6e74 7c66 6c6f 6174 5d20 6974 656d 733a  nt|float] items:
+000110f0: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00011100: 204e 756d 6265 7273 4469 6374 0a20 2020   NumbersDict.   
+00011110: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00011120: 2061 7373 6572 7420 6974 656d 730a 2020   assert items.  
+00011130: 2020 2020 2020 6966 206c 656e 2869 7465        if len(ite
+00011140: 6d73 2920 3d3d 2031 3a0a 2020 2020 2020  ms) == 1:.      
+00011150: 2020 2020 2020 7265 7475 726e 204e 756d        return Num
+00011160: 6265 7273 4469 6374 2869 7465 6d73 5b30  bersDict(items[0
+00011170: 5d29 0a20 2020 2020 2020 2069 6620 6c65  ]).        if le
+00011180: 6e28 6974 656d 7329 203d 3d20 323a 0a20  n(items) == 2:. 
+00011190: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000111a0: 6e20 636c 732e 6269 6e5f 6f70 2869 7465  n cls.bin_op(ite
+000111b0: 6d73 5b30 5d2c 2069 7465 6d73 5b31 5d2c  ms[0], items[1],
+000111c0: 206f 703d 636c 732e 5f6d 696e 2c20 7a65   op=cls._min, ze
+000111d0: 726f 3d4e 6f6e 6529 0a20 2020 2020 2020  ro=None).       
+000111e0: 2072 6574 7572 6e20 636c 732e 6d69 6e28   return cls.min(
+000111f0: 5b69 7465 6d73 5b30 5d2c 2063 6c73 2e6d  [items[0], cls.m
+00011200: 696e 2869 7465 6d73 5b31 3a5d 295d 290a  in(items[1:])]).
+00011210: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+00011220: 6f64 0a20 2020 2064 6566 205f 6d61 785f  od.    def _max_
+00011230: 6572 726f 7228 293a 0a20 2020 2020 2020  error():.       
+00011240: 2023 2057 696c 6c20 7265 706c 6163 6520   # Will replace 
+00011250: 7365 6c66 2e6d 6178 2066 6f72 2065 6163  self.max for eac
+00011260: 6820 696e 7374 616e 6365 2e20 546f 2062  h instance. To b
+00011270: 6520 7375 7265 2074 6861 7420 7765 2064  e sure that we d
+00011280: 6f6e 2774 2063 6f6e 6675 7365 2069 7420  on't confuse it 
+00011290: 7769 7468 2073 656c 662e 6d61 785f 7661  with self.max_va
+000112a0: 6c75 652e 0a20 2020 2020 2020 2072 6169  lue..        rai
+000112b0: 7365 2045 7863 6570 7469 6f6e 2822 5573  se Exception("Us
+000112c0: 6520 6d61 785f 7661 6c75 6520 696e 7374  e max_value inst
+000112d0: 6561 642e 2229 0a0a 2020 2020 6465 6620  ead.")..    def 
+000112e0: 6d61 785f 7661 6c75 6528 7365 6c66 293a  max_value(self):
+000112f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00011300: 2020 2020 204d 6178 696d 756d 206f 6620       Maximum of 
+00011310: 6f75 7220 7661 6c75 6573 2e0a 2020 2020  our values..    
+00011320: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00011330: 7265 7475 726e 206d 6178 2873 656c 662e  return max(self.
+00011340: 7661 6c75 6573 2829 290a 0a20 2020 2064  values())..    d
+00011350: 6566 206d 696e 5f76 616c 7565 2873 656c  ef min_value(sel
+00011360: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+00011370: 2020 2020 2020 2020 4d69 6e69 6d75 6d20          Minimum 
+00011380: 6f66 206f 7572 2076 616c 7565 732e 0a20  of our values.. 
+00011390: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000113a0: 2020 2072 6574 7572 6e20 6d69 6e28 7365     return min(se
+000113b0: 6c66 2e76 616c 7565 7328 2929 0a0a 2020  lf.values())..  
+000113c0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+000113d0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
+000113e0: 2073 656c 662e 7661 6c75 6520 6973 204e   self.value is N
+000113f0: 6f6e 6520 616e 6420 6e6f 7420 7365 6c66  one and not self
+00011400: 2e64 6963 743a 0a20 2020 2020 2020 2020  .dict:.         
+00011410: 2020 2072 6574 7572 6e20 2225 7328 2922     return "%s()"
+00011420: 2025 2073 656c 662e 5f5f 636c 6173 735f   % self.__class_
+00011430: 5f2e 5f5f 6e61 6d65 5f5f 0a20 2020 2020  _.__name__.     
+00011440: 2020 2069 6620 7365 6c66 2e76 616c 7565     if self.value
+00011450: 2069 7320 4e6f 6e65 2061 6e64 2073 656c   is None and sel
+00011460: 662e 6469 6374 3a0a 2020 2020 2020 2020  f.dict:.        
+00011470: 2020 2020 7265 7475 726e 2022 2573 2825      return "%s(%
+00011480: 7229 2220 2520 2873 656c 662e 5f5f 636c  r)" % (self.__cl
+00011490: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 2c20  ass__.__name__, 
+000114a0: 7365 6c66 2e64 6963 7429 0a20 2020 2020  self.dict).     
+000114b0: 2020 2069 6620 6e6f 7420 7365 6c66 2e64     if not self.d
+000114c0: 6963 7420 616e 6420 7365 6c66 2e76 616c  ict and self.val
+000114d0: 7565 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ue is not None:.
+000114e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000114f0: 726e 2022 2573 2825 7229 2220 2520 2873  rn "%s(%r)" % (s
+00011500: 656c 662e 5f5f 636c 6173 735f 5f2e 5f5f  elf.__class__.__
+00011510: 6e61 6d65 5f5f 2c20 7365 6c66 2e76 616c  name__, self.val
+00011520: 7565 290a 2020 2020 2020 2020 7265 7475  ue).        retu
+00011530: 726e 2022 2573 286e 756d 6265 7273 5f64  rn "%s(numbers_d
+00011540: 6963 743d 2572 2c20 6272 6f61 6463 6173  ict=%r, broadcas
+00011550: 745f 7661 6c75 653d 2572 2922 2025 2028  t_value=%r)" % (
+00011560: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
+00011570: 5f6e 616d 655f 5f2c 2073 656c 662e 6469  _name__, self.di
+00011580: 6374 2c20 7365 6c66 2e76 616c 7565 290a  ct, self.value).
+00011590: 0a0a 6465 6620 636f 6c6c 6563 745f 636c  ..def collect_cl
+000115a0: 6173 735f 696e 6974 5f6b 7761 7267 7328  ass_init_kwargs(
+000115b0: 636c 732c 206f 6e6c 795f 7769 7468 5f64  cls, only_with_d
+000115c0: 6566 6175 6c74 3d46 616c 7365 293a 0a20  efault=False):. 
+000115d0: 2020 2022 2222 0a20 2020 203a 7061 7261     """.    :para
+000115e0: 6d20 7479 7065 2063 6c73 3a20 636c 6173  m type cls: clas
+000115f0: 732c 2077 6865 7265 2069 7420 6173 7375  s, where it assu
+00011600: 6d65 7320 7468 6174 206b 7761 7267 7320  mes that kwargs 
+00011610: 6172 6520 7061 7373 6564 206f 6e20 746f  are passed on to
+00011620: 2062 6173 6520 636c 6173 7365 730a 2020   base classes.  
+00011630: 2020 3a70 6172 616d 2062 6f6f 6c20 6f6e    :param bool on
+00011640: 6c79 5f77 6974 685f 6465 6661 756c 743a  ly_with_default:
+00011650: 2069 6620 6769 7665 6e20 7769 6c6c 206f   if given will o
+00011660: 6e6c 7920 7265 7475 726e 2074 6865 206b  nly return the k
+00011670: 7761 7267 7320 7769 7468 2064 6566 6175  wargs with defau
+00011680: 6c74 2076 616c 7565 730a 2020 2020 3a72  lt values.    :r
+00011690: 6574 7572 6e3a 2073 6574 2069 6620 6e6f  eturn: set if no
+000116a0: 7420 7769 7468 5f64 6566 6175 6c74 2c20  t with_default, 
+000116b0: 6f74 6865 7277 6973 6520 7468 6520 6469  otherwise the di
+000116c0: 6374 2074 6f20 7468 6520 6465 6661 756c  ct to the defaul
+000116d0: 7420 7661 6c75 6573 0a20 2020 203a 7274  t values.    :rt
+000116e0: 7970 653a 206c 6973 745b 7374 725d 207c  ype: list[str] |
+000116f0: 2064 6963 745b 7374 725d 0a20 2020 2022   dict[str].    "
+00011700: 2222 0a20 2020 2066 726f 6d20 636f 6c6c  "".    from coll
+00011710: 6563 7469 6f6e 7320 696d 706f 7274 204f  ections import O
+00011720: 7264 6572 6564 4469 6374 0a0a 2020 2020  rderedDict..    
+00011730: 6966 206f 6e6c 795f 7769 7468 5f64 6566  if only_with_def
+00011740: 6175 6c74 3a0a 2020 2020 2020 2020 6b77  ault:.        kw
+00011750: 6172 6773 203d 204f 7264 6572 6564 4469  args = OrderedDi
+00011760: 6374 2829 0a20 2020 2065 6c73 653a 0a20  ct().    else:. 
+00011770: 2020 2020 2020 206b 7761 7267 7320 3d20         kwargs = 
+00011780: 5b5d 0a20 2020 2066 6f72 2063 6c73 5f20  [].    for cls_ 
+00011790: 696e 2069 6e73 7065 6374 2e67 6574 6d72  in inspect.getmr
+000117a0: 6f28 636c 7329 3a0a 2020 2020 2020 2020  o(cls):.        
+000117b0: 2320 4368 6563 6b20 5079 7468 6f6e 2066  # Check Python f
+000117c0: 756e 6374 696f 6e2e 2043 6f75 6c64 2062  unction. Could b
+000117d0: 6520 6275 696c 7469 6e20 6675 6e63 206f  e builtin func o
+000117e0: 7220 736f 2e20 5079 7468 6f6e 2032 2067  r so. Python 2 g
+000117f0: 6574 6172 6773 7065 6320 646f 6573 206e  etargspec does n
+00011800: 6f74 2077 6f72 6b20 696e 2074 6861 7420  ot work in that 
+00011810: 6361 7365 2e0a 2020 2020 2020 2020 6966  case..        if
+00011820: 206e 6f74 2069 6e73 7065 6374 2e69 736d   not inspect.ism
+00011830: 6574 686f 6428 636c 735f 2e5f 5f69 6e69  ethod(cls_.__ini
+00011840: 745f 5f29 2061 6e64 206e 6f74 2069 6e73  t__) and not ins
+00011850: 7065 6374 2e69 7366 756e 6374 696f 6e28  pect.isfunction(
+00011860: 636c 735f 2e5f 5f69 6e69 745f 5f29 3a0a  cls_.__init__):.
+00011870: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00011880: 696e 7565 0a20 2020 2020 2020 2061 7267  inue.        arg
+00011890: 5f73 7065 6320 3d20 6765 7461 7267 7370  _spec = getargsp
+000118a0: 6563 2863 6c73 5f2e 5f5f 696e 6974 5f5f  ec(cls_.__init__
+000118b0: 290a 2020 2020 2020 2020 6172 6773 203d  ).        args =
+000118c0: 2061 7267 5f73 7065 632e 6172 6773 5b31   arg_spec.args[1
+000118d0: 3a5d 2020 2320 6669 7273 7420 6172 6720  :]  # first arg 
+000118e0: 6973 2073 656c 662c 2069 676e 6f72 650a  is self, ignore.
+000118f0: 2020 2020 2020 2020 6966 206f 6e6c 795f          if only_
+00011900: 7769 7468 5f64 6566 6175 6c74 3a0a 2020  with_default:.  
+00011910: 2020 2020 2020 2020 2020 6966 2061 7267            if arg
+00011920: 5f73 7065 632e 6465 6661 756c 7473 3a0a  _spec.defaults:.
+00011930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011940: 6173 7365 7274 206c 656e 2861 7267 5f73  assert len(arg_s
+00011950: 7065 632e 6465 6661 756c 7473 2920 3c3d  pec.defaults) <=
+00011960: 206c 656e 2861 7267 7329 0a20 2020 2020   len(args).     
+00011970: 2020 2020 2020 2020 2020 2061 7267 7320             args 
+00011980: 3d20 6172 6773 5b6c 656e 2861 7267 7329  = args[len(args)
+00011990: 202d 206c 656e 2861 7267 5f73 7065 632e   - len(arg_spec.
+000119a0: 6465 6661 756c 7473 2920 3a5d 0a20 2020  defaults) :].   
+000119b0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+000119c0: 6572 7420 6c65 6e28 6172 675f 7370 6563  ert len(arg_spec
+000119d0: 2e64 6566 6175 6c74 7329 203d 3d20 6c65  .defaults) == le
+000119e0: 6e28 6172 6773 292c 2061 7267 5f73 7065  n(args), arg_spe
+000119f0: 630a 2020 2020 2020 2020 2020 2020 2020  c.              
+00011a00: 2020 666f 7220 6172 672c 2064 6566 6175    for arg, defau
+00011a10: 6c74 2069 6e20 7a69 7028 6172 6773 2c20  lt in zip(args, 
+00011a20: 6172 675f 7370 6563 2e64 6566 6175 6c74  arg_spec.default
+00011a30: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00011a40: 2020 2020 2020 2020 6b77 6172 6773 5b61          kwargs[a
+00011a50: 7267 5d20 3d20 6465 6661 756c 740a 2020  rg] = default.  
+00011a60: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00011a70: 2020 2020 2020 2020 666f 7220 6172 6720          for arg 
+00011a80: 696e 2061 7267 733a 0a20 2020 2020 2020  in args:.       
+00011a90: 2020 2020 2020 2020 2069 6620 6172 6720           if arg 
+00011aa0: 6e6f 7420 696e 206b 7761 7267 733a 0a20  not in kwargs:. 
+00011ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ac0: 2020 206b 7761 7267 732e 6170 7065 6e64     kwargs.append
+00011ad0: 2861 7267 290a 2020 2020 7265 7475 726e  (arg).    return
+00011ae0: 206b 7761 7267 730a 0a0a 6465 6620 6765   kwargs...def ge
+00011af0: 7461 7267 7370 6563 2866 756e 6329 3a0a  targspec(func):.
+00011b00: 2020 2020 2222 220a 2020 2020 3a66 756e      """.    :fun
+00011b10: 633a 6069 6e73 7065 6374 2e67 6574 6675  c:`inspect.getfu
+00011b20: 6c6c 6172 6773 7065 6360 206f 7220 6069  llargspec` or `i
+00011b30: 6e73 7065 6374 2e67 6574 6172 6773 7065  nspect.getargspe
+00011b40: 6360 2028 5079 7468 6f6e 2032 290a 0a20  c` (Python 2).. 
+00011b50: 2020 203a 7061 7261 6d20 6675 6e63 3a0a     :param func:.
+00011b60: 2020 2020 3a72 6574 7572 6e3a 2046 756c      :return: Ful
+00011b70: 6c41 7267 5370 6563 0a20 2020 2022 2222  lArgSpec.    """
+00011b80: 0a20 2020 2069 6620 5059 333a 0a20 2020  .    if PY3:.   
+00011b90: 2020 2020 2072 6574 7572 6e20 696e 7370       return insp
+00011ba0: 6563 742e 6765 7466 756c 6c61 7267 7370  ect.getfullargsp
+00011bb0: 6563 2866 756e 6329 0a20 2020 2065 6c73  ec(func).    els
+00011bc0: 653a 0a20 2020 2020 2020 2023 206e 6f69  e:.        # noi
+00011bd0: 6e73 7065 6374 696f 6e20 5079 4465 7072  nspection PyDepr
+00011be0: 6563 6174 696f 6e0a 2020 2020 2020 2020  ecation.        
+00011bf0: 7265 7475 726e 2069 6e73 7065 6374 2e67  return inspect.g
+00011c00: 6574 6172 6773 7065 6328 6675 6e63 290a  etargspec(func).
+00011c10: 0a0a 6465 6620 636f 6c6c 6563 745f 6d61  ..def collect_ma
+00011c20: 6e64 6174 6f72 795f 636c 6173 735f 696e  ndatory_class_in
+00011c30: 6974 5f6b 7761 7267 7328 636c 7329 3a0a  it_kwargs(cls):.
+00011c40: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
+00011c50: 616d 2074 7970 6520 636c 733a 0a20 2020  am type cls:.   
+00011c60: 203a 7265 7475 726e 3a20 6c69 7374 206f   :return: list o
+00011c70: 6620 6b77 6172 6773 2077 6869 6368 2068  f kwargs which h
+00011c80: 6176 6520 6e6f 2064 6566 6175 6c74 2c20  ave no default, 
+00011c90: 692e 652e 2077 6869 6368 206d 7573 7420  i.e. which must 
+00011ca0: 6265 2070 726f 7669 6465 640a 2020 2020  be provided.    
+00011cb0: 3a72 7479 7065 3a20 6c69 7374 5b73 7472  :rtype: list[str
+00011cc0: 5d0a 2020 2020 2222 220a 2020 2020 616c  ].    """.    al
+00011cd0: 6c5f 6b77 6172 6773 203d 2063 6f6c 6c65  l_kwargs = colle
+00011ce0: 6374 5f63 6c61 7373 5f69 6e69 745f 6b77  ct_class_init_kw
+00011cf0: 6172 6773 2863 6c73 2c20 6f6e 6c79 5f77  args(cls, only_w
+00011d00: 6974 685f 6465 6661 756c 743d 4661 6c73  ith_default=Fals
+00011d10: 6529 0a20 2020 2064 6566 6175 6c74 5f6b  e).    default_k
+00011d20: 7761 7267 7320 3d20 636f 6c6c 6563 745f  wargs = collect_
+00011d30: 636c 6173 735f 696e 6974 5f6b 7761 7267  class_init_kwarg
+00011d40: 7328 636c 732c 206f 6e6c 795f 7769 7468  s(cls, only_with
+00011d50: 5f64 6566 6175 6c74 3d54 7275 6529 0a20  _default=True). 
+00011d60: 2020 206d 616e 6461 746f 7279 5f6b 7761     mandatory_kwa
+00011d70: 7267 7320 3d20 5b5d 0a20 2020 2066 6f72  rgs = [].    for
+00011d80: 2061 7267 2069 6e20 616c 6c5f 6b77 6172   arg in all_kwar
+00011d90: 6773 3a0a 2020 2020 2020 2020 6966 2061  gs:.        if a
+00011da0: 7267 206e 6f74 2069 6e20 6465 6661 756c  rg not in defaul
+00011db0: 745f 6b77 6172 6773 3a0a 2020 2020 2020  t_kwargs:.      
+00011dc0: 2020 2020 2020 6d61 6e64 6174 6f72 795f        mandatory_
+00011dd0: 6b77 6172 6773 2e61 7070 656e 6428 6172  kwargs.append(ar
+00011de0: 6729 0a20 2020 2072 6574 7572 6e20 6d61  g).    return ma
+00011df0: 6e64 6174 6f72 795f 6b77 6172 6773 0a0a  ndatory_kwargs..
+00011e00: 0a64 6566 2068 656c 705f 6f6e 5f74 7970  .def help_on_typ
+00011e10: 655f 6572 726f 725f 7772 6f6e 675f 6172  e_error_wrong_ar
+00011e20: 6773 2863 6c73 2c20 6b77 6172 6773 293a  gs(cls, kwargs):
+00011e30: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
+00011e40: 7261 6d20 7479 7065 2063 6c73 3a0a 2020  ram type cls:.  
+00011e50: 2020 3a70 6172 616d 206c 6973 745b 7374    :param list[st
+00011e60: 725d 206b 7761 7267 733a 0a20 2020 2022  r] kwargs:.    "
+00011e70: 2222 0a20 2020 206d 616e 6461 746f 7279  "".    mandatory
+00011e80: 5f61 7267 7320 3d20 636f 6c6c 6563 745f  _args = collect_
+00011e90: 6d61 6e64 6174 6f72 795f 636c 6173 735f  mandatory_class_
+00011ea0: 696e 6974 5f6b 7761 7267 7328 636c 7329  init_kwargs(cls)
+00011eb0: 0a20 2020 2066 6f72 2061 7267 2069 6e20  .    for arg in 
+00011ec0: 6b77 6172 6773 3a0a 2020 2020 2020 2020  kwargs:.        
+00011ed0: 6966 2061 7267 2069 6e20 6d61 6e64 6174  if arg in mandat
+00011ee0: 6f72 795f 6172 6773 3a0a 2020 2020 2020  ory_args:.      
+00011ef0: 2020 2020 2020 6d61 6e64 6174 6f72 795f        mandatory_
+00011f00: 6172 6773 2e72 656d 6f76 6528 6172 6729  args.remove(arg)
+00011f10: 0a20 2020 2061 6c6c 5f6b 7761 7267 7320  .    all_kwargs 
+00011f20: 3d20 636f 6c6c 6563 745f 636c 6173 735f  = collect_class_
+00011f30: 696e 6974 5f6b 7761 7267 7328 636c 7329  init_kwargs(cls)
+00011f40: 0a20 2020 2075 6e6b 6e6f 776e 5f61 7267  .    unknown_arg
+00011f50: 7320 3d20 5b5d 0a20 2020 2066 6f72 2061  s = [].    for a
+00011f60: 7267 2069 6e20 6b77 6172 6773 3a0a 2020  rg in kwargs:.  
+00011f70: 2020 2020 2020 6966 2061 7267 206e 6f74        if arg not
+00011f80: 2069 6e20 616c 6c5f 6b77 6172 6773 3a0a   in all_kwargs:.
+00011f90: 2020 2020 2020 2020 2020 2020 756e 6b6e              unkn
+00011fa0: 6f77 6e5f 6172 6773 2e61 7070 656e 6428  own_args.append(
+00011fb0: 6172 6729 0a20 2020 2069 6620 6d61 6e64  arg).    if mand
+00011fc0: 6174 6f72 795f 6172 6773 206f 7220 756e  atory_args or un
+00011fd0: 6b6e 6f77 6e5f 6172 6773 3a0a 2020 2020  known_args:.    
+00011fe0: 2020 2020 7072 696e 7428 2241 7267 7320      print("Args 
+00011ff0: 6d69 736d 6174 6368 3f20 4d69 7373 696e  mismatch? Missin
+00012000: 6720 6172 6520 2572 2c20 756e 6b6e 6f77  g are %r, unknow
+00012010: 6e73 2061 7265 2025 722e 204b 7761 7267  ns are %r. Kwarg
+00012020: 7320 2572 2e22 2025 2028 6d61 6e64 6174  s %r." % (mandat
+00012030: 6f72 795f 6172 6773 2c20 756e 6b6e 6f77  ory_args, unknow
+00012040: 6e5f 6172 6773 2c20 6b77 6172 6773 2929  n_args, kwargs))
+00012050: 0a0a 0a64 6566 2063 7573 746f 6d5f 6578  ...def custom_ex
+00012060: 6563 2873 6f75 7263 653a 2073 7472 2c20  ec(source: str, 
+00012070: 736f 7572 6365 5f66 696c 656e 616d 653a  source_filename:
+00012080: 2073 7472 2c20 7573 6572 5f6e 733a 2044   str, user_ns: D
+00012090: 6963 745b 7374 722c 2041 6e79 5d2c 2075  ict[str, Any], u
+000120a0: 7365 725f 676c 6f62 616c 5f6e 733a 2044  ser_global_ns: D
+000120b0: 6963 745b 7374 722c 2041 6e79 5d29 3a0a  ict[str, Any]):.
+000120c0: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
+000120d0: 616d 2073 6f75 7263 653a 0a20 2020 203a  am source:.    :
+000120e0: 7061 7261 6d20 736f 7572 6365 5f66 696c  param source_fil
+000120f0: 656e 616d 653a 0a20 2020 203a 7061 7261  ename:.    :para
+00012100: 6d20 7573 6572 5f6e 733a 0a20 2020 203a  m user_ns:.    :
+00012110: 7061 7261 6d20 7573 6572 5f67 6c6f 6261  param user_globa
+00012120: 6c5f 6e73 3a0a 2020 2020 3a72 6574 7572  l_ns:.    :retur
+00012130: 6e3a 206e 6f74 6869 6e67 0a20 2020 2022  n: nothing.    "
+00012140: 2222 0a20 2020 2069 6620 6e6f 7420 736f  "".    if not so
+00012150: 7572 6365 2e65 6e64 7377 6974 6828 225c  urce.endswith("\
+00012160: 6e22 293a 0a20 2020 2020 2020 2073 6f75  n"):.        sou
+00012170: 7263 6520 2b3d 2022 5c6e 220a 2020 2020  rce += "\n".    
+00012180: 636f 203d 2063 6f6d 7069 6c65 2873 6f75  co = compile(sou
+00012190: 7263 652c 2073 6f75 7263 655f 6669 6c65  rce, source_file
+000121a0: 6e61 6d65 2c20 2265 7865 6322 290a 2020  name, "exec").  
+000121b0: 2020 7573 6572 5f67 6c6f 6261 6c5f 6e73    user_global_ns
+000121c0: 5b22 5f5f 7061 636b 6167 655f 5f22 5d20  ["__package__"] 
+000121d0: 3d20 2272 6574 7572 6e6e 2220 2023 2069  = "returnn"  # i
+000121e0: 6d70 6f72 7461 6e74 2073 6f20 7468 6174  mportant so that
+000121f0: 2069 6d70 6f72 7473 2077 6f72 6b0a 2020   imports work.  
+00012200: 2020 6576 616c 2863 6f2c 2075 7365 725f    eval(co, user_
+00012210: 676c 6f62 616c 5f6e 732c 2075 7365 725f  global_ns, user_
+00012220: 6e73 290a 0a0a 636c 6173 7320 4672 6f7a  ns)...class Froz
+00012230: 656e 4469 6374 2864 6963 7429 3a0a 2020  enDict(dict):.  
+00012240: 2020 2222 220a 2020 2020 4672 6f7a 656e    """.    Frozen
+00012250: 2064 6963 742e 0a20 2020 2022 2222 0a0a   dict..    """..
+00012260: 2020 2020 6465 6620 5f5f 7365 7469 7465      def __setite
+00012270: 6d5f 5f28 7365 6c66 2c20 6b65 792c 2076  m__(self, key, v
+00012280: 616c 7565 293a 0a20 2020 2020 2020 2072  alue):.        r
+00012290: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000122a0: 2246 726f 7a65 6e44 6963 7420 6361 6e6e  "FrozenDict cann
+000122b0: 6f74 2062 6520 6d6f 6469 6669 6564 2229  ot be modified")
+000122c0: 0a0a 2020 2020 6465 6620 5f5f 6861 7368  ..    def __hash
+000122d0: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+000122e0: 2020 7265 7475 726e 2068 6173 6828 7475    return hash(tu
+000122f0: 706c 6528 736f 7274 6564 2873 656c 662e  ple(sorted(self.
+00012300: 6974 656d 7328 2929 2929 0a0a 0a64 6566  items())))...def
+00012310: 206d 616b 655f 6861 7368 6162 6c65 286f   make_hashable(o
+00012320: 626a 293a 0a20 2020 2022 2222 0a20 2020  bj):.    """.   
+00012330: 2054 6865 616e 6f20 6e65 6564 7320 6861   Theano needs ha
+00012340: 7368 6162 6c65 206f 626a 6563 7473 2069  shable objects i
+00012350: 6e20 736f 6d65 2063 6173 6573 2c20 652e  n some cases, e.
+00012360: 672e 2074 6865 2070 726f 7065 7274 6965  g. the propertie
+00012370: 7320 6f66 204f 7073 2e0a 2020 2020 5468  s of Ops..    Th
+00012380: 6973 2063 6f6e 7665 7274 7320 616c 6c20  is converts all 
+00012390: 6f62 6a65 6374 7320 6173 2073 7563 682c  objects as such,
+000123a0: 2069 2e65 2e20 696e 746f 2069 6d6d 7574   i.e. into immut
+000123b0: 6162 6c65 2066 726f 7a65 6e20 7479 7065  able frozen type
+000123c0: 732e 0a0a 2020 2020 3a70 6172 616d 2054  s...    :param T
+000123d0: 7c64 6963 747c 6c69 7374 7c74 7570 6c65  |dict|list|tuple
+000123e0: 206f 626a 3a0a 2020 2020 3a72 7479 7065   obj:.    :rtype
+000123f0: 3a20 547c 4672 6f7a 656e 4469 6374 7c74  : T|FrozenDict|t
+00012400: 7570 6c65 0a20 2020 2022 2222 0a20 2020  uple.    """.   
+00012410: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+00012420: 626a 2c20 6469 6374 293a 0a20 2020 2020  bj, dict):.     
+00012430: 2020 2072 6574 7572 6e20 4672 6f7a 656e     return Frozen
+00012440: 4469 6374 285b 6d61 6b65 5f68 6173 6861  Dict([make_hasha
+00012450: 626c 6528 6974 656d 2920 666f 7220 6974  ble(item) for it
+00012460: 656d 2069 6e20 6f62 6a2e 6974 656d 7328  em in obj.items(
+00012470: 295d 290a 2020 2020 6966 2069 7369 6e73  )]).    if isins
+00012480: 7461 6e63 6528 6f62 6a2c 2028 6c69 7374  tance(obj, (list
+00012490: 2c20 7475 706c 6529 293a 0a20 2020 2020  , tuple)):.     
+000124a0: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+000124b0: 5b6d 616b 655f 6861 7368 6162 6c65 2869  [make_hashable(i
+000124c0: 7465 6d29 2066 6f72 2069 7465 6d20 696e  tem) for item in
+000124d0: 206f 626a 5d29 0a20 2020 2069 6620 6973   obj]).    if is
+000124e0: 696e 7374 616e 6365 286f 626a 2c20 2873  instance(obj, (s
+000124f0: 7472 2c20 756e 6963 6f64 652c 2066 6c6f  tr, unicode, flo
+00012500: 6174 2c20 696e 742c 206c 6f6e 6729 293a  at, int, long)):
+00012510: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00012520: 6f62 6a0a 2020 2020 6966 206f 626a 2069  obj.    if obj i
+00012530: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00012540: 7265 7475 726e 206f 626a 0a20 2020 2069  return obj.    i
+00012550: 6620 2274 656e 736f 7266 6c6f 7722 2069  f "tensorflow" i
+00012560: 6e20 7379 732e 6d6f 6475 6c65 733a 0a20  n sys.modules:. 
+00012570: 2020 2020 2020 2069 6d70 6f72 7420 7465         import te
+00012580: 6e73 6f72 666c 6f77 2061 7320 7466 0a0a  nsorflow as tf..
+00012590: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000125a0: 7461 6e63 6528 6f62 6a2c 2074 662e 5465  tance(obj, tf.Te
+000125b0: 6e73 6f72 293a 0a20 2020 2020 2020 2020  nsor):.         
+000125c0: 2020 2072 6574 7572 6e20 5265 6649 6445     return RefIdE
+000125d0: 7128 6f62 6a29 0a20 2020 2061 7373 6572  q(obj).    asser
+000125e0: 7420 4661 6c73 652c 2022 646f 6e27 7420  t False, "don't 
+000125f0: 6b6e 6f77 2068 6f77 2074 6f20 6d61 6b65  know how to make
+00012600: 2068 6173 6861 626c 653a 2025 7220 2825   hashable: %r (%
+00012610: 7229 2220 2520 286f 626a 2c20 7479 7065  r)" % (obj, type
+00012620: 286f 626a 2929 0a0a 0a63 6c61 7373 2052  (obj))...class R
+00012630: 6566 4964 4571 2847 656e 6572 6963 5b54  efIdEq(Generic[T
+00012640: 5d29 3a0a 2020 2020 2222 220a 2020 2020  ]):.    """.    
+00012650: 5265 6665 7265 6e63 6520 746f 2073 6f6d  Reference to som
+00012660: 6520 6f62 6a65 6374 2028 652e 672e 2074  e object (e.g. t
+00012670: 2e66 5465 6e73 6f72 292c 2062 7574 2074  .fTensor), but t
+00012680: 6869 7320 6f62 6a65 6374 2069 7320 616c  his object is al
+00012690: 7761 7973 2068 6173 6861 626c 652c 0a20  ways hashable,. 
+000126a0: 2020 2061 6e64 2075 7365 7320 7468 6520     and uses the 
+000126b0: 6069 6460 206f 6620 7468 6520 6675 6e63  `id` of the func
+000126c0: 7469 6f6e 2066 6f72 2074 6865 2068 6173  tion for the has
+000126d0: 6820 616e 6420 6571 7561 6c69 7479 2e0a  h and equality..
+000126e0: 0a20 2020 2028 496e 2063 6173 6520 6f66  .    (In case of
+000126f0: 2074 662e 5465 6e73 6f72 2c20 7468 6973   tf.Tensor, this
+00012700: 2069 7320 666f 7220 636f 6d70 6174 6962   is for compatib
+00012710: 696c 6974 790a 2020 2020 2062 6563 6175  ility.     becau
+00012720: 7365 2074 662e 5465 6e73 6f72 2e72 6566  se tf.Tensor.ref
+00012730: 2829 2077 6173 206e 6f74 2061 7661 696c  () was not avail
+00012740: 6162 6c65 2069 6e20 6561 726c 6965 7220  able in earlier 
+00012750: 5446 2076 6572 7369 6f6e 732e 0a20 2020  TF versions..   
+00012760: 2020 486f 7765 7665 722c 2077 6520 616c    However, we al
+00012770: 736f 206e 6565 6420 7468 6973 2066 6f72  so need this for
+00012780: 203a 636c 6173 733a 6044 6963 7452 6566   :class:`DictRef
+00012790: 4b65 7973 602e 290a 2020 2020 2854 6869  Keys`.).    (Thi
+000127a0: 7320 7761 7320 5465 6e73 6f72 5265 6620  s was TensorRef 
+000127b0: 696e 2065 6172 6c69 6572 2052 4554 5552  in earlier RETUR
+000127c0: 4e4e 2076 6572 7369 6f6e 732e 290a 2020  NN versions.).  
+000127d0: 2020 2222 220a 0a20 2020 2064 6566 205f    """..    def _
+000127e0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6f62  _init__(self, ob
+000127f0: 6a3a 2054 293a 0a20 2020 2020 2020 2022  j: T):.        "
+00012800: 2222 0a20 2020 2020 2020 203a 7061 7261  "".        :para
+00012810: 6d20 6f62 6a3a 2066 6f72 2065 7861 6d70  m obj: for examp
+00012820: 6c65 2074 662e 5465 6e73 6f72 0a20 2020  le tf.Tensor.   
+00012830: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00012840: 2073 656c 662e 6f62 6a20 3d20 6f62 6a0a   self.obj = obj.
+00012850: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
+00012860: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
+00012870: 2072 6574 7572 6e20 2254 656e 736f 7252   return "TensorR
+00012880: 6566 7b25 727d 2220 2520 7365 6c66 2e6f  ef{%r}" % self.o
+00012890: 626a 0a0a 2020 2020 6465 6620 5f5f 6571  bj..    def __eq
+000128a0: 5f5f 2873 656c 662c 206f 7468 6572 293a  __(self, other):
+000128b0: 0a20 2020 2020 2020 2069 6620 6f74 6865  .        if othe
+000128c0: 7220 6973 204e 6f6e 6520 6f72 206e 6f74  r is None or not
+000128d0: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
+000128e0: 722c 2052 6566 4964 4571 293a 0a20 2020  r, RefIdEq):.   
+000128f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00012900: 4661 6c73 650a 2020 2020 2020 2020 7265  False.        re
+00012910: 7475 726e 2073 656c 662e 6f62 6a20 6973  turn self.obj is
+00012920: 206f 7468 6572 2e6f 626a 0a0a 2020 2020   other.obj..    
+00012930: 6465 6620 5f5f 6e65 5f5f 2873 656c 662c  def __ne__(self,
+00012940: 206f 7468 6572 293a 0a20 2020 2020 2020   other):.       
+00012950: 2072 6574 7572 6e20 6e6f 7420 7365 6c66   return not self
+00012960: 2e5f 5f65 715f 5f28 6f74 6865 7229 0a0a  .__eq__(other)..
+00012970: 2020 2020 6465 6620 5f5f 6861 7368 5f5f      def __hash__
+00012980: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00012990: 7265 7475 726e 2069 6428 7365 6c66 2e6f  return id(self.o
+000129a0: 626a 290a 0a0a 636c 6173 7320 4469 6374  bj)...class Dict
+000129b0: 5265 664b 6579 7328 4765 6e65 7269 635b  RefKeys(Generic[
+000129c0: 4b2c 2056 5d29 3a0a 2020 2020 2222 220a  K, V]):.    """.
+000129d0: 2020 2020 4c69 6b65 2060 6469 6374 602c      Like `dict`,
+000129e0: 2062 7574 2068 6173 6820 616e 6420 6571   but hash and eq
+000129f0: 7561 6c69 7479 206f 6620 7468 6520 6b65  uality of the ke
+00012a00: 7973 0a20 2020 2022 2222 0a0a 2020 2020  ys.    """..    
+00012a10: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00012a20: 6629 3a0a 2020 2020 2020 2020 7365 6c66  f):.        self
+00012a30: 2e5f 6420 3d20 7b7d 2020 2320 7479 7065  ._d = {}  # type
+00012a40: 3a20 4469 6374 5b52 6566 4964 4571 5b4b  : Dict[RefIdEq[K
+00012a50: 5d2c 2056 5d0a 0a20 2020 2064 6566 205f  ], V]..    def _
+00012a60: 5f72 6570 725f 5f28 7365 6c66 293a 0a20  _repr__(self):. 
+00012a70: 2020 2020 2020 2072 6574 7572 6e20 2244         return "D
+00012a80: 6963 7452 6566 4b65 7973 2825 7329 2220  ictRefKeys(%s)" 
+00012a90: 2520 222c 2022 2e6a 6f69 6e28 5b22 2572  % ", ".join(["%r
+00012aa0: 3a20 2572 2220 2520 286b 2c20 7629 2066  : %r" % (k, v) f
+00012ab0: 6f72 2028 6b2c 2076 2920 696e 2073 656c  or (k, v) in sel
+00012ac0: 662e 6974 656d 7328 295d 290a 0a20 2020  f.items()])..   
+00012ad0: 2064 6566 2069 7465 6d73 2873 656c 6629   def items(self)
+00012ae0: 202d 3e20 4974 6572 6162 6c65 5b54 7570   -> Iterable[Tup
+00012af0: 6c65 5b4b 2c20 565d 5d3a 0a20 2020 2020  le[K, V]]:.     
+00012b00: 2020 2022 2222 6974 656d 7322 2222 0a20     """items""". 
+00012b10: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+00012b20: 696e 2073 656c 662e 5f64 2e69 7465 6d73  in self._d.items
+00012b30: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00012b40: 7969 656c 6420 6b2e 6f62 6a2c 2076 0a0a  yield k.obj, v..
+00012b50: 2020 2020 6465 6620 6b65 7973 2873 656c      def keys(sel
+00012b60: 6629 202d 3e20 4974 6572 6162 6c65 5b4b  f) -> Iterable[K
+00012b70: 5d3a 0a20 2020 2020 2020 2022 2222 6b65  ]:.        """ke
+00012b80: 7973 2222 220a 2020 2020 2020 2020 666f  ys""".        fo
+00012b90: 7220 6b20 696e 2073 656c 662e 5f64 2e6b  r k in self._d.k
+00012ba0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+00012bb0: 2020 2079 6965 6c64 206b 2e6f 626a 0a0a     yield k.obj..
+00012bc0: 2020 2020 6465 6620 7661 6c75 6573 2873      def values(s
+00012bd0: 656c 6629 202d 3e20 4974 6572 6162 6c65  elf) -> Iterable
+00012be0: 5b56 5d3a 0a20 2020 2020 2020 2022 2222  [V]:.        """
+00012bf0: 7661 6c75 6573 2222 220a 2020 2020 2020  values""".      
+00012c00: 2020 666f 7220 7620 696e 2073 656c 662e    for v in self.
+00012c10: 5f64 2e76 616c 7565 7328 293a 0a20 2020  _d.values():.   
+00012c20: 2020 2020 2020 2020 2079 6965 6c64 2076           yield v
+00012c30: 0a0a 2020 2020 6465 6620 5f5f 6765 7469  ..    def __geti
+00012c40: 7465 6d5f 5f28 7365 6c66 2c20 6974 656d  tem__(self, item
+00012c50: 3a20 4b29 202d 3e20 563a 0a20 2020 2020  : K) -> V:.     
+00012c60: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00012c70: 645b 5265 6649 6445 7128 6974 656d 295d  d[RefIdEq(item)]
+00012c80: 0a0a 2020 2020 6465 6620 5f5f 7365 7469  ..    def __seti
+00012c90: 7465 6d5f 5f28 7365 6c66 2c20 6b65 793a  tem__(self, key:
+00012ca0: 204b 2c20 7661 6c75 653a 2056 293a 0a20   K, value: V):. 
+00012cb0: 2020 2020 2020 2073 656c 662e 5f64 5b52         self._d[R
+00012cc0: 6566 4964 4571 286b 6579 295d 203d 2076  efIdEq(key)] = v
+00012cd0: 616c 7565 0a0a 2020 2020 6465 6620 5f5f  alue..    def __
+00012ce0: 636f 6e74 6169 6e73 5f5f 2873 656c 662c  contains__(self,
+00012cf0: 2069 7465 6d3a 204b 293a 0a20 2020 2020   item: K):.     
+00012d00: 2020 2072 6574 7572 6e20 5265 6649 6445     return RefIdE
+00012d10: 7128 6974 656d 2920 696e 2073 656c 662e  q(item) in self.
+00012d20: 5f64 0a0a 0a64 6566 206d 616b 655f 646c  _d...def make_dl
+00012d30: 6c5f 6e61 6d65 2862 6173 656e 616d 6529  l_name(basename)
+00012d40: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
+00012d50: 6172 616d 2073 7472 2062 6173 656e 616d  aram str basenam
+00012d60: 653a 0a20 2020 203a 7265 7475 726e 3a20  e:.    :return: 
+00012d70: 652e 672e 2022 6c69 6225 732e 736f 2220  e.g. "lib%s.so" 
+00012d80: 2520 6261 7365 6e61 6d65 2c20 6465 7065  % basename, depe
+00012d90: 6e64 696e 6720 6f6e 2073 7973 2e70 6c61  nding on sys.pla
+00012da0: 7466 6f72 6d0a 2020 2020 3a72 7479 7065  tform.    :rtype
+00012db0: 3a20 7374 720a 2020 2020 2222 220a 2020  : str.    """.  
+00012dc0: 2020 6966 2073 7973 2e70 6c61 7466 6f72    if sys.platfor
+00012dd0: 6d20 3d3d 2022 6461 7277 696e 223a 0a20  m == "darwin":. 
+00012de0: 2020 2020 2020 2072 6574 7572 6e20 226c         return "l
+00012df0: 6962 2573 2e64 796c 6962 2220 2520 6261  ib%s.dylib" % ba
+00012e00: 7365 6e61 6d65 0a20 2020 2065 6c69 6620  sename.    elif 
+00012e10: 7379 732e 706c 6174 666f 726d 203d 3d20  sys.platform == 
+00012e20: 2277 696e 3332 223a 0a20 2020 2020 2020  "win32":.       
+00012e30: 2072 6574 7572 6e20 2225 732e 646c 6c22   return "%s.dll"
+00012e40: 2025 2062 6173 656e 616d 650a 2020 2020   % basename.    
+00012e50: 656c 7365 3a20 2023 204c 696e 7578 2c20  else:  # Linux, 
+00012e60: 556e 6978 0a20 2020 2020 2020 2072 6574  Unix.        ret
+00012e70: 7572 6e20 226c 6962 2573 2e73 6f22 2025  urn "lib%s.so" %
+00012e80: 2062 6173 656e 616d 650a 0a0a 6465 6620   basename...def 
+00012e90: 6573 6361 7065 5f63 5f73 7472 2873 293a  escape_c_str(s):
+00012ea0: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
+00012eb0: 7261 6d20 7374 7220 733a 0a20 2020 203a  ram str s:.    :
+00012ec0: 7265 7475 726e 3a20 432d 6573 6361 7065  return: C-escape
+00012ed0: 6420 7374 720a 2020 2020 3a72 7479 7065  d str.    :rtype
+00012ee0: 3a20 7374 720a 2020 2020 2222 220a 2020  : str.    """.  
+00012ef0: 2020 7265 7475 726e 2027 2225 7322 2720    return '"%s"' 
+00012f00: 2520 732e 7265 706c 6163 6528 225c 5c5c  % s.replace("\\\
+00012f10: 5c22 2c20 225c 5c22 292e 7265 706c 6163  \", "\\").replac
+00012f20: 6528 225c 6e22 2c20 225c 5c6e 2229 2e72  e("\n", "\\n").r
+00012f30: 6570 6c61 6365 2827 2227 2c20 275c 5c22  eplace('"', '\\"
+00012f40: 2729 2e72 6570 6c61 6365 2822 2722 2c20  ').replace("'", 
+00012f50: 225c 5c27 2229 0a0a 0a64 6566 2061 7474  "\\'")...def att
+00012f60: 725f 6368 6169 6e28 6261 7365 2c20 6174  r_chain(base, at
+00012f70: 7472 6962 7329 3a0a 2020 2020 2222 220a  tribs):.    """.
+00012f80: 2020 2020 3a70 6172 616d 206f 626a 6563      :param objec
+00012f90: 7420 6261 7365 3a0a 2020 2020 3a70 6172  t base:.    :par
+00012fa0: 616d 206c 6973 745b 7374 725d 7c74 7570  am list[str]|tup
+00012fb0: 6c65 5b73 7472 5d7c 7374 7220 6174 7472  le[str]|str attr
+00012fc0: 6962 733a 0a20 2020 203a 7265 7475 726e  ibs:.    :return
+00012fd0: 3a20 6765 7461 7474 7228 6765 7461 7474  : getattr(getatt
+00012fe0: 7228 6f62 6a65 6374 2c20 6174 7472 6962  r(object, attrib
+00012ff0: 735b 305d 292c 2061 7474 7269 6273 5b31  s[0]), attribs[1
+00013000: 5d29 202e 2e2e 0a20 2020 203a 7274 7970  ]) ....    :rtyp
+00013010: 653a 206f 626a 6563 740a 2020 2020 2222  e: object.    ""
+00013020: 220a 2020 2020 6966 206e 6f74 2069 7369  ".    if not isi
+00013030: 6e73 7461 6e63 6528 6174 7472 6962 732c  nstance(attribs,
+00013040: 2028 6c69 7374 2c20 7475 706c 6529 293a   (list, tuple)):
+00013050: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00013060: 6973 696e 7374 616e 6365 2861 7474 7269  isinstance(attri
+00013070: 6273 2c20 7374 7229 0a20 2020 2020 2020  bs, str).       
+00013080: 2061 7474 7269 6273 203d 205b 6174 7472   attribs = [attr
+00013090: 6962 735d 0a20 2020 2065 6c73 653a 0a20  ibs].    else:. 
+000130a0: 2020 2020 2020 2061 7474 7269 6273 203d         attribs =
+000130b0: 206c 6973 7428 6174 7472 6962 7329 0a20   list(attribs). 
+000130c0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+000130d0: 6528 6c65 6e28 6174 7472 6962 7329 293a  e(len(attribs)):
+000130e0: 0a20 2020 2020 2020 2062 6173 6520 3d20  .        base = 
+000130f0: 6765 7461 7474 7228 6261 7365 2c20 6174  getattr(base, at
+00013100: 7472 6962 735b 695d 290a 2020 2020 7265  tribs[i]).    re
+00013110: 7475 726e 2062 6173 650a 0a0a 6465 6620  turn base...def 
+00013120: 746f 5f62 6f6f 6c28 7629 3a0a 2020 2020  to_bool(v):.    
+00013130: 2222 220a 2020 2020 3a70 6172 616d 2069  """.    :param i
+00013140: 6e74 7c66 6c6f 6174 7c73 7472 2076 3a20  nt|float|str v: 
+00013150: 6966 2069 7420 6973 2061 2073 7472 696e  if it is a strin
+00013160: 672c 2069 7420 7368 6f75 6c64 2072 6570  g, it should rep
+00013170: 7265 7365 6e74 2073 6f6d 6520 696e 7465  resent some inte
+00013180: 6765 722c 206f 7220 616c 7465 726e 6174  ger, or alternat
+00013190: 6976 656c 7920 2274 7275 6522 206f 7220  ively "true" or 
+000131a0: 2266 616c 7365 220a 2020 2020 3a72 7479  "false".    :rty
+000131b0: 7065 3a20 626f 6f6c 0a20 2020 2022 2222  pe: bool.    """
+000131c0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+000131d0: 2020 7265 7475 726e 2062 6f6f 6c28 696e    return bool(in
+000131e0: 7428 7629 290a 2020 2020 6578 6365 7074  t(v)).    except
+000131f0: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
+00013200: 2020 2020 2070 6173 730a 2020 2020 6966       pass.    if
+00013210: 2069 7369 6e73 7461 6e63 6528 762c 2028   isinstance(v, (
+00013220: 7374 722c 2075 6e69 636f 6465 2929 3a0a  str, unicode)):.
+00013230: 2020 2020 2020 2020 7620 3d20 762e 6c6f          v = v.lo
+00013240: 7765 7228 290a 2020 2020 2020 2020 6966  wer().        if
+00013250: 2076 2069 6e20 5b22 7472 7565 222c 2022   v in ["true", "
+00013260: 7965 7322 2c20 226f 6e22 2c20 2231 225d  yes", "on", "1"]
+00013270: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00013280: 7475 726e 2054 7275 650a 2020 2020 2020  turn True.      
+00013290: 2020 6966 2076 2069 6e20 5b22 6661 6c73    if v in ["fals
+000132a0: 6522 2c20 226e 6f22 2c20 226f 6666 222c  e", "no", "off",
+000132b0: 2022 3022 5d3a 0a20 2020 2020 2020 2020   "0"]:.         
+000132c0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+000132d0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000132e0: 7272 6f72 2822 746f 5f62 6f6f 6c20 6361  rror("to_bool ca
+000132f0: 6e6e 6f74 2068 616e 646c 6520 2572 2220  nnot handle %r" 
+00013300: 2520 7629 0a0a 0a64 6566 2061 735f 7374  % v)...def as_st
+00013310: 7228 7329 3a0a 2020 2020 2222 220a 2020  r(s):.    """.  
+00013320: 2020 3a70 6172 616d 2073 7472 7c75 6e69    :param str|uni
+00013330: 636f 6465 7c62 7974 6573 2073 3a0a 2020  code|bytes s:.  
+00013340: 2020 3a72 7479 7065 3a20 7374 727c 756e    :rtype: str|un
+00013350: 6963 6f64 650a 2020 2020 2222 220a 2020  icode.    """.  
+00013360: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00013370: 732c 2073 7472 2920 6f72 2022 756e 6963  s, str) or "unic
+00013380: 6f64 6522 2069 6e20 7374 7228 7479 7065  ode" in str(type
+00013390: 2873 2929 3a0a 2020 2020 2020 2020 7265  (s)):.        re
+000133a0: 7475 726e 2073 0a20 2020 2069 6620 6973  turn s.    if is
+000133b0: 696e 7374 616e 6365 2873 2c20 6279 7465  instance(s, byte
+000133c0: 7329 206f 7220 6973 696e 7374 616e 6365  s) or isinstance
+000133d0: 2873 2c20 756e 6963 6f64 6529 3a0a 2020  (s, unicode):.  
+000133e0: 2020 2020 2020 2320 6e6f 696e 7370 6563        # noinspec
+000133f0: 7469 6f6e 2050 7955 6e72 6573 6f6c 7665  tion PyUnresolve
+00013400: 6452 6566 6572 656e 6365 730a 2020 2020  dReferences.    
+00013410: 2020 2020 7265 7475 726e 2073 2e64 6563      return s.dec
+00013420: 6f64 6528 2275 7466 3822 290a 2020 2020  ode("utf8").    
+00013430: 6173 7365 7274 2046 616c 7365 2c20 2275  assert False, "u
+00013440: 6e6b 6e6f 776e 2074 7970 6520 2573 2220  nknown type %s" 
+00013450: 2520 7479 7065 2873 290a 0a0a 6465 6620  % type(s)...def 
+00013460: 7079 325f 7574 6638 5f73 7472 5f74 6f5f  py2_utf8_str_to_
+00013470: 756e 6963 6f64 6528 7329 3a0a 2020 2020  unicode(s):.    
+00013480: 2222 220a 2020 2020 3a70 6172 616d 2073  """.    :param s
+00013490: 7472 2073 3a20 652e 672e 2074 6865 2073  tr s: e.g. the s
+000134a0: 7472 696e 6720 6c69 7465 7261 6c20 22c3  tring literal ".
+000134b0: a4c3 b6c3 bc22 2069 6e20 5079 7468 6f6e  ....." in Python
+000134c0: 2033 2069 7320 636f 7272 6563 742c 2062   3 is correct, b
+000134d0: 7574 2069 6e20 5079 7468 6f6e 2032 2069  ut in Python 2 i
+000134e0: 7420 7368 6f75 6c64 2068 6176 6520 6265  t should have be
+000134f0: 656e 2075 22c3 a4c3 b6c3 bc22 2c0a 2020  en u"......",.  
+00013500: 2020 2020 6275 7420 6a75 7374 2075 7369      but just usi
+00013510: 6e67 2022 c3a4 c3b6 c3bc 2220 7769 6c6c  ng "......" will
+00013520: 2061 6374 7561 6c6c 7920 6265 2074 6865   actually be the
+00013530: 2072 6177 2075 7466 3820 6279 7465 2073   raw utf8 byte s
+00013540: 6571 7565 6e63 652e 0a20 2020 2020 2054  equence..      T
+00013550: 6869 7320 6361 6e20 6861 7070 656e 2077  his can happen w
+00013560: 6865 6e20 796f 7520 6576 616c 2829 2073  hen you eval() s
+00013570: 6f6d 6520 7374 7269 6e67 2e0a 2020 2020  ome string..    
+00013580: 2020 5765 2061 7373 756d 6520 7468 6174    We assume that
+00013590: 2079 6f75 2061 7265 2075 7369 6e67 2050   you are using P
+000135a0: 7974 686f 6e20 322c 2061 6e64 2067 6f74  ython 2, and got
+000135b0: 2074 6865 2073 7472 696e 6720 286e 6f74   the string (not
+000135c0: 2075 6e69 636f 6465 206f 626a 6563 7429   unicode object)
+000135d0: 2022 c3a4 c3b6 c3bc 222c 206f 7220 6d61   "......", or ma
+000135e0: 7962 6520 2261 6263 222e 0a20 2020 2020  ybe "abc"..     
+000135f0: 2041 6c73 6f20 7365 6520 3a66 756e 633a   Also see :func:
+00013600: 605f 7079 325f 756e 6963 6f64 655f 746f  `_py2_unicode_to
+00013610: 5f73 7472 5f72 6563 7572 7369 7665 6020  _str_recursive` 
+00013620: 616e 6420 3a66 756e 633a 6061 735f 7374  and :func:`as_st
+00013630: 7260 2e0a 2020 2020 3a72 6574 7572 6e3a  r`..    :return:
+00013640: 2069 6620 6974 2069 7320 696e 6465 6564   if it is indeed
+00013650: 2075 6e69 636f 6465 2c20 6974 2077 696c   unicode, it wil
+00013660: 6c20 7265 7475 726e 2074 6865 2075 6e69  l return the uni
+00013670: 636f 6465 206f 626a 6563 742c 206f 7468  code object, oth
+00013680: 6572 7769 7365 2069 7420 6b65 6570 7320  erwise it keeps 
+00013690: 7468 6520 7374 7269 6e67 0a20 2020 203a  the string.    :
+000136a0: 7274 7970 653a 2073 7472 7c75 6e69 636f  rtype: str|unico
+000136b0: 6465 0a20 2020 2022 2222 0a20 2020 2061  de.    """.    a
+000136c0: 7373 6572 7420 6e6f 7420 5059 330a 2020  ssert not PY3.  
+000136d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000136e0: 6e63 6528 732c 2073 7472 290a 2020 2020  nce(s, str).    
+000136f0: 7472 793a 0a20 2020 2020 2020 2023 206e  try:.        # n
+00013700: 6f69 6e73 7065 6374 696f 6e20 5079 556e  oinspection PyUn
+00013710: 7265 736f 6c76 6564 5265 6665 7265 6e63  resolvedReferenc
+00013720: 6573 0a20 2020 2020 2020 2073 2e64 6563  es.        s.dec
+00013730: 6f64 6528 2261 7363 6969 2229 0a20 2020  ode("ascii").   
+00013740: 2020 2020 2072 6574 7572 6e20 730a 2020       return s.  
+00013750: 2020 6578 6365 7074 2055 6e69 636f 6465    except Unicode
+00013760: 4465 636f 6465 4572 726f 723a 0a20 2020  DecodeError:.   
+00013770: 2020 2020 2070 6173 730a 2020 2020 2320       pass.    # 
+00013780: 6e6f 696e 7370 6563 7469 6f6e 2050 7955  noinspection PyU
+00013790: 6e72 6573 6f6c 7665 6452 6566 6572 656e  nresolvedReferen
+000137a0: 6365 730a 2020 2020 7265 7475 726e 2073  ces.    return s
+000137b0: 2e64 6563 6f64 6528 2275 7466 3822 290a  .decode("utf8").
+000137c0: 0a0a 6465 6620 756e 6963 6f64 655f 746f  ..def unicode_to
+000137d0: 5f73 7472 2873 293a 0a20 2020 2022 2222  _str(s):.    """
+000137e0: 0a20 2020 2054 6865 2062 6568 6176 696f  .    The behavio
+000137f0: 7220 6973 2064 6966 6665 7265 6e74 2064  r is different d
+00013800: 6570 656e 6469 6e67 206f 6e20 5079 7468  epending on Pyth
+00013810: 6f6e 2032 206f 7220 5079 7468 6f6e 2033  on 2 or Python 3
+00013820: 2e20 496e 2061 6c6c 2063 6173 6573 2c20  . In all cases, 
+00013830: 7468 6520 7265 7475 726e 6564 2074 7970  the returned typ
+00013840: 6520 6973 2061 2073 7472 206f 626a 6563  e is a str objec
+00013850: 742e 0a20 2020 2050 7974 686f 6e20 323a  t..    Python 2:
+00013860: 0a20 2020 2020 2057 6520 7265 7475 726e  .      We return
+00013870: 2074 6865 2075 7466 3820 656e 636f 6465   the utf8 encode
+00013880: 6420 7374 7220 2877 6869 6368 2069 7320  d str (which is 
+00013890: 6c69 6b65 2050 7974 686f 6e20 3320 6279  like Python 3 by
+000138a0: 7465 732c 206f 7220 666f 7220 4153 4349  tes, or for ASCI
+000138b0: 492c 2074 6865 7265 2069 7320 6e6f 2064  I, there is no d
+000138c0: 6966 6665 7265 6e63 6529 2e0a 2020 2020  ifference)..    
+000138d0: 5079 7468 6f6e 2033 3a0a 2020 2020 2020  Python 3:.      
+000138e0: 5765 2072 6574 7572 6e20 6120 7374 7220  We return a str 
+000138f0: 6f62 6a65 6374 2e0a 2020 2020 4e6f 7465  object..    Note
+00013900: 2074 6861 7420 7468 6973 2066 756e 6374   that this funct
+00013910: 696f 6e20 7072 6f62 6162 6c79 2064 6f65  ion probably doe
+00013920: 7320 6e6f 7420 6d61 6b65 206d 7563 6820  s not make much 
+00013930: 7365 6e73 652e 0a20 2020 2049 7420 6d69  sense..    It mi
+00013940: 6768 7420 6265 2075 7365 6420 7768 656e  ght be used when
+00013950: 2074 6865 7265 2069 7320 6f74 6865 7220   there is other 
+00013960: 636f 6465 2077 6869 6368 2065 7870 6563  code which expec
+00013970: 7473 2061 2073 7472 206f 626a 6563 742c  ts a str object,
+00013980: 206e 6f20 6d61 7474 6572 2069 6620 5079   no matter if Py
+00013990: 7468 6f6e 2032 206f 7220 5079 7468 6f6e  thon 2 or Python
+000139a0: 2033 2e0a 2020 2020 496e 2050 7974 686f   3..    In Pytho
+000139b0: 6e20 322c 2061 2073 7472 206f 626a 6563  n 2, a str objec
+000139c0: 7420 6f66 7465 6e20 686f 6c64 7320 5554  t often holds UT
+000139d0: 4638 2074 6578 742c 2073 6f20 7468 6520  F8 text, so the 
+000139e0: 6265 6861 7669 6f72 206f 6620 7468 6973  behavior of this
+000139f0: 2066 756e 6374 696f 6e20 6973 2066 696e   function is fin
+00013a00: 6520 7468 656e 2e0a 2020 2020 416c 736f  e then..    Also
+00013a10: 2073 6565 203a 6675 6e63 3a60 6173 5f73   see :func:`as_s
+00013a20: 7472 602e 0a0a 2020 2020 3a70 6172 616d  tr`...    :param
+00013a30: 2073 7472 7c75 6e69 636f 6465 7c62 7974   str|unicode|byt
+00013a40: 6573 2073 3a0a 2020 2020 3a72 7479 7065  es s:.    :rtype
+00013a50: 3a20 7374 720a 2020 2020 2222 220a 2020  : str.    """.  
+00013a60: 2020 6966 2050 5933 2061 6e64 2069 7369    if PY3 and isi
+00013a70: 6e73 7461 6e63 6528 732c 2062 7974 6573  nstance(s, bytes
+00013a80: 293a 0a20 2020 2020 2020 2073 203d 2073  ):.        s = s
+00013a90: 2e64 6563 6f64 6528 2275 7466 3822 290a  .decode("utf8").
+00013aa0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+00013ab0: 7369 6e73 7461 6e63 6528 732c 2073 7472  sinstance(s, str
+00013ac0: 290a 2020 2020 6966 206e 6f74 2050 5933  ).    if not PY3
+00013ad0: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
+00013ae0: 732c 2075 6e69 636f 6465 293a 0a20 2020  s, unicode):.   
+00013af0: 2020 2020 2073 203d 2073 2e65 6e63 6f64       s = s.encod
+00013b00: 6528 2275 7466 3822 290a 2020 2020 2020  e("utf8").      
+00013b10: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00013b20: 6e63 6528 732c 2073 7472 290a 2020 2020  nce(s, str).    
+00013b30: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00013b40: 6528 732c 2073 7472 290a 2020 2020 7265  e(s, str).    re
+00013b50: 7475 726e 2073 0a0a 0a64 6566 2064 6565  turn s...def dee
+00013b60: 7063 6f70 7928 782c 2073 746f 705f 7479  pcopy(x, stop_ty
+00013b70: 7065 733d 4e6f 6e65 293a 0a20 2020 2022  pes=None):.    "
+00013b80: 2222 0a20 2020 2053 696d 706c 6572 2076  "".    Simpler v
+00013b90: 6172 6961 6e74 206f 6620 636f 7079 2e64  ariant of copy.d
+00013ba0: 6565 7063 6f70 7928 292e 0a20 2020 2053  eepcopy()..    S
+00013bb0: 686f 756c 6420 6861 6e64 6c65 2073 6f6d  hould handle som
+00013bc0: 6520 6564 6765 2063 6173 6573 2061 7320  e edge cases as 
+00013bd0: 7765 6c6c 2c20 6c69 6b65 2063 6f70 7969  well, like copyi
+00013be0: 6e67 206d 6f64 756c 6520 7265 6665 7265  ng module refere
+00013bf0: 6e63 6573 2e0a 0a20 2020 203a 7061 7261  nces...    :para
+00013c00: 6d20 5420 783a 2061 6e20 6172 6269 7472  m T x: an arbitr
+00013c10: 6172 7920 6f62 6a65 6374 0a20 2020 203a  ary object.    :
+00013c20: 7061 7261 6d20 6c69 7374 5b74 7970 655d  param list[type]
+00013c30: 7c4e 6f6e 6520 7374 6f70 5f74 7970 6573  |None stop_types
+00013c40: 3a20 6f62 6a65 6374 7320 6f66 2074 6865  : objects of the
+00013c50: 7365 2074 7970 6573 2077 696c 6c20 6e6f  se types will no
+00013c60: 7420 6265 2064 6565 702d 636f 7069 6564  t be deep-copied
+00013c70: 2c20 6f6e 6c79 2074 6865 2072 6566 6572  , only the refer
+00013c80: 656e 6365 2069 7320 7061 7373 6564 0a20  ence is passed. 
+00013c90: 2020 203a 7274 7970 653a 2054 0a20 2020     :rtype: T.   
+00013ca0: 2022 2222 0a20 2020 2023 2053 6565 2061   """.    # See a
+00013cb0: 6c73 6f20 636c 6173 7320 5069 636b 6c65  lso class Pickle
+00013cc0: 7220 6672 6f6d 2054 6173 6b53 7973 7465  r from TaskSyste
+00013cd0: 6d2e 0a20 2020 2023 204f 723a 2068 7474  m..    # Or: htt
+00013ce0: 7073 3a2f 2f6d 6169 6c2e 7079 7468 6f6e  ps://mail.python
+00013cf0: 2e6f 7267 2f70 6970 6572 6d61 696c 2f70  .org/pipermail/p
+00013d00: 7974 686f 6e2d 6964 6561 732f 3230 3133  ython-ideas/2013
+00013d10: 2d4a 756c 792f 3032 3139 3539 2e68 746d  -July/021959.htm
+00013d20: 6c0a 2020 2020 6672 6f6d 202e 7461 736b  l.    from .task
+00013d30: 5f73 7973 7465 6d20 696d 706f 7274 2050  _system import P
+00013d40: 6963 6b6c 6572 2c20 556e 7069 636b 6c65  ickler, Unpickle
+00013d50: 720a 0a20 2020 2070 6572 7369 7374 656e  r..    persisten
+00013d60: 745f 6d65 6d6f 203d 207b 7d20 2023 2069  t_memo = {}  # i
+00013d70: 6420 2d3e 206f 626a 0a0a 2020 2020 6465  d -> obj..    de
+00013d80: 6620 7065 7273 6973 7465 6e74 5f69 6428  f persistent_id(
+00013d90: 6f62 6a29 3a0a 2020 2020 2020 2020 2222  obj):.        ""
+00013da0: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
+00013db0: 206f 626a 6563 7420 6f62 6a3a 0a20 2020   object obj:.   
+00013dc0: 2020 2020 203a 7274 7970 653a 2069 6e74       :rtype: int
+00013dd0: 7c4e 6f6e 650a 2020 2020 2020 2020 2222  |None.        ""
+00013de0: 220a 2020 2020 2020 2020 6966 2073 746f  ".        if sto
+00013df0: 705f 7479 7065 7320 616e 6420 6973 696e  p_types and isin
+00013e00: 7374 616e 6365 286f 626a 2c20 7475 706c  stance(obj, tupl
+00013e10: 6528 7374 6f70 5f74 7970 6573 2929 3a0a  e(stop_types)):.
+00013e20: 2020 2020 2020 2020 2020 2020 7065 7273              pers
+00013e30: 6973 7465 6e74 5f6d 656d 6f5b 6964 286f  istent_memo[id(o
+00013e40: 626a 295d 203d 206f 626a 0a20 2020 2020  bj)] = obj.     
+00013e50: 2020 2020 2020 2072 6574 7572 6e20 6964         return id
+00013e60: 286f 626a 290a 2020 2020 2020 2020 7265  (obj).        re
+00013e70: 7475 726e 204e 6f6e 650a 0a20 2020 2064  turn None..    d
+00013e80: 6566 2070 6963 6b6c 655f 6475 6d70 7328  ef pickle_dumps(
+00013e90: 6f62 6a29 3a0a 2020 2020 2020 2020 2222  obj):.        ""
+00013ea0: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
+00013eb0: 206f 626a 6563 7420 6f62 6a3a 0a20 2020   object obj:.   
+00013ec0: 2020 2020 203a 7274 7970 653a 2062 7974       :rtype: byt
+00013ed0: 6573 0a20 2020 2020 2020 2022 2222 0a20  es.        """. 
+00013ee0: 2020 2020 2020 2073 696f 203d 2042 7974         sio = Byt
+00013ef0: 6573 494f 2829 0a20 2020 2020 2020 2070  esIO().        p
+00013f00: 203d 2050 6963 6b6c 6572 2873 696f 290a   = Pickler(sio).
+00013f10: 2020 2020 2020 2020 702e 7065 7273 6973          p.persis
+00013f20: 7465 6e74 5f69 6420 3d20 7065 7273 6973  tent_id = persis
+00013f30: 7465 6e74 5f69 640a 2020 2020 2020 2020  tent_id.        
+00013f40: 702e 6475 6d70 286f 626a 290a 2020 2020  p.dump(obj).    
+00013f50: 2020 2020 7265 7475 726e 2073 696f 2e67      return sio.g
+00013f60: 6574 7661 6c75 6528 290a 0a20 2020 2023  etvalue()..    #
+00013f70: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
+00013f80: 5368 6164 6f77 696e 674e 616d 6573 0a20  ShadowingNames. 
+00013f90: 2020 2064 6566 2070 6963 6b6c 655f 6c6f     def pickle_lo
+00013fa0: 6164 7328 7329 3a0a 2020 2020 2020 2020  ads(s):.        
+00013fb0: 2222 220a 2020 2020 2020 2020 3a70 6172  """.        :par
+00013fc0: 616d 2062 7974 6573 2073 3a0a 2020 2020  am bytes s:.    
+00013fd0: 2020 2020 3a72 7479 7065 3a20 6f62 6a65      :rtype: obje
+00013fe0: 6374 0a20 2020 2020 2020 2022 2222 0a20  ct.        """. 
+00013ff0: 2020 2020 2020 2070 203d 2055 6e70 6963         p = Unpic
+00014000: 6b6c 6572 2842 7974 6573 494f 2873 2929  kler(BytesIO(s))
+00014010: 0a20 2020 2020 2020 2070 2e70 6572 7369  .        p.persi
+00014020: 7374 656e 745f 6c6f 6164 203d 2070 6572  stent_load = per
+00014030: 7369 7374 656e 745f 6d65 6d6f 2e5f 5f67  sistent_memo.__g
+00014040: 6574 6974 656d 5f5f 0a20 2020 2020 2020  etitem__.       
+00014050: 2072 6574 7572 6e20 702e 6c6f 6164 2829   return p.load()
+00014060: 0a0a 2020 2020 7320 3d20 7069 636b 6c65  ..    s = pickle
+00014070: 5f64 756d 7073 2878 290a 2020 2020 6320  _dumps(x).    c 
+00014080: 3d20 7069 636b 6c65 5f6c 6f61 6473 2873  = pickle_loads(s
+00014090: 290a 2020 2020 7265 7475 726e 2063 0a0a  ).    return c..
+000140a0: 0a64 6566 2072 6561 645f 6279 7465 735f  .def read_bytes_
+000140b0: 746f 5f6e 6577 5f62 7566 6665 7228 703a  to_new_buffer(p:
+000140c0: 2074 7970 696e 672e 4269 6e61 7279 494f   typing.BinaryIO
+000140d0: 2c20 7369 7a65 3a20 696e 7429 202d 3e20  , size: int) -> 
+000140e0: 4279 7465 7349 4f3a 0a20 2020 2022 2222  BytesIO:.    """
+000140f0: 0a20 2020 2052 6561 6420 6279 7465 7320  .    Read bytes 
+00014100: 6672 6f6d 2073 7472 6561 6d20 7320 696e  from stream s in
+00014110: 746f 2061 2042 7974 6573 494f 2062 7566  to a BytesIO buf
+00014120: 6665 722e 0a20 2020 2052 6169 7365 7320  fer..    Raises 
+00014130: 454f 4645 7272 6f72 2069 6620 6e6f 7420  EOFError if not 
+00014140: 656e 6f75 6768 2062 7974 6573 2061 7265  enough bytes are
+00014150: 2061 7661 696c 6162 6c65 2e0a 2020 2020   available..    
+00014160: 5468 656e 2072 6561 6420 6974 2076 6961  Then read it via
+00014170: 203a 6675 6e63 3a60 7265 6164 5f70 6963   :func:`read_pic
+00014180: 6b6c 6564 5f6f 626a 6563 7460 2e0a 2020  kled_object`..  
+00014190: 2020 2222 220a 2020 2020 7374 7265 616d    """.    stream
+000141a0: 203d 2042 7974 6573 494f 2829 0a20 2020   = BytesIO().   
+000141b0: 2072 6561 645f 7369 7a65 203d 2030 0a20   read_size = 0. 
+000141c0: 2020 2077 6869 6c65 2072 6561 645f 7369     while read_si
+000141d0: 7a65 203c 2073 697a 653a 0a20 2020 2020  ze < size:.     
+000141e0: 2020 2064 6174 615f 7261 7720 3d20 702e     data_raw = p.
+000141f0: 7265 6164 2873 697a 6520 2d20 7265 6164  read(size - read
+00014200: 5f73 697a 6529 0a20 2020 2020 2020 2069  _size).        i
+00014210: 6620 6c65 6e28 6461 7461 5f72 6177 2920  f len(data_raw) 
+00014220: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00014230: 2020 7261 6973 6520 454f 4645 7272 6f72    raise EOFError
+00014240: 2822 6578 7065 6374 6564 2074 6f20 7265  ("expected to re
+00014250: 6164 2025 6920 6279 7465 7320 6275 7420  ad %i bytes but 
+00014260: 676f 7420 454f 4620 6166 7465 7220 2569  got EOF after %i
+00014270: 2062 7974 6573 2220 2520 2873 697a 652c   bytes" % (size,
+00014280: 2072 6561 645f 7369 7a65 2929 0a20 2020   read_size)).   
+00014290: 2020 2020 2072 6561 645f 7369 7a65 202b       read_size +
+000142a0: 3d20 6c65 6e28 6461 7461 5f72 6177 290a  = len(data_raw).
+000142b0: 2020 2020 2020 2020 7374 7265 616d 2e77          stream.w
+000142c0: 7269 7465 2864 6174 615f 7261 7729 0a20  rite(data_raw). 
+000142d0: 2020 2073 7472 6561 6d2e 7365 656b 2830     stream.seek(0
+000142e0: 290a 2020 2020 7265 7475 726e 2073 7472  ).    return str
+000142f0: 6561 6d0a 0a0a 6465 6620 7265 6164 5f70  eam...def read_p
+00014300: 6963 6b6c 6564 5f6f 626a 6563 7428 703a  ickled_object(p:
+00014310: 2074 7970 696e 672e 4269 6e61 7279 494f   typing.BinaryIO
+00014320: 2920 2d3e 2041 6e79 3a0a 2020 2020 2222  ) -> Any:.    ""
+00014330: 220a 2020 2020 5265 6164 2070 6963 6b6c  ".    Read pickl
+00014340: 6564 206f 626a 6563 7420 6672 6f6d 2073  ed object from s
+00014350: 7472 6561 6d20 702c 0a20 2020 2061 6674  tream p,.    aft
+00014360: 6572 2069 7420 7761 7320 7772 6974 7465  er it was writte
+00014370: 6e20 7669 6120 3a66 756e 633a 6072 6561  n via :func:`rea
+00014380: 645f 6279 7465 735f 746f 5f6e 6577 5f62  d_bytes_to_new_b
+00014390: 7566 6665 7260 2e0a 0a20 2020 203a 7061  uffer`...    :pa
+000143a0: 7261 6d20 703a 0a20 2020 2022 2222 0a20  ram p:.    """. 
+000143b0: 2020 2066 726f 6d20 7265 7475 726e 6e2e     from returnn.
+000143c0: 7574 696c 2e74 6173 6b5f 7379 7374 656d  util.task_system
+000143d0: 2069 6d70 6f72 7420 556e 7069 636b 6c65   import Unpickle
+000143e0: 720a 0a20 2020 2073 697a 655f 7261 7720  r..    size_raw 
+000143f0: 3d20 7265 6164 5f62 7974 6573 5f74 6f5f  = read_bytes_to_
+00014400: 6e65 775f 6275 6666 6572 2870 2c20 3429  new_buffer(p, 4)
+00014410: 2e67 6574 7661 6c75 6528 290a 2020 2020  .getvalue().    
+00014420: 2873 697a 652c 2920 3d20 7374 7275 6374  (size,) = struct
+00014430: 2e75 6e70 6163 6b28 223c 6922 2c20 7369  .unpack("<i", si
+00014440: 7a65 5f72 6177 290a 2020 2020 6173 7365  ze_raw).    asse
+00014450: 7274 2073 697a 6520 3e20 302c 2022 7265  rt size > 0, "re
+00014460: 6164 5f70 6963 6b6c 6564 5f6f 626a 6563  ad_pickled_objec
+00014470: 743a 2057 6520 6578 7065 6374 2074 6f20  t: We expect to 
+00014480: 6765 7420 736f 6d65 206e 6f6e 2d65 6d70  get some non-emp
+00014490: 7479 2070 6163 6b61 6765 2e22 0a20 2020  ty package.".   
+000144a0: 2073 7472 6561 6d20 3d20 7265 6164 5f62   stream = read_b
+000144b0: 7974 6573 5f74 6f5f 6e65 775f 6275 6666  ytes_to_new_buff
+000144c0: 6572 2870 2c20 7369 7a65 290a 2020 2020  er(p, size).    
+000144d0: 7265 7475 726e 2055 6e70 6963 6b6c 6572  return Unpickler
+000144e0: 2873 7472 6561 6d29 2e6c 6f61 6428 290a  (stream).load().
+000144f0: 0a0a 6465 6620 7772 6974 655f 7069 636b  ..def write_pick
+00014500: 6c65 645f 6f62 6a65 6374 2870 3a20 7479  led_object(p: ty
+00014510: 7069 6e67 2e42 696e 6172 7949 4f2c 206f  ping.BinaryIO, o
+00014520: 626a 3a20 416e 7929 3a0a 2020 2020 2222  bj: Any):.    ""
+00014530: 220a 2020 2020 5772 6974 6573 2070 6963  ".    Writes pic
+00014540: 6b6c 6564 206f 626a 6563 7420 746f 2073  kled object to s
+00014550: 7472 6561 6d20 702e 0a20 2020 2022 2222  tream p..    """
+00014560: 0a20 2020 2066 726f 6d20 7265 7475 726e  .    from return
+00014570: 6e2e 7574 696c 2e74 6173 6b5f 7379 7374  n.util.task_syst
+00014580: 656d 2069 6d70 6f72 7420 5069 636b 6c65  em import Pickle
+00014590: 720a 0a20 2020 2073 7472 6561 6d20 3d20  r..    stream = 
+000145a0: 4279 7465 7349 4f28 290a 2020 2020 5069  BytesIO().    Pi
+000145b0: 636b 6c65 7228 7374 7265 616d 292e 6475  ckler(stream).du
+000145c0: 6d70 286f 626a 290a 2020 2020 7261 775f  mp(obj).    raw_
+000145d0: 6461 7461 203d 2073 7472 6561 6d2e 6765  data = stream.ge
+000145e0: 7476 616c 7565 2829 0a20 2020 2061 7373  tvalue().    ass
+000145f0: 6572 7420 6c65 6e28 7261 775f 6461 7461  ert len(raw_data
+00014600: 2920 3e20 300a 2020 2020 702e 7772 6974  ) > 0.    p.writ
+00014610: 6528 7374 7275 6374 2e70 6163 6b28 223c  e(struct.pack("<
+00014620: 6922 2c20 6c65 6e28 7261 775f 6461 7461  i", len(raw_data
+00014630: 2929 290a 2020 2020 702e 7772 6974 6528  ))).    p.write(
+00014640: 7261 775f 6461 7461 290a 2020 2020 702e  raw_data).    p.
+00014650: 666c 7573 6828 290a 0a0a 6465 6620 7365  flush()...def se
+00014660: 7269 616c 697a 655f 6f62 6a65 6374 286f  rialize_object(o
+00014670: 626a 3a20 416e 7929 202d 3e20 6279 7465  bj: Any) -> byte
+00014680: 733a 0a20 2020 2022 2222 0a20 2020 2055  s:.    """.    U
+00014690: 7365 7320 3a66 756e 633a 6077 7269 7465  ses :func:`write
+000146a0: 5f70 6963 6b6c 6564 5f6f 626a 6563 7460  _pickled_object`
+000146b0: 2e0a 2020 2020 2222 220a 2020 2020 7374  ..    """.    st
+000146c0: 7265 616d 203d 2042 7974 6573 494f 2829  ream = BytesIO()
+000146d0: 0a20 2020 2077 7269 7465 5f70 6963 6b6c  .    write_pickl
+000146e0: 6564 5f6f 626a 6563 7428 7374 7265 616d  ed_object(stream
+000146f0: 2c20 6f62 6a29 0a20 2020 2072 6574 7572  , obj).    retur
+00014700: 6e20 7374 7265 616d 2e67 6574 7661 6c75  n stream.getvalu
+00014710: 6528 290a 0a0a 6465 6620 6465 7365 7269  e()...def deseri
+00014720: 616c 697a 655f 6f62 6a65 6374 2864 6174  alize_object(dat
+00014730: 613a 2062 7974 6573 2920 2d3e 2041 6e79  a: bytes) -> Any
+00014740: 3a0a 2020 2020 2222 220a 2020 2020 5573  :.    """.    Us
+00014750: 6573 203a 6675 6e63 3a60 7265 6164 5f70  es :func:`read_p
+00014760: 6963 6b6c 6564 5f6f 626a 6563 7460 2e0a  ickled_object`..
+00014770: 2020 2020 2222 220a 2020 2020 7374 7265      """.    stre
+00014780: 616d 203d 2042 7974 6573 494f 2864 6174  am = BytesIO(dat
+00014790: 6129 0a20 2020 2072 6574 7572 6e20 7265  a).    return re
+000147a0: 6164 5f70 6963 6b6c 6564 5f6f 626a 6563  ad_pickled_objec
+000147b0: 7428 7374 7265 616d 290a 0a0a 6465 6620  t(stream)...def 
+000147c0: 6c6f 6164 5f74 7874 5f76 6563 746f 7228  load_txt_vector(
+000147d0: 6669 6c65 6e61 6d65 293a 0a20 2020 2022  filename):.    "
+000147e0: 2222 0a20 2020 2045 7870 6563 7420 6c69  "".    Expect li
+000147f0: 6e65 2d62 6173 6564 2074 6578 7420 656e  ne-based text en
+00014800: 636f 6469 6e67 2069 6e20 6669 6c65 2e0a  coding in file..
+00014810: 2020 2020 5765 2061 6c73 6f20 7375 7070      We also supp
+00014820: 6f72 7420 5370 7269 6e74 2058 4d4c 2066  ort Sprint XML f
+00014830: 6f72 6d61 742c 2077 6869 6368 2068 6173  ormat, which has
+00014840: 2073 6f6d 6520 6164 6469 7469 6f6e 616c   some additional
+00014850: 2078 6d6c 2068 6561 6465 7220 616e 6420   xml header and 
+00014860: 666f 6f74 6572 2c0a 2020 2020 7768 6963  footer,.    whic
+00014870: 6820 7765 2077 696c 6c20 6a75 7374 2073  h we will just s
+00014880: 7472 6970 2061 7761 792e 0a0a 2020 2020  trip away...    
+00014890: 3a70 6172 616d 2073 7472 2066 696c 656e  :param str filen
+000148a0: 616d 653a 0a20 2020 203a 7274 7970 653a  ame:.    :rtype:
+000148b0: 206c 6973 745b 666c 6f61 745d 0a20 2020   list[float].   
+000148c0: 2022 2222 0a20 2020 2072 6574 7572 6e20   """.    return 
+000148d0: 5b66 6c6f 6174 286c 696e 6529 2066 6f72  [float(line) for
+000148e0: 206c 696e 6520 696e 206f 7065 6e28 6669   line in open(fi
+000148f0: 6c65 6e61 6d65 292e 7265 6164 2829 2e73  lename).read().s
+00014900: 706c 6974 6c69 6e65 7328 2920 6966 206c  plitlines() if l
+00014910: 696e 6520 616e 6420 6e6f 7420 6c69 6e65  ine and not line
+00014920: 2e73 7461 7274 7377 6974 6828 223c 2229  .startswith("<")
+00014930: 5d0a 0a0a 636c 6173 7320 436f 6c6c 6563  ]...class Collec
+00014940: 7469 6f6e 5265 6164 4368 6563 6b43 6f76  tionReadCheckCov
+00014950: 6572 6564 3a0a 2020 2020 2222 220a 2020  ered:.    """.  
+00014960: 2020 5772 6170 7320 6172 6f75 6e64 2061    Wraps around a
+00014970: 2064 6963 742e 2049 7420 6b65 6570 7320   dict. It keeps 
+00014980: 7472 6163 6b20 6162 6f75 7420 616c 6c20  track about all 
+00014990: 7468 6520 6b65 7973 2077 6869 6368 2077  the keys which w
+000149a0: 6572 6520 7265 6164 2066 726f 6d20 7468  ere read from th
+000149b0: 6520 6469 6374 2e0a 2020 2020 5669 6120  e dict..    Via 
+000149c0: 3a66 756e 633a 6061 7373 6572 745f 616c  :func:`assert_al
+000149d0: 6c5f 7265 6164 602c 2079 6f75 2063 616e  l_read`, you can
+000149e0: 2063 6865 636b 2074 6861 7420 7468 6572   check that ther
+000149f0: 6520 6172 6520 6e6f 206b 6579 7320 696e  e are no keys in
+00014a00: 2074 6865 2064 6963 7420 7768 6963 6820   the dict which 
+00014a10: 7765 7265 206e 6f74 2072 6561 642e 0a20  were not read.. 
+00014a20: 2020 2054 6865 2075 7361 6765 2069 7320     The usage is 
+00014a30: 666f 7220 636f 6e66 6967 2064 6963 7420  for config dict 
+00014a40: 6f70 7469 6f6e 732c 2077 6865 7265 2074  options, where t
+00014a50: 6865 2075 7365 7220 6861 7320 7370 6563  he user has spec
+00014a60: 6966 6965 6420 6120 7261 6e67 6520 6f66  ified a range of
+00014a70: 206f 7074 696f 6e73 2c0a 2020 2020 616e   options,.    an
+00014a80: 6420 7768 6572 6520 696e 2074 6865 2063  d where in the c
+00014a90: 6f64 6520 7468 6572 6520 6973 2075 7375  ode there is usu
+00014aa0: 616c 6c79 2061 2064 6566 6175 6c74 2066  ally a default f
+00014ab0: 6f72 2065 7665 7279 206e 6f6e 2d73 7065  or every non-spe
+00014ac0: 6369 6669 6564 206f 7074 696f 6e2c 0a20  cified option,. 
+00014ad0: 2020 2074 6f20 6368 6563 6b20 7768 6574     to check whet
+00014ae0: 6865 7220 616c 6c20 7468 6520 7573 6572  her all the user
+00014af0: 2d73 7065 6369 6669 6564 206f 7074 696f  -specified optio
+00014b00: 6e73 2061 7265 2061 6c73 6f20 7573 6564  ns are also used
+00014b10: 2028 6d61 7962 6520 7468 6520 7573 6572   (maybe the user
+00014b20: 206d 6164 6520 6120 7479 706f 292e 0a20   made a typo).. 
+00014b30: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+00014b40: 5f5f 696e 6974 5f5f 2873 656c 662c 2063  __init__(self, c
+00014b50: 6f6c 6c65 6374 696f 6e3a 2044 6963 745b  ollection: Dict[
+00014b60: 7374 722c 2041 6e79 5d2c 2074 7275 7468  str, Any], truth
+00014b70: 5f76 616c 7565 3a20 4f70 7469 6f6e 616c  _value: Optional
+00014b80: 5b62 6f6f 6c5d 203d 204e 6f6e 6529 3a0a  [bool] = None):.
+00014b90: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00014ba0: 2020 2020 3a70 6172 616d 2063 6f6c 6c65      :param colle
+00014bb0: 6374 696f 6e3a 0a20 2020 2020 2020 203a  ction:.        :
+00014bc0: 7061 7261 6d20 7472 7574 685f 7661 6c75  param truth_valu
+00014bd0: 653a 206e 6f74 653a 2063 6865 636b 2065  e: note: check e
+00014be0: 7870 6c69 6369 746c 7920 666f 7220 7365  xplicitly for se
+00014bf0: 6c66 2e74 7275 7468 5f76 616c 7565 2c20  lf.truth_value, 
+00014c00: 626f 6f6c 2873 656c 6629 2069 7320 6e6f  bool(self) is no
+00014c10: 7420 7468 6520 7361 6d65 210a 2020 2020  t the same!.    
+00014c20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00014c30: 7365 6c66 2e63 6f6c 6c65 6374 696f 6e20  self.collection 
+00014c40: 3d20 636f 6c6c 6563 7469 6f6e 0a20 2020  = collection.   
+00014c50: 2020 2020 2069 6620 7472 7574 685f 7661       if truth_va
+00014c60: 6c75 6520 6973 204e 6f6e 653a 0a20 2020  lue is None:.   
+00014c70: 2020 2020 2020 2020 2074 7275 7468 5f76           truth_v
+00014c80: 616c 7565 203d 2062 6f6f 6c28 7365 6c66  alue = bool(self
+00014c90: 2e63 6f6c 6c65 6374 696f 6e29 0a20 2020  .collection).   
+00014ca0: 2020 2020 2073 656c 662e 7472 7574 685f       self.truth_
+00014cb0: 7661 6c75 6520 3d20 7472 7574 685f 7661  value = truth_va
+00014cc0: 6c75 650a 2020 2020 2020 2020 7365 6c66  lue.        self
+00014cd0: 2e67 6f74 5f69 7465 6d73 203d 2073 6574  .got_items = set
+00014ce0: 2829 0a0a 2020 2020 6465 6620 5f5f 7265  ()..    def __re
+00014cf0: 7072 5f5f 2873 656c 6629 3a0a 2020 2020  pr__(self):.    
+00014d00: 2020 2020 7265 7475 726e 2022 2573 2825      return "%s(%
+00014d10: 722c 2074 7275 7468 5f76 616c 7565 3d25  r, truth_value=%
+00014d20: 7229 2220 2520 2873 656c 662e 5f5f 636c  r)" % (self.__cl
+00014d30: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 2c20  ass__.__name__, 
+00014d40: 7365 6c66 2e63 6f6c 6c65 6374 696f 6e2c  self.collection,
+00014d50: 2073 656c 662e 7472 7574 685f 7661 6c75   self.truth_valu
+00014d60: 6529 0a0a 2020 2020 4063 6c61 7373 6d65  e)..    @classme
+00014d70: 7468 6f64 0a20 2020 2064 6566 2066 726f  thod.    def fro
+00014d80: 6d5f 626f 6f6c 5f6f 725f 6469 6374 2863  m_bool_or_dict(c
+00014d90: 6c73 2c20 7661 6c75 653a 2055 6e69 6f6e  ls, value: Union
+00014da0: 5b62 6f6f 6c2c 2044 6963 745b 7374 722c  [bool, Dict[str,
+00014db0: 2041 6e79 5d5d 2920 2d3e 2043 6f6c 6c65   Any]]) -> Colle
+00014dc0: 6374 696f 6e52 6561 6443 6865 636b 436f  ctionReadCheckCo
+00014dd0: 7665 7265 643a 0a20 2020 2020 2020 2022  vered:.        "
+00014de0: 2222 0a20 2020 2020 2020 203a 7061 7261  "".        :para
+00014df0: 6d20 7661 6c75 653a 0a20 2020 2020 2020  m value:.       
+00014e00: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00014e10: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+00014e20: 2c20 626f 6f6c 293a 0a20 2020 2020 2020  , bool):.       
+00014e30: 2020 2020 2072 6574 7572 6e20 636c 7328       return cls(
+00014e40: 636f 6c6c 6563 7469 6f6e 3d7b 7d2c 2074  collection={}, t
+00014e50: 7275 7468 5f76 616c 7565 3d76 616c 7565  ruth_value=value
+00014e60: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+00014e70: 6e73 7461 6e63 6528 7661 6c75 652c 2064  nstance(value, d
+00014e80: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
+00014e90: 2020 7265 7475 726e 2063 6c73 2863 6f6c    return cls(col
+00014ea0: 6c65 6374 696f 6e3d 7661 6c75 6529 0a20  lection=value). 
+00014eb0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
+00014ec0: 6545 7272 6f72 2822 696e 7661 6c69 6420  eError("invalid 
+00014ed0: 7479 7065 3a20 2573 2220 2520 7479 7065  type: %s" % type
+00014ee0: 2876 616c 7565 2929 0a0a 2020 2020 6465  (value))..    de
+00014ef0: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
+00014f00: 6c66 2c20 6974 656d 293a 0a20 2020 2020  lf, item):.     
+00014f10: 2020 2072 6573 203d 2073 656c 662e 636f     res = self.co
+00014f20: 6c6c 6563 7469 6f6e 5b69 7465 6d5d 0a20  llection[item]. 
+00014f30: 2020 2020 2020 2073 656c 662e 676f 745f         self.got_
+00014f40: 6974 656d 732e 6164 6428 6974 656d 290a  items.add(item).
+00014f50: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00014f60: 6573 0a0a 2020 2020 6465 6620 6765 7428  es..    def get(
+00014f70: 7365 6c66 2c20 6974 656d 2c20 6465 6661  self, item, defa
+00014f80: 756c 743d 4e6f 6e65 293a 0a20 2020 2020  ult=None):.     
+00014f90: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
+00014fa0: 7061 7261 6d20 7374 7220 6974 656d 3a0a  param str item:.
+00014fb0: 2020 2020 2020 2020 3a70 6172 616d 2054          :param T
+00014fc0: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+00014fd0: 2020 3a72 7479 7065 3a20 547c 7479 7069    :rtype: T|typi
+00014fe0: 6e67 2e41 6e79 7c4e 6f6e 650a 2020 2020  ng.Any|None.    
+00014ff0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00015000: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00015010: 2072 6574 7572 6e20 7365 6c66 5b69 7465   return self[ite
+00015020: 6d5d 0a20 2020 2020 2020 2065 7863 6570  m].        excep
+00015030: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+00015040: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00015050: 6566 6175 6c74 0a0a 2020 2020 6465 6620  efault..    def 
+00015060: 5f5f 626f 6f6c 5f5f 2873 656c 6629 202d  __bool__(self) -
+00015070: 3e20 626f 6f6c 3a20 2023 2050 7974 686f  > bool:  # Pytho
+00015080: 6e20 330a 2020 2020 2020 2020 7265 7475  n 3.        retu
+00015090: 726e 2073 656c 662e 7472 7574 685f 7661  rn self.truth_va
+000150a0: 6c75 650a 0a20 2020 205f 5f6e 6f6e 7a65  lue..    __nonze
+000150b0: 726f 5f5f 203d 205f 5f62 6f6f 6c5f 5f20  ro__ = __bool__ 
+000150c0: 2023 2050 7974 686f 6e20 320a 0a20 2020   # Python 2..   
+000150d0: 2064 6566 205f 5f6c 656e 5f5f 2873 656c   def __len__(sel
+000150e0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+000150f0: 726e 206c 656e 2873 656c 662e 636f 6c6c  rn len(self.coll
+00015100: 6563 7469 6f6e 290a 0a20 2020 2064 6566  ection)..    def
+00015110: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
+00015120: 0a20 2020 2020 2020 2066 6f72 206b 2069  .        for k i
+00015130: 6e20 7365 6c66 2e63 6f6c 6c65 6374 696f  n self.collectio
+00015140: 6e3a 0a20 2020 2020 2020 2020 2020 2079  n:.            y
+00015150: 6965 6c64 2073 656c 665b 6b5d 0a0a 2020  ield self[k]..  
+00015160: 2020 6465 6620 6173 7365 7274 5f61 6c6c    def assert_all
+00015170: 5f72 6561 6428 7365 6c66 293a 0a20 2020  _read(self):.   
+00015180: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00015190: 2041 7373 6572 7473 2074 6861 7420 616c   Asserts that al
+000151a0: 6c20 6974 656d 7320 6861 7665 2062 6565  l items have bee
+000151b0: 6e20 7265 6164 2e0a 2020 2020 2020 2020  n read..        
+000151c0: 2222 220a 2020 2020 2020 2020 7265 6d61  """.        rema
+000151d0: 696e 696e 6720 3d20 7365 7428 7365 6c66  ining = set(self
+000151e0: 2e63 6f6c 6c65 6374 696f 6e29 2e64 6966  .collection).dif
+000151f0: 6665 7265 6e63 6528 7365 6c66 2e67 6f74  ference(self.got
+00015200: 5f69 7465 6d73 290a 2020 2020 2020 2020  _items).        
+00015210: 6173 7365 7274 206e 6f74 2072 656d 6169  assert not remai
+00015220: 6e69 6e67 2c20 2254 6865 206b 6579 7320  ning, "The keys 
+00015230: 2572 2077 6572 6520 6e6f 7420 7265 6164  %r were not read
+00015240: 2069 6e20 7468 6520 636f 6c6c 6563 7469   in the collecti
+00015250: 6f6e 2025 722e 2220 2520 2872 656d 6169  on %r." % (remai
+00015260: 6e69 6e67 2c20 7365 6c66 2e63 6f6c 6c65  ning, self.colle
+00015270: 6374 696f 6e29 0a0a 0a64 6566 2077 6869  ction)...def whi
+00015280: 6368 2870 726f 6772 616d 3a20 7374 7229  ch(program: str)
+00015290: 202d 3e20 4f70 7469 6f6e 616c 5b73 7472   -> Optional[str
+000152a0: 5d3a 0a20 2020 2022 2222 0a20 2020 2046  ]:.    """.    F
+000152b0: 696e 6473 2060 7072 6f67 7261 6d60 2069  inds `program` i
+000152c0: 6e20 736f 6d65 206f 6620 7468 6520 6469  n some of the di
+000152d0: 7273 206f 6620 7468 6520 5041 5448 2065  rs of the PATH e
+000152e0: 6e76 2076 6172 2e0a 0a20 2020 203a 7061  nv var...    :pa
+000152f0: 7261 6d20 7072 6f67 7261 6d3a 2065 2e67  ram program: e.g
+00015300: 2e20 2270 7974 686f 6e22 0a20 2020 203a  . "python".    :
+00015310: 7265 7475 726e 3a20 6675 6c6c 2070 6174  return: full pat
+00015320: 682c 2065 2e67 2e20 222f 7573 722f 6269  h, e.g. "/usr/bi
+00015330: 6e2f 7079 7468 6f6e 222c 206f 7220 4e6f  n/python", or No
+00015340: 6e65 0a20 2020 2022 2222 0a0a 2020 2020  ne.    """..    
+00015350: 2320 6e6f 696e 7370 6563 7469 6f6e 2050  # noinspection P
+00015360: 7953 6861 646f 7769 6e67 4e61 6d65 730a  yShadowingNames.
+00015370: 2020 2020 6465 6620 6973 5f65 7865 2870      def is_exe(p
+00015380: 6174 6829 3a0a 2020 2020 2020 2020 2222  ath):.        ""
+00015390: 220a 2020 2020 2020 2020 3a70 6172 616d  ".        :param
+000153a0: 2073 7472 2070 6174 683a 0a20 2020 2020   str path:.     
+000153b0: 2020 203a 7274 7970 653a 2073 7472 0a20     :rtype: str. 
+000153c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000153d0: 2020 2072 6574 7572 6e20 6f73 2e70 6174     return os.pat
+000153e0: 682e 6973 6669 6c65 2870 6174 6829 2061  h.isfile(path) a
+000153f0: 6e64 206f 732e 6163 6365 7373 2870 6174  nd os.access(pat
+00015400: 682c 206f 732e 585f 4f4b 290a 0a20 2020  h, os.X_OK)..   
+00015410: 2066 7061 7468 2c20 666e 616d 6520 3d20   fpath, fname = 
+00015420: 6f73 2e70 6174 682e 7370 6c69 7428 7072  os.path.split(pr
+00015430: 6f67 7261 6d29 0a20 2020 2069 6620 6670  ogram).    if fp
+00015440: 6174 683a 0a20 2020 2020 2020 2069 6620  ath:.        if 
+00015450: 6973 5f65 7865 2870 726f 6772 616d 293a  is_exe(program):
+00015460: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00015470: 7572 6e20 7072 6f67 7261 6d0a 2020 2020  urn program.    
+00015480: 656c 7365 3a0a 2020 2020 2020 2020 666f  else:.        fo
+00015490: 7220 7061 7468 2069 6e20 6f73 2e65 6e76  r path in os.env
+000154a0: 6972 6f6e 5b22 5041 5448 225d 2e73 706c  iron["PATH"].spl
+000154b0: 6974 286f 732e 7061 7468 7365 7029 3a0a  it(os.pathsep):.
+000154c0: 2020 2020 2020 2020 2020 2020 7061 7468              path
+000154d0: 203d 2070 6174 682e 7374 7269 7028 2722   = path.strip('"
+000154e0: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
+000154f0: 7865 5f66 696c 6520 3d20 6f73 2e70 6174  xe_file = os.pat
+00015500: 682e 6a6f 696e 2870 6174 682c 2070 726f  h.join(path, pro
+00015510: 6772 616d 290a 2020 2020 2020 2020 2020  gram).          
+00015520: 2020 6966 2069 735f 6578 6528 6578 655f    if is_exe(exe_
+00015530: 6669 6c65 293a 0a20 2020 2020 2020 2020  file):.         
+00015540: 2020 2020 2020 2072 6574 7572 6e20 6578         return ex
+00015550: 655f 6669 6c65 0a0a 2020 2020 7265 7475  e_file..    retu
+00015560: 726e 204e 6f6e 650a 0a0a 6465 6620 7768  rn None...def wh
+00015570: 6963 685f 7069 7028 293a 0a20 2020 2022  ich_pip():.    "
+00015580: 2222 0a20 2020 203a 7274 7970 653a 2073  "".    :rtype: s
+00015590: 7472 0a20 2020 203a 7265 7475 726e 3a20  tr.    :return: 
+000155a0: 7061 7468 2074 6f20 7069 7020 666f 7220  path to pip for 
+000155b0: 7468 6520 6375 7272 656e 7420 5079 7468  the current Pyth
+000155c0: 6f6e 2065 6e76 0a20 2020 2022 2222 0a20  on env.    """. 
+000155d0: 2020 2023 2042 6566 6f72 6520 7765 206c     # Before we l
+000155e0: 6f6f 6b20 616e 7977 6865 7265 2069 6e20  ook anywhere in 
+000155f0: 5041 5448 2c20 6368 6563 6b20 6966 2074  PATH, check if t
+00015600: 6865 7265 2069 7320 736f 6d65 2070 6970  here is some pip
+00015610: 2061 6c6f 6e67 7369 6465 2074 6f20 7468   alongside to th
+00015620: 6520 5079 7468 6f6e 2065 7865 6375 7461  e Python executa
+00015630: 626c 652e 0a20 2020 2023 2054 6869 7320  ble..    # This 
+00015640: 6d69 6768 7420 6265 206d 6f72 6520 7265  might be more re
+00015650: 6c69 6162 6c65 2e0a 2020 2020 7079 203d  liable..    py =
+00015660: 2073 7973 2e65 7865 6375 7461 626c 650a   sys.executable.
+00015670: 2020 2020 6469 725f 6e61 6d65 2c20 6261      dir_name, ba
+00015680: 7365 6e61 6d65 203d 2070 792e 7273 706c  sename = py.rspl
+00015690: 6974 2822 2f22 2c20 3129 0a20 2020 2069  it("/", 1).    i
+000156a0: 6620 6261 7365 6e61 6d65 2e73 7461 7274  f basename.start
+000156b0: 7377 6974 6828 2270 7974 686f 6e22 293a  swith("python"):
+000156c0: 0a20 2020 2020 2020 2070 6f73 7466 6978  .        postfix
+000156d0: 203d 2062 6173 656e 616d 655b 6c65 6e28   = basename[len(
+000156e0: 2270 7974 686f 6e22 2920 3a5d 0a20 2020  "python") :].   
+000156f0: 2020 2020 2070 6970 5f70 6174 6820 3d20       pip_path = 
+00015700: 2225 732f 7069 7025 7322 2025 2028 6469  "%s/pip%s" % (di
+00015710: 725f 6e61 6d65 2c20 706f 7374 6669 7829  r_name, postfix)
+00015720: 0a20 2020 2020 2020 2069 6620 6f73 2e70  .        if os.p
+00015730: 6174 682e 6578 6973 7473 2870 6970 5f70  ath.exists(pip_p
+00015740: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00015750: 2020 7265 7475 726e 2070 6970 5f70 6174    return pip_pat
+00015760: 680a 2020 2020 2320 4765 6e65 7269 6320  h.    # Generic 
+00015770: 6661 6c6c 6261 636b 2e0a 2020 2020 7069  fallback..    pi
+00015780: 705f 7061 7468 203d 2077 6869 6368 2822  p_path = which("
+00015790: 7069 7022 290a 2020 2020 7265 7475 726e  pip").    return
+000157a0: 2070 6970 5f70 6174 680a 0a0a 6465 6620   pip_path...def 
+000157b0: 7069 705f 696e 7374 616c 6c28 2a70 6b67  pip_install(*pkg
+000157c0: 5f6e 616d 6573 293a 0a20 2020 2022 2222  _names):.    """
+000157d0: 0a20 2020 2049 6e73 7461 6c6c 2070 6163  .    Install pac
+000157e0: 6b61 6765 7320 7669 6120 7069 7020 666f  kages via pip fo
+000157f0: 7220 7468 6520 6375 7272 656e 7420 5079  r the current Py
+00015800: 7468 6f6e 2065 6e76 2e0a 0a20 2020 203a  thon env...    :
+00015810: 7061 7261 6d20 7374 7220 706b 675f 6e61  param str pkg_na
+00015820: 6d65 733a 0a20 2020 2022 2222 0a20 2020  mes:.    """.   
+00015830: 2070 7920 3d20 7379 732e 6578 6563 7574   py = sys.execut
+00015840: 6162 6c65 0a20 2020 2070 6970 5f70 6174  able.    pip_pat
+00015850: 6820 3d20 7768 6963 685f 7069 7028 290a  h = which_pip().
+00015860: 2020 2020 7072 696e 7428 2250 6970 2069      print("Pip i
+00015870: 6e73 7461 6c6c 222c 202a 706b 675f 6e61  nstall", *pkg_na
+00015880: 6d65 7329 0a20 2020 2069 6e5f 7669 7274  mes).    in_virt
+00015890: 7561 6c5f 656e 7620 3d20 6861 7361 7474  ual_env = hasatt
+000158a0: 7228 7379 732c 2022 7265 616c 5f70 7265  r(sys, "real_pre
+000158b0: 6669 7822 2920 2023 2068 7474 7073 3a2f  fix")  # https:/
+000158c0: 2f73 7461 636b 6f76 6572 666c 6f77 2e63  /stackoverflow.c
+000158d0: 6f6d 2f71 7565 7374 696f 6e73 2f31 3837  om/questions/187
+000158e0: 3135 3439 2f0a 2020 2020 636d 6420 3d20  1549/.    cmd = 
+000158f0: 5b70 792c 2070 6970 5f70 6174 682c 2022  [py, pip_path, "
+00015900: 696e 7374 616c 6c22 5d0a 2020 2020 6966  install"].    if
+00015910: 206e 6f74 2069 6e5f 7669 7274 7561 6c5f   not in_virtual_
+00015920: 656e 763a 0a20 2020 2020 2020 2063 6d64  env:.        cmd
+00015930: 202b 3d20 5b22 2d2d 7573 6572 225d 0a20   += ["--user"]. 
+00015940: 2020 2063 6d64 202b 3d20 6c69 7374 2870     cmd += list(p
+00015950: 6b67 5f6e 616d 6573 290a 2020 2020 7072  kg_names).    pr
+00015960: 696e 7428 2224 2025 7322 2025 2022 2022  int("$ %s" % " "
+00015970: 2e6a 6f69 6e28 636d 6429 290a 2020 2020  .join(cmd)).    
+00015980: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+00015990: 5f63 616c 6c28 636d 642c 2063 7764 3d22  _call(cmd, cwd="
+000159a0: 2f22 290a 2020 2020 5f70 6970 5f69 6e73  /").    _pip_ins
+000159b0: 7461 6c6c 6564 5f70 6163 6b61 6765 732e  talled_packages.
+000159c0: 636c 6561 7228 2920 2023 2066 6f72 6365  clear()  # force
+000159d0: 2072 656c 6f61 640a 0a0a 5f70 6970 5f69   reload..._pip_i
+000159e0: 6e73 7461 6c6c 6564 5f70 6163 6b61 6765  nstalled_package
+000159f0: 7320 3d20 7365 7428 290a 0a0a 6465 6620  s = set()...def 
+00015a00: 7069 705f 6368 6563 6b5f 6973 5f69 6e73  pip_check_is_ins
+00015a10: 7461 6c6c 6564 2870 6b67 5f6e 616d 6529  talled(pkg_name)
+00015a20: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
+00015a30: 6172 616d 2073 7472 2070 6b67 5f6e 616d  aram str pkg_nam
+00015a40: 653a 2077 6974 686f 7574 2076 6572 7369  e: without versi
+00015a50: 6f6e 2c20 652e 672e 206a 7573 7420 2274  on, e.g. just "t
+00015a60: 656e 736f 7266 6c6f 7722 2c20 6f72 2077  ensorflow", or w
+00015a70: 6974 6820 7665 7273 696f 6e2c 2065 2e67  ith version, e.g
+00015a80: 2e20 2274 656e 736f 7266 6c6f 773d 3d31  . "tensorflow==1
+00015a90: 2e32 2e33 220a 2020 2020 3a72 7479 7065  .2.3".    :rtype
+00015aa0: 3a20 626f 6f6c 0a20 2020 2022 2222 0a20  : bool.    """. 
+00015ab0: 2020 2069 6620 6e6f 7420 5f70 6970 5f69     if not _pip_i
+00015ac0: 6e73 7461 6c6c 6564 5f70 6163 6b61 6765  nstalled_package
+00015ad0: 733a 0a20 2020 2020 2020 2070 7920 3d20  s:.        py = 
+00015ae0: 7379 732e 6578 6563 7574 6162 6c65 0a20  sys.executable. 
+00015af0: 2020 2020 2020 2070 6970 5f70 6174 6820         pip_path 
+00015b00: 3d20 7768 6963 685f 7069 7028 290a 2020  = which_pip().  
+00015b10: 2020 2020 2020 636d 6420 3d20 5b70 792c        cmd = [py,
+00015b20: 2070 6970 5f70 6174 682c 2022 6672 6565   pip_path, "free
+00015b30: 7a65 225d 0a20 2020 2020 2020 2066 6f72  ze"].        for
+00015b40: 206c 696e 6520 696e 2073 7973 5f65 7865   line in sys_exe
+00015b50: 635f 6f75 7428 2a63 6d64 292e 7370 6c69  c_out(*cmd).spli
+00015b60: 746c 696e 6573 2829 3a0a 2020 2020 2020  tlines():.      
+00015b70: 2020 2020 2020 6966 206c 696e 6520 616e        if line an
+00015b80: 6420 223d 3d22 2069 6e20 6c69 6e65 3a0a  d "==" in line:.
+00015b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ba0: 6966 2022 3d3d 2220 6e6f 7420 696e 2070  if "==" not in p
+00015bb0: 6b67 5f6e 616d 653a 0a20 2020 2020 2020  kg_name:.       
+00015bc0: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+00015bd0: 6520 3d20 6c69 6e65 5b3a 206c 696e 652e  e = line[: line.
+00015be0: 696e 6465 7828 223d 3d22 295d 0a20 2020  index("==")].   
+00015bf0: 2020 2020 2020 2020 2020 2020 205f 7069               _pi
+00015c00: 705f 696e 7374 616c 6c65 645f 7061 636b  p_installed_pack
+00015c10: 6167 6573 2e61 6464 286c 696e 6529 0a20  ages.add(line). 
+00015c20: 2020 2072 6574 7572 6e20 706b 675f 6e61     return pkg_na
+00015c30: 6d65 2069 6e20 5f70 6970 5f69 6e73 7461  me in _pip_insta
+00015c40: 6c6c 6564 5f70 6163 6b61 6765 730a 0a0a  lled_packages...
+00015c50: 5f6f 7269 6769 6e61 6c5f 6578 6563 7620  _original_execv 
+00015c60: 3d20 4e6f 6e65 0a5f 6f72 6967 696e 616c  = None._original
+00015c70: 5f65 7865 6376 6520 3d20 4e6f 6e65 0a5f  _execve = None._
+00015c80: 6f72 6967 696e 616c 5f65 7865 6376 7065  original_execvpe
+00015c90: 203d 204e 6f6e 650a 0a0a 6465 6620 6f76   = None...def ov
+00015ca0: 6572 7772 6974 655f 6f73 5f65 7865 6328  erwrite_os_exec(
+00015cb0: 7072 6566 6978 5f61 7267 7329 3a0a 2020  prefix_args):.  
+00015cc0: 2020 2222 220a 2020 2020 3a70 6172 616d    """.    :param
+00015cd0: 206c 6973 745b 7374 725d 2070 7265 6669   list[str] prefi
+00015ce0: 785f 6172 6773 3a0a 2020 2020 2222 220a  x_args:.    """.
+00015cf0: 2020 2020 676c 6f62 616c 205f 6f72 6967      global _orig
+00015d00: 696e 616c 5f65 7865 6376 2c20 5f6f 7269  inal_execv, _ori
+00015d10: 6769 6e61 6c5f 6578 6563 7665 2c20 5f6f  ginal_execve, _o
+00015d20: 7269 6769 6e61 6c5f 6578 6563 7670 650a  riginal_execvpe.
+00015d30: 2020 2020 6966 206e 6f74 205f 6f72 6967      if not _orig
+00015d40: 696e 616c 5f65 7865 6376 3a0a 2020 2020  inal_execv:.    
+00015d50: 2020 2020 5f6f 7269 6769 6e61 6c5f 6578      _original_ex
+00015d60: 6563 7620 3d20 6f73 2e65 7865 6376 0a20  ecv = os.execv. 
+00015d70: 2020 2069 6620 6e6f 7420 5f6f 7269 6769     if not _origi
+00015d80: 6e61 6c5f 6578 6563 7665 3a0a 2020 2020  nal_execve:.    
+00015d90: 2020 2020 5f6f 7269 6769 6e61 6c5f 6578      _original_ex
+00015da0: 6563 7665 203d 206f 732e 6578 6563 7665  ecve = os.execve
+00015db0: 0a20 2020 2069 6620 6e6f 7420 5f6f 7269  .    if not _ori
+00015dc0: 6769 6e61 6c5f 6578 6563 7670 653a 0a20  ginal_execvpe:. 
+00015dd0: 2020 2020 2020 2023 206e 6f69 6e73 7065         # noinspe
+00015de0: 6374 696f 6e20 5079 5072 6f74 6563 7465  ction PyProtecte
+00015df0: 644d 656d 6265 722c 5079 556e 7265 736f  dMember,PyUnreso
+00015e00: 6c76 6564 5265 6665 7265 6e63 6573 0a20  lvedReferences. 
+00015e10: 2020 2020 2020 205f 6f72 6967 696e 616c         _original
+00015e20: 5f65 7865 6376 7065 203d 206f 732e 5f65  _execvpe = os._e
+00015e30: 7865 6376 7065 0a0a 2020 2020 2320 6e6f  xecvpe..    # no
+00015e40: 696e 7370 6563 7469 6f6e 2050 7955 6e75  inspection PyUnu
+00015e50: 7365 644c 6f63 616c 0a20 2020 2064 6566  sedLocal.    def
+00015e60: 2077 7261 7070 6564 5f65 7865 6376 7065   wrapped_execvpe
+00015e70: 2866 696c 652c 2061 7267 732c 2065 6e76  (file, args, env
+00015e80: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
+00015e90: 2222 220a 2020 2020 2020 2020 3a70 6172  """.        :par
+00015ea0: 616d 2066 696c 653a 0a20 2020 2020 2020  am file:.       
+00015eb0: 203a 7061 7261 6d20 6c69 7374 5b73 7472   :param list[str
+00015ec0: 5d7c 7475 706c 655b 7374 725d 2061 7267  ]|tuple[str] arg
+00015ed0: 733a 0a20 2020 2020 2020 203a 7061 7261  s:.        :para
+00015ee0: 6d20 6469 6374 5b73 7472 5d20 656e 763a  m dict[str] env:
+00015ef0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00015f00: 2020 2020 206e 6577 5f61 7267 7320 3d20       new_args = 
+00015f10: 7072 6566 6978 5f61 7267 7320 2b20 5b77  prefix_args + [w
+00015f20: 6869 6368 2861 7267 735b 305d 295d 202b  hich(args[0])] +
+00015f30: 2061 7267 735b 313a 5d0a 2020 2020 2020   args[1:].      
+00015f40: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+00015f50: 7465 2822 2420 2573 5c6e 2220 2520 2220  te("$ %s\n" % " 
+00015f60: 222e 6a6f 696e 286e 6577 5f61 7267 7329  ".join(new_args)
+00015f70: 290a 2020 2020 2020 2020 7379 732e 7374  ).        sys.st
+00015f80: 6465 7272 2e66 6c75 7368 2829 0a20 2020  derr.flush().   
+00015f90: 2020 2020 205f 6f72 6967 696e 616c 5f65       _original_e
+00015fa0: 7865 6376 7065 2866 696c 653d 7072 6566  xecvpe(file=pref
+00015fb0: 6978 5f61 7267 735b 305d 2c20 6172 6773  ix_args[0], args
+00015fc0: 3d6e 6577 5f61 7267 732c 2065 6e76 3d65  =new_args, env=e
+00015fd0: 6e76 290a 0a20 2020 2064 6566 2065 7865  nv)..    def exe
+00015fe0: 6376 2870 6174 682c 2061 7267 7329 3a0a  cv(path, args):.
+00015ff0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00016000: 2020 2020 3a70 6172 616d 2073 7472 2070      :param str p
+00016010: 6174 683a 0a20 2020 2020 2020 203a 7061  ath:.        :pa
+00016020: 7261 6d20 6c69 7374 5b73 7472 5d7c 7475  ram list[str]|tu
+00016030: 706c 655b 7374 725d 2061 7267 733a 0a20  ple[str] args:. 
+00016040: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00016050: 2020 2069 6620 6172 6773 5b3a 206c 656e     if args[: len
+00016060: 2870 7265 6669 785f 6172 6773 295d 203d  (prefix_args)] =
+00016070: 3d20 7072 6566 6978 5f61 7267 733a 0a20  = prefix_args:. 
+00016080: 2020 2020 2020 2020 2020 205f 6f72 6967             _orig
+00016090: 696e 616c 5f65 7865 6376 2870 6174 682c  inal_execv(path,
+000160a0: 2061 7267 7329 0a20 2020 2020 2020 2065   args).        e
+000160b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000160c0: 2077 7261 7070 6564 5f65 7865 6376 7065   wrapped_execvpe
+000160d0: 2870 6174 682c 2061 7267 7329 0a0a 2020  (path, args)..  
+000160e0: 2020 6465 6620 6578 6563 7665 2870 6174    def execve(pat
+000160f0: 682c 2061 7267 732c 2065 6e76 293a 0a20  h, args, env):. 
+00016100: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00016110: 2020 203a 7061 7261 6d20 7374 7220 7061     :param str pa
+00016120: 7468 3a0a 2020 2020 2020 2020 3a70 6172  th:.        :par
+00016130: 616d 206c 6973 745b 7374 725d 7c74 7570  am list[str]|tup
+00016140: 6c65 5b73 7472 5d20 6172 6773 3a0a 2020  le[str] args:.  
+00016150: 2020 2020 2020 3a70 6172 616d 2064 6963        :param dic
+00016160: 745b 7374 725d 2065 6e76 3a0a 2020 2020  t[str] env:.    
+00016170: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00016180: 6966 2061 7267 735b 3a20 6c65 6e28 7072  if args[: len(pr
+00016190: 6566 6978 5f61 7267 7329 5d20 3d3d 2070  efix_args)] == p
+000161a0: 7265 6669 785f 6172 6773 3a0a 2020 2020  refix_args:.    
+000161b0: 2020 2020 2020 2020 5f6f 7269 6769 6e61          _origina
+000161c0: 6c5f 6578 6563 7665 2870 6174 682c 2061  l_execve(path, a
+000161d0: 7267 732c 2065 6e76 290a 2020 2020 2020  rgs, env).      
+000161e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000161f0: 2020 2020 7772 6170 7065 645f 6578 6563      wrapped_exec
+00016200: 7670 6528 7061 7468 2c20 6172 6773 2c20  vpe(path, args, 
+00016210: 656e 7629 0a0a 2020 2020 6465 6620 6578  env)..    def ex
+00016220: 6563 6c28 6669 6c65 2c20 2a61 7267 7329  ecl(file, *args)
+00016230: 3a0a 2020 2020 2020 2020 2222 2265 7865  :.        """exe
+00016240: 636c 2866 696c 652c 202a 6172 6773 290a  cl(file, *args).
+00016250: 0a20 2020 2020 2020 2045 7865 6375 7465  .        Execute
+00016260: 2074 6865 2065 7865 6375 7461 626c 6520   the executable 
+00016270: 6669 6c65 2077 6974 6820 6172 6775 6d65  file with argume
+00016280: 6e74 206c 6973 7420 6172 6773 2c20 7265  nt list args, re
+00016290: 706c 6163 696e 6720 7468 650a 2020 2020  placing the.    
+000162a0: 2020 2020 6375 7272 656e 7420 7072 6f63      current proc
+000162b0: 6573 732e 2222 220a 2020 2020 2020 2020  ess.""".        
+000162c0: 6f73 2e65 7865 6376 2866 696c 652c 2061  os.execv(file, a
+000162d0: 7267 7329 0a0a 2020 2020 6465 6620 6578  rgs)..    def ex
+000162e0: 6563 6c65 2866 696c 652c 202a 6172 6773  ecle(file, *args
+000162f0: 293a 0a20 2020 2020 2020 2022 2222 6578  ):.        """ex
+00016300: 6563 6c65 2866 696c 652c 202a 6172 6773  ecle(file, *args
+00016310: 2c20 656e 7629 0a0a 2020 2020 2020 2020  , env)..        
+00016320: 4578 6563 7574 6520 7468 6520 6578 6563  Execute the exec
+00016330: 7574 6162 6c65 2066 696c 6520 7769 7468  utable file with
+00016340: 2061 7267 756d 656e 7420 6c69 7374 2061   argument list a
+00016350: 7267 7320 616e 640a 2020 2020 2020 2020  rgs and.        
+00016360: 656e 7669 726f 6e6d 656e 7420 656e 762c  environment env,
+00016370: 2072 6570 6c61 6369 6e67 2074 6865 2063   replacing the c
+00016380: 7572 7265 6e74 2070 726f 6365 7373 2e22  urrent process."
+00016390: 2222 0a20 2020 2020 2020 2065 6e76 203d  "".        env =
+000163a0: 2061 7267 735b 2d31 5d0a 2020 2020 2020   args[-1].      
+000163b0: 2020 6f73 2e65 7865 6376 6528 6669 6c65    os.execve(file
+000163c0: 2c20 6172 6773 5b3a 2d31 5d2c 2065 6e76  , args[:-1], env
+000163d0: 290a 0a20 2020 2064 6566 2065 7865 636c  )..    def execl
+000163e0: 7028 6669 6c65 2c20 2a61 7267 7329 3a0a  p(file, *args):.
+000163f0: 2020 2020 2020 2020 2222 2265 7865 636c          """execl
+00016400: 7028 6669 6c65 2c20 2a61 7267 7329 0a0a  p(file, *args)..
+00016410: 2020 2020 2020 2020 4578 6563 7574 6520          Execute 
+00016420: 7468 6520 6578 6563 7574 6162 6c65 2066  the executable f
+00016430: 696c 6520 2877 6869 6368 2069 7320 7365  ile (which is se
+00016440: 6172 6368 6564 2066 6f72 2061 6c6f 6e67  arched for along
+00016450: 2024 5041 5448 290a 2020 2020 2020 2020   $PATH).        
+00016460: 7769 7468 2061 7267 756d 656e 7420 6c69  with argument li
+00016470: 7374 2061 7267 732c 2072 6570 6c61 6369  st args, replaci
+00016480: 6e67 2074 6865 2063 7572 7265 6e74 2070  ng the current p
+00016490: 726f 6365 7373 2e22 2222 0a20 2020 2020  rocess.""".     
+000164a0: 2020 206f 732e 6578 6563 7670 2866 696c     os.execvp(fil
+000164b0: 652c 2061 7267 7329 0a0a 2020 2020 6465  e, args)..    de
+000164c0: 6620 6578 6563 6c70 6528 6669 6c65 2c20  f execlpe(file, 
+000164d0: 2a61 7267 7329 3a0a 2020 2020 2020 2020  *args):.        
+000164e0: 2222 2265 7865 636c 7065 2866 696c 652c  """execlpe(file,
+000164f0: 202a 6172 6773 2c20 656e 7629 0a0a 2020   *args, env)..  
+00016500: 2020 2020 2020 4578 6563 7574 6520 7468        Execute th
+00016510: 6520 6578 6563 7574 6162 6c65 2066 696c  e executable fil
+00016520: 6520 2877 6869 6368 2069 7320 7365 6172  e (which is sear
+00016530: 6368 6564 2066 6f72 2061 6c6f 6e67 2024  ched for along $
+00016540: 5041 5448 290a 2020 2020 2020 2020 7769  PATH).        wi
+00016550: 7468 2061 7267 756d 656e 7420 6c69 7374  th argument list
+00016560: 2061 7267 7320 616e 6420 656e 7669 726f   args and enviro
+00016570: 6e6d 656e 7420 656e 762c 2072 6570 6c61  nment env, repla
+00016580: 6369 6e67 2074 6865 2063 7572 7265 6e74  cing the current
+00016590: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+000165a0: 2e22 2222 0a20 2020 2020 2020 2065 6e76  .""".        env
+000165b0: 203d 2061 7267 735b 2d31 5d0a 2020 2020   = args[-1].    
+000165c0: 2020 2020 6f73 2e65 7865 6376 7065 2866      os.execvpe(f
+000165d0: 696c 652c 2061 7267 735b 3a2d 315d 2c20  ile, args[:-1], 
+000165e0: 656e 7629 0a0a 2020 2020 6465 6620 6578  env)..    def ex
+000165f0: 6563 7670 2866 696c 652c 2061 7267 7329  ecvp(file, args)
+00016600: 3a0a 2020 2020 2020 2020 2222 2265 7865  :.        """exe
+00016610: 6376 7028 6669 6c65 2c20 6172 6773 290a  cvp(file, args).
+00016620: 0a20 2020 2020 2020 2045 7865 6375 7465  .        Execute
+00016630: 2074 6865 2065 7865 6375 7461 626c 6520   the executable 
+00016640: 6669 6c65 2028 7768 6963 6820 6973 2073  file (which is s
+00016650: 6561 7263 6865 6420 666f 7220 616c 6f6e  earched for alon
+00016660: 6720 2450 4154 4829 0a20 2020 2020 2020  g $PATH).       
+00016670: 2077 6974 6820 6172 6775 6d65 6e74 206c   with argument l
+00016680: 6973 7420 6172 6773 2c20 7265 706c 6163  ist args, replac
+00016690: 696e 6720 7468 6520 6375 7272 656e 7420  ing the current 
+000166a0: 7072 6f63 6573 732e 0a20 2020 2020 2020  process..       
+000166b0: 2061 7267 7320 6d61 7920 6265 2061 206c   args may be a l
+000166c0: 6973 7420 6f72 2074 7570 6c65 206f 6620  ist or tuple of 
+000166d0: 7374 7269 6e67 732e 2222 220a 2020 2020  strings.""".    
+000166e0: 2020 2020 7772 6170 7065 645f 6578 6563      wrapped_exec
+000166f0: 7670 6528 6669 6c65 2c20 6172 6773 290a  vpe(file, args).
+00016700: 0a20 2020 2064 6566 2065 7865 6376 7065  .    def execvpe
+00016710: 2866 696c 652c 2061 7267 732c 2065 6e76  (file, args, env
+00016720: 293a 0a20 2020 2020 2020 2022 2222 6578  ):.        """ex
+00016730: 6563 7670 6528 6669 6c65 2c20 6172 6773  ecvpe(file, args
+00016740: 2c20 656e 7629 0a0a 2020 2020 2020 2020  , env)..        
+00016750: 4578 6563 7574 6520 7468 6520 6578 6563  Execute the exec
+00016760: 7574 6162 6c65 2066 696c 6520 2877 6869  utable file (whi
+00016770: 6368 2069 7320 7365 6172 6368 6564 2066  ch is searched f
+00016780: 6f72 2061 6c6f 6e67 2024 5041 5448 290a  or along $PATH).
+00016790: 2020 2020 2020 2020 7769 7468 2061 7267          with arg
+000167a0: 756d 656e 7420 6c69 7374 2061 7267 7320  ument list args 
+000167b0: 616e 6420 656e 7669 726f 6e6d 656e 7420  and environment 
+000167c0: 656e 7620 2c20 7265 706c 6163 696e 6720  env , replacing 
+000167d0: 7468 650a 2020 2020 2020 2020 6375 7272  the.        curr
+000167e0: 656e 7420 7072 6f63 6573 732e 0a20 2020  ent process..   
+000167f0: 2020 2020 2061 7267 7320 6d61 7920 6265       args may be
+00016800: 2061 206c 6973 7420 6f72 2074 7570 6c65   a list or tuple
+00016810: 206f 6620 7374 7269 6e67 732e 2222 220a   of strings.""".
+00016820: 2020 2020 2020 2020 7772 6170 7065 645f          wrapped_
+00016830: 6578 6563 7670 6528 6669 6c65 2c20 6172  execvpe(file, ar
+00016840: 6773 2c20 656e 7629 0a0a 2020 2020 6f73  gs, env)..    os
+00016850: 2e65 7865 6376 203d 2065 7865 6376 0a20  .execv = execv. 
+00016860: 2020 206f 732e 6578 6563 7665 203d 2065     os.execve = e
+00016870: 7865 6376 650a 2020 2020 6f73 2e65 7865  xecve.    os.exe
+00016880: 636c 203d 2065 7865 636c 0a20 2020 206f  cl = execl.    o
+00016890: 732e 6578 6563 6c65 203d 2065 7865 636c  s.execle = execl
+000168a0: 650a 2020 2020 6f73 2e65 7865 636c 7020  e.    os.execlp 
+000168b0: 3d20 6578 6563 6c70 0a20 2020 206f 732e  = execlp.    os.
+000168c0: 6578 6563 6c70 6520 3d20 6578 6563 6c70  execlpe = execlp
+000168d0: 650a 2020 2020 6f73 2e65 7865 6376 7020  e.    os.execvp 
+000168e0: 3d20 6578 6563 7670 0a20 2020 206f 732e  = execvp.    os.
+000168f0: 6578 6563 7670 6520 3d20 6578 6563 7670  execvpe = execvp
+00016900: 650a 2020 2020 6f73 2e5f 6578 6563 7670  e.    os._execvp
+00016910: 6520 3d20 7772 6170 7065 645f 6578 6563  e = wrapped_exec
+00016920: 7670 650a 0a0a 6465 6620 6765 745f 6c73  vpe...def get_ls
+00016930: 625f 7265 6c65 6173 6528 293a 0a20 2020  b_release():.   
+00016940: 2022 2222 0a20 2020 203a 7265 7475 726e   """.    :return
+00016950: 3a20 6060 2f65 7463 2f6c 7362 2d72 656c  : ``/etc/lsb-rel
+00016960: 6561 7365 6060 2070 6172 7365 6420 6173  ease`` parsed as
+00016970: 2061 2064 6963 740a 2020 2020 3a72 7479   a dict.    :rty
+00016980: 7065 3a20 6469 6374 5b73 7472 2c73 7472  pe: dict[str,str
+00016990: 5d0a 2020 2020 2222 220a 2020 2020 6420  ].    """.    d 
+000169a0: 3d20 7b7d 0a20 2020 2066 6f72 206c 696e  = {}.    for lin
+000169b0: 6520 696e 206f 7065 6e28 222f 6574 632f  e in open("/etc/
+000169c0: 6c73 622d 7265 6c65 6173 6522 292e 7265  lsb-release").re
+000169d0: 6164 2829 2e73 706c 6974 6c69 6e65 7328  ad().splitlines(
+000169e0: 293a 0a20 2020 2020 2020 206b 2c20 7620  ):.        k, v 
+000169f0: 3d20 6c69 6e65 2e73 706c 6974 2822 3d22  = line.split("="
+00016a00: 2c20 3129 0a20 2020 2020 2020 2069 6620  , 1).        if 
+00016a10: 765b 305d 203d 3d20 765b 2d31 5d20 3d3d  v[0] == v[-1] ==
+00016a20: 2027 2227 3a0a 2020 2020 2020 2020 2020   '"':.          
+00016a30: 2020 7620 3d20 765b 313a 2d31 5d0a 2020    v = v[1:-1].  
+00016a40: 2020 2020 2020 645b 6b5d 203d 2076 0a20        d[k] = v. 
+00016a50: 2020 2072 6574 7572 6e20 640a 0a0a 6465     return d...de
+00016a60: 6620 6765 745f 7562 756e 7475 5f6d 616a  f get_ubuntu_maj
+00016a70: 6f72 5f76 6572 7369 6f6e 2829 3a0a 2020  or_version():.  
+00016a80: 2020 2222 220a 2020 2020 3a72 7479 7065    """.    :rtype
+00016a90: 3a20 696e 747c 4e6f 6e65 0a20 2020 2022  : int|None.    "
+00016aa0: 2222 0a20 2020 2064 203d 2067 6574 5f6c  "".    d = get_l
+00016ab0: 7362 5f72 656c 6561 7365 2829 0a20 2020  sb_release().   
+00016ac0: 2069 6620 645b 2244 4953 5452 4942 5f49   if d["DISTRIB_I
+00016ad0: 4422 5d20 213d 2022 5562 756e 7475 223a  D"] != "Ubuntu":
+00016ae0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00016af0: 4e6f 6e65 0a20 2020 2072 6574 7572 6e20  None.    return 
+00016b00: 696e 7428 666c 6f61 7428 645b 2244 4953  int(float(d["DIS
+00016b10: 5452 4942 5f52 454c 4541 5345 225d 2929  TRIB_RELEASE"]))
+00016b20: 0a0a 0a64 6566 2061 7574 6f5f 7072 6566  ...def auto_pref
+00016b30: 6978 5f6f 735f 6578 6563 5f70 7265 6669  ix_os_exec_prefi
+00016b40: 785f 7562 756e 7475 2870 7265 6669 785f  x_ubuntu(prefix_
+00016b50: 6172 6773 2c20 7562 756e 7475 5f6d 696e  args, ubuntu_min
+00016b60: 5f76 6572 7369 6f6e 3d31 3629 3a0a 2020  _version=16):.  
+00016b70: 2020 2222 220a 2020 2020 3a70 6172 616d    """.    :param
+00016b80: 206c 6973 745b 7374 725d 2070 7265 6669   list[str] prefi
+00016b90: 785f 6172 6773 3a0a 2020 2020 3a70 6172  x_args:.    :par
+00016ba0: 616d 2069 6e74 2075 6275 6e74 755f 6d69  am int ubuntu_mi
+00016bb0: 6e5f 7665 7273 696f 6e3a 0a0a 2020 2020  n_version:..    
+00016bc0: 4578 616d 706c 6520 7573 6167 653a 0a20  Example usage:. 
+00016bd0: 2020 2020 2061 7574 6f5f 7072 6566 6978       auto_prefix
+00016be0: 5f6f 735f 6578 6563 5f70 7265 6669 785f  _os_exec_prefix_
+00016bf0: 7562 756e 7475 285b 222f 752f 7a65 7965  ubuntu(["/u/zeye
+00016c00: 722f 746f 6f6c 732f 676c 6962 6332 3137  r/tools/glibc217
+00016c10: 2f6c 642d 6c69 6e75 782d 7838 362d 3634  /ld-linux-x86-64
+00016c20: 2e73 6f2e 3222 5d29 0a20 2020 2022 2222  .so.2"]).    """
+00016c30: 0a20 2020 2075 6275 6e74 755f 7665 7273  .    ubuntu_vers
+00016c40: 696f 6e20 3d20 6765 745f 7562 756e 7475  ion = get_ubuntu
+00016c50: 5f6d 616a 6f72 5f76 6572 7369 6f6e 2829  _major_version()
+00016c60: 0a20 2020 2069 6620 7562 756e 7475 5f76  .    if ubuntu_v
+00016c70: 6572 7369 6f6e 2069 7320 4e6f 6e65 3a0a  ersion is None:.
+00016c80: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00016c90: 2020 2069 6620 7562 756e 7475 5f76 6572     if ubuntu_ver
+00016ca0: 7369 6f6e 203e 3d20 7562 756e 7475 5f6d  sion >= ubuntu_m
+00016cb0: 696e 5f76 6572 7369 6f6e 3a0a 2020 2020  in_version:.    
+00016cc0: 2020 2020 7265 7475 726e 0a20 2020 2070      return.    p
+00016cd0: 7269 6e74 2822 596f 7520 6172 6520 7275  rint("You are ru
+00016ce0: 6e6e 696e 6720 5562 756e 7475 2025 692c  nning Ubuntu %i,
+00016cf0: 2074 6875 7320 7765 2070 7265 6669 7820   thus we prefix 
+00016d00: 616c 6c20 6f73 2e65 7865 6320 7769 7468  all os.exec with
+00016d10: 2025 732e 2220 2520 2875 6275 6e74 755f   %s." % (ubuntu_
+00016d20: 7665 7273 696f 6e2c 2070 7265 6669 785f  version, prefix_
+00016d30: 6172 6773 2929 0a20 2020 2061 7373 6572  args)).    asser
+00016d40: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00016d50: 2870 7265 6669 785f 6172 6773 5b30 5d29  (prefix_args[0])
+00016d60: 0a20 2020 206f 7665 7277 7269 7465 5f6f  .    overwrite_o
+00016d70: 735f 6578 6563 2870 7265 6669 785f 6172  s_exec(prefix_ar
+00016d80: 6773 3d70 7265 6669 785f 6172 6773 290a  gs=prefix_args).
+00016d90: 0a0a 6465 6620 636c 6561 6e75 705f 656e  ..def cleanup_en
+00016da0: 765f 7661 725f 7061 7468 2865 6e76 5f76  v_var_path(env_v
+00016db0: 6172 2c20 7061 7468 5f70 7265 6669 7829  ar, path_prefix)
+00016dc0: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
+00016dd0: 6172 616d 2073 7472 2065 6e76 5f76 6172  aram str env_var
+00016de0: 3a20 652e 672e 2022 4c44 5f4c 4942 5241  : e.g. "LD_LIBRA
+00016df0: 5259 5f50 4154 4822 0a20 2020 203a 7061  RY_PATH".    :pa
+00016e00: 7261 6d20 7374 7220 7061 7468 5f70 7265  ram str path_pre
+00016e10: 6669 783a 0a0a 2020 2020 5769 6c6c 2072  fix:..    Will r
+00016e20: 656d 6f76 6520 616c 6c20 7061 7468 7320  emove all paths 
+00016e30: 696e 206f 732e 656e 7669 726f 6e5b 656e  in os.environ[en
+00016e40: 765f 7661 725d 2077 6869 6368 2061 7265  v_var] which are
+00016e50: 2070 7265 6669 7865 6420 7769 7468 2070   prefixed with p
+00016e60: 6174 685f 7072 6566 6978 2e0a 2020 2020  ath_prefix..    
+00016e70: 2222 220a 2020 2020 6966 2065 6e76 5f76  """.    if env_v
+00016e80: 6172 206e 6f74 2069 6e20 6f73 2e65 6e76  ar not in os.env
+00016e90: 6972 6f6e 3a0a 2020 2020 2020 2020 7265  iron:.        re
+00016ea0: 7475 726e 0a20 2020 2070 7320 3d20 6f73  turn.    ps = os
+00016eb0: 2e65 6e76 6972 6f6e 5b65 6e76 5f76 6172  .environ[env_var
+00016ec0: 5d2e 7370 6c69 7428 223a 2229 0a0a 2020  ].split(":")..  
+00016ed0: 2020 6465 6620 6628 7029 3a0a 2020 2020    def f(p):.    
+00016ee0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00016ef0: 3a70 6172 616d 2073 7472 2070 3a0a 2020  :param str p:.  
+00016f00: 2020 2020 2020 3a72 7479 7065 3a20 626f        :rtype: bo
+00016f10: 6f6c 0a20 2020 2020 2020 2022 2222 0a20  ol.        """. 
+00016f20: 2020 2020 2020 2069 6620 7020 3d3d 2070         if p == p
+00016f30: 6174 685f 7072 6566 6978 206f 7220 702e  ath_prefix or p.
+00016f40: 7374 6172 7473 7769 7468 2870 6174 685f  startswith(path_
+00016f50: 7072 6566 6978 202b 2022 2f22 293a 0a20  prefix + "/"):. 
+00016f60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00016f70: 2822 5265 6d6f 7669 6e67 2025 7320 6672  ("Removing %s fr
+00016f80: 6f6d 2025 732e 2220 2520 2870 2c20 656e  om %s." % (p, en
+00016f90: 765f 7661 7229 290a 2020 2020 2020 2020  v_var)).        
+00016fa0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00016fb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00016fc0: 5472 7565 0a0a 2020 2020 7073 203d 2066  True..    ps = f
+00016fd0: 696c 7465 7228 662c 2070 7329 0a20 2020  ilter(f, ps).   
+00016fe0: 206f 732e 656e 7669 726f 6e5b 656e 765f   os.environ[env_
+00016ff0: 7661 725d 203d 2022 3a22 2e6a 6f69 6e28  var] = ":".join(
+00017000: 7073 290a 0a0a 6465 6620 6765 745f 6c6f  ps)...def get_lo
+00017010: 6769 6e5f 7573 6572 6e61 6d65 2829 3a0a  gin_username():.
+00017020: 2020 2020 2222 220a 2020 2020 3a72 7479      """.    :rty
+00017030: 7065 3a20 7374 720a 2020 2020 3a72 6574  pe: str.    :ret
+00017040: 7572 6e3a 2074 6865 2075 7365 726e 616d  urn: the usernam
+00017050: 6520 6f66 2074 6865 2063 7572 7265 6e74  e of the current
+00017060: 2075 7365 722e 0a20 2020 2055 7365 2074   user..    Use t
+00017070: 6869 7320 6173 2061 2072 6570 6c61 6365  his as a replace
+00017080: 6d65 6e74 2066 6f72 206f 732e 6765 746c  ment for os.getl
+00017090: 6f67 696e 2829 2e0a 2020 2020 2222 220a  ogin()..    """.
+000170a0: 2020 2020 696d 706f 7274 206f 730a 0a20      import os.. 
+000170b0: 2020 2069 6620 7379 732e 706c 6174 666f     if sys.platfo
+000170c0: 726d 203d 3d20 2277 696e 3332 223a 0a20  rm == "win32":. 
+000170d0: 2020 2020 2020 2072 6574 7572 6e20 6f73         return os
+000170e0: 2e67 6574 6c6f 6769 6e28 290a 2020 2020  .getlogin().    
+000170f0: 696d 706f 7274 2070 7764 0a0a 2020 2020  import pwd..    
+00017100: 7472 793a 0a20 2020 2020 2020 2072 6574  try:.        ret
+00017110: 7572 6e20 7077 642e 6765 7470 7775 6964  urn pwd.getpwuid
+00017120: 286f 732e 6765 7475 6964 2829 295b 305d  (os.getuid())[0]
+00017130: 0a20 2020 2065 7863 6570 7420 4b65 7945  .    except KeyE
+00017140: 7272 6f72 3a0a 2020 2020 2020 2020 2320  rror:.        # 
+00017150: 7077 642e 6765 7470 7775 6964 2829 2063  pwd.getpwuid() c
+00017160: 616e 2074 6872 6f77 204b 6579 4572 726f  an throw KeyErro
+00017170: 723a 2027 6765 7470 7775 6964 2829 3a20  r: 'getpwuid(): 
+00017180: 7569 6420 6e6f 7420 666f 756e 643a 2031  uid not found: 1
+00017190: 3233 3435 270a 2020 2020 2020 2020 2320  2345'.        # 
+000171a0: 7468 6973 2063 616e 2068 6170 7065 6e20  this can happen 
+000171b0: 652e 672e 2069 6e20 6120 646f 636b 6572  e.g. in a docker
+000171c0: 2065 6e76 6972 6f6e 6d65 6e74 2077 6974   environment wit
+000171d0: 6820 6d61 7070 6564 2075 6964 7320 756e  h mapped uids un
+000171e0: 6b6e 6f77 6e20 746f 2074 6865 2064 6f63  known to the doc
+000171f0: 6b65 7220 4f53 0a20 2020 2020 2020 2072  ker OS.        r
+00017200: 6574 7572 6e20 7374 7228 6f73 2e67 6574  eturn str(os.get
+00017210: 7569 6428 2929 0a0a 0a64 6566 2067 6574  uid())...def get
+00017220: 5f74 656d 705f 6469 7228 293a 0a20 2020  _temp_dir():.   
+00017230: 2022 2222 0a20 2020 203a 7274 7970 653a   """.    :rtype:
+00017240: 2073 7472 0a20 2020 203a 7265 7475 726e   str.    :return
+00017250: 3a20 652e 672e 2022 2f74 6d70 2f24 5553  : e.g. "/tmp/$US
+00017260: 4552 4e41 4d45 220a 2020 2020 2222 220a  ERNAME".    """.
+00017270: 2020 2020 7573 6572 6e61 6d65 203d 2067      username = g
+00017280: 6574 5f6c 6f67 696e 5f75 7365 726e 616d  et_login_usernam
+00017290: 6528 290a 2020 2020 666f 7220 656e 766e  e().    for envn
+000172a0: 616d 6520 696e 205b 2254 4d50 4449 5222  ame in ["TMPDIR"
+000172b0: 2c20 2254 454d 5022 2c20 2254 4d50 225d  , "TEMP", "TMP"]
+000172c0: 3a0a 2020 2020 2020 2020 6469 726e 616d  :.        dirnam
+000172d0: 6520 3d20 6f73 2e67 6574 656e 7628 656e  e = os.getenv(en
+000172e0: 766e 616d 6529 0a20 2020 2020 2020 2069  vname).        i
+000172f0: 6620 6469 726e 616d 653a 0a20 2020 2020  f dirname:.     
+00017300: 2020 2020 2020 2072 6574 7572 6e20 2225         return "%
+00017310: 732f 2573 2220 2520 2864 6972 6e61 6d65  s/%s" % (dirname
+00017320: 2c20 7573 6572 6e61 6d65 290a 2020 2020  , username).    
+00017330: 2320 2f76 6172 2f74 6d70 2073 686f 756c  # /var/tmp shoul
+00017340: 6420 6265 206d 6f72 6520 7065 7273 6973  d be more persis
+00017350: 7465 6e74 2074 6861 6e20 2f74 6d70 2075  tent than /tmp u
+00017360: 7375 616c 6c79 2e0a 2020 2020 6966 206f  sually..    if o
+00017370: 732e 7061 7468 2e65 7869 7374 7328 222f  s.path.exists("/
+00017380: 7661 722f 746d 7022 293a 0a20 2020 2020  var/tmp"):.     
+00017390: 2020 2072 6574 7572 6e20 222f 7661 722f     return "/var/
+000173a0: 746d 702f 2573 2220 2520 7573 6572 6e61  tmp/%s" % userna
+000173b0: 6d65 0a20 2020 2072 6574 7572 6e20 222f  me.    return "/
+000173c0: 746d 702f 2573 2220 2520 7573 6572 6e61  tmp/%s" % userna
+000173d0: 6d65 0a0a 0a64 6566 2067 6574 5f63 6163  me...def get_cac
+000173e0: 6865 5f64 6972 2829 3a0a 2020 2020 2222  he_dir():.    ""
+000173f0: 220a 2020 2020 3a72 6574 7572 6e3a 2075  ".    :return: u
+00017400: 7365 6420 746f 2063 6163 6865 206e 6f6e  sed to cache non
+00017410: 2d63 7269 7469 6361 6c20 7468 696e 6773  -critical things
+00017420: 2e20 6279 2064 6566 6175 6c74 2067 6574  . by default get
+00017430: 5f74 656d 705f 6469 722e 2075 6e6c 6573  _temp_dir. unles
+00017440: 7320 796f 7520 6465 6669 6e65 2065 6e76  s you define env
+00017450: 2052 4554 5552 4e4e 5f43 4143 4845 5f44   RETURNN_CACHE_D
+00017460: 4952 0a20 2020 203a 7274 7970 653a 2073  IR.    :rtype: s
+00017470: 7472 0a20 2020 2022 2222 0a20 2020 2069  tr.    """.    i
+00017480: 6620 2252 4554 5552 4e4e 5f43 4143 4845  f "RETURNN_CACHE
+00017490: 5f44 4952 2220 696e 206f 732e 656e 7669  _DIR" in os.envi
+000174a0: 726f 6e3a 0a20 2020 2020 2020 2072 6574  ron:.        ret
+000174b0: 7572 6e20 6f73 2e65 6e76 6972 6f6e 5b22  urn os.environ["
+000174c0: 5245 5455 524e 4e5f 4341 4348 455f 4449  RETURNN_CACHE_DI
+000174d0: 5222 5d0a 2020 2020 7265 7475 726e 2067  R"].    return g
+000174e0: 6574 5f74 656d 705f 6469 7228 290a 0a0a  et_temp_dir()...
+000174f0: 636c 6173 7320 4c6f 636b 4669 6c65 286f  class LockFile(o
+00017500: 626a 6563 7429 3a0a 2020 2020 2222 220a  bject):.    """.
+00017510: 2020 2020 5369 6d70 6c65 206c 6f63 6b20      Simple lock 
+00017520: 6669 6c65 2e0a 2020 2020 2222 220a 0a20  file..    """.. 
+00017530: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00017540: 7365 6c66 2c20 6469 7265 6374 6f72 792c  self, directory,
+00017550: 206e 616d 653d 226c 6f63 6b5f 6669 6c65   name="lock_file
+00017560: 222c 206c 6f63 6b5f 7469 6d65 6f75 743d  ", lock_timeout=
+00017570: 3120 2a20 3630 202a 2036 3029 3a0a 2020  1 * 60 * 60):.  
+00017580: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00017590: 2020 3a70 6172 616d 2073 7472 2064 6972    :param str dir
+000175a0: 6563 746f 7279 3a0a 2020 2020 2020 2020  ectory:.        
+000175b0: 3a70 6172 616d 2069 6e74 7c66 6c6f 6174  :param int|float
+000175c0: 206c 6f63 6b5f 7469 6d65 6f75 743a 2069   lock_timeout: i
+000175d0: 6e20 7365 636f 6e64 730a 2020 2020 2020  n seconds.      
+000175e0: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
+000175f0: 6c66 2e64 6972 6563 746f 7279 203d 2064  lf.directory = d
+00017600: 6972 6563 746f 7279 0a20 2020 2020 2020  irectory.       
+00017610: 2073 656c 662e 6e61 6d65 203d 206e 616d   self.name = nam
+00017620: 650a 2020 2020 2020 2020 7365 6c66 2e66  e.        self.f
+00017630: 6420 3d20 4e6f 6e65 0a20 2020 2020 2020  d = None.       
+00017640: 2073 656c 662e 6c6f 636b 5f74 696d 656f   self.lock_timeo
+00017650: 7574 203d 206c 6f63 6b5f 7469 6d65 6f75  ut = lock_timeou
+00017660: 740a 2020 2020 2020 2020 7365 6c66 2e6c  t.        self.l
+00017670: 6f63 6b66 696c 6520 3d20 2225 732f 2573  ockfile = "%s/%s
+00017680: 2220 2520 2864 6972 6563 746f 7279 2c20  " % (directory, 
+00017690: 6e61 6d65 290a 0a20 2020 2064 6566 2069  name)..    def i
+000176a0: 735f 6f6c 645f 6c6f 636b 6669 6c65 2873  s_old_lockfile(s
+000176b0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+000176c0: 220a 2020 2020 2020 2020 3a72 6574 7572  ".        :retur
+000176d0: 6e3a 2057 6865 7468 6572 2074 6865 7265  n: Whether there
+000176e0: 2069 7320 616e 2065 7869 7374 696e 6720   is an existing 
+000176f0: 6c6f 636b 2066 696c 6520 616e 6420 7468  lock file and th
+00017700: 6520 6578 6973 7469 6e67 206c 6f63 6b20  e existing lock 
+00017710: 6669 6c65 2069 7320 6f6c 642e 0a20 2020  file is old..   
+00017720: 2020 2020 203a 7274 7970 653a 2062 6f6f       :rtype: boo
+00017730: 6c0a 2020 2020 2020 2020 2222 220a 2020  l.        """.  
+00017740: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00017750: 2020 2020 2020 206d 7469 6d65 203d 206f         mtime = o
+00017760: 732e 7061 7468 2e67 6574 6d74 696d 6528  s.path.getmtime(
+00017770: 7365 6c66 2e6c 6f63 6b66 696c 6529 0a20  self.lockfile). 
+00017780: 2020 2020 2020 2065 7863 6570 7420 4f53         except OS
+00017790: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000177a0: 2020 206d 7469 6d65 203d 204e 6f6e 650a     mtime = None.
+000177b0: 2020 2020 2020 2020 6966 206d 7469 6d65          if mtime
+000177c0: 2061 6e64 2028 6162 7328 7469 6d65 2e74   and (abs(time.t
+000177d0: 696d 6528 2920 2d20 6d74 696d 6529 203e  ime() - mtime) >
+000177e0: 2073 656c 662e 6c6f 636b 5f74 696d 656f   self.lock_timeo
+000177f0: 7574 293a 0a20 2020 2020 2020 2020 2020  ut):.           
+00017800: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
+00017810: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00017820: 650a 0a20 2020 2064 6566 206d 6179 6265  e..    def maybe
+00017830: 5f72 656d 6f76 655f 6f6c 645f 6c6f 636b  _remove_old_lock
+00017840: 6669 6c65 2873 656c 6629 3a0a 2020 2020  file(self):.    
+00017850: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00017860: 5265 6d6f 7665 7320 616e 2065 7869 7374  Removes an exist
+00017870: 696e 6720 6f6c 6420 6c6f 636b 6669 6c65  ing old lockfile
+00017880: 2c20 6966 2074 6865 7265 2069 7320 6f6e  , if there is on
+00017890: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+000178a0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+000178b0: 6c66 2e69 735f 6f6c 645f 6c6f 636b 6669  lf.is_old_lockfi
+000178c0: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
+000178d0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+000178e0: 2070 7269 6e74 2822 5265 6d6f 7669 6e67   print("Removing
+000178f0: 206f 6c64 206c 6f63 6b66 696c 6520 2572   old lockfile %r
+00017900: 2028 7072 6f62 6162 6c79 2063 7261 7368   (probably crash
+00017910: 6564 2070 726f 6329 2e22 2025 2073 656c  ed proc)." % sel
+00017920: 662e 6c6f 636b 6669 6c65 290a 2020 2020  f.lockfile).    
+00017930: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00017940: 2020 2020 206f 732e 7265 6d6f 7665 2873       os.remove(s
+00017950: 656c 662e 6c6f 636b 6669 6c65 290a 2020  elf.lockfile).  
+00017960: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
+00017970: 7272 6f72 2061 7320 6578 633a 0a20 2020  rror as exc:.   
+00017980: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00017990: 5265 6d6f 7665 206c 6f63 6b66 696c 6520  Remove lockfile 
+000179a0: 6578 6365 7074 696f 6e20 2572 2e20 4967  exception %r. Ig
+000179b0: 6e6f 7269 6e67 2069 742e 2220 2520 6578  noring it." % ex
+000179c0: 6329 0a0a 2020 2020 6465 6620 6973 5f6c  c)..    def is_l
+000179d0: 6f63 6b65 6428 7365 6c66 293a 0a20 2020  ocked(self):.   
+000179e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000179f0: 203a 7265 7475 726e 3a20 7768 6574 6865   :return: whethe
+00017a00: 7220 7468 6572 6520 6973 2061 6e20 6163  r there is an ac
+00017a10: 7469 7665 2028 6e6f 7420 6f6c 6429 206c  tive (not old) l
+00017a20: 6f63 6b66 696c 650a 2020 2020 2020 2020  ockfile.        
+00017a30: 3a72 7479 7065 3a20 626f 6f6c 0a20 2020  :rtype: bool.   
+00017a40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00017a50: 2069 6620 7365 6c66 2e69 735f 6f6c 645f   if self.is_old_
+00017a60: 6c6f 636b 6669 6c65 2829 3a0a 2020 2020  lockfile():.    
+00017a70: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00017a80: 616c 7365 0a20 2020 2020 2020 2074 7279  alse.        try
+00017a90: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00017aa0: 7475 726e 206f 732e 7061 7468 2e65 7869  turn os.path.exi
+00017ab0: 7374 7328 7365 6c66 2e6c 6f63 6b66 696c  sts(self.lockfil
+00017ac0: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+00017ad0: 7420 4f53 4572 726f 723a 0a20 2020 2020  t OSError:.     
+00017ae0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00017af0: 6c73 650a 0a20 2020 2064 6566 206c 6f63  lse..    def loc
+00017b00: 6b28 7365 6c66 293a 0a20 2020 2020 2020  k(self):.       
+00017b10: 2022 2222 0a20 2020 2020 2020 2041 6371   """.        Acq
+00017b20: 7569 7265 7320 7468 6520 6c6f 636b 2e0a  uires the lock..
+00017b30: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00017b40: 2020 2020 696d 706f 7274 2074 696d 650a      import time.
+00017b50: 2020 2020 2020 2020 696d 706f 7274 2065          import e
+00017b60: 7272 6e6f 0a0a 2020 2020 2020 2020 7761  rrno..        wa
+00017b70: 6974 5f63 6f75 6e74 203d 2030 0a20 2020  it_count = 0.   
+00017b80: 2020 2020 2077 6869 6c65 2054 7275 653a       while True:
+00017b90: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00017ba0: 7279 2074 6f20 6372 6561 7465 2064 6972  ry to create dir
+00017bb0: 6563 746f 7279 2069 6620 6974 2064 6f65  ectory if it doe
+00017bc0: 7320 6e6f 7420 6578 6973 742e 0a20 2020  s not exist..   
+00017bd0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00017be0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+00017bf0: 2e6d 616b 6564 6972 7328 7365 6c66 2e64  .makedirs(self.d
+00017c00: 6972 6563 746f 7279 290a 2020 2020 2020  irectory).      
+00017c10: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
+00017c20: 7272 6f72 2061 7320 6578 633a 0a20 2020  rror as exc:.   
+00017c30: 2020 2020 2020 2020 2020 2020 2023 2050               # P
+00017c40: 6f73 7369 626c 6520 6572 726f 7273 3a0a  ossible errors:.
+00017c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c60: 2320 454e 4f45 4e54 2028 4e6f 2073 7563  # ENOENT (No suc
+00017c70: 6820 6669 6c65 206f 7220 6469 7265 6374  h file or direct
+00017c80: 6f72 7929 2c20 652e 672e 2069 6620 736f  ory), e.g. if so
+00017c90: 6d65 2070 6172 656e 7420 6469 7265 6374  me parent direct
+00017ca0: 6f72 7920 7761 7320 6465 6c65 7465 642e  ory was deleted.
+00017cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017cc0: 2023 2045 4558 4953 5420 2846 696c 6520   # EEXIST (File 
+00017cd0: 6578 6973 7473 292c 2069 6620 7468 6520  exists), if the 
+00017ce0: 6469 7220 616c 7265 6164 7920 6578 6973  dir already exis
+00017cf0: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
+00017d00: 2020 2020 6966 2065 7863 2e65 7272 6e6f      if exc.errno
+00017d10: 206e 6f74 2069 6e20 5b65 7272 6e6f 2e45   not in [errno.E
+00017d20: 4e4f 454e 542c 2065 7272 6e6f 2e45 4558  NOENT, errno.EEX
+00017d30: 4953 545d 3a0a 2020 2020 2020 2020 2020  IST]:.          
+00017d40: 2020 2020 2020 2020 2020 2320 4f74 6865            # Othe
+00017d50: 7220 6572 726f 722c 2073 6f20 7265 7261  r error, so rera
+00017d60: 6973 652e 0a20 2020 2020 2020 2020 2020  ise..           
+00017d70: 2020 2020 2020 2020 2023 2043 6f6d 6d6f           # Commo
+00017d80: 6e20 6f6e 6573 2061 7265 2065 2e67 2e3a  n ones are e.g.:
+00017d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017da0: 2020 2020 2023 2045 4e4f 5350 4320 284e       # ENOSPC (N
+00017db0: 6f20 7370 6163 6520 6c65 6674 206f 6e20  o space left on 
+00017dc0: 6465 7669 6365 290a 2020 2020 2020 2020  device).        
+00017dd0: 2020 2020 2020 2020 2020 2020 2320 4541              # EA
+00017de0: 4343 4553 2028 5065 726d 6973 7369 6f6e  CCES (Permission
+00017df0: 2064 656e 6965 6429 0a20 2020 2020 2020   denied).       
+00017e00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00017e10: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00017e20: 2020 2023 2049 676e 6f72 6520 7468 6f73     # Ignore thos
+00017e30: 6520 6572 726f 7273 2e0a 2020 2020 2020  e errors..      
+00017e40: 2020 2020 2020 2320 4e6f 7720 7472 7920        # Now try 
+00017e50: 746f 2063 7265 6174 6520 7468 6520 6c6f  to create the lo
+00017e60: 636b 2e0a 2020 2020 2020 2020 2020 2020  ck..            
+00017e70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00017e80: 2020 2020 2073 656c 662e 6664 203d 206f       self.fd = o
+00017e90: 732e 6f70 656e 2873 656c 662e 6c6f 636b  s.open(self.lock
+00017ea0: 6669 6c65 2c20 6f73 2e4f 5f43 5245 4154  file, os.O_CREAT
+00017eb0: 207c 206f 732e 4f5f 4558 434c 207c 206f   | os.O_EXCL | o
+00017ec0: 732e 4f5f 5244 5752 290a 2020 2020 2020  s.O_RDWR).      
+00017ed0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00017ee0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00017ef0: 6570 7420 4f53 4572 726f 7220 6173 2065  ept OSError as e
+00017f00: 7863 3a0a 2020 2020 2020 2020 2020 2020  xc:.            
+00017f10: 2020 2020 2320 506f 7373 6962 6c65 2065      # Possible e
+00017f20: 7272 6f72 733a 0a20 2020 2020 2020 2020  rrors:.         
+00017f30: 2020 2020 2020 2023 2045 4e4f 454e 5420         # ENOENT 
+00017f40: 284e 6f20 7375 6368 2066 696c 6520 6f72  (No such file or
+00017f50: 2064 6972 6563 746f 7279 292c 2065 2e67   directory), e.g
+00017f60: 2e20 6966 2074 6865 2064 6972 6563 746f  . if the directo
+00017f70: 7279 2077 6173 2064 656c 6574 6564 2e0a  ry was deleted..
+00017f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f90: 2320 4545 5849 5354 2028 4669 6c65 2065  # EEXIST (File e
+00017fa0: 7869 7374 7329 2c20 6966 2074 6865 206c  xists), if the l
+00017fb0: 6f63 6b20 616c 7265 6164 7920 6578 6973  ock already exis
+00017fc0: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
+00017fd0: 2020 2020 6966 2065 7863 2e65 7272 6e6f      if exc.errno
+00017fe0: 206e 6f74 2069 6e20 5b65 7272 6e6f 2e45   not in [errno.E
+00017ff0: 4e4f 454e 542c 2065 7272 6e6f 2e45 4558  NOENT, errno.EEX
+00018000: 4953 545d 3a0a 2020 2020 2020 2020 2020  IST]:.          
+00018010: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00018020: 2023 204f 7468 6572 2065 7272 6f72 2c20   # Other error, 
+00018030: 736f 2072 6572 6169 7365 2e0a 2020 2020  so reraise..    
+00018040: 2020 2020 2020 2020 2320 5765 2064 6964          # We did
+00018050: 206e 6f74 2067 6574 2074 6865 206c 6f63   not get the loc
+00018060: 6b2e 0a20 2020 2020 2020 2020 2020 2023  k..            #
+00018070: 2043 6865 636b 2069 6620 6974 2069 7320   Check if it is 
+00018080: 6120 7265 616c 6c79 206f 6c64 206f 6e65  a really old one
+00018090: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000180a0: 6c66 2e6d 6179 6265 5f72 656d 6f76 655f  lf.maybe_remove_
+000180b0: 6f6c 645f 6c6f 636b 6669 6c65 2829 0a20  old_lockfile(). 
+000180c0: 2020 2020 2020 2020 2020 2023 2057 6169             # Wai
+000180d0: 7420 6120 6269 742c 2061 6e64 2074 6865  t a bit, and the
+000180e0: 6e20 7265 7472 792e 0a20 2020 2020 2020  n retry..       
+000180f0: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+00018100: 3129 0a20 2020 2020 2020 2020 2020 2077  1).            w
+00018110: 6169 745f 636f 756e 7420 2b3d 2031 0a20  ait_count += 1. 
+00018120: 2020 2020 2020 2020 2020 2069 6620 7761             if wa
+00018130: 6974 5f63 6f75 6e74 203d 3d20 3130 3a0a  it_count == 10:.
+00018140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018150: 7072 696e 7428 2257 6169 7469 6e67 2066  print("Waiting f
+00018160: 6f72 206c 6f63 6b2d 6669 6c65 3a20 2573  or lock-file: %s
+00018170: 2220 2520 7365 6c66 2e6c 6f63 6b66 696c  " % self.lockfil
+00018180: 6529 0a0a 2020 2020 6465 6620 756e 6c6f  e)..    def unlo
+00018190: 636b 2873 656c 6629 3a0a 2020 2020 2020  ck(self):.      
+000181a0: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
+000181b0: 6c65 6173 6573 2074 6865 206c 6f63 6b2e  leases the lock.
+000181c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000181d0: 2020 2020 206f 732e 636c 6f73 6528 7365       os.close(se
+000181e0: 6c66 2e66 6429 0a20 2020 2020 2020 206f  lf.fd).        o
+000181f0: 732e 7265 6d6f 7665 2873 656c 662e 6c6f  s.remove(self.lo
+00018200: 636b 6669 6c65 290a 0a20 2020 2064 6566  ckfile)..    def
+00018210: 205f 5f65 6e74 6572 5f5f 2873 656c 6629   __enter__(self)
+00018220: 3a0a 2020 2020 2020 2020 7365 6c66 2e6c  :.        self.l
+00018230: 6f63 6b28 290a 0a20 2020 2064 6566 205f  ock()..    def _
+00018240: 5f65 7869 745f 5f28 7365 6c66 2c20 6578  _exit__(self, ex
+00018250: 635f 7479 7065 2c20 6578 635f 7661 6c2c  c_type, exc_val,
+00018260: 2065 7863 5f74 6229 3a0a 2020 2020 2020   exc_tb):.      
+00018270: 2020 7365 6c66 2e75 6e6c 6f63 6b28 290a    self.unlock().
+00018280: 0a0a 6465 6620 7374 725f 6973 5f6e 756d  ..def str_is_num
+00018290: 6265 7228 7329 3a0a 2020 2020 2222 220a  ber(s):.    """.
+000182a0: 2020 2020 3a70 6172 616d 2073 7472 2073      :param str s
+000182b0: 3a20 652e 672e 2022 3122 2c20 222e 3322  : e.g. "1", ".3"
+000182c0: 206f 7220 2278 220a 2020 2020 3a72 6574   or "x".    :ret
+000182d0: 7572 6e3a 2077 6865 7468 6572 2073 2063  urn: whether s c
+000182e0: 616e 2062 6520 6361 7374 6564 2074 6f20  an be casted to 
+000182f0: 666c 6f61 7420 6f72 2069 6e74 0a20 2020  float or int.   
+00018300: 203a 7274 7970 653a 2062 6f6f 6c0a 2020   :rtype: bool.  
+00018310: 2020 2222 220a 2020 2020 7472 793a 0a20    """.    try:. 
+00018320: 2020 2020 2020 2066 6c6f 6174 2873 290a         float(s).
+00018330: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00018340: 7275 650a 2020 2020 6578 6365 7074 2056  rue.    except V
+00018350: 616c 7565 4572 726f 723a 0a20 2020 2020  alueError:.     
+00018360: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00018370: 0a0a 6465 6620 736f 7274 6564 5f76 616c  ..def sorted_val
+00018380: 7565 735f 6672 6f6d 5f64 6963 7428 6429  ues_from_dict(d)
+00018390: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
+000183a0: 6172 616d 2064 6963 745b 542c 565d 2064  aram dict[T,V] d
+000183b0: 3a0a 2020 2020 3a72 7479 7065 3a20 6c69  :.    :rtype: li
+000183c0: 7374 5b56 5d0a 2020 2020 2222 220a 2020  st[V].    """.  
+000183d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+000183e0: 6e63 6528 642c 2064 6963 7429 0a20 2020  nce(d, dict).   
+000183f0: 2072 6574 7572 6e20 5b76 2066 6f72 2028   return [v for (
+00018400: 6b2c 2076 2920 696e 2073 6f72 7465 6428  k, v) in sorted(
+00018410: 642e 6974 656d 7328 2929 5d0a 0a0a 6465  d.items())]...de
+00018420: 6620 6469 6374 5f7a 6970 286b 6579 732c  f dict_zip(keys,
+00018430: 2076 616c 7565 7329 3a0a 2020 2020 2222   values):.    ""
+00018440: 220a 2020 2020 3a70 6172 616d 206c 6973  ".    :param lis
+00018450: 745b 545d 206b 6579 733a 0a20 2020 203a  t[T] keys:.    :
+00018460: 7061 7261 6d20 6c69 7374 5b56 5d20 7661  param list[V] va
+00018470: 6c75 6573 3a0a 2020 2020 3a72 7479 7065  lues:.    :rtype
+00018480: 3a20 6469 6374 5b54 2c56 5d0a 2020 2020  : dict[T,V].    
+00018490: 2222 220a 2020 2020 6173 7365 7274 206c  """.    assert l
+000184a0: 656e 286b 6579 7329 203d 3d20 6c65 6e28  en(keys) == len(
+000184b0: 7661 6c75 6573 290a 2020 2020 7265 7475  values).    retu
+000184c0: 726e 2064 6963 7428 7a69 7028 6b65 7973  rn dict(zip(keys
+000184d0: 2c20 7661 6c75 6573 2929 0a0a 0a64 6566  , values))...def
+000184e0: 2070 6172 7365 5f6c 645f 636f 6e66 5f66   parse_ld_conf_f
+000184f0: 696c 6528 666e 293a 0a20 2020 2022 2222  ile(fn):.    """
+00018500: 0a20 2020 2056 6961 2068 7474 7073 3a2f  .    Via https:/
+00018510: 2f67 6974 6875 622e 636f 6d2f 616c 6265  /github.com/albe
+00018520: 7274 7a2f 7379 7374 656d 2d74 6f6f 6c73  rtz/system-tools
+00018530: 2f62 6c6f 622f 6d61 7374 6572 2f62 696e  /blob/master/bin
+00018540: 2f66 696e 642d 6c69 622d 696e 2d70 6174  /find-lib-in-pat
+00018550: 682e 7079 2e0a 0a20 2020 203a 7061 7261  h.py...    :para
+00018560: 6d20 7374 7220 666e 3a20 652e 672e 2022  m str fn: e.g. "
+00018570: 2f65 7463 2f6c 642e 736f 2e63 6f6e 6622  /etc/ld.so.conf"
+00018580: 0a20 2020 203a 7265 7475 726e 3a20 6c69  .    :return: li
+00018590: 7374 206f 6620 7061 7468 7320 666f 7220  st of paths for 
+000185a0: 6c69 6273 0a20 2020 203a 7274 7970 653a  libs.    :rtype:
+000185b0: 206c 6973 745b 7374 725d 0a20 2020 2022   list[str].    "
+000185c0: 2222 0a20 2020 2066 726f 6d20 676c 6f62  "".    from glob
+000185d0: 2069 6d70 6f72 7420 676c 6f62 0a0a 2020   import glob..  
+000185e0: 2020 7061 7468 7320 3d20 5b5d 0a20 2020    paths = [].   
+000185f0: 2066 6f72 206c 696e 6520 696e 206f 7065   for line in ope
+00018600: 6e28 666e 292e 7265 6164 2829 2e73 706c  n(fn).read().spl
+00018610: 6974 6c69 6e65 7328 293a 0a20 2020 2020  itlines():.     
+00018620: 2020 206c 696e 6520 3d20 6c69 6e65 2e73     line = line.s
+00018630: 7472 6970 2829 0a20 2020 2020 2020 2069  trip().        i
+00018640: 6620 6e6f 7420 6c69 6e65 3a0a 2020 2020  f not line:.    
+00018650: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00018660: 0a20 2020 2020 2020 2069 6620 6c69 6e65  .        if line
+00018670: 2e73 7461 7274 7377 6974 6828 2223 2229  .startswith("#")
+00018680: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00018690: 6e74 696e 7565 0a20 2020 2020 2020 2069  ntinue.        i
+000186a0: 6620 6c69 6e65 2e73 7461 7274 7377 6974  f line.startswit
+000186b0: 6828 2269 6e63 6c75 6465 2022 293a 0a20  h("include "):. 
+000186c0: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
+000186d0: 7562 5f66 6e20 696e 2067 6c6f 6228 6c69  ub_fn in glob(li
+000186e0: 6e65 5b6c 656e 2822 696e 636c 7564 6520  ne[len("include 
+000186f0: 2229 203a 5d29 3a0a 2020 2020 2020 2020  ") :]):.        
+00018700: 2020 2020 2020 2020 7061 7468 732e 6578          paths.ex
+00018710: 7465 6e64 2870 6172 7365 5f6c 645f 636f  tend(parse_ld_co
+00018720: 6e66 5f66 696c 6528 7375 625f 666e 2929  nf_file(sub_fn))
+00018730: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00018740: 7469 6e75 650a 2020 2020 2020 2020 7061  tinue.        pa
+00018750: 7468 732e 6170 7065 6e64 286c 696e 6529  ths.append(line)
+00018760: 0a20 2020 2072 6574 7572 6e20 7061 7468  .    return path
+00018770: 730a 0a0a 6465 6620 6765 745f 6c64 5f70  s...def get_ld_p
+00018780: 6174 6873 2829 3a0a 2020 2020 2222 220a  aths():.    """.
+00018790: 2020 2020 546f 2062 6520 7665 7279 2063      To be very c
+000187a0: 6f72 7265 6374 2c20 7365 6520 6d61 6e2d  orrect, see man-
+000187b0: 7061 6765 206f 6620 6c64 2e73 6f2e 0a20  page of ld.so.. 
+000187c0: 2020 2041 6e64 2068 6572 653a 2068 7474     And here: htt
+000187d0: 7073 3a2f 2f75 6e69 782e 7374 6163 6b65  ps://unix.stacke
+000187e0: 7863 6861 6e67 652e 636f 6d2f 7175 6573  xchange.com/ques
+000187f0: 7469 6f6e 732f 3335 3432 3935 2f77 6861  tions/354295/wha
+00018800: 742d 6973 2d74 6865 2d64 6566 6175 6c74  t-is-the-default
+00018810: 2d76 616c 7565 2d6f 662d 6c64 2d6c 6962  -value-of-ld-lib
+00018820: 7261 7279 2d70 6174 682f 3335 3432 3936  rary-path/354296
+00018830: 0a20 2020 2053 686f 7274 2076 6572 7369  .    Short versi
+00018840: 6f6e 2c20 6e6f 7420 7370 6563 6966 6963  on, not specific
+00018850: 2074 6f20 616e 2065 7865 6375 7461 626c   to an executabl
+00018860: 652c 2069 6e20 7468 6973 206f 7264 6572  e, in this order
+00018870: 3a0a 2020 2020 2d20 4c44 5f4c 4942 5241  :.    - LD_LIBRA
+00018880: 5259 5f50 4154 480a 2020 2020 2d20 2f65  RY_PATH.    - /e
+00018890: 7463 2f6c 642e 736f 2e63 6163 6865 2028  tc/ld.so.cache (
+000188a0: 696e 7374 6561 6420 7765 2077 696c 6c20  instead we will 
+000188b0: 7061 7273 6520 2f65 7463 2f6c 642e 736f  parse /etc/ld.so
+000188c0: 2e63 6f6e 6629 0a20 2020 202d 202f 6c69  .conf).    - /li
+000188d0: 622c 202f 7573 722f 6c69 6220 286f 7220  b, /usr/lib (or 
+000188e0: 6d61 7962 6520 2f6c 6962 3634 2c20 2f75  maybe /lib64, /u
+000188f0: 7372 2f6c 6962 3634 290a 2020 2020 5669  sr/lib64).    Vi
+00018900: 6120 6874 7470 733a 2f2f 6769 7468 7562  a https://github
+00018910: 2e63 6f6d 2f61 6c62 6572 747a 2f73 7973  .com/albertz/sys
+00018920: 7465 6d2d 746f 6f6c 732f 626c 6f62 2f6d  tem-tools/blob/m
+00018930: 6173 7465 722f 6269 6e2f 6669 6e64 2d6c  aster/bin/find-l
+00018940: 6962 2d69 6e2d 7061 7468 2e70 792e 0a0a  ib-in-path.py...
+00018950: 2020 2020 3a72 7479 7065 3a20 6c69 7374      :rtype: list
+00018960: 5b73 7472 5d0a 2020 2020 3a72 6574 7572  [str].    :retur
+00018970: 6e3a 206c 6973 7420 6f66 2070 6174 6873  n: list of paths
+00018980: 2074 6f20 7365 6172 6368 2066 6f72 206c   to search for l
+00018990: 6962 7320 282a 2e73 6f20 6669 6c65 7329  ibs (*.so files)
+000189a0: 0a20 2020 2022 2222 0a20 2020 2070 6174  .    """.    pat
+000189b0: 6873 203d 205b 5d0a 2020 2020 6966 2022  hs = [].    if "
+000189c0: 4c44 5f4c 4942 5241 5259 5f50 4154 4822  LD_LIBRARY_PATH"
+000189d0: 2069 6e20 6f73 2e65 6e76 6972 6f6e 3a0a   in os.environ:.
+000189e0: 2020 2020 2020 2020 7061 7468 732e 6578          paths.ex
+000189f0: 7465 6e64 286f 732e 656e 7669 726f 6e5b  tend(os.environ[
+00018a00: 224c 445f 4c49 4252 4152 595f 5041 5448  "LD_LIBRARY_PATH
+00018a10: 225d 2e73 706c 6974 2822 3a22 2929 0a20  "].split(":")). 
+00018a20: 2020 2069 6620 6f73 2e70 6174 682e 6578     if os.path.ex
+00018a30: 6973 7473 2822 2f65 7463 2f6c 642e 736f  ists("/etc/ld.so
+00018a40: 2e63 6f6e 6622 293a 0a20 2020 2020 2020  .conf"):.       
+00018a50: 2070 6174 6873 2e65 7874 656e 6428 7061   paths.extend(pa
+00018a60: 7273 655f 6c64 5f63 6f6e 665f 6669 6c65  rse_ld_conf_file
+00018a70: 2822 2f65 7463 2f6c 642e 736f 2e63 6f6e  ("/etc/ld.so.con
+00018a80: 6622 2929 0a20 2020 2070 6174 6873 2e65  f")).    paths.e
+00018a90: 7874 656e 6428 5b22 2f6c 6962 222c 2022  xtend(["/lib", "
+00018aa0: 2f75 7372 2f6c 6962 222c 2022 2f6c 6962  /usr/lib", "/lib
+00018ab0: 3634 222c 2022 2f75 7372 2f6c 6962 3634  64", "/usr/lib64
+00018ac0: 225d 290a 2020 2020 7265 7475 726e 2070  "]).    return p
+00018ad0: 6174 6873 0a0a 0a64 6566 2066 696e 645f  aths...def find_
+00018ae0: 6c69 6228 6c69 625f 6e61 6d65 293a 0a20  lib(lib_name):. 
+00018af0: 2020 2022 2222 0a20 2020 203a 7061 7261     """.    :para
+00018b00: 6d20 7374 7220 6c69 625f 6e61 6d65 3a20  m str lib_name: 
+00018b10: 7769 7468 6f75 7420 706f 7374 6669 782f  without postfix/
+00018b20: 7072 6566 6978 2c20 652e 672e 2022 6375  prefix, e.g. "cu
+00018b30: 6461 7274 2220 6f72 2022 626c 6173 220a  dart" or "blas".
+00018b40: 2020 2020 3a72 6574 7572 6e3a 2072 6574      :return: ret
+00018b50: 7572 6e73 2066 756c 6c20 7061 7468 2074  urns full path t
+00018b60: 6f20 6c69 6220 6f72 204e 6f6e 650a 2020  o lib or None.  
+00018b70: 2020 3a72 7479 7065 3a20 7374 727c 4e6f    :rtype: str|No
+00018b80: 6e65 0a20 2020 2022 2222 0a20 2020 2069  ne.    """.    i
+00018b90: 6620 7379 732e 706c 6174 666f 726d 203d  f sys.platform =
+00018ba0: 3d20 2264 6172 7769 6e22 3a0a 2020 2020  = "darwin":.    
+00018bb0: 2020 2020 7072 6566 6978 203d 2022 6c69      prefix = "li
+00018bc0: 6222 0a20 2020 2020 2020 2070 6f73 7466  b".        postf
+00018bd0: 6978 203d 2022 2e64 796c 6962 220a 2020  ix = ".dylib".  
+00018be0: 2020 656c 6966 2073 7973 2e70 6c61 7466    elif sys.platf
+00018bf0: 6f72 6d20 3d3d 2022 7769 6e33 3222 3a0a  orm == "win32":.
+00018c00: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
+00018c10: 2022 220a 2020 2020 2020 2020 706f 7374   "".        post
+00018c20: 6669 7820 3d20 222e 646c 6c22 0a20 2020  fix = ".dll".   
+00018c30: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
+00018c40: 7265 6669 7820 3d20 226c 6962 220a 2020  refix = "lib".  
+00018c50: 2020 2020 2020 706f 7374 6669 7820 3d20        postfix = 
+00018c60: 222e 736f 220a 2020 2020 666f 7220 7061  ".so".    for pa
+00018c70: 7468 2069 6e20 6765 745f 6c64 5f70 6174  th in get_ld_pat
+00018c80: 6873 2829 3a0a 2020 2020 2020 2020 666e  hs():.        fn
+00018c90: 203d 2022 2573 2f25 7325 7325 7322 2025   = "%s/%s%s%s" %
+00018ca0: 2028 7061 7468 2c20 7072 6566 6978 2c20   (path, prefix, 
+00018cb0: 6c69 625f 6e61 6d65 2c20 706f 7374 6669  lib_name, postfi
+00018cc0: 7829 0a20 2020 2020 2020 2069 6620 6f73  x).        if os
+00018cd0: 2e70 6174 682e 6578 6973 7473 2866 6e29  .path.exists(fn)
+00018ce0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00018cf0: 7475 726e 2066 6e0a 2020 2020 7265 7475  turn fn.    retu
+00018d00: 726e 204e 6f6e 650a 0a0a 6465 6620 7265  rn None...def re
+00018d10: 6164 5f73 6765 5f6e 756d 5f70 726f 6373  ad_sge_num_procs
+00018d20: 286a 6f62 5f69 643d 4e6f 6e65 293a 0a20  (job_id=None):. 
+00018d30: 2020 2022 2222 0a20 2020 2046 726f 6d20     """.    From 
+00018d40: 7468 6520 5375 6e20 4772 6964 2045 6e67  the Sun Grid Eng
+00018d50: 696e 6520 2853 4745 292c 2072 6561 6473  ine (SGE), reads
+00018d60: 2074 6865 206e 756d 5f70 726f 6320 7365   the num_proc se
+00018d70: 7474 696e 6720 666f 7220 6120 7061 7274  tting for a part
+00018d80: 6963 756c 6172 206a 6f62 2e0a 2020 2020  icular job..    
+00018d90: 4966 206a 6f62 5f69 6420 6973 206e 6f74  If job_id is not
+00018da0: 2070 726f 7669 6465 6420 616e 6420 7468   provided and th
+00018db0: 6520 4a4f 425f 4944 2065 6e76 2069 7320  e JOB_ID env is 
+00018dc0: 7365 742c 2069 7420 7769 6c6c 2075 7365  set, it will use
+00018dd0: 2074 6861 7420 696e 7374 6561 6420 2869   that instead (i
+00018de0: 2e65 2e20 6974 2075 7365 7320 7468 6520  .e. it uses the 
+00018df0: 6375 7272 656e 7420 6a6f 6229 2e0a 2020  current job)..  
+00018e00: 2020 5468 6973 2063 616c 6c73 2071 7374    This calls qst
+00018e10: 6174 2074 6f20 6669 6775 7265 206f 7574  at to figure out
+00018e20: 2074 6869 7320 7365 7474 696e 672e 2054   this setting. T
+00018e30: 6865 7265 2061 7265 206d 756c 7469 706c  here are multipl
+00018e40: 6520 7761 7973 2074 6869 7320 6361 6e20  e ways this can 
+00018e50: 676f 2077 726f 6e67 2c0a 2020 2020 736f  go wrong,.    so
+00018e60: 2062 6574 7465 7220 6361 7463 6820 616e   better catch an
+00018e70: 7920 6578 6365 7074 696f 6e2e 0a0a 2020  y exception...  
+00018e80: 2020 3a70 6172 616d 2069 6e74 7c4e 6f6e    :param int|Non
+00018e90: 6520 6a6f 625f 6964 3a0a 2020 2020 3a72  e job_id:.    :r
+00018ea0: 6574 7572 6e3a 206e 756d 5f70 726f 630a  eturn: num_proc.
+00018eb0: 2020 2020 3a72 7479 7065 3a20 696e 747c      :rtype: int|
+00018ec0: 4e6f 6e65 0a20 2020 2022 2222 0a20 2020  None.    """.   
+00018ed0: 2069 6620 6e6f 7420 6a6f 625f 6964 3a0a   if not job_id:.
+00018ee0: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
+00018ef0: 732e 656e 7669 726f 6e2e 6765 7428 2253  s.environ.get("S
+00018f00: 4745 5f52 4f4f 5422 293a 0a20 2020 2020  GE_ROOT"):.     
+00018f10: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+00018f20: 6e65 0a20 2020 2020 2020 2074 7279 3a0a  ne.        try:.
+00018f30: 2020 2020 2020 2020 2020 2020 2320 7169              # qi
+00018f40: 6e74 2e70 7920 6d69 6768 7420 6f76 6572  nt.py might over
+00018f50: 7772 6974 6520 4a4f 425f 4944 2062 7574  write JOB_ID but
+00018f60: 2073 6574 7320 5347 455f 4a4f 425f 4944   sets SGE_JOB_ID
+00018f70: 2069 6e73 7465 6164 2e0a 2020 2020 2020   instead..      
+00018f80: 2020 2020 2020 6a6f 625f 6964 203d 2069        job_id = i
+00018f90: 6e74 286f 732e 656e 7669 726f 6e2e 6765  nt(os.environ.ge
+00018fa0: 7428 2253 4745 5f4a 4f42 5f49 4422 2920  t("SGE_JOB_ID") 
+00018fb0: 6f72 206f 732e 656e 7669 726f 6e2e 6765  or os.environ.ge
+00018fc0: 7428 224a 4f42 5f49 4422 2920 6f72 2030  t("JOB_ID") or 0
+00018fd0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00018fe0: 2056 616c 7565 4572 726f 7220 6173 2065   ValueError as e
+00018ff0: 7863 3a0a 2020 2020 2020 2020 2020 2020  xc:.            
+00019000: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+00019010: 2272 6561 645f 7367 655f 6e75 6d5f 7072  "read_sge_num_pr
+00019020: 6f63 733a 2025 722c 2069 6e76 616c 6964  ocs: %r, invalid
+00019030: 204a 4f42 5f49 443a 2025 7222 2025 2028   JOB_ID: %r" % (
+00019040: 6578 632c 206f 732e 656e 7669 726f 6e2e  exc, os.environ.
+00019050: 6765 7428 224a 4f42 5f49 4422 2929 290a  get("JOB_ID"))).
+00019060: 2020 2020 2020 2020 6966 206e 6f74 206a          if not j
+00019070: 6f62 5f69 643a 0a20 2020 2020 2020 2020  ob_id:.         
+00019080: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+00019090: 2020 2066 726f 6d20 7375 6270 726f 6365     from subproce
+000190a0: 7373 2069 6d70 6f72 7420 506f 7065 6e2c  ss import Popen,
+000190b0: 2050 4950 452c 2043 616c 6c65 6450 726f   PIPE, CalledPro
+000190c0: 6365 7373 4572 726f 720a 0a20 2020 2073  cessError..    s
+000190d0: 6765 5f63 6d64 203d 205b 2271 7374 6174  ge_cmd = ["qstat
+000190e0: 222c 2022 2d6a 222c 2073 7472 286a 6f62  ", "-j", str(job
+000190f0: 5f69 6429 5d0a 2020 2020 7072 6f63 203d  _id)].    proc =
+00019100: 2050 6f70 656e 2873 6765 5f63 6d64 2c20   Popen(sge_cmd, 
+00019110: 7374 646f 7574 3d50 4950 4529 0a20 2020  stdout=PIPE).   
+00019120: 2073 7464 6f75 742c 205f 203d 2070 726f   stdout, _ = pro
+00019130: 632e 636f 6d6d 756e 6963 6174 6528 290a  c.communicate().
+00019140: 2020 2020 6966 2070 726f 632e 7265 7475      if proc.retu
+00019150: 726e 636f 6465 3a0a 2020 2020 2020 2020  rncode:.        
+00019160: 7261 6973 6520 4361 6c6c 6564 5072 6f63  raise CalledProc
+00019170: 6573 7345 7272 6f72 2870 726f 632e 7265  essError(proc.re
+00019180: 7475 726e 636f 6465 2c20 7367 655f 636d  turncode, sge_cm
+00019190: 642c 2073 7464 6f75 7429 0a20 2020 2073  d, stdout).    s
+000191a0: 7464 6f75 7420 3d20 7374 646f 7574 2e64  tdout = stdout.d
+000191b0: 6563 6f64 6528 2275 7466 3822 290a 2020  ecode("utf8").  
+000191c0: 2020 6c73 203d 205b 0a20 2020 2020 2020    ls = [.       
+000191d0: 206c 696e 655b 6c65 6e28 2268 6172 6420   line[len("hard 
+000191e0: 7265 736f 7572 6365 5f6c 6973 743a 2229  resource_list:")
+000191f0: 203a 5d2e 7374 7269 7028 290a 2020 2020   :].strip().    
+00019200: 2020 2020 666f 7220 6c69 6e65 2069 6e20      for line in 
+00019210: 7374 646f 7574 2e73 706c 6974 6c69 6e65  stdout.splitline
+00019220: 7328 290a 2020 2020 2020 2020 6966 206c  s().        if l
+00019230: 696e 652e 7374 6172 7473 7769 7468 2822  ine.startswith("
+00019240: 6861 7264 2072 6573 6f75 7263 655f 6c69  hard resource_li
+00019250: 7374 3a22 290a 2020 2020 5d0a 2020 2020  st:").    ].    
+00019260: 6173 7365 7274 206c 656e 286c 7329 203d  assert len(ls) =
+00019270: 3d20 310a 2020 2020 6f70 7473 203d 2064  = 1.    opts = d
+00019280: 6963 7428 5b6f 7074 2e73 706c 6974 2822  ict([opt.split("
+00019290: 3d22 2c20 3129 2066 6f72 206f 7074 2069  =", 1) for opt i
+000192a0: 6e20 6c73 5b30 5d2e 7370 6c69 7428 222c  n ls[0].split(",
+000192b0: 2229 5d29 2020 2320 6e6f 7161 0a20 2020  ")])  # noqa.   
+000192c0: 2074 7279 3a0a 2020 2020 2020 2020 7265   try:.        re
+000192d0: 7475 726e 2069 6e74 286f 7074 735b 226e  turn int(opts["n
+000192e0: 756d 5f70 726f 6322 5d29 0a20 2020 2065  um_proc"]).    e
+000192f0: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
+00019300: 2061 7320 6578 633a 0a20 2020 2020 2020   as exc:.       
+00019310: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+00019320: 280a 2020 2020 2020 2020 2020 2020 2272  (.            "r
+00019330: 6561 645f 7367 655f 6e75 6d5f 7072 6f63  ead_sge_num_proc
+00019340: 733a 2025 722c 2069 6e76 616c 6964 206e  s: %r, invalid n
+00019350: 756d 5f70 726f 6320 2572 2066 6f72 206a  um_proc %r for j
+00019360: 6f62 2069 6420 2569 2e5c 6e6c 696e 653a  ob id %i.\nline:
+00019370: 2025 7222 0a20 2020 2020 2020 2020 2020   %r".           
+00019380: 2025 2028 6578 632c 206f 7074 735b 226e   % (exc, opts["n
+00019390: 756d 5f70 726f 6322 5d2c 206a 6f62 5f69  um_proc"], job_i
+000193a0: 642c 206c 735b 305d 290a 2020 2020 2020  d, ls[0]).      
+000193b0: 2020 290a 0a0a 6465 6620 6765 745f 6e75    )...def get_nu
+000193c0: 6d62 6572 5f61 7661 696c 6162 6c65 5f63  mber_available_c
+000193d0: 7075 7328 293a 0a20 2020 2022 2222 0a20  pus():.    """. 
+000193e0: 2020 203a 7265 7475 726e 3a20 6e75 6d62     :return: numb
+000193f0: 6572 206f 6620 6176 6169 6c61 626c 6520  er of available 
+00019400: 4350 5573 2c20 6966 2077 6520 6361 6e20  CPUs, if we can 
+00019410: 6669 6775 7265 2069 7420 6f75 740a 2020  figure it out.  
+00019420: 2020 3a72 7479 7065 3a20 696e 747c 4e6f    :rtype: int|No
+00019430: 6e65 0a20 2020 2022 2222 0a20 2020 2069  ne.    """.    i
+00019440: 6620 6861 7361 7474 7228 6f73 2c20 2273  f hasattr(os, "s
+00019450: 6368 6564 5f67 6574 6166 6669 6e69 7479  ched_getaffinity
+00019460: 2229 3a20 2023 2050 7974 686f 6e20 3e3d  "):  # Python >=
+00019470: 332e 340a 2020 2020 2020 2020 7265 7475  3.4.        retu
+00019480: 726e 206c 656e 286f 732e 7363 6865 645f  rn len(os.sched_
+00019490: 6765 7461 6666 696e 6974 7928 3029 290a  getaffinity(0)).
+000194a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000194b0: 2023 206e 6f69 6e73 7065 6374 696f 6e20   # noinspection 
+000194c0: 5079 5061 636b 6167 6552 6571 7569 7265  PyPackageRequire
+000194d0: 6d65 6e74 732c 5079 556e 7265 736f 6c76  ments,PyUnresolv
+000194e0: 6564 5265 6665 7265 6e63 6573 0a20 2020  edReferences.   
+000194f0: 2020 2020 2069 6d70 6f72 7420 7073 7574       import psut
+00019500: 696c 0a0a 2020 2020 2020 2020 7072 6f63  il..        proc
+00019510: 203d 2070 7375 7469 6c2e 5072 6f63 6573   = psutil.Proces
+00019520: 7328 290a 2020 2020 2020 2020 6966 2068  s().        if h
+00019530: 6173 6174 7472 2870 726f 632c 2022 6370  asattr(proc, "cp
+00019540: 755f 6166 6669 6e69 7479 2229 3a0a 2020  u_affinity"):.  
+00019550: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00019560: 206c 656e 2870 726f 632e 6370 755f 6166   len(proc.cpu_af
+00019570: 6669 6e69 7479 2829 290a 2020 2020 6578  finity()).    ex
+00019580: 6365 7074 2049 6d70 6f72 7445 7272 6f72  cept ImportError
+00019590: 3a0a 2020 2020 2020 2020 7061 7373 0a20  :.        pass. 
+000195a0: 2020 2069 6620 6861 7361 7474 7228 6f73     if hasattr(os
+000195b0: 2c20 2273 7973 636f 6e66 2229 2061 6e64  , "sysconf") and
+000195c0: 2022 5343 5f4e 5052 4f43 4553 534f 5253   "SC_NPROCESSORS
+000195d0: 5f4f 4e4c 4e22 2069 6e20 6f73 2e73 7973  _ONLN" in os.sys
+000195e0: 636f 6e66 5f6e 616d 6573 3a0a 2020 2020  conf_names:.    
+000195f0: 2020 2020 7265 7475 726e 206f 732e 7379      return os.sy
+00019600: 7363 6f6e 6628 2253 435f 4e50 524f 4345  sconf("SC_NPROCE
+00019610: 5353 4f52 535f 4f4e 4c4e 2229 0a20 2020  SSORS_ONLN").   
+00019620: 2069 6620 6861 7361 7474 7228 6f73 2c20   if hasattr(os, 
+00019630: 2263 7075 5f63 6f75 6e74 2229 3a20 2023  "cpu_count"):  #
+00019640: 2050 7974 686f 6e20 3e3d 332e 340a 2020   Python >=3.4.  
+00019650: 2020 2020 2020 7265 7475 726e 206f 732e        return os.
+00019660: 6370 755f 636f 756e 7428 2920 2023 206e  cpu_count()  # n
+00019670: 6f74 2071 7569 7465 2063 6f72 7265 6374  ot quite correct
+00019680: 3b20 7468 6174 2061 7265 2061 6c6c 2069  ; that are all i
+00019690: 6e20 7468 6520 7379 7374 656d 0a20 2020  n the system.   
+000196a0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 0a64   return None...d
+000196b0: 6566 2067 7565 7373 5f72 6571 7565 7374  ef guess_request
+000196c0: 6564 5f6d 6178 5f6e 756d 5f74 6872 6561  ed_max_num_threa
+000196d0: 6473 286c 6f67 5f66 696c 653d 4e6f 6e65  ds(log_file=None
+000196e0: 2c20 6661 6c6c 6261 636b 5f6e 756d 5f63  , fallback_num_c
+000196f0: 7075 733d 5472 7565 293a 0a20 2020 2022  pus=True):.    "
+00019700: 2222 0a20 2020 203a 7061 7261 6d20 696f  "".    :param io
+00019710: 2e46 696c 6520 6c6f 675f 6669 6c65 3a0a  .File log_file:.
+00019720: 2020 2020 3a70 6172 616d 2062 6f6f 6c20      :param bool 
+00019730: 6661 6c6c 6261 636b 5f6e 756d 5f63 7075  fallback_num_cpu
+00019740: 733a 0a20 2020 203a 7274 7970 653a 2069  s:.    :rtype: i
+00019750: 6e74 7c4e 6f6e 650a 2020 2020 2222 220a  nt|None.    """.
+00019760: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00019770: 2073 6765 5f6e 756d 5f70 726f 6373 203d   sge_num_procs =
+00019780: 2072 6561 645f 7367 655f 6e75 6d5f 7072   read_sge_num_pr
+00019790: 6f63 7328 290a 2020 2020 6578 6365 7074  ocs().    except
+000197a0: 2045 7863 6570 7469 6f6e 2061 7320 6578   Exception as ex
+000197b0: 633a 0a20 2020 2020 2020 2069 6620 6c6f  c:.        if lo
+000197c0: 675f 6669 6c65 3a0a 2020 2020 2020 2020  g_file:.        
+000197d0: 2020 2020 7072 696e 7428 2245 7272 6f72      print("Error
+000197e0: 2077 6869 6c65 2067 6574 7469 6e67 2053   while getting S
+000197f0: 4745 206e 756d 5f70 726f 633a 2025 7222  GE num_proc: %r"
+00019800: 2025 2065 7863 2c20 6669 6c65 3d6c 6f67   % exc, file=log
+00019810: 5f66 696c 6529 0a20 2020 2065 6c73 653a  _file).    else:
+00019820: 0a20 2020 2020 2020 2069 6620 7367 655f  .        if sge_
+00019830: 6e75 6d5f 7072 6f63 733a 0a20 2020 2020  num_procs:.     
+00019840: 2020 2020 2020 2069 6620 6c6f 675f 6669         if log_fi
+00019850: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00019860: 2020 2020 7072 696e 7428 2255 7365 206e      print("Use n
+00019870: 756d 5f74 6872 6561 6473 3d25 6920 2862  um_threads=%i (b
+00019880: 7574 206d 696e 2032 2920 7669 6120 5347  ut min 2) via SG
+00019890: 4520 6e75 6d5f 7072 6f63 2e22 2025 2073  E num_proc." % s
+000198a0: 6765 5f6e 756d 5f70 726f 6373 2c20 6669  ge_num_procs, fi
+000198b0: 6c65 3d6c 6f67 5f66 696c 6529 0a20 2020  le=log_file).   
+000198c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000198d0: 6d61 7828 7367 655f 6e75 6d5f 7072 6f63  max(sge_num_proc
+000198e0: 732c 2032 290a 2020 2020 6f6d 705f 6e75  s, 2).    omp_nu
+000198f0: 6d5f 7468 7265 6164 7320 3d20 696e 7428  m_threads = int(
+00019900: 6f73 2e65 6e76 6972 6f6e 2e67 6574 2822  os.environ.get("
+00019910: 4f4d 505f 4e55 4d5f 5448 5245 4144 5322  OMP_NUM_THREADS"
+00019920: 2920 6f72 2030 290a 2020 2020 6966 206f  ) or 0).    if o
+00019930: 6d70 5f6e 756d 5f74 6872 6561 6473 3a0a  mp_num_threads:.
+00019940: 2020 2020 2020 2020 2320 4d69 6e69 6d75          # Minimu
+00019950: 6d20 6f66 2032 2074 6872 6561 6473 2c20  m of 2 threads, 
+00019960: 7368 6f75 6c64 206e 6f74 2068 7572 742e  should not hurt.
+00019970: 0a20 2020 2020 2020 2069 6620 6c6f 675f  .        if log_
+00019980: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+00019990: 2020 7072 696e 7428 2255 7365 206e 756d    print("Use num
+000199a0: 5f74 6872 6561 6473 3d25 6920 2862 7574  _threads=%i (but
+000199b0: 206d 696e 2032 2920 7669 6120 4f4d 505f   min 2) via OMP_
+000199c0: 4e55 4d5f 5448 5245 4144 532e 2220 2520  NUM_THREADS." % 
+000199d0: 6f6d 705f 6e75 6d5f 7468 7265 6164 732c  omp_num_threads,
+000199e0: 2066 696c 653d 6c6f 675f 6669 6c65 290a   file=log_file).
+000199f0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+00019a00: 6178 286f 6d70 5f6e 756d 5f74 6872 6561  ax(omp_num_threa
+00019a10: 6473 2c20 3229 0a20 2020 2069 6620 6661  ds, 2).    if fa
+00019a20: 6c6c 6261 636b 5f6e 756d 5f63 7075 733a  llback_num_cpus:
+00019a30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00019a40: 6765 745f 6e75 6d62 6572 5f61 7661 696c  get_number_avail
+00019a50: 6162 6c65 5f63 7075 7328 290a 2020 2020  able_cpus().    
+00019a60: 7265 7475 726e 204e 6f6e 650a 0a0a 5468  return None...Th
+00019a70: 6561 6e6f 466c 6167 7320 3d20 7b0a 2020  eanoFlags = {.  
+00019a80: 2020 6b65 793a 2076 616c 7565 2066 6f72    key: value for
+00019a90: 2028 6b65 792c 2076 616c 7565 2920 696e   (key, value) in
+00019aa0: 205b 732e 7370 6c69 7428 223d 222c 2031   [s.split("=", 1
+00019ab0: 2920 666f 7220 7320 696e 206f 732e 656e  ) for s in os.en
+00019ac0: 7669 726f 6e2e 6765 7428 2254 4845 414e  viron.get("THEAN
+00019ad0: 4f5f 464c 4147 5322 2c20 2222 292e 7370  O_FLAGS", "").sp
+00019ae0: 6c69 7428 222c 2229 2069 6620 735d 0a7d  lit(",") if s].}
+00019af0: 0a0a 0a64 6566 205f 636f 6e73 6964 6572  ...def _consider
+00019b00: 5f63 6865 636b 5f66 6f72 5f67 7075 2829  _check_for_gpu()
+00019b10: 3a0a 2020 2020 2222 220a 2020 2020 5468  :.    """.    Th
+00019b20: 6572 6520 6172 6520 6361 7365 7320 7768  ere are cases wh
+00019b30: 6572 6520 6e76 6964 6961 2d73 6d69 2063  ere nvidia-smi c
+00019b40: 6f75 6c64 2068 616e 672e 0a20 2020 2028  ould hang..    (
+00019b50: 416e 7920 7265 6164 206f 6620 2f70 726f  Any read of /pro
+00019b60: 632f 6d6f 6475 6c65 7320 6d69 6768 7420  c/modules might 
+00019b70: 6861 6e67 2069 6e20 7468 6174 2063 6173  hang in that cas
+00019b80: 652c 206d 6179 6265 2063 6175 7365 640a  e, maybe caused.
+00019b90: 2020 2020 2062 7920 7472 7969 6e67 2074       by trying t
+00019ba0: 6f20 606d 6f64 7072 6f62 6520 6e76 6964  o `modprobe nvid
+00019bb0: 6961 6020 746f 2063 6865 636b 2069 6620  ia` to check if 
+00019bc0: 7468 6572 6520 6973 2061 204e 7669 6469  there is a Nvidi
+00019bd0: 6120 6361 7264 2e29 0a20 2020 2054 6869  a card.).    Thi
+00019be0: 7320 736f 6d65 7469 6d65 7320 6861 7070  s sometimes happ
+00019bf0: 656e 7320 696e 206f 7572 2053 4745 2063  ens in our SGE c
+00019c00: 6c75 7374 6572 206f 6e20 6e6f 6465 7320  luster on nodes 
+00019c10: 7769 7468 6f75 7420 4e76 6964 6961 2063  without Nvidia c
+00019c20: 6172 6473 2e0a 2020 2020 4d61 7962 6520  ards..    Maybe 
+00019c30: 6974 2773 2061 6c73 6f20 6120 4c69 6e75  it's also a Linu
+00019c40: 7820 4b65 726e 656c 2062 7567 2e0a 2020  x Kernel bug..  
+00019c50: 2020 416e 7977 6179 2c20 6a75 7374 2061    Anyway, just a
+00019c60: 766f 6964 2061 6e79 2073 7563 6820 6368  void any such ch
+00019c70: 6563 6b20 6966 2077 6520 646f 6e27 7420  eck if we don't 
+00019c80: 6173 6b65 6420 666f 7220 6120 4750 552e  asked for a GPU.
+00019c90: 0a0a 2020 2020 3a72 7479 7065 3a20 626f  ..    :rtype: bo
+00019ca0: 6f6c 0a20 2020 2022 2222 0a20 2020 2069  ol.    """.    i
+00019cb0: 6620 2264 6576 6963 6522 2069 6e20 5468  f "device" in Th
+00019cc0: 6561 6e6f 466c 6167 733a 0a20 2020 2020  eanoFlags:.     
+00019cd0: 2020 2064 6576 203d 2054 6865 616e 6f46     dev = TheanoF
+00019ce0: 6c61 6773 5b22 6465 7669 6365 225d 0a20  lags["device"]. 
+00019cf0: 2020 2020 2020 2069 6620 6465 762e 7374         if dev.st
+00019d00: 6172 7473 7769 7468 2822 6770 7522 2920  artswith("gpu") 
+00019d10: 6f72 2064 6576 2e73 7461 7274 7377 6974  or dev.startswit
+00019d20: 6828 2263 7564 6122 293a 0a20 2020 2020  h("cuda"):.     
+00019d30: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00019d40: 7565 0a20 2020 2020 2020 2023 2054 4845  ue.        # THE
+00019d50: 414e 4f5f 464c 4147 5320 7769 6c6c 206f  ANO_FLAGS will o
+00019d60: 7665 7277 7269 7465 2074 6869 7320 636f  verwrite this co
+00019d70: 6e66 6967 206f 7074 696f 6e2e 2053 6565  nfig option. See
+00019d80: 2072 6e6e 2e69 6e69 7444 6576 6963 6573   rnn.initDevices
+00019d90: 2829 2e0a 2020 2020 2020 2020 7265 7475  ()..        retu
+00019da0: 726e 2046 616c 7365 0a20 2020 2023 206e  rn False.    # n
+00019db0: 6f69 6e73 7065 6374 696f 6e20 5079 4272  oinspection PyBr
+00019dc0: 6f61 6445 7863 6570 7469 6f6e 0a20 2020  oadException.   
+00019dd0: 2074 7279 3a0a 2020 2020 2020 2020 6672   try:.        fr
+00019de0: 6f6d 2072 6574 7572 6e6e 2e63 6f6e 6669  om returnn.confi
+00019df0: 6720 696d 706f 7274 2067 6574 5f67 6c6f  g import get_glo
+00019e00: 6261 6c5f 636f 6e66 6967 0a0a 2020 2020  bal_config..    
+00019e10: 2020 2020 636f 6e66 6967 203d 2067 6574      config = get
+00019e20: 5f67 6c6f 6261 6c5f 636f 6e66 6967 2829  _global_config()
+00019e30: 0a20 2020 2065 7863 6570 7420 4578 6365  .    except Exce
+00019e40: 7074 696f 6e3a 0a20 2020 2020 2020 2063  ption:.        c
+00019e50: 6f6e 6669 6720 3d20 4e6f 6e65 0a20 2020  onfig = None.   
+00019e60: 2069 6620 636f 6e66 6967 3a0a 2020 2020   if config:.    
+00019e70: 2020 2020 666f 7220 6465 7620 696e 2063      for dev in c
+00019e80: 6f6e 6669 672e 6c69 7374 2822 6465 7669  onfig.list("devi
+00019e90: 6365 222c 205b 5d29 3a0a 2020 2020 2020  ce", []):.      
+00019ea0: 2020 2020 2020 6966 2064 6576 2e73 7461        if dev.sta
+00019eb0: 7274 7377 6974 6828 2267 7075 2229 206f  rtswith("gpu") o
+00019ec0: 7220 6465 762e 7374 6172 7473 7769 7468  r dev.startswith
+00019ed0: 2822 6375 6461 2229 3a0a 2020 2020 2020  ("cuda"):.      
+00019ee0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00019ef0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+00019f00: 2020 6966 2064 6576 203d 3d20 2261 6c6c    if dev == "all
+00019f10: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00019f20: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
+00019f30: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00019f40: 0a0a 6465 6620 6765 745f 6370 755f 6d6f  ..def get_cpu_mo
+00019f50: 6465 6c5f 6e61 6d65 2829 202d 3e20 7374  del_name() -> st
+00019f60: 723a 0a20 2020 2022 2222 0a20 2020 203a  r:.    """.    :
+00019f70: 7265 7475 726e 3a20 652e 672e 2022 496e  return: e.g. "In
+00019f80: 7465 6c28 5229 2043 6f72 6528 544d 2920  tel(R) Core(TM) 
+00019f90: 6935 2d38 3530 3020 4350 5520 4020 332e  i5-8500 CPU @ 3.
+00019fa0: 3030 4748 7a22 2076 6961 202f 7072 6f63  00GHz" via /proc
+00019fb0: 2f63 7075 696e 666f 2e20 6661 6c6c 7320  /cpuinfo. falls 
+00019fc0: 6261 636b 2074 6f20 706c 6174 666f 726d  back to platform
+00019fd0: 2e70 726f 6365 7373 6f72 2829 2e0a 2020  .processor()..  
+00019fe0: 2020 2222 220a 2020 2020 6966 206f 732e    """.    if os.
+00019ff0: 7061 7468 2e65 7869 7374 7328 222f 7072  path.exists("/pr
+0001a000: 6f63 2f63 7075 696e 666f 2229 3a0a 2020  oc/cpuinfo"):.  
+0001a010: 2020 2020 2020 666f 7220 6c69 6e65 2069        for line i
+0001a020: 6e20 6f70 656e 2822 2f70 726f 632f 6370  n open("/proc/cp
+0001a030: 7569 6e66 6f22 292e 7265 6164 2829 2e73  uinfo").read().s
+0001a040: 706c 6974 6c69 6e65 7328 293a 0a20 2020  plitlines():.   
+0001a050: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001a060: 6c69 6e65 2e73 7461 7274 7377 6974 6828  line.startswith(
+0001a070: 226d 6f64 656c 206e 616d 6522 293a 0a20  "model name"):. 
+0001a080: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001a090: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+0001a0a0: 2020 2020 6b65 792c 2076 616c 7565 203d      key, value =
+0001a0b0: 206c 696e 652e 7370 6c69 7428 223a 222c   line.split(":",
+0001a0c0: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
+0001a0d0: 6b65 792c 2076 616c 7565 203d 206b 6579  key, value = key
+0001a0e0: 2e73 7472 6970 2829 2c20 7661 6c75 652e  .strip(), value.
+0001a0f0: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
+0001a100: 2020 2020 6173 7365 7274 206b 6579 203d      assert key =
+0001a110: 3d20 226d 6f64 656c 206e 616d 6522 0a20  = "model name". 
+0001a120: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001a130: 6e20 7661 6c75 650a 0a20 2020 2069 6d70  n value..    imp
+0001a140: 6f72 7420 706c 6174 666f 726d 0a0a 2020  ort platform..  
+0001a150: 2020 7265 7475 726e 2070 6c61 7466 6f72    return platfor
+0001a160: 6d2e 7072 6f63 6573 736f 7228 290a 0a0a  m.processor()...
+0001a170: 6465 6620 6765 745f 6770 755f 6e61 6d65  def get_gpu_name
+0001a180: 7328 293a 0a20 2020 2022 2222 0a20 2020  s():.    """.   
+0001a190: 203a 7274 7970 653a 206c 6973 745b 7374   :rtype: list[st
+0001a1a0: 725d 0a20 2020 2022 2222 0a20 2020 2069  r].    """.    i
+0001a1b0: 6620 6e6f 7420 5f63 6f6e 7369 6465 725f  f not _consider_
+0001a1c0: 6368 6563 6b5f 666f 725f 6770 7528 293a  check_for_gpu():
+0001a1d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001a1e0: 5b5d 0a20 2020 2069 6620 6f73 2e6e 616d  [].    if os.nam
+0001a1f0: 6520 3d3d 2022 6e74 223a 0a20 2020 2020  e == "nt":.     
+0001a200: 2020 2072 6574 7572 6e20 2247 6546 6f72     return "GeFor
+0001a210: 6365 2047 5458 2037 3730 2220 2023 2054  ce GTX 770"  # T
+0001a220: 4f44 4f0a 2020 2020 656c 6966 2073 7973  ODO.    elif sys
+0001a230: 2e70 6c61 7466 6f72 6d20 3d3d 2022 6461  .platform == "da
+0001a240: 7277 696e 223a 0a20 2020 2020 2020 2023  rwin":.        #
+0001a250: 2054 4f44 4f20 7061 7273 6520 7669 6120   TODO parse via 
+0001a260: 786d 6c20 6f75 7470 7574 0a20 2020 2020  xml output.     
+0001a270: 2020 2072 6574 7572 6e20 7379 735f 636d     return sys_cm
+0001a280: 645f 6f75 745f 6c69 6e65 7328 0a20 2020  d_out_lines(.   
+0001a290: 2020 2020 2020 2020 2022 7379 7374 656d           "system
+0001a2a0: 5f70 726f 6669 6c65 7220 5350 4469 7370  _profiler SPDisp
+0001a2b0: 6c61 7973 4461 7461 5479 7065 207c 2022  laysDataType | "
+0001a2c0: 0a20 2020 2020 2020 2020 2020 2022 6772  .            "gr
+0001a2d0: 6570 2027 4368 6970 7365 7420 4d6f 6465  ep 'Chipset Mode
+0001a2e0: 6c3a 204e 5649 4449 4127 207c 2022 0a20  l: NVIDIA' | ". 
+0001a2f0: 2020 2020 2020 2020 2020 2022 7365 6420             "sed 
+0001a300: 2773 2f2e 2a43 6869 7073 6574 204d 6f64  's/.*Chipset Mod
+0001a310: 656c 3a20 4e56 4944 4941 202a 2f2f 3b73  el: NVIDIA *//;s
+0001a320: 2f20 2a24 2f2f 2722 0a20 2020 2020 2020  / *$//'".       
+0001a330: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
+0001a340: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001a350: 2020 2020 2020 7265 7475 726e 2073 7973        return sys
+0001a360: 5f63 6d64 5f6f 7574 5f6c 696e 6573 2822  _cmd_out_lines("
+0001a370: 6e76 6964 6961 2d73 6d69 202d 4c20 7c20  nvidia-smi -L | 
+0001a380: 6375 7420 2d64 2027 2827 202d 6620 3120  cut -d '(' -f 1 
+0001a390: 7c20 6375 7420 2d64 2027 2027 202d 6620  | cut -d ' ' -f 
+0001a3a0: 332d 207c 2073 6564 202d 6520 2773 2f5c  3- | sed -e 's/\
+0001a3b0: 5c20 242f 2f27 2229 0a20 2020 2020 2020  \ $//'").       
+0001a3c0: 2065 7863 6570 7420 4361 6c6c 6564 5072   except CalledPr
+0001a3d0: 6f63 6573 7345 7272 6f72 3a0a 2020 2020  ocessError:.    
+0001a3e0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+0001a3f0: 5d0a 0a0a 6465 6620 5f67 6574 5f6e 756d  ]...def _get_num
+0001a400: 5f67 7075 5f64 6576 6963 6573 2829 3a0a  _gpu_devices():.
+0001a410: 2020 2020 2222 220a 2020 2020 3a72 6574      """.    :ret
+0001a420: 7572 6e3a 2063 7075 2c67 7075 0a20 2020  urn: cpu,gpu.   
+0001a430: 203a 7274 7970 653a 2028 696e 742c 696e   :rtype: (int,in
+0001a440: 7429 0a20 2020 2022 2222 0a20 2020 2069  t).    """.    i
+0001a450: 6620 6f73 2e6e 616d 6520 3d3d 2022 6e74  f os.name == "nt
+0001a460: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
+0001a470: 6e20 312c 2031 2020 2320 544f 444f 0a20  n 1, 1  # TODO. 
+0001a480: 2020 2065 6c69 6620 7379 732e 706c 6174     elif sys.plat
+0001a490: 666f 726d 203d 3d20 2264 6172 7769 6e22  form == "darwin"
+0001a4a0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001a4b0: 2028 0a20 2020 2020 2020 2020 2020 2069   (.            i
+0001a4c0: 6e74 2873 7973 5f63 6d64 5f6f 7574 5f6c  nt(sys_cmd_out_l
+0001a4d0: 696e 6573 2822 7379 7363 746c 202d 6120  ines("sysctl -a 
+0001a4e0: 7c20 6772 6570 206d 6163 6864 6570 2e63  | grep machdep.c
+0001a4f0: 7075 2e63 6f72 655f 636f 756e 7420 7c20  pu.core_count | 
+0001a500: 6177 6b20 277b 7072 696e 7420 2432 7d27  awk '{print $2}'
+0001a510: 2229 5b30 5d29 2c0a 2020 2020 2020 2020  ")[0]),.        
+0001a520: 2020 2020 6c65 6e28 7379 735f 636d 645f      len(sys_cmd_
+0001a530: 6f75 745f 6c69 6e65 7328 2273 7973 7465  out_lines("syste
+0001a540: 6d5f 7072 6f66 696c 6572 2053 5044 6973  m_profiler SPDis
+0001a550: 706c 6179 7344 6174 6154 7970 6520 7c20  playsDataType | 
+0001a560: 6772 6570 2027 4368 6970 7365 7420 4d6f  grep 'Chipset Mo
+0001a570: 6465 6c3a 204e 5649 4449 4127 207c 2063  del: NVIDIA' | c
+0001a580: 6174 2229 292c 0a20 2020 2020 2020 2029  at")),.        )
+0001a590: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0001a5a0: 2020 206e 756d 5f63 7075 7320 3d20 6c65     num_cpus = le
+0001a5b0: 6e28 7379 735f 636d 645f 6f75 745f 6c69  n(sys_cmd_out_li
+0001a5c0: 6e65 7328 2263 6174 202f 7072 6f63 2f63  nes("cat /proc/c
+0001a5d0: 7075 696e 666f 207c 2067 7265 7020 7072  puinfo | grep pr
+0001a5e0: 6f63 6573 736f 7222 2929 206f 7220 310a  ocessor")) or 1.
+0001a5f0: 2020 2020 2020 2020 6e75 6d5f 6770 7573          num_gpus
+0001a600: 203d 2030 0a20 2020 2020 2020 2069 6620   = 0.        if 
+0001a610: 5f63 6f6e 7369 6465 725f 6368 6563 6b5f  _consider_check_
+0001a620: 666f 725f 6770 7528 293a 0a20 2020 2020  for_gpu():.     
+0001a630: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001a640: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+0001a650: 6770 7573 203d 206c 656e 2873 7973 5f63  gpus = len(sys_c
+0001a660: 6d64 5f6f 7574 5f6c 696e 6573 2822 6e76  md_out_lines("nv
+0001a670: 6964 6961 2d73 6d69 202d 4c22 2929 0a20  idia-smi -L")). 
+0001a680: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001a690: 7420 4361 6c6c 6564 5072 6f63 6573 7345  t CalledProcessE
+0001a6a0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0001a6b0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+0001a6c0: 2020 2072 6574 7572 6e20 6e75 6d5f 6370     return num_cp
+0001a6d0: 7573 2c20 6e75 6d5f 6770 7573 0a0a 0a5f  us, num_gpus..._
+0001a6e0: 6e75 6d5f 6465 7669 6365 7320 3d20 4e6f  num_devices = No
+0001a6f0: 6e65 0a0a 0a64 6566 2067 6574 5f6e 756d  ne...def get_num
+0001a700: 5f67 7075 5f64 6576 6963 6573 2829 3a0a  _gpu_devices():.
+0001a710: 2020 2020 2222 220a 2020 2020 3a72 6574      """.    :ret
+0001a720: 7572 6e3a 2028 6370 7520 636f 756e 742c  urn: (cpu count,
+0001a730: 2067 7075 2063 6f75 6e74 290a 2020 2020   gpu count).    
+0001a740: 3a72 7479 7065 3a20 2869 6e74 2c20 696e  :rtype: (int, in
+0001a750: 7429 0a20 2020 2022 2222 0a20 2020 2067  t).    """.    g
+0001a760: 6c6f 6261 6c20 5f6e 756d 5f64 6576 6963  lobal _num_devic
+0001a770: 6573 0a20 2020 2069 6620 5f6e 756d 5f64  es.    if _num_d
+0001a780: 6576 6963 6573 2069 7320 6e6f 7420 4e6f  evices is not No
+0001a790: 6e65 3a0a 2020 2020 2020 2020 7265 7475  ne:.        retu
+0001a7a0: 726e 205f 6e75 6d5f 6465 7669 6365 730a  rn _num_devices.
+0001a7b0: 2020 2020 5f6e 756d 5f64 6576 6963 6573      _num_devices
+0001a7c0: 203d 205f 6765 745f 6e75 6d5f 6770 755f   = _get_num_gpu_
+0001a7d0: 6465 7669 6365 7328 290a 2020 2020 7265  devices().    re
+0001a7e0: 7475 726e 205f 6e75 6d5f 6465 7669 6365  turn _num_device
+0001a7f0: 730a 0a0a 6465 6620 6861 7665 5f67 7075  s...def have_gpu
+0001a800: 2829 3a0a 2020 2020 2222 220a 2020 2020  ():.    """.    
+0001a810: 3a72 7479 7065 3a20 626f 6f6c 0a20 2020  :rtype: bool.   
+0001a820: 2022 2222 0a20 2020 2063 7075 732c 2067   """.    cpus, g
+0001a830: 7075 7320 3d20 6765 745f 6e75 6d5f 6770  pus = get_num_gp
+0001a840: 755f 6465 7669 6365 7328 290a 2020 2020  u_devices().    
+0001a850: 7265 7475 726e 2067 7075 7320 3e20 300a  return gpus > 0.
+0001a860: 0a0a 6465 6620 7472 795f 616e 645f 6967  ..def try_and_ig
+0001a870: 6e6f 7265 5f65 7863 6570 7469 6f6e 2866  nore_exception(f
+0001a880: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+0001a890: 616c 6c73 2060 6066 6060 2c20 616e 6420  alls ``f``, and 
+0001a8a0: 6967 6e6f 7265 7320 616e 7920 6578 6365  ignores any exce
+0001a8b0: 7074 696f 6e2e 0a0a 2020 2020 3a70 6172  ption...    :par
+0001a8c0: 616d 2028 292d 3e54 2066 3a0a 2020 2020  am ()->T f:.    
+0001a8d0: 3a72 6574 7572 6e3a 2077 6861 7465 7665  :return: whateve
+0001a8e0: 7220 6060 6660 6020 7265 7475 726e 732c  r ``f`` returns,
+0001a8f0: 206f 7220 4e6f 6e65 0a20 2020 203a 7274   or None.    :rt
+0001a900: 7970 653a 2054 7c4e 6f6e 650a 2020 2020  ype: T|None.    
+0001a910: 2222 220a 2020 2020 7472 793a 0a20 2020  """.    try:.   
+0001a920: 2020 2020 2072 6574 7572 6e20 6628 290a       return f().
+0001a930: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0001a940: 7469 6f6e 2061 7320 6578 633a 0a20 2020  tion as exc:.   
+0001a950: 2020 2020 2070 7269 6e74 2822 7472 795f       print("try_
+0001a960: 616e 645f 6967 6e6f 7265 5f65 7863 6570  and_ignore_excep
+0001a970: 7469 6f6e 3a20 2572 2066 6169 6c65 643a  tion: %r failed:
+0001a980: 2025 7322 2025 2028 662c 2065 7863 2929   %s" % (f, exc))
+0001a990: 0a20 2020 2020 2020 2073 7973 2e65 7863  .        sys.exc
+0001a9a0: 6570 7468 6f6f 6b28 2a73 7973 2e65 7863  epthook(*sys.exc
+0001a9b0: 5f69 6e66 6f28 2929 0a20 2020 2020 2020  _info()).       
+0001a9c0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 0a64   return None...d
+0001a9d0: 6566 2074 7279 5f67 6574 5f73 7461 636b  ef try_get_stack
+0001a9e0: 5f66 7261 6d65 2864 6570 7468 3d31 293a  _frame(depth=1):
+0001a9f0: 0a20 2020 2022 2222 0a20 2020 203a 7061  .    """.    :pa
+0001aa00: 7261 6d20 696e 7420 6465 7074 683a 0a20  ram int depth:. 
+0001aa10: 2020 203a 7274 7970 653a 2074 7970 6573     :rtype: types
+0001aa20: 2e46 7261 6d65 5479 7065 7c4e 6f6e 650a  .FrameType|None.
+0001aa30: 2020 2020 3a72 6574 7572 6e3a 2063 616c      :return: cal
+0001aa40: 6c65 7220 6675 6e63 7469 6f6e 206e 616d  ler function nam
+0001aa50: 652e 2074 6869 7320 6973 206a 7573 7420  e. this is just 
+0001aa60: 666f 7220 6465 6275 6767 696e 670a 2020  for debugging.  
+0001aa70: 2020 2222 220a 2020 2020 2320 6e6f 696e    """.    # noin
+0001aa80: 7370 6563 7469 6f6e 2050 7942 726f 6164  spection PyBroad
+0001aa90: 4578 6365 7074 696f 6e0a 2020 2020 7472  Exception.    tr
+0001aaa0: 793a 0a20 2020 2020 2020 2023 206e 6f69  y:.        # noi
+0001aab0: 6e73 7065 6374 696f 6e20 5079 5072 6f74  nspection PyProt
+0001aac0: 6563 7465 644d 656d 6265 722c 5079 556e  ectedMember,PyUn
+0001aad0: 7265 736f 6c76 6564 5265 6665 7265 6e63  resolvedReferenc
+0001aae0: 6573 0a20 2020 2020 2020 2066 7261 6d65  es.        frame
+0001aaf0: 203d 2073 7973 2e5f 6765 7466 7261 6d65   = sys._getframe
+0001ab00: 2864 6570 7468 202b 2031 2920 2023 206f  (depth + 1)  # o
+0001ab10: 6e65 206d 6f72 6520 746f 2063 6f75 6e74  ne more to count
+0001ab20: 206f 7572 7365 6c76 6573 0a20 2020 2020   ourselves.     
+0001ab30: 2020 2072 6574 7572 6e20 6672 616d 650a     return frame.
+0001ab40: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0001ab50: 7469 6f6e 3a0a 2020 2020 2020 2020 7265  tion:.        re
+0001ab60: 7475 726e 204e 6f6e 650a 0a0a 6465 6620  turn None...def 
+0001ab70: 7472 795f 6765 745f 6361 6c6c 6572 5f6e  try_get_caller_n
+0001ab80: 616d 6528 6465 7074 683d 312c 2066 616c  ame(depth=1, fal
+0001ab90: 6c62 6163 6b3d 4e6f 6e65 293a 0a20 2020  lback=None):.   
+0001aba0: 2022 2222 0a20 2020 203a 7061 7261 6d20   """.    :param 
+0001abb0: 696e 7420 6465 7074 683a 0a20 2020 203a  int depth:.    :
+0001abc0: 7061 7261 6d20 7374 727c 4e6f 6e65 2066  param str|None f
+0001abd0: 616c 6c62 6163 6b3a 2074 6869 7320 6973  allback: this is
+0001abe0: 2072 6574 7572 6e65 6420 6966 2077 6520   returned if we 
+0001abf0: 6661 696c 2066 6f72 2073 6f6d 6520 7265  fail for some re
+0001ac00: 6173 6f6e 0a20 2020 203a 7274 7970 653a  ason.    :rtype:
+0001ac10: 2073 7472 7c4e 6f6e 650a 2020 2020 3a72   str|None.    :r
+0001ac20: 6574 7572 6e3a 2063 616c 6c65 7220 6675  eturn: caller fu
+0001ac30: 6e63 7469 6f6e 206e 616d 652e 2074 6869  nction name. thi
+0001ac40: 7320 6973 206a 7573 7420 666f 7220 6465  s is just for de
+0001ac50: 6275 6767 696e 670a 2020 2020 2222 220a  bugging.    """.
+0001ac60: 2020 2020 6672 616d 6520 3d20 7472 795f      frame = try_
+0001ac70: 6765 745f 7374 6163 6b5f 6672 616d 6528  get_stack_frame(
+0001ac80: 6465 7074 6820 2b20 3129 2020 2320 6f6e  depth + 1)  # on
+0001ac90: 6520 6d6f 7265 2074 6f20 636f 756e 7420  e more to count 
+0001aca0: 6f75 7273 656c 7665 730a 2020 2020 6966  ourselves.    if
+0001acb0: 2066 7261 6d65 3a0a 2020 2020 2020 2020   frame:.        
+0001acc0: 6672 6f6d 202e 6265 7474 6572 5f65 7863  from .better_exc
+0001acd0: 686f 6f6b 2069 6d70 6f72 7420 6765 745f  hook import get_
+0001ace0: 6675 6e63 5f73 7472 5f66 726f 6d5f 636f  func_str_from_co
+0001acf0: 6465 5f6f 626a 6563 740a 0a20 2020 2020  de_object..     
+0001ad00: 2020 2072 6574 7572 6e20 6765 745f 6675     return get_fu
+0001ad10: 6e63 5f73 7472 5f66 726f 6d5f 636f 6465  nc_str_from_code
+0001ad20: 5f6f 626a 6563 7428 6672 616d 652e 665f  _object(frame.f_
+0001ad30: 636f 6465 2c20 6672 616d 653d 6672 616d  code, frame=fram
+0001ad40: 6529 0a20 2020 2072 6574 7572 6e20 6661  e).    return fa
+0001ad50: 6c6c 6261 636b 0a0a 0a64 6566 2074 7261  llback...def tra
+0001ad60: 6365 6261 636b 5f63 6c65 6172 5f66 7261  ceback_clear_fra
+0001ad70: 6d65 7328 7462 293a 0a20 2020 2022 2222  mes(tb):.    """
+0001ad80: 0a20 2020 2043 6c65 6172 2074 7261 6365  .    Clear trace
+0001ad90: 6261 636b 2066 7261 6d65 206c 6f63 616c  back frame local
+0001ada0: 732e 0a0a 2020 2020 4a75 7374 206c 696b  s...    Just lik
+0001adb0: 6520 3a66 756e 633a 6074 7261 6365 6261  e :func:`traceba
+0001adc0: 636b 2e63 6c65 6172 5f66 7261 6d65 7360  ck.clear_frames`
+0001add0: 2c20 6275 7420 6861 7320 616e 2061 6464  , but has an add
+0001ade0: 6974 696f 6e61 6c20 6669 780a 2020 2020  itional fix.    
+0001adf0: 2868 7474 7073 3a2f 2f67 6974 6875 622e  (https://github.
+0001ae00: 636f 6d2f 7079 7468 6f6e 2f63 7079 7468  com/python/cpyth
+0001ae10: 6f6e 2f69 7373 7565 732f 3131 3339 3339  on/issues/113939
+0001ae20: 292e 0a0a 2020 2020 3a70 6172 616d 2074  )...    :param t
+0001ae30: 7970 6573 2e54 7261 6365 6261 636b 5479  ypes.TracebackTy
+0001ae40: 7065 2074 623a 0a20 2020 2022 2222 0a20  pe tb:.    """. 
+0001ae50: 2020 2077 6869 6c65 2074 623a 0a20 2020     while tb:.   
+0001ae60: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001ae70: 2020 2020 2020 7462 2e74 625f 6672 616d        tb.tb_fram
+0001ae80: 652e 636c 6561 7228 290a 2020 2020 2020  e.clear().      
+0001ae90: 2020 6578 6365 7074 2052 756e 7469 6d65    except Runtime
+0001aea0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0001aeb0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+0001aec0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001aed0: 2020 2320 5573 696e 6720 7468 6973 2063    # Using this c
+0001aee0: 6f64 6520 7472 6967 6765 7273 2074 6861  ode triggers tha
+0001aef0: 7420 7468 6520 7265 6620 6163 7475 616c  t the ref actual
+0001af00: 6c79 2067 6f65 7320 6f75 7420 6f66 2073  ly goes out of s
+0001af10: 636f 7065 2c20 6f74 6865 7277 6973 6520  cope, otherwise 
+0001af20: 6974 2064 6f65 7320 6e6f 7421 0a20 2020  it does not!.   
+0001af30: 2020 2020 2020 2020 2023 2068 7474 7073           # https
+0001af40: 3a2f 2f67 6974 6875 622e 636f 6d2f 7079  ://github.com/py
+0001af50: 7468 6f6e 2f63 7079 7468 6f6e 2f69 7373  thon/cpython/iss
+0001af60: 7565 732f 3131 3339 3339 0a20 2020 2020  ues/113939.     
+0001af70: 2020 2020 2020 2074 622e 7462 5f66 7261         tb.tb_fra
+0001af80: 6d65 2e66 5f6c 6f63 616c 7320 2023 206e  me.f_locals  # n
+0001af90: 6f71 610a 2020 2020 2020 2020 7462 203d  oqa.        tb =
+0001afa0: 2074 622e 7462 5f6e 6578 740a 0a0a 636c   tb.tb_next...cl
+0001afb0: 6173 7320 496e 6669 6e69 7465 5265 6375  ass InfiniteRecu
+0001afc0: 7273 696f 6e44 6574 6563 7465 6428 4578  rsionDetected(Ex
+0001afd0: 6365 7074 696f 6e29 3a0a 2020 2020 2222  ception):.    ""
+0001afe0: 220a 2020 2020 5261 6973 6564 2077 6865  ".    Raised whe
+0001aff0: 6e20 616e 2069 6e66 696e 6974 6520 7265  n an infinite re
+0001b000: 6375 7273 696f 6e20 6973 2064 6574 6563  cursion is detec
+0001b010: 7465 642c 2062 7920 6775 6172 645f 696e  ted, by guard_in
+0001b020: 6669 6e69 7465 5f72 6563 7572 7369 6f6e  finite_recursion
+0001b030: 2e0a 2020 2020 2222 220a 0a0a 5f67 7561  ..    """..._gua
+0001b040: 7264 5f69 6e66 696e 6974 655f 7265 6375  rd_infinite_recu
+0001b050: 7273 696f 6e5f 6361 6368 6520 3d20 7468  rsion_cache = th
+0001b060: 7265 6164 696e 672e 6c6f 6361 6c28 290a  reading.local().
+0001b070: 0a0a 4063 6f6e 7465 7874 6c69 622e 636f  ..@contextlib.co
+0001b080: 6e74 6578 746d 616e 6167 6572 0a64 6566  ntextmanager.def
+0001b090: 2067 7561 7264 5f69 6e66 696e 6974 655f   guard_infinite_
+0001b0a0: 7265 6375 7273 696f 6e28 2a61 7267 7329  recursion(*args)
+0001b0b0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+0001b0c0: 6769 7374 6572 7320 6172 6773 2028 636f  gisters args (co
+0001b0d0: 756c 6420 6265 2066 756e 6320 2b20 6172  uld be func + ar
+0001b0e0: 6773 2920 696e 2073 6f6d 6520 6361 6368  gs) in some cach
+0001b0f0: 652e 0a20 2020 2049 6620 7468 6f73 6520  e..    If those 
+0001b100: 6172 6773 2061 7265 2061 6c72 6561 6479  args are already
+0001b110: 2069 6e20 7468 6520 6361 6368 652c 2069   in the cache, i
+0001b120: 7420 7769 6c6c 2072 6169 7365 2061 6e20  t will raise an 
+0001b130: 6578 6365 7074 696f 6e2e 0a0a 2020 2020  exception...    
+0001b140: 4974 2077 696c 6c20 7573 6520 7468 6520  It will use the 
+0001b150: 6964 206f 6620 7468 6520 6172 6773 2061  id of the args a
+0001b160: 7320 6b65 7920 616e 6420 6e6f 7420 7573  s key and not us
+0001b170: 6520 616e 7920 6861 7368 696e 670a 2020  e any hashing.  
+0001b180: 2020 746f 2061 6c6c 6f77 2074 6861 7420    to allow that 
+0001b190: 6775 6172 645f 696e 6669 6e69 7465 5f72  guard_infinite_r
+0001b1a0: 6563 7572 7369 6f6e 2063 616e 2062 6520  ecursion can be 
+0001b1b0: 7573 6564 0a20 2020 2074 6f20 6775 6172  used.    to guar
+0001b1c0: 6420 6375 7374 6f6d 205f 5f68 6173 685f  d custom __hash_
+0001b1d0: 5f20 696d 706c 656d 656e 7461 7469 6f6e  _ implementation
+0001b1e0: 7320 6173 2077 656c 6c2e 0a20 2020 2022  s as well..    "
+0001b1f0: 2222 0a20 2020 2069 6620 6e6f 7420 6172  "".    if not ar
+0001b200: 6773 3a0a 2020 2020 2020 2020 7261 6973  gs:.        rais
+0001b210: 6520 5661 6c75 6545 7272 6f72 2822 6775  e ValueError("gu
+0001b220: 6172 645f 696e 6669 6e69 7465 5f72 6563  ard_infinite_rec
+0001b230: 7572 7369 6f6e 206e 6565 6473 2061 7420  ursion needs at 
+0001b240: 6c65 6173 7420 6f6e 6520 6172 6722 290a  least one arg").
+0001b250: 2020 2020 6b65 7920 3d20 7475 706c 6528      key = tuple(
+0001b260: 6964 2861 7267 2920 666f 7220 6172 6720  id(arg) for arg 
+0001b270: 696e 2061 7267 7329 0a20 2020 2069 6620  in args).    if 
+0001b280: 6e6f 7420 6861 7361 7474 7228 5f67 7561  not hasattr(_gua
+0001b290: 7264 5f69 6e66 696e 6974 655f 7265 6375  rd_infinite_recu
+0001b2a0: 7273 696f 6e5f 6361 6368 652c 2022 6361  rsion_cache, "ca
+0001b2b0: 6368 6522 293a 0a20 2020 2020 2020 205f  che"):.        _
+0001b2c0: 6775 6172 645f 696e 6669 6e69 7465 5f72  guard_infinite_r
+0001b2d0: 6563 7572 7369 6f6e 5f63 6163 6865 2e63  ecursion_cache.c
+0001b2e0: 6163 6865 203d 2073 6574 2829 0a20 2020  ache = set().   
+0001b2f0: 2069 6620 6b65 7920 696e 205f 6775 6172   if key in _guar
+0001b300: 645f 696e 6669 6e69 7465 5f72 6563 7572  d_infinite_recur
+0001b310: 7369 6f6e 5f63 6163 6865 2e63 6163 6865  sion_cache.cache
+0001b320: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+0001b330: 496e 6669 6e69 7465 5265 6375 7273 696f  InfiniteRecursio
+0001b340: 6e44 6574 6563 7465 6428 2269 6e66 696e  nDetected("infin
+0001b350: 6974 6520 7265 6375 7273 696f 6e20 6465  ite recursion de
+0001b360: 7465 6374 6564 2229 0a20 2020 205f 6775  tected").    _gu
+0001b370: 6172 645f 696e 6669 6e69 7465 5f72 6563  ard_infinite_rec
+0001b380: 7572 7369 6f6e 5f63 6163 6865 2e63 6163  ursion_cache.cac
+0001b390: 6865 2e61 6464 286b 6579 290a 2020 2020  he.add(key).    
+0001b3a0: 7472 793a 0a20 2020 2020 2020 2079 6965  try:.        yie
+0001b3b0: 6c64 0a20 2020 2066 696e 616c 6c79 3a0a  ld.    finally:.
+0001b3c0: 2020 2020 2020 2020 5f67 7561 7264 5f69          _guard_i
+0001b3d0: 6e66 696e 6974 655f 7265 6375 7273 696f  nfinite_recursio
+0001b3e0: 6e5f 6361 6368 652e 6361 6368 652e 7265  n_cache.cache.re
+0001b3f0: 6d6f 7665 286b 6579 290a 0a0a 6465 6620  move(key)...def 
+0001b400: 6361 6d65 6c5f 6361 7365 5f74 6f5f 736e  camel_case_to_sn
+0001b410: 616b 655f 6361 7365 286e 616d 6529 3a0a  ake_case(name):.
+0001b420: 2020 2020 2222 220a 2020 2020 3a70 6172      """.    :par
+0001b430: 616d 2073 7472 206e 616d 653a 2065 2e67  am str name: e.g
+0001b440: 2e20 2243 616d 656c 4361 7365 220a 2020  . "CamelCase".  
+0001b450: 2020 3a72 6574 7572 6e3a 2065 2e67 2e20    :return: e.g. 
+0001b460: 2263 616d 656c 5f63 6173 6522 0a20 2020  "camel_case".   
+0001b470: 203a 7274 7970 653a 2073 7472 0a20 2020   :rtype: str.   
+0001b480: 2022 2222 0a20 2020 2073 3120 3d20 7265   """.    s1 = re
+0001b490: 2e73 7562 2822 282e 2928 5b41 2d5a 5d5b  .sub("(.)([A-Z][
+0001b4a0: 612d 7a5d 2b29 222c 2072 225c 315f 5c32  a-z]+)", r"\1_\2
+0001b4b0: 222c 206e 616d 6529 0a20 2020 2072 6574  ", name).    ret
+0001b4c0: 7572 6e20 7265 2e73 7562 2822 285b 612d  urn re.sub("([a-
+0001b4d0: 7a30 2d39 5d29 285b 412d 5a5d 2922 2c20  z0-9])([A-Z])", 
+0001b4e0: 7222 5c31 5f5c 3222 2c20 7331 292e 6c6f  r"\1_\2", s1).lo
+0001b4f0: 7765 7228 290a 0a0a 6465 6620 6765 745f  wer()...def get_
+0001b500: 686f 7374 6e61 6d65 2829 3a0a 2020 2020  hostname():.    
+0001b510: 2222 220a 2020 2020 3a72 6574 7572 6e3a  """.    :return:
+0001b520: 2065 2e67 2e20 2263 6c75 7374 6572 2d63   e.g. "cluster-c
+0001b530: 6e2d 3231 3122 0a20 2020 203a 7274 7970  n-211".    :rtyp
+0001b540: 653a 2073 7472 0a20 2020 2022 2222 0a20  e: str.    """. 
+0001b550: 2020 2023 2063 6865 636b 5f6f 7574 7075     # check_outpu
+0001b560: 7428 5b22 686f 7374 6e61 6d65 225d 292e  t(["hostname"]).
+0001b570: 7374 7269 7028 292e 6465 636f 6465 2822  strip().decode("
+0001b580: 7574 6638 2229 0a20 2020 2069 6d70 6f72  utf8").    impor
+0001b590: 7420 736f 636b 6574 0a0a 2020 2020 7265  t socket..    re
+0001b5a0: 7475 726e 2073 6f63 6b65 742e 6765 7468  turn socket.geth
+0001b5b0: 6f73 746e 616d 6528 290a 0a0a 6465 6620  ostname()...def 
+0001b5c0: 6973 5f72 756e 6e69 6e67 5f6f 6e5f 636c  is_running_on_cl
+0001b5d0: 7573 7465 7228 293a 0a20 2020 2022 2222  uster():.    """
+0001b5e0: 0a20 2020 203a 7265 7475 726e 3a20 6936  .    :return: i6
+0001b5f0: 2073 7065 6369 6669 632e 2057 6865 7468   specific. Wheth
+0001b600: 6572 2077 6520 7275 6e20 6f6e 2073 6f6d  er we run on som
+0001b610: 6520 6f66 2074 6865 2063 6c75 7374 6572  e of the cluster
+0001b620: 206e 6f64 6573 2e0a 2020 2020 3a72 7479   nodes..    :rty
+0001b630: 7065 3a20 626f 6f6c 0a20 2020 2022 2222  pe: bool.    """
+0001b640: 0a20 2020 2072 6574 7572 6e20 6765 745f  .    return get_
+0001b650: 686f 7374 6e61 6d65 2829 2e73 7461 7274  hostname().start
+0001b660: 7377 6974 6828 2263 6c75 7374 6572 2d63  swith("cluster-c
+0001b670: 6e2d 2229 206f 7220 6765 745f 686f 7374  n-") or get_host
+0001b680: 6e61 6d65 2829 2e73 7461 7274 7377 6974  name().startswit
+0001b690: 6828 2263 6e2d 2229 0a0a 0a73 7461 7274  h("cn-")...start
+0001b6a0: 5f74 696d 6520 3d20 7469 6d65 2e74 696d  _time = time.tim
+0001b6b0: 6528 290a 0a0a 6465 6620 6765 745f 7574  e()...def get_ut
+0001b6c0: 635f 7374 6172 745f 7469 6d65 5f66 696c  c_start_time_fil
+0001b6d0: 656e 616d 655f 7061 7274 2829 3a0a 2020  ename_part():.  
+0001b6e0: 2020 2222 220a 2020 2020 3a72 6574 7572    """.    :retur
+0001b6f0: 6e3a 2073 7472 696e 6720 7768 6963 6820  n: string which 
+0001b700: 6361 6e20 6265 2075 7365 6420 6173 2070  can be used as p
+0001b710: 6172 7420 6f66 2061 2066 696c 656e 616d  art of a filenam
+0001b720: 652c 2077 6869 6368 2072 6570 7265 7365  e, which represe
+0001b730: 6e74 7320 7468 6520 7374 6172 7420 7469  nts the start ti
+0001b740: 6d65 206f 6620 5245 5455 524e 4e20 696e  me of RETURNN in
+0001b750: 2055 5443 0a20 2020 203a 7274 7970 653a   UTC.    :rtype:
+0001b760: 2073 7472 0a20 2020 2022 2222 0a20 2020   str.    """.   
+0001b770: 2072 6574 7572 6e20 7469 6d65 2e73 7472   return time.str
+0001b780: 6674 696d 6528 2225 592d 256d 2d25 642d  ftime("%Y-%m-%d-
+0001b790: 2548 2d25 4d2d 2553 222c 2074 696d 652e  %H-%M-%S", time.
+0001b7a0: 676d 7469 6d65 2873 7461 7274 5f74 696d  gmtime(start_tim
+0001b7b0: 6529 290a 0a0a 6465 6620 6d61 7962 655f  e))...def maybe_
+0001b7c0: 6d61 6b65 5f64 6972 7328 6469 726e 616d  make_dirs(dirnam
+0001b7d0: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+0001b7e0: 4372 6561 7465 7320 7468 6520 6469 7265  Creates the dire
+0001b7f0: 6374 6f72 7920 6966 2069 7420 646f 6573  ctory if it does
+0001b800: 206e 6f74 2079 6574 2065 7869 7374 2e0a   not yet exist..
+0001b810: 0a20 2020 203a 7061 7261 6d20 7374 7220  .    :param str 
+0001b820: 6469 726e 616d 653a 2054 6865 2070 6174  dirname: The pat
+0001b830: 6820 6f66 2074 6865 2064 6972 6563 746f  h of the directo
+0001b840: 7279 0a20 2020 2022 2222 0a20 2020 2069  ry.    """.    i
+0001b850: 6d70 6f72 7420 6f73 0a0a 2020 2020 6966  mport os..    if
+0001b860: 206e 6f74 206f 732e 7061 7468 2e65 7869   not os.path.exi
+0001b870: 7374 7328 6469 726e 616d 6529 3a0a 2020  sts(dirname):.  
+0001b880: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001b890: 2020 2020 2020 206f 732e 6d61 6b65 6469         os.makedi
+0001b8a0: 7273 2864 6972 6e61 6d65 290a 2020 2020  rs(dirname).    
+0001b8b0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0001b8c0: 7469 6f6e 2061 7320 6578 633a 0a20 2020  tion as exc:.   
+0001b8d0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0001b8e0: 6d61 7962 655f 6372 6561 7465 5f66 6f6c  maybe_create_fol
+0001b8f0: 6465 723a 2065 7863 6570 7469 6f6e 2063  der: exception c
+0001b900: 7265 6174 696e 6720 6469 723a 222c 2065  reating dir:", e
+0001b910: 7863 290a 2020 2020 2020 2020 2020 2020  xc).            
+0001b920: 2320 4d61 7962 6520 6120 636f 6e63 7572  # Maybe a concur
+0001b930: 7265 6e74 2070 726f 6365 7373 2c20 652e  rent process, e.
+0001b940: 672e 2074 662e 636f 6d70 6174 2e76 312e  g. tf.compat.v1.
+0001b950: 7375 6d6d 6172 792e 4669 6c65 5772 6974  summary.FileWrit
+0001b960: 6572 2063 7265 6174 6564 2069 7420 696e  er created it in
+0001b970: 2074 6865 206d 6561 6e2d 7768 696c 652c   the mean-while,
+0001b980: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+0001b990: 6f20 7468 656e 2069 7420 776f 756c 6420  o then it would 
+0001b9a0: 6265 206f 6b20 6e6f 7720 6966 2069 7420  be ok now if it 
+0001b9b0: 6578 6973 7473 2c20 6275 7420 6661 696c  exists, but fail
+0001b9c0: 2069 6620 6974 2064 6f65 7320 6e6f 7420   if it does not 
+0001b9d0: 6578 6973 742e 0a20 2020 2020 2020 2020  exist..         
+0001b9e0: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
+0001b9f0: 682e 6578 6973 7473 2864 6972 6e61 6d65  h.exists(dirname
+0001ba00: 290a 0a0a 6465 6620 6c6f 675f 7275 6e74  )...def log_runt
+0001ba10: 696d 655f 696e 666f 5f74 6f5f 6469 7228  ime_info_to_dir(
+0001ba20: 7061 7468 2c20 636f 6e66 6967 293a 0a20  path, config):. 
+0001ba30: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
+0001ba40: 7769 6c6c 2077 7269 7465 206d 756c 7469  will write multi
+0001ba50: 706c 6520 6c6f 6767 696e 6720 696e 666f  ple logging info
+0001ba60: 726d 6174 696f 6e20 696e 746f 2074 6865  rmation into the
+0001ba70: 2070 6174 682e 0a20 2020 2049 7420 7769   path..    It wi
+0001ba80: 6c6c 2063 7265 6174 6520 7265 7475 726e  ll create return
+0001ba90: 6e2e 2a2e 6c6f 6720 7769 7468 2073 6f6d  n.*.log with som
+0001baa0: 6520 6d65 7461 2069 6e66 6f72 6d61 7469  e meta informati
+0001bab0: 6f6e 2c0a 2020 2020 6173 2077 656c 6c20  on,.    as well 
+0001bac0: 6173 2063 6f70 7920 7468 6520 7573 6564  as copy the used
+0001bad0: 2063 6f6e 6669 6720 6669 6c65 2e0a 0a20   config file... 
+0001bae0: 2020 203a 7061 7261 6d20 7374 7220 7061     :param str pa
+0001baf0: 7468 3a20 6469 7265 6374 6f72 7920 7061  th: directory pa
+0001bb00: 7468 0a20 2020 203a 7061 7261 6d20 7265  th.    :param re
+0001bb10: 7475 726e 6e2e 636f 6e66 6967 2e43 6f6e  turnn.config.Con
+0001bb20: 6669 6720 636f 6e66 6967 3a0a 2020 2020  fig config:.    
+0001bb30: 2222 220a 2020 2020 696d 706f 7274 206f  """.    import o
+0001bb40: 730a 2020 2020 696d 706f 7274 2073 7973  s.    import sys
+0001bb50: 0a20 2020 2069 6d70 6f72 7420 7368 7574  .    import shut
+0001bb60: 696c 0a20 2020 2066 726f 6d20 7265 7475  il.    from retu
+0001bb70: 726e 6e2e 636f 6e66 6967 2069 6d70 6f72  rnn.config impor
+0001bb80: 7420 436f 6e66 6967 0a0a 2020 2020 7472  t Config..    tr
+0001bb90: 793a 0a20 2020 2020 2020 2068 6f73 746e  y:.        hostn
+0001bba0: 616d 6520 3d20 6765 745f 686f 7374 6e61  ame = get_hostna
+0001bbb0: 6d65 2829 0a20 2020 2020 2020 2063 6f6e  me().        con
+0001bbc0: 7465 6e74 203d 205b 0a20 2020 2020 2020  tent = [.       
+0001bbd0: 2020 2020 2022 5469 6d65 3a20 2573 2220       "Time: %s" 
+0001bbe0: 2520 7469 6d65 2e73 7472 6674 696d 6528  % time.strftime(
+0001bbf0: 2225 592d 256d 2d25 6420 2548 3a25 4d3a  "%Y-%m-%d %H:%M:
+0001bc00: 2553 222c 2074 696d 652e 676d 7469 6d65  %S", time.gmtime
+0001bc10: 2873 7461 7274 5f74 696d 6529 292c 0a20  (start_time)),. 
+0001bc20: 2020 2020 2020 2020 2020 2022 4361 6c6c             "Call
+0001bc30: 3a20 2573 2220 2520 2873 7973 2e61 7267  : %s" % (sys.arg
+0001bc40: 762c 292c 0a20 2020 2020 2020 2020 2020  v,),.           
+0001bc50: 2022 5061 7468 3a20 2573 2220 2520 286f   "Path: %s" % (o
+0001bc60: 732e 6765 7463 7764 2829 2c29 2c0a 2020  s.getcwd(),),.  
+0001bc70: 2020 2020 2020 2020 2020 2248 6f73 746e            "Hostn
+0001bc80: 616d 653a 2025 7322 2025 2067 6574 5f68  ame: %s" % get_h
+0001bc90: 6f73 746e 616d 6528 292c 0a20 2020 2020  ostname(),.     
+0001bca0: 2020 2020 2020 2022 5049 443a 2025 6922         "PID: %i"
+0001bcb0: 2025 206f 732e 6765 7470 6964 2829 2c0a   % os.getpid(),.
+0001bcc0: 2020 2020 2020 2020 2020 2020 2252 6574              "Ret
+0001bcd0: 7572 6e6e 3a20 2573 2220 2520 2864 6573  urnn: %s" % (des
+0001bce0: 6372 6962 655f 7265 7475 726e 6e5f 7665  cribe_returnn_ve
+0001bcf0: 7273 696f 6e28 292c 292c 0a20 2020 2020  rsion(),),.     
+0001bd00: 2020 2020 2020 2022 5465 6e73 6f72 466c         "TensorFl
+0001bd10: 6f77 3a20 2573 2220 2520 2864 6573 6372  ow: %s" % (descr
+0001bd20: 6962 655f 7465 6e73 6f72 666c 6f77 5f76  ibe_tensorflow_v
+0001bd30: 6572 7369 6f6e 2829 2c29 2c0a 2020 2020  ersion(),),.    
+0001bd40: 2020 2020 2020 2020 2243 6f6e 6669 6720          "Config 
+0001bd50: 6669 6c65 733a 2025 7322 2025 2028 636f  files: %s" % (co
+0001bd60: 6e66 6967 2e66 696c 6573 2c29 2c0a 2020  nfig.files,),.  
+0001bd70: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0001bd80: 6d61 7962 655f 6d61 6b65 5f64 6972 7328  maybe_make_dirs(
+0001bd90: 7061 7468 290a 2020 2020 2020 2020 6c6f  path).        lo
+0001bda0: 675f 666e 203d 2022 2573 2f72 6574 7572  g_fn = "%s/retur
+0001bdb0: 6e6e 2e25 732e 2573 2e25 692e 6c6f 6722  nn.%s.%s.%i.log"
+0001bdc0: 2025 2028 7061 7468 2c20 6765 745f 7574   % (path, get_ut
+0001bdd0: 635f 7374 6172 745f 7469 6d65 5f66 696c  c_start_time_fil
+0001bde0: 656e 616d 655f 7061 7274 2829 2c20 686f  ename_part(), ho
+0001bdf0: 7374 6e61 6d65 2c20 6f73 2e67 6574 7069  stname, os.getpi
+0001be00: 6428 2929 0a20 2020 2020 2020 2069 6620  d()).        if 
+0001be10: 6e6f 7420 6f73 2e70 6174 682e 6578 6973  not os.path.exis
+0001be20: 7473 286c 6f67 5f66 6e29 3a0a 2020 2020  ts(log_fn):.    
+0001be30: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+0001be40: 6e28 6c6f 675f 666e 2c20 2277 2229 2061  n(log_fn, "w") a
+0001be50: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
+0001be60: 2020 2020 2066 2e77 7269 7465 2822 5265       f.write("Re
+0001be70: 7475 726e 6e20 6c6f 6720 6669 6c65 3a5c  turnn log file:\
+0001be80: 6e22 202b 2022 222e 6a6f 696e 285b 2225  n" + "".join(["%
+0001be90: 735c 6e22 2025 2073 2066 6f72 2073 2069  s\n" % s for s i
+0001bea0: 6e20 636f 6e74 656e 745d 2920 2b20 225c  n content]) + "\
+0001beb0: 6e22 290a 2020 2020 2020 2020 666f 7220  n").        for 
+0001bec0: 666e 2069 6e20 636f 6e66 6967 2e66 696c  fn in config.fil
+0001bed0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001bee0: 6261 7365 5f66 6e20 3d20 6f73 2e70 6174  base_fn = os.pat
+0001bef0: 682e 6261 7365 6e61 6d65 2866 6e29 0a20  h.basename(fn). 
+0001bf00: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+0001bf10: 745f 666e 203d 2022 2573 2f25 7322 2025  t_fn = "%s/%s" %
+0001bf20: 2028 7061 7468 2c20 6261 7365 5f66 6e29   (path, base_fn)
+0001bf30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001bf40: 6f73 2e70 6174 682e 6578 6973 7473 2874  os.path.exists(t
+0001bf50: 6172 6765 745f 666e 293a 0a20 2020 2020  arget_fn):.     
+0001bf60: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0001bf70: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+0001bf80: 7368 7574 696c 2e63 6f70 7928 666e 2c20  shutil.copy(fn, 
+0001bf90: 7461 7267 6574 5f66 6e29 0a20 2020 2020  target_fn).     
+0001bfa0: 2020 2020 2020 2063 6f6e 6669 675f 7479         config_ty
+0001bfb0: 7065 203d 2043 6f6e 6669 672e 6765 745f  pe = Config.get_
+0001bfc0: 636f 6e66 6967 5f66 696c 655f 7479 7065  config_file_type
+0001bfd0: 2866 6e29 0a20 2020 2020 2020 2020 2020  (fn).           
+0001bfe0: 2063 6f6d 6d65 6e74 5f70 7265 6669 7820   comment_prefix 
+0001bff0: 3d20 2223 220a 2020 2020 2020 2020 2020  = "#".          
+0001c000: 2020 6966 2063 6f6e 6669 675f 7479 7065    if config_type
+0001c010: 203d 3d20 226a 7322 3a0a 2020 2020 2020   == "js":.      
+0001c020: 2020 2020 2020 2020 2020 636f 6d6d 656e            commen
+0001c030: 745f 7072 6566 6978 203d 2022 2f2f 220a  t_prefix = "//".
+0001c040: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0001c050: 206f 7065 6e28 7461 7267 6574 5f66 6e2c   open(target_fn,
+0001c060: 2022 6122 2920 6173 2066 3a0a 2020 2020   "a") as f:.    
+0001c070: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
+0001c080: 6974 6528 0a20 2020 2020 2020 2020 2020  ite(.           
+0001c090: 2020 2020 2020 2020 2022 5c6e 5c6e 5c6e           "\n\n\n
+0001c0a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001c0b0: 2020 2020 2020 2b20 2222 2e6a 6f69 6e28        + "".join(
+0001c0c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c0d0: 2020 2020 2020 2020 205b 2225 7320 436f           ["%s Co
+0001c0e0: 6e66 6967 2d66 696c 6520 636f 7069 6564  nfig-file copied
+0001c0f0: 2066 6f72 206c 6f67 6769 6e67 2070 7572   for logging pur
+0001c100: 706f 7365 2062 7920 5265 7475 726e 6e2e  pose by Returnn.
+0001c110: 5c6e 2220 2520 636f 6d6d 656e 745f 7072  \n" % comment_pr
+0001c120: 6566 6978 5d0a 2020 2020 2020 2020 2020  efix].          
+0001c130: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+0001c140: 5b22 2573 2025 735c 6e22 2025 2028 636f  ["%s %s\n" % (co
+0001c150: 6d6d 656e 745f 7072 6566 6978 2c20 7329  mment_prefix, s)
+0001c160: 2066 6f72 2073 2069 6e20 636f 6e74 656e   for s in conten
+0001c170: 745d 0a20 2020 2020 2020 2020 2020 2020  t].             
+0001c180: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001c190: 2020 2020 2020 2020 2020 2020 202b 2022               + "
+0001c1a0: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
+0001c1b0: 2020 2020 290a 2020 2020 6578 6365 7074      ).    except
+0001c1c0: 204f 5345 7272 6f72 2061 7320 6578 633a   OSError as exc:
+0001c1d0: 0a20 2020 2020 2020 2069 6620 2244 6973  .        if "Dis
+0001c1e0: 6b20 7175 6f74 6122 2069 6e20 7374 7228  k quota" in str(
+0001c1f0: 6578 6329 3a0a 2020 2020 2020 2020 2020  exc):.          
+0001c200: 2020 7072 696e 7428 226c 6f67 5f72 756e    print("log_run
+0001c210: 7469 6d65 5f69 6e66 6f5f 746f 5f64 6972  time_info_to_dir
+0001c220: 3a20 4572 726f 722c 2063 616e 6e6f 7420  : Error, cannot 
+0001c230: 7772 6974 653a 2025 7322 2025 2065 7863  write: %s" % exc
+0001c240: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001c250: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c260: 650a 0a0a 6465 6620 7368 6f75 6c64 5f77  e...def should_w
+0001c270: 7269 7465 5f74 6f5f 6469 736b 2863 6f6e  rite_to_disk(con
+0001c280: 6669 6729 3a0a 2020 2020 2222 220a 2020  fig):.    """.  
+0001c290: 2020 3a70 6172 616d 2072 6574 7572 6e6e    :param returnn
+0001c2a0: 2e63 6f6e 6669 672e 436f 6e66 6967 2063  .config.Config c
+0001c2b0: 6f6e 6669 673a 0a20 2020 203a 7274 7970  onfig:.    :rtyp
+0001c2c0: 653a 2062 6f6f 6c0a 2020 2020 2222 220a  e: bool.    """.
+0001c2d0: 2020 2020 6966 2063 6f6e 6669 672e 7479      if config.ty
+0001c2e0: 7065 645f 7661 6c75 6528 2274 6f72 6368  ped_value("torch
+0001c2f0: 5f64 6973 7472 6962 7574 6564 2229 2069  _distributed") i
+0001c300: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001c310: 2020 2020 6173 7365 7274 2042 6163 6b65      assert Backe
+0001c320: 6e64 456e 6769 6e65 2e69 735f 746f 7263  ndEngine.is_torc
+0001c330: 685f 7365 6c65 6374 6564 2829 2c20 2274  h_selected(), "t
+0001c340: 6f72 6368 5f64 6973 7472 6962 7574 6564  orch_distributed
+0001c350: 2061 7373 756d 6573 2050 7954 6f72 6368   assumes PyTorch
+0001c360: 220a 0a20 2020 2020 2020 2069 6d70 6f72  "..        impor
+0001c370: 7420 746f 7263 682e 6469 7374 7269 6275  t torch.distribu
+0001c380: 7465 640a 0a20 2020 2020 2020 2069 6620  ted..        if 
+0001c390: 746f 7263 682e 6469 7374 7269 6275 7465  torch.distribute
+0001c3a0: 642e 6765 745f 7261 6e6b 2829 2021 3d20  d.get_rank() != 
+0001c3b0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+0001c3c0: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
+0001c3d0: 656c 6966 2063 6f6e 6669 672e 6973 5f74  elif config.is_t
+0001c3e0: 7275 6528 2275 7365 5f68 6f72 6f76 6f64  rue("use_horovod
+0001c3f0: 2229 3a0a 2020 2020 2020 2020 6173 7365  "):.        asse
+0001c400: 7274 2042 6163 6b65 6e64 456e 6769 6e65  rt BackendEngine
+0001c410: 2e69 735f 7465 6e73 6f72 666c 6f77 5f73  .is_tensorflow_s
+0001c420: 656c 6563 7465 6428 292c 2022 7573 655f  elected(), "use_
+0001c430: 686f 726f 766f 6420 6375 7272 656e 746c  horovod currentl
+0001c440: 7920 6173 7375 6d65 7320 5465 6e73 6f72  y assumes Tensor
+0001c450: 466c 6f77 220a 0a20 2020 2020 2020 2023  Flow"..        #
+0001c460: 206e 6f69 6e73 7065 6374 696f 6e20 5079   noinspection Py
+0001c470: 5061 636b 6167 6552 6571 7569 7265 6d65  PackageRequireme
+0001c480: 6e74 732c 5079 556e 7265 736f 6c76 6564  nts,PyUnresolved
+0001c490: 5265 6665 7265 6e63 6573 0a20 2020 2020  References.     
+0001c4a0: 2020 2069 6d70 6f72 7420 686f 726f 766f     import horovo
+0001c4b0: 642e 7465 6e73 6f72 666c 6f77 2061 7320  d.tensorflow as 
+0001c4c0: 6876 640a 0a20 2020 2020 2020 2069 6620  hvd..        if 
+0001c4d0: 6876 642e 7261 6e6b 2829 2021 3d20 303a  hvd.rank() != 0:
+0001c4e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001c4f0: 7572 6e20 4661 6c73 650a 2020 2020 6966  urn False.    if
+0001c500: 2063 6f6e 6669 672e 6973 5f74 7275 6528   config.is_true(
+0001c510: 2264 7279 5f72 756e 2229 3a0a 2020 2020  "dry_run"):.    
+0001c520: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+0001c530: 0a20 2020 2072 6574 7572 6e20 5472 7565  .    return True
+0001c540: 0a0a 0a5f 6465 6661 756c 745f 676c 6f62  ..._default_glob
+0001c550: 616c 5f69 6e66 5f76 616c 7565 203d 2066  al_inf_value = f
+0001c560: 6c6f 6174 2822 696e 6622 290a 0a0a 6465  loat("inf")...de
+0001c570: 6620 6765 745f 676c 6f62 616c 5f69 6e66  f get_global_inf
+0001c580: 5f76 616c 7565 2829 202d 3e20 666c 6f61  _value() -> floa
+0001c590: 743a 0a20 2020 2022 2222 0a20 2020 203a  t:.    """.    :
+0001c5a0: 7265 7475 726e 3a20 666c 6f61 7428 2269  return: float("i
+0001c5b0: 6e66 2229 2062 7920 6465 6661 756c 742c  nf") by default,
+0001c5c0: 2062 7574 2074 7269 6573 2074 6f20 7265   but tries to re
+0001c5d0: 6164 2060 696e 665f 7661 6c75 6560 2066  ad `inf_value` f
+0001c5e0: 726f 6d20 7468 6520 676c 6f62 616c 2063  rom the global c
+0001c5f0: 6f6e 6669 670a 2020 2020 2222 220a 2020  onfig.    """.  
+0001c600: 2020 6672 6f6d 2072 6574 7572 6e6e 2e63    from returnn.c
+0001c610: 6f6e 6669 6720 696d 706f 7274 2067 6574  onfig import get
+0001c620: 5f67 6c6f 6261 6c5f 636f 6e66 6967 0a0a  _global_config..
+0001c630: 2020 2020 636f 6e66 6967 203d 2067 6574      config = get
+0001c640: 5f67 6c6f 6261 6c5f 636f 6e66 6967 2872  _global_config(r
+0001c650: 6169 7365 5f65 7863 6570 7469 6f6e 3d46  aise_exception=F
+0001c660: 616c 7365 290a 2020 2020 6966 206e 6f74  alse).    if not
+0001c670: 2063 6f6e 6669 673a 0a20 2020 2020 2020   config:.       
+0001c680: 2072 6574 7572 6e20 5f64 6566 6175 6c74   return _default
+0001c690: 5f67 6c6f 6261 6c5f 696e 665f 7661 6c75  _global_inf_valu
+0001c6a0: 650a 2020 2020 7265 7475 726e 2063 6f6e  e.    return con
+0001c6b0: 6669 672e 666c 6f61 7428 2269 6e66 5f76  fig.float("inf_v
+0001c6c0: 616c 7565 222c 205f 6465 6661 756c 745f  alue", _default_
+0001c6d0: 676c 6f62 616c 5f69 6e66 5f76 616c 7565  global_inf_value
+0001c6e0: 290a 0a0a 6465 6620 6973 5f6f 6e6e 785f  )...def is_onnx_
+0001c6f0: 6578 706f 7274 5f67 6c6f 6261 6c28 2920  export_global() 
+0001c700: 2d3e 2062 6f6f 6c3a 0a20 2020 2022 2222  -> bool:.    """
+0001c710: 0a20 2020 203a 7265 7475 726e 3a20 4661  .    :return: Fa
+0001c720: 6c73 6520 6279 2064 6566 6175 6c74 2e20  lse by default. 
+0001c730: 4966 2027 6f6e 6e78 5f65 7870 6f72 7427  If 'onnx_export'
+0001c740: 2069 7320 7365 7420 696e 2074 6865 2063   is set in the c
+0001c750: 6f6e 6669 672c 2074 6861 7420 7661 6c75  onfig, that valu
+0001c760: 6520 6973 2075 7365 642e 0a20 2020 2022  e is used..    "
+0001c770: 2222 0a20 2020 2066 726f 6d20 7265 7475  "".    from retu
+0001c780: 726e 6e2e 636f 6e66 6967 2069 6d70 6f72  rnn.config impor
+0001c790: 7420 6765 745f 676c 6f62 616c 5f63 6f6e  t get_global_con
+0001c7a0: 6669 670a 0a20 2020 2063 6f6e 6669 6720  fig..    config 
+0001c7b0: 3d20 6765 745f 676c 6f62 616c 5f63 6f6e  = get_global_con
+0001c7c0: 6669 6728 7261 6973 655f 6578 6365 7074  fig(raise_except
+0001c7d0: 696f 6e3d 4661 6c73 6529 0a20 2020 2069  ion=False).    i
+0001c7e0: 6620 6e6f 7420 636f 6e66 6967 3a0a 2020  f not config:.  
+0001c7f0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0001c800: 7365 0a20 2020 2072 6574 7572 6e20 636f  se.    return co
+0001c810: 6e66 6967 2e62 6f6f 6c28 226f 6e6e 785f  nfig.bool("onnx_
+0001c820: 6578 706f 7274 222c 2046 616c 7365 290a  export", False).
+0001c830: 0a0a 2320 5365 6520 3a66 756e 633a 606d  ..# See :func:`m
+0001c840: 6179 6265 5f72 6573 7461 7274 5f72 6574  aybe_restart_ret
+0001c850: 7572 6e6e 5f77 6974 685f 6174 666f 726b  urnn_with_atfork
+0001c860: 5f70 6174 6368 6020 6265 6c6f 7720 666f  _patch` below fo
+0001c870: 7220 7768 7920 796f 7520 6d69 6768 7420  r why you might 
+0001c880: 7761 6e74 2074 6f20 7573 6520 7468 6973  want to use this
+0001c890: 2e0a 5f63 5f63 6f64 655f 7061 7463 685f  .._c_code_patch_
+0001c8a0: 6174 666f 726b 203d 2022 2222 0a23 6465  atfork = """.#de
+0001c8b0: 6669 6e65 205f 474e 555f 534f 5552 4345  fine _GNU_SOURCE
+0001c8c0: 0a23 696e 636c 7564 6520 3c73 6368 6564  .#include <sched
+0001c8d0: 2e68 3e0a 2369 6e63 6c75 6465 203c 7369  .h>.#include <si
+0001c8e0: 676e 616c 2e68 3e0a 2369 6e63 6c75 6465  gnal.h>.#include
+0001c8f0: 203c 7379 732f 7379 7363 616c 6c2e 683e   <sys/syscall.h>
+0001c900: 0a23 696e 636c 7564 6520 3c73 7464 696f  .#include <stdio
+0001c910: 2e68 3e0a 2369 6e63 6c75 6465 203c 7374  .h>.#include <st
+0001c920: 646c 6962 2e68 3e0a 2369 6e63 6c75 6465  dlib.h>.#include
+0001c930: 203c 756e 6973 7464 2e68 3e0a 0a2f 2f20   <unistd.h>..// 
+0001c940: 6874 7470 733a 2f2f 7374 6163 6b6f 7665  https://stackove
+0001c950: 7266 6c6f 772e 636f 6d2f 7175 6573 7469  rflow.com/questi
+0001c960: 6f6e 732f 3436 3834 3534 3936 2f6c 642d  ons/46845496/ld-
+0001c970: 7072 656c 6f61 642d 616e 642d 6c69 6e6b  preload-and-link
+0001c980: 6167 650a 2f2f 2068 7474 7073 3a2f 2f73  age.// https://s
+0001c990: 7461 636b 6f76 6572 666c 6f77 2e63 6f6d  tackoverflow.com
+0001c9a0: 2f71 7565 7374 696f 6e73 2f34 3638 3130  /questions/46810
+0001c9b0: 3539 372f 666f 726b 6578 6563 2d77 6974  597/forkexec-wit
+0001c9c0: 686f 7574 2d61 7466 6f72 6b2d 6861 6e64  hout-atfork-hand
+0001c9d0: 6c65 7273 0a0a 696e 7420 7074 6872 6561  lers..int pthrea
+0001c9e0: 645f 6174 666f 726b 2876 6f69 6420 282a  d_atfork(void (*
+0001c9f0: 7072 6570 6172 6529 2876 6f69 6429 2c20  prepare)(void), 
+0001ca00: 766f 6964 2028 2a70 6172 656e 7429 2876  void (*parent)(v
+0001ca10: 6f69 6429 2c20 766f 6964 2028 2a63 6869  oid), void (*chi
+0001ca20: 6c64 2928 766f 6964 2929 207b 0a20 2070  ld)(void)) {.  p
+0001ca30: 7269 6e74 6628 2249 676e 6f72 696e 6720  rintf("Ignoring 
+0001ca40: 7074 6872 6561 645f 6174 666f 726b 2063  pthread_atfork c
+0001ca50: 616c 6c21 5c5c 6e22 293b 0a20 2066 666c  all!\\n");.  ffl
+0001ca60: 7573 6828 7374 646f 7574 293b 0a20 2072  ush(stdout);.  r
+0001ca70: 6574 7572 6e20 303b 0a7d 0a0a 696e 7420  eturn 0;.}..int 
+0001ca80: 5f5f 7265 6769 7374 6572 5f61 7466 6f72  __register_atfor
+0001ca90: 6b28 766f 6964 2028 2a70 7265 7061 7265  k(void (*prepare
+0001caa0: 2928 766f 6964 292c 2076 6f69 6420 282a  )(void), void (*
+0001cab0: 7061 7265 6e74 2928 766f 6964 292c 2076  parent)(void), v
+0001cac0: 6f69 6420 282a 6368 696c 6429 2876 6f69  oid (*child)(voi
+0001cad0: 6429 2920 7b0a 2020 7072 696e 7466 2822  d)) {.  printf("
+0001cae0: 4967 6e6f 7269 6e67 205f 5f72 6567 6973  Ignoring __regis
+0001caf0: 7465 725f 6174 666f 726b 2063 616c 6c21  ter_atfork call!
+0001cb00: 5c5c 6e22 293b 0a20 2066 666c 7573 6828  \\n");.  fflush(
+0001cb10: 7374 646f 7574 293b 0a20 2072 6574 7572  stdout);.  retur
+0001cb20: 6e20 303b 0a7d 0a0a 2f2f 2041 6e6f 7468  n 0;.}..// Anoth
+0001cb30: 6572 2077 6179 2074 6f20 6967 6e6f 7265  er way to ignore
+0001cb40: 2061 7466 6f72 6b20 6861 6e64 6c65 7273   atfork handlers
+0001cb50: 3a20 4f76 6572 7269 6465 2066 6f72 6b2e  : Override fork.
+0001cb60: 0a23 6966 6465 6620 5f5f 6c69 6e75 785f  .#ifdef __linux_
+0001cb70: 5f20 2f2f 206f 6e6c 7920 776f 726b 7320  _ // only works 
+0001cb80: 6f6e 204c 696e 7578 2063 7572 7265 6e74  on Linux current
+0001cb90: 6c79 0a70 6964 5f74 2066 6f72 6b28 766f  ly.pid_t fork(vo
+0001cba0: 6964 2920 7b0a 2020 7265 7475 726e 2073  id) {.  return s
+0001cbb0: 7973 6361 6c6c 2853 5953 5f63 6c6f 6e65  yscall(SYS_clone
+0001cbc0: 2c20 5349 4743 484c 442c 2030 293b 0a7d  , SIGCHLD, 0);.}
+0001cbd0: 0a23 656e 6469 660a 0a5f 5f61 7474 7269  .#endif..__attri
+0001cbe0: 6275 7465 5f5f 2828 636f 6e73 7472 7563  bute__((construc
+0001cbf0: 746f 7229 290a 766f 6964 2070 6174 6368  tor)).void patch
+0001cc00: 5f61 7466 6f72 6b5f 696e 6974 2829 207b  _atfork_init() {
+0001cc10: 0a20 2073 6574 656e 7628 225f 5f52 4554  .  setenv("__RET
+0001cc20: 5552 4e4e 5f41 5446 4f52 4b5f 5041 5443  URNN_ATFORK_PATC
+0001cc30: 4845 4422 2c20 2231 222c 2031 293b 0a7d  HED", "1", 1);.}
+0001cc40: 0a22 2222 0a0a 0a64 6566 2067 6574 5f70  ."""...def get_p
+0001cc50: 6174 6368 5f61 7466 6f72 6b5f 6c69 6228  atch_atfork_lib(
+0001cc60: 293a 0a20 2020 2022 2222 0a20 2020 203a  ):.    """.    :
+0001cc70: 7265 7475 726e 3a20 7061 7468 2074 6f20  return: path to 
+0001cc80: 6f75 7220 7061 7463 685f 6174 666f 726b  our patch_atfork
+0001cc90: 206c 6962 2e20 7365 6520 3a66 756e 633a   lib. see :func:
+0001cca0: 606d 6179 6265 5f72 6573 7461 7274 5f72  `maybe_restart_r
+0001ccb0: 6574 7572 6e6e 5f77 6974 685f 6174 666f  eturnn_with_atfo
+0001ccc0: 726b 5f70 6174 6368 600a 2020 2020 3a72  rk_patch`.    :r
+0001ccd0: 7479 7065 3a20 7374 720a 2020 2020 2222  type: str.    ""
+0001cce0: 220a 2020 2020 6e61 7469 7665 203d 204e  ".    native = N
+0001ccf0: 6174 6976 6543 6f64 6543 6f6d 7069 6c65  ativeCodeCompile
+0001cd00: 7228 6261 7365 5f6e 616d 653d 2270 6174  r(base_name="pat
+0001cd10: 6368 5f61 7466 6f72 6b22 2c20 636f 6465  ch_atfork", code
+0001cd20: 5f76 6572 7369 6f6e 3d32 2c20 636f 6465  _version=2, code
+0001cd30: 3d5f 635f 636f 6465 5f70 6174 6368 5f61  =_c_code_patch_a
+0001cd40: 7466 6f72 6b2c 2069 735f 6370 703d 4661  tfork, is_cpp=Fa
+0001cd50: 6c73 6529 0a20 2020 2066 6e20 3d20 6e61  lse).    fn = na
+0001cd60: 7469 7665 2e67 6574 5f6c 6962 5f66 696c  tive.get_lib_fil
+0001cd70: 656e 616d 6528 290a 2020 2020 7265 7475  ename().    retu
+0001cd80: 726e 2066 6e0a 0a0a 6465 6620 7265 7374  rn fn...def rest
+0001cd90: 6172 745f 7265 7475 726e 6e28 293a 0a20  art_returnn():. 
+0001cda0: 2020 2022 2222 0a20 2020 2052 6573 7461     """.    Resta
+0001cdb0: 7274 7320 5245 5455 524e 4e2e 0a20 2020  rts RETURNN..   
+0001cdc0: 2022 2222 0a20 2020 206c 6f67 2e66 6c75   """.    log.flu
+0001cdd0: 7368 2829 0a20 2020 2073 7973 2e73 7464  sh().    sys.std
+0001cde0: 6f75 742e 666c 7573 6828 290a 2020 2020  out.flush().    
+0001cdf0: 7379 732e 7374 6465 7272 2e66 6c75 7368  sys.stderr.flush
+0001ce00: 2829 0a20 2020 2023 2068 7474 7073 3a2f  ().    # https:/
+0001ce10: 2f73 7461 636b 6f76 6572 666c 6f77 2e63  /stackoverflow.c
+0001ce20: 6f6d 2f71 7565 7374 696f 6e73 2f37 3233  om/questions/723
+0001ce30: 3335 3930 342f 7369 6d70 6c65 2d77 6179  35904/simple-way
+0001ce40: 2d74 6f2d 7265 7374 6172 742d 6170 706c  -to-restart-appl
+0001ce50: 6963 6174 696f 6e0a 2020 2020 636c 6f73  ication.    clos
+0001ce60: 655f 616c 6c5f 6664 735f 6578 6365 7074  e_all_fds_except
+0001ce70: 287b 302c 2031 2c20 327d 290a 2020 2020  ({0, 1, 2}).    
+0001ce80: 6f73 2e65 7865 6376 2873 7973 2e65 7865  os.execv(sys.exe
+0001ce90: 6375 7461 626c 652c 205b 7379 732e 6578  cutable, [sys.ex
+0001cea0: 6563 7574 6162 6c65 5d20 2b20 7379 732e  ecutable] + sys.
+0001ceb0: 6172 6776 290a 2020 2020 7261 6973 6520  argv).    raise 
+0001cec0: 4578 6365 7074 696f 6e28 2272 6573 7461  Exception("resta
+0001ced0: 7274 5f72 6574 7572 6e6e 3a20 6578 6563  rt_returnn: exec
+0001cee0: 7620 6661 696c 6564 2229 0a0a 0a64 6566  v failed")...def
+0001cef0: 206d 6179 6265 5f72 6573 7461 7274 5f72   maybe_restart_r
+0001cf00: 6574 7572 6e6e 5f77 6974 685f 6174 666f  eturnn_with_atfo
+0001cf10: 726b 5f70 6174 6368 2829 3a0a 2020 2020  rk_patch():.    
+0001cf20: 2222 220a 2020 2020 5768 6174 2077 6520  """.    What we 
+0001cf30: 7761 6e74 3a20 7375 6270 726f 6365 7373  want: subprocess
+0001cf40: 2e50 6f70 656e 2074 6f20 616c 7761 7973  .Popen to always
+0001cf50: 2077 6f72 6b2e 0a20 2020 2050 726f 626c   work..    Probl
+0001cf60: 656d 3a20 4974 2075 7365 7320 666f 726b  em: It uses fork
+0001cf70: 2b65 7865 6320 696e 7465 726e 616c 6c79  +exec internally
+0001cf80: 2069 6e20 7375 6270 726f 6365 7373 5f66   in subprocess_f
+0001cf90: 6f72 6b5f 6578 6563 2c20 7669 6120 5f70  ork_exec, via _p
+0001cfa0: 6f73 6978 7375 6270 726f 6365 7373 2e66  osixsubprocess.f
+0001cfb0: 6f72 6b5f 6578 6563 2e0a 2020 2020 5468  ork_exec..    Th
+0001cfc0: 6174 2069 7320 6120 7072 6f62 6c65 6d20  at is a problem 
+0001cfd0: 6265 6361 7573 6520 666f 726b 2063 616e  because fork can
+0001cfe0: 2074 7269 6767 6572 2061 6e79 2061 7466   trigger any atf
+0001cff0: 6f72 6b20 6861 6e64 6c65 7273 2072 6567  ork handlers reg
+0001d000: 6973 7465 7265 6420 7669 6120 7074 6872  istered via pthr
+0001d010: 6561 645f 6174 666f 726b 2c0a 2020 2020  ead_atfork,.    
+0001d020: 616e 6420 7468 6f73 6520 6361 6e20 6372  and those can cr
+0001d030: 6173 682f 6465 6164 6c6f 636b 2069 6e20  ash/deadlock in 
+0001d040: 736f 6d65 2063 6173 6573 2e0a 0a20 2020  some cases...   
+0001d050: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
+0001d060: 636f 6d2f 7465 6e73 6f72 666c 6f77 2f74  com/tensorflow/t
+0001d070: 656e 736f 7266 6c6f 772f 6973 7375 6573  ensorflow/issues
+0001d080: 2f31 3338 3032 0a20 2020 2068 7474 7073  /13802.    https
+0001d090: 3a2f 2f67 6974 6875 622e 636f 6d2f 7869  ://github.com/xi
+0001d0a0: 616e 7969 2f4f 7065 6e42 4c41 532f 6973  anyi/OpenBLAS/is
+0001d0b0: 7375 6573 2f32 3430 0a20 2020 2068 7474  sues/240.    htt
+0001d0c0: 7073 3a2f 2f74 7261 632e 7361 6765 6d61  ps://trac.sagema
+0001d0d0: 7468 2e6f 7267 2f74 6963 6b65 742f 3232  th.org/ticket/22
+0001d0e0: 3032 310a 2020 2020 6874 7470 733a 2f2f  021.    https://
+0001d0f0: 6275 6773 2e70 7974 686f 6e2e 6f72 672f  bugs.python.org/
+0001d100: 6973 7375 6533 3138 3134 0a20 2020 2068  issue31814.    h
+0001d110: 7474 7073 3a2f 2f73 7461 636b 6f76 6572  ttps://stackover
+0001d120: 666c 6f77 2e63 6f6d 2f71 7565 7374 696f  flow.com/questio
+0001d130: 6e73 2f34 3638 3435 3439 362f 6c64 2d70  ns/46845496/ld-p
+0001d140: 7265 6c6f 6164 2d61 6e64 2d6c 696e 6b61  reload-and-linka
+0001d150: 6765 0a20 2020 2068 7474 7073 3a2f 2f73  ge.    https://s
+0001d160: 7461 636b 6f76 6572 666c 6f77 2e63 6f6d  tackoverflow.com
+0001d170: 2f71 7565 7374 696f 6e73 2f34 3638 3130  /questions/46810
+0001d180: 3539 372f 666f 726b 6578 6563 2d77 6974  597/forkexec-wit
+0001d190: 686f 7574 2d61 7466 6f72 6b2d 6861 6e64  hout-atfork-hand
+0001d1a0: 6c65 7273 0a0a 2020 2020 5468 6520 736f  lers..    The so
+0001d1b0: 6c75 7469 6f6e 2068 6572 653a 204a 7573  lution here: Jus
+0001d1c0: 7420 6f76 6572 7269 6465 2070 7468 7265  t override pthre
+0001d1d0: 6164 5f61 7466 6f72 6b2c 2076 6961 204c  ad_atfork, via L
+0001d1e0: 445f 5052 454c 4f41 442e 0a20 2020 204e  D_PRELOAD..    N
+0001d1f0: 6f74 6520 7468 6174 2069 6e20 736f 6d65  ote that in some
+0001d200: 2063 6173 6573 2c20 7468 6973 2069 7320   cases, this is 
+0001d210: 6e6f 7420 656e 6f75 6768 2028 7365 6520  not enough (see 
+0001d220: 7468 6520 534f 2064 6973 6375 7373 696f  the SO discussio
+0001d230: 6e29 2c0a 2020 2020 736f 2077 6520 616c  n),.    so we al
+0001d240: 736f 206f 7665 7277 7269 7465 2066 6f72  so overwrite for
+0001d250: 6b20 6974 7365 6c66 2e0a 2020 2020 5365  k itself..    Se
+0001d260: 6520 616c 736f 2074 6573 7473 2f74 6573  e also tests/tes
+0001d270: 745f 666f 726b 5f65 7865 632e 7079 2066  t_fork_exec.py f
+0001d280: 6f72 2061 2064 656d 6f2e 0a20 2020 2022  or a demo..    "
+0001d290: 2222 0a20 2020 2069 6620 6f73 2e65 6e76  "".    if os.env
+0001d2a0: 6972 6f6e 2e67 6574 2822 5f5f 5245 5455  iron.get("__RETU
+0001d2b0: 524e 4e5f 4154 464f 524b 5f50 4154 4348  RNN_ATFORK_PATCH
+0001d2c0: 4544 2229 203d 3d20 2231 223a 0a20 2020  ED") == "1":.   
+0001d2d0: 2020 2020 2070 7269 6e74 2822 5275 6e6e       print("Runn
+0001d2e0: 696e 6720 7769 7468 2070 6174 6368 6564  ing with patched
+0001d2f0: 2061 7466 6f72 6b2e 2229 0a20 2020 2020   atfork.").     
+0001d300: 2020 2072 6574 7572 6e0a 2020 2020 6966     return.    if
+0001d310: 206f 732e 656e 7669 726f 6e2e 6765 7428   os.environ.get(
+0001d320: 225f 5f52 4554 5552 4e4e 5f54 5259 5f41  "__RETURNN_TRY_A
+0001d330: 5446 4f52 4b5f 5041 5443 4845 4422 2920  TFORK_PATCHED") 
+0001d340: 3d3d 2022 3122 3a0a 2020 2020 2020 2020  == "1":.        
+0001d350: 7072 696e 7428 2250 6174 6368 696e 6720  print("Patching 
+0001d360: 6174 666f 726b 2064 6964 206e 6f74 2077  atfork did not w
+0001d370: 6f72 6b21 2057 696c 6c20 636f 6e74 696e  ork! Will contin
+0001d380: 7565 2061 6e79 7761 792e 2229 0a20 2020  ue anyway.").   
+0001d390: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0001d3a0: 6c69 6220 3d20 6765 745f 7061 7463 685f  lib = get_patch_
+0001d3b0: 6174 666f 726b 5f6c 6962 2829 0a20 2020  atfork_lib().   
+0001d3c0: 2065 6e76 203d 206f 732e 656e 7669 726f   env = os.enviro
+0001d3d0: 6e2e 636f 7079 2829 0a20 2020 2065 6e76  n.copy().    env
+0001d3e0: 5b22 4459 4c44 5f49 4e53 4552 545f 4c49  ["DYLD_INSERT_LI
+0001d3f0: 4252 4152 4945 5322 2069 6620 7379 732e  BRARIES" if sys.
+0001d400: 706c 6174 666f 726d 203d 3d20 2264 6172  platform == "dar
+0001d410: 7769 6e22 2065 6c73 6520 224c 445f 5052  win" else "LD_PR
+0001d420: 454c 4f41 4422 5d20 3d20 6c69 620a 2020  ELOAD"] = lib.  
+0001d430: 2020 656e 765b 225f 5f52 4554 5552 4e4e    env["__RETURNN
+0001d440: 5f54 5259 5f41 5446 4f52 4b5f 5041 5443  _TRY_ATFORK_PATC
+0001d450: 4845 4422 5d20 3d20 2231 220a 2020 2020  HED"] = "1".    
+0001d460: 7072 696e 7428 2252 6573 7461 7274 696e  print("Restartin
+0001d470: 6720 5265 7475 726e 6e20 7769 7468 2061  g Returnn with a
+0001d480: 7466 6f72 6b20 7061 7463 682e 2e2e 222c  tfork patch...",
+0001d490: 2073 7973 2e65 7865 6375 7461 626c 652c   sys.executable,
+0001d4a0: 2073 7973 2e61 7267 7629 0a20 2020 2073   sys.argv).    s
+0001d4b0: 7973 2e73 7464 6f75 742e 666c 7573 6828  ys.stdout.flush(
+0001d4c0: 290a 2020 2020 6f73 2e65 7865 6376 7065  ).    os.execvpe
+0001d4d0: 2873 7973 2e65 7865 6375 7461 626c 652c  (sys.executable,
+0001d4e0: 205b 7379 732e 6578 6563 7574 6162 6c65   [sys.executable
+0001d4f0: 5d20 2b20 7379 732e 6172 6776 2c20 656e  ] + sys.argv, en
+0001d500: 7629 0a20 2020 2070 7269 6e74 2822 6578  v).    print("ex
+0001d510: 6563 7670 6520 6469 6420 6e6f 7420 776f  ecvpe did not wo
+0001d520: 726b 3f22 290a 0a0a 6465 6620 636c 6f73  rk?")...def clos
+0001d530: 655f 616c 6c5f 6664 735f 6578 6365 7074  e_all_fds_except
+0001d540: 2865 7863 6570 745f 6664 7329 3a0a 2020  (except_fds):.  
+0001d550: 2020 2222 220a 2020 2020 4361 6c6c 7320    """.    Calls 
+0001d560: 6f73 2e63 6c6f 7365 7261 6e67 6520 6578  os.closerange ex
+0001d570: 6365 7074 2066 6f72 2074 6865 2067 6976  cept for the giv
+0001d580: 656e 2066 6473 2e0a 2020 2020 436f 6465  en fds..    Code
+0001d590: 2061 646f 7074 6564 2061 6e64 2065 7874   adopted and ext
+0001d5a0: 656e 6465 6420 6672 6f6d 206d 756c 7469  ended from multi
+0001d5b0: 7072 6f63 6573 7369 6e67 2e75 7469 6c2e  processing.util.
+0001d5c0: 636c 6f73 655f 616c 6c5f 6664 735f 6578  close_all_fds_ex
+0001d5d0: 6365 7074 2e0a 0a20 2020 203a 7061 7261  cept...    :para
+0001d5e0: 6d20 7479 7069 6e67 2e43 6f6c 6c65 6374  m typing.Collect
+0001d5f0: 696f 6e5b 696e 745d 2065 7863 6570 745f  ion[int] except_
+0001d600: 6664 733a 2075 7375 616c 6c79 2061 7420  fds: usually at 
+0001d610: 6c65 6173 7420 7b30 2c31 2c32 7d0a 2020  least {0,1,2}.  
+0001d620: 2020 2222 220a 2020 2020 2320 6e6f 696e    """.    # noin
+0001d630: 7370 6563 7469 6f6e 2050 7942 726f 6164  spection PyBroad
+0001d640: 4578 6365 7074 696f 6e0a 2020 2020 7472  Exception.    tr
+0001d650: 793a 0a20 2020 2020 2020 206d 6178 5f66  y:.        max_f
+0001d660: 6420 3d20 6f73 2e73 7973 636f 6e66 2822  d = os.sysconf("
+0001d670: 5343 5f4f 5045 4e5f 4d41 5822 290a 2020  SC_OPEN_MAX").  
+0001d680: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0001d690: 6f6e 3a0a 2020 2020 2020 2020 6d61 785f  on:.        max_
+0001d6a0: 6664 203d 2032 3536 0a0a 2020 2020 6578  fd = 256..    ex
+0001d6b0: 6365 7074 5f66 6473 203d 2073 6f72 7465  cept_fds = sorte
+0001d6c0: 6428 6c69 7374 2865 7863 6570 745f 6664  d(list(except_fd
+0001d6d0: 7329 202b 205b 2d31 2c20 6d61 785f 6664  s) + [-1, max_fd
+0001d6e0: 5d29 0a20 2020 2061 7373 6572 7420 6578  ]).    assert ex
+0001d6f0: 6365 7074 5f66 6473 5b30 5d20 3d3d 202d  cept_fds[0] == -
+0001d700: 3120 616e 6420 6578 6365 7074 5f66 6473  1 and except_fds
+0001d710: 5b2d 315d 203d 3d20 6d61 785f 6664 2c20  [-1] == max_fd, 
+0001d720: 2266 6420 696e 7661 6c69 6422 0a0a 2020  "fd invalid"..  
+0001d730: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0001d740: 286c 656e 2865 7863 6570 745f 6664 7329  (len(except_fds)
+0001d750: 202d 2031 293a 0a20 2020 2020 2020 2069   - 1):.        i
+0001d760: 6620 6578 6365 7074 5f66 6473 5b69 5d20  f except_fds[i] 
+0001d770: 2b20 3120 3c20 6578 6365 7074 5f66 6473  + 1 < except_fds
+0001d780: 5b69 202b 2031 5d3a 0a20 2020 2020 2020  [i + 1]:.       
+0001d790: 2020 2020 206f 732e 636c 6f73 6572 616e       os.closeran
+0001d7a0: 6765 2865 7863 6570 745f 6664 735b 695d  ge(except_fds[i]
+0001d7b0: 202b 2031 2c20 6578 6365 7074 5f66 6473   + 1, except_fds
+0001d7c0: 5b69 202b 2031 5d29 0a0a 0a63 6c61 7373  [i + 1])...class
+0001d7d0: 2053 7461 7473 3a0a 2020 2020 2222 220a   Stats:.    """.
+0001d7e0: 2020 2020 436f 6c6c 6563 7473 206d 6561      Collects mea
+0001d7f0: 6e20 616e 6420 7661 7269 616e 6365 2c20  n and variance, 
+0001d800: 7275 6e6e 696e 6720 6176 6572 6167 652e  running average.
+0001d810: 0a0a 2020 2020 6874 7470 733a 2f2f 656e  ..    https://en
+0001d820: 2e77 696b 6970 6564 6961 2e6f 7267 2f77  .wikipedia.org/w
+0001d830: 696b 692f 416c 676f 7269 7468 6d73 5f66  iki/Algorithms_f
+0001d840: 6f72 5f63 616c 6375 6c61 7469 6e67 5f76  or_calculating_v
+0001d850: 6172 6961 6e63 650a 2020 2020 2222 220a  ariance.    """.
+0001d860: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0001d870: 5f28 7365 6c66 2c20 666f 726d 6174 5f73  _(self, format_s
+0001d880: 7472 3d4e 6f6e 6529 3a0a 2020 2020 2020  tr=None):.      
+0001d890: 2020 2222 220a 2020 2020 2020 2020 3a70    """.        :p
+0001d8a0: 6172 616d 204e 6f6e 657c 2828 666c 6f61  aram None|((floa
+0001d8b0: 747c 6e75 6d70 792e 6e64 6172 7261 7929  t|numpy.ndarray)
+0001d8c0: 2d3e 7374 7229 2066 6f72 6d61 745f 7374  ->str) format_st
+0001d8d0: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+0001d8e0: 2020 2020 2020 2073 656c 662e 666f 726d         self.form
+0001d8f0: 6174 5f73 7472 203d 2066 6f72 6d61 745f  at_str = format_
+0001d900: 7374 7220 6f72 2073 7472 0a20 2020 2020  str or str.     
+0001d910: 2020 2073 656c 662e 6d65 616e 203d 2030     self.mean = 0
+0001d920: 2e30 0a20 2020 2020 2020 2073 656c 662e  .0.        self.
+0001d930: 6d65 616e 5f73 7120 3d20 302e 300a 2020  mean_sq = 0.0.  
+0001d940: 2020 2020 2020 7365 6c66 2e76 6172 203d        self.var =
+0001d950: 2030 2e30 0a20 2020 2020 2020 2073 656c   0.0.        sel
+0001d960: 662e 6d69 6e20 3d20 4e6f 6e65 0a20 2020  f.min = None.   
+0001d970: 2020 2020 2073 656c 662e 6d61 7820 3d20       self.max = 
+0001d980: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+0001d990: 662e 746f 7461 6c5f 6461 7461 5f6c 656e  f.total_data_len
+0001d9a0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0001d9b0: 662e 6e75 6d5f 7365 7173 203d 2030 0a0a  f.num_seqs = 0..
+0001d9c0: 2020 2020 6465 6620 5f5f 7374 725f 5f28      def __str__(
+0001d9d0: 7365 6c66 293a 0a20 2020 2020 2020 2069  self):.        i
+0001d9e0: 6620 7365 6c66 2e6e 756d 5f73 6571 7320  f self.num_seqs 
+0001d9f0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0001da00: 2069 6620 7365 6c66 2e6e 756d 5f73 6571   if self.num_seq
+0001da10: 7320 3d3d 2073 656c 662e 746f 7461 6c5f  s == self.total_
+0001da20: 6461 7461 5f6c 656e 3a0a 2020 2020 2020  data_len:.      
+0001da30: 2020 2020 2020 2020 2020 6578 7472 615f            extra_
+0001da40: 7374 7220 3d20 2261 7667 5f64 6174 615f  str = "avg_data_
+0001da50: 6c65 6e3d 3122 0a20 2020 2020 2020 2020  len=1".         
+0001da60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001da70: 2020 2020 2020 2020 2065 7874 7261 5f73           extra_s
+0001da80: 7472 203d 2022 746f 7461 6c5f 6461 7461  tr = "total_data
+0001da90: 5f6c 656e 3d25 692c 2061 7667 5f64 6174  _len=%i, avg_dat
+0001daa0: 615f 6c65 6e3d 2566 2220 2520 280a 2020  a_len=%f" % (.  
+0001dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dac0: 2020 7365 6c66 2e74 6f74 616c 5f64 6174    self.total_dat
+0001dad0: 615f 6c65 6e2c 0a20 2020 2020 2020 2020  a_len,.         
+0001dae0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0001daf0: 2873 656c 662e 746f 7461 6c5f 6461 7461  (self.total_data
+0001db00: 5f6c 656e 2920 2f20 7365 6c66 2e6e 756d  _len) / self.num
+0001db10: 5f73 6571 732c 0a20 2020 2020 2020 2020  _seqs,.         
+0001db20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001db30: 2020 2020 2072 6574 7572 6e20 2253 7461       return "Sta
+0001db40: 7473 286d 6561 6e3d 2573 2c20 7374 645f  ts(mean=%s, std_
+0001db50: 6465 763d 2573 2c20 6d69 6e3d 2573 2c20  dev=%s, min=%s, 
+0001db60: 6d61 783d 2573 2c20 6e75 6d5f 7365 7173  max=%s, num_seqs
+0001db70: 3d25 692c 2025 7329 2220 2520 280a 2020  =%i, %s)" % (.  
+0001db80: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001db90: 6c66 2e66 6f72 6d61 745f 7374 7228 7365  lf.format_str(se
+0001dba0: 6c66 2e67 6574 5f6d 6561 6e28 2929 2c0a  lf.get_mean()),.
+0001dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbc0: 7365 6c66 2e66 6f72 6d61 745f 7374 7228  self.format_str(
+0001dbd0: 7365 6c66 2e67 6574 5f73 7464 5f64 6576  self.get_std_dev
+0001dbe0: 2829 292c 0a20 2020 2020 2020 2020 2020  ()),.           
+0001dbf0: 2020 2020 2073 656c 662e 666f 726d 6174       self.format
+0001dc00: 5f73 7472 2873 656c 662e 6d69 6e29 2c0a  _str(self.min),.
+0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc20: 7365 6c66 2e66 6f72 6d61 745f 7374 7228  self.format_str(
+0001dc30: 7365 6c66 2e6d 6178 292c 0a20 2020 2020  self.max),.     
+0001dc40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001dc50: 6e75 6d5f 7365 7173 2c0a 2020 2020 2020  num_seqs,.      
+0001dc60: 2020 2020 2020 2020 2020 6578 7472 615f            extra_
+0001dc70: 7374 722c 0a20 2020 2020 2020 2020 2020  str,.           
+0001dc80: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0001dc90: 6e20 2253 7461 7473 286e 756d 5f73 6571  n "Stats(num_seq
+0001dca0: 733d 3029 220a 0a20 2020 2064 6566 2063  s=0)"..    def c
+0001dcb0: 6f6c 6c65 6374 2873 656c 662c 2064 6174  ollect(self, dat
+0001dcc0: 6129 3a0a 2020 2020 2020 2020 2222 220a  a):.        """.
+0001dcd0: 2020 2020 2020 2020 3a70 6172 616d 206e          :param n
+0001dce0: 756d 7079 2e6e 6461 7272 6179 7c6c 6973  umpy.ndarray|lis
+0001dcf0: 745b 696e 745d 7c6c 6973 745b 666c 6f61  t[int]|list[floa
+0001dd00: 745d 2064 6174 613a 2073 6861 7065 2028  t] data: shape (
+0001dd10: 7469 6d65 2c20 6469 6d29 206f 7220 2874  time, dim) or (t
+0001dd20: 696d 652c 290a 2020 2020 2020 2020 2222  ime,).        ""
+0001dd30: 220a 2020 2020 2020 2020 696d 706f 7274  ".        import
+0001dd40: 206e 756d 7079 0a0a 2020 2020 2020 2020   numpy..        
+0001dd50: 6966 2069 7369 6e73 7461 6e63 6528 6461  if isinstance(da
+0001dd60: 7461 2c20 286c 6973 742c 2074 7570 6c65  ta, (list, tuple
+0001dd70: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0001dd80: 6461 7461 203d 206e 756d 7079 2e61 7272  data = numpy.arr
+0001dd90: 6179 2864 6174 6129 0a20 2020 2020 2020  ay(data).       
+0001dda0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0001ddb0: 6365 2864 6174 612c 206e 756d 7079 2e6e  ce(data, numpy.n
+0001ddc0: 6461 7272 6179 290a 2020 2020 2020 2020  darray).        
+0001ddd0: 6173 7365 7274 2064 6174 612e 6e64 696d  assert data.ndim
+0001dde0: 203e 3d20 310a 2020 2020 2020 2020 6966   >= 1.        if
+0001ddf0: 2064 6174 612e 7368 6170 655b 305d 203d   data.shape[0] =
+0001de00: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0001de10: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0001de20: 7365 6c66 2e6e 756d 5f73 6571 7320 2b3d  self.num_seqs +=
+0001de30: 2031 0a20 2020 2020 2020 2064 6174 615f   1.        data_
+0001de40: 6d69 6e20 3d20 6e75 6d70 792e 6d69 6e28  min = numpy.min(
+0001de50: 6461 7461 2c20 6178 6973 3d30 290a 2020  data, axis=0).  
+0001de60: 2020 2020 2020 6461 7461 5f6d 6178 203d        data_max =
+0001de70: 206e 756d 7079 2e6d 6178 2864 6174 612c   numpy.max(data,
+0001de80: 2061 7869 733d 3029 0a20 2020 2020 2020   axis=0).       
+0001de90: 2069 6620 7365 6c66 2e6d 696e 2069 7320   if self.min is 
+0001dea0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001deb0: 2020 7365 6c66 2e6d 696e 203d 2064 6174    self.min = dat
+0001dec0: 615f 6d69 6e0a 2020 2020 2020 2020 2020  a_min.          
+0001ded0: 2020 7365 6c66 2e6d 6178 203d 2064 6174    self.max = dat
+0001dee0: 615f 6d61 780a 2020 2020 2020 2020 656c  a_max.        el
+0001def0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001df00: 7365 6c66 2e6d 696e 203d 206e 756d 7079  self.min = numpy
+0001df10: 2e6d 696e 696d 756d 2873 656c 662e 6d69  .minimum(self.mi
+0001df20: 6e2c 2064 6174 615f 6d69 6e29 0a20 2020  n, data_min).   
+0001df30: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+0001df40: 7820 3d20 6e75 6d70 792e 6d61 7869 6d75  x = numpy.maximu
+0001df50: 6d28 7365 6c66 2e6d 6178 2c20 6461 7461  m(self.max, data
+0001df60: 5f6d 6178 290a 2020 2020 2020 2020 6e65  _max).        ne
+0001df70: 775f 746f 7461 6c5f 6461 7461 5f6c 656e  w_total_data_len
+0001df80: 203d 2073 656c 662e 746f 7461 6c5f 6461   = self.total_da
+0001df90: 7461 5f6c 656e 202b 2064 6174 612e 7368  ta_len + data.sh
+0001dfa0: 6170 655b 305d 0a20 2020 2020 2020 206d  ape[0].        m
+0001dfb0: 6561 6e5f 6469 6666 203d 206e 756d 7079  ean_diff = numpy
+0001dfc0: 2e6d 6561 6e28 6461 7461 2c20 6178 6973  .mean(data, axis
+0001dfd0: 3d30 2920 2d20 7365 6c66 2e6d 6561 6e0a  =0) - self.mean.
+0001dfe0: 2020 2020 2020 2020 6d5f 6120 3d20 7365          m_a = se
+0001dff0: 6c66 2e76 6172 202a 2073 656c 662e 746f  lf.var * self.to
+0001e000: 7461 6c5f 6461 7461 5f6c 656e 0a20 2020  tal_data_len.   
+0001e010: 2020 2020 206d 5f62 203d 206e 756d 7079       m_b = numpy
+0001e020: 2e76 6172 2864 6174 612c 2061 7869 733d  .var(data, axis=
+0001e030: 3029 202a 2064 6174 612e 7368 6170 655b  0) * data.shape[
+0001e040: 305d 0a20 2020 2020 2020 206d 3220 3d20  0].        m2 = 
+0001e050: 6d5f 6120 2b20 6d5f 6220 2b20 6d65 616e  m_a + m_b + mean
+0001e060: 5f64 6966 662a 2a32 202a 2073 656c 662e  _diff**2 * self.
+0001e070: 746f 7461 6c5f 6461 7461 5f6c 656e 202a  total_data_len *
+0001e080: 2064 6174 612e 7368 6170 655b 305d 202f   data.shape[0] /
+0001e090: 206e 6577 5f74 6f74 616c 5f64 6174 615f   new_total_data_
+0001e0a0: 6c65 6e0a 2020 2020 2020 2020 7365 6c66  len.        self
+0001e0b0: 2e76 6172 203d 206d 3220 2f20 6e65 775f  .var = m2 / new_
+0001e0c0: 746f 7461 6c5f 6461 7461 5f6c 656e 0a20  total_data_len. 
+0001e0d0: 2020 2020 2020 2064 6174 615f 7375 6d20         data_sum 
+0001e0e0: 3d20 6e75 6d70 792e 7375 6d28 6461 7461  = numpy.sum(data
+0001e0f0: 2c20 6178 6973 3d30 290a 2020 2020 2020  , axis=0).      
+0001e100: 2020 6465 6c74 6120 3d20 6461 7461 5f73    delta = data_s
+0001e110: 756d 202d 2073 656c 662e 6d65 616e 202a  um - self.mean *
+0001e120: 2064 6174 612e 7368 6170 655b 305d 0a20   data.shape[0]. 
+0001e130: 2020 2020 2020 2073 656c 662e 6d65 616e         self.mean
+0001e140: 202b 3d20 6465 6c74 6120 2f20 6e65 775f   += delta / new_
+0001e150: 746f 7461 6c5f 6461 7461 5f6c 656e 0a20  total_data_len. 
+0001e160: 2020 2020 2020 2064 656c 7461 5f73 7120         delta_sq 
+0001e170: 3d20 6e75 6d70 792e 7375 6d28 6461 7461  = numpy.sum(data
+0001e180: 202a 2064 6174 612c 2061 7869 733d 3029   * data, axis=0)
+0001e190: 202d 2073 656c 662e 6d65 616e 5f73 7120   - self.mean_sq 
+0001e1a0: 2a20 6461 7461 2e73 6861 7065 5b30 5d0a  * data.shape[0].
+0001e1b0: 2020 2020 2020 2020 7365 6c66 2e6d 6561          self.mea
+0001e1c0: 6e5f 7371 202b 3d20 6465 6c74 615f 7371  n_sq += delta_sq
+0001e1d0: 202f 206e 6577 5f74 6f74 616c 5f64 6174   / new_total_dat
+0001e1e0: 615f 6c65 6e0a 2020 2020 2020 2020 7365  a_len.        se
+0001e1f0: 6c66 2e74 6f74 616c 5f64 6174 615f 6c65  lf.total_data_le
+0001e200: 6e20 3d20 6e65 775f 746f 7461 6c5f 6461  n = new_total_da
+0001e210: 7461 5f6c 656e 0a0a 2020 2020 6465 6620  ta_len..    def 
+0001e220: 6765 745f 6d65 616e 2873 656c 6629 3a0a  get_mean(self):.
+0001e230: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001e240: 2020 2020 3a72 6574 7572 6e3a 206d 6561      :return: mea
+0001e250: 6e2c 2073 6861 7065 2028 6469 6d2c 290a  n, shape (dim,).
+0001e260: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+0001e270: 6e75 6d70 792e 6e64 6172 7261 790a 2020  numpy.ndarray.  
+0001e280: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001e290: 2020 6173 7365 7274 2073 656c 662e 6e75    assert self.nu
+0001e2a0: 6d5f 7365 7173 203e 2030 0a20 2020 2020  m_seqs > 0.     
+0001e2b0: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
+0001e2c0: 6561 6e0a 0a20 2020 2064 6566 2067 6574  ean..    def get
+0001e2d0: 5f73 7464 5f64 6576 2873 656c 6629 3a0a  _std_dev(self):.
+0001e2e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001e2f0: 2020 2020 3a72 6574 7572 6e3a 2073 7464      :return: std
+0001e300: 2064 6576 2c20 7368 6170 6520 2864 696d   dev, shape (dim
+0001e310: 2c29 0a20 2020 2020 2020 203a 7274 7970  ,).        :rtyp
+0001e320: 653a 206e 756d 7079 2e6e 6461 7272 6179  e: numpy.ndarray
+0001e330: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001e340: 2020 2020 2069 6d70 6f72 7420 6e75 6d70       import nump
+0001e350: 790a 0a20 2020 2020 2020 2061 7373 6572  y..        asser
+0001e360: 7420 7365 6c66 2e6e 756d 5f73 6571 7320  t self.num_seqs 
+0001e370: 3e20 300a 2020 2020 2020 2020 7265 7475  > 0.        retu
+0001e380: 726e 206e 756d 7079 2e73 7172 7428 7365  rn numpy.sqrt(se
+0001e390: 6c66 2e76 6172 290a 2020 2020 2020 2020  lf.var).        
+0001e3a0: 2320 7265 7475 726e 206e 756d 7079 2e73  # return numpy.s
+0001e3b0: 7172 7428 7365 6c66 2e6d 6561 6e5f 7371  qrt(self.mean_sq
+0001e3c0: 202d 2073 656c 662e 6d65 616e 202a 2073   - self.mean * s
+0001e3d0: 656c 662e 6d65 616e 290a 0a20 2020 2064  elf.mean)..    d
+0001e3e0: 6566 2064 756d 7028 7365 6c66 2c20 6f75  ef dump(self, ou
+0001e3f0: 7470 7574 5f66 696c 655f 7072 6566 6978  tput_file_prefix
+0001e400: 3d4e 6f6e 652c 2073 7472 6561 6d3d 4e6f  =None, stream=No
+0001e410: 6e65 2c20 7374 7265 616d 5f70 7265 6669  ne, stream_prefi
+0001e420: 783d 2222 293a 0a20 2020 2020 2020 2022  x=""):.        "
+0001e430: 2222 0a20 2020 2020 2020 203a 7061 7261  "".        :para
+0001e440: 6d20 7374 727c 4e6f 6e65 206f 7574 7075  m str|None outpu
+0001e450: 745f 6669 6c65 5f70 7265 6669 783a 2069  t_file_prefix: i
+0001e460: 6620 6769 7665 6e2c 2077 696c 6c20 6e75  f given, will nu
+0001e470: 6d70 792e 7361 7665 7478 7420 6d65 616e  mpy.savetxt mean
+0001e480: 7c73 7464 5f64 6576 2074 6f20 6469 736b  |std_dev to disk
+0001e490: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001e4a0: 7374 7220 7374 7265 616d 5f70 7265 6669  str stream_prefi
+0001e4b0: 783a 0a20 2020 2020 2020 203a 7061 7261  x:.        :para
+0001e4c0: 6d20 696f 2e54 6578 7449 4f42 6173 6520  m io.TextIOBase 
+0001e4d0: 7374 7265 616d 3a20 7379 732e 7374 646f  stream: sys.stdo
+0001e4e0: 7574 2062 7920 6465 6661 756c 740a 2020  ut by default.  
+0001e4f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001e500: 2020 6966 2073 7472 6561 6d20 6973 204e    if stream is N
+0001e510: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001e520: 2073 7472 6561 6d20 3d20 7379 732e 7374   stream = sys.st
+0001e530: 646f 7574 0a20 2020 2020 2020 2069 6d70  dout.        imp
+0001e540: 6f72 7420 6e75 6d70 790a 0a20 2020 2020  ort numpy..     
+0001e550: 2020 2070 7269 6e74 2822 2573 5374 6174     print("%sStat
+0001e560: 733a 2220 2520 7374 7265 616d 5f70 7265  s:" % stream_pre
+0001e570: 6669 782c 2066 696c 653d 7374 7265 616d  fix, file=stream
+0001e580: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+0001e590: 662e 6e75 6d5f 7365 7173 2021 3d20 7365  f.num_seqs != se
+0001e5a0: 6c66 2e74 6f74 616c 5f64 6174 615f 6c65  lf.total_data_le
+0001e5b0: 6e3a 0a20 2020 2020 2020 2020 2020 2070  n:.            p
+0001e5c0: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
+0001e5d0: 2020 2020 2020 2220 2025 6920 7365 7173        "  %i seqs
+0001e5e0: 2c20 2569 2074 6f74 616c 2066 7261 6d65  , %i total frame
+0001e5f0: 732c 2025 6620 6176 6572 6167 6520 6672  s, %f average fr
+0001e600: 616d 6573 220a 2020 2020 2020 2020 2020  ames".          
+0001e610: 2020 2020 2020 2520 2873 656c 662e 6e75        % (self.nu
+0001e620: 6d5f 7365 7173 2c20 7365 6c66 2e74 6f74  m_seqs, self.tot
+0001e630: 616c 5f64 6174 615f 6c65 6e2c 2073 656c  al_data_len, sel
+0001e640: 662e 746f 7461 6c5f 6461 7461 5f6c 656e  f.total_data_len
+0001e650: 202f 2066 6c6f 6174 2873 656c 662e 6e75   / float(self.nu
+0001e660: 6d5f 7365 7173 2929 2c0a 2020 2020 2020  m_seqs)),.      
+0001e670: 2020 2020 2020 2020 2020 6669 6c65 3d73            file=s
+0001e680: 7472 6561 6d2c 0a20 2020 2020 2020 2020  tream,.         
+0001e690: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+0001e6a0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0001e6b0: 7269 6e74 2822 2020 2569 2073 6571 7322  rint("  %i seqs"
+0001e6c0: 2025 2028 7365 6c66 2e6e 756d 5f73 6571   % (self.num_seq
+0001e6d0: 732c 292c 2066 696c 653d 7374 7265 616d  s,), file=stream
+0001e6e0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+0001e6f0: 662e 6e75 6d5f 7365 7173 203e 2030 3a0a  f.num_seqs > 0:.
+0001e700: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001e710: 7428 2220 204d 6561 6e3a 2025 7322 2025  t("  Mean: %s" %
+0001e720: 2028 7365 6c66 2e66 6f72 6d61 745f 7374   (self.format_st
+0001e730: 7228 7365 6c66 2e67 6574 5f6d 6561 6e28  r(self.get_mean(
+0001e740: 2929 2c29 2c20 6669 6c65 3d73 7472 6561  )),), file=strea
+0001e750: 6d29 0a20 2020 2020 2020 2020 2020 2070  m).            p
+0001e760: 7269 6e74 2822 2020 5374 6420 6465 763a  rint("  Std dev:
+0001e770: 2025 7322 2025 2028 7365 6c66 2e66 6f72   %s" % (self.for
+0001e780: 6d61 745f 7374 7228 7365 6c66 2e67 6574  mat_str(self.get
+0001e790: 5f73 7464 5f64 6576 2829 292c 292c 2066  _std_dev()),), f
+0001e7a0: 696c 653d 7374 7265 616d 290a 2020 2020  ile=stream).    
+0001e7b0: 2020 2020 2020 2020 7072 696e 7428 2220          print(" 
+0001e7c0: 204d 696e 2f6d 6178 3a20 2573 202f 2025   Min/max: %s / %
+0001e7d0: 7322 2025 2028 7365 6c66 2e66 6f72 6d61  s" % (self.forma
+0001e7e0: 745f 7374 7228 7365 6c66 2e6d 696e 292c  t_str(self.min),
+0001e7f0: 2073 656c 662e 666f 726d 6174 5f73 7472   self.format_str
+0001e800: 2873 656c 662e 6d61 7829 292c 2066 696c  (self.max)), fil
+0001e810: 653d 7374 7265 616d 290a 2020 2020 2020  e=stream).      
+0001e820: 2020 2020 2020 2320 7072 696e 7428 2253        # print("S
+0001e830: 7464 2064 6576 2028 6e61 6976 6529 3a20  td dev (naive): 
+0001e840: 2573 2220 2520 6e75 6d70 792e 7371 7274  %s" % numpy.sqrt
+0001e850: 2873 656c 662e 6d65 616e 5f73 7120 2d20  (self.mean_sq - 
+0001e860: 7365 6c66 2e6d 6561 6e20 2a20 7365 6c66  self.mean * self
+0001e870: 2e6d 6561 6e29 2c20 6669 6c65 3d73 7472  .mean), file=str
+0001e880: 6561 6d29 0a20 2020 2020 2020 2065 6c73  eam).        els
+0001e890: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0001e8a0: 7269 6e74 2822 2020 284e 6f20 6461 7461  rint("  (No data
+0001e8b0: 2922 2c20 6669 6c65 3d73 7472 6561 6d29  )", file=stream)
+0001e8c0: 0a20 2020 2020 2020 2069 6620 6f75 7470  .        if outp
+0001e8d0: 7574 5f66 696c 655f 7072 6566 6978 3a0a  ut_file_prefix:.
+0001e8e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001e8f0: 7274 2073 656c 662e 6e75 6d5f 7365 7173  rt self.num_seqs
+0001e900: 203e 2030 2c20 2263 616e 6e6f 7420 6475   > 0, "cannot du
+0001e910: 6d70 2073 7461 7473 2077 6974 686f 7574  mp stats without
+0001e920: 2061 6e79 2064 6174 6122 0a20 2020 2020   any data".     
+0001e930: 2020 2020 2020 2070 7269 6e74 2822 2020         print("  
+0001e940: 5772 6974 6520 6d65 616e 2f73 7464 2d64  Write mean/std-d
+0001e950: 6576 2074 6f20 2573 2e28 6d65 616e 7c73  ev to %s.(mean|s
+0001e960: 7464 5f64 6576 292e 7478 742e 2220 2520  td_dev).txt." % 
+0001e970: 286f 7574 7075 745f 6669 6c65 5f70 7265  (output_file_pre
+0001e980: 6669 782c 292c 2066 696c 653d 7374 7265  fix,), file=stre
+0001e990: 616d 290a 2020 2020 2020 2020 2020 2020  am).            
+0001e9a0: 6e75 6d70 792e 7361 7665 7478 7428 2225  numpy.savetxt("%
+0001e9b0: 732e 6d65 616e 2e74 7874 2220 2520 6f75  s.mean.txt" % ou
+0001e9c0: 7470 7574 5f66 696c 655f 7072 6566 6978  tput_file_prefix
+0001e9d0: 2c20 7365 6c66 2e67 6574 5f6d 6561 6e28  , self.get_mean(
+0001e9e0: 2929 0a20 2020 2020 2020 2020 2020 206e  )).            n
+0001e9f0: 756d 7079 2e73 6176 6574 7874 2822 2573  umpy.savetxt("%s
+0001ea00: 2e73 7464 5f64 6576 2e74 7874 2220 2520  .std_dev.txt" % 
+0001ea10: 6f75 7470 7574 5f66 696c 655f 7072 6566  output_file_pref
+0001ea20: 6978 2c20 7365 6c66 2e67 6574 5f73 7464  ix, self.get_std
+0001ea30: 5f64 6576 2829 290a 0a0a 6465 6620 6973  _dev())...def is
+0001ea40: 5f6e 616d 6564 7475 706c 6528 636c 7329  _namedtuple(cls)
+0001ea50: 3a0a 2020 2020 2222 220a 2020 2020 3a70  :.    """.    :p
+0001ea60: 6172 616d 2054 2063 6c73 3a20 7475 706c  aram T cls: tupl
+0001ea70: 652c 206c 6973 7420 6f72 206e 616d 6564  e, list or named
+0001ea80: 7475 706c 6520 7479 7065 0a20 2020 203a  tuple type.    :
+0001ea90: 7265 7475 726e 3a20 7768 6574 6865 7220  return: whether 
+0001eaa0: 636c 7320 6973 2061 206e 616d 6564 7475  cls is a namedtu
+0001eab0: 706c 6520 7479 7065 0a20 2020 203a 7274  ple type.    :rt
+0001eac0: 7970 653a 2062 6f6f 6c0a 2020 2020 2222  ype: bool.    ""
+0001ead0: 220a 2020 2020 7265 7475 726e 2069 7373  ".    return iss
+0001eae0: 7562 636c 6173 7328 636c 732c 2074 7570  ubclass(cls, tup
+0001eaf0: 6c65 2920 616e 6420 636c 7320 6973 206e  le) and cls is n
+0001eb00: 6f74 2074 7570 6c65 0a0a 0a64 6566 206d  ot tuple...def m
+0001eb10: 616b 655f 7365 715f 6f66 5f74 7970 6528  ake_seq_of_type(
+0001eb20: 636c 732c 2073 6571 293a 0a20 2020 2022  cls, seq):.    "
+0001eb30: 2222 0a20 2020 203a 7061 7261 6d20 7479  "".    :param ty
+0001eb40: 7065 5b54 5d20 636c 733a 2065 2e67 2e20  pe[T] cls: e.g. 
+0001eb50: 7475 706c 652c 206c 6973 7420 6f72 206e  tuple, list or n
+0001eb60: 616d 6564 7475 706c 650a 2020 2020 3a70  amedtuple.    :p
+0001eb70: 6172 616d 206c 6973 747c 7475 706c 657c  aram list|tuple|
+0001eb80: 5420 7365 713a 0a20 2020 203a 7265 7475  T seq:.    :retu
+0001eb90: 726e 3a20 636c 7328 7365 7129 206f 7220  rn: cls(seq) or 
+0001eba0: 636c 7328 2a73 6571 290a 2020 2020 3a72  cls(*seq).    :r
+0001ebb0: 7479 7065 3a20 547c 6c69 7374 7c74 7570  type: T|list|tup
+0001ebc0: 6c65 0a20 2020 2022 2222 0a20 2020 2061  le.    """.    a
+0001ebd0: 7373 6572 7420 6973 7375 6263 6c61 7373  ssert issubclass
+0001ebe0: 2863 6c73 2c20 286c 6973 742c 2074 7570  (cls, (list, tup
+0001ebf0: 6c65 2929 0a20 2020 2069 6620 6973 5f6e  le)).    if is_n
+0001ec00: 616d 6564 7475 706c 6528 636c 7329 3a0a  amedtuple(cls):.
+0001ec10: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0001ec20: 6c73 282a 7365 7129 2020 2320 6e6f 7161  ls(*seq)  # noqa
+0001ec30: 0a20 2020 2072 6574 7572 6e20 636c 7328  .    return cls(
+0001ec40: 7365 7129 2020 2320 6e6f 7161 0a0a 0a64  seq)  # noqa...d
+0001ec50: 6566 2065 6e73 7572 655f 6c69 7374 5f6f  ef ensure_list_o
+0001ec60: 665f 7479 7065 286c 732c 2074 7970 655f  f_type(ls, type_
+0001ec70: 293a 0a20 2020 2022 2222 0a20 2020 203a  ):.    """.    :
+0001ec80: 7061 7261 6d20 6c69 7374 206c 733a 0a20  param list ls:. 
+0001ec90: 2020 203a 7061 7261 6d20 2828 292d 3e54     :param (()->T
+0001eca0: 297c 7479 7065 5b54 5d20 7479 7065 5f3a  )|type[T] type_:
+0001ecb0: 2074 7970 6520 6f66 2069 6e73 7461 6e63   type of instanc
+0001ecc0: 6573 206f 6620 606c 7360 2e0a 2020 2020  es of `ls`..    
+0001ecd0: 2020 4e6f 7465 2074 6865 2073 7472 616e    Note the stran
+0001ece0: 6765 2074 7970 6520 6865 7265 2069 6e20  ge type here in 
+0001ecf0: 7468 6520 646f 6373 7472 696e 6720 6973  the docstring is
+0001ed00: 2064 7565 2074 6f20 736f 6d65 2050 7943   due to some PyC
+0001ed10: 6861 726d 2074 7970 6520 696e 6665 7265  harm type infere
+0001ed20: 6e63 6520 7072 6f62 6c65 6d73 0a20 2020  nce problems.   
+0001ed30: 2020 2028 6874 7470 733a 2f2f 796f 7574     (https://yout
+0001ed40: 7261 636b 2e6a 6574 6272 6169 6e73 2e63  rack.jetbrains.c
+0001ed50: 6f6d 2f69 7373 7565 2f50 592d 3530 3832  om/issue/PY-5082
+0001ed60: 3829 2e0a 2020 2020 3a72 7479 7065 3a20  8)..    :rtype: 
+0001ed70: 6c69 7374 5b54 5d0a 2020 2020 2222 220a  list[T].    """.
+0001ed80: 2020 2020 6173 7365 7274 2061 6c6c 2869      assert all(i
+0001ed90: 7369 6e73 7461 6e63 6528 656c 656d 2c20  sinstance(elem, 
+0001eda0: 7479 7065 5f29 2066 6f72 2065 6c65 6d20  type_) for elem 
+0001edb0: 696e 206c 7329 0a20 2020 2072 6574 7572  in ls).    retur
+0001edc0: 6e20 6c73 0a0a 0a64 6566 205f 6765 745f  n ls...def _get_
+0001edd0: 6e67 7261 6d73 2873 6567 6d65 6e74 2c20  ngrams(segment, 
+0001ede0: 6d61 785f 6f72 6465 7229 3a0a 2020 2020  max_order):.    
+0001edf0: 2222 2245 7874 7261 6374 7320 616c 6c20  """Extracts all 
+0001ee00: 6e2d 6772 616d 7320 7570 746f 2061 2067  n-grams upto a g
+0001ee10: 6976 656e 206d 6178 696d 756d 206f 7264  iven maximum ord
+0001ee20: 6572 2066 726f 6d20 616e 2069 6e70 7574  er from an input
+0001ee30: 2073 6567 6d65 6e74 2e0a 2020 2020 436f   segment..    Co
+0001ee40: 6465 2061 6461 7074 6564 2066 726f 6d20  de adapted from 
+0001ee50: 476f 6f67 6c65 2054 656e 736f 7232 5465  Google Tensor2Te
+0001ee60: 6e73 6f72 2e0a 0a20 2020 2041 7267 733a  nsor...    Args:
+0001ee70: 0a20 2020 2020 2073 6567 6d65 6e74 2028  .      segment (
+0001ee80: 6c69 7374 5b69 6e74 5d7c 6c69 7374 5b73  list[int]|list[s
+0001ee90: 7472 5d29 3a20 7465 7874 2073 6567 6d65  tr]): text segme
+0001eea0: 6e74 2066 726f 6d20 7768 6963 6820 6e2d  nt from which n-
+0001eeb0: 6772 616d 7320 7769 6c6c 2062 6520 6578  grams will be ex
+0001eec0: 7472 6163 7465 642e 0a20 2020 2020 206d  tracted..      m
+0001eed0: 6178 5f6f 7264 6572 2028 696e 7429 3a20  ax_order (int): 
+0001eee0: 6d61 7869 6d75 6d20 6c65 6e67 7468 2069  maximum length i
+0001eef0: 6e20 746f 6b65 6e73 206f 6620 7468 6520  n tokens of the 
+0001ef00: 6e2d 6772 616d 7320 7265 7475 726e 6564  n-grams returned
+0001ef10: 2062 7920 7468 6973 0a20 2020 2020 2020   by this.       
+0001ef20: 2020 206d 6574 686f 6473 2e0a 0a20 2020     methods...   
+0001ef30: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001ef40: 5468 6520 436f 756e 7465 7220 636f 6e74  The Counter cont
+0001ef50: 6169 6e69 6e67 2061 6c6c 206e 2d67 7261  aining all n-gra
+0001ef60: 6d73 2075 7074 6f20 6d61 785f 6f72 6465  ms upto max_orde
+0001ef70: 7220 696e 2073 6567 6d65 6e74 0a20 2020  r in segment.   
+0001ef80: 2020 2077 6974 6820 6120 636f 756e 7420     with a count 
+0001ef90: 6f66 2068 6f77 206d 616e 7920 7469 6d65  of how many time
+0001efa0: 7320 6561 6368 206e 2d67 7261 6d20 6f63  s each n-gram oc
+0001efb0: 6375 7272 6564 2e0a 2020 2020 2222 220a  curred..    """.
+0001efc0: 2020 2020 696d 706f 7274 2063 6f6c 6c65      import colle
+0001efd0: 6374 696f 6e73 0a0a 2020 2020 6e67 7261  ctions..    ngra
+0001efe0: 6d5f 636f 756e 7473 203d 2063 6f6c 6c65  m_counts = colle
+0001eff0: 6374 696f 6e73 2e43 6f75 6e74 6572 2829  ctions.Counter()
+0001f000: 0a20 2020 2066 6f72 206f 7264 6572 2069  .    for order i
+0001f010: 6e20 7261 6e67 6528 312c 206d 6178 5f6f  n range(1, max_o
+0001f020: 7264 6572 202b 2031 293a 0a20 2020 2020  rder + 1):.     
+0001f030: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0001f040: 6528 302c 206c 656e 2873 6567 6d65 6e74  e(0, len(segment
+0001f050: 2920 2d20 6f72 6465 7220 2b20 3129 3a0a  ) - order + 1):.
+0001f060: 2020 2020 2020 2020 2020 2020 6e67 7261              ngra
+0001f070: 6d20 3d20 7475 706c 6528 7365 676d 656e  m = tuple(segmen
+0001f080: 745b 6920 3a20 6920 2b20 6f72 6465 725d  t[i : i + order]
+0001f090: 290a 2020 2020 2020 2020 2020 2020 6e67  ).            ng
+0001f0a0: 7261 6d5f 636f 756e 7473 5b6e 6772 616d  ram_counts[ngram
+0001f0b0: 5d20 2b3d 2031 0a20 2020 2072 6574 7572  ] += 1.    retur
+0001f0c0: 6e20 6e67 7261 6d5f 636f 756e 7473 0a0a  n ngram_counts..
+0001f0d0: 0a64 6566 2063 6f6d 7075 7465 5f62 6c65  .def compute_ble
+0001f0e0: 7528 7265 6665 7265 6e63 655f 636f 7270  u(reference_corp
+0001f0f0: 7573 2c20 7472 616e 736c 6174 696f 6e5f  us, translation_
+0001f100: 636f 7270 7573 2c20 6d61 785f 6f72 6465  corpus, max_orde
+0001f110: 723d 342c 2075 7365 5f62 703d 5472 7565  r=4, use_bp=True
+0001f120: 293a 0a20 2020 2022 2222 436f 6d70 7574  ):.    """Comput
+0001f130: 6573 2042 4c45 5520 7363 6f72 6520 6f66  es BLEU score of
+0001f140: 2074 7261 6e73 6c61 7465 6420 7365 676d   translated segm
+0001f150: 656e 7473 2061 6761 696e 7374 206f 6e65  ents against one
+0001f160: 206f 7220 6d6f 7265 2072 6566 6572 656e   or more referen
+0001f170: 6365 732e 0a20 2020 2043 6f64 6520 6164  ces..    Code ad
+0001f180: 6170 7465 6420 6672 6f6d 2047 6f6f 676c  apted from Googl
+0001f190: 6520 5465 6e73 6f72 3254 656e 736f 722e  e Tensor2Tensor.
+0001f1a0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001f1b0: 2020 7265 6665 7265 6e63 655f 636f 7270    reference_corp
+0001f1c0: 7573 2028 6c69 7374 5b6c 6973 745b 696e  us (list[list[in
+0001f1d0: 745d 7c6c 6973 745b 7374 725d 5d29 3a20  t]|list[str]]): 
+0001f1e0: 6c69 7374 206f 6620 7265 6665 7265 6e63  list of referenc
+0001f1f0: 6573 2066 6f72 2065 6163 6820 7472 616e  es for each tran
+0001f200: 736c 6174 696f 6e2e 2045 6163 680a 2020  slation. Each.  
+0001f210: 2020 2020 2020 2020 7265 6665 7265 6e63          referenc
+0001f220: 6520 7368 6f75 6c64 2062 6520 746f 6b65  e should be toke
+0001f230: 6e69 7a65 6420 696e 746f 2061 206c 6973  nized into a lis
+0001f240: 7420 6f66 2074 6f6b 656e 732e 0a20 2020  t of tokens..   
+0001f250: 2020 2074 7261 6e73 6c61 7469 6f6e 5f63     translation_c
+0001f260: 6f72 7075 7320 286c 6973 745b 6c69 7374  orpus (list[list
+0001f270: 5b69 6e74 5d7c 6c69 7374 5b73 7472 5d5d  [int]|list[str]]
+0001f280: 293a 206c 6973 7420 6f66 2074 7261 6e73  ): list of trans
+0001f290: 6c61 7469 6f6e 7320 746f 2073 636f 7265  lations to score
+0001f2a0: 2e20 4561 6368 2074 7261 6e73 6c61 7469  . Each translati
+0001f2b0: 6f6e 0a20 2020 2020 2020 2020 2073 686f  on.          sho
+0001f2c0: 756c 6420 6265 2074 6f6b 656e 697a 6564  uld be tokenized
+0001f2d0: 2069 6e74 6f20 6120 6c69 7374 206f 6620   into a list of 
+0001f2e0: 746f 6b65 6e73 2e0a 2020 2020 2020 6d61  tokens..      ma
+0001f2f0: 785f 6f72 6465 7220 2869 6e74 293a 204d  x_order (int): M
+0001f300: 6178 696d 756d 206e 2d67 7261 6d20 6f72  aximum n-gram or
+0001f310: 6465 7220 746f 2075 7365 2077 6865 6e20  der to use when 
+0001f320: 636f 6d70 7574 696e 6720 424c 4555 2073  computing BLEU s
+0001f330: 636f 7265 2e0a 2020 2020 2020 7573 655f  core..      use_
+0001f340: 6270 2028 626f 6f6c 293a 2062 6f6f 6c65  bp (bool): boole
+0001f350: 616e 2c20 7768 6574 6865 7220 746f 2061  an, whether to a
+0001f360: 7070 6c79 2062 7265 7669 7479 2070 656e  pply brevity pen
+0001f370: 616c 7479 2e0a 0a20 2020 2052 6574 7572  alty...    Retur
+0001f380: 6e73 3a0a 2020 2020 2020 424c 4555 2073  ns:.      BLEU s
+0001f390: 636f 7265 2e0a 2020 2020 2222 220a 2020  core..    """.  
+0001f3a0: 2020 696d 706f 7274 206d 6174 680a 0a20    import math.. 
+0001f3b0: 2020 2072 6566 6572 656e 6365 5f6c 656e     reference_len
+0001f3c0: 6774 6820 3d20 300a 2020 2020 7472 616e  gth = 0.    tran
+0001f3d0: 736c 6174 696f 6e5f 6c65 6e67 7468 203d  slation_length =
+0001f3e0: 2030 0a20 2020 2062 7020 3d20 312e 300a   0.    bp = 1.0.
+0001f3f0: 2020 2020 6765 6f5f 6d65 616e 203d 2030      geo_mean = 0
+0001f400: 0a0a 2020 2020 6d61 7463 6865 735f 6279  ..    matches_by
+0001f410: 5f6f 7264 6572 203d 205b 305d 202a 206d  _order = [0] * m
+0001f420: 6178 5f6f 7264 6572 0a20 2020 2070 6f73  ax_order.    pos
+0001f430: 7369 626c 655f 6d61 7463 6865 735f 6279  sible_matches_by
+0001f440: 5f6f 7264 6572 203d 205b 305d 202a 206d  _order = [0] * m
+0001f450: 6178 5f6f 7264 6572 0a0a 2020 2020 666f  ax_order..    fo
+0001f460: 7220 7265 6665 7265 6e63 6573 2c20 7472  r references, tr
+0001f470: 616e 736c 6174 696f 6e73 2069 6e20 7a69  anslations in zi
+0001f480: 7028 7265 6665 7265 6e63 655f 636f 7270  p(reference_corp
+0001f490: 7573 2c20 7472 616e 736c 6174 696f 6e5f  us, translation_
+0001f4a0: 636f 7270 7573 293a 0a20 2020 2020 2020  corpus):.       
+0001f4b0: 2072 6566 6572 656e 6365 5f6c 656e 6774   reference_lengt
+0001f4c0: 6820 2b3d 206c 656e 2872 6566 6572 656e  h += len(referen
+0001f4d0: 6365 7329 0a20 2020 2020 2020 2074 7261  ces).        tra
+0001f4e0: 6e73 6c61 7469 6f6e 5f6c 656e 6774 6820  nslation_length 
+0001f4f0: 2b3d 206c 656e 2874 7261 6e73 6c61 7469  += len(translati
+0001f500: 6f6e 7329 0a20 2020 2020 2020 2072 6566  ons).        ref
+0001f510: 5f6e 6772 616d 5f63 6f75 6e74 7320 3d20  _ngram_counts = 
+0001f520: 5f67 6574 5f6e 6772 616d 7328 7265 6665  _get_ngrams(refe
+0001f530: 7265 6e63 6573 2c20 6d61 785f 6f72 6465  rences, max_orde
+0001f540: 7229 0a20 2020 2020 2020 2074 7261 6e73  r).        trans
+0001f550: 6c61 7469 6f6e 5f6e 6772 616d 5f63 6f75  lation_ngram_cou
+0001f560: 6e74 7320 3d20 5f67 6574 5f6e 6772 616d  nts = _get_ngram
+0001f570: 7328 7472 616e 736c 6174 696f 6e73 2c20  s(translations, 
+0001f580: 6d61 785f 6f72 6465 7229 0a0a 2020 2020  max_order)..    
+0001f590: 2020 2020 6f76 6572 6c61 7020 3d20 7b6e      overlap = {n
+0001f5a0: 6772 616d 3a20 6d69 6e28 636f 756e 742c  gram: min(count,
+0001f5b0: 2074 7261 6e73 6c61 7469 6f6e 5f6e 6772   translation_ngr
+0001f5c0: 616d 5f63 6f75 6e74 735b 6e67 7261 6d5d  am_counts[ngram]
+0001f5d0: 2920 666f 7220 6e67 7261 6d2c 2063 6f75  ) for ngram, cou
+0001f5e0: 6e74 2069 6e20 7265 665f 6e67 7261 6d5f  nt in ref_ngram_
+0001f5f0: 636f 756e 7473 2e69 7465 6d73 2829 7d0a  counts.items()}.
+0001f600: 0a20 2020 2020 2020 2066 6f72 206e 6772  .        for ngr
+0001f610: 616d 2069 6e20 6f76 6572 6c61 703a 0a20  am in overlap:. 
+0001f620: 2020 2020 2020 2020 2020 206d 6174 6368             match
+0001f630: 6573 5f62 795f 6f72 6465 725b 6c65 6e28  es_by_order[len(
+0001f640: 6e67 7261 6d29 202d 2031 5d20 2b3d 206f  ngram) - 1] += o
+0001f650: 7665 726c 6170 5b6e 6772 616d 5d0a 2020  verlap[ngram].  
+0001f660: 2020 2020 2020 666f 7220 6e67 7261 6d20        for ngram 
+0001f670: 696e 2074 7261 6e73 6c61 7469 6f6e 5f6e  in translation_n
+0001f680: 6772 616d 5f63 6f75 6e74 733a 0a20 2020  gram_counts:.   
+0001f690: 2020 2020 2020 2020 2070 6f73 7369 626c           possibl
+0001f6a0: 655f 6d61 7463 6865 735f 6279 5f6f 7264  e_matches_by_ord
+0001f6b0: 6572 5b6c 656e 286e 6772 616d 2920 2d20  er[len(ngram) - 
+0001f6c0: 315d 202b 3d20 7472 616e 736c 6174 696f  1] += translatio
+0001f6d0: 6e5f 6e67 7261 6d5f 636f 756e 7473 5b6e  n_ngram_counts[n
+0001f6e0: 6772 616d 5d0a 0a20 2020 2070 7265 6369  gram]..    preci
+0001f6f0: 7369 6f6e 7320 3d20 5b30 2e30 5d20 2a20  sions = [0.0] * 
+0001f700: 6d61 785f 6f72 6465 720a 2020 2020 736d  max_order.    sm
+0001f710: 6f6f 7468 203d 2031 2e30 0a20 2020 2066  ooth = 1.0.    f
+0001f720: 6f72 2069 2069 6e20 7261 6e67 6528 302c  or i in range(0,
+0001f730: 206d 6178 5f6f 7264 6572 293a 0a20 2020   max_order):.   
+0001f740: 2020 2020 2069 6620 706f 7373 6962 6c65       if possible
+0001f750: 5f6d 6174 6368 6573 5f62 795f 6f72 6465  _matches_by_orde
+0001f760: 725b 695d 203e 2030 3a0a 2020 2020 2020  r[i] > 0:.      
+0001f770: 2020 2020 2020 7072 6563 6973 696f 6e73        precisions
+0001f780: 5b69 5d20 3d20 6d61 7463 6865 735f 6279  [i] = matches_by
+0001f790: 5f6f 7264 6572 5b69 5d20 2f20 706f 7373  _order[i] / poss
+0001f7a0: 6962 6c65 5f6d 6174 6368 6573 5f62 795f  ible_matches_by_
+0001f7b0: 6f72 6465 725b 695d 0a20 2020 2020 2020  order[i].       
+0001f7c0: 2020 2020 2069 6620 6d61 7463 6865 735f       if matches_
+0001f7d0: 6279 5f6f 7264 6572 5b69 5d20 3e20 303a  by_order[i] > 0:
+0001f7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f7f0: 2070 7265 6369 7369 6f6e 735b 695d 203d   precisions[i] =
+0001f800: 206d 6174 6368 6573 5f62 795f 6f72 6465   matches_by_orde
+0001f810: 725b 695d 202f 2070 6f73 7369 626c 655f  r[i] / possible_
+0001f820: 6d61 7463 6865 735f 6279 5f6f 7264 6572  matches_by_order
+0001f830: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
+0001f840: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001f850: 2020 2020 2020 736d 6f6f 7468 202a 3d20        smooth *= 
+0001f860: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+0001f870: 2020 7072 6563 6973 696f 6e73 5b69 5d20    precisions[i] 
+0001f880: 3d20 312e 3020 2f20 2873 6d6f 6f74 6820  = 1.0 / (smooth 
+0001f890: 2a20 706f 7373 6962 6c65 5f6d 6174 6368  * possible_match
+0001f8a0: 6573 5f62 795f 6f72 6465 725b 695d 290a  es_by_order[i]).
+0001f8b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f8c0: 2020 2020 2020 2020 2020 7072 6563 6973            precis
+0001f8d0: 696f 6e73 5b69 5d20 3d20 302e 300a 0a20  ions[i] = 0.0.. 
+0001f8e0: 2020 2069 6620 6d61 7828 7072 6563 6973     if max(precis
+0001f8f0: 696f 6e73 2920 3e20 303a 0a20 2020 2020  ions) > 0:.     
+0001f900: 2020 2070 5f6c 6f67 5f73 756d 203d 2073     p_log_sum = s
+0001f910: 756d 286d 6174 682e 6c6f 6728 7029 2066  um(math.log(p) f
+0001f920: 6f72 2070 2069 6e20 7072 6563 6973 696f  or p in precisio
+0001f930: 6e73 2069 6620 7029 0a20 2020 2020 2020  ns if p).       
+0001f940: 2067 656f 5f6d 6561 6e20 3d20 6d61 7468   geo_mean = math
+0001f950: 2e65 7870 2870 5f6c 6f67 5f73 756d 202f  .exp(p_log_sum /
+0001f960: 206d 6178 5f6f 7264 6572 290a 0a20 2020   max_order)..   
+0001f970: 2069 6620 7573 655f 6270 3a0a 2020 2020   if use_bp:.    
+0001f980: 2020 2020 7261 7469 6f20 3d20 7472 616e      ratio = tran
+0001f990: 736c 6174 696f 6e5f 6c65 6e67 7468 202f  slation_length /
+0001f9a0: 2072 6566 6572 656e 6365 5f6c 656e 6774   reference_lengt
+0001f9b0: 680a 2020 2020 2020 2020 6966 2072 6174  h.        if rat
+0001f9c0: 696f 203c 2031 652d 3330 3a0a 2020 2020  io < 1e-30:.    
+0001f9d0: 2020 2020 2020 2020 6270 203d 2030 2e30          bp = 0.0
+0001f9e0: 0a20 2020 2020 2020 2065 6c69 6620 7261  .        elif ra
+0001f9f0: 7469 6f20 3c20 312e 303a 0a20 2020 2020  tio < 1.0:.     
+0001fa00: 2020 2020 2020 2062 7020 3d20 6d61 7468         bp = math
+0001fa10: 2e65 7870 2831 202d 2031 2e30 202f 2072  .exp(1 - 1.0 / r
+0001fa20: 6174 696f 290a 2020 2020 2020 2020 656c  atio).        el
+0001fa30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001fa40: 6270 203d 2031 2e30 0a20 2020 2062 6c65  bp = 1.0.    ble
+0001fa50: 7520 3d20 6765 6f5f 6d65 616e 202a 2062  u = geo_mean * b
+0001fa60: 700a 2020 2020 7265 7475 726e 206e 702e  p.    return np.
+0001fa70: 666c 6f61 7433 3228 626c 6575 290a 0a0a  float32(bleu)...
+0001fa80: 2320 6e6f 696e 7370 6563 7469 6f6e 2050  # noinspection P
+0001fa90: 7950 6163 6b61 6765 5265 7175 6972 656d  yPackageRequirem
+0001faa0: 656e 7473 0a64 6566 206d 6f6e 6b65 7966  ents.def monkeyf
+0001fab0: 6978 5f67 6c69 6228 293a 0a20 2020 2022  ix_glib():.    "
+0001fac0: 2222 0a20 2020 2046 6978 6573 2073 6f6d  "".    Fixes som
+0001fad0: 6520 7374 7570 6964 2062 7567 7320 7375  e stupid bugs su
+0001fae0: 6368 2074 6861 7420 5349 4749 4e54 2069  ch that SIGINT i
+0001faf0: 7320 6e6f 7420 776f 726b 696e 672e 0a20  s not working.. 
+0001fb00: 2020 2054 6869 7320 6973 2075 7365 6420     This is used 
+0001fb10: 6279 2061 7564 696f 7265 6164 2c20 616e  by audioread, an
+0001fb20: 6420 696e 6469 7265 6374 6c79 2062 7920  d indirectly by 
+0001fb30: 6c69 6272 6f73 6120 666f 7220 6c6f 6164  librosa for load
+0001fb40: 696e 6720 6175 6469 6f2e 0a20 2020 2068  ing audio..    h
+0001fb50: 7474 7073 3a2f 2f73 7461 636b 6f76 6572  ttps://stackover
+0001fb60: 666c 6f77 2e63 6f6d 2f71 7565 7374 696f  flow.com/questio
+0001fb70: 6e73 2f31 3634 3130 3835 322f 0a20 2020  ns/16410852/.   
+0001fb80: 2053 6565 2061 6c73 6f20 3a66 756e 633a   See also :func:
+0001fb90: 606d 6f6e 6b65 7970 6174 6368 5f61 7564  `monkeypatch_aud
+0001fba0: 696f 7265 6164 602e 0a20 2020 2022 2222  ioread`..    """
+0001fbb0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+0001fbc0: 2020 696d 706f 7274 2067 690a 2020 2020    import gi.    
+0001fbd0: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
+0001fbe0: 6f72 3a0a 2020 2020 2020 2020 7265 7475  or:.        retu
+0001fbf0: 726e 0a20 2020 2074 7279 3a0a 2020 2020  rn.    try:.    
+0001fc00: 2020 2020 6672 6f6d 2067 692e 7265 706f      from gi.repo
+0001fc10: 7369 746f 7279 2069 6d70 6f72 7420 474c  sitory import GL
+0001fc20: 6962 0a20 2020 2065 7863 6570 7420 496d  ib.    except Im
+0001fc30: 706f 7274 4572 726f 723a 0a20 2020 2020  portError:.     
+0001fc40: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
+0001fc50: 6e20 5079 556e 7265 736f 6c76 6564 5265  n PyUnresolvedRe
+0001fc60: 6665 7265 6e63 6573 0a20 2020 2020 2020  ferences.       
+0001fc70: 2066 726f 6d20 6769 2e6f 7665 7272 6964   from gi.overrid
+0001fc80: 6573 2069 6d70 6f72 7420 474c 6962 0a20  es import GLib. 
+0001fc90: 2020 2023 2044 6f20 6e6f 7468 696e 672e     # Do nothing.
+0001fca0: 0a20 2020 2023 2054 6865 206f 7269 6769  .    # The origi
+0001fcb0: 6e61 6c20 6265 6861 7669 6f72 2077 6f75  nal behavior wou
+0001fcc0: 6c64 2069 6e73 7461 6c6c 2061 2053 4947  ld install a SIG
+0001fcd0: 494e 5420 6861 6e64 6c65 7220 7768 6963  INT handler whic
+0001fce0: 6820 6361 6c6c 7320 474c 6962 2e4d 6169  h calls GLib.Mai
+0001fcf0: 6e4c 6f6f 702e 7175 6974 2829 2c0a 2020  nLoop.quit(),.  
+0001fd00: 2020 2320 616e 6420 7468 656e 2072 6572    # and then rer
+0001fd10: 6169 7365 2061 204b 6579 626f 6172 6449  aise a KeyboardI
+0001fd20: 6e74 6572 7275 7074 2069 6e20 7468 6174  nterrupt in that
+0001fd30: 2074 6872 6561 642e 0a20 2020 2023 2048   thread..    # H
+0001fd40: 6f77 6576 6572 2c20 7765 2077 616e 7420  owever, we want 
+0001fd50: 616e 6420 6578 7065 6374 2074 6f20 6765  and expect to ge
+0001fd60: 7420 7468 6520 4b65 7962 6f61 7264 496e  t the KeyboardIn
+0001fd70: 7465 7272 7570 7420 696e 2074 6865 206d  terrupt in the m
+0001fd80: 6169 6e20 7468 7265 6164 2e0a 2020 2020  ain thread..    
+0001fd90: 474c 6962 2e4d 6169 6e4c 6f6f 702e 5f5f  GLib.MainLoop.__
+0001fda0: 696e 6974 5f5f 203d 206c 616d 6264 6120  init__ = lambda 
+0001fdb0: 2a61 7267 732c 202a 2a6b 7761 7267 733a  *args, **kwargs:
+0001fdc0: 204e 6f6e 650a 0a0a 6465 6620 6d6f 6e6b   None...def monk
+0001fdd0: 6579 7061 7463 685f 6175 6469 6f72 6561  eypatch_audiorea
+0001fde0: 6428 293a 0a20 2020 2022 2222 0a20 2020  d():.    """.   
+0001fdf0: 2061 7564 696f 7265 6164 2064 6f65 7320   audioread does 
+0001fe00: 6e6f 7420 6265 6861 7665 206f 7074 696d  not behave optim
+0001fe10: 616c 2069 6e20 736f 6d65 2063 6173 6573  al in some cases
+0001fe20: 2e0a 2020 2020 452e 672e 2065 6163 6820  ..    E.g. each 
+0001fe30: 6361 6c6c 2074 6f20 5f63 615f 6176 6169  call to _ca_avai
+0001fe40: 6c61 626c 6528 2920 7461 6b65 7320 7175  lable() takes qu
+0001fe50: 6974 6520 6c6f 6e67 2062 6563 6175 7365  ite long because
+0001fe60: 206f 6620 7468 6520 6374 7970 6573 2e75   of the ctypes.u
+0001fe70: 7469 6c2e 6669 6e64 5f6c 6962 7261 7279  til.find_library
+0001fe80: 2075 7361 6765 2e0a 2020 2020 5765 2077   usage..    We w
+0001fe90: 696c 6c20 7061 7463 6820 7468 6973 2e0a  ill patch this..
+0001fea0: 0a20 2020 2048 6f77 6576 6572 2c20 7468  .    However, th
+0001feb0: 6520 7265 636f 6d6d 656e 6461 7469 6f6e  e recommendation
+0001fec0: 2077 6f75 6c64 2062 6520 746f 206e 6f74   would be to not
+0001fed0: 2075 7365 2061 7564 696f 7265 6164 2028   use audioread (
+0001fee0: 6c69 6272 6f73 612e 6c6f 6164 292e 0a20  librosa.load).. 
+0001fef0: 2020 2061 7564 696f 7265 6164 2075 7365     audioread use
+0001ff00: 7320 4773 7472 6561 6d65 7220 6173 2061  s Gstreamer as a
+0001ff10: 2062 6163 6b65 6e64 2062 7920 6465 6661   backend by defa
+0001ff20: 756c 7420 6375 7272 656e 746c 7920 286f  ult currently (o
+0001ff30: 6e20 4c69 6e75 7829 2e0a 2020 2020 4773  n Linux)..    Gs
+0001ff40: 7472 6561 6d65 7220 6861 7320 6d75 6c74  treamer has mult
+0001ff50: 6970 6c65 2069 7373 7565 732e 2053 6565  iple issues. See
+0001ff60: 2061 6c73 6f20 3a66 756e 633a 606d 6f6e   also :func:`mon
+0001ff70: 6b65 7966 6978 5f67 6c69 6260 2c20 616e  keyfix_glib`, an
+0001ff80: 6420 6865 7265 2066 6f72 2064 6973 6375  d here for discu
+0001ff90: 7373 696f 6e3a 0a20 2020 2068 7474 7073  ssion:.    https
+0001ffa0: 3a2f 2f67 6974 6875 622e 636f 6d2f 6265  ://github.com/be
+0001ffb0: 6574 626f 782f 6175 6469 6f72 6561 642f  etbox/audioread/
+0001ffc0: 6973 7375 6573 2f36 320a 2020 2020 6874  issues/62.    ht
+0001ffd0: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+0001ffe0: 2f62 6565 7462 6f78 2f61 7564 696f 7265  /beetbox/audiore
+0001fff0: 6164 2f69 7373 7565 732f 3633 0a0a 2020  ad/issues/63..  
+00020000: 2020 496e 7374 6561 642c 2075 7365 2050    Instead, use P
+00020010: 7953 6f75 6e64 4669 6c65 2c20 7768 6963  ySoundFile, whic
+00020020: 6820 6973 2061 6c73 6f20 6661 7374 6572  h is also faster
+00020030: 2e20 5365 6520 6865 7265 2066 6f72 2064  . See here for d
+00020040: 6973 6375 7373 696f 6e73 3a0a 2020 2020  iscussions:.    
+00020050: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+00020060: 6f6d 2f62 6565 7462 6f78 2f61 7564 696f  om/beetbox/audio
+00020070: 7265 6164 2f69 7373 7565 732f 3634 0a20  read/issues/64. 
+00020080: 2020 2068 7474 7073 3a2f 2f67 6974 6875     https://githu
+00020090: 622e 636f 6d2f 6c69 6272 6f73 612f 6c69  b.com/librosa/li
+000200a0: 6272 6f73 612f 6973 7375 6573 2f36 3831  brosa/issues/681
+000200b0: 0a20 2020 2022 2222 0a20 2020 2074 7279  .    """.    try
+000200c0: 3a0a 2020 2020 2020 2020 2320 6e6f 696e  :.        # noin
+000200d0: 7370 6563 7469 6f6e 2050 7950 6163 6b61  spection PyPacka
+000200e0: 6765 5265 7175 6972 656d 656e 7473 0a20  geRequirements. 
+000200f0: 2020 2020 2020 2069 6d70 6f72 7420 6175         import au
+00020100: 6469 6f72 6561 640a 2020 2020 6578 6365  dioread.    exce
+00020110: 7074 2049 6d70 6f72 7445 7272 6f72 3a0a  pt ImportError:.
+00020120: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00020130: 2020 2023 206e 6f69 6e73 7065 6374 696f     # noinspectio
+00020140: 6e20 5079 5072 6f74 6563 7465 644d 656d  n PyProtectedMem
+00020150: 6265 720a 2020 2020 7265 7320 3d20 6175  ber.    res = au
+00020160: 6469 6f72 6561 642e 5f63 615f 6176 6169  dioread._ca_avai
+00020170: 6c61 626c 6528 290a 2020 2020 6175 6469  lable().    audi
+00020180: 6f72 6561 642e 5f63 615f 6176 6169 6c61  oread._ca_availa
+00020190: 626c 6520 3d20 6c61 6d62 6461 3a20 7265  ble = lambda: re
+000201a0: 730a 0a0a 5f63 665f 6361 6368 6520 3d20  s..._cf_cache = 
+000201b0: 7b7d 0a5f 6366 5f6d 7367 5f70 7269 6e74  {}._cf_msg_print
+000201c0: 6564 203d 2046 616c 7365 0a0a 0a64 6566  ed = False...def
+000201d0: 2063 6628 6669 6c65 6e61 6d65 293a 0a20   cf(filename):. 
+000201e0: 2020 2022 2222 0a20 2020 2043 6163 6865     """.    Cache
+000201f0: 206d 616e 6167 6572 2e20 6936 2073 7065   manager. i6 spe
+00020200: 6369 6669 632e 0a0a 2020 2020 3a72 6574  cific...    :ret
+00020210: 7572 6e3a 2066 696c 656e 616d 650a 2020  urn: filename.  
+00020220: 2020 3a72 7479 7065 3a20 7374 720a 2020    :rtype: str.  
+00020230: 2020 2222 220a 2020 2020 676c 6f62 616c    """.    global
+00020240: 205f 6366 5f6d 7367 5f70 7269 6e74 6564   _cf_msg_printed
+00020250: 0a20 2020 2069 6d70 6f72 7420 6f73 0a20  .    import os. 
+00020260: 2020 2066 726f 6d20 7375 6270 726f 6365     from subproce
+00020270: 7373 2069 6d70 6f72 7420 6368 6563 6b5f  ss import check_
+00020280: 6f75 7470 7574 0a0a 2020 2020 6966 2066  output..    if f
+00020290: 696c 656e 616d 6520 696e 205f 6366 5f63  ilename in _cf_c
+000202a0: 6163 6865 3a0a 2020 2020 2020 2020 7265  ache:.        re
+000202b0: 7475 726e 205f 6366 5f63 6163 6865 5b66  turn _cf_cache[f
+000202c0: 696c 656e 616d 655d 0a20 2020 2064 6562  ilename].    deb
+000202d0: 7567 5f6d 6f64 6520 3d20 696e 7428 6f73  ug_mode = int(os
+000202e0: 2e65 6e76 6972 6f6e 2e67 6574 2822 4445  .environ.get("DE
+000202f0: 4255 4722 2c20 3029 290a 2020 2020 6966  BUG", 0)).    if
+00020300: 2064 6562 7567 5f6d 6f64 6520 6f72 2067   debug_mode or g
+00020310: 6574 5f68 6f73 746e 616d 6528 2920 3d3d  et_hostname() ==
+00020320: 2022 636c 7573 7465 722d 636e 2d32 3131   "cluster-cn-211
+00020330: 2220 6f72 206e 6f74 2069 735f 7275 6e6e  " or not is_runn
+00020340: 696e 675f 6f6e 5f63 6c75 7374 6572 2829  ing_on_cluster()
+00020350: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00020360: 205f 6366 5f6d 7367 5f70 7269 6e74 6564   _cf_msg_printed
+00020370: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00020380: 696e 7428 2243 6163 6865 206d 616e 6167  int("Cache manag
+00020390: 6572 3a20 6e6f 7420 7573 6564 2c20 7573  er: not used, us
+000203a0: 6520 6c6f 6361 6c20 6669 6c65 3a20 2573  e local file: %s
+000203b0: 2028 6469 7363 6172 6420 6675 7274 6865   (discard furthe
+000203c0: 7220 6d65 7373 6167 6573 2922 2025 2066  r messages)" % f
+000203d0: 696c 656e 616d 6529 0a20 2020 2020 2020  ilename).       
+000203e0: 2020 2020 205f 6366 5f6d 7367 5f70 7269       _cf_msg_pri
+000203f0: 6e74 6564 203d 2054 7275 650a 2020 2020  nted = True.    
+00020400: 2020 2020 7265 7475 726e 2066 696c 656e      return filen
+00020410: 616d 6520 2023 2066 6f72 2064 6562 7567  ame  # for debug
+00020420: 6769 6e67 0a20 2020 2074 7279 3a0a 2020  ging.    try:.  
+00020430: 2020 2020 2020 6361 6368 6564 5f66 6e20        cached_fn 
+00020440: 3d20 6368 6563 6b5f 6f75 7470 7574 285b  = check_output([
+00020450: 2263 6622 2c20 6669 6c65 6e61 6d65 5d29  "cf", filename])
+00020460: 2e73 7472 6970 2829 2e64 6563 6f64 6528  .strip().decode(
+00020470: 2275 7466 3822 290a 2020 2020 6578 6365  "utf8").    exce
+00020480: 7074 2043 616c 6c65 6450 726f 6365 7373  pt CalledProcess
+00020490: 4572 726f 723a 0a20 2020 2020 2020 2069  Error:.        i
+000204a0: 6620 6e6f 7420 5f63 665f 6d73 675f 7072  f not _cf_msg_pr
+000204b0: 696e 7465 643a 0a20 2020 2020 2020 2020  inted:.         
+000204c0: 2020 2070 7269 6e74 2822 4361 6368 6520     print("Cache 
+000204d0: 6d61 6e61 6765 723a 2045 7272 6f72 206f  manager: Error o
+000204e0: 6363 7572 7265 642c 2075 7369 6e67 206c  ccurred, using l
+000204f0: 6f63 616c 2066 696c 6522 290a 2020 2020  ocal file").    
+00020500: 2020 2020 2020 2020 5f63 665f 6d73 675f          _cf_msg_
+00020510: 7072 696e 7465 6420 3d20 5472 7565 0a20  printed = True. 
+00020520: 2020 2020 2020 2072 6574 7572 6e20 6669         return fi
+00020530: 6c65 6e61 6d65 0a20 2020 2061 7373 6572  lename.    asser
+00020540: 7420 6f73 2e70 6174 682e 6578 6973 7473  t os.path.exists
+00020550: 2863 6163 6865 645f 666e 290a 2020 2020  (cached_fn).    
+00020560: 5f63 665f 6361 6368 655b 6669 6c65 6e61  _cf_cache[filena
+00020570: 6d65 5d20 3d20 6361 6368 6564 5f66 6e0a  me] = cached_fn.
+00020580: 2020 2020 7265 7475 726e 2063 6163 6865      return cache
+00020590: 645f 666e 0a0a 0a64 6566 2062 696e 6172  d_fn...def binar
+000205a0: 795f 7365 6172 6368 5f61 6e79 2863 6d70  y_search_any(cmp
+000205b0: 2c20 6c6f 772c 2068 6967 6829 3a0a 2020  , low, high):.  
+000205c0: 2020 2222 220a 2020 2020 4269 6e61 7279    """.    Binary
+000205d0: 2073 6561 7263 6820 666f 7220 6120 6375   search for a cu
+000205e0: 7374 6f6d 2063 6f6d 7061 7265 2066 756e  stom compare fun
+000205f0: 6374 696f 6e2e 0a0a 2020 2020 3a70 6172  ction...    :par
+00020600: 616d 2028 696e 7429 2d3e 696e 7420 636d  am (int)->int cm
+00020610: 703a 2065 2e67 2e20 636d 7028 6964 7829  p: e.g. cmp(idx)
+00020620: 203d 3d20 636f 6d70 6172 6528 6172 7261   == compare(arra
+00020630: 795b 6964 785d 2c20 6b65 7929 0a20 2020  y[idx], key).   
+00020640: 203a 7061 7261 6d20 696e 7420 6c6f 773a   :param int low:
+00020650: 2069 6e63 6c75 7369 7665 0a20 2020 203a   inclusive.    :
+00020660: 7061 7261 6d20 696e 7420 6869 6768 3a20  param int high: 
+00020670: 6578 636c 7573 6976 650a 2020 2020 3a72  exclusive.    :r
+00020680: 7479 7065 3a20 696e 747c 4e6f 6e65 0a20  type: int|None. 
+00020690: 2020 2022 2222 0a20 2020 2077 6869 6c65     """.    while
+000206a0: 206c 6f77 203c 2068 6967 683a 0a20 2020   low < high:.   
+000206b0: 2020 2020 206d 6964 203d 2028 6c6f 7720       mid = (low 
+000206c0: 2b20 6869 6768 2920 2f2f 2032 0a20 2020  + high) // 2.   
+000206d0: 2020 2020 2072 203d 2063 6d70 286d 6964       r = cmp(mid
+000206e0: 290a 2020 2020 2020 2020 6966 2072 203c  ).        if r <
+000206f0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00020700: 6c6f 7720 3d20 6d69 6420 2b20 310a 2020  low = mid + 1.  
+00020710: 2020 2020 2020 656c 6966 2072 203e 2030        elif r > 0
+00020720: 3a0a 2020 2020 2020 2020 2020 2020 6869  :.            hi
+00020730: 6768 203d 206d 6964 0a20 2020 2020 2020  gh = mid.       
+00020740: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00020750: 2020 2072 6574 7572 6e20 6d69 640a 2020     return mid.  
+00020760: 2020 7265 7475 726e 206c 6f77 0a0a 0a64    return low...d
+00020770: 6566 2067 656e 6572 6963 5f69 6d70 6f72  ef generic_impor
+00020780: 745f 6d6f 6475 6c65 2866 696c 656e 616d  t_module(filenam
+00020790: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+000207a0: 3a70 6172 616d 2073 7472 2066 696c 656e  :param str filen
+000207b0: 616d 653a 0a20 2020 2020 2057 6520 7472  ame:.      We tr
+000207c0: 7920 746f 2062 6520 636c 6576 6572 2061  y to be clever a
+000207d0: 626f 7574 2066 696c 656e 616d 652e 0a20  bout filename.. 
+000207e0: 2020 2020 2049 6620 6974 206c 6f6f 6b73       If it looks
+000207f0: 206c 696b 6520 6120 6d6f 6475 6c65 206e   like a module n
+00020800: 616d 652c 206a 7573 7420 646f 2069 6d70  ame, just do imp
+00020810: 6f72 746c 6962 2e69 6d70 6f72 745f 6d6f  ortlib.import_mo
+00020820: 6475 6c65 2e0a 2020 2020 2020 4966 2069  dule..      If i
+00020830: 7420 6c6f 6f6b 7320 6c69 6b65 2061 2066  t looks like a f
+00020840: 696c 656e 616d 652c 2073 6561 7263 6820  ilename, search 
+00020850: 666f 7220 6120 6261 7365 2070 6174 6820  for a base path 
+00020860: 2877 6869 6368 2064 6f65 7320 6e6f 7420  (which does not 
+00020870: 6861 7665 205f 5f69 6e69 745f 5f2e 7079  have __init__.py
+00020880: 292c 0a20 2020 2020 2061 6464 2074 6861  ),.      add tha
+00020890: 7420 7061 7468 2074 6f20 7379 732e 7061  t path to sys.pa
+000208a0: 7468 2069 6620 6e65 6564 6564 2c20 616e  th if needed, an
+000208b0: 6420 696d 706f 7274 2074 6865 2072 656d  d import the rem
+000208c0: 6169 6e69 6e67 2077 6865 7265 2022 2f22  aining where "/"
+000208d0: 2069 7320 7265 706c 6163 6564 2062 7920   is replaced by 
+000208e0: 222e 220a 2020 2020 2020 616e 6420 7468  ".".      and th
+000208f0: 6520 6669 6c65 2065 7874 656e 7369 6f6e  e file extension
+00020900: 2069 7320 7265 6d6f 7665 642e 0a20 2020   is removed..   
+00020910: 203a 7265 7475 726e 3a20 7468 6520 6d6f   :return: the mo
+00020920: 6475 6c65 0a20 2020 203a 7274 7970 653a  dule.    :rtype:
+00020930: 2074 7970 6573 2e4d 6f64 756c 6554 7970   types.ModuleTyp
+00020940: 650a 2020 2020 2222 220a 2020 2020 6173  e.    """.    as
+00020950: 7365 7274 2066 696c 656e 616d 650a 2020  sert filename.  
+00020960: 2020 696d 706f 7274 2069 6d70 6f72 746c    import importl
+00020970: 6962 0a0a 2020 2020 6966 2022 2f22 206e  ib..    if "/" n
+00020980: 6f74 2069 6e20 6669 6c65 6e61 6d65 3a0a  ot in filename:.
+00020990: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+000209a0: 6d70 6f72 746c 6962 2e69 6d70 6f72 745f  mportlib.import_
+000209b0: 6d6f 6475 6c65 2866 696c 656e 616d 6529  module(filename)
+000209c0: 0a20 2020 2070 7265 6669 785f 6469 7220  .    prefix_dir 
+000209d0: 3d20 2222 0a20 2020 2069 6620 6e6f 7420  = "".    if not 
+000209e0: 6f73 2e70 6174 682e 6578 6973 7473 2866  os.path.exists(f
+000209f0: 696c 656e 616d 6529 3a0a 2020 2020 2020  ilename):.      
+00020a00: 2020 6173 7365 7274 2066 696c 656e 616d    assert filenam
+00020a10: 655b 305d 2021 3d20 222f 220a 2020 2020  e[0] != "/".    
+00020a20: 2020 2020 2320 4d61 7962 6520 7265 6c61      # Maybe rela
+00020a30: 7469 7665 2074 6f20 5265 7475 726e 6e3f  tive to Returnn?
+00020a40: 0a20 2020 2020 2020 2070 7265 6669 785f  .        prefix_
+00020a50: 6469 7220 3d20 2225 732f 2220 2520 7265  dir = "%s/" % re
+00020a60: 7475 726e 6e5f 726f 6f74 5f64 6972 0a20  turnn_root_dir. 
+00020a70: 2020 2061 7373 6572 7420 6f73 2e70 6174     assert os.pat
+00020a80: 682e 6578 6973 7473 2870 7265 6669 785f  h.exists(prefix_
+00020a90: 6469 7220 2b20 6669 6c65 6e61 6d65 290a  dir + filename).
+00020aa0: 2020 2020 6173 7365 7274 2066 696c 656e      assert filen
+00020ab0: 616d 652e 656e 6473 7769 7468 2822 2e70  ame.endswith(".p
+00020ac0: 7922 2920 6f72 206f 732e 7061 7468 2e69  y") or os.path.i
+00020ad0: 7364 6972 2870 7265 6669 785f 6469 7220  sdir(prefix_dir 
+00020ae0: 2b20 6669 6c65 6e61 6d65 290a 2020 2020  + filename).    
+00020af0: 6469 7273 203d 2066 696c 656e 616d 652e  dirs = filename.
+00020b00: 7370 6c69 7428 222f 2229 0a20 2020 2064  split("/").    d
+00020b10: 6972 732c 2062 6173 655f 666e 203d 2064  irs, base_fn = d
+00020b20: 6972 735b 3a2d 315d 2c20 6469 7273 5b2d  irs[:-1], dirs[-
+00020b30: 315d 0a20 2020 2061 7373 6572 7420 6c65  1].    assert le
+00020b40: 6e28 6469 7273 2920 3e3d 2031 0a20 2020  n(dirs) >= 1.   
+00020b50: 2066 6f72 2069 2069 6e20 7265 7665 7273   for i in revers
+00020b60: 6564 2872 616e 6765 286c 656e 2864 6972  ed(range(len(dir
+00020b70: 7329 2929 3a0a 2020 2020 2020 2020 6420  s))):.        d 
+00020b80: 3d20 7072 6566 6978 5f64 6972 202b 2022  = prefix_dir + "
+00020b90: 2f22 2e6a 6f69 6e28 6469 7273 5b3a 2069  /".join(dirs[: i
+00020ba0: 202b 2031 5d29 0a20 2020 2020 2020 2061   + 1]).        a
+00020bb0: 7373 6572 7420 6f73 2e70 6174 682e 6973  ssert os.path.is
+00020bc0: 6469 7228 6429 0a20 2020 2020 2020 2069  dir(d).        i
+00020bd0: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
+00020be0: 2822 2573 2f5f 5f69 6e69 745f 5f2e 7079  ("%s/__init__.py
+00020bf0: 2220 2520 6429 3a0a 2020 2020 2020 2020  " % d):.        
+00020c00: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00020c10: 2020 2020 2069 6620 6420 6e6f 7420 696e       if d not in
+00020c20: 2073 7973 2e70 6174 683a 0a20 2020 2020   sys.path:.     
+00020c30: 2020 2020 2020 2073 7973 2e70 6174 682e         sys.path.
+00020c40: 6170 7065 6e64 2864 290a 2020 2020 2020  append(d).      
+00020c50: 2020 6d20 3d20 222e 222e 6a6f 696e 2864    m = ".".join(d
+00020c60: 6972 735b 6920 2b20 3120 3a5d 202b 205b  irs[i + 1 :] + [
+00020c70: 6261 7365 5f66 6e5d 290a 2020 2020 2020  base_fn]).      
+00020c80: 2020 6966 2062 6173 655f 666e 2e65 6e64    if base_fn.end
+00020c90: 7377 6974 6828 222e 7079 2229 3a0a 2020  swith(".py"):.  
+00020ca0: 2020 2020 2020 2020 2020 6d20 3d20 6d5b            m = m[
+00020cb0: 3a2d 335d 0a20 2020 2020 2020 2072 6574  :-3].        ret
+00020cc0: 7572 6e20 696d 706f 7274 6c69 622e 696d  urn importlib.im
+00020cd0: 706f 7274 5f6d 6f64 756c 6528 6d29 0a20  port_module(m). 
+00020ce0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00020cf0: 726f 7228 2263 616e 6e6f 7420 6669 6775  ror("cannot figu
+00020d00: 7265 206f 7574 2062 6173 6520 6d6f 6475  re out base modu
+00020d10: 6c65 2070 6174 6820 6672 6f6d 2025 7222  le path from %r"
+00020d20: 2025 2066 696c 656e 616d 6529 0a0a 0a64   % filename)...d
+00020d30: 6566 2073 6f66 746d 6178 2878 2c20 6178  ef softmax(x, ax
+00020d40: 6973 3d4e 6f6e 6529 3a0a 2020 2020 2222  is=None):.    ""
+00020d50: 220a 2020 2020 3a70 6172 616d 206e 756d  ".    :param num
+00020d60: 7079 2e6e 6461 7272 6179 2078 3a0a 2020  py.ndarray x:.  
+00020d70: 2020 3a70 6172 616d 2069 6e74 7c4e 6f6e    :param int|Non
+00020d80: 6520 6178 6973 3a0a 2020 2020 3a72 7479  e axis:.    :rty
+00020d90: 7065 3a20 6e75 6d70 792e 6e64 6172 7261  pe: numpy.ndarra
+00020da0: 790a 2020 2020 2222 220a 2020 2020 696d  y.    """.    im
+00020db0: 706f 7274 206e 756d 7079 0a0a 2020 2020  port numpy..    
+00020dc0: 655f 7820 3d20 6e75 6d70 792e 6578 7028  e_x = numpy.exp(
+00020dd0: 7820 2d20 6e75 6d70 792e 6d61 7828 782c  x - numpy.max(x,
+00020de0: 2061 7869 733d 6178 6973 2c20 6b65 6570   axis=axis, keep
+00020df0: 6469 6d73 3d54 7275 6529 290a 2020 2020  dims=True)).    
+00020e00: 7265 7475 726e 2065 5f78 202f 206e 756d  return e_x / num
+00020e10: 7079 2e73 756d 2865 5f78 2c20 6178 6973  py.sum(e_x, axis
+00020e20: 3d61 7869 732c 206b 6565 7064 696d 733d  =axis, keepdims=
+00020e30: 5472 7565 290a 0a0a 6465 6620 636f 6c6c  True)...def coll
+00020e40: 6563 745f 7072 6f63 5f6d 6170 735f 6578  ect_proc_maps_ex
+00020e50: 6563 5f66 696c 6573 2829 3a0a 2020 2020  ec_files():.    
+00020e60: 2222 220a 2020 2020 4375 7272 656e 746c  """.    Currentl
+00020e70: 7920 6f6e 6c79 2077 6f72 6b73 206f 6e20  y only works on 
+00020e80: 4c69 6e75 782e 2e2e 0a0a 2020 2020 3a72  Linux.....    :r
+00020e90: 6574 7572 6e3a 206c 6973 7420 6f66 206d  eturn: list of m
+00020ea0: 6170 7065 6420 6578 6563 7574 6162 6c65  apped executable
+00020eb0: 7320 286c 6962 7329 0a20 2020 203a 7274  s (libs).    :rt
+00020ec0: 7970 653a 206c 6973 745b 7374 725d 0a20  ype: list[str]. 
+00020ed0: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
+00020ee0: 7420 7265 0a0a 2020 2020 7069 6420 3d20  t re..    pid = 
+00020ef0: 6f73 2e67 6574 7069 6428 290a 2020 2020  os.getpid().    
+00020f00: 666e 7320 3d20 5b5d 0a20 2020 2066 6f72  fns = [].    for
+00020f10: 206c 696e 6520 696e 206f 7065 6e28 222f   line in open("/
+00020f20: 7072 6f63 2f25 692f 6d61 7073 2220 2520  proc/%i/maps" % 
+00020f30: 7069 642c 2022 7222 292e 7265 6164 2829  pid, "r").read()
+00020f40: 2e73 706c 6974 6c69 6e65 7328 293a 2020  .splitlines():  
+00020f50: 2320 666f 7220 6561 6368 206d 6170 7065  # for each mappe
+00020f60: 6420 7265 6769 6f6e 0a20 2020 2020 2020  d region.       
+00020f70: 2023 2068 7474 7073 3a2f 2f73 7461 636b   # https://stack
+00020f80: 6f76 6572 666c 6f77 2e63 6f6d 2f71 7565  overflow.com/que
+00020f90: 7374 696f 6e73 2f31 3430 3133 3539 2f75  stions/1401359/u
+00020fa0: 6e64 6572 7374 616e 6469 6e67 2d6c 696e  nderstanding-lin
+00020fb0: 7578 2d70 726f 632d 6964 2d6d 6170 730a  ux-proc-id-maps.
+00020fc0: 2020 2020 2020 2020 2320 6164 6472 6573          # addres
+00020fd0: 7320 2020 2020 2020 2020 2020 7065 726d  s           perm
+00020fe0: 7320 6f66 6673 6574 2020 6465 7620 2020  s offset  dev   
+00020ff0: 696e 6f64 6520 2020 7061 7468 6e61 6d65  inode   pathname
+00021000: 0a20 2020 2020 2020 2023 2045 2e67 2e3a  .        # E.g.:
+00021010: 0a20 2020 2020 2020 2023 2037 6666 3264  .        # 7ff2d
+00021020: 6539 3163 3030 302d 3766 6632 6465 3931  e91c000-7ff2de91
+00021030: 6530 3030 2072 772d 7020 3030 3137 6330  e000 rw-p 0017c0
+00021040: 3030 2030 383a 3032 2037 3934 3834 3420  00 08:02 794844 
+00021050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021060: 2020 2020 2f75 7372 2f6c 6962 2f78 3836      /usr/lib/x86
+00021070: 5f36 342d 6c69 6e75 782d 676e 752f 6c69  _64-linux-gnu/li
+00021080: 6273 7464 632b 2e2e 2e0a 2020 2020 2020  bstdc+....      
+00021090: 2020 6d20 3d20 7265 2e6d 6174 6368 280a    m = re.match(.
+000210a0: 2020 2020 2020 2020 2020 2020 7222 5e28              r"^(
+000210b0: 5b30 2d39 412d 4661 2d66 5d2b 292d 285b  [0-9A-Fa-f]+)-([
+000210c0: 302d 3941 2d46 612d 665d 2b29 5c73 2b28  0-9A-Fa-f]+)\s+(
+000210d0: 5b72 7778 7073 5c2d 5d2b 295c 732b 285b  [rwxps\-]+)\s+([
+000210e0: 302d 3941 2d46 612d 665d 2b29 5c73 2b28  0-9A-Fa-f]+)\s+(
+000210f0: 5b30 2d39 412d 4661 2d66 3a5d 2b29 5c73  [0-9A-Fa-f:]+)\s
+00021100: 2b28 5b30 2d39 5d2b 295c 732a 282e 2a29  +([0-9]+)\s*(.*)
+00021110: 2422 2c20 6c69 6e65 0a20 2020 2020 2020  $", line.       
+00021120: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00021130: 7420 6d2c 2022 6e6f 206d 6174 6368 2066  t m, "no match f
+00021140: 6f72 2025 7222 2025 206c 696e 650a 2020  or %r" % line.  
+00021150: 2020 2020 2020 6164 6472 6573 735f 7374        address_st
+00021160: 6172 742c 2061 6464 7265 7373 5f65 6e64  art, address_end
+00021170: 2c20 7065 726d 732c 206f 6666 7365 742c  , perms, offset,
+00021180: 2064 6576 2c20 695f 6e6f 6465 2c20 7061   dev, i_node, pa
+00021190: 7468 5f6e 616d 6520 3d20 6d2e 6772 6f75  th_name = m.grou
+000211a0: 7073 2829 0a20 2020 2020 2020 2069 6620  ps().        if 
+000211b0: 2278 2220 6e6f 7420 696e 2070 6572 6d73  "x" not in perms
+000211c0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000211d0: 6e74 696e 7565 0a20 2020 2020 2020 2069  ntinue.        i
+000211e0: 6620 6e6f 7420 7061 7468 5f6e 616d 6520  f not path_name 
+000211f0: 6f72 2070 6174 685f 6e61 6d65 2e73 7461  or path_name.sta
+00021200: 7274 7377 6974 6828 225b 2229 206f 7220  rtswith("[") or 
+00021210: 2228 6465 6c65 7465 6429 2220 696e 2070  "(deleted)" in p
+00021220: 6174 685f 6e61 6d65 3a0a 2020 2020 2020  ath_name:.      
+00021230: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00021240: 2020 2020 2020 2069 6620 7061 7468 5f6e         if path_n
+00021250: 616d 6520 6e6f 7420 696e 2066 6e73 3a0a  ame not in fns:.
+00021260: 2020 2020 2020 2020 2020 2020 666e 732e              fns.
+00021270: 6170 7065 6e64 2870 6174 685f 6e61 6d65  append(path_name
+00021280: 290a 2020 2020 7265 7475 726e 2066 6e73  ).    return fns
+00021290: 0a0a 0a64 6566 2066 696e 645f 7379 6d5f  ...def find_sym_
+000212a0: 696e 5f65 7865 6328 666e 2c20 7379 6d29  in_exec(fn, sym)
+000212b0: 3a0a 2020 2020 2222 220a 2020 2020 5573  :.    """.    Us
+000212c0: 6573 2060 606f 626a 6475 6d70 6060 2074  es ``objdump`` t
+000212d0: 6f20 6c69 7374 2061 7661 696c 6162 6c65  o list available
+000212e0: 2073 796d 626f 6c73 2c20 616e 6420 6669   symbols, and fi
+000212f0: 6c74 6572 7320 7468 656d 2062 7920 7468  lters them by th
+00021300: 6520 6769 7665 6e20 6060 7379 6d60 602e  e given ``sym``.
+00021310: 0a0a 2020 2020 3a70 6172 616d 2073 7472  ..    :param str
+00021320: 2066 6e3a 2070 6174 680a 2020 2020 3a70   fn: path.    :p
+00021330: 6172 616d 2073 7472 2073 796d 3a0a 2020  aram str sym:.  
+00021340: 2020 3a72 6574 7572 6e3a 206d 6174 6368    :return: match
+00021350: 6564 206f 7574 2c20 6f72 204e 6f6e 650a  ed out, or None.
+00021360: 2020 2020 3a72 7479 7065 3a20 7374 727c      :rtype: str|
+00021370: 4e6f 6e65 0a20 2020 2022 2222 0a20 2020  None.    """.   
+00021380: 2066 726f 6d20 7375 6270 726f 6365 7373   from subprocess
+00021390: 2069 6d70 6f72 7420 4361 6c6c 6564 5072   import CalledPr
+000213a0: 6f63 6573 7345 7272 6f72 0a0a 2020 2020  ocessError..    
+000213b0: 6f62 6a64 756d 7020 3d20 226f 626a 6475  objdump = "objdu
+000213c0: 6d70 202d 5422 0a20 2020 2069 6620 7379  mp -T".    if sy
+000213d0: 732e 706c 6174 666f 726d 203d 3d20 2264  s.platform == "d
+000213e0: 6172 7769 6e22 3a0a 2020 2020 2020 2020  arwin":.        
+000213f0: 6f62 6a64 756d 7020 3d20 226f 746f 6f6c  objdump = "otool
+00021400: 202d 4948 4776 220a 2020 2020 7368 656c   -IHGv".    shel
+00021410: 6c5f 636d 6420 3d20 2225 7320 2573 207c  l_cmd = "%s %s |
+00021420: 2067 7265 7020 2573 2220 2520 286f 626a   grep %s" % (obj
+00021430: 6475 6d70 2c20 666e 2c20 7379 6d29 0a20  dump, fn, sym). 
+00021440: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00021450: 6f75 7420 3d20 7379 735f 6578 6563 5f6f  out = sys_exec_o
+00021460: 7574 2873 6865 6c6c 5f63 6d64 2c20 7368  ut(shell_cmd, sh
+00021470: 656c 6c3d 5472 7565 290a 2020 2020 6578  ell=True).    ex
+00021480: 6365 7074 2043 616c 6c65 6450 726f 6365  cept CalledProce
+00021490: 7373 4572 726f 723a 2020 2320 6e6f 6e65  ssError:  # none
+000214a0: 2066 6f75 6e64 0a20 2020 2020 2020 2072   found.        r
+000214b0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2061  eturn None.    a
+000214c0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+000214d0: 286f 7574 2c20 2873 7472 2c20 756e 6963  (out, (str, unic
+000214e0: 6f64 6529 290a 2020 2020 6f75 745f 6c6e  ode)).    out_ln
+000214f0: 7320 3d20 6f75 742e 7370 6c69 746c 696e  s = out.splitlin
+00021500: 6573 2829 0a20 2020 206f 7574 5f6c 6e73  es().    out_lns
+00021510: 203d 205b 6c6e 2066 6f72 206c 6e20 696e   = [ln for ln in
+00021520: 206f 7574 5f6c 6e73 2069 6620 222e 7465   out_lns if ".te
+00021530: 7874 2220 696e 206c 6e5d 2020 2320 7365  xt" in ln]  # se
+00021540: 6520 6f62 6a64 756d 700a 2020 2020 6f75  e objdump.    ou
+00021550: 745f 6c6e 7320 3d20 5b6c 6e20 666f 7220  t_lns = [ln for 
+00021560: 6c6e 2069 6e20 6f75 745f 6c6e 7320 6966  ln in out_lns if
+00021570: 2073 796d 2069 6e20 6c6e 2e73 706c 6974   sym in ln.split
+00021580: 2829 5d0a 2020 2020 6966 206e 6f74 206f  ()].    if not o
+00021590: 7574 5f6c 6e73 3a0a 2020 2020 2020 2020  ut_lns:.        
+000215a0: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+000215b0: 7265 7475 726e 2022 466f 756e 6420 2572  return "Found %r
+000215c0: 2069 6e20 2572 3a5c 6e25 7322 2025 2028   in %r:\n%s" % (
+000215d0: 7379 6d2c 2066 6e2c 2022 5c6e 222e 6a6f  sym, fn, "\n".jo
+000215e0: 696e 286f 7574 5f6c 6e73 2929 0a0a 0a64  in(out_lns))...d
+000215f0: 6566 2064 756d 6d79 5f6e 756d 7079 5f67  ef dummy_numpy_g
+00021600: 656d 6d5f 6361 6c6c 2829 3a0a 2020 2020  emm_call():.    
+00021610: 2222 220a 2020 2020 4a75 7374 2070 6572  """.    Just per
+00021620: 666f 726d 7320 736f 6d65 2047 454d 4d20  forms some GEMM 
+00021630: 6361 6c6c 2076 6961 204e 756d 7079 2e0a  call via Numpy..
+00021640: 2020 2020 5468 6973 206d 616b 6573 2073      This makes s
+00021650: 7572 6520 7468 6174 2074 6865 2042 4c41  ure that the BLA
+00021660: 5320 6c69 6272 6172 7920 6973 206c 6f61  S library is loa
+00021670: 6465 642e 0a20 2020 2022 2222 0a20 2020  ded..    """.   
+00021680: 2069 6d70 6f72 7420 6e75 6d70 790a 0a20   import numpy.. 
+00021690: 2020 2061 203d 206e 756d 7079 2e72 616e     a = numpy.ran
+000216a0: 646f 6d2e 7261 6e64 6e28 352c 2033 292e  dom.randn(5, 3).
+000216b0: 6173 7479 7065 286e 756d 7079 2e66 6c6f  astype(numpy.flo
+000216c0: 6174 3332 290a 2020 2020 6220 3d20 6e75  at32).    b = nu
+000216d0: 6d70 792e 7261 6e64 6f6d 2e72 616e 646e  mpy.random.randn
+000216e0: 2833 2c20 3729 2e61 7374 7970 6528 6e75  (3, 7).astype(nu
+000216f0: 6d70 792e 666c 6f61 7433 3229 0a20 2020  mpy.float32).   
+00021700: 2063 203d 206e 756d 7079 2e64 6f74 2861   c = numpy.dot(a
+00021710: 2c20 6229 0a20 2020 2061 7373 6572 7420  , b).    assert 
+00021720: 6e75 6d70 792e 6973 6669 6e69 7465 2863  numpy.isfinite(c
+00021730: 292e 616c 6c28 290a 0a0a 5f66 696e 645f  ).all()..._find_
+00021740: 7367 656d 6d5f 6c69 625f 6672 6f6d 5f72  sgemm_lib_from_r
+00021750: 756e 7469 6d65 5f63 6163 6865 6420 3d20  untime_cached = 
+00021760: 4e6f 6e65 0a0a 0a64 6566 2066 696e 645f  None...def find_
+00021770: 7367 656d 6d5f 6c69 6273 5f66 726f 6d5f  sgemm_libs_from_
+00021780: 7275 6e74 696d 6528 293a 0a20 2020 2022  runtime():.    "
+00021790: 2222 0a20 2020 204c 6f6f 6b73 2074 6872  "".    Looks thr
+000217a0: 6f75 6768 2061 6c6c 206c 6962 7320 7669  ough all libs vi
+000217b0: 6120 3a66 756e 633a 6063 6f6c 6c65 6374  a :func:`collect
+000217c0: 5f70 726f 635f 6d61 7073 5f65 7865 635f  _proc_maps_exec_
+000217d0: 6669 6c65 7360 2c0a 2020 2020 616e 6420  files`,.    and 
+000217e0: 7365 6172 6368 6573 2066 6f72 2061 6c6c  searches for all
+000217f0: 2077 6869 6368 2068 6176 6520 7468 6520   which have the 
+00021800: 6060 7367 656d 6d60 6020 7379 6d62 6f6c  ``sgemm`` symbol
+00021810: 2e0a 2020 2020 4375 7272 656e 746c 7920  ..    Currently 
+00021820: 6f6e 6c79 2077 6f72 6b73 206f 6e20 4c69  only works on Li
+00021830: 6e75 7820 2862 6563 6175 7365 2063 6f6c  nux (because col
+00021840: 6c65 6374 5f70 726f 635f 6d61 7073 5f65  lect_proc_maps_e
+00021850: 7865 635f 6669 6c65 7329 2e0a 0a20 2020  xec_files)...   
+00021860: 203a 7265 7475 726e 3a20 6c69 7374 206f   :return: list o
+00021870: 6620 6c69 6273 2028 7468 6569 7220 7061  f libs (their pa
+00021880: 7468 290a 2020 2020 3a72 7479 7065 3a20  th).    :rtype: 
+00021890: 6c69 7374 5b73 7472 5d0a 2020 2020 2222  list[str].    ""
+000218a0: 220a 2020 2020 6966 206e 6f74 206f 732e  ".    if not os.
+000218b0: 7061 7468 2e65 7869 7374 7328 222f 7072  path.exists("/pr
+000218c0: 6f63 2229 3a0a 2020 2020 2020 2020 7265  oc"):.        re
+000218d0: 7475 726e 204e 6f6e 650a 2020 2020 676c  turn None.    gl
+000218e0: 6f62 616c 205f 6669 6e64 5f73 6765 6d6d  obal _find_sgemm
+000218f0: 5f6c 6962 5f66 726f 6d5f 7275 6e74 696d  _lib_from_runtim
+00021900: 655f 6361 6368 6564 0a20 2020 2069 6620  e_cached.    if 
+00021910: 5f66 696e 645f 7367 656d 6d5f 6c69 625f  _find_sgemm_lib_
+00021920: 6672 6f6d 5f72 756e 7469 6d65 5f63 6163  from_runtime_cac
+00021930: 6865 6420 6973 206e 6f74 204e 6f6e 653a  hed is not None:
+00021940: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00021950: 5f66 696e 645f 7367 656d 6d5f 6c69 625f  _find_sgemm_lib_
+00021960: 6672 6f6d 5f72 756e 7469 6d65 5f63 6163  from_runtime_cac
+00021970: 6865 640a 2020 2020 6475 6d6d 795f 6e75  hed.    dummy_nu
+00021980: 6d70 795f 6765 6d6d 5f63 616c 6c28 2920  mpy_gemm_call() 
+00021990: 2023 206d 616b 6520 7375 7265 2074 6861   # make sure tha
+000219a0: 7420 4e75 6d70 7920 6973 206c 6f61 6465  t Numpy is loade
+000219b0: 6420 616e 6420 4e75 6d70 7920 7367 656d  d and Numpy sgem
+000219c0: 6d20 6973 2061 7661 696c 6162 6c65 0a20  m is available. 
+000219d0: 2020 2066 6e73 203d 2063 6f6c 6c65 6374     fns = collect
+000219e0: 5f70 726f 635f 6d61 7073 5f65 7865 635f  _proc_maps_exec_
+000219f0: 6669 6c65 7328 290a 2020 2020 666e 735f  files().    fns_
+00021a00: 7769 7468 5f73 6765 6d6d 203d 205b 5d0a  with_sgemm = [].
+00021a10: 2020 2020 666f 7220 666e 2069 6e20 666e      for fn in fn
+00021a20: 733a 0a20 2020 2020 2020 206f 7574 203d  s:.        out =
+00021a30: 2066 696e 645f 7379 6d5f 696e 5f65 7865   find_sym_in_exe
+00021a40: 6328 666e 2c20 2273 6765 6d6d 5f22 290a  c(fn, "sgemm_").
+00021a50: 2020 2020 2020 2020 6966 206f 7574 3a0a          if out:.
+00021a60: 2020 2020 2020 2020 2020 2020 666e 735f              fns_
+00021a70: 7769 7468 5f73 6765 6d6d 2e61 7070 656e  with_sgemm.appen
+00021a80: 6428 666e 290a 2020 2020 5f66 696e 645f  d(fn).    _find_
+00021a90: 7367 656d 6d5f 6c69 625f 6672 6f6d 5f72  sgemm_lib_from_r
+00021aa0: 756e 7469 6d65 5f63 6163 6865 6420 3d20  untime_cached = 
+00021ab0: 666e 735f 7769 7468 5f73 6765 6d6d 0a20  fns_with_sgemm. 
+00021ac0: 2020 2072 6574 7572 6e20 666e 735f 7769     return fns_wi
+00021ad0: 7468 5f73 6765 6d6d 0a0a 0a5f 6669 6e64  th_sgemm..._find
+00021ae0: 5f6c 6962 6375 6461 7274 5f66 726f 6d5f  _libcudart_from_
+00021af0: 7275 6e74 696d 655f 6361 6368 6564 203d  runtime_cached =
+00021b00: 204e 6f6e 650a 0a0a 6465 6620 6669 6e64   None...def find
+00021b10: 5f6c 6962 6375 6461 7274 5f66 726f 6d5f  _libcudart_from_
+00021b20: 7275 6e74 696d 6528 293a 0a20 2020 2022  runtime():.    "
+00021b30: 2222 0a20 2020 204c 6f6f 6b73 2074 6872  "".    Looks thr
+00021b40: 6f75 6768 2061 6c6c 206c 6962 7320 7669  ough all libs vi
+00021b50: 6120 3a66 756e 633a 6063 6f6c 6c65 6374  a :func:`collect
+00021b60: 5f70 726f 635f 6d61 7073 5f65 7865 635f  _proc_maps_exec_
+00021b70: 6669 6c65 7360 2c0a 2020 2020 616e 6420  files`,.    and 
+00021b80: 7365 6172 6368 6573 2066 6f72 2061 6c6c  searches for all
+00021b90: 2077 6869 6368 2068 6176 6520 7468 6520   which have the 
+00021ba0: 6060 7367 656d 6d60 6020 7379 6d62 6f6c  ``sgemm`` symbol
+00021bb0: 2e0a 2020 2020 4375 7272 656e 746c 7920  ..    Currently 
+00021bc0: 6f6e 6c79 2077 6f72 6b73 206f 6e20 4c69  only works on Li
+00021bd0: 6e75 7820 2862 6563 6175 7365 2063 6f6c  nux (because col
+00021be0: 6c65 6374 5f70 726f 635f 6d61 7073 5f65  lect_proc_maps_e
+00021bf0: 7865 635f 6669 6c65 7329 2e0a 0a20 2020  xec_files)...   
+00021c00: 203a 7265 7475 726e 3a20 6c69 7374 206f   :return: list o
+00021c10: 6620 6c69 6273 2028 7468 6569 7220 7061  f libs (their pa
+00021c20: 7468 290a 2020 2020 3a72 7479 7065 3a20  th).    :rtype: 
+00021c30: 7374 727c 4e6f 6e65 0a20 2020 2022 2222  str|None.    """
+00021c40: 0a20 2020 2069 6620 6e6f 7420 6f73 2e70  .    if not os.p
+00021c50: 6174 682e 6578 6973 7473 2822 2f70 726f  ath.exists("/pro
+00021c60: 6322 293a 0a20 2020 2020 2020 2072 6574  c"):.        ret
+00021c70: 7572 6e20 4e6f 6e65 0a20 2020 2067 6c6f  urn None.    glo
+00021c80: 6261 6c20 5f66 696e 645f 6c69 6263 7564  bal _find_libcud
+00021c90: 6172 745f 6672 6f6d 5f72 756e 7469 6d65  art_from_runtime
+00021ca0: 5f63 6163 6865 640a 2020 2020 6966 205f  _cached.    if _
+00021cb0: 6669 6e64 5f6c 6962 6375 6461 7274 5f66  find_libcudart_f
+00021cc0: 726f 6d5f 7275 6e74 696d 655f 6361 6368  rom_runtime_cach
+00021cd0: 6564 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ed is not None:.
+00021ce0: 2020 2020 2020 2020 7265 7475 726e 205f          return _
+00021cf0: 6669 6e64 5f6c 6962 6375 6461 7274 5f66  find_libcudart_f
+00021d00: 726f 6d5f 7275 6e74 696d 655f 6361 6368  rom_runtime_cach
+00021d10: 6564 5b30 5d0a 2020 2020 666e 7320 3d20  ed[0].    fns = 
+00021d20: 636f 6c6c 6563 745f 7072 6f63 5f6d 6170  collect_proc_map
+00021d30: 735f 6578 6563 5f66 696c 6573 2829 0a20  s_exec_files(). 
+00021d40: 2020 2066 6f72 2066 6e20 696e 2066 6e73     for fn in fns
+00021d50: 3a0a 2020 2020 2020 2020 6966 2072 652e  :.        if re.
+00021d60: 6d61 7463 6828 222e 2a2f 6c69 6263 7564  match(".*/libcud
+00021d70: 6172 745c 5c2e 736f 285c 5c2e 2e2a 293f  art\\.so(\\..*)?
+00021d80: 222c 2066 6e29 3a0a 2020 2020 2020 2020  ", fn):.        
+00021d90: 2020 2020 5f66 696e 645f 6c69 6263 7564      _find_libcud
+00021da0: 6172 745f 6672 6f6d 5f72 756e 7469 6d65  art_from_runtime
+00021db0: 5f63 6163 6865 6420 3d20 5b66 6e5d 0a20  _cached = [fn]. 
+00021dc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00021dd0: 6e20 666e 0a20 2020 205f 6669 6e64 5f6c  n fn.    _find_l
+00021de0: 6962 6375 6461 7274 5f66 726f 6d5f 7275  ibcudart_from_ru
+00021df0: 6e74 696d 655f 6361 6368 6564 203d 205b  ntime_cached = [
+00021e00: 4e6f 6e65 5d0a 2020 2020 7265 7475 726e  None].    return
+00021e10: 204e 6f6e 650a                            None.
```

### Comparing `returnn-1.20240327.165809/returnn/util/better_exchook.py` & `returnn-1.20240513.232708/returnn/util/better_exchook.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/bpe.py` & `returnn-1.20240513.232708/returnn/util/bpe.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/debug.py` & `returnn-1.20240513.232708/returnn/util/debug.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/debug_helpers.py` & `returnn-1.20240513.232708/returnn/util/debug_helpers.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/fsa.py` & `returnn-1.20240513.232708/returnn/util/fsa.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/literal_py_to_pickle.py` & `returnn-1.20240513.232708/returnn/util/literal_py_to_pickle.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/multi_proc_non_daemonic_spawn.py` & `returnn-1.20240513.232708/returnn/util/multi_proc_non_daemonic_spawn.py`

 * *Files 16% similar despite different names*

```diff
@@ -14,24 +14,31 @@
     https://github.com/rwth-i6/returnn/issues/1494
     https://github.com/rwth-i6/returnn/issues/1495
     https://github.com/pytorch/pytorch/issues/15950
 """
 
 from __future__ import annotations
 
+import io
+import pickle
 import time
-from typing import Optional, Any, Callable, Tuple
+from typing import Optional, Callable
 import os
 import signal
 import atexit
+from .basic import serialize_object, deserialize_object
+from . import better_exchook
 
 # noinspection PyProtectedMember
 from multiprocessing.context import BaseContext, SpawnProcess
 
 # noinspection PyUnresolvedReferences
+from multiprocessing import reduction
+
+# noinspection PyUnresolvedReferences
 from multiprocessing.util import is_exiting
 
 
 class NonDaemonicSpawnProcess(SpawnProcess):
     """
     This process is always non-daemon, even if ``proc.daemon=True`` is executed
     (like https://stackoverflow.com/a/8963618/133374).
@@ -107,37 +114,64 @@
         """close"""
         if not self._at_exit_cleanup_handler:
             return
         atexit.unregister(self._at_exit_cleanup_handler)
         self._at_exit_cleanup_handler = None
 
     def __reduce__(self):
-        res_tuple = super().__reduce__()
         if not self.pre_init_func:
-            return res_tuple
-        reconstruct_func, reconstruct_args, *other = res_tuple
+            return super().__reduce__()
+        reconstruct_func, reconstruct_args, reconstruct_state = super().__reduce__()
+        reconstruct_state = reconstruct_state.copy()
+        reconstruct_state.pop("pre_init_func")
+        # For pickling the process object, we need to use the multiprocessing pickler.
+        buffer = io.BytesIO()
+        reduction.dump((reconstruct_func, reconstruct_args, reconstruct_state), buffer)
         # Use our own reconstruct function to call the pre_init_func.
         # This is unpickled and executed *before* the other state is unpickled.
         # This is important: This allows to potentially prepare some global state,
         # to make the following unpickling work.
         # E.g. in case the remaining state depends on some dynamic module,
         # which must be imported in a special way before (e.g. __returnn_config__),
         # this is the way to do it.
         # Note that internally, multiprocessing SpawnProcess does sth similar,
         # see multiprocessing.spawn._main, spawn.prepare.
-        return (self._reconstruct_with_pre_init_func, (reconstruct_func, reconstruct_args, self.pre_init_func)) + tuple(
-            other
+        return (
+            self._reconstruct_with_pre_init_func,
+            (
+                serialize_object(self.pre_init_func),
+                buffer.getvalue(),
+            ),
         )
 
     @staticmethod
     def _reconstruct_with_pre_init_func(
-        reconstruct_func: Callable, reconstruct_args: Tuple[Any, ...], pre_init_func: Callable[[], None]
+        pre_init_func_serialized: bytes,
+        reconstruct_func_and_args_and_state_serialized: bytes,
     ):
-        pre_init_func()
-        return reconstruct_func(*reconstruct_args)
+        better_exchook.install()
+        try:
+            pre_init_func: Callable[[], None] = deserialize_object(pre_init_func_serialized)
+            pre_init_func()
+            buffer = io.BytesIO(reconstruct_func_and_args_and_state_serialized)
+            reconstruct_func, reconstruct_args, reconstruct_state = pickle.load(buffer)
+            obj = reconstruct_func(*reconstruct_args)
+            for k, v in reconstruct_state.items():
+                setattr(obj, k, v)
+            return obj
+        except Exception as exc:
+            print(
+                f"[PID {os.getpid()}, PPID {os.getppid()}]"
+                f" Error in NonDaemonicSpawnProcess._reconstruct_with_pre_init_func: {exc}"
+            )
+            # Note: All relevant data should have been read already from the pipe in the child proc,
+            # so we should not hang anymore in the parent while writing to the pipe.
+            # Thus, it should be safe to just reraise here.
+            # https://github.com/rwth-i6/returnn/issues/1514
+            raise
 
 
 class NonDaemonicSpawnContext(BaseContext):
     """
     Spawn start methods, where all procs are non-daemonic.
     """
```

### Comparing `returnn-1.20240327.165809/returnn/util/native_code_compiler.py` & `returnn-1.20240513.232708/returnn/util/native_code_compiler.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/pprint.py` & `returnn-1.20240513.232708/returnn/util/pprint.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/py-to-pickle.cpp` & `returnn-1.20240513.232708/returnn/util/py-to-pickle.cpp`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/py_ext_mod_compiler.py` & `returnn-1.20240513.232708/returnn/util/py_ext_mod_compiler.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/sig_proc.py` & `returnn-1.20240513.232708/returnn/util/sig_proc.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/task_system.py` & `returnn-1.20240513.232708/returnn/util/task_system.py`

 * *Files 6% similar despite different names*

```diff
@@ -653,23 +653,14 @@
             self.memoize(obj)
             return
         # We could maybe construct it manually. For now, just fail.
         raise pickle.PicklingError("cannot pickle module %r" % obj)
 
     dispatch[ModuleType] = save_module
 
-    def save_string(self, obj, pack=struct.pack):
-        # Difference to base: We just always use BINSTRING (simpler)
-        # and use a separate write for the obj itself.
-        # For a huge obj, this avoids one unnecessary copy of the data.
-        self.write(pickle.BINSTRING + pack("<i", len(obj)))
-        self.write(bytes(obj, "utf8"))
-
-    dispatch[str] = save_string
-
     def save_ndarray(self, obj):
         if use_shared_mem_for_numpy_array(obj):
             try:
                 shared = SharedNumpyArray.as_shared(obj)
             except SharedMem.ShmException as e:
                 print("SharedNumpyArray exception: %s" % e)
                 # fallback to default
```

### Comparing `returnn-1.20240327.165809/returnn/util/train_proc_manager.py` & `returnn-1.20240513.232708/returnn/util/train_proc_manager.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn/util/watch_memory.py` & `returnn-1.20240513.232708/returnn/util/watch_memory.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/returnn.egg-info/PKG-INFO` & `returnn-1.20240513.232708/returnn.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: returnn
-Version: 1.20240327.165809
+Version: 1.20240513.232708
 Summary: The RWTH extensible training framework for universal recurrent neural networks
 Home-page: https://github.com/rwth-i6/returnn/
 Author: Albert Zeyer
 Author-email: albzey@gmail.com
 License: RETURNN license
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Environment :: Console
```

### Comparing `returnn-1.20240327.165809/returnn.egg-info/SOURCES.txt` & `returnn-1.20240513.232708/returnn.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/setup.py` & `returnn-1.20240513.232708/setup.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/DummySprintExec.py` & `returnn-1.20240513.232708/tests/DummySprintExec.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/PyCharm-inspection-profile.xml` & `returnn-1.20240513.232708/tests/PyCharm-inspection-profile.xml`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/PyCharm.idea/codeStyleSettings.xml` & `returnn-1.20240513.232708/tests/PyCharm.idea/codeStyleSettings.xml`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/PyCharm.idea/inspectionProfiles/Project_Default.xml` & `returnn-1.20240513.232708/tests/PyCharm.idea/inspectionProfiles/Project_Default.xml`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/_set_num_threads1.py` & `returnn-1.20240513.232708/tests/_set_num_threads1.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/_setup_test_env.py` & `returnn-1.20240513.232708/tests/_setup_test_env.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/bpe-unicode-demo.codes` & `returnn-1.20240513.232708/tests/bpe-unicode-demo.codes`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/bpe-unicode-demo.vocab` & `returnn-1.20240513.232708/tests/bpe-unicode-demo.vocab`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/lexicon_opt.isyms` & `returnn-1.20240513.232708/tests/lexicon_opt.isyms`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/lexicon_opt.jpg` & `returnn-1.20240513.232708/tests/lexicon_opt.jpg`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/lint_common.py` & `returnn-1.20240513.232708/tests/lint_common.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/pycharm-inspect.py` & `returnn-1.20240513.232708/tests/pycharm-inspect.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/pylint.py` & `returnn-1.20240513.232708/tests/pylint.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/returnn-as-framework.py` & `returnn-1.20240513.232708/tests/returnn-as-framework.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/rf_utils.py` & `returnn-1.20240513.232708/tests/rf_utils.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/spelling.dic` & `returnn-1.20240513.232708/tests/spelling.dic`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_Config.py` & `returnn-1.20240513.232708/tests/test_Config.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_Dataset.py` & `returnn-1.20240513.232708/tests/test_Dataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_Fsa.py` & `returnn-1.20240513.232708/tests/test_Fsa.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_GeneratingDataset.py` & `returnn-1.20240513.232708/tests/test_GeneratingDataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_HDFDataset.py` & `returnn-1.20240513.232708/tests/test_HDFDataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_LearningRateControl.py` & `returnn-1.20240513.232708/tests/test_LearningRateControl.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_Log.py` & `returnn-1.20240513.232708/tests/test_Log.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_MultiProcDataset.py` & `returnn-1.20240513.232708/tests/test_MultiProcDataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_Pretrain.py` & `returnn-1.20240513.232708/tests/test_Pretrain.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_ResNet.py` & `returnn-1.20240513.232708/tests/test_ResNet.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_SprintDataset.py` & `returnn-1.20240513.232708/tests/test_SprintDataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_SprintInterface.py` & `returnn-1.20240513.232708/tests/test_SprintInterface.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TFEngine.py` & `returnn-1.20240513.232708/tests/test_TFEngine.py`

 * *Files 0% similar despite different names*

```diff
@@ -4405,37 +4405,43 @@
                             "eval": "(source(0, auto_convert=False),"
                             "tf.squeeze(self.sources[0].search_choices.beam_scores, axis=1)"
                             "/ tf.cast(source(0, auto_convert=False, as_data=True).get_sequence_lengths(), tf.float32))"
                             "[-1]",
                             "loss": "as_is",
                             "loss_scale": 0,
                         },
-                        "use_t_search": {
-                            "class": "compare",
-                            "kind": "less",
-                            "from": ["existing_align_score", "extra.search:search_score"],
-                        }
-                        if have_existing_align
-                        else {"class": "constant", "value": True},
-                        "t_search_or_fallback": {
-                            "class": "switch",
-                            "condition": "use_t_search",
-                            "true_from": "extra.search:t_search",
-                            "false_from": "data:t_base",
-                        }
-                        if have_existing_align
-                        else {"class": "copy", "from": "data:t_base"},
-                        "t_search_or_fallback_score": {
-                            "class": "switch",
-                            "condition": "use_t_search",
-                            "true_from": "extra.search:search_score",
-                            "false_from": "existing_align_score",
-                        }
-                        if have_existing_align
-                        else {"class": "copy", "from": "extra.search:search_score"},
+                        "use_t_search": (
+                            {
+                                "class": "compare",
+                                "kind": "less",
+                                "from": ["existing_align_score", "extra.search:search_score"],
+                            }
+                            if have_existing_align
+                            else {"class": "constant", "value": True}
+                        ),
+                        "t_search_or_fallback": (
+                            {
+                                "class": "switch",
+                                "condition": "use_t_search",
+                                "true_from": "extra.search:t_search",
+                                "false_from": "data:t_base",
+                            }
+                            if have_existing_align
+                            else {"class": "copy", "from": "data:t_base"}
+                        ),
+                        "t_search_or_fallback_score": (
+                            {
+                                "class": "switch",
+                                "condition": "use_t_search",
+                                "true_from": "extra.search:search_score",
+                                "false_from": "existing_align_score",
+                            }
+                            if have_existing_align
+                            else {"class": "copy", "from": "extra.search:search_score"}
+                        ),
                     }
                 )
                 if epoch0 is not None and epoch0 < StoreAlignmentUpToEpoch:
                     net_dict.update(
                         {
                             "extra.search:t_search_dump": {
                                 "class": "hdf_dump",
```

### Comparing `returnn-1.20240327.165809/tests/test_TFNativeOp.py` & `returnn-1.20240513.232708/tests/test_TFNativeOp.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TFNetworkLayer.py` & `returnn-1.20240513.232708/tests/test_TFNetworkLayer.py`

 * *Files 0% similar despite different names*

```diff
@@ -358,15 +358,24 @@
             "debug_print_layer_output_template": True,
         }
     )
     with make_scope() as session:
         padding = (2, 3)
         net = TFNetwork(config=config)
         net.construct_from_dict(
-            {"output": {"class": "pad", "axes": "T", "padding": padding, "mode": "replication", "from": "data:data"}}
+            {
+                "output": {
+                    "class": "pad",
+                    "axes": "T",
+                    "padding": padding,
+                    "handle_dynamic_dims": False,  # our test below does not handle dyn seq lens
+                    "mode": "replication",
+                    "from": "data:data",
+                }
+            }
         )
         out_t = net.get_default_output_layer().output.placeholder
         assert out_t.shape.as_list() == [None, None, n_in]
         in_v = numpy.arange(0, n_batch * n_time * n_in).astype("float32").reshape((n_batch, n_time, n_in))
         out_v = session.run(out_t, feed_dict={net.extern_data.data["data"].placeholder: in_v})
         assert isinstance(out_v, numpy.ndarray)
         assert out_v.shape == (n_batch, n_time + sum(padding), n_in)
@@ -391,15 +400,24 @@
             "debug_print_layer_output_template": True,
         }
     )
     with make_scope() as session:
         padding = (2, 3)
         net = TFNetwork(config=config)
         net.construct_from_dict(
-            {"output": {"class": "pad", "axes": "F", "padding": padding, "mode": "replication", "from": "data:data"}}
+            {
+                "output": {
+                    "class": "pad",
+                    "axes": "F",
+                    "padding": padding,
+                    "handle_dynamic_dims": False,  # our test below does not handle dyn seq lens
+                    "mode": "replication",
+                    "from": "data:data",
+                }
+            }
         )
         out_t = net.get_default_output_layer().output.placeholder
         assert out_t.shape.as_list() == [None, None, None]
         in_v = numpy.arange(0, n_batch * n_time * n_in).astype("float32").reshape((n_batch, n_time, n_in))
         out_v = session.run(out_t, feed_dict={net.extern_data.data["data"].placeholder: in_v})
         assert isinstance(out_v, numpy.ndarray)
         assert out_v.shape == (n_batch, n_time, n_in + sum(padding))
@@ -12393,14 +12411,15 @@
         net.construct_from_dict(
             {
                 "layer0": {
                     "class": "pad",
                     "mode": "reflect",
                     "axes": "spatial",
                     "padding": (3, 3),
+                    "handle_dynamic_dims": False,  # not supported yet otherwise
                     "from": "data",
                 },  # len+6
                 "layer1": {
                     "class": "conv",
                     "from": "layer0",
                     "activation": None,
                     "with_bias": True,
```

### Comparing `returnn-1.20240327.165809/tests/test_TFNetworkRecLayer.py` & `returnn-1.20240513.232708/tests/test_TFNetworkRecLayer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TFNetworkSigProcLayer.py` & `returnn-1.20240513.232708/tests/test_TFNetworkSigProcLayer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TFUpdater.py` & `returnn-1.20240513.232708/tests/test_TFUpdater.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TFUtil.py` & `returnn-1.20240513.232708/tests/test_TFUtil.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TF_determinism.py` & `returnn-1.20240513.232708/tests/test_TF_determinism.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TaskSystem.py` & `returnn-1.20240513.232708/tests/test_TaskSystem.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 import os
 import sys
 import _setup_test_env  # noqa
 
 from io import BytesIO
 from returnn.util.task_system import *
 import inspect
+import unittest
 from nose.tools import assert_equal, assert_is_instance
 from returnn.util import better_exchook
 
 better_exchook.replace_traceback_format_tb()
 
 
 def pickle_dumps(obj):
@@ -97,7 +98,34 @@
 
 
 def test_pickle():
     obj = DemoClass()
     s = pickle_dumps(obj.method)
     inst = pickle_loads(s)
     assert_equal(inst(), 42)
+
+
+def test_pickle_unicode_str():
+    assert_equal(pickle_loads(pickle_dumps("")), "")
+
+
+if __name__ == "__main__":
+    better_exchook.install()
+    if len(sys.argv) <= 1:
+        for k, v in sorted(globals().items()):
+            if k.startswith("test_"):
+                print("-" * 40)
+                print("Executing: %s" % k)
+                try:
+                    v()
+                except unittest.SkipTest as exc:
+                    print("SkipTest:", exc)
+                print("-" * 40)
+        print("Finished all tests.")
+    else:
+        assert len(sys.argv) >= 2
+        for arg in sys.argv[1:]:
+            print("Executing: %s" % arg)
+            if arg in globals():
+                globals()[arg]()  # assume function and execute
+            else:
+                eval(arg)  # assume Python code and execute
```

#### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

### Comparing `returnn-1.20240327.165809/tests/test_TaskSystem_SharedMem.py` & `returnn-1.20240513.232708/tests/test_TaskSystem_SharedMem.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_TranslationDataset.py` & `returnn-1.20240513.232708/tests/test_TranslationDataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_Util.py` & `returnn-1.20240513.232708/tests/test_Util.py`

 * *Files 10% similar despite different names*

```diff
@@ -6,23 +6,43 @@
 from returnn.util.basic import *
 import sys
 import os
 import numpy as np
 import numpy
 import unittest
 import textwrap
+import signal
 
 from returnn.util import better_exchook
 from returnn.util.py_ext_mod_compiler import PyExtModCompiler
 
 better_exchook.replace_traceback_format_tb()
 
 my_dir = os.path.dirname(os.path.realpath(__file__))
 
 
+def _sig_alarm_handler(signum, frame):
+    raise Exception(f"Alarm (timeout) signal handler")
+
+
+signal.signal(signal.SIGALRM, _sig_alarm_handler)
+
+
+@contextlib.contextmanager
+def timeout(seconds=10):
+    """
+    :param seconds: when the context is not closed within this time, an exception will be raised
+    """
+    signal.alarm(seconds)
+    try:
+        yield
+    finally:
+        signal.alarm(0)
+
+
 def test_cmd_true():
     r = sys_cmd_out_lines("true")
     assert_equal(r, [])
 
 
 def test_cmd_false():
     assert_raises(CalledProcessError, lambda: sys_cmd_out_lines("false"))
@@ -533,14 +553,54 @@
 
 def test_native_signal_handler():
     from returnn.util.debug import install_native_signal_handler
 
     install_native_signal_handler(reraise_exceptions=True)
 
 
+class _PreInitUnpicklingRaiseException:
+    def __getstate__(self):
+        return 42
+
+    def __setstate__(self, state):
+        raise Exception("_PreInitUnpicklingRaiseException")
+
+
+class _PreInitDummy:
+    def __init__(self, *, payload):
+        self.payload = payload
+
+    def __call__(self):
+        pass  # nothing
+
+
+def _noop_func():
+    pass
+
+
+def test_NonDaemonicSpawnProcess_hang_1514():
+    # https://github.com/rwth-i6/returnn/issues/1514
+    from returnn.util.multi_proc_non_daemonic_spawn import NonDaemonicSpawnProcess
+
+    with timeout():
+        proc = NonDaemonicSpawnProcess(target=_noop_func)
+        proc.start()
+        proc.join()
+        assert proc.exitcode == 0
+
+        proc = NonDaemonicSpawnProcess(target=_noop_func)
+        # Give it some payload large enough such that it will the pipe buffer to trigger the potential hang.
+        proc.pre_init_func = _PreInitDummy(payload=["A" * 100_000, _PreInitUnpicklingRaiseException(), "B" * 100_000])
+        # After fixing this, we expect that the unpickling of pre_init_func will raise an exception,
+        # however, the parent then will not hang.
+        proc.start()
+        proc.join()
+        assert proc.exitcode != 0
+
+
 if __name__ == "__main__":
     better_exchook.install()
     if len(sys.argv) <= 1:
         for k, v in sorted(globals().items()):
             if k.startswith("test_"):
                 print("-" * 40)
                 print("Executing: %s" % k)
```

### Comparing `returnn-1.20240327.165809/tests/test_demos.py` & `returnn-1.20240513.232708/tests/test_demos.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_fork_exec.py` & `returnn-1.20240513.232708/tests/test_fork_exec.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_hdf_dump.py` & `returnn-1.20240513.232708/tests/test_hdf_dump.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_array.py` & `returnn-1.20240513.232708/tests/test_rf_array.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """
 RETURNN frontend (returnn.frontend) tests
 """
 
 from __future__ import annotations
 from typing import Tuple
 import _setup_test_env  # noqa
+import numpy as np
 import returnn.frontend as rf
 from returnn.tensor import Tensor, Dim, TensorDict, batch_dim
 from rf_utils import run_model
 
 
 def test_pack_padded():
     time_dim = Dim(Tensor("time", [batch_dim], dtype="int32"))
@@ -124,26 +125,68 @@
     extern_data = TensorDict(
         {
             "data": Tensor("data", [batch_dim, time_dim, in_dim], dtype="float32"),
         }
     )
 
     class _Net(rf.Module):
-        def __call__(self, x: Tensor) -> Tuple[Tensor, Tuple[Dim, Dim]]:
+        def __call__(self, x: Tensor) -> Tuple[Tensor, Tuple[Dim]]:
             pack, (new_time,) = rf.pad(x, axes=[time_dim], padding=[(1, 0)], value=0)
             return pack, (new_time,)
 
     # noinspection PyShadowingNames
     def _forward_step(*, model: _Net, extern_data: TensorDict):
         out, (new_time,) = model(extern_data["data"])
         out.mark_as_default_output(shape=(batch_dim, new_time, in_dim))
 
     run_model(extern_data, lambda *, epoch, step: _Net(), _forward_step)
 
 
+def test_pad_time_right():
+    time_dim = Dim(Tensor("time", [batch_dim], dtype="int32"))
+    in_dim = Dim(7, name="in")
+    extern_data = TensorDict(
+        {
+            "data": Tensor("data", [batch_dim, time_dim, in_dim], dtype="float32"),
+        }
+    )
+
+    class _Net(rf.Module):
+        def __call__(self, x: Tensor) -> Tuple[Tensor, Tuple[Dim]]:
+            pack, (new_time,) = rf.pad(x, axes=[time_dim], padding=[(0, 1)], value=1)
+            return pack, (new_time,)
+
+    # noinspection PyShadowingNames
+    def _forward_step(*, model: _Net, extern_data: TensorDict):
+        data = extern_data["data"]
+        data.mark_as_output("data", shape=(batch_dim, time_dim, in_dim))
+        out, (new_time,) = model(data)
+        out.mark_as_default_output(shape=(batch_dim, new_time, in_dim))
+
+    res = run_model(extern_data, lambda *, epoch, step: _Net(), _forward_step)
+    data_: Tensor = res["data"]
+    out_: Tensor = res["output"]
+    assert data_.dims == (batch_dim, time_dim, in_dim)
+    new_time_dim = out_.dims[1]
+    assert out_.dims == (batch_dim, new_time_dim, in_dim) and new_time_dim != time_dim
+    assert new_time_dim == time_dim + 1  # math dim... not really necessary check here...
+    assert time_dim.dyn_size_ext.dims == new_time_dim.dyn_size_ext.dims == (batch_dim,)
+    batch_size = batch_dim.get_dim_value()
+    assert batch_size > 1
+    assert len(set(time_dim.dyn_size_ext.raw_tensor)) > 1  # not all the same
+    for b in range(batch_size):
+        seq_len = time_dim.dyn_size_ext.raw_tensor[b]
+        new_seq_len = new_time_dim.dyn_size_ext.raw_tensor[b]
+        print(f"batch {b}, seq_len {seq_len}, new_seq_len {new_seq_len}")
+        assert new_seq_len == seq_len + 1
+        np.testing.assert_allclose(data_.raw_tensor[b, :seq_len], out_.raw_tensor[b, :seq_len])
+        print(out_.raw_tensor[b])
+        assert all(out_.raw_tensor[b, seq_len] == 1.0)
+
+
 def test_gather():
     time_dim = Dim(Tensor("time", [batch_dim], dtype="int32"))
     in_dim = Dim(7, name="in")
     extern_data = TensorDict(
         {
             "data": Tensor("data", [batch_dim, time_dim, in_dim], dtype="float32"),
         }
```

### Comparing `returnn-1.20240327.165809/tests/test_rf_attention.py` & `returnn-1.20240513.232708/tests/test_rf_attention.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_base.py` & `returnn-1.20240513.232708/tests/test_rf_base.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_cond.py` & `returnn-1.20240513.232708/tests/test_rf_cond.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_const.py` & `returnn-1.20240513.232708/tests/test_rf_const.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_container.py` & `returnn-1.20240513.232708/tests/test_rf_container.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_conv.py` & `returnn-1.20240513.232708/tests/test_rf_conv.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_encoder_conformer.py` & `returnn-1.20240513.232708/tests/test_rf_encoder_conformer.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_gradient.py` & `returnn-1.20240513.232708/tests/test_rf_gradient.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_label_smoothing.py` & `returnn-1.20240513.232708/tests/test_rf_label_smoothing.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_loop.py` & `returnn-1.20240513.232708/tests/test_rf_loop.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_math.py` & `returnn-1.20240513.232708/tests/test_rf_math.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_normalization.py` & `returnn-1.20240513.232708/tests/test_rf_normalization.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_rec.py` & `returnn-1.20240513.232708/tests/test_rf_rec.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_reduce.py` & `returnn-1.20240513.232708/tests/test_rf_reduce.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_rf_signal.py` & `returnn-1.20240513.232708/tests/test_rf_signal.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_tensor.py` & `returnn-1.20240513.232708/tests/test_tensor.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_tools.py` & `returnn-1.20240513.232708/tests/test_tools.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_torch_dataset.py` & `returnn-1.20240513.232708/tests/test_torch_dataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_torch_engine.py` & `returnn-1.20240513.232708/tests/test_torch_engine.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_torch_frontend.py` & `returnn-1.20240513.232708/tests/test_torch_frontend.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tests/test_torch_internal_frontend.py` & `returnn-1.20240513.232708/tests/test_torch_internal_frontend.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/analyze-dataset-batches.py` & `returnn-1.20240513.232708/tools/analyze-dataset-batches.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/bliss-collect-seq-lens.py` & `returnn-1.20240513.232708/tools/bliss-collect-seq-lens.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/bliss-dump-text.py` & `returnn-1.20240513.232708/tools/bliss-dump-text.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/bliss-get-segment-names.py` & `returnn-1.20240513.232708/tools/bliss-get-segment-names.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/bliss-to-ogg-zip.py` & `returnn-1.20240513.232708/tools/bliss-to-ogg-zip.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/bpe-create-lexicon.py` & `returnn-1.20240513.232708/tools/bpe-create-lexicon.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/calculate-word-error-rate.py` & `returnn-1.20240513.232708/tools/calculate-word-error-rate.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/cleanup-old-models.py` & `returnn-1.20240513.232708/tools/cleanup-old-models.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/collect-orth-symbols.py` & `returnn-1.20240513.232708/tools/collect-orth-symbols.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/collect-words.py` & `returnn-1.20240513.232708/tools/collect-words.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/compile_native_op.py` & `returnn-1.20240513.232708/tools/compile_native_op.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/compile_tf_graph.py` & `returnn-1.20240513.232708/tools/compile_tf_graph.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/debug-dump-search-scores.py` & `returnn-1.20240513.232708/tools/debug-dump-search-scores.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/debug-plot-search-scores.py` & `returnn-1.20240513.232708/tools/debug-plot-search-scores.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/dump-dataset-raw-strings.py` & `returnn-1.20240513.232708/tools/dump-dataset-raw-strings.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/dump-dataset.py` & `returnn-1.20240513.232708/tools/dump-dataset.py`

 * *Files 2% similar despite different names*

```diff
@@ -232,14 +232,16 @@
         print("Using config file %r." % config_filename)
         assert os.path.exists(config_filename)
     rnn.init_config(config_filename=config_filename, default_config={"cache_size": "0"})
     global config
     config = rnn.config
     config.set("log", None)
     config.set("log_verbosity", verbosity)
+    config.set("torch_distributed", None)
+    config.set("use_horovod", None)
     if dataset_dict:
         assert not config_dataset
         dataset = init_dataset(dataset_dict)
     elif config_dataset and config_dataset != "train":
         print("Use dataset %r from config." % config_dataset)
         dataset = init_dataset("config:%s" % config_dataset)
     else:
```

### Comparing `returnn-1.20240327.165809/tools/dump-forward-stats.py` & `returnn-1.20240513.232708/tools/dump-forward-stats.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/dump-forward.py` & `returnn-1.20240513.232708/tools/dump-forward.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/dump-network-json.py` & `returnn-1.20240513.232708/tools/dump-network-json.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/dump-pickle.py` & `returnn-1.20240513.232708/tools/dump-pickle.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/extract_state_tying_from_dataset.py` & `returnn-1.20240513.232708/tools/extract_state_tying_from_dataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/get-attention-weights.py` & `returnn-1.20240513.232708/tools/get-attention-weights.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/get-best-model-epoch.py` & `returnn-1.20240513.232708/tools/get-best-model-epoch.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/hdf_dump.py` & `returnn-1.20240513.232708/tools/hdf_dump.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/hdf_dump_translation_dataset.py` & `returnn-1.20240513.232708/tools/hdf_dump_translation_dataset.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/import-blocks-mt-model.py` & `returnn-1.20240513.232708/tools/import-blocks-mt-model.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/import-t2t-mt-model.py` & `returnn-1.20240513.232708/tools/import-t2t-mt-model.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/Makefile` & `returnn-1.20240513.232708/tools/lattice_rescorer/Makefile`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/README.md` & `returnn-1.20240513.232708/tools/lattice_rescorer/README.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/example/README.md` & `returnn-1.20240513.232708/tools/lattice_rescorer/example/README.md`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.config` & `returnn-1.20240513.232708/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.keep_over_epoch.lstm2.config` & `returnn-1.20240513.232708/tools/lattice_rescorer/example/network.040/i600_m600_m600.sgd_b16_lr0_cl2.newbobabs.keep_over_epoch.lstm2.config`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/example/rescore_lattice.sh` & `returnn-1.20240513.232708/tools/lattice_rescorer/example/rescore_lattice.sh`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/file.h` & `returnn-1.20240513.232708/tools/lattice_rescorer/file.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/htklatticerescorer.cc` & `returnn-1.20240513.232708/tools/lattice_rescorer/htklatticerescorer.cc`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/htklatticerescorer.h` & `returnn-1.20240513.232708/tools/lattice_rescorer/htklatticerescorer.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/main.cc` & `returnn-1.20240513.232708/tools/lattice_rescorer/main.cc`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/rescorer.h` & `returnn-1.20240513.232708/tools/lattice_rescorer/rescorer.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/vocabulary.cc` & `returnn-1.20240513.232708/tools/lattice_rescorer/vocabulary.cc`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/lattice_rescorer/vocabulary.h` & `returnn-1.20240513.232708/tools/lattice_rescorer/vocabulary.h`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/tf_avg_checkpoints.py` & `returnn-1.20240513.232708/tools/tf_avg_checkpoints.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/tf_inspect_checkpoint.py` & `returnn-1.20240513.232708/tools/tf_inspect_checkpoint.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/tf_inspect_summary_log.py` & `returnn-1.20240513.232708/tools/tf_inspect_summary_log.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/torch_avg_checkpoints.py` & `returnn-1.20240513.232708/tools/torch_avg_checkpoints.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/torch_export_to_onnx.py` & `returnn-1.20240513.232708/tools/torch_export_to_onnx.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/torch_inspect_checkpoint.py` & `returnn-1.20240513.232708/tools/torch_inspect_checkpoint.py`

 * *Files identical despite different names*

### Comparing `returnn-1.20240327.165809/tools/torch_inspect_checkpoint_and_opt.py` & `returnn-1.20240513.232708/tools/torch_inspect_checkpoint_and_opt.py`

 * *Files identical despite different names*

